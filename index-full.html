<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>åŸºé‡‘è‚¡å¸‚å°åŠ©ç†</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f0f2f5;--card:#fff;--text:#1a1a2e;--sub:#8896a4;
  --primary:#4F6EF7;--primary-bg:#eef2ff;
  --up:#e74040;--up-bg:#fef2f2;
  --down:#22a065;--down-bg:#ecfdf5;
  --border:#e8ecf1;--radius:14px;
  --warn:#f59e0b;--warn-bg:#fef3c7;
}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro","PingFang SC","Helvetica Neue",sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

/* Top bar */
.topbar{background:linear-gradient(135deg,#1e293b,#0f172a);padding:14px 16px;color:#fff;position:sticky;top:0;z-index:100}
.topbar-row{display:flex;align-items:center;justify-content:space-between}
.topbar h1{font-size:16px;font-weight:700;display:flex;align-items:center;gap:6px}
.market-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;animation:pulse 2s infinite}
.market-badge.open{background:#22c55e;color:#fff}
.market-badge.closed{background:#64748b;color:#fff;animation:none}
.market-badge.soon{background:#f59e0b;color:#fff}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.topbar-sub{font-size:11px;opacity:.6;margin-top:4px}
.topbar-indices{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.1)}
.idx-row{display:flex;gap:8px}
.idx-row+.idx-row{margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,.06)}
.idx-row .idx-row-label{font-size:9px;opacity:.35;writing-mode:vertical-rl;display:flex;align-items:center;padding-right:4px;letter-spacing:1px}
.idx-mini{flex:1;text-align:center}
.idx-mini .idx-name{font-size:10px;opacity:.55}
.idx-mini .idx-val{font-size:13px;font-weight:600;margin-top:1px}
.idx-mini .idx-pct{font-size:11px;font-weight:600}
.idx-mini.commodity .idx-name{opacity:.65;color:#fbbf24}
.idx-mini.commodity .idx-val{font-size:12px}

/* Main content */
.main{flex:1;padding:0 0 80px;overflow-y:auto}

/* Page tabs */
.page-tabs{display:flex;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
.page-tab{flex:1;text-align:center;padding:12px 8px;font-size:13px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--sub);transition:.2s}
.page-tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:700}
.page-tab .pt-badge{display:inline-block;font-size:10px;background:var(--primary-bg);color:var(--primary);padding:1px 6px;border-radius:8px;margin-left:4px;font-weight:600}
.page-content{padding:12px}

/* Status card */
.status-card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.status-icon{font-size:48px;margin-bottom:8px}
.status-title{font-size:15px;font-weight:600;margin-bottom:4px}
.status-desc{font-size:12px;color:var(--sub);line-height:1.6}
.countdown{font-size:20px;font-weight:700;color:var(--primary);margin-top:8px;font-variant-numeric:tabular-nums}

/* Message feed */
.msg-feed{display:flex;flex-direction:column;gap:8px}
.msg{background:var(--card);border-radius:var(--radius);padding:12px 14px;box-shadow:0 1px 3px rgba(0,0,0,.04);animation:slideIn .3s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.msg-header{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.msg-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.msg-avatar.sys{background:#dbeafe}
.msg-avatar.alert{background:#fee2e2}
.msg-avatar.good{background:#dcfce7}
.msg-avatar.ai{background:linear-gradient(135deg,#c084fc,#818cf8);color:#fff}
.msg-name{font-size:11px;font-weight:600;color:var(--sub)}
.msg-time{font-size:10px;color:var(--sub);margin-left:auto}
.msg-body{font-size:13px;line-height:1.7}
.msg-body strong{font-weight:600}
.msg-tag{display:inline-block;font-size:10px;padding:1px 6px;border-radius:4px;font-weight:600;margin-right:4px}
.msg-tag.up{background:var(--up-bg);color:var(--up)}
.msg-tag.down{background:var(--down-bg);color:var(--down)}
.msg-tag.info{background:var(--primary-bg);color:var(--primary)}
.msg-tag.warn{background:var(--warn-bg);color:var(--warn)}

/* Holdings card */
.holdings-card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.holdings-title{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.h-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);gap:8px}
.h-item:last-child{border-bottom:none}
.h-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.h-info{flex:1;min-width:0}
.h-name{font-size:12px;font-weight:500}
.h-code{font-size:10px;color:var(--sub)}
.h-pct{font-size:13px;font-weight:700;text-align:right}

/* AI Live Card (homepage prominent) */
.ai-live-card{background:var(--card);border-radius:var(--radius);margin-bottom:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.ai-live-header{background:linear-gradient(135deg,#4F6EF7,#6366f1);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.ai-live-header .alh-left{display:flex;align-items:center;gap:8px}
.ai-live-header .alh-title{font-size:14px;font-weight:700}
.ai-live-header .alh-badge{font-size:10px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px}
.ai-live-header .alh-btn{font-size:11px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:5px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.ai-live-header .alh-btn:active{background:rgba(255,255,255,.35)}
.ai-engine-tabs{display:flex;border-bottom:1px solid var(--border);background:#f8fafc;overflow-x:auto}
.ai-engine-tab{flex-shrink:0;text-align:center;padding:10px 14px;font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--sub);transition:.2s;white-space:nowrap}
.ai-engine-tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
.ai-engine-tab .aet-icon{font-size:14px;margin-right:3px}
.ai-engine-view{display:none;padding:14px}
.ai-engine-view.active{display:block}
/* Synthesis view */
.synth-overview{margin-bottom:12px}
.synth-meter{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.synth-meter .sm-bar{flex:1;display:flex;height:8px;border-radius:4px;overflow:hidden;gap:2px}
.synth-meter .sm-seg{height:100%;border-radius:4px;transition:width .5s}
.synth-meter .sm-seg.bull{background:var(--up)}
.synth-meter .sm-seg.bear{background:var(--down)}
.synth-meter .sm-seg.neutral{background:var(--warn)}
.synth-meter .sm-text{font-size:12px;font-weight:700;flex-shrink:0}
.synth-engines{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.synth-eng{padding:10px;border-radius:10px;background:var(--bg)}
.synth-eng .se-head{display:flex;align-items:center;gap:5px;margin-bottom:4px}
.synth-eng .se-icon{font-size:16px}
.synth-eng .se-name{font-size:11px;font-weight:600}
.synth-eng .se-verdict{font-size:11px;font-weight:700}
.synth-eng .se-verdict.bull{color:var(--up)}
.synth-eng .se-verdict.bear{color:var(--down)}
.synth-eng .se-verdict.neutral{color:var(--warn)}
.synth-eng .se-brief{font-size:10px;color:var(--sub);line-height:1.4;margin-top:2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.synth-fund-section{margin-top:10px}
.synth-fund-title{font-size:11px;font-weight:600;color:var(--sub);margin-bottom:6px;display:flex;align-items:center;gap:4px}
/* Collapsible list */
.collapse-list:not(.expanded) > .cl-item:nth-child(n+4){display:none !important}
.cl-toggle{display:flex;align-items:center;justify-content:center;gap:4px;padding:6px 0;font-size:11px;color:var(--primary);font-weight:500;cursor:pointer;user-select:none;border-top:1px dashed var(--border);margin-top:4px}
.cl-toggle:active{opacity:.6}
.cl-toggle .cl-arrow{transition:transform .2s}
.collapse-list.expanded .cl-toggle .cl-arrow{transform:rotate(180deg)}
.synth-fund-item{display:flex;align-items:center;padding:8px;background:var(--bg);border-radius:8px;margin-bottom:6px;gap:8px}
.synth-fund-item .sfi-name{flex:1;font-size:12px;font-weight:500}
.synth-fund-item .sfi-pct{font-size:11px;font-weight:600}
.synth-fund-item .sfi-votes{font-size:9px;color:var(--sub);display:flex;gap:3px}
.synth-fund-item .sfi-action{font-size:10px;font-weight:700;padding:2px 8px;border-radius:6px}
.synth-fund-item .sfi-action.buy{background:var(--up-bg);color:var(--up)}
.synth-fund-item .sfi-action.sell{background:var(--down-bg);color:var(--down)}
.synth-fund-item .sfi-action.hold{background:var(--warn-bg);color:var(--warn)}

/* AI Analysis Panel (full detail in feed) */
.analysis-panel{background:var(--card);border-radius:var(--radius);overflow:hidden;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.analysis-header{background:linear-gradient(135deg,#4F6EF7,#818cf8);color:#fff;padding:14px 16px}
.analysis-header h3{font-size:14px;font-weight:700;margin-bottom:2px}
.analysis-header p{font-size:11px;opacity:.75}
.ai-tabs{display:flex;border-bottom:1px solid var(--border);background:#f8fafc}
.ai-tab{flex:1;text-align:center;padding:10px 4px;font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;transition:.2s;color:var(--sub)}
.ai-tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
.ai-tab .tab-icon{font-size:16px;display:block;margin-bottom:2px}
.ai-content{padding:14px}
.ai-view{display:none}
.ai-view.active{display:block}
.ai-verdict{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;margin-bottom:10px;font-size:12px;line-height:1.6}
.ai-verdict.bull{background:var(--up-bg);border:1px solid #fecaca}
.ai-verdict.bear{background:var(--down-bg);border:1px solid #bbf7d0}
.ai-verdict.neutral{background:var(--warn-bg);border:1px solid #fde68a}
.ai-verdict-icon{font-size:20px;flex-shrink:0}
.ai-detail{font-size:12px;line-height:1.8;color:#374151}
.ai-detail p{margin-bottom:8px}
.ai-detail .highlight{font-weight:600;color:var(--text)}
.ai-fund-row{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9;font-size:12px;gap:6px}
.ai-fund-row:last-child{border-bottom:none}
.ai-fund-row .f-name{flex:1;font-weight:500}
.ai-fund-row .f-action{font-weight:600;font-size:11px;padding:2px 8px;border-radius:6px}
.ai-fund-row .f-action.buy{background:var(--up-bg);color:var(--up)}
.ai-fund-row .f-action.sell{background:var(--down-bg);color:var(--down)}
.ai-fund-row .f-action.hold{background:var(--warn-bg);color:var(--warn)}
.ai-fund-detail{padding:4px 0 8px;font-size:10px;color:var(--sub);line-height:1.5}
.ai-fund-detail .fd-year{display:flex;flex-wrap:wrap;gap:6px 12px;margin-bottom:3px}
.ai-fund-detail .fd-tag{display:inline-flex;align-items:center;gap:2px}
.ai-fund-detail .fd-band{background:linear-gradient(90deg,#eef2ff,#f0f9ff);padding:4px 8px;border-radius:6px;border-left:3px solid var(--primary);margin-top:3px;font-size:10px;line-height:1.5}
.ai-fund-detail .fd-final{margin-top:3px;font-weight:600;font-size:10px}
.sfi-expand{margin-top:4px;font-size:10px;color:var(--sub);line-height:1.4}
.sfi-expand .sfi-year{display:flex;flex-wrap:wrap;gap:4px 10px;margin-bottom:2px}
.sfi-expand .sfi-band{background:linear-gradient(90deg,#eef2ff,#f0f9ff);padding:3px 6px;border-radius:5px;border-left:2px solid var(--primary);font-size:9px;line-height:1.4}

/* AI Recommended Funds */
.reco-buy-section{margin-top:16px;border-top:1px solid var(--border);padding-top:14px}
.reco-buy-title{font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.reco-buy-title .rbt-badge{font-size:9px;background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;padding:2px 8px;border-radius:10px;font-weight:600}
.reco-buy-item{background:linear-gradient(135deg,#fef2f2,#fff7ed);border:1px solid #fecaca;border-radius:10px;padding:10px 12px;margin-bottom:8px;position:relative}
.reco-buy-item .rbi-top{display:flex;align-items:center;gap:8px}
.reco-buy-item .rbi-name{font-size:12px;font-weight:600;flex:1}
.reco-buy-item .rbi-code{font-size:10px;color:var(--sub)}
.reco-buy-item .rbi-type{font-size:9px;padding:1px 6px;border-radius:4px;background:var(--primary-bg);color:var(--primary);font-weight:600}
.reco-buy-item .rbi-score{font-size:11px;font-weight:700;color:var(--up);padding:2px 8px;background:var(--up-bg);border-radius:6px}
.reco-buy-item .rbi-body{margin-top:6px;font-size:10px;color:#374151;line-height:1.6}
.reco-buy-item .rbi-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.reco-buy-item .rbi-tag{font-size:9px;padding:1px 5px;border-radius:4px;background:#fef3c7;color:#92400e}
.reco-buy-item .rbi-actions{display:flex;gap:6px;margin-top:8px}
.reco-buy-item .rbi-btn{border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
.reco-buy-item .rbi-btn.primary{background:var(--primary);color:#fff}
.reco-buy-item .rbi-btn.outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}
.reco-buy-item .rbi-btn:active{transform:scale(.96)}
.reco-buy-item .rbi-btn.added{background:#e2e8f0;color:var(--sub);border:none}

/* Recommendation panel */
.reco-panel{background:var(--card);border-radius:var(--radius);overflow:hidden;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);border:2px solid var(--primary)}
.reco-header{background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff;padding:14px 16px}
.reco-header h3{font-size:14px;font-weight:700}
.reco-header p{font-size:11px;opacity:.8}
.reco-body{padding:14px}
.reco-item{padding:12px;border-radius:10px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px}
.reco-item.buy{background:linear-gradient(135deg,#fef2f2,#fff5f5);border:1px solid #fecaca}
.reco-item.sell{background:linear-gradient(135deg,#ecfdf5,#f0fdf4);border:1px solid #bbf7d0}
.reco-item.hold{background:#f8fafc;border:1px solid var(--border)}
.reco-icon{font-size:24px;flex-shrink:0}
.reco-info{flex:1}
.reco-info .r-action{font-size:14px;font-weight:700}
.reco-info .r-action.buy{color:var(--up)}
.reco-info .r-action.sell{color:var(--down)}
.reco-info .r-action.hold{color:var(--warn)}
.reco-info .r-name{font-size:13px;font-weight:500;margin-top:2px}
.reco-info .r-reason{font-size:11px;color:var(--sub);line-height:1.6;margin-top:4px}
.reco-info .r-consensus{font-size:10px;margin-top:4px;color:var(--primary)}
.reco-summary{background:var(--primary-bg);border-radius:10px;padding:12px;font-size:12px;line-height:1.7;color:#374151;margin-top:8px}

/* Bottom bar */
.bottombar{position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;background:var(--card);border-top:1px solid var(--border);padding:10px 16px env(safe-area-inset-bottom,10px);display:flex;align-items:center;gap:8px;z-index:100}
.bottom-status{flex:1;font-size:11px;color:var(--sub);line-height:1.4}
.bottom-btn{padding:8px 16px;border-radius:10px;border:none;font-size:12px;font-weight:600;cursor:pointer}
.bottom-btn.primary{background:var(--primary);color:#fff}
.bottom-btn:active{transform:scale(.96)}

/* Holdings modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:500px;max-height:80vh;overflow-y:auto;padding:20px 16px;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h3{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
.modal h3 button{border:none;background:none;font-size:18px;cursor:pointer;color:var(--sub)}
.form-row{margin-bottom:12px}
.form-row label{display:block;font-size:12px;font-weight:500;margin-bottom:4px;color:var(--sub)}
.form-row select,.form-row input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg)}
.form-btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;background:var(--primary);color:#fff;margin-top:8px}
.form-btn:active{transform:scale(.98)}
.h-manage{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.h-manage:last-child{border-bottom:none}
.h-manage .hm-info{flex:1}
.h-manage .hm-name{font-size:13px;font-weight:500}
.h-manage .hm-detail{font-size:11px;color:var(--sub)}
.h-manage .hm-del{border:none;background:#fee2e2;color:#dc2626;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}

/* Typing indicator */
.typing{display:flex;gap:4px;padding:8px 12px;align-items:center}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--sub);animation:typeBounce 1.4s infinite ease-in-out}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typeBounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),#818cf8);border-radius:2px;transition:width .5s ease}

/* Watchlist card */
.watch-card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.watch-card .watch-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.watch-card .watch-title{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.watch-card .watch-edit{font-size:11px;color:var(--primary);cursor:pointer;font-weight:500}
.w-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);gap:8px}
.w-item:last-child{border-bottom:none}
.w-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--primary-bg);color:var(--primary);font-weight:700}
.w-info{flex:1;min-width:0}
.w-name{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.w-code{font-size:10px;color:var(--sub)}
.w-data{text-align:right;flex-shrink:0}
.w-nav{font-size:12px;font-weight:600}
.w-pct{font-size:11px;font-weight:600}

/* Watchlist modal tabs */
.wm-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:12px}
.wm-tab{flex:1;text-align:center;padding:10px;font-size:13px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--sub);transition:.2s}
.wm-tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
.wm-view{display:none}
.wm-view.active{display:block}
.wm-search{display:flex;gap:8px;margin-bottom:12px}
.wm-search input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg)}
.wm-search button{padding:10px 16px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:13px;font-weight:600;cursor:pointer;flex-shrink:0}
.wm-search button:active{transform:scale(.96)}
.wm-result{padding:10px;background:var(--bg);border-radius:10px;margin-bottom:8px;font-size:12px;display:flex;align-items:center;gap:8px}
.wm-result .r-info{flex:1}
.wm-result .r-name{font-weight:500}
.wm-result .r-code{font-size:11px;color:var(--sub)}
.wm-result button{padding:6px 14px;border:none;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer}
.wm-result button.add{background:var(--primary);color:#fff}
.wm-result button.added{background:var(--border);color:var(--sub)}
.wm-result button.del{background:#fee2e2;color:#dc2626}
.wm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.wm-pick{padding:10px;background:var(--bg);border-radius:10px;font-size:12px;cursor:pointer;text-align:center;transition:.15s;border:2px solid transparent}
.wm-pick:active{transform:scale(.97)}
.wm-pick.selected{border-color:var(--primary);background:var(--primary-bg)}
.wm-pick .p-name{font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wm-pick .p-type{font-size:10px;color:var(--sub)}
.bottom-btn.secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}

/* Top Manager Section */
.tm-section{background:var(--card);border-radius:var(--radius);margin-bottom:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.tm-header{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.tm-header .tmh-left{display:flex;align-items:center;gap:8px}
.tm-header .tmh-title{font-size:14px;font-weight:700}
.tm-header .tmh-badge{font-size:10px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px}
.tm-header .tmh-sub{font-size:10px;opacity:.8;margin-top:2px}
.tm-body{padding:14px}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-row">
    <h1>ğŸ¤– åŸºé‡‘å°åŠ©ç† <span class="market-badge closed" id="market-badge">å·²æ”¶ç›˜</span></h1>
    <span style="font-size:11px;opacity:.6" id="clock">--:--:--</span>
  </div>
  <div class="topbar-sub" id="topbar-sub">ç­‰å¾…å¼€ç›˜...</div>
  <div class="topbar-indices" id="topbar-indices"></div>
</div>

<div class="main" id="main-content"></div>

<div class="bottombar">
  <div class="bottom-status" id="bottom-status">ç­‰å¾…å¸‚åœºæ•°æ®...</div>
  <button class="bottom-btn secondary" onclick="openWatchModal()">â­ è‡ªé€‰</button>
  <button class="bottom-btn primary" onclick="openHoldingsModal()">ğŸ“‹ æŒä»“</button>
  <button class="bottom-btn primary" onclick="triggerAnalysisNow()" id="btn-analyze">ğŸ§  åˆ†æ</button>
  <button class="bottom-btn secondary" onclick="openAISettings()" style="font-size:16px;padding:8px 10px">âš™ï¸</button>
</div>

<!-- AI Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeAISettings()" style="display:none">
  <div class="modal" style="max-width:360px">
    <h3>âš™ï¸ AIè®¾ç½® <button onclick="closeAISettings()">âœ•</button></h3>
    <div style="padding:10px 0">
      <div style="font-size:11px;font-weight:600;margin-bottom:8px">ğŸŒ AIæœåŠ¡æä¾›å•†</div>
      <div id="provider-list" style="margin-bottom:12px"></div>

      <div style="font-size:11px;font-weight:600;margin:12px 0 6px">API Key</div>
      <div class="form-row">
        <input type="password" id="input-302key" placeholder="sk-... / ä½ çš„API Key" style="width:100%;font-size:12px">
      </div>
      <div id="provider-hint" style="font-size:10px;color:var(--sub);margin:-6px 0 10px"></div>

      <div style="font-size:11px;font-weight:600;margin:12px 0 6px">AIå¼•æ“æ¨¡å‹é…ç½®ï¼š</div>
      <div id="engine-model-list" style="font-size:11px"></div>
      <button type="button" class="form-btn" onclick="saveAISettings()" style="margin-top:12px">ä¿å­˜è®¾ç½®</button>
      <div style="text-align:center;margin-top:8px"><span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="toggleKeyVisibility()">æ˜¾ç¤º/éšè—Key</span></div>
    </div>
  </div>
</div>

<!-- Holdings Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h3>æˆ‘çš„æŒä»“ <button onclick="closeModal()">âœ•</button></h3>
    <div id="holdings-list"></div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <div class="form-row"><label>æ·»åŠ åŸºé‡‘ï¼ˆè¾“å…¥ä»£ç æœç´¢ï¼‰</label>
        <div style="display:flex;gap:8px">
          <input type="text" id="holding-code-input" placeholder="è¾“å…¥åŸºé‡‘ä»£ç ï¼Œå¦‚ 000001" inputmode="numeric" maxlength="6" style="flex:1">
          <button type="button" class="form-btn" id="btn-search-holding" style="width:auto;margin:0;padding:10px 16px;flex-shrink:0">æœç´¢</button>
        </div>
      </div>
      <div id="holding-search-result"></div>
      <div class="form-row" id="holding-cost-row" style="display:none"><label>æŒä»“é‡‘é¢ (å…ƒ)</label><input type="number" id="cost-input" placeholder="10000" step="100" inputmode="decimal"></div>
      <button type="button" class="form-btn" id="btn-add-holding" style="display:none">æ·»åŠ æŒä»“</button>
    </div>
  </div>
</div>

<!-- Watchlist Modal -->
<div class="modal-overlay" id="watch-modal" onclick="if(event.target===this)closeWatchModal()">
  <div class="modal">
    <h3>â­ è‡ªé€‰åŸºé‡‘ç®¡ç† <button onclick="closeWatchModal()">âœ•</button></h3>
    <div class="wm-tabs">
      <div class="wm-tab active" onclick="switchWatchTab('search')" data-wtab="search">ğŸ” æœç´¢æ·»åŠ </div>
      <div class="wm-tab" onclick="switchWatchTab('pick')" data-wtab="pick">ğŸ“‹ å¿«é€Ÿé€‰æ‹©</div>
      <div class="wm-tab" onclick="switchWatchTab('manage')" data-wtab="manage">âš™ï¸ ç®¡ç†</div>
    </div>
    <div class="wm-view active" id="wm-search">
      <div class="wm-search">
        <input type="text" id="watch-code-input" placeholder="è¾“å…¥åŸºé‡‘ä»£ç ï¼Œå¦‚ 000001" inputmode="numeric" maxlength="6">
        <button onclick="searchFund()">æœç´¢</button>
      </div>
      <div id="watch-search-result"></div>
      <div style="font-size:11px;color:var(--sub);line-height:1.6;margin-top:8px">ğŸ’¡ è¾“å…¥6ä½åŸºé‡‘ä»£ç æœç´¢ï¼Œå¯æ·»åŠ ä»»æ„åŸºé‡‘åˆ°è‡ªé€‰åˆ—è¡¨ã€‚<br>æ•°æ®æ¥æºï¼šå¤©å¤©åŸºé‡‘å®æ—¶ä¼°å€¼æ¥å£ã€‚</div>
    </div>
    <div class="wm-view" id="wm-pick">
      <div style="font-size:11px;color:var(--sub);margin-bottom:10px">ç‚¹å‡»é€‰ä¸­/å–æ¶ˆï¼Œå¿«é€Ÿç®¡ç†å¸¸ç”¨åŸºé‡‘ï¼š</div>
      <div class="wm-grid" id="wm-pick-grid"></div>
    </div>
    <div class="wm-view" id="wm-manage">
      <div id="wm-manage-list"></div>
    </div>
  </div>
</div>

<script>
// ==================== CONFIG ====================
const FUND_DB = [
  {code:'000216',name:'åå®‰é»„é‡‘ETFè”æ¥A',type:'é»„é‡‘',baseNav:1.38},
  {code:'012414',name:'åå¤ä¸­è¯A500ETFè”æ¥A',type:'å®½åŸº',baseNav:1.25},
  {code:'011852',name:'å¤©å¼˜ä¸­è¯äº‘è®¡ç®—ä¸å¤§æ•°æ®ETFè”æ¥A',type:'AI/ç§‘æŠ€',baseNav:0.91},
  {code:'004814',name:'ä¸­æ¬§çº¢åˆ©ä¼˜äº«æ··åˆA',type:'çº¢åˆ©',baseNav:1.48},
  {code:'257070',name:'å›½æ³°ä¸­è¯å†›å·¥ETFè”æ¥A',type:'å†›å·¥',baseNav:1.12},
  {code:'003834',name:'åå¤èƒ½æºé©æ–°è‚¡ç¥¨A',type:'æ–°èƒ½æº',baseNav:1.65},
  {code:'161725',name:'æ‹›å•†ä¸­è¯ç™½é…’æŒ‡æ•°A',type:'ç™½é…’/æ¶ˆè´¹',baseNav:1.28},
  {code:'110011',name:'æ˜“æ–¹è¾¾ä¸­å°ç›˜æ··åˆ',type:'ä¸­å°ç›˜',baseNav:5.52},
  {code:'005827',name:'æ˜“æ–¹è¾¾è“ç­¹ç²¾é€‰æ··åˆ',type:'è“ç­¹',baseNav:2.05},
  {code:'001156',name:'ç”³ä¸‡è±ä¿¡ä¸­è¯åŠå¯¼ä½“æŒ‡æ•°A',type:'åŠå¯¼ä½“',baseNav:1.18},
  {code:'320007',name:'è¯ºå®‰æˆé•¿æ··åˆ',type:'åŠå¯¼ä½“/ç§‘æŠ€',baseNav:1.42},
  {code:'160119',name:'å—æ–¹ä¸­è¯500ETFè”æ¥A',type:'å®½åŸº',baseNav:1.55},
];

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'ç¡…åŸºæµåŠ¨(å…è´¹)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    desc:'å…è´¹å¼€æºæ¨¡å‹ï¼Œæ³¨å†Œå³ç”¨ï¼Œæ— éœ€å……å€¼',
    link:'https://cloud.siliconflow.cn',
    models: [
      {id:'doubao', name:'DeepSeek-V3', icon:'ğŸ«˜', color:'#6366f1', style:'åæŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'deepseek-ai/DeepSeek-V3'},
      {id:'qwen', name:'Qwen2.5-72B', icon:'ğŸ”®', color:'#ec4899', style:'åå®è§‚ç»æµ+æ”¿ç­–é¢', model:'Qwen/Qwen2.5-72B-Instruct'},
      {id:'deepseek', name:'DeepSeek-R1-32B', icon:'ğŸ”', color:'#3b82f6', style:'åæ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-ai/DeepSeek-R1-Distill-Qwen-32B'},
      {id:'gemini', name:'Gemma-2-27B', icon:'â™Š', color:'#f59e0b', style:'åå…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'google/gemma-2-27b-it'},
    ]
  },
  {
    id:'deepseek', name:'DeepSeekå®˜æ–¹(æä½ä»·)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    desc:'Â¥1/ç™¾ä¸‡tokenï¼Œå‡ ä¹å…è´¹ï¼Œæ–°ç”¨æˆ·èµ Â¥10',
    link:'https://platform.deepseek.com',
    models: [
      {id:'doubao', name:'DeepSeek-V3â‘ ', icon:'ğŸ«˜', color:'#6366f1', style:'åæŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'deepseek-chat'},
      {id:'qwen', name:'DeepSeek-V3â‘¡', icon:'ğŸ”®', color:'#ec4899', style:'åå®è§‚ç»æµ+æ”¿ç­–é¢', model:'deepseek-chat'},
      {id:'deepseek', name:'DeepSeek-R1', icon:'ğŸ”', color:'#3b82f6', style:'åæ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-reasoner'},
      {id:'gemini', name:'DeepSeek-V3â‘¢', icon:'â™Š', color:'#f59e0b', style:'åå…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'deepseek-chat'},
    ]
  },
  {
    id:'302ai', name:'302.AI(ä»˜è´¹)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    desc:'èšåˆå¹³å°ï¼Œæ”¯æŒå¤šç§æ¨¡å‹ï¼Œéœ€å……å€¼',
    link:'https://302.ai',
    models: [
      {id:'doubao', name:'è±†åŒ…', icon:'ğŸ«˜', color:'#6366f1', style:'åæŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'doubao-1.5-pro-32k'},
      {id:'qwen', name:'é€šä¹‰åƒé—®', icon:'ğŸ”®', color:'#ec4899', style:'åå®è§‚ç»æµ+æ”¿ç­–é¢', model:'qwen3-235b-a22b'},
      {id:'deepseek', name:'DeepSeek', icon:'ğŸ”', color:'#3b82f6', style:'åæ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-r1'},
      {id:'gemini', name:'Gemini', icon:'â™Š', color:'#f59e0b', style:'åå…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'gemini-2.5-flash'},
    ]
  }
];

// Active provider & engines (loaded from localStorage)
let _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
let _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
let AI_ENGINES = _aiProvider.models;
let _apiBase = _aiProvider.base;

// Recommended fund pool â€” hot funds across sectors for buy recommendations
const RECO_FUND_POOL = [
  // é»„é‡‘/è´µé‡‘å±
  {code:'002610',name:'åšæ—¶é»„é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['é¿é™©','è´µé‡‘å±','æŠ—é€šèƒ€']},
  {code:'007929',name:'åå®‰é»„é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['é¿é™©','é»„é‡‘','ä½è´¹ç‡']},
  {code:'008986',name:'å—æ–¹ä¸Šæµ·é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['æ²ªé‡‘','å®ç‰©é»„é‡‘','é¿é™©']},
  // ç§‘æŠ€/AI
  {code:'015047',name:'å¹¿å‘äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',tags:['AI','äººå·¥æ™ºèƒ½','äº§ä¸šè¶‹åŠ¿']},
  {code:'017992',name:'æ˜“æ–¹è¾¾ä¸­è¯äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',tags:['AI','æœºå™¨äºº','ç®—åŠ›']},
  {code:'014557',name:'ä¸‡å®¶ä¸­è¯èŠ¯ç‰‡äº§ä¸šæŒ‡æ•°C',type:'åŠå¯¼ä½“',tags:['èŠ¯ç‰‡','å›½äº§æ›¿ä»£','ç¡¬ç§‘æŠ€']},
  {code:'013313',name:'åå®ä¸­è¯ç§‘æŠ€é¾™å¤´ETFè”æ¥C',type:'ç§‘æŠ€',tags:['ç§‘æŠ€é¾™å¤´','ç¡¬æ ¸ç§‘æŠ€','å¤§ç›˜']},
  // å†›å·¥/å›½é˜²
  {code:'012860',name:'é•¿åŸå†›å·¥æˆé•¿ETFè”æ¥C',type:'å†›å·¥',tags:['å›½é˜²å†›å·¥','åœ°ç¼˜æ”¿æ²»','æˆ˜ç•¥']},
  {code:'008281',name:'å¯Œå›½ä¸­è¯å†›å·¥é¾™å¤´ETFè”æ¥C',type:'å†›å·¥',tags:['å†›å·¥é¾™å¤´','å¤§é£æœº','èˆªå¤©']},
  // æ–°èƒ½æº/ç»¿è‰²
  {code:'013010',name:'å¤©å¼˜ä¸­è¯æ–°èƒ½æºè½¦ETFè”æ¥C',type:'æ–°èƒ½æº',tags:['æ–°èƒ½æºè½¦','ç”µæ± ','æ™ºèƒ½é©¾é©¶']},
  {code:'012726',name:'å˜‰å®æ–°èƒ½æºæ–°ææ–™ETFè”æ¥C',type:'æ–°èƒ½æº',tags:['é”šç”µæ± ','å…‰ä¼','é£ç”µ']},
  // æ¶ˆè´¹/åŒ»è¯
  {code:'012762',name:'å¤©å¼˜ä¸­è¯é£Ÿå“é¥®æ–™ETFè”æ¥C',type:'æ¶ˆè´¹',tags:['é£Ÿå“é¥®æ–™','å†…éœ€','ç¡®å®šæ€§']},
  {code:'001550',name:'å¤©å¼˜ä¸­è¯åŒ»è¯100A',type:'åŒ»è¯',tags:['åŒ»è¯','åˆ›æ–°è¯','è€é¾„åŒ–']},
  {code:'014584',name:'æ±‡æ·»å¯Œä¸­è¯ç»†åˆ†é£Ÿå“é¥®æ–™äº§ä¸šC',type:'æ¶ˆè´¹',tags:['ç™½é…’','é£Ÿå“','æ¶ˆè´¹å¤è‹']},
  // çº¢åˆ©/ä½æ³¢åŠ¨
  {code:'012643',name:'å¤©å¼˜çº¢åˆ©ä½æ³¢åŠ¨C',type:'çº¢åˆ©',tags:['çº¢åˆ©','ä½æ³¢åŠ¨','é˜²å¾¡']},
  {code:'012070',name:'ä¸‡å®¶ä¸­è¯çº¢åˆ©ETFè”æ¥C',type:'çº¢åˆ©',tags:['é«˜è‚¡æ¯','ä»·å€¼','ç¨³å¥']},
  // å®½åŸº/æŒ‡æ•°
  {code:'007339',name:'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥C',type:'å®½åŸº',tags:['æ²ªæ·±300','ç™½é©¬','æ ¸å¿ƒèµ„äº§']},
  {code:'006881',name:'å¤©å¼˜åˆ›ä¸šæ¿ETFè”æ¥C',type:'å®½åŸº',tags:['åˆ›ä¸šæ¿','æˆé•¿','ç§‘æŠ€']},
  {code:'013601',name:'åå®‰ä¸­è¯A500ETFè”æ¥C',type:'å®½åŸº',tags:['A500','å¤§ç›˜','æ ¸å¿ƒ']},
  // QDII/æµ·å¤–
  {code:'006327',name:'æ˜“æ–¹è¾¾åŸæ²¹Aäººæ°‘å¸(QDII)',type:'å•†å“/QDII',tags:['åŸæ²¹','å•†å“','æŠ—é€šèƒ€']},
  {code:'164824',name:'ä¿¡è¯šå…¨çƒå•†å“ä¸»é¢˜(QDII)',type:'å•†å“/QDII',tags:['å•†å“','å…¨çƒé…ç½®','å¯¹å†²']},
  {code:'012548',name:'å—æ–¹ä¸œè‹±ç§‘æŠ€åˆ›æ–°ETF(QDII)C',type:'QDII/ç§‘æŠ€',tags:['ç¾è‚¡ç§‘æŠ€','å…¨çƒ','çº³æ–¯è¾¾å…‹']},
  // æœ‰è‰²/èµ„æº
  {code:'014832',name:'å¤©å¼˜ä¸­è¯æœ‰è‰²é‡‘å±ETFè”æ¥C',type:'æœ‰è‰²é‡‘å±',tags:['æœ‰è‰²','é“œé“','å‘¨æœŸ']},
  {code:'008064',name:'å›½æ³°ä¸­è¯é’¢é“ETFè”æ¥C',type:'èµ„æº',tags:['é’¢é“','å‘¨æœŸ','åŸºå»º']},
  // é‡‘è/åœ°äº§
  {code:'013308',name:'æ˜“æ–¹è¾¾ä¸­è¯å…¨æŒ‡è¯åˆ¸å…¬å¸C',type:'é‡‘è',tags:['åˆ¸å•†','ç‰µç‰›','æ”¿ç­–å—ç›Š']},
];


const INDICES_CONFIG = [
  {name:'ä¸Šè¯',secid:'1.000001',group:'stock'},
  {name:'æ·±æˆ',secid:'0.399001',group:'stock'},
  {name:'åˆ›ä¸šæ¿',secid:'0.399006',group:'stock'},
  {name:'æ²ªé‡‘',secid:'118.AU9999',group:'commodity'},
  {name:'æ²ªé“¶',secid:'118.AG9999',group:'commodity'},
  {name:'æœ‰è‰²',secid:'90.BK0478',group:'commodity'},
  {name:'è´µé‡‘å±',secid:'90.BK0732',group:'commodity'},
];

// ==================== STATE ====================
let holdings = JSON.parse(localStorage.getItem('fa_holdings')||'[]');
let watchlist = JSON.parse(localStorage.getItem('fa_watchlist')||'[]'); // [{code,name,type}]
let messages = [];
let liveIndices = {};
let liveFundData = {};
let liveSectors = [];
let lastAnalysisDate = localStorage.getItem('fa_lastAnalysis')||'';
let lastRecoDate = localStorage.getItem('fa_lastReco')||'';
let analysisData = null;
let recoData = null;
let refreshTimer = null;
let msgTimer = null;
let lastMsgTime = 0;
let _302aiKey = localStorage.getItem('fa_302ai_key') || 'sk-njqerftsrrnojbsdagigsrzbwwxgtuhrsyihphcxvsdpbaxl';
let _aiAnalyzing = false; // lock to prevent concurrent AI calls

function saveHoldings(){ localStorage.setItem('fa_holdings', JSON.stringify(holdings)); }
function saveWatchlist(){ localStorage.setItem('fa_watchlist', JSON.stringify(watchlist)); }
function save302Key(key){ _302aiKey=key; localStorage.setItem('fa_302ai_key', key); }
function saveProvider(id){
  _aiProviderId = id;
  _aiProvider = AI_PROVIDERS.find(p=>p.id===id) || AI_PROVIDERS[0];
  AI_ENGINES = _aiProvider.models;
  _apiBase = _aiProvider.base;
  localStorage.setItem('fa_ai_provider', id);
}

// ==================== UTILITIES ====================
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function timeStr(d){ d=d||new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
function timeStrSec(d){ d=d||new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }
function fmt(n,d=2){ return Number(n).toFixed(d); }
function sign(n){ return n>=0?'+':''; }
function seededRand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

// ==================== CHINESE HOLIDAYS (Aè‚¡ä¼‘å¸‚æ—¥) ====================
// å…ƒæ—¦ã€æ˜¥èŠ‚ã€æ¸…æ˜ã€åŠ³åŠ¨èŠ‚ã€ç«¯åˆã€ä¸­ç§‹ã€å›½åº† åŠè°ƒä¼‘
const CN_HOLIDAYS = (function(){
  const h = new Set();
  function add(y,m,d){ h.add(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`); }
  function range(y,m,d1,d2){ for(let d=d1;d<=d2;d++) add(y,m,d); }
  function rangeAcross(y,m1,d1,m2,d2){ // across months
    const s=new Date(y,m1-1,d1), e=new Date(y,m2-1,d2);
    for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1)) add(d.getFullYear(),d.getMonth()+1,d.getDate());
  }
  // ===== 2025 =====
  // å…ƒæ—¦ 1.1(å‘¨ä¸‰)
  add(2025,1,1);
  // æ˜¥èŠ‚: é™¤å¤•1.28(å‘¨äºŒ)-2.4(å‘¨äºŒ), å·¥ä½œæ—¥ä¼‘å¸‚: 1.28-1.31, 2.3-2.4
  range(2025,1,28,31); range(2025,2,3,4);
  // æ¸…æ˜ 4.4(å‘¨äº”)-4.6(å‘¨æ—¥), å·¥ä½œæ—¥: 4.4
  add(2025,4,4);
  // åŠ³åŠ¨èŠ‚ 5.1(å‘¨å››)-5.5(å‘¨ä¸€), å·¥ä½œæ—¥: 5.1-5.2, 5.5
  range(2025,5,1,2); add(2025,5,5);
  // ç«¯åˆ 5.31(å‘¨å…­)-6.2(å‘¨ä¸€), å·¥ä½œæ—¥: 6.2
  add(2025,6,2);
  // å›½åº†+ä¸­ç§‹ 10.1(å‘¨ä¸‰)-10.8(å‘¨ä¸‰), å·¥ä½œæ—¥: 10.1-10.3, 10.6-10.8
  range(2025,10,1,3); range(2025,10,6,8);

  // ===== 2026 =====
  // å…ƒæ—¦ 1.1(å‘¨å››)-1.2(å‘¨äº”)
  range(2026,1,1,2);
  // æ˜¥èŠ‚: é™¤å¤•2.16(å‘¨ä¸€)-2.22(å‘¨æ—¥),  å·¥ä½œæ—¥ä¼‘å¸‚: 2.16-2.20
  range(2026,2,16,20);
  // æ¸…æ˜ 4.4(å‘¨å…­)-4.6(å‘¨ä¸€), å·¥ä½œæ—¥: 4.6
  add(2026,4,6);
  // åŠ³åŠ¨èŠ‚ 5.1(å‘¨äº”)-5.5(å‘¨äºŒ), å·¥ä½œæ—¥: 5.1, 5.4-5.5
  add(2026,5,1); range(2026,5,4,5);
  // ç«¯åˆ 6.19(å‘¨äº”)-6.21(å‘¨æ—¥), å·¥ä½œæ—¥: 6.19
  add(2026,6,19);
  // ä¸­ç§‹ 9.25(å‘¨äº”)-9.27(å‘¨æ—¥), å·¥ä½œæ—¥: 9.25
  add(2026,9,25);
  // å›½åº† 10.1(å‘¨å››)-10.7(å‘¨ä¸‰), å·¥ä½œæ—¥: 10.1-10.2, 10.5-10.7
  range(2026,10,1,2); range(2026,10,5,7);

  // ===== 2027 =====
  // å…ƒæ—¦ 1.1(å‘¨äº”)-1.3(å‘¨æ—¥), å·¥ä½œæ—¥: 1.1
  add(2027,1,1);
  // æ˜¥èŠ‚: é™¤å¤•2.5(å‘¨äº”)-2.11(å‘¨å››), å·¥ä½œæ—¥: 2.5, 2.8-2.11
  add(2027,2,5); range(2027,2,8,11);
  // æ¸…æ˜ 4.3(å‘¨å…­)-4.5(å‘¨ä¸€), å·¥ä½œæ—¥: 4.5
  add(2027,4,5);
  // åŠ³åŠ¨èŠ‚ 5.1(å‘¨å…­)-5.5(å‘¨ä¸‰), å·¥ä½œæ—¥: 5.3-5.5
  range(2027,5,3,5);
  // ç«¯åˆ 6.9(å‘¨ä¸‰)-6.11(å‘¨äº”), å·¥ä½œæ—¥: 6.9-6.11
  range(2027,6,9,11);
  // ä¸­ç§‹ 9.15(å‘¨ä¸‰)-9.17(å‘¨äº”), å·¥ä½œæ—¥: 9.15-9.17
  range(2027,9,15,17);
  // å›½åº† 10.1(å‘¨äº”)-10.7(å‘¨å››), å·¥ä½œæ—¥: 10.1, 10.4-10.7
  add(2027,10,1); range(2027,10,4,7);

  return h;
})();

function isChinaHoliday(date){
  const d = date || new Date();
  const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  return CN_HOLIDAYS.has(key);
}

function getHolidayName(date){
  const d = date || new Date();
  const m = d.getMonth()+1, day = d.getDate(), y = d.getFullYear();
  // Rough match by date ranges
  if(m===1 && day<=3) return 'å…ƒæ—¦';
  if(m===2 && day>=5 && day<=24) return 'æ˜¥èŠ‚';
  if(m===1 && day>=25) return 'æ˜¥èŠ‚';
  if(m===4 && day>=3 && day<=6) return 'æ¸…æ˜èŠ‚';
  if(m===5 && day>=1 && day<=5) return 'åŠ³åŠ¨èŠ‚';
  if(m===5 && day>=28 || m===6 && day<=2) return 'ç«¯åˆèŠ‚';
  if(m===6 && day>=9 && day<=21) return 'ç«¯åˆèŠ‚';
  if(m===9 && day>=15 && day<=27) return 'ä¸­ç§‹èŠ‚';
  if(m===10 && day>=1 && day<=8) return 'å›½åº†èŠ‚';
  return 'èŠ‚å‡æ—¥';
}

function getMarketPhase(){
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const t = h*60+m;
  const day = now.getDay();
  if(day===0||day===6) return 'closed';
  if(isChinaHoliday(now)) return 'holiday';
  if(t < 9*60+15) return 'pre';
  if(t < 9*60+30) return 'soon';
  if(t < 11*60+30) return 'morning';
  if(t < 13*60) return 'lunch';
  if(t < 15*60) return 'afternoon';
  return 'closed';
}

function isTrading(){
  const p = getMarketPhase();
  return p==='morning'||p==='afternoon';
}

function getNextOpenCountdown(){
  const now = new Date();
  let target = new Date(now);
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const t = h*60+m;
  
  // If today is a trading weekday, not a holiday, and before 9:30
  if(day>=1 && day<=5 && !isChinaHoliday(now) && t < 9*60+30){
    target.setHours(9,30,0,0);
  } else {
    // Find the next non-weekend, non-holiday day
    target.setDate(target.getDate()+1);
    target.setHours(9,30,0,0);
    let safety = 0;
    while(safety < 30){
      const wd = target.getDay();
      if(wd>=1 && wd<=5 && !isChinaHoliday(target)) break;
      target.setDate(target.getDate()+1);
      safety++;
    }
  }
  
  const diff = target - now;
  if(diff <= 0) return null;
  const totalH = Math.floor(diff/3600000);
  const mins = Math.floor((diff%3600000)/60000);
  const secs = Math.floor((diff%60000)/1000);
  if(totalH >= 24){
    const days = Math.floor(totalH/24);
    const remH = totalH%24;
    return `${days}å¤©${String(remH).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  }
  return `${String(totalH).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

// ==================== JSONP ENGINE ====================
let _jcnt=0;
function jsonpFetch(url, opts={}){
  return new Promise((resolve, reject)=>{
    const cbName = opts.fixedCb || `_jp${++_jcnt}_${Date.now()}`;
    const timeout = opts.timeout || 8000;
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
    function cleanup(){ clearTimeout(timer); if(!opts.fixedCb) delete window[cbName]; try{script.remove();}catch(e){} }
    window[cbName] = function(data){ cleanup(); resolve(data); };
    let finalUrl = url;
    if(!opts.fixedCb) finalUrl += (url.includes('?')?'&':'?') + `cb=${cbName}`;
    finalUrl += (finalUrl.includes('?')?'&':'?') + `_t=${Date.now()}`;
    script.src = finalUrl;
    script.onerror = ()=>{ cleanup(); reject(new Error('network')); };
    document.head.appendChild(script);
  });
}

// ==================== LIVE DATA APIS ====================
async function fetchIndices(){
  try{
    const secids = INDICES_CONFIG.map(i=>i.secid).join(',');
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=${secids}&fields=f2,f3,f4,f12,f13,f14`);
    if(data?.data?.diff){
      data.data.diff.forEach(d=>{
        const key=`${d.f13}.${d.f12}`;
        if(d.f2!=='-'&&!isNaN(d.f2)) liveIndices[key]={name:d.f14,price:d.f2,pct:d.f3,change:d.f4};
      });
      return true;
    }
  }catch(e){}
  return false;
}

async function fetchSectors(){
  try{
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=20&po=1&np=1&fltt=2&invt=2&fid=f3&fs=m:90+t:2&fields=f3,f14`);
    if(data?.data?.diff){
      liveSectors = data.data.diff.map(d=>({name:d.f14,pct:d.f3})).filter(d=>!isNaN(d.pct)).sort((a,b)=>b.pct-a.pct);
      return true;
    }
  }catch(e){}
  return false;
}

async function fetchFundEstimate(code){
  return new Promise((resolve, reject)=>{
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{ done(); reject(new Error('timeout')); }, 5000);
    function done(){ clearTimeout(timer); try{script.remove();}catch(e){} }
    window.jsonpgz = function(d){ done(); resolve(d); };
    script.src = `http://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
    script.onerror = ()=>{ done(); reject(new Error('error')); };
    document.head.appendChild(script);
  });
}

async function fetchAllFunds(){
  const codes = [...new Set(holdings.map(h=>h.code))];
  for(const code of codes){
    try{
      const d = await fetchFundEstimate(code);
      if(d?.gsz) liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name||'', gztime:d.gztime||'' };
    }catch(e){}
    await new Promise(r=>setTimeout(r,120));
  }
}

function getFundData(code){
  if(liveFundData[code]) return liveFundData[code];
  const f = FUND_DB.find(x=>x.code===code);
  const r = RECO_FUND_POOL.find(x=>x.code===code);
  const seed = parseInt(todayStr().replace(/-/g,''))+parseInt(code);
  const pct = (seededRand(seed)-0.46)*4;
  const dwjz = (f?f.baseNav:1)*(1+(seededRand(seed+100)-0.5)*0.3);
  const nm = f?f.name : r?r.name : code;
  return {gsz:dwjz*(1+pct/100), dwjz, gszzl:pct, name:nm, gztime:todayStr()+' 15:00'};
}

function getIndexData(cfg){
  if(liveIndices[cfg.secid]) return liveIndices[cfg.secid];
  const base={'1.000001':3340,'0.399001':10420,'0.399006':2110,'118.AU9999':680,'118.AG9999':8200,'90.BK0478':28000,'90.BK0732':2800}[cfg.secid]||3000;
  const seed = parseInt(todayStr().replace(/-/g,''))+(cfg.secid.charCodeAt(2)||0)*137;
  const pct=(seededRand(seed)-0.46)*4;
  return {name:cfg.name,price:base*(1+pct/100),pct,change:base*pct/100};
}

// ==================== CLOCK ====================
function updateClock(){
  document.getElementById('clock').textContent = timeStrSec();
  const phase = getMarketPhase();
  const badge = document.getElementById('market-badge');
  const sub = document.getElementById('topbar-sub');
  
  if(phase==='morning'||phase==='afternoon'){
    badge.textContent='äº¤æ˜“ä¸­'; badge.className='market-badge open';
    sub.textContent=`Aè‚¡äº¤æ˜“ä¸­ Â· å®æ—¶ç›‘æ§æŒä»“åŠ¨æ€`;
  } else if(phase==='lunch'){
    badge.textContent='åˆé—´ä¼‘å¸‚'; badge.className='market-badge soon';
    sub.textContent='åˆé—´ä¼‘å¸‚ä¸­ï¼Œ13:00æ¢å¤äº¤æ˜“';
  } else if(phase==='soon'){
    badge.textContent='å³å°†å¼€ç›˜'; badge.className='market-badge soon';
    sub.textContent='é›†åˆç«ä»·ä¸­ï¼Œå³å°†å¼€ç›˜';
  } else if(phase==='pre'){
    badge.textContent='ç›˜å‰'; badge.className='market-badge closed';
    const cd = getNextOpenCountdown();
    sub.textContent=cd?`è·å¼€ç›˜ ${cd}`:'ç­‰å¾…å¼€ç›˜';
  } else if(phase==='holiday'){
    const hName = getHolidayName(new Date());
    badge.textContent=`${hName}ä¼‘å¸‚`; badge.className='market-badge closed';
    const cd = getNextOpenCountdown();
    sub.textContent=cd?`${hName}å‡æœŸä¼‘å¸‚ä¸­ Â· è·ä¸‹æ¬¡å¼€ç›˜ ${cd}`:`${hName}å‡æœŸä¼‘å¸‚ä¸­`;
  } else {
    badge.textContent='å·²æ”¶ç›˜'; badge.className='market-badge closed';
    const cd = getNextOpenCountdown();
    sub.textContent=cd?`è·ä¸‹æ¬¡å¼€ç›˜ ${cd}`:'ä¼‘å¸‚ä¸­';
  }
}

// ==================== RENDER TOP INDICES ====================
function renderTopIndices(){
  const el = document.getElementById('topbar-indices');
  const stockIndices = INDICES_CONFIG.filter(c=>c.group==='stock');
  const commodityIndices = INDICES_CONFIG.filter(c=>c.group==='commodity');
  
  function renderIdxRow(list, isCommodity){
    return list.map(cfg=>{
      const d = getIndexData(cfg);
      const c = d.pct>=0?'var(--up)':'var(--down)';
      const cls = isCommodity ? 'idx-mini commodity' : 'idx-mini';
      const isGold = cfg.secid.includes('AU');
      const isSilver = cfg.secid.includes('AG');
      const priceStr = (isGold||isSilver) ? fmt(d.price,2) : fmt(d.price,0);
      return `<div class="${cls}"><div class="idx-name">${cfg.name}</div><div class="idx-val">${priceStr}</div><div class="idx-pct" style="color:${c}">${sign(d.pct)}${fmt(d.pct)}%</div></div>`;
    }).join('');
  }
  
  el.innerHTML = `<div class="idx-row">${renderIdxRow(stockIndices, false)}</div>
    <div class="idx-row"><span class="idx-row-label">å•†å“</span>${renderIdxRow(commodityIndices, true)}</div>`;
}

// ==================== MESSAGE SYSTEM ====================
function addMessage(msg){
  msg.time = msg.time || timeStr();
  msg.id = msg.id || Date.now()+Math.random();
  messages.push(msg);
  if(messages.length > 50) messages = messages.slice(-50);
  renderFeed();
  // Auto scroll
  setTimeout(()=>{
    const main = document.getElementById('main-content');
    main.scrollTop = main.scrollHeight;
  }, 50);
}

function renderHoldingsCard(){
  if(holdings.length===0) return '';
  const needCollapse = holdings.length > 3;
  let html = `<div class="holdings-card"><div class="holdings-title">ğŸ“Š ä»Šæ—¥æŒä»“åŠ¨æ€ <span style="font-size:10px;color:var(--sub);font-weight:400">${holdings.length}åª</span></div>`;
  if(needCollapse) html += `<div class="collapse-list" id="cl-holdings">`;
  holdings.forEach(h=>{
    const f = getFundData(h.code);
    const pct = f.gszzl||0;
    const c = pct>=0?'var(--up)':'var(--down)';
    const info = FUND_DB.find(x=>x.code===h.code);
    const liveInfo = liveFundData[h.code];
    const recoInfo = RECO_FUND_POOL.find(x=>x.code===h.code);
    const name = info ? info.name : (liveInfo?.name || h.name || recoInfo?.name || h.code);
    const type = info ? info.type : (recoInfo?.type || 'åŸºé‡‘');
    html += `<div class="h-item ${needCollapse?'cl-item':''}"><div class="h-dot" style="background:${c}"></div><div class="h-info"><div class="h-name">${name}</div><div class="h-code">${h.code} Â· ${type}</div></div><div class="h-pct" style="color:${c}">${sign(pct)}${fmt(pct)}%</div></div>`;
  });
  if(needCollapse) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-holdings')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${holdings.length-3}åª</div></div>`;
  html += `</div>`;
  return html;
}

function renderWatchCard(){
  if(watchlist.length===0) return '';
  const needCollapse = watchlist.length > 3;
  let html = `<div class="watch-card"><div class="watch-header"><div class="watch-title">â­ è‡ªé€‰åŸºé‡‘ <span style="font-size:10px;color:var(--sub);font-weight:400">${watchlist.length}åª</span></div><div class="watch-edit" onclick="openWatchModal()">ç®¡ç† â€º</div></div>`;
  if(needCollapse) html += `<div class="collapse-list" id="cl-watch">`;
  watchlist.forEach(w=>{
    const f = getFundData(w.code);
    const pct = f.gszzl||0;
    const c = pct>=0?'var(--up)':'var(--down)';
    const navStr = f.gsz ? fmt(f.gsz,4) : '--';
    html += `<div class="w-item ${needCollapse?'cl-item':''}"><div class="w-icon">${(w.type||'åŸº')[0]}</div><div class="w-info"><div class="w-name">${w.name||f.name||w.code}</div><div class="w-code">${w.code} Â· ${w.type||'åŸºé‡‘'}</div></div><div class="w-data"><div class="w-nav">${navStr}</div><div class="w-pct" style="color:${c}">${sign(pct)}${fmt(pct)}%</div></div></div>`;
  });
  if(needCollapse) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-watch')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${watchlist.length-3}åª</div></div>`;
  html += `</div>`;
  return html;
}

let _currentPageTab = 'holdings'; // 'holdings' | 'watchlist'

function toggleCollapse(id){
  const el = document.getElementById(id);
  if(!el) return;
  const expanded = el.classList.toggle('expanded');
  const toggle = el.querySelector('.cl-toggle');
  if(toggle){
    const count = el.querySelectorAll('.cl-item').length - 3;
    toggle.innerHTML = expanded 
      ? '<span class="cl-arrow">â–¼</span> æ”¶èµ·'
      : `<span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${count}åª`;
  }
}

function switchPageTab(tab){
  _currentPageTab = tab;
  renderFeed();
}

function renderFeed(){
  const main = document.getElementById('main-content');
  const phase = getMarketPhase();
  let html = '';
  
  // Page tab bar
  html += `<div class="page-tabs">
    <div class="page-tab ${_currentPageTab==='holdings'?'active':''}" onclick="switchPageTab('holdings')">ğŸ“Š æŒä»“<span class="pt-badge">${holdings.length}</span></div>
    <div class="page-tab ${_currentPageTab==='watchlist'?'active':''}" onclick="switchPageTab('watchlist')">â­ è‡ªé€‰<span class="pt-badge">${watchlist.length}</span></div>
  </div>`;
  
  html += `<div class="page-content">`;
  
  if(_currentPageTab==='holdings'){
    // === HOLDINGS TAB ===
    html += renderHoldingsCard();
    html += renderAILiveCard();
    html += renderManagerAnalysisEntry();
    
    if(!isTrading() && phase!=='lunch' && phase!=='soon'){
      const cd = getNextOpenCountdown();
      const isHoliday = phase==='holiday';
      const hName = isHoliday ? getHolidayName(new Date()) : '';
      html += `<div class="status-card">
        <div class="status-icon">${isHoliday?'ğŸ‰':phase==='pre'?'ğŸŒ…':'ğŸŒ™'}</div>
        <div class="status-title">${isHoliday?hName+'å‡æœŸä¼‘å¸‚':phase==='pre'?'ç›˜å‰å‡†å¤‡ä¸­':'Aè‚¡å·²æ”¶ç›˜'}</div>
        <div class="status-desc">${isHoliday?`${hName}å‡æœŸæœŸé—´Aè‚¡ä¼‘å¸‚ï¼ŒèŠ‚åå°†æ¢å¤äº¤æ˜“<br>å°åŠ©ç†å·²ä¸ºæ‚¨è®°å½•ä¼‘å¸‚å‰æœ€åæ•°æ®`:`å°åŠ©ç†å°†åœ¨äº¤æ˜“æ—¶æ®µ(9:30-15:00)ä¸ºæ‚¨å®æ—¶æ¨é€æ¶ˆæ¯<br>14:30è¿›è¡Œå¤šAIç»¼åˆåˆ†æ Â· 14:35ç»™å‡ºæ“ä½œå»ºè®®`}</div>
        ${cd?`<div class="countdown">è·å¼€ç›˜${isHoliday?' â†’ ':' '}${cd}</div>`:''}
      </div>`;
    }
    
    // Messages
    html += `<div class="msg-feed" id="msg-feed">`;
    messages.forEach(m=>{
      if(m.type==='analysis'){ html += renderAnalysisPanel(m.data); return; }
      if(m.type==='reco'){ html += renderRecoPanel(m.data); return; }
      const avatarClass = m.avatar||'sys';
      html += `<div class="msg"><div class="msg-header"><div class="msg-avatar ${avatarClass}">${m.icon||'ğŸ“¢'}</div><div class="msg-name">${m.from||'å°åŠ©ç†'}</div><div class="msg-time">${m.time}</div></div><div class="msg-body">${m.body}</div></div>`;
    });
    html += `</div>`;
    
  } else {
    // === WATCHLIST TAB ===
    if(watchlist.length===0){
      html += `<div class="status-card"><div class="status-icon">â­</div><div class="status-title">æš‚æ— è‡ªé€‰åŸºé‡‘</div><div class="status-desc">ç‚¹å‡»ä¸‹æ–¹â€œâ­ è‡ªé€‰â€æŒ‰é’®æ·»åŠ æ‚¨å…³æ³¨çš„åŸºé‡‘</div></div>`;
    } else {
      html += renderWatchCard();
      html += renderAIWatchAnalysis();
    }
    html += renderManagerAnalysisEntry();
  }
  
  html += `</div>`;
  main.innerHTML = html;
}

// Render AI analysis specifically for watchlist funds
function renderAIWatchAnalysis(){
  if(!analysisData || watchlist.length===0) return '';
  const data = analysisData;
  
  let html = `<div class="ai-live-card">
    <div class="ai-live-header">
      <div class="alh-left"><span class="alh-title">ğŸ§  è‡ªé€‰AIç ”åˆ¤</span></div>
      <button class="alh-btn" onclick="refreshAnalysis()">â†» åˆ·æ–°</button>
    </div>
    <div style="padding:14px">`;
  
  // Show synthesized watchlist recommendations
  const awCollapse = watchlist.length > 3;
  if(awCollapse) html += `<div class="collapse-list" id="cl-aiwatch">`;
  watchlist.forEach(w=>{
    const f = getFundData(w.code);
    const pct = f.gszzl||0;
    const c = pct>=0?'var(--up)':'var(--down)';
    // Collect votes from available AIs only
    let buys=0,sells=0,holds=0;
    AI_ENGINES.filter(eng=>data[eng.id]).forEach(eng=>{
      const views = data[eng.id]?.watchViews;
      const v = views?.find(x=>x.code===w.code);
      if(v){ if(v.action==='buy') buys++; else if(v.action==='sell') sells++; else holds++; }
    });
    let action='hold', actLabel='æŒæœ‰';
    if(buys>sells && buys>holds){action='buy'; actLabel='å»ºè®®å…³æ³¨';}
    else if(sells>buys && sells>holds){action='sell'; actLabel='æš‚æ—¶è§‚æœ›';}
    
    html += `<div class="synth-fund-item ${awCollapse?'cl-item':''}">
      <div class="sfi-name">${w.name||w.code}<br><span style="font-size:10px;color:var(--sub)">${w.code}</span></div>
      <div class="sfi-pct" style="color:${c}">${sign(pct)}${fmt(pct)}%</div>
      <div class="sfi-votes">${buys}ğŸ“ˆ${holds}âš–ï¸${sells}ğŸ“‰</div>
      <div class="sfi-action ${action}">${actLabel}</div>
    </div>`;
  });
  if(awCollapse) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-aiwatch')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${watchlist.length-3}åª</div></div>`;
  
  html += `</div></div>`;
  return html;
}

// ==================== MARKET MESSAGE GENERATOR ====================
function generateMarketMessages(){
  if(!isTrading()) return;
  const now = new Date();
  const elapsed = now - lastMsgTime;
  if(elapsed < 45000) return; // max 1 msg per 45s
  lastMsgTime = Date.now();
  
  const seed = Date.now();
  const r = seededRand(seed);
  
  // Gather live data
  const shData = getIndexData(INDICES_CONFIG[0]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const sectors = liveSectors.length>0 ? liveSectors : [];
  const topUp = sectors.filter(s=>s.pct>0).slice(0,3);
  const topDown = sectors.filter(s=>s.pct<0).slice(-3).reverse();
  
  const msgTypes = [];
  
  // Index movement alerts
  if(Math.abs(shData.pct)>1.5){
    msgTypes.push({
      icon: shData.pct>0?'ğŸ”´':'ğŸŸ¢',
      avatar: shData.pct>0?'good':'alert',
      from: 'è¡Œæƒ…æ’­æŠ¥',
      body: `<span class="msg-tag ${shData.pct>0?'up':'down'}">${shData.pct>0?'å¤§æ¶¨':'å¤§è·Œ'}</span> <strong>ä¸Šè¯æŒ‡æ•°</strong> ${shData.pct>0?'å¼ºåŠ¿æ‹‰å‡':'å¿«é€Ÿä¸‹æ¢'}ï¼Œç°æŠ¥ ${fmt(shData.price,0)} ç‚¹ï¼Œæ¶¨å¹… <strong style="color:${shData.pct>=0?'var(--up)':'var(--down)'}">${sign(shData.pct)}${fmt(shData.pct)}%</strong>ï¼Œè¯·å…³æ³¨æŒä»“é£é™©ã€‚`
    });
  }
  
  // Sector alerts
  if(topUp.length>0 && r>0.3){
    const s = topUp[Math.floor(seededRand(seed+1)*topUp.length)];
    msgTypes.push({
      icon:'ğŸ“ˆ', avatar:'good', from:'æ¿å—ç›‘æ§',
      body: `<span class="msg-tag up">æ¿å—å¼‚åŠ¨</span> <strong>${s.name}</strong> æ¿å—é¢†æ¶¨ <strong style="color:var(--up)">+${fmt(s.pct)}%</strong>` + 
        (holdings.some(h=>{const f=FUND_DB.find(x=>x.code===h.code); return f&&(f.type.includes(s.name.slice(0,2))||s.name.includes(f.type.slice(0,2)));}) 
          ? `ï¼Œä¸æ‚¨æŒä»“å…³è”åº¦é«˜ï¼Œå»ºè®®å…³æ³¨ã€‚` : `ï¼Œå¯å…³æ³¨ç›¸å…³åŸºé‡‘é…ç½®æœºä¼šã€‚`)
    });
  }
  
  if(topDown.length>0 && r<0.7){
    const s = topDown[Math.floor(seededRand(seed+2)*topDown.length)];
    msgTypes.push({
      icon:'ğŸ“‰', avatar:'alert', from:'é£é™©æé†’',
      body: `<span class="msg-tag down">æ¿å—èµ°å¼±</span> <strong>${s.name}</strong> æ¿å—ä¸‹è·Œ <strong style="color:var(--down)">${fmt(s.pct)}%</strong>` +
        (holdings.some(h=>{const f=FUND_DB.find(x=>x.code===h.code); return f&&(f.type.includes(s.name.slice(0,2))||s.name.includes(f.type.slice(0,2)));})
          ? `ï¼Œæ‚¨æŒæœ‰çš„ç›¸å…³åŸºé‡‘å¯èƒ½å—å½±å“ã€‚` : `ï¼Œæ³¨æ„è§„é¿é£é™©ã€‚`)
    });
  }
  
  // Holding-specific alerts
  holdings.forEach(h=>{
    const f = getFundData(h.code);
    const info = FUND_DB.find(x=>x.code===h.code);
    if(Math.abs(f.gszzl)>2 && seededRand(seed+parseInt(h.code))>0.5){
      msgTypes.push({
        icon: f.gszzl>0?'ğŸ’°':'âš ï¸',
        avatar: f.gszzl>0?'good':'alert',
        from: 'æŒä»“æé†’',
        body: `<span class="msg-tag ${f.gszzl>0?'up':'down'}">${f.gszzl>0?'å¤§æ¶¨':'å¤§è·Œ'}</span> æ‚¨æŒæœ‰çš„ <strong>${info?info.name:h.code}</strong> ä»Šæ—¥ä¼°å€¼ <strong style="color:${f.gszzl>=0?'var(--up)':'var(--down)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</strong>ï¼Œ${f.gszzl>2?'å·²è§¦å‘å…³æ³¨é˜ˆå€¼ï¼Œå¯è€ƒè™‘éƒ¨åˆ†æ­¢ç›ˆã€‚':'è¯·æ³¨æ„é£é™©ï¼Œæ˜¯å¦éœ€è¦å‡ä»“ï¼Ÿ'}`
      });
    }
  });
  
  // General market commentary
  if(msgTypes.length===0){
    const generalMsgs = [
      {icon:'ğŸ“Š',avatar:'sys',from:'å¸‚åœºå¿«è®¯',body:`<span class="msg-tag info">ç›˜ä¸­</span> ä¸¤å¸‚æˆäº¤é¢${seededRand(seed+10)>0.5?'æ”¾é‡':'ç¼©é‡'}ï¼Œæ²ªæŒ‡${shData.pct>=0?'çº¢ç›˜è¿è¡Œ':'ç»¿ç›˜éœ‡è¡'}ï¼Œå½“å‰ ${fmt(shData.price,0)} ç‚¹ (${sign(shData.pct)}${fmt(shData.pct)}%)ã€‚`},
      {icon:'ğŸ’¡',avatar:'sys',from:'ç­–ç•¥æç¤º',body:`<span class="msg-tag info">æç¤º</span> å½“å‰å¸‚åœº${Math.abs(shData.pct)<0.5?'çª„å¹…éœ‡è¡ï¼Œå»ºè®®æŒä»“è§‚æœ›':'æ³¢åŠ¨åŠ å¤§ï¼Œæ³¨æ„ä»“ä½æ§åˆ¶'}ã€‚${isTrading()?'14:30å°†è¿›è¡Œå¤šAIç»¼åˆåˆ†æã€‚':''}`},
      {icon:'ğŸ“¡',avatar:'sys',from:'æ•°æ®æ›´æ–°',body:`<span class="msg-tag info">åˆ·æ–°</span> å®æ—¶æ•°æ®å·²æ›´æ–°ï¼Œä¸Šè¯ ${fmt(shData.price,0)} (${sign(shData.pct)}${fmt(shData.pct)}%)ï¼Œåˆ›ä¸šæ¿ ${fmt(cyData.price,0)} (${sign(cyData.pct)}${fmt(cyData.pct)}%)ã€‚`},
    ];
    msgTypes.push(generalMsgs[Math.floor(seededRand(seed+3)*generalMsgs.length)]);
  }
  
  // Pick one message
  const msg = msgTypes[Math.floor(seededRand(seed+5)*msgTypes.length)];
  addMessage(msg);
}

// ==================== AI ANALYSIS ENGINE ====================

async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_302aiKey) throw new Error('No API keyï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®API Key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_302aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:4096
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildMarketContext(){
  const shData = getIndexData(INDICES_CONFIG[0]);
  const szData = getIndexData(INDICES_CONFIG[1]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const sectors = liveSectors.length>0 ? liveSectors.slice(0,15) : [];
  const topUp = sectors.filter(s=>s.pct>0).slice(0,8);
  const topDown = sectors.filter(s=>s.pct<0).slice(-5).reverse();
  
  let ctx = `å½“å‰æ—¥æœŸ: ${todayStr()}\n`;
  ctx += `\nã€å¤§ç›˜æŒ‡æ•°ã€‘\n`;
  ctx += `ä¸Šè¯æŒ‡æ•°: ${shData.price} (${sign(shData.pct)}${fmt(shData.pct)}%)\n`;
  ctx += `æ·±è¯æˆæŒ‡: ${szData.price} (${sign(szData.pct)}${fmt(szData.pct)}%)\n`;
  ctx += `åˆ›ä¸šæ¿æŒ‡: ${cyData.price} (${sign(cyData.pct)}${fmt(cyData.pct)}%)\n`;
  
  if(topUp.length>0){
    ctx += `\nã€é¢†æ¶¨æ¿å—ã€‘\n`;
    topUp.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }
  if(topDown.length>0){
    ctx += `\nã€é¢†è·Œæ¿å—ã€‘\n`;
    topDown.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }
  return ctx;
}

function buildFundContext(){
  const allFunds = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  let ctx = `\nã€ç”¨æˆ·å…³æ³¨çš„åŸºé‡‘ã€‘\n`;
  
  allFunds.forEach(code=>{
    const f = getFundData(code);
    const info = FUND_DB.find(x=>x.code===code);
    const reco = RECO_FUND_POOL.find(x=>x.code===code);
    const h = holdings.find(x=>x.code===code);
    const w = watchlist.find(x=>x.code===code);
    const name = info?.name || reco?.name || f?.name || w?.name || h?.name || code;
    const type = info?.type || reco?.type || w?.type || '';
    const isHolding = !!h;
    
    ctx += `${name}(${code}) - ç±»å‹:${type||'æœªçŸ¥'} - ${isHolding?'æŒä»“':'è‡ªé€‰'} - ä»Šæ—¥ä¼°å€¼:${sign(f.gszzl)}${fmt(f.gszzl)}%\n`;
  });
  
  return ctx;
}

const AI_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŸºé‡‘æŠ•èµ„åˆ†æå¸ˆï¼Œéœ€è¦æ ¹æ®å¸‚åœºæ•°æ®å¯¹ç”¨æˆ·å…³æ³¨çš„åŸºé‡‘è¿›è¡Œåˆ†æã€‚

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–çš„æ–‡å­—æˆ–markdownæ ‡è®°ï¼š
{
  "verdict": "bull/bear/neutral",
  "verdictText": "ç®€çŸ­çš„2-4å­—æ€»ç»“ï¼Œå¦‚'ä¸­æœŸåå¤š'ã€'å®è§‚æ‰¿å‹'ç­‰",
  "summary": "100-200å­—çš„å¸‚åœºæ•´ä½“åˆ†æï¼ŒåŒ…æ‹¬ä½ å¯¹æœªæ¥3ä¸ªæœˆå¸‚åœºèµ°åŠ¿çš„åˆ¤æ–­",
  "fundViews": [
    {
      "code": "åŸºé‡‘ä»£ç ",
      "action": "buy/sell/hold",
      "reason": "50-100å­—çš„åˆ†æç†ç”±ï¼ŒåŒ…å«å¯¹è¯¥åŸºé‡‘æ‰€åœ¨èµ›é“æœªæ¥3ä¸ªæœˆå‰æ™¯çš„åˆ¤æ–­",
      "finalNote": "ä¸€å¥è¯æ€»ç»“å»ºè®®ï¼Œå¸¦emojiå‰ç¼€å¦‚âœ…/âš ï¸/âŒ/ğŸ’¡/â¸ï¸"
    }
  ]
}

æ³¨æ„ï¼š
1. verdictå¿…é¡»æ˜¯bull/bear/neutralä¹‹ä¸€
2. actionå¿…é¡»æ˜¯buy/sell/holdä¹‹ä¸€
3. åˆ†æè§†è§’ä¾§é‡æœªæ¥3ä¸ªæœˆçš„ä¸­æœŸè¶‹åŠ¿ï¼Œä¸è¦åªçœ‹ä»Šå¤©çš„æ¶¨è·Œ
4. fundViewsä¸­çš„codeå¿…é¡»ä¸ç”¨æˆ·æä¾›çš„åŸºé‡‘ä»£ç å®Œå…¨ä¸€è‡´
5. è¯·åŸºäºä½ å¯¹å½“å‰Aè‚¡å¸‚åœºã€è¡Œä¸šè¶‹åŠ¿ã€å®è§‚ç»æµçš„ä¸“ä¸šçŸ¥è¯†ç»™å‡ºæœ‰ä»·å€¼çš„åˆ†æ
6. åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰å…¶ä»–ä»»ä½•æ–‡å­—`;

async function callRealAI(engine, marketCtx, fundCtx, onProgress){
  const roleDesc = {
    doubao: 'ä½ ç‰¹åˆ«æ“…é•¿æŠ€æœ¯åˆ†æå’Œé‡åŒ–å› å­åˆ†æã€‚è¯·ä»æŠ€æœ¯é¢ã€è¶‹åŠ¿ã€åŠ¨é‡ã€é‡ä»·å…³ç³»ç­‰è§’åº¦è¿›è¡Œåˆ†æã€‚',
    qwen: 'ä½ ç‰¹åˆ«æ“…é•¿å®è§‚ç»æµå’Œæ”¿ç­–é¢åˆ†æã€‚è¯·ä»è´§å¸æ”¿ç­–ã€è´¢æ”¿æ”¿ç­–ã€ç»æµæ•°æ®ã€å›½å†…å¤–å½¢åŠ¿ç­‰è§’åº¦è¿›è¡Œåˆ†æã€‚',
    deepseek: 'ä½ ç‰¹åˆ«æ“…é•¿æ·±åº¦åŸºæœ¬é¢å’Œè¡Œä¸šç ”ç©¶ã€‚è¯·ä»è¡Œä¸šæ™¯æ°”åº¦ã€ä¼°å€¼æ°´å¹³ã€ç›ˆåˆ©è¶‹åŠ¿ã€äº§ä¸šé“¾é€»è¾‘ç­‰è§’åº¦è¿›è¡Œåˆ†æã€‚',
    gemini: 'ä½ ç‰¹åˆ«æ“…é•¿å…¨çƒè§†è§’å’Œé£é™©è¯„ä¼°ã€‚è¯·ä»å…¨çƒèµ„äº§é…ç½®ã€åœ°ç¼˜æ”¿æ²»ã€æ±‡ç‡ã€èµ„é‡‘æµå‘ç­‰è§’åº¦è¿›è¡Œåˆ†æã€‚'
  };
  
  const userMsg = `${roleDesc[engine.id]}\n\n${marketCtx}\n${fundCtx}\n\nè¯·åˆ†æä»¥ä¸Šå¸‚åœºæ•°æ®å’ŒåŸºé‡‘ï¼Œç»™å‡ºä½ çš„ç ”åˆ¤ã€‚`;
  
  if(onProgress) onProgress(`${engine.icon} ${engine.name}(${engine.model}) åˆ†æä¸­...`);
  
  const raw = await callAI(engine.model, AI_SYSTEM_PROMPT, userMsg, 0.7);
  
  // Parse JSON from response (handle possible markdown wrapping)
  let jsonStr = raw.trim();
  // Remove markdown code blocks if present
  if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
  // Try to extract JSON object
  const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
  if(!jsonMatch) throw new Error('No JSON in response');
  
  const parsed = JSON.parse(jsonMatch[0]);
  return parsed;
}

async function generateRealAIAnalysis(onProgress){
  const marketCtx = buildMarketContext();
  const fundCtx = buildFundContext();
  const allFundCodes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  
  const analyses = {};
  let completedCount = 0;
  
  // Call all 4 AI engines in parallel
  const promises = AI_ENGINES.map(async (eng) => {
    try {
      const result = await callRealAI(eng, marketCtx, fundCtx, onProgress);
      completedCount++;
      if(onProgress) onProgress(`å·²å®Œæˆ ${completedCount}/${AI_ENGINES.length} ä¸ªå¼•æ“åˆ†æ...`);
      
      // Map parsed result to expected data structure
      const fundViewMap = {};
      (result.fundViews||[]).forEach(v=>{ fundViewMap[v.code] = v; });
      
      const mapViews = (codes) => codes.map(code=>{
        const f = getFundData(code);
        const v = fundViewMap[code];
        const info = FUND_DB.find(x=>x.code===code);
        const reco = RECO_FUND_POOL.find(x=>x.code===code);
        const w = watchlist.find(x=>x.code===code);
        const h = holdings.find(x=>x.code===code);
        const name = info?.name || reco?.name || f?.name || w?.name || h?.name || code;
        return {
          code,
          name,
          pct: f.gszzl,
          action: v?.action || 'hold',
          reason: v?.reason || 'æš‚æ— åˆ†æ',
          finalNote: v?.finalNote || '',
          // These are optional, AI doesn't provide them but we can fill from simulated profile
          yearReturn: undefined,
          maxDD: undefined,
          vol: undefined,
          pos: undefined,
          bandText: ''
        };
      }).filter(Boolean);
      
      analyses[eng.id] = {
        verdict: result.verdict || 'neutral',
        verdictText: result.verdictText || 'åˆ†æä¸­',
        summary: result.summary || '',
        holdingViews: mapViews(holdings.map(h=>h.code)),
        watchViews: mapViews(watchlist.map(w=>w.code))
      };
    } catch(e) {
      console.error(`${eng.name} AI call failed:`, e);
      if(onProgress) onProgress(`${eng.icon} ${eng.name} è°ƒç”¨å¤±è´¥ï¼Œå·²è·³è¿‡`);
      // Skip failed engines â€” only use real AI results
      analyses[eng.id] = null;
    }
  });
  
  await Promise.all(promises);
  
  // Remove failed engines (null entries)
  AI_ENGINES.forEach(eng=>{
    if(!analyses[eng.id]) delete analyses[eng.id];
  });
  
  // Check if we got any results at all
  const successCount = AI_ENGINES.filter(eng=>analyses[eng.id]).length;
  if(successCount === 0) throw new Error('æ‰€æœ‰AIå¼•æ“è°ƒç”¨å‡å¤±è´¥');
  
  if(onProgress) onProgress(`${successCount}/${AI_ENGINES.length} ä¸ªAIå¼•æ“åˆ†æå®Œæˆ`);
  
  // Generate buy recommendations using scoring logic (doesn't need AI)
  const simForReco = generateAIAnalysis_simulated();
  analyses._recoFunds = simForReco._recoFunds;
  
  return analyses;
}

// Settings UI functions
function openAISettings(){
  const modal = document.getElementById('settings-modal');
  modal.style.display = 'flex';
  document.getElementById('input-302key').value = _302aiKey || '';
  // Render provider list
  let phtml = '';
  AI_PROVIDERS.forEach(p=>{
    const isSel = p.id===_aiProviderId;
    phtml += `<div onclick="selectProvider('${p.id}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:2px solid ${isSel?'var(--primary)':'var(--border)'};border-radius:10px;margin-bottom:6px;cursor:pointer;background:${isSel?'var(--primary-bg)':'white'};transition:all .2s">
      <div style="flex:1">
        <div style="font-weight:600;font-size:12px">${p.name} ${p.free?'<span style="font-size:9px;background:#22c55e;color:white;padding:1px 5px;border-radius:3px">å…è´¹</span>':''}</div>
        <div style="font-size:9px;color:var(--sub);margin-top:2px">${p.desc}</div>
      </div>
      <div style="width:18px;height:18px;border-radius:50%;border:2px solid ${isSel?'var(--primary)':'#ccc'};display:flex;align-items:center;justify-content:center">
        ${isSel?'<div style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>':''}
      </div>
    </div>`;
  });
  document.getElementById('provider-list').innerHTML = phtml;
  // Render provider hint
  document.getElementById('provider-hint').innerHTML = `åœ¨ <a href='${_aiProvider.link}' target='_blank' style='color:var(--primary)'>${_aiProvider.name}</a> æ³¨å†Œåè·å–API Key${_aiProvider.free?' (å…è´¹)':''}`;
  // Render engine model list
  let html = '';
  AI_ENGINES.forEach(eng=>{
    html += `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${eng.icon}</span>
      <span style="flex:1;font-weight:500">${eng.name}</span>
      <span style="font-size:10px;color:var(--primary);background:var(--primary-bg);padding:1px 6px;border-radius:4px">${eng.model}</span>
    </div>`;
  });
  document.getElementById('engine-model-list').innerHTML = html;
}
function selectProvider(id){
  saveProvider(id);
  openAISettings(); // re-render
}
function closeAISettings(){ document.getElementById('settings-modal').style.display='none'; }
function saveAISettings(){
  const key = document.getElementById('input-302key').value.trim();
  if(!key){ alert('è¯·è¾“å…¥API Key'); return; }
  save302Key(key);
  closeAISettings();
  alert(`å·²ä¿å­˜ï¼å½“å‰ä½¿ç”¨: ${_aiProvider.name}`);
}
function toggleKeyVisibility(){
  const inp = document.getElementById('input-302key');
  inp.type = inp.type==='password' ? 'text' : 'password';
}

// ==================== MULTI-AI ANALYSIS ENGINE ====================

// 3-month forward-looking sector outlook based on macro trends
// Returns a score (-5 to +5) and narrative for each sector type
function sectorOutlook3M(seed){
  const r = seededRand;
  // Macro scenario factors (simulated from date seed, stable per day)
  const geopoliticalTension = r(seed+500)*0.6 + 0.3;   // 0.3~0.9, higher = more tension
  const aiIndustryBoom      = r(seed+501)*0.4 + 0.55;   // 0.55~0.95, AI is structurally strong in 2026
  const domesticRecovery    = r(seed+502)*0.7 + 0.15;   // 0.15~0.85
  const rateEnvironment     = r(seed+503)*0.6 + 0.2;    // 0.2~0.8, higher = more easing
  const commodityCycle      = r(seed+504)*0.5 + 0.4;    // 0.4~0.9, metals demand from AI/energy
  const globalRisk          = r(seed+505)*0.6 + 0.2;    // 0.2~0.8, higher = more risky
  const exportStrength      = r(seed+506)*0.5 + 0.3;    // 0.3~0.8
  
  const outlook = {};
  
  // é»„é‡‘ â€” geopolitical tension + global risk + real rate decline
  const goldScore = geopoliticalTension*2.5 + globalRisk*1.5 + rateEnvironment*1 - 2;
  outlook['é»„é‡‘'] = {
    score: Math.max(-4, Math.min(5, goldScore)),
    narrative: goldScore>1.5 ? 'å›½é™…å±€åŠ¿æŒç»­ç´§å¼ ï¼Œå…¨çƒå¤®è¡Œå¢æŒé»„é‡‘ï¼Œå®é™…åˆ©ç‡ä¸‹è¡Œé¢„æœŸæ”¯æ’‘é‡‘ä»·ä¸­æœŸèµ°å¼º' :
              goldScore>0 ? 'åœ°ç¼˜é£é™©ç»´æŒï¼Œé»„é‡‘ä½œä¸ºé¿é™©é…ç½®ä»æœ‰ä»·å€¼ï¼Œä½†ä¸Šè¡Œç©ºé—´æ”¶çª„' :
              'çŸ­æœŸé‡‘ä»·é«˜ä½æ‰¿å‹ï¼Œä½†é•¿æœŸé¿é™©é€»è¾‘ä¸å˜ï¼Œç­‰å¾…å›è°ƒåå¸ƒå±€'
  };
  
  // AI/ç§‘æŠ€ â€” AI industry boom is the dominant driver
  const aiScore = aiIndustryBoom*3.5 + domesticRecovery*0.8 - globalRisk*0.5 - 1.2;
  outlook['AI/ç§‘æŠ€'] = {
    score: Math.max(-3, Math.min(5, aiScore)),
    narrative: aiScore>2 ? 'AIäº§ä¸šé“¾çˆ†å‘å¼å¢é•¿ï¼Œç®—åŠ›éœ€æ±‚ç¿»å€ï¼Œå¤§æ¨¡å‹åº”ç”¨åŠ é€Ÿè½åœ°ï¼Œä¸­é•¿æœŸç¡®å®šæ€§æå¼º' :
              aiScore>0 ? 'AIè¶‹åŠ¿æ˜ç¡®ä½†çŸ­æœŸæ¶¨å¹…è¾ƒå¤§ã€ä¼°å€¼éœ€æ¶ˆåŒ–ï¼Œå…³æ³¨ä¸šç»©å…‘ç°èŠ‚å¥' :
              'AIæ¿å—é˜¶æ®µæ€§è°ƒæ•´ï¼Œäº§ä¸šé€»è¾‘ä¸å˜ä½†çŸ­æœŸæ‹¥æŒ¤åº¦åé«˜'
  };
  outlook['ç§‘æŠ€'] = outlook['AI/ç§‘æŠ€'];
  
  // åŠå¯¼ä½“ â€” AI demand + å›½äº§æ›¿ä»£ + cycle recovery
  const semiScore = aiIndustryBoom*2.5 + exportStrength*1 + commodityCycle*0.5 - 1.5;
  outlook['åŠå¯¼ä½“'] = {
    score: Math.max(-3, Math.min(5, semiScore)),
    narrative: semiScore>2 ? 'AIç®—åŠ›çˆ†å‘æ‹‰åŠ¨èŠ¯ç‰‡éœ€æ±‚ï¼Œå›½äº§æ›¿ä»£åŠ é€Ÿæ¨è¿›ï¼ŒåŠå¯¼ä½“å‘¨æœŸæ€§å¤è‹+ç»“æ„æ€§æˆé•¿å…±æŒ¯' :
              semiScore>0 ? 'åŠå¯¼ä½“æ™¯æ°”åº¦æ¸©å’Œå›å‡ï¼ŒAIç›¸å…³èŠ¯ç‰‡éœ€æ±‚å¼ºåŠ²ï¼Œä½†æ¶ˆè´¹ç”µå­æ¢å¤åæ…¢' :
              'åŠå¯¼ä½“å‘¨æœŸæœªå®Œå…¨è§åº•ï¼Œç­‰å¾…åº“å­˜å»åŒ–å®Œæˆåçš„æ‹ç‚¹'
  };
  outlook['åŠå¯¼ä½“/ç§‘æŠ€'] = outlook['åŠå¯¼ä½“'];
  
  // å†›å·¥ â€” geopolitical tension + defense spend
  const milScore = geopoliticalTension*3 + globalRisk*1 - domesticRecovery*0.3 - 1.5;
  outlook['å†›å·¥'] = {
    score: Math.max(-3, Math.min(5, milScore)),
    narrative: milScore>2 ? 'å›½é™…å±€åŠ¿ç´§å¼ å åŠ å›½é˜²é¢„ç®—ç¨³æ­¥å¢é•¿ï¼Œå†›å·¥æ¿å—æ”»å®ˆå…¼å¤‡ï¼Œè®¢å•ç¡®å®šæ€§å¼º' :
              milScore>0 ? 'åœ°ç¼˜æ”¿æ²»ç»´æŒç´§å¼ ï¼Œå†›å·¥æœ‰é˜²å¾¡ä»·å€¼ï¼Œä½†å¼¹æ€§ä¸åŠè¿›æ”»æ¿å—' :
              'å†›å·¥æ¿å—ç¼ºä¹çŸ­æœŸå‚¬åŒ–ï¼Œä½†ä¸‹è¡Œé£é™©æœ‰é™ï¼Œé€‚åˆåº•ä»“é…ç½®'
  };
  
  // æ–°èƒ½æº â€” export + domestic policy + commodity cycle
  const neScore = exportStrength*2 + domesticRecovery*1.5 + rateEnvironment*0.5 - commodityCycle*0.3 - 1.5;
  outlook['æ–°èƒ½æº'] = {
    score: Math.max(-4, Math.min(4, neScore)),
    narrative: neScore>1.5 ? 'æ–°èƒ½æºè½¦å‡ºå£æŒç»­æ”¾é‡ï¼Œå‚¨èƒ½/å…‰ä¼éœ€æ±‚å›æš–ï¼Œäº§ä¸šé“¾ç›ˆåˆ©æ‹ç‚¹æ¸è¿‘' :
              neScore>0 ? 'æ–°èƒ½æºæ•´ä½“è¶‹ç¨³ï¼Œé¾™å¤´å…¬å¸æµ·å¤–å¼€æ‹“æˆæ•ˆæ˜¾è‘—ï¼Œä½†äº§èƒ½è¿‡å‰©æ‹…å¿§æœªæ¶ˆ' :
              'æ–°èƒ½æºäº§ä¸šé“¾ä»·æ ¼æˆ˜æŒç»­ï¼Œç›ˆåˆ©åº•å°šæœªç¡®è®¤ï¼ŒçŸ­æœŸè°¨æ…ä½†ä¸­æœŸå¯å…³æ³¨'
  };
  
  // æ¶ˆè´¹/ç™½é…’ â€” domestic recovery is the key driver
  const consScore = domesticRecovery*3 + rateEnvironment*1 - globalRisk*0.3 - 1.5;
  outlook['æ¶ˆè´¹'] = {
    score: Math.max(-4, Math.min(4, consScore)),
    narrative: consScore>1.5 ? 'æ¶ˆè´¹å¤è‹æ•°æ®æŒç»­éªŒè¯ï¼Œç¤¾é›¶å¢é€Ÿå›å‡ï¼Œé¾™å¤´ä¼°å€¼åˆç†ï¼Œä¸­æœŸé…ç½®çª—å£' :
              consScore>0 ? 'æ¶ˆè´¹å¼±å¤è‹æ ¼å±€ï¼Œé«˜ç«¯æ¶ˆè´¹éŸ§æ€§å¼ºäºå¤§ä¼—æ¶ˆè´¹ï¼Œç»“æ„æ€§å¸ƒå±€' :
              'æ¶ˆè´¹å¤è‹èŠ‚å¥åæ…¢ï¼Œå±…æ°‘æ”¶å…¥é¢„æœŸå°šæœªä¿®å¤ï¼Œç­‰å¾…å®è§‚æ•°æ®æ”¹å–„'
  };
  outlook['ç™½é…’/æ¶ˆè´¹'] = outlook['æ¶ˆè´¹'];
  
  // åŒ»è¯ â€” æ”¿ç­–+åˆ›æ–°è¯+è€é¾„åŒ–
  const pharmaScore = domesticRecovery*1.5 + rateEnvironment*1 - globalRisk*0.3 + r(seed+510)*1.5 - 1.5;
  outlook['åŒ»è¯'] = {
    score: Math.max(-3, Math.min(4, pharmaScore)),
    narrative: pharmaScore>1.5 ? 'åˆ›æ–°è¯å‡ºæµ·åŠ é€Ÿ+é›†é‡‡å½±å“é’åŒ–+è€é¾„åŒ–è¶‹åŠ¿ï¼ŒåŒ»è¯æ¿å—åº•éƒ¨åè½¬é€»è¾‘æ˜ç¡®' :
              pharmaScore>0 ? 'åŒ»è¯ä¼°å€¼å¤„äºä½ä½ï¼Œæ”¿ç­–è¾¹é™…æ”¹å–„ï¼Œå¯é€¢ä½å¸ƒå±€ä½†éœ€ç²¾é€‰ä¸ªè‚¡' :
              'åŒ»è¯æ¿å—ç£¨åº•ä¸­ï¼Œé›†é‡‡æ‰°åŠ¨å°šå­˜ï¼Œç­‰å¾…æ”¿ç­–æ˜ç¡®æ‹ç‚¹'
  };
  
  // çº¢åˆ© â€” rate decline + volatility hedge
  const divScore = rateEnvironment*2 + globalRisk*1.5 - domesticRecovery*0.8 + 0.5;
  outlook['çº¢åˆ©'] = {
    score: Math.max(-2, Math.min(5, divScore)),
    narrative: divScore>2 ? 'åˆ©ç‡ä¸‹è¡Œå‘¨æœŸä¸­é«˜è‚¡æ¯èµ„äº§æ€§ä»·æ¯”æé«˜ï¼Œä½œä¸ºç»„åˆå‹èˆ±çŸ³+æŠ—æ³¢åŠ¨é¦–é€‰' :
              divScore>0 ? 'çº¢åˆ©ç­–ç•¥åœ¨éœ‡è¡å¸‚ä¸­é˜²å¾¡åŠ›çªå‡ºï¼Œå›½ä¼æ”¹é©æå‡åˆ†çº¢æ„æ„¿' :
              'ç»æµå¤è‹é¢„æœŸä¸‹æˆé•¿è‚¡è·‘èµ¢ä»·å€¼è‚¡ï¼Œçº¢åˆ©å¸å¼•åŠ›ç›¸å¯¹ä¸‹é™'
  };
  
  // å®½åŸº â€” overall market outlook
  const broadScore = domesticRecovery*2 + rateEnvironment*1 - globalRisk*0.5 - 0.8;
  outlook['å®½åŸº'] = {
    score: Math.max(-3, Math.min(4, broadScore)),
    narrative: broadScore>1.5 ? 'å®è§‚ç»æµä¼ç¨³å›å‡ï¼ŒAè‚¡ä¼°å€¼å¤„äºå†å²ä¸­ä½ä½ï¼Œå®½åŸºæŒ‡æ•°ä¸­é•¿æœŸé…ç½®ä»·å€¼çªå‡º' :
              broadScore>0 ? 'Aè‚¡éœ‡è¡ç­‘åº•ï¼Œå®½åŸºé€‚åˆå®šæŠ•å¼å¸ƒå±€ï¼Œåˆ†æ•£ä¸ªè‚¡é£é™©' :
              'æ•´ä½“å¸‚åœºåå¼±ï¼Œå®½åŸºè·Ÿéšå¤§ç›˜æ³¢åŠ¨ï¼Œå»ºè®®é™ä½ä»“ä½ç­‰å¾…ä¼ç¨³'
  };
  
  // æœ‰è‰²é‡‘å± â€” AIæ•°æ®ä¸­å¿ƒç”¨é“œ+æ–°èƒ½æºé‡‘å±+commodity cycle
  const metalScore = commodityCycle*2 + aiIndustryBoom*2 + exportStrength*0.8 - 1.8;
  outlook['æœ‰è‰²é‡‘å±'] = {
    score: Math.max(-3, Math.min(5, metalScore)),
    narrative: metalScore>2 ? 'AIæ•°æ®ä¸­å¿ƒ+æ–°èƒ½æºæ‹‰åŠ¨é“œé“éœ€æ±‚å‰§å¢ï¼Œä¾›ç»™ç«¯çŸ¿å±±èµ„æœ¬å¼€æ”¯ä¸è¶³ï¼Œæœ‰è‰²é‡‘å±è¿æ¥è¶…çº§å‘¨æœŸ' :
              metalScore>0 ? 'æœ‰è‰²é‡‘å±å—ç›ŠäºAIäº§ä¸šé“¾é‡‘å±éœ€æ±‚ï¼Œä½†å…¨çƒç»æµæ”¾ç¼“åˆ¶çº¦æƒ³è±¡ç©ºé—´' :
              'å•†å“ä»·æ ¼é«˜ä½éœ‡è¡ï¼Œæœ‰è‰²é‡‘å±çŸ­æœŸæ‰¿å‹ï¼Œç­‰å¾…éœ€æ±‚ç«¯ç¡®è®¤'
  };
  outlook['èµ„æº'] = { score: outlook['æœ‰è‰²é‡‘å±'].score * 0.8, narrative: outlook['æœ‰è‰²é‡‘å±'].narrative };
  
  // ä¸­å°ç›˜ â€” risk appetite + domestic recovery
  const smScore = domesticRecovery*2 + rateEnvironment*1.5 - globalRisk*1 - 0.5;
  outlook['ä¸­å°ç›˜'] = {
    score: Math.max(-3, Math.min(4, smScore)),
    narrative: smScore>1.5 ? 'æµåŠ¨æ€§å®½æ¾åˆ©å¥½ä¸­å°ç›˜ï¼Œå¹¶è´­é‡ç»„é¢„æœŸå‡æ¸©ï¼Œä¸­å°ç›˜å¼¹æ€§ç©ºé—´å¤§' :
              smScore>0 ? 'ä¸­å°ç›˜åˆ†åŒ–åŠ å‰§ï¼Œç²¾é€‰é«˜æ™¯æ°”èµ›é“é¾™å¤´ä»æœ‰æœºä¼š' :
              'é£é™©åå¥½ä½è¿·æ‹–ç´¯ä¸­å°ç›˜ï¼Œå¤§ç›˜è“ç­¹ç›¸å¯¹å ä¼˜'
  };
  
  // è“ç­¹ â€” stability + foreign inflow
  const blueScore = domesticRecovery*1.5 + exportStrength*1.5 - globalRisk*0.3 - 1;
  outlook['è“ç­¹'] = {
    score: Math.max(-2, Math.min(4, blueScore)),
    narrative: blueScore>1.5 ? 'æ ¸å¿ƒèµ„äº§ä¼°å€¼ä¿®å¤ï¼Œå¤–èµ„æŒç»­æµå…¥è“ç­¹ï¼Œä¸šç»©ç¡®å®šæ€§æ”¯æ’‘é•¿æœŸé…ç½®' :
              blueScore>0 ? 'è“ç­¹ä¼°å€¼åˆç†ï¼Œä½œä¸ºç»„åˆæ ¸å¿ƒåº•ä»“é…ç½®é€»è¾‘ä¸å˜' :
              'è“ç­¹ç¼ºä¹è¿›æ”»æ€§ï¼Œä½†ä¸‹è¡Œä¿æŠ¤è¾ƒå¥½ï¼Œé€‚åˆä¿å®ˆå‹æŠ•èµ„è€…'
  };
  
  // QDII/å•†å“ â€” global diversification
  const qdiiScore = globalRisk*1.5 + commodityCycle*1 + geopoliticalTension*0.5 - 1;
  outlook['å•†å“/QDII'] = {
    score: Math.max(-3, Math.min(4, qdiiScore)),
    narrative: qdiiScore>1.5 ? 'å…¨çƒèµ„äº§é…ç½®éœ€æ±‚æå‡ï¼Œå•†å“ä¸Aè‚¡ä½ç›¸å…³æä¾›åˆ†æ•£åŒ–ä»·å€¼' :
              qdiiScore>0 ? 'QDIIé€‚åˆä½œä¸ºç»„åˆå«æ˜Ÿé…ç½®ï¼Œå¯¹å†²å•ä¸€å¸‚åœºé£é™©' :
              'æµ·å¤–å¸‚åœºä¼°å€¼åé«˜ï¼ŒQDIIé…ç½®æ€§ä»·æ¯”ä¸‹é™ï¼Œå»ºè®®è§‚æœ›'
  };
  outlook['QDII/ç§‘æŠ€'] = { score: (qdiiScore + aiScore) / 2, narrative: `æµ·å¤–ç§‘æŠ€è‚¡å—ç›ŠäºAIè¶‹åŠ¿${qdiiScore>0?'ï¼Œå…¨çƒé…ç½®åˆ†æ•£Aè‚¡é£é™©':'ï¼Œä½†ä¼°å€¼è¾ƒé«˜éœ€æ³¨æ„'}` };
  
  // é‡‘è â€” rate + reform
  const finScore = domesticRecovery*2 + rateEnvironment*0.5 + r(seed+511)*1.5 - 1.5;
  outlook['é‡‘è'] = {
    score: Math.max(-3, Math.min(4, finScore)),
    narrative: finScore>1.5 ? 'æ´»è·ƒèµ„æœ¬å¸‚åœºæ”¿ç­–è½åœ°ï¼Œåˆ¸å•†æ”¹é©æé€Ÿï¼Œé‡‘èæ¿å—ä¼°å€¼ä¿®å¤ç©ºé—´å¤§' :
              finScore>0 ? 'é‡‘èæ¿å—ä¼°å€¼ä½ä½ï¼Œæ”¿ç­–å‚¬åŒ–å¯æœŸï¼Œä½†çŸ­æœŸå¼¹æ€§æœ‰é™' :
              'å¸‚åœºäº¤æŠ•æ¸…æ·¡åˆ¶çº¦åˆ¸å•†ä¸šç»©ï¼Œé‡‘èæ¿å—ç­‰å¾…å¸‚åœºæ”¾é‡'
  };
  
  return { outlook, factors: { geopoliticalTension, aiIndustryBoom, domesticRecovery, rateEnvironment, commodityCycle, globalRisk, exportStrength } };
}

function generateAIAnalysis_simulated(){
  const shData = getIndexData(INDICES_CONFIG[0]);
  const szData = getIndexData(INDICES_CONFIG[1]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const sectors = liveSectors.length>0 ? liveSectors : [];
  const topUp = sectors.filter(s=>s.pct>0).slice(0,5);
  const topDown = sectors.filter(s=>s.pct<0).slice(-5).reverse();
  const avgPct = (shData.pct+cyData.pct)/2;
  const seed = parseInt(todayStr().replace(/-/g,''));
  
  const analyses = {};
  
  // 3-month forward sector outlook
  const { outlook, factors } = sectorOutlook3M(seed);
  
  // Helper: get 3-month outlook score for a fund, matching by type keywords
  function getOutlookScore(code){
    const type = fundType(code);
    if(!type) return { score:0, narrative:'æš‚æ— è¯¥ç±»å‹å‰ç»åˆ†æ' };
    // Try exact match first, then keyword match
    if(outlook[type]) return outlook[type];
    for(const [k,v] of Object.entries(outlook)){
      if(type.includes(k) || k.includes(type)) return v;
    }
    // Keyword fallback
    if(type.includes('é»„é‡‘')) return outlook['é»„é‡‘'];
    if(type.includes('AI') || type.includes('ç§‘æŠ€') || type.includes('äººå·¥æ™ºèƒ½')) return outlook['AI/ç§‘æŠ€'];
    if(type.includes('åŠå¯¼ä½“') || type.includes('èŠ¯ç‰‡')) return outlook['åŠå¯¼ä½“'];
    if(type.includes('å†›å·¥') || type.includes('å›½é˜²')) return outlook['å†›å·¥'];
    if(type.includes('æ–°èƒ½æº') || type.includes('ç”µæ± ') || type.includes('å…‰ä¼')) return outlook['æ–°èƒ½æº'];
    if(type.includes('æ¶ˆè´¹') || type.includes('ç™½é…’') || type.includes('é£Ÿå“')) return outlook['æ¶ˆè´¹'];
    if(type.includes('åŒ»è¯') || type.includes('åˆ›æ–°è¯')) return outlook['åŒ»è¯'];
    if(type.includes('çº¢åˆ©') || type.includes('ä½æ³¢') || type.includes('è‚¡æ¯')) return outlook['çº¢åˆ©'];
    if(type.includes('å®½åŸº') || type.includes('300') || type.includes('500')) return outlook['å®½åŸº'];
    if(type.includes('æœ‰è‰²') || type.includes('é“œ') || type.includes('é“')) return outlook['æœ‰è‰²é‡‘å±'];
    if(type.includes('QDII') || type.includes('å•†å“')) return outlook['å•†å“/QDII'];
    if(type.includes('é‡‘è') || type.includes('åˆ¸å•†')) return outlook['é‡‘è'];
    if(type.includes('ä¸­å°ç›˜')) return outlook['ä¸­å°ç›˜'];
    if(type.includes('è“ç­¹')) return outlook['è“ç­¹'];
    return { score: 0, narrative: 'è¡Œä¸šä¸­æ€§ï¼Œéœ€è·Ÿè¸ªåŸºæœ¬é¢å˜åŒ–' };
  }
  
  // Merge all fund codes (holdings + watchlist) for unified analysis
  const allFundCodes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  
  // Helper: get fund name and type from any source
  function fundName(code){
    const info = FUND_DB.find(x=>x.code===code);
    if(info) return info.name;
    const reco = RECO_FUND_POOL.find(x=>x.code===code);
    if(reco) return reco.name;
    const live = liveFundData[code];
    if(live?.name) return live.name;
    const h = holdings.find(x=>x.code===code);
    if(h?.name) return h.name;
    const w = watchlist.find(x=>x.code===code);
    if(w?.name) return w.name;
    return code;
  }
  function fundType(code){
    const info = FUND_DB.find(x=>x.code===code);
    if(info) return info.type;
    const reco = RECO_FUND_POOL.find(x=>x.code===code);
    if(reco) return reco.type;
    const w = watchlist.find(x=>x.code===code);
    if(w?.type) return w.type;
    return '';
  }
  
  // Generate simulated 1-year performance profile for each fund
  function genFundProfile(code){
    const s = seed + parseInt(code);
    const r = seededRand;
    const type = fundType(code);
    // 1-year return: -25% to +55%
    let baseReturn = (r(s+100)-0.42)*55;
    if(type.includes('ç§‘æŠ€')||type.includes('AI')) baseReturn += 12;
    if(type.includes('é»„é‡‘')) baseReturn += 6;
    if(type.includes('åŒ»è¯')) baseReturn -= 5;
    if(type.includes('æ¶ˆè´¹')) baseReturn += 3;
    if(type.includes('æ–°èƒ½æº')) baseReturn += (r(s+104)>0.5?8:-4);
    const yearReturn = Math.round(baseReturn*10)/10;
    // Max drawdown: 5% to 32%
    const maxDD = Math.round((5 + r(s+101)*(yearReturn>10?18:28))*10)/10;
    // Volatility: 8% to 28%
    const vol = Math.round((8 + r(s+102)*20)*10)/10;
    // Position in 1-year range: 0=at low, 1=at high
    const pos = r(s+103);
    // Band trading advice
    let bandText, bandAction;
    if(pos > 0.82){
      bandText = `å¤„äºè¿‘1å¹´é«˜ä½(${Math.round(pos*100)}%åˆ†ä½)ï¼ŒçŸ­çº¿è·åˆ©ç›˜ç§¯ç´¯æ˜æ˜¾ã€‚å»ºè®®${yearReturn>20?'åˆ†æ‰¹æ­¢ç›ˆï¼Œé”å®šåˆ©æ¶¦':'é€¢é«˜å‡ä»“'}ï¼Œå›è½åˆ°${Math.round(pos*70)}%åˆ†ä½é™„è¿‘å†æ¥å›ã€‚`;
      bandAction = 'sell_band';
    } else if(pos < 0.2){
      bandText = `å¤„äºè¿‘1å¹´ä½ä½(${Math.round(pos*100)}%åˆ†ä½)ï¼Œ${maxDD>20?'å·²å……åˆ†é‡Šæ”¾é£é™©':'ä¸‹è¡Œç©ºé—´æœ‰é™'}ã€‚å»ºè®®åˆ†3æ‰¹é€¢ä½å»ºä»“ï¼Œæ¯è·Œ${(2+r(s+105)*2).toFixed(1)}%åŠ ä¸€æ¬¡ä»“ã€‚`;
      bandAction = 'buy_band';
    } else if(pos < 0.45){
      bandText = `å¤„äºè¿‘1å¹´ä¸­ä½ä½(${Math.round(pos*100)}%åˆ†ä½)ï¼Œ${yearReturn<0?'å¼±åŠ¿ç­‘åº•ä¸­':'å›è°ƒè¾ƒå……åˆ†'}ã€‚å¯å°ä»“ä½ä»‹å…¥ï¼Œè®¾æ­¢æŸä½åœ¨${Math.round(pos*80)}%åˆ†ä½ã€‚`;
      bandAction = 'buy_band';
    } else if(pos > 0.65){
      bandText = `å¤„äºè¿‘1å¹´ä¸­é«˜ä½(${Math.round(pos*100)}%åˆ†ä½)ï¼Œæ³¢æ®µæ”¶ç›Šç©ºé—´æ”¶çª„ã€‚å»ºè®®æŒæœ‰ä¸ºä¸»ï¼Œçªç ´æ–°é«˜å¯è¿½ä»“ï¼Œè·Œç ´${Math.round(pos*85)}%åˆ†ä½æ­¢ç›ˆã€‚`;
      bandAction = 'hold_band';
    } else {
      bandText = `å¤„äºè¿‘1å¹´ä¸­ä½åŒºé—´(${Math.round(pos*100)}%åˆ†ä½)ï¼Œæ–¹å‘ä¸æ˜ç¡®ã€‚å»ºè®®ç»´æŒä»“ä½ï¼Œçªç ´${Math.round(pos*115)}%åˆ†ä½åŠ ä»“ï¼Œè·Œç ´${Math.round(pos*85)}%åˆ†ä½å‡ä»“ã€‚`;
      bandAction = 'hold_band';
    }
    return { yearReturn, maxDD, vol, pos, bandText, bandAction };
  }
  
  // Pre-compute profiles for all funds
  const fundProfiles = {};
  allFundCodes.forEach(code=>{ fundProfiles[code] = genFundProfile(code); });
  
  // === è±†åŒ… (Technical + Quant) â€” æŠ€æœ¯é¢è¶‹åŠ¿ + ä¸­æœŸé‡åŒ–å› å­ ===
  const dbBias = avgPct*0.2 + (seededRand(seed+11)-0.5)*0.8;
  const dbFundViews = {};
  allFundCodes.forEach(code=>{
    const f = getFundData(code);
    const p = fundProfiles[code];
    const ol = getOutlookScore(code);
    // 3-month outlook is the primary driver, today's price is secondary
    let bias = ol.score*0.7 + p.yearReturn*0.015 + (seededRand(seed+parseInt(code)+20)-0.5)*1.2;
    // Band position adjustment
    if(p.pos>0.8 && ol.score>1) bias -= 0.4; // high position tempers bullishness
    if(p.pos<0.2 && ol.score>0) bias += 0.5; // low position amplifies opportunity
    if(p.bandAction==='sell_band') bias -= 0.3;
    if(p.bandAction==='buy_band') bias += 0.3;
    // Today's price as minor signal only
    bias += f.gszzl * 0.05;
    dbFundViews[code] = {
      code, name:fundName(code), pct:f.gszzl,
      yearReturn:p.yearReturn, maxDD:p.maxDD, vol:p.vol, pos:p.pos, bandText:p.bandText,
      action: bias>1.2?'buy':bias<-1.2?'sell':'hold',
      reason: bias>1.2?`ä¸­æœŸè¶‹åŠ¿çº¿ä¸Šè¡Œï¼Œé‡åŒ–æ¨¡å‹æ˜¾ç¤ºæœªæ¥3ä¸ªæœˆä¸Šæ¶¨æ¦‚ç‡${55+Math.round(ol.score*6)}%${p.pos<0.4?'ï¼Œä¸”å¤„äºä½ä½åŒºé—´ï¼Œå»ºä»“ä¿¡å·æ˜ç¡®':''}ã€‚${ol.narrative}`:bias<-1.2?`ä¸­æœŸå‡çº¿ç³»ç»Ÿèµ°åï¼Œé‡åŒ–æ¨¡å‹é¢„è­¦ä¸‹è¡Œé£é™©${p.pos>0.7?'ï¼Œé«˜ä½è·åˆ©ç›˜ç§¯ç´¯ï¼Œå»ºè®®å‡ä»“':''}ã€‚${ol.narrative}`:`æŠ€æœ¯é¢ä¸­æ€§éœ‡è¡ï¼Œè¶‹åŠ¿æ–¹å‘å¾…ç¡®è®¤ã€‚${ol.narrative}`,
      finalNote: bias>1.2?(p.bandAction==='sell_band'?'âš ï¸ ä¸­æœŸçœ‹å¤šä½†å¤„äºé«˜ä½ï¼Œå»ºè®®ç­‰å›è°ƒåˆ°ä¸­ä½å†åŠ ä»“':'âœ… ä¸­æœŸè¶‹åŠ¿+æ³¢æ®µä½ç½®å…±æŒ¯çœ‹å¤šï¼Œå»ºè®®åŠ ä»“'):bias<-1.2?(p.bandAction==='buy_band'?'ğŸ’¡ ä¸­æœŸåå¼±ä½†å¤„äºä½ä½ï¼Œå¯å°ä»“ä½é€¢ä½å¸ƒå±€ç­‰åè½¬':'âŒ ä¸­æœŸè¶‹åŠ¿+ä½ç½®åŒé‡åˆ©ç©ºï¼Œå»ºè®®å‡ä»“'):(p.bandAction==='buy_band'?'ğŸ’¡ è¶‹åŠ¿ä¸­æ€§ä½†ä½ä½æœ‰æ”¯æ’‘ï¼Œå¯åˆ†æ‰¹å»ºä»“':p.bandAction==='sell_band'?'âš ï¸ è¶‹åŠ¿ä¸­æ€§ä½†é«˜ä½æ‰¿å‹ï¼Œå»ºè®®é€¢é«˜å‡ä»“':'â¸ï¸ è¶‹åŠ¿+ä½ç½®å‡ä¸­æ€§ï¼Œç»´æŒä¸åŠ¨')
    };
  });
  analyses.doubao = {
    verdict: dbBias>0.3?'bull':dbBias<-0.3?'bear':'neutral',
    verdictText: dbBias>0.3?'ä¸­æœŸåå¤š':dbBias<-0.3?'ä¸­æœŸåç©º':'ä¸­æ€§éœ‡è¡',
    summary: dbBias>0.3 ?
      `ä¸­æœŸè¶‹åŠ¿åˆ†æï¼šä¸Šè¯æŒ‡æ•°ç«™ç¨³ä¸­æœŸå‡çº¿(20/60æ—¥)ï¼Œæœˆçº¿MACDé‡‘å‰ç¡®ç«‹ï¼Œå¸‚åœºé‡èƒ½${seededRand(seed+12)>0.5?'æ¸©å’Œæ”¾å¤§ï¼Œè¶‹åŠ¿å¥åº·':'ç»´æŒåœ¨å‡å€¼ä»¥ä¸Š'}ã€‚åˆ›ä¸šæ¿æŒ‡${cyData.pct>0?'é¢†æ¶¨':'ä¼ç¨³å›å‡'}ï¼Œç§‘æŠ€æˆé•¿æ¿å—ä¸­æœŸåŠ¨é‡${seededRand(seed+14)>0.5?'å¼ºåŠ²':'é€æ­¥å¢å¼º'}ï¼Œé‡åŒ–å› å­æ˜¾ç¤ºæœªæ¥3ä¸ªæœˆä¸Šæ¶¨æ¦‚ç‡è¾ƒé«˜ã€‚` :
      dbBias<-0.3 ? 
      `ä¸­æœŸè¶‹åŠ¿èµ°å¼±ï¼Œä¸Šè¯è·Œç ´${seededRand(seed+15)>0.5?'60æ—¥å‡çº¿':'å­£åº¦å‡çº¿'}æ”¯æ’‘ï¼Œæœˆçº¿MACDæ­»å‰å½¢æ€${seededRand(seed+16)>0.5?'å·²ç¡®è®¤':'å³å°†å½¢æˆ'}ã€‚ä¸­æœŸé‡èƒ½èç¼©æ˜¾ç¤ºåšå¤šèµ„é‡‘ä¸è¶³ï¼Œé‡åŒ–æ¨¡å‹é¢„è­¦æœªæ¥3ä¸ªæœˆå›è°ƒé£é™©ã€‚` :
      `ä¸­æœŸè¶‹åŠ¿ä¸­æ€§ï¼Œä¸Šè¯æŒ‡æ•°åœ¨20æ—¥å’Œ60æ—¥å‡çº¿é—´éœ‡è¡è¿è¡Œï¼Œæœˆçº¿å¸ƒæ—å¸¦æ”¶çª„æš—ç¤ºä¸­æœŸå˜ç›˜åœ¨å³ã€‚é‡åŒ–å› å­æ— æ˜æ˜¾æ–¹å‘ä¿¡å·ï¼Œå»ºè®®ç­‰å¾…è¶‹åŠ¿ç¡®ç«‹åå†æ“ä½œã€‚`,
    holdingViews: holdings.map(h=>dbFundViews[h.code]).filter(Boolean),
    watchViews: watchlist.map(w=>dbFundViews[w.code]).filter(Boolean)
  };
  
  // === é€šä¹‰åƒé—® (Macro + Policy) â€” å®è§‚ç»æµ3æœˆå‰ç» ===
  const ybBias = factors.domesticRecovery*1.5 + factors.rateEnvironment*1 - factors.globalRisk*0.5 - 1;
  const ybFundViews = {};
  allFundCodes.forEach(code=>{
    const f = getFundData(code);
    const type = fundType(code);
    const p = fundProfiles[code];
    const ol = getOutlookScore(code);
    let bias = ol.score*0.8 + ybBias*0.4 + (seededRand(seed+parseInt(code)+30)-0.5)*1;
    // Macro-driven type adjustments
    if(type.includes('ç§‘æŠ€')||type.includes('AI')) bias += factors.aiIndustryBoom*1.2 - 0.5;
    if(type.includes('é»„é‡‘')) bias += factors.geopoliticalTension*1.5 - 0.5;
    if(type.includes('æœ‰è‰²')||type.includes('èµ„æº')) bias += factors.commodityCycle*1.2 + factors.aiIndustryBoom*0.8 - 0.8;
    if(type.includes('å†›å·¥')) bias += factors.geopoliticalTension*1.2 - 0.4;
    if(type.includes('çº¢åˆ©')) bias += factors.rateEnvironment*1.2  - 0.3;
    if(type.includes('æ¶ˆè´¹')||type.includes('ç™½é…’')) bias += factors.domesticRecovery*1.2 - 0.5;
    // Band position
    if(p.pos>0.8) bias -= 0.5;
    if(p.pos<0.2) bias += 0.4;
    if(p.bandAction==='sell_band') bias -= 0.2;
    if(p.bandAction==='buy_band') bias += 0.2;
    ybFundViews[code] = {
      code, name:fundName(code), pct:f.gszzl,
      yearReturn:p.yearReturn, maxDD:p.maxDD, vol:p.vol, pos:p.pos, bandText:p.bandText,
      action: bias>1.2?'buy':bias<-1.2?'sell':'hold',
      reason: bias>1.2?`å®è§‚ç¯å¢ƒåˆ©å¥½è¯¥æ¿å—ï¼Œæœªæ¥3ä¸ªæœˆæ™¯æ°”åº¦ä¸Šè¡Œ${p.pos<0.4?'ï¼Œä¼°å€¼å¤„äºä½ä½é…ç½®ä»·å€¼çªå‡º':''}ã€‚${ol.narrative}`:bias<-1.2?`å®è§‚å‹åŠ›ä¼ å¯¼è‡³è¯¥æ¿å—${p.pos>0.7?'ï¼Œä¸”ä¼°å€¼å¤„äºé«˜ä½ï¼Œå‡ä»“ä¸ºå®œ':'ï¼Œä¸­æœŸè°¨æ…'}ã€‚${ol.narrative}`:`å®è§‚å½±å“ä¸­æ€§ï¼Œæ”¿ç­–çª—å£æœŸç»´æŒé…ç½®ã€‚${ol.narrative}`,
      finalNote: bias>1.2?(p.bandAction==='sell_band'?'âš ï¸ å®è§‚çœ‹å¥½ä½†ä½ç½®åé«˜ï¼Œç­‰å›è°ƒååˆ†æ‰¹åŠ ä»“':'âœ… å®è§‚+ä¸­æœŸè¶‹åŠ¿å…±æŒ¯çœ‹å¤šï¼Œå»ºè®®åŠ ä»“'):bias<-1.2?(p.bandAction==='buy_band'?'ğŸ’¡ å®è§‚åå¼±ä½†å·²è·Œè‡³ä½ä½ï¼Œå¯é€¢ä½å°‘é‡å»ºä»“':'âŒ å®è§‚æ‰¿å‹å åŠ é«˜ä½ï¼Œå»ºè®®å‡ä»“'):(p.bandAction==='buy_band'?'ğŸ’¡ å®è§‚ä¸­æ€§+ä½ä½ï¼Œé€‚åˆåˆ†æ‰¹å¸ƒå±€':p.bandAction==='sell_band'?'âš ï¸ å®è§‚ä¸­æ€§+é«˜ä½ï¼Œæ³¢æ®µæ­¢ç›ˆ':'â¸ï¸ å®è§‚+ä½ç½®å‡ä¸­æ€§ï¼ŒæŒæœ‰ç­‰å¾…')
    };
  });
  analyses.qwen = {
    verdict: ybBias>0.2?'bull':ybBias<-0.2?'bear':'neutral',
    verdictText: ybBias>0.2?'å®è§‚åå¤š':ybBias<-0.2?'å®è§‚æ‰¿å‹':'å®è§‚ä¸­æ€§',
    summary: ybBias>0.2 ?
      `æœªæ¥3ä¸ªæœˆå®è§‚å±•æœ›åä¹è§‚ï¼š${seededRand(seed+22)>0.5?'å¤®è¡Œç»´æŒå®½æ¾å–å‘ï¼ŒMLF/LPRåˆ©ç‡æœ‰æœ›å†é™':'æµåŠ¨æ€§ä¿æŒå……è£•ï¼Œç¤¾èå¢é€Ÿä¼ç¨³å›å‡'}ã€‚${seededRand(seed+23)>0.5?'PMIè¿ç»­å¤„äºè£æ¯çº¿ä¸Šæ–¹ï¼Œç»æµä¿®å¤åŠ¨èƒ½å¢å¼º':'å‡ºå£æ•°æ®è¶…é¢„æœŸï¼Œåˆ¶é€ ä¸šæ™¯æ°”åº¦å›æš–'}ã€‚æ”¿ç­–é¢ï¼Œ${seededRand(seed+24)>0.5?'AIäº§ä¸šæ”¿ç­–å¯†é›†å‡ºå°ï¼Œæœ‰è‰²é‡‘å±æˆ˜ç•¥å‚¨å¤‡æå‡':'æ–°è´¨ç”Ÿäº§åŠ›+æ´»è·ƒèµ„æœ¬å¸‚åœºæ”¿ç­–æŒç»­å‘åŠ›'}ã€‚å›½é™…å±€åŠ¿${factors.geopoliticalTension>0.6?'ç´§å¼ ä½†åˆ©å¥½é»„é‡‘/å†›å·¥ç­‰é¿é™©æ¿å—':'ç›¸å¯¹å¯æ§'}ã€‚` :
      ybBias<-0.2 ?
      `æœªæ¥3ä¸ªæœˆå®è§‚åè°¨æ…ï¼š${seededRand(seed+26)>0.5?'ç»æµä¿®å¤èŠ‚å¥æ”¾ç¼“ï¼Œæ¶ˆè´¹æ•°æ®ä½äºé¢„æœŸ':'æˆ¿åœ°äº§æ‹–ç´¯æ•ˆåº”æŒç»­ï¼Œå†…éœ€æ¢å¤åæ…¢'}ã€‚${seededRand(seed+27)>0.5?'ä¸­ç¾å…³ç³»ä¸ç¡®å®šæ€§å¢åŠ ï¼Œå‡ºå£æ‰¿å‹':'å…¨çƒå¤®è¡Œæ”¿ç­–åˆ†æ­§ï¼Œäººæ°‘å¸æ±‡ç‡åŒå‘æ³¢åŠ¨'}ã€‚å»ºè®®é˜²å¾¡ä¸ºä¸»ï¼Œå…³æ³¨é«˜è‚¡æ¯çº¢åˆ©+é»„é‡‘é¿é™©é…ç½®ã€‚` :
      `æœªæ¥3ä¸ªæœˆå®è§‚ä¸­æ€§åå¹³ï¼šç»æµè¿è¡Œå¹³ç¨³ä½†å¼¹æ€§ä¸è¶³ï¼ŒæµåŠ¨æ€§åˆç†å……è£•ã€‚AIäº§ä¸šé“¾${factors.aiIndustryBoom>0.7?'æ˜¯æœ€å¤§ç»“æ„æ€§äº®ç‚¹':'ä¿æŒé«˜æ™¯æ°”'}ï¼Œæœ‰è‰²é‡‘å±å—ç›Šäº${factors.commodityCycle>0.6?'AIç®—åŠ›é“œéœ€æ±‚+æ–°èƒ½æºé‡‘å±éœ€æ±‚':'ä¾›éœ€æ ¼å±€æ”¹å–„'}ã€‚å…³æ³¨æ”¿ç­–è¾¹é™…å˜åŒ–ã€‚`,
    holdingViews: holdings.map(h=>ybFundViews[h.code]).filter(Boolean),
    watchViews: watchlist.map(w=>ybFundViews[w.code]).filter(Boolean)
  };
  
  // === DeepSeek (Fundamental + Industry) â€” åŸºæœ¬é¢+äº§ä¸šè¶‹åŠ¿3æœˆå‰ç» ===
  const dsBias = factors.aiIndustryBoom*1 + factors.domesticRecovery*0.8 - factors.globalRisk*0.5 - 0.8;
  const dsFundViews = {};
  allFundCodes.forEach(code=>{
    const f = getFundData(code);
    const p = fundProfiles[code];
    const ol = getOutlookScore(code);
    let bias = ol.score*0.9 + dsBias*0.3 + (seededRand(seed+parseInt(code)+40)-0.5)*1;
    // Year performance as valuation signal
    if(p.yearReturn>30 && p.pos>0.75) bias -= 0.6; // overbought
    if(p.yearReturn<-15 && p.pos<0.3) bias += 0.5; // oversold value
    if(p.bandAction==='sell_band') bias -= 0.3;
    if(p.bandAction==='buy_band') bias += 0.3;
    dsFundViews[code] = {
      code, name:fundName(code), pct:f.gszzl,
      yearReturn:p.yearReturn, maxDD:p.maxDD, vol:p.vol, pos:p.pos, bandText:p.bandText,
      action: bias>1?'buy':bias<-1?'sell':'hold',
      reason: bias>1?`äº§ä¸šæ™¯æ°”åº¦æœªæ¥3ä¸ªæœˆæŒç»­ä¸Šè¡Œ${p.pos<0.4?'ï¼Œä¼°å€¼å¤„äºä½ä½æå…·æ€§ä»·æ¯”':'ï¼ŒåŸºæœ¬é¢é©±åŠ¨ä¸­é•¿æœŸä¸Šæ¶¨é€»è¾‘'}ã€‚${ol.narrative}`:bias<-1?`${p.pos>0.7?'ä¼°å€¼å¤„äºé«˜ä½å åŠ ':''}åŸºæœ¬é¢è¾¹é™…èµ°å¼±ï¼Œæœªæ¥3ä¸ªæœˆç›ˆåˆ©é¢„æœŸä¸‹ä¿®ã€‚${ol.narrative}`:`åŸºæœ¬é¢ç¨³å®šï¼Œè¡Œä¸šæ™¯æ°”ä¸­æ€§ã€‚${ol.narrative}`,
      finalNote: bias>1?(p.bandAction==='sell_band'?'âš ï¸ åŸºæœ¬é¢çœ‹å¥½ä½†ä¼°å€¼åé«˜ï¼Œåˆ†æ‰¹åŠ ä»“æ›´ç¨³å¦¥':'âœ… äº§ä¸šè¶‹åŠ¿+ä½ä½å…±æŒ¯ï¼Œä¸­é•¿æœŸåŠ ä»“è‰¯æœº'):bias<-1?(p.bandAction==='buy_band'?'ğŸ’¡ åŸºæœ¬é¢åå¼±ä½†å·²è¶…è·Œï¼Œå¯åšåå¼¹å°ä»“ä½ä»‹å…¥':'âŒ åŸºæœ¬é¢+ä½ç½®åŒé‡åˆ©ç©ºï¼Œæœæ–­å‡ä»“'):(p.bandAction==='buy_band'?'ğŸ’¡ åŸºæœ¬é¢ä¸­æ€§+ä½ä½æ”¯æ’‘ï¼Œé€‚åˆé€¢ä½å¸ƒå±€':p.bandAction==='sell_band'?'âš ï¸ åŸºæœ¬é¢ä¸­æ€§+é«˜ä½æ‰¿å‹ï¼Œæ³¢æ®µå‡ä»“':'â¸ï¸ åŸºæœ¬é¢+ä½ç½®å‡ä¸­æ€§ï¼Œè€å¿ƒæŒæœ‰')
    };
  });
  analyses.deepseek = {
    verdict: dsBias>0.3?'bull':dsBias<-0.3?'bear':'neutral',
    verdictText: dsBias>0.3?'äº§ä¸šè¶‹åŠ¿å‘å¥½':dsBias<-0.3?'åŸºæœ¬é¢æ‰¿å‹':'åŸºæœ¬é¢åˆ†åŒ–',
    summary: `æœªæ¥3ä¸ªæœˆæ·±åº¦è¡Œä¸šç ”åˆ¤ï¼š` + (dsBias>0.3 ?
      `Aè‚¡ä¼°å€¼å¤„äºå†å²${seededRand(seed+32)>0.5?'30%åˆ†ä½åä½':'ä¸­ä½æ•°ä»¥ä¸‹'}ï¼Œå®‰å…¨è¾¹é™…å……è¶³ã€‚AIäº§ä¸šé“¾${factors.aiIndustryBoom>0.7?'æ˜¯æœ€å¤§ç¡®å®šæ€§æœºä¼šï¼Œç®—åŠ›éœ€æ±‚ç¿»å€æ‹‰åŠ¨åŠå¯¼ä½“+æœ‰è‰²é‡‘å±(é“œ)':'ä¿æŒé«˜æ™¯æ°”'}ã€‚${seededRand(seed+33)>0.5?'å›½äº§æ›¿ä»£åŠ é€Ÿæ¨è¿›ï¼ŒèŠ¯ç‰‡/è½¯ä»¶è‡ªä¸»å¯æ§é€»è¾‘å¼ºåŒ–':'æ¶ˆè´¹ç”µå­åº“å­˜å‘¨æœŸè§åº•ï¼Œæ¢æœºæ½®æ¨åŠ¨éœ€æ±‚å›å‡'}ã€‚æœ‰è‰²é‡‘å±å—ç›ŠäºAIæ•°æ®ä¸­å¿ƒå»ºè®¾å¯¹é“œé“çš„å·¨é‡éœ€æ±‚ã€‚` :
      dsBias<-0.3 ?
      `éƒ¨åˆ†æ¿å—ä¼°å€¼å·²å¤„äºå†å²${seededRand(seed+35)>0.5?'åé«˜æ°´å¹³':'70%åˆ†ä½ä»¥ä¸Š'}ã€‚${seededRand(seed+36)>0.5?'ä¸šç»©å…‘ç°å‹åŠ›åŠ å¤§':'ä¼°å€¼é€æ”¯æœªæ¥å¢é•¿é¢„æœŸ'}ï¼Œæœªæ¥3ä¸ªæœˆç›ˆåˆ©å¢é€Ÿé¢ä¸´ä¸‹ä¿®é£é™©ã€‚å»ºè®®å…³æ³¨ä½ä¼°å€¼çº¢åˆ©æ¿å—é˜²å¾¡ä»·å€¼ã€‚` :
      `å¸‚åœºä¼°å€¼ä¸­æ€§ï¼Œè¡Œä¸šæ™¯æ°”åº¦åˆ†åŒ–åŠ å‰§ã€‚AI/åŠå¯¼ä½“/æœ‰è‰²é‡‘å±ä¿æŒé«˜æ™¯æ°”ï¼Œæ¶ˆè´¹/é‡‘èä¿®å¤åæ…¢ã€‚å»ºè®®é‡é…äº§ä¸šè¶‹åŠ¿æ˜ç¡®çš„æ–¹å‘ï¼Œè½»é…ç¼ºä¹å‚¬åŒ–çš„æ¿å—ã€‚`),
    holdingViews: holdings.map(h=>dsFundViews[h.code]).filter(Boolean),
    watchViews: watchlist.map(w=>dsFundViews[w.code]).filter(Boolean)
  };
  
  // === Gemini (Global + Risk) â€” å…¨çƒè§†è§’+åœ°ç¼˜é£é™©3æœˆå‰ç» ===
  const gmBias = factors.globalRisk*-1 + factors.exportStrength*0.8 + factors.geopoliticalTension*-0.3 + 0.5;
  const gmFundViews = {};
  allFundCodes.forEach(code=>{
    const f = getFundData(code);
    const type = fundType(code);
    const p = fundProfiles[code];
    const ol = getOutlookScore(code);
    let bias = ol.score*0.7 + gmBias*0.4 + (seededRand(seed+parseInt(code)+50)-0.5)*1;
    // Global risk premium adjustments
    if(type.includes('é»„é‡‘')) bias += factors.geopoliticalTension*2 + factors.globalRisk*1 - 1;
    if(type.includes('å†›å·¥')) bias += factors.geopoliticalTension*1.5 - 0.5;
    if((type.includes('ç§‘æŠ€')||type.includes('AI'))) bias += factors.aiIndustryBoom*1.5 - 0.6;
    if(type.includes('æœ‰è‰²')||type.includes('èµ„æº')) bias += factors.commodityCycle*1 + factors.aiIndustryBoom*0.6 - 0.6;
    if(type.includes('QDII')||type.includes('å•†å“')) bias += factors.globalRisk*-0.5 + factors.commodityCycle*0.5;
    // Band position
    if(p.pos>0.8) bias -= 0.4;
    if(p.pos<0.2) bias += 0.4;
    if(p.bandAction==='sell_band') bias -= 0.2;
    if(p.bandAction==='buy_band') bias += 0.2;
    gmFundViews[code] = {
      code, name:fundName(code), pct:f.gszzl,
      yearReturn:p.yearReturn, maxDD:p.maxDD, vol:p.vol, pos:p.pos, bandText:p.bandText,
      action: bias>1.2?'buy':bias<-1.2?'sell':'hold',
      reason: bias>1.2?`å…¨çƒè§†è§’ä¸‹è¯¥èµ„äº§æœªæ¥3ä¸ªæœˆå…·å¤‡é…ç½®ä»·å€¼${p.pos<0.4?'ï¼Œä½ä½ç©ºé—´å¤§':''}ã€‚${ol.narrative}`:bias<-1.2?`å…¨çƒä¸ç¡®å®šæ€§${p.pos>0.7?'å åŠ é«˜ä½ï¼Œå»ºè®®é™ä½é£é™©æ•å£':'ä¼ å¯¼è‡³è¯¥æ¿å—ï¼Œä¸­æœŸæ‰¿å‹'}ã€‚${ol.narrative}`:`å…¨çƒç»´åº¦ä¸­æ€§ï¼Œç»´æŒå½“å‰é…ç½®æ¯”ä¾‹ã€‚${ol.narrative}`,
      finalNote: bias>1.2?(p.bandAction==='sell_band'?'âš ï¸ å…¨çƒåˆ©å¥½ä½†é«˜ä½ï¼Œæ‹©æ—¶åˆ†æ‰¹åŠ ä»“':'âœ… å…¨çƒè¶‹åŠ¿+ä½ç½®å®‰å…¨ï¼Œä¸­æœŸåŠ ä»“é…ç½®'):bias<-1.2?(p.bandAction==='buy_band'?'ğŸ’¡ å…¨çƒé£é™©ä½†å·²è‡³ä½ä¼°å€¼ï¼Œå¯å°ä»“ä½å·¦ä¾§å¸ƒå±€':'âŒ å…¨çƒé£é™©+é«˜ä½æ‰¿å‹ï¼Œå‡ä»“é¿é™©'):(p.bandAction==='buy_band'?'ğŸ’¡ å…¨çƒä¸­æ€§+ä½ä½ï¼Œåˆ†æ‰¹é…ç½®':p.bandAction==='sell_band'?'âš ï¸ å…¨çƒä¸­æ€§+é«˜ä½ï¼Œæ³¢æ®µæ­¢ç›ˆ':'â¸ï¸ å…¨çƒ+ä½ç½®å‡ä¸­æ€§ï¼Œç»´æŒå½“å‰é…ç½®')
    };
  });
  analyses.gemini = {
    verdict: gmBias>0.3?'bull':gmBias<-0.3?'bear':'neutral',
    verdictText: gmBias>0.3?'å…¨çƒåæš–':gmBias<-0.3?'å…¨çƒé£é™©å‡æ¸©':'å…¨çƒä¸­æ€§',
    summary: `æœªæ¥3ä¸ªæœˆå…¨çƒè§†è§’ï¼š` + (gmBias>0.3 ?
      `å…¨çƒrisk-onæƒ…ç»ªå›æš–ï¼Œ${seededRand(seed+42)>0.5?'ç¾è”å‚¨é™æ¯é¢„æœŸæ”¯æ’‘å…¨çƒé£é™©èµ„äº§':'æ–°å…´å¸‚åœºèµ„é‡‘å›æµåŠ é€Ÿ'}ã€‚VIXç»´æŒä½ä½ã€‚AIäº§ä¸šæµªæ½®${factors.aiIndustryBoom>0.7?'æ¨åŠ¨å…¨çƒé“œé“ç­‰æœ‰è‰²é‡‘å±éœ€æ±‚é£™å‡ï¼Œæ•°æ®ä¸­å¿ƒå»ºè®¾æˆä¸ºæ–°çš„è¶…çº§å‘¨æœŸ':'æŒç»­åˆ©å¥½ç§‘æŠ€+ä¸Šæ¸¸èµ„æºæ¿å—'}ã€‚${factors.geopoliticalTension>0.6?'åœ°ç¼˜ç´§å¼ ä½†é»„é‡‘/å†›å·¥æä¾›å¯¹å†²':'åœ°ç¼˜é£é™©å¯æ§'}ã€‚Aè‚¡åœ¨å…¨çƒèµ„äº§ä¸­${seededRand(seed+44)>0.5?'ä¼°å€¼æ´¼åœ°':'é…ç½®æ€§ä»·æ¯”çªå‡º'}ã€‚` :
      gmBias<-0.3 ?
      `æµ·å¤–ä¸ç¡®å®šæ€§å¢åŠ ï¼Œ${seededRand(seed+46)>0.5?'åœ°ç¼˜å†²çªå‡çº§é£é™©':'ç¾è”å‚¨æ”¿ç­–æ‘‡æ‘†'}å‹åˆ¶é£é™©åå¥½ã€‚VIXä¸­æ¢ä¸Šç§»ã€‚æ–°å…´å¸‚åœºé¢ä¸´${seededRand(seed+47)>0.5?'èµ„æœ¬å¤–æµ':'æ±‡ç‡æ³¢åŠ¨'}å‹åŠ›ã€‚å»ºè®®å¢é…é»„é‡‘/çº¢åˆ©ç­‰é˜²å¾¡èµ„äº§ï¼Œé™ä½ç»„åˆæ³¢åŠ¨ã€‚AIè¶‹åŠ¿ä»æ˜¯å°‘æ•°ç¡®å®šæ€§æ–¹å‘ã€‚` :
      `å…¨çƒæ ¼å±€å¹³è¡¡ä½†æš—æµæ¶ŒåŠ¨ã€‚AIäº§ä¸šé“¾æŒç»­ç¹è£æ‹‰åŠ¨æœ‰è‰²é‡‘å±éœ€æ±‚ï¼Œ${factors.geopoliticalTension>0.5?'å›½é™…å±€åŠ¿ç´§å¼ æå‡é¿é™©èµ„äº§æº¢ä»·':'åœ°ç¼˜é£é™©æ¸©å’Œ'}ã€‚å»ºè®®å‡è¡¡é…ç½®ï¼šæ ¸å¿ƒæŒä»“(AI/ç§‘æŠ€)+é˜²å¾¡é…ç½®(é»„é‡‘/çº¢åˆ©)+é€‚åº¦å…³æ³¨æœ‰è‰²é‡‘å±çš„AIéœ€æ±‚é€»è¾‘ã€‚`),
    holdingViews: holdings.map(h=>gmFundViews[h.code]).filter(Boolean),
    watchViews: watchlist.map(w=>gmFundViews[w.code]).filter(Boolean)
  };
  
  // ==================== AI BUY RECOMMENDATIONS ====================
  // Select funds from RECO_FUND_POOL based on 3-month forward outlook
  
  // Filter out funds already in holdings or watchlist
  const ownedCodes = new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)]);
  const pool = RECO_FUND_POOL.filter(f=>!ownedCodes.has(f.code));
  
  // Score each fund based on 3-month sector outlook + macro factors
  const scored = pool.map(f=>{
    let score = 50 + (seededRand(seed+parseInt(f.code)+200)-0.3)*15; // smaller random baseline
    const t = f.type;
    
    // Get 3-month forward outlook for this fund's sector
    const ol = getOutlookScore(f.code);
    score += ol.score * 6; // outlook is the primary driver (+/-30 points)
    
    // Macro factor boosts â€” structural/thematic, not daily price based
    if(t.includes('é»„é‡‘')){
      score += factors.geopoliticalTension * 12; // geopolitical tension drives gold
      score += factors.globalRisk * 5;
    }
    if(t.includes('æœ‰è‰²')){
      score += factors.aiIndustryBoom * 10; // AI data centers need copper/aluminum
      score += factors.commodityCycle * 6;
    }
    if(t.includes('ç§‘æŠ€')||t.includes('AI')||t.includes('åŠå¯¼ä½“')){
      score += factors.aiIndustryBoom * 12; // AI boom is a structural mega-trend
    }
    if(t.includes('å†›å·¥')){
      score += factors.geopoliticalTension * 10;
    }
    if(t.includes('æ–°èƒ½æº')){
      score += factors.exportStrength * 6;
      score += factors.domesticRecovery * 4;
    }
    if(t.includes('æ¶ˆè´¹')||t.includes('åŒ»è¯')){
      score += factors.domesticRecovery * 8;
    }
    if(t.includes('çº¢åˆ©')){
      score += factors.rateEnvironment * 8; // rate cut cycle favors dividends
      score += factors.globalRisk * 4; // defensive in uncertain times
    }
    if(t.includes('å®½åŸº')){
      score += factors.domesticRecovery * 5;
      score += factors.rateEnvironment * 3;
    }
    if(t.includes('QDII')||t.includes('å•†å“')){
      score += factors.commodityCycle * 6;
      score += factors.globalRisk * 3; // diversification value
    }
    if(t.includes('é‡‘è')){
      score += factors.domesticRecovery * 6;
      score += factors.rateEnvironment * 3;
    }
    if(t.includes('èµ„æº')){
      score += factors.commodityCycle * 8;
      score += factors.aiIndustryBoom * 4;
    }
    
    score = Math.max(30, Math.min(99, score));
    
    // Generate reason based on 3-month outlook narrative
    let reason;
    if(score>=75){
      reason = t.includes('é»„é‡‘') ? `æœªæ¥3ä¸ªæœˆï¼š${ol.narrative}ã€‚åœ°ç¼˜é£é™©æº¢ä»·(${Math.round(factors.geopoliticalTension*100)}%)æ”¯æ’‘é‡‘ä»·` :
             t.includes('æœ‰è‰²') ? `æœªæ¥3ä¸ªæœˆï¼šAIäº§ä¸šæ‹‰åŠ¨é“œé“éœ€æ±‚æ¿€å¢ï¼Œä¾›ç»™ç«¯çŸ¿å±±èµ„æœ¬å¼€æ”¯ä¸è¶³ã€‚${ol.narrative}` :
             t.includes('AI')||t.includes('ç§‘æŠ€') ? `æœªæ¥3ä¸ªæœˆï¼š${ol.narrative}` :
             t.includes('åŠå¯¼ä½“') ? `æœªæ¥3ä¸ªæœˆï¼šAIç®—åŠ›èŠ¯ç‰‡éœ€æ±‚çˆ†å‘+å›½äº§æ›¿ä»£åŠ é€Ÿã€‚${ol.narrative}` :
             t.includes('å†›å·¥') ? `æœªæ¥3ä¸ªæœˆï¼šå›½é™…å±€åŠ¿ç´§å¼ (${Math.round(factors.geopoliticalTension*100)}%)+å›½é˜²é¢„ç®—ç¨³å¢ã€‚${ol.narrative}` :
             t.includes('çº¢åˆ©') ? `æœªæ¥3ä¸ªæœˆï¼šåˆ©ç‡ä¸‹è¡Œå‘¨æœŸä¸­é«˜è‚¡æ¯ç¨€ç¼ºæ€§æå‡ã€‚${ol.narrative}` :
             t.includes('QDII')||t.includes('å•†å“') ? `æœªæ¥3ä¸ªæœˆï¼šå…¨çƒèµ„äº§é…ç½®åˆ†æ•£Aè‚¡é£é™©ã€‚${ol.narrative}` :
             `æœªæ¥3ä¸ªæœˆå¤šå› å­å…±æŒ¯çœ‹å¥½ï¼š${ol.narrative}`;
    } else if(score>=60){
      reason = ol.narrative;
    } else {
      reason = `ä¸­æœŸé€»è¾‘å°šéœ€éªŒè¯ï¼Œ${ol.narrative}ã€‚å¯å°‘é‡è·Ÿè¸ªè§‚å¯Ÿ`;
    }
    
    return {...f, score:Math.round(score), reason};
  });
  
  // Sort by score, take top 6
  scored.sort((a,b)=>b.score-a.score);
  analyses._recoFunds = scored.slice(0, 6).map(f=>({
    code:f.code, name:f.name, type:f.type, tags:f.tags,
    score:f.score, reason:f.reason,
    bandTip: f.score>=75 ? 'ä¸­æœŸçœ‹å¥½ï¼Œå»ºè®®åˆ†3æ‰¹å»ºä»“(1/3+1/3+1/3)ï¼Œæ¯è·Œ3-5%åŠ ä¸€æ¬¡' :
             f.score>=60 ? 'å‰æ™¯åæ­£é¢ï¼Œè½»ä»“è¯•æ¢ï¼Œç¡®è®¤äº§ä¸šè¶‹åŠ¿åå†åŠ ä»“' : 'ä»…å»ºè®®è§‚å¯Ÿè·Ÿè¸ªï¼Œç­‰å¾…ä¸­æœŸé€»è¾‘éªŒè¯åä»‹å…¥'
  }));
  
  return analyses;
}

// Synthesize all AI analyses into final recommendations
function synthesizeRecommendations(analyses){
  const recos = [];
  // Only use engines that have real data
  const availEngines = AI_ENGINES.filter(eng=>analyses[eng.id]);
  
  holdings.forEach(h=>{
    const info = FUND_DB.find(x=>x.code===h.code);
    const f = getFundData(h.code);
    
    // Collect votes from available AIs only
    const votes = {};
    const reasons = {};
    availEngines.forEach(eng=>{
      const view = analyses[eng.id]?.holdingViews?.find(v=>v.code===h.code);
      if(view){
        votes[eng.id] = view.action;
        reasons[eng.id] = view.reason;
      }
    });
    
    // Count votes
    const buyVotes = Object.values(votes).filter(v=>v==='buy').length;
    const sellVotes = Object.values(votes).filter(v=>v==='sell').length;
    const holdVotes = Object.values(votes).filter(v=>v==='hold').length;
    const totalVotes = buyVotes + sellVotes + holdVotes;
    
    // Consensus (dynamic thresholds based on available engines)
    let action, confidence;
    if(totalVotes === 0){ action='hold'; confidence='æ— æ•°æ®'; }
    else if(buyVotes >= Math.ceil(totalVotes*0.75)){ action='buy'; confidence='å¼ºçƒˆ'; }
    else if(buyVotes >= Math.ceil(totalVotes*0.5) && sellVotes===0){ action='buy'; confidence='è¾ƒå¼º'; }
    else if(sellVotes >= Math.ceil(totalVotes*0.75)){ action='sell'; confidence='å¼ºçƒˆ'; }
    else if(sellVotes >= Math.ceil(totalVotes*0.5) && buyVotes===0){ action='sell'; confidence='è¾ƒå¼º'; }
    else if(buyVotes > sellVotes){ action='buy'; confidence='æ¸©å’Œ'; }
    else if(sellVotes > buyVotes){ action='sell'; confidence='æ¸©å’Œ'; }
    else { action='hold'; confidence='ä¸€è‡´'; }
    
    // Build consensus string (only show engines that voted)
    const voteStr = availEngines.filter(e=>votes[e.id]).map(e=>{
      const v = votes[e.id];
      const label = v==='buy'?'ä¹°å…¥':v==='sell'?'å–å‡º':'æŒæœ‰';
      return `${e.icon}${e.name}:${label}`;
    }).join(' Â· ');
    
    // Synthesized reason
    const mainReasons = [];
    availEngines.forEach(e=>{
      if(votes[e.id]===action || (action==='hold' && votes[e.id]==='hold')){
        mainReasons.push(reasons[e.id]);
      }
    });
    const synthReason = mainReasons.length>0 ? mainReasons.join('ï¼›') : 'å„AIå¼•æ“è§‚ç‚¹åˆ†æ­§è¾ƒå¤§ï¼Œå»ºè®®ä¿æŒè§‚æœ›ã€‚';
    
    recos.push({
      code: h.code,
      name: info?info.name:h.code,
      type: info?info.type:'åŸºé‡‘',
      todayPct: f.gszzl,
      action,
      confidence,
      consensus: voteStr,
      reason: synthReason,
      votes: {buy:buyVotes, sell:sellVotes, hold:holdVotes},
    });
  });
  
  return recos;
}

// ==================== AI LIVE CARD (HOMEPAGE PROMINENT) ====================
let _aiActiveTab = 'synthesis'; // 'synthesis' | engine id

// ==================== MANAGER ANALYSIS ENTRY CARD ====================
function renderManagerAnalysisEntry(){
  return `<div class="tm-section">
    <div class="tm-header" style="cursor:pointer" onclick="location.href='manager-analysis.html'">
      <div>
        <div class="tmh-left"><span class="tmh-title">ğŸ† åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ</span><span class="tmh-badge">TOP500</span></div>
        <div class="tmh-sub">åŸºäºä¸œæ–¹è´¢å¯ŒChoiceå…¨é‡æ•°æ® Â· 500ä½å¤´éƒ¨åŸºé‡‘ç»ç†æ·±åº¦åˆ†æ</div>
      </div>
    </div>
    <div class="tm-body" style="padding:16px">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
        <div style="text-align:center;background:#fffbeb;border-radius:10px;padding:10px 6px">
          <div style="font-size:20px;font-weight:800;color:#d97706">500</div>
          <div style="font-size:9px;color:var(--sub);margin-top:2px">å¤´éƒ¨åŸºé‡‘ç»ç†</div>
        </div>
        <div style="text-align:center;background:#fffbeb;border-radius:10px;padding:10px 6px">
          <div style="font-size:20px;font-weight:800;color:#d97706">18+</div>
          <div style="font-size:9px;color:var(--sub);margin-top:2px">æŠ•èµ„é£æ ¼åˆ†ç±»</div>
        </div>
        <div style="text-align:center;background:#fffbeb;border-radius:10px;padding:10px 6px">
          <div style="font-size:20px;font-weight:800;color:#d97706">3æœˆ</div>
          <div style="font-size:9px;color:var(--sub);margin-top:2px">å‰ç»å»ºè®®</div>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px">
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#eef2ff;color:var(--primary)">ğŸ“Š æ•°æ®æ¦‚è§ˆ</span>
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#ecfdf5;color:#065f46">ğŸ¯ ç­–ç•¥åˆ†æ</span>
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#fef3c7;color:#92400e">ğŸ¢ å…¬å¸å¯¹æ¯”</span>
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#fce7f3;color:#9d174d">ğŸ“ˆ ç»éªŒå›æŠ¥</span>
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#e0e7ff;color:#3730a3">ğŸ’¡ è¡Œä¸ºæ´å¯Ÿ</span>
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#fef2f2;color:#991b1b">ğŸ”® ä¸‰æœˆå‰ç»</span>
        <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:#fffbeb;color:#92400e">ğŸ–ï¸ åŸºé‡‘æ¨è</span>
      </div>
      <a href="manager-analysis.html" style="display:block;text-align:center;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;padding:10px;border-radius:10px;font-size:13px;font-weight:700;text-decoration:none;box-shadow:0 2px 8px rgba(217,119,6,.3)">è¿›å…¥å®Œæ•´åˆ†æ â†’</a>
      <div style="text-align:center;font-size:10px;color:var(--sub);margin-top:8px">å®æ—¶ä»å¤©å¤©åŸºé‡‘APIè·å–æ•°æ® Â· å«æ¿å—é…ç½®å»ºè®®ä¸ç²¾é€‰åŸºé‡‘æ¨è</div>
    </div>
  </div>`;
}

function renderAILiveCard(){
  if(holdings.length===0 && watchlist.length===0) return '';
  
  // Auto-generate analysis if we have market data
  if(!analysisData && Object.keys(liveFundData).length>0 && (holdings.length>0||watchlist.length>0)){
    if(_302aiKey && !_aiAnalyzing){
      // Trigger real AI analysis asynchronously, show loading state now
      _aiAnalyzing = true;
      generateRealAIAnalysis((msg)=>{
        const badge = document.querySelector('.alh-badge');
        if(badge) badge.textContent = msg;
      }).then(result=>{
        analysisData = result;
        _aiAnalyzing = false;
        renderFeed();
      }).catch(e=>{
        console.error('Auto real AI failed:', e);
        // Don't fall back to simulated â€” show error state
        _aiAnalyzing = false;
        renderFeed();
      });
      // Return loading state card immediately
    } else if(!_302aiKey) {
      analysisData = generateAIAnalysis_simulated();
    }
    // If _aiAnalyzing is true, we're already fetching â€” fall through to show loading
  }
  
  if(!analysisData) {
    const isLoading = _aiAnalyzing;
    return `<div class="ai-live-card">
      <div class="ai-live-header">
        <div class="alh-left"><span class="alh-title">ğŸ§  AIå®æ—¶ç ”åˆ¤</span><span class="alh-badge">${isLoading?'AIåˆ†æä¸­...':'ç­‰å¾…æ•°æ®'}</span></div>
        ${isLoading?'':'<button class="alh-btn" onclick="triggerAnalysisNow()">å¼€å§‹åˆ†æ</button>'}
      </div>
      <div style="padding:20px;text-align:center;color:var(--sub);font-size:12px">${isLoading?'<div class="spinner"></div> æ­£åœ¨è°ƒç”¨AIå¼•æ“åˆ†æï¼Œè¯·ç¨å€™...':'åŠ è½½å¸‚åœºæ•°æ®åè‡ªåŠ¨åˆ†æ...'}</div>
    </div>`;
  }
  
  const data = analysisData;
  const now = new Date();
  const timeLabel = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  let html = `<div class="ai-live-card">
    <div class="ai-live-header">
      <div class="alh-left"><span class="alh-title">ğŸ§  AIå®æ—¶ç ”åˆ¤</span><span class="alh-badge">${timeLabel}æ›´æ–°</span></div>
      <button class="alh-btn" onclick="refreshAnalysis()">â†» åˆ·æ–°</button>
    </div>`;
  
  // Tab bar: ç»¼åˆ first, then individual AIs (only show engines with data)
  const availableEngines = AI_ENGINES.filter(eng=>data[eng.id]);
  html += `<div class="ai-engine-tabs">
    <div class="ai-engine-tab ${_aiActiveTab==='synthesis'?'active':''}" onclick="switchAILiveTab('synthesis')"><span class="aet-icon">ğŸ¯</span>ç»¼åˆç ”åˆ¤</div>`;
  availableEngines.forEach(eng=>{
    html += `<div class="ai-engine-tab ${_aiActiveTab===eng.id?'active':''}" onclick="switchAILiveTab('${eng.id}')"><span class="aet-icon">${eng.icon}</span>${eng.name}</div>`;
  });
  html += `</div>`;
  
  // === Synthesis View (default) ===
  html += `<div class="ai-engine-view ${_aiActiveTab==='synthesis'?'active':''}" id="aev-synthesis">`;
  html += renderSynthesisView(data);
  html += `</div>`;
  
  // === Individual AI views (only available engines) ===
  availableEngines.forEach(eng=>{
    const a = data[eng.id];
    if(!a) return;
    html += `<div class="ai-engine-view ${_aiActiveTab===eng.id?'active':''}" id="aev-${eng.id}">`;
    html += renderEngineView(eng, a);
    html += `</div>`;
  });
  
  html += `</div>`;
  return html;
}

function renderSynthesisView(data){
  const availEngines = AI_ENGINES.filter(e=>data[e.id]);
  let bullN=0, bearN=0, neutralN=0;
  availEngines.forEach(e=>{
    const v = data[e.id]?.verdict;
    if(v==='bull') bullN++; else if(v==='bear') bearN++; else neutralN++;
  });
  const total = bullN+bearN+neutralN||1;
  const synthLabel = bullN>bearN ? 'åå¤š' : bearN>bullN ? 'åç©º' : 'åˆ†æ­§';
  const synthColor = bullN>bearN ? 'var(--up)' : bearN>bullN ? 'var(--down)' : 'var(--warn)';
  const synthIcon = bullN>bearN ? 'ğŸ“ˆ' : bearN>bullN ? 'ğŸ“‰' : 'âš–ï¸';
  
  // Aggregate fund-level actions across available AI engines
  const allCodes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  let fundBuyN=0, fundSellN=0, fundHoldN=0;
  allCodes.forEach(code=>{
    let buys=0,sells=0,holds=0;
    availEngines.forEach(eng=>{
      const hv = data[eng.id]?.holdingViews?.find(x=>x.code===code);
      const wv = data[eng.id]?.watchViews?.find(x=>x.code===code);
      const v = hv || wv;
      if(v){ if(v.action==='buy') buys++; else if(v.action==='sell') sells++; else holds++; }
    });
    if(buys>sells) fundBuyN++;
    else if(sells>buys) fundSellN++;
    else fundHoldN++;
  });
  const fundTotal = fundBuyN+fundSellN+fundHoldN||1;
  
  let html = `<div class="synth-overview">
    <div class="ai-verdict ${bullN>bearN?'bull':bearN>bullN?'bear':'neutral'}">
      <span class="ai-verdict-icon">${synthIcon}</span>
      <div><strong>ç»¼åˆç ”åˆ¤ï¼š${synthLabel}</strong><br><span style="font-size:10px">${availEngines.length}å®¶AIå¼•æ“ï¼šçœ‹å¤š${bullN} Â· ä¸­æ€§${neutralN} Â· çœ‹ç©º${bearN}</span></div>
    </div>
    <div class="synth-meter">
      <div class="sm-bar">
        <div class="sm-seg bull" style="width:${bullN/total*100}%"></div>
        <div class="sm-seg neutral" style="width:${neutralN/total*100}%"></div>
        <div class="sm-seg bear" style="width:${bearN/total*100}%"></div>
      </div>
      <div class="sm-text" style="color:${synthColor}">${bullN}ğŸ“ˆ ${neutralN}âš–ï¸ ${bearN}ğŸ“‰</div>
    </div>
    <div style="margin-top:8px;padding:8px 10px;background:#f8fafc;border-radius:8px;font-size:11px;display:flex;align-items:center;gap:6px">
      <span style="font-weight:600;color:var(--text)">ğŸ“‹ ${allCodes.length}åªåŸºé‡‘ç»¼åˆï¼š</span>
      <span style="color:var(--up);font-weight:600">ä¹°å…¥${fundBuyN}åª</span>
      <span style="color:var(--sub)">Â·</span>
      <span style="color:var(--warn);font-weight:600">æŒæœ‰${fundHoldN}åª</span>
      <span style="color:var(--sub)">Â·</span>
      <span style="color:var(--down);font-weight:600">å–å‡º${fundSellN}åª</span>
      <span style="flex:1"></span>
      <span style="background:linear-gradient(90deg,var(--up) ${fundBuyN/fundTotal*100}%,var(--warn) ${fundBuyN/fundTotal*100}% ${(fundBuyN+fundHoldN)/fundTotal*100}%,var(--down) ${(fundBuyN+fundHoldN)/fundTotal*100}%);height:4px;border-radius:2px;width:60px;display:inline-block"></span>
    </div>
  </div>`;
  
  // Engine overview grid (only available engines)
  html += `<div class="synth-engines">`;
  availEngines.forEach(eng=>{
    const a = data[eng.id];
    const vClass = a.verdict==='bull'?'bull':a.verdict==='bear'?'bear':'neutral';
    const vIcon = a.verdict==='bull'?'ğŸ“ˆ':a.verdict==='bear'?'ğŸ“‰':'âš–ï¸';
    html += `<div class="synth-eng" onclick="switchAILiveTab('${eng.id}')" style="cursor:pointer">
      <div class="se-head"><span class="se-icon">${eng.icon}</span><span class="se-name">${eng.name}</span></div>
      <div class="se-verdict ${vClass}">${vIcon} ${a.verdictText}</div>
      <div class="se-brief">${a.summary.slice(0,45)}...</div>
    </div>`;
  });
  html += `</div>`;
  
  // Synthesized fund recommendations: holdings
  if(holdings.length>0){
    const hCollapse = holdings.length > 3;
    html += `<div class="synth-fund-section"><div class="synth-fund-title">ğŸ“Š æŒä»“åŸºé‡‘ç»¼åˆå»ºè®® <span style="font-weight:400">(${holdings.length}åª)</span></div>`;
    if(hCollapse) html += `<div class="collapse-list" id="cl-synth-hold">`;
    holdings.forEach(h=>{
      html += `<div class="${hCollapse?'cl-item':''}">${renderSynthFundItem(h.code, data, 'holding')}</div>`;
    });
    if(hCollapse) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-synth-hold')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${holdings.length-3}åª</div></div>`;
    html += `</div>`;
  }
  
  // Synthesized fund recommendations: watchlist
  if(watchlist.length>0){
    const wCollapse = watchlist.length > 3;
    html += `<div class="synth-fund-section" style="margin-top:14px"><div class="synth-fund-title">â­ è‡ªé€‰åŸºé‡‘ç»¼åˆå»ºè®® <span style="font-weight:400">(${watchlist.length}åª)</span></div>`;
    if(wCollapse) html += `<div class="collapse-list" id="cl-synth-watch">`;
    watchlist.forEach(w=>{
      html += `<div class="${wCollapse?'cl-item':''}">${renderSynthFundItem(w.code, data, 'watch')}</div>`;
    });
    if(wCollapse) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-synth-watch')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${watchlist.length-3}åª</div></div>`;
    html += `</div>`;
  }
  
  // AI Buy Recommendations
  if(data._recoFunds && data._recoFunds.length>0){
    html += `<div class="reco-buy-section">
      <div class="reco-buy-title">ğŸ”¥ AIä¹°å…¥æ¨è <span class="rbt-badge">å®æ—¶ç­–ç•¥</span></div>`;
    data._recoFunds.forEach(f=>{
      const inWatch = watchlist.find(w=>w.code===f.code);
      const inHold = holdings.find(h=>h.code===f.code);
      const scoreColor = f.score>=75?'var(--up)':f.score>=60?'var(--warn)':'var(--sub)';
      html += `<div class="reco-buy-item">
        <div class="rbi-top">
          <span class="rbi-type">${f.type}</span>
          <span class="rbi-name">${f.name}</span>
          <span class="rbi-code">${f.code}</span>
          <span class="rbi-score" style="color:${scoreColor};background:${f.score>=75?'var(--up-bg)':f.score>=60?'var(--warn-bg)':'#f1f5f9'}">${f.score}åˆ†</span>
        </div>
        <div class="rbi-body">
          <div>ğŸ“Œ ${f.reason}</div>
          <div style="margin-top:3px">ğŸ”„ <b>æ³¢æ®µç­–ç•¥ï¼š</b>${f.bandTip}</div>
        </div>
        <div class="rbi-tags">${f.tags.map(t=>'<span class="rbi-tag">'+t+'</span>').join('')}</div>
        <div class="rbi-actions">
          ${inWatch||inHold
            ?'<button class="rbi-btn added" disabled>âœ… å·²åœ¨è‡ªé€‰</button>'
            :`<button class="rbi-btn primary" onclick="quickAddReco('${f.code}','${f.name.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}','${f.type}')">â­ åŠ å…¥è‡ªé€‰</button>`}
          <button class="rbi-btn outline" onclick="quickAddHoldingReco('${f.code}','${f.name.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}')">ğŸ’° åŠ å…¥æŒä»“</button>
        </div>
      </div>`;
    });
    html += `</div>`;
  }
  
  return html;
}

function renderSynthFundItem(code, data, listType){
  const f = getFundData(code);
  const info = FUND_DB.find(x=>x.code===code);
  const liveInfo = liveFundData[code];
  const recoInfo = RECO_FUND_POOL.find(x=>x.code===code);
  const hInfo = holdings.find(x=>x.code===code);
  const wInfo = watchlist.find(x=>x.code===code);
  const name = info?.name || recoInfo?.name || liveInfo?.name || hInfo?.name || wInfo?.name || f.name || code;
  const pct = f.gszzl||0;
  const c = pct>=0?'var(--up)':'var(--down)';
  
  // Collect votes from BOTH holdingViews and watchViews â€” use whichever has this code
  const avail = AI_ENGINES.filter(eng=>data[eng.id]);
  let buys=0,sells=0,holds=0;
  avail.forEach(eng=>{
    const hv = data[eng.id]?.holdingViews?.find(x=>x.code===code);
    const wv = data[eng.id]?.watchViews?.find(x=>x.code===code);
    const v = hv || wv; // same result since unified
    if(v){ if(v.action==='buy') buys++; else if(v.action==='sell') sells++; else holds++; }
  });
  const totalV = buys+sells+holds || 1;
  let action='hold', actLabel='æŒæœ‰';
  if(buys>=Math.ceil(totalV*0.75)){action='buy'; actLabel='å¼ºçƒˆä¹°å…¥';}
  else if(buys>=Math.ceil(totalV*0.5) && sells===0){action='buy'; actLabel='ä¹°å…¥';}
  else if(sells>=Math.ceil(totalV*0.75)){action='sell'; actLabel='å¼ºçƒˆå–å‡º';}
  else if(sells>=Math.ceil(totalV*0.5) && buys===0){action='sell'; actLabel='å–å‡º';}
  else if(buys>sells){action='buy'; actLabel='åå¤š';}
  else if(sells>buys){action='sell'; actLabel='åç©º';}
  else {action='hold'; actLabel='æŒæœ‰';}
  
  // Get year performance and band info from first available engine view
  let yearInfo = null;
  avail.forEach(eng=>{
    if(yearInfo) return;
    const hv = data[eng.id]?.holdingViews?.find(x=>x.code===code);
    const wv = data[eng.id]?.watchViews?.find(x=>x.code===code);
    yearInfo = hv || wv;
  });
  
  let extraHtml = '';
  if(yearInfo && yearInfo.yearReturn!==undefined){
    const yrC = yearInfo.yearReturn>=0?'var(--up)':'var(--down)';
    extraHtml = `<div class="sfi-expand">
      <div class="sfi-year"><span>ğŸ“…è¿‘1å¹´ <b style="color:${yrC}">${sign(yearInfo.yearReturn)}${fmt(yearInfo.yearReturn)}%</b></span><span>ğŸ“‰å›æ’¤ <b>-${fmt(yearInfo.maxDD)}%</b></span><span>ğŸ“<b>${Math.round(yearInfo.pos*100)}%</b>åˆ†ä½</span></div>
      ${yearInfo.bandText?`<div class="sfi-band">ğŸ”„ ${yearInfo.bandText}</div>`:''}
      ${yearInfo.finalNote?`<div style="font-weight:600;margin-top:2px">${yearInfo.finalNote}</div>`:''}
    </div>`;
  }
  
  return `<div class="synth-fund-item" style="flex-wrap:wrap">
    <div class="sfi-name">${name}<br><span style="font-size:10px;color:var(--sub)">${code}</span></div>
    <div class="sfi-pct" style="color:${c}">${sign(pct)}${fmt(pct)}%</div>
    <div class="sfi-votes">${buys}ğŸ“ˆ${holds}âš–ï¸${sells}ğŸ“‰</div>
    <div class="sfi-action ${action}">${actLabel}</div>
    ${extraHtml?`<div style="width:100%;padding:0 2px">${extraHtml}</div>`:''}
  </div>`;
}

function renderEngineView(eng, a){
  const vClass = a.verdict==='bull'?'bull':a.verdict==='bear'?'bear':'neutral';
  const vIcon = a.verdict==='bull'?'ğŸ“ˆ':a.verdict==='bear'?'ğŸ“‰':'âš–ï¸';
  let html = `<div class="ai-verdict ${vClass}"><span class="ai-verdict-icon">${vIcon}</span><div><strong>${eng.name}ç ”åˆ¤ï¼š${a.verdictText}</strong><br><span style="font-size:10px;color:var(--sub)">${eng.style}</span></div></div>`;
  html += `<div class="ai-detail"><p>${a.summary}</p></div>`;
  
  if(a.holdingViews && a.holdingViews.length>0){
    const hC = a.holdingViews.length > 3;
    html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin:12px 0 6px">ğŸ“Š æŒä»“åŸºé‡‘åˆ†æ (${a.holdingViews.length}åª)ï¼š</div>`;
    if(hC) html += `<div class="collapse-list" id="cl-eng-hold-${eng.id}">`;
    a.holdingViews.forEach(v=>{
      const actLabel = v.action==='buy'?'ä¹°å…¥':v.action==='sell'?'å–å‡º':'æŒæœ‰';
      const yrC = v.yearReturn>=0?'var(--up)':'var(--down)';
      html += `<div class="${hC?'cl-item':''}"><div class="ai-fund-row"><span class="f-name">${v.name}</span><span style="color:${v.pct>=0?'var(--up)':'var(--down)'};font-size:11px">${sign(v.pct)}${fmt(v.pct)}%</span><span class="f-action ${v.action}">${actLabel}</span></div>`;
      html += `<div class="ai-fund-detail">`;
      if(v.yearReturn!==undefined){
        html += `<div class="fd-year"><span class="fd-tag">ğŸ“…è¿‘1å¹´ï¼š<b style="color:${yrC}">${sign(v.yearReturn)}${fmt(v.yearReturn)}%</b></span><span class="fd-tag">ğŸ“‰å›æ’¤ï¼š<b>-${fmt(v.maxDD)}%</b></span><span class="fd-tag">ğŸ“Šæ³¢åŠ¨ï¼š<b>${fmt(v.vol)}%</b></span><span class="fd-tag">ğŸ“ä½ç½®ï¼š<b>${Math.round(v.pos*100)}%</b>åˆ†ä½</span></div>`;
      }
      html += `<div>â†’ ${v.reason}</div>`;
      if(v.bandText) html += `<div class="fd-band">ğŸ”„ æ³¢æ®µå»ºè®®ï¼š${v.bandText}</div>`;
      if(v.finalNote) html += `<div class="fd-final">${v.finalNote}</div>`;
      html += `</div></div>`;
    });
    if(hC) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-eng-hold-${eng.id}')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${a.holdingViews.length-3}åª</div></div>`;
  }
  
  if(a.watchViews && a.watchViews.length>0){
    const wC = a.watchViews.length > 3;
    html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin:12px 0 6px">â­ è‡ªé€‰åŸºé‡‘åˆ†æ (${a.watchViews.length}åª)ï¼š</div>`;
    if(wC) html += `<div class="collapse-list" id="cl-eng-watch-${eng.id}">`;
    a.watchViews.forEach(v=>{
      const actLabel = v.action==='buy'?'å…³æ³¨ä¹°å…¥':v.action==='sell'?'è§‚æœ›':'ä¸­æ€§';
      const yrC = v.yearReturn>=0?'var(--up)':'var(--down)';
      html += `<div class="${wC?'cl-item':''}"><div class="ai-fund-row"><span class="f-name">${v.name}</span><span style="color:${v.pct>=0?'var(--up)':'var(--down)'};font-size:11px">${sign(v.pct)}${fmt(v.pct)}%</span><span class="f-action ${v.action}">${actLabel}</span></div>`;
      html += `<div class="ai-fund-detail">`;
      if(v.yearReturn!==undefined){
        html += `<div class="fd-year"><span class="fd-tag">ğŸ“…è¿‘1å¹´ï¼š<b style="color:${yrC}">${sign(v.yearReturn)}${fmt(v.yearReturn)}%</b></span><span class="fd-tag">ğŸ“‰å›æ’¤ï¼š<b>-${fmt(v.maxDD)}%</b></span><span class="fd-tag">ğŸ“Šæ³¢åŠ¨ï¼š<b>${fmt(v.vol)}%</b></span><span class="fd-tag">ğŸ“ä½ç½®ï¼š<b>${Math.round(v.pos*100)}%</b>åˆ†ä½</span></div>`;
      }
      html += `<div>â†’ ${v.reason}</div>`;
      if(v.bandText) html += `<div class="fd-band">ğŸ”„ æ³¢æ®µå»ºè®®ï¼š${v.bandText}</div>`;
      if(v.finalNote) html += `<div class="fd-final">${v.finalNote}</div>`;
      html += `</div></div>`;
    });
    if(wC) html += `<div class="cl-toggle" onclick="toggleCollapse('cl-eng-watch-${eng.id}')"><span class="cl-arrow">â–¼</span> å±•å¼€å‰©ä½™${a.watchViews.length-3}åª</div></div>`;
  }
  return html;
}

function switchAILiveTab(tab){
  _aiActiveTab = tab;
  renderFeed();
}

async function refreshAnalysis(){
  if(_aiAnalyzing) return;
  if(_302aiKey){
    _aiAnalyzing = true;
    try {
      analysisData = await generateRealAIAnalysis((msg)=>{
        const st = document.getElementById('bottom-status');
        if(st) st.textContent = msg;
      });
    } catch(e){
      console.error('Real AI all failed:', e);
      // Don't fall back to simulated â€” show error
      analysisData = null;
      alert('AIåˆ†æè°ƒç”¨å¤±è´¥ï¼š' + e.message + 'ï¼Œè¯·æ£€æŸ¥API Keyå’Œç½‘ç»œ');
    }
    _aiAnalyzing = false;
  } else {
    analysisData = generateAIAnalysis_simulated();
  }
  renderFeed();
}

// ==================== RENDER ANALYSIS PANEL (in message feed) ====================
function renderAnalysisPanel(data){
  if(!data) return '';
  let html = `<div class="analysis-panel">
    <div class="analysis-header">
      <h3>ğŸ§  å¤šAIç»¼åˆåˆ†ææŠ¥å‘Š</h3>
      <p>${todayStr()} 14:30 Â· åŸºäºå®æ—¶è¡Œæƒ… + æ¿å—åŠ¨æ€ + æ–°é—»é¢</p>
    </div>
    <div class="ai-tabs" id="ai-tabs">`;
  
  const panelEngines = AI_ENGINES.filter(eng=>data[eng.id]);
  panelEngines.forEach((eng,i)=>{
    html += `<div class="ai-tab ${i===0?'active':''}" onclick="switchAITab('${eng.id}')" data-tab="${eng.id}"><span class="tab-icon">${eng.icon}</span>${eng.name}</div>`;
  });
  html += `<div class="ai-tab" onclick="switchAITab('synthesis')" data-tab="synthesis"><span class="tab-icon">ğŸ¯</span>ç»¼åˆ</div>`;
  html += `</div><div class="ai-content">`;
  
  // Individual AI views (only available engines)
  panelEngines.forEach((eng,i)=>{
    const a = data[eng.id];
    if(!a) return;
    const vClass = a.verdict==='bull'?'bull':a.verdict==='bear'?'bear':'neutral';
    const vIcon = a.verdict==='bull'?'ğŸ“ˆ':a.verdict==='bear'?'ğŸ“‰':'âš–ï¸';
    
    html += `<div class="ai-view ${i===0?'active':''}" id="ai-view-${eng.id}">
      <div class="ai-verdict ${vClass}"><span class="ai-verdict-icon">${vIcon}</span><div><strong>${eng.name}ç ”åˆ¤ï¼š${a.verdictText}</strong><br><span style="font-size:10px;color:var(--sub)">${eng.style}</span></div></div>
      <div class="ai-detail"><p>${a.summary}</p></div>`;
    
    if(a.holdingViews && a.holdingViews.length>0){
      html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin:10px 0 6px">æŒä»“å»ºè®®ï¼š</div>`;
      a.holdingViews.forEach(v=>{
        const actLabel = v.action==='buy'?'ä¹°å…¥':v.action==='sell'?'å–å‡º':'æŒæœ‰';
        const yrC = (v.yearReturn||0)>=0?'var(--up)':'var(--down)';
        html += `<div class="ai-fund-row"><span class="f-name">${v.name}</span><span style="color:${v.pct>=0?'var(--up)':'var(--down)'}; font-size:11px">${sign(v.pct)}${fmt(v.pct)}%</span><span class="f-action ${v.action}">${actLabel}</span></div>`;
        html += `<div class="ai-fund-detail">`;
        if(v.yearReturn!==undefined){
          html += `<div class="fd-year"><span class="fd-tag">ğŸ“…è¿‘1å¹´ï¼š<b style="color:${yrC}">${sign(v.yearReturn)}${fmt(v.yearReturn)}%</b></span><span class="fd-tag">ğŸ“‰å›æ’¤ï¼š<b>-${fmt(v.maxDD)}%</b></span><span class="fd-tag">ğŸ“ä½ç½®ï¼š<b>${Math.round(v.pos*100)}%</b>åˆ†ä½</span></div>`;
        }
        html += `<div>â†’ ${v.reason}</div>`;
        if(v.bandText) html += `<div class="fd-band">ğŸ”„ æ³¢æ®µå»ºè®®ï¼š${v.bandText}</div>`;
        if(v.finalNote) html += `<div class="fd-final">${v.finalNote}</div>`;
        html += `</div>`;
      });
    }
    html += `</div>`;
  });
  
  // Synthesis view
  const verdicts = panelEngines.map(e=>data[e.id]?.verdict);
  const bullCount = verdicts.filter(v=>v==='bull').length;
  const bearCount = verdicts.filter(v=>v==='bear').length;
  const synthVerdict = bullCount>bearCount?'bull':bearCount>bullCount?'bear':'neutral';
  const synthText = bullCount>bearCount?'å¤šæ•°AIçœ‹å¤š':bearCount>bullCount?'å¤šæ•°AIçœ‹ç©º':'è§‚ç‚¹åˆ†æ­§';
  const synthIcon = bullCount>bearCount?'ğŸ“ˆ':bearCount>bullCount?'ğŸ“‰':'âš–ï¸';
  
  html += `<div class="ai-view" id="ai-view-synthesis">
    <div class="ai-verdict ${synthVerdict}"><span class="ai-verdict-icon">${synthIcon}</span><div><strong>ç»¼åˆç ”åˆ¤ï¼š${synthText}</strong><br><span style="font-size:10px">çœ‹å¤š${bullCount}å®¶ Â· çœ‹ç©º${bearCount}å®¶ Â· ä¸­æ€§${panelEngines.length-bullCount-bearCount}å®¶</span></div></div>
    <div class="ai-detail">`;
  
  panelEngines.forEach(eng=>{
    const a = data[eng.id];
    if(!a) return;
    html += `<p>${eng.icon} <strong>${eng.name}</strong>ï¼ˆ${a.verdictText}ï¼‰ï¼š${a.summary.slice(0,60)}...</p>`;
  });
  
  html += `</div></div></div></div>`;
  return html;
}

function switchAITab(tab){
  document.querySelectorAll('.ai-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.ai-view').forEach(v=>v.classList.remove('active'));
  const view = document.getElementById(`ai-view-${tab}`);
  if(view) view.classList.add('active');
}

// ==================== RENDER RECOMMENDATION PANEL ====================
function renderRecoPanel(recos){
  if(!recos || recos.length===0) return '';
  let html = `<div class="reco-panel">
    <div class="reco-header"><h3>ğŸ¯ æ“ä½œå»ºè®® (14:35)</h3><p>åŸºäº${AI_ENGINES.filter(e=>analysisData?.[e.id]).map(e=>e.name).join('Â·')||"å¤šAIå¼•æ“"}ç»¼åˆç ”åˆ¤</p></div>
    <div class="reco-body">`;
  
  recos.forEach(r=>{
    const icon = r.action==='buy'?'ğŸ”´':r.action==='sell'?'ğŸŸ¢':'â¸ï¸';
    const actText = r.action==='buy'?'å»ºè®®ä¹°å…¥':r.action==='sell'?'å»ºè®®å–å‡º':'å»ºè®®æŒæœ‰';
    html += `<div class="reco-item ${r.action}">
      <div class="reco-icon">${icon}</div>
      <div class="reco-info">
        <div class="r-action ${r.action}">${actText} Â· ${r.confidence}å…±è¯†</div>
        <div class="r-name">${r.name} (${r.code}) Â· ä»Šæ—¥ <span style="color:${r.todayPct>=0?'var(--up)':'var(--down)'}"> ${sign(r.todayPct)}${fmt(r.todayPct)}%</span></div>
        <div class="r-reason">${r.reason}</div>
        <div class="r-consensus">${r.consensus}</div>
      </div>
    </div>`;
  });
  
  // Summary
  const buyRecs = recos.filter(r=>r.action==='buy');
  const sellRecs = recos.filter(r=>r.action==='sell');
  const holdRecs = recos.filter(r=>r.action==='hold');
  html += `<div class="reco-summary">
    ğŸ“‹ <strong>ä»Šæ—¥æ“ä½œæ‘˜è¦ï¼š</strong><br>
    ${buyRecs.length>0?`ğŸ”´ å»ºè®®ä¹°å…¥ ${buyRecs.length} åªï¼š${buyRecs.map(r=>r.name.slice(0,6)).join('ã€')}<br>`:''}
    ${sellRecs.length>0?`ğŸŸ¢ å»ºè®®å–å‡º ${sellRecs.length} åªï¼š${sellRecs.map(r=>r.name.slice(0,6)).join('ã€')}<br>`:''}
    ${holdRecs.length>0?`â¸ï¸ å»ºè®®æŒæœ‰ ${holdRecs.length} åªï¼š${holdRecs.map(r=>r.name.slice(0,6)).join('ã€')}<br>`:''}
    âš ï¸ ä»¥ä¸Šå»ºè®®ä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆè‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›å†³ç­–ã€‚
  </div>`;
  
  html += `</div></div>`;
  return html;
}

// ==================== SCHEDULED TASKS ====================
function checkScheduledTasks(){
  if(!isTrading() && getMarketPhase()!=='afternoon') return;
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const today = todayStr();
  
  // 14:30 - Multi AI Analysis
  if(h===14 && m>=28 && m<=32 && lastAnalysisDate!==today && holdings.length>0){
    runAnalysis();
  }
  
  // 14:35 - Recommendations
  if(h===14 && m>=33 && m<=37 && lastRecoDate!==today && analysisData && holdings.length>0){
    runRecommendations();
  }
}

async function runAnalysis(){
  const today = todayStr();
  if(lastAnalysisDate===today) return;
  
  addMessage({icon:'ğŸ§ ',avatar:'ai',from:'AIåˆ†æå¼•æ“',body:`<div class="spinner"></div> æ­£åœ¨å¯åŠ¨å¤šAIåˆ†æå¼•æ“...<div class="progress-bar"><div class="progress-fill" style="width:10%"></div></div>`});
  
  const useRealAI = !!_302aiKey;
  
  if(useRealAI){
    // Real AI with progress callback
    try {
      analysisData = await generateRealAIAnalysis((progress)=>{
        messages[messages.length-1].body = `<div class="spinner"></div> ${progress}<div class="progress-bar"><div class="progress-fill" style="width:${Math.min(90, 20 + Math.random()*60)}%"></div></div>`;
        renderFeed();
      });
    } catch(e){
      console.error('Real AI failed in runAnalysis:', e);
      messages.pop();
      addMessage({icon:'âŒ',avatar:'ai',from:'AIåˆ†æå¼•æ“',body:`AIåˆ†æè°ƒç”¨å¤±è´¥ï¼š${e.message}ã€‚è¯·æ£€æŸ¥API Keyå’Œç½‘ç»œè¿æ¥ã€‚`});
      return;
    }
  } else {
    // Simulated progressive analysis with delays
    const steps = AI_ENGINES.map((eng,i)=>({
      text:`${eng.icon} ${eng.name}(${eng.style.slice(1)})åˆ†æä¸­...`,
      pct: Math.round(30 + i*20)
    }));
    for(const step of steps){
      await new Promise(r=>setTimeout(r,600));
      messages[messages.length-1].body = `<div class="spinner"></div> ${step.text}<div class="progress-bar"><div class="progress-fill" style="width:${step.pct}%"></div></div>`;
      renderFeed();
    }
    await new Promise(r=>setTimeout(r,500));
    analysisData = generateAIAnalysis_simulated();
  }
  
  // Remove loading message
  messages.pop();
  
  lastAnalysisDate = today;
  localStorage.setItem('fa_lastAnalysis', today);
  
  // Add analysis panel as a message
  addMessage({type:'analysis', data:analysisData});
  
  addMessage({icon:'âœ…',avatar:'ai',from:'AIåˆ†æå¼•æ“',body:`å¤šAIç»¼åˆåˆ†æå®Œæˆï¼å…±åˆ†æ <strong>${holdings.length}</strong> åªæŒä»“åŸºé‡‘ã€‚<br>14:35å°†ç»™å‡ºå…·ä½“æ“ä½œå»ºè®®ï¼Œè¯·ç¨å€™...`});
}

async function runRecommendations(){
  const today = todayStr();
  if(lastRecoDate===today || !analysisData) return;
  
  addMessage({icon:'ğŸ¯',avatar:'ai',from:'æ“ä½œå»ºè®®',body:`<div class="spinner"></div> æ­£åœ¨ç»¼åˆå››å¤§AIå¼•æ“ç»“è®ºï¼Œç”Ÿæˆæ“ä½œå»ºè®®...`});
  
  await new Promise(r=>setTimeout(r,1500));
  messages.pop();
  
  recoData = synthesizeRecommendations(analysisData);
  lastRecoDate = today;
  localStorage.setItem('fa_lastReco', today);
  
  addMessage({type:'reco', data:recoData});
}

function triggerAnalysisNow(){
  if(holdings.length===0){
    alert('è¯·å…ˆæ·»åŠ æŒä»“åŸºé‡‘');
    return;
  }
  lastAnalysisDate = '';
  lastRecoDate = '';
  runAnalysis().then(()=>{
    setTimeout(()=>runRecommendations(), 3000);
  });
}

// ==================== WATCHLIST MODAL ====================
function openWatchModal(){
  document.getElementById('watch-modal').classList.add('show');
  switchWatchTab('search');
  renderWatchPickGrid();
  renderWatchManageList();
}

function closeWatchModal(){
  document.getElementById('watch-modal').classList.remove('show');
  renderFeed();
}

function switchWatchTab(tab){
  document.querySelectorAll('.wm-tab').forEach(t=>t.classList.toggle('active',t.dataset.wtab===tab));
  document.querySelectorAll('.wm-view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`wm-${tab}`).classList.add('active');
  if(tab==='pick') renderWatchPickGrid();
  if(tab==='manage') renderWatchManageList();
}

async function searchFund(){
  const code = document.getElementById('watch-code-input').value.trim();
  if(!code || code.length<4){ alert('è¯·è¾“å…¥è‡³å°‘4ä½åŸºé‡‘ä»£ç '); return; }
  const resultEl = document.getElementById('watch-search-result');
  resultEl.innerHTML = `<div class="wm-result"><div class="spinner"></div> æ­£åœ¨æœç´¢ ${code} ...</div>`;
  
  // Try fetching from TianTian Fund API
  try{
    const d = await fetchFundEstimate(code);
    if(d && d.name){
      const exists = watchlist.find(w=>w.code===code);
      const info = FUND_DB.find(f=>f.code===code);
      liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name, gztime:d.gztime||'' };
      resultEl.innerHTML = `<div class="wm-result">
        <div class="r-info"><div class="r-name">${d.name}</div><div class="r-code">${code} Â· å‡€å€¼ ${fmt(parseFloat(d.dwjz),4)} Â· ä¼°å€¼ <span style="color:${parseFloat(d.gszzl)>=0?'var(--up)':'var(--down)'}">${sign(parseFloat(d.gszzl))}${fmt(parseFloat(d.gszzl))}%</span></div></div>
        ${exists ? '<button class="added" disabled>å·²æ·»åŠ </button>' : `<button class="add" onclick="addToWatchFromSearch('${code}','${d.name.replace(/'/g,"\\'").slice(0,20)}','${info?info.type:''}')">+ è‡ªé€‰</button>`}
      </div>`;
    } else {
      resultEl.innerHTML = `<div class="wm-result" style="color:var(--sub)">æœªæ‰¾åˆ°åŸºé‡‘ ${code}ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®</div>`;
    }
  }catch(e){
    resultEl.innerHTML = `<div class="wm-result" style="color:var(--sub)">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç æˆ–ç½‘ç»œåé‡è¯• (${code})</div>`;
  }
}

function addToWatchFromSearch(code, name, type){
  if(watchlist.find(w=>w.code===code)) return;
  watchlist.push({code, name, type: type||'åŸºé‡‘'});
  saveWatchlist();
  // Refresh the search result to show "å·²æ·»åŠ "
  searchFund();
  renderWatchManageList();
  renderWatchPickGrid();
}

// Quick add from AI recommendations
function quickAddReco(code, name, type){
  if(watchlist.find(w=>w.code===code)) return;
  watchlist.push({code, name, type: type||'åŸºé‡‘'});
  saveWatchlist();
  fetchFundEstimate(code).catch(()=>{});
  renderFeed();
}
function quickAddHoldingReco(code, name){
  if(holdings.find(h=>h.code===code)) return;
  holdings.push({code, name, cost:10000});
  saveHoldings();
  fetchFundEstimate(code).catch(()=>{});
  renderFeed();
}

function renderWatchPickGrid(){
  const grid = document.getElementById('wm-pick-grid');
  if(!grid) return;
  grid.innerHTML = FUND_DB.map(f=>{
    const selected = watchlist.find(w=>w.code===f.code);
    return `<div class="wm-pick ${selected?'selected':''}" onclick="toggleWatchPick('${f.code}')">
      <div class="p-name">${f.name.slice(0,8)}</div>
      <div class="p-type">${f.code} Â· ${f.type}</div>
    </div>`;
  }).join('');
}

function toggleWatchPick(code){
  const idx = watchlist.findIndex(w=>w.code===code);
  if(idx>=0){
    watchlist.splice(idx,1);
  } else {
    const info = FUND_DB.find(f=>f.code===code);
    if(info) watchlist.push({code, name:info.name, type:info.type});
  }
  saveWatchlist();
  renderWatchPickGrid();
  renderWatchManageList();
}

function renderWatchManageList(){
  const list = document.getElementById('wm-manage-list');
  if(!list) return;
  if(watchlist.length===0){
    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--sub);font-size:13px">æš‚æ— è‡ªé€‰åŸºé‡‘<br>é€šè¿‡æœç´¢æˆ–å¿«é€Ÿé€‰æ‹©æ·»åŠ </div>';
    return;
  }
  list.innerHTML = `<div style="font-size:11px;color:var(--sub);margin-bottom:8px">å…± ${watchlist.length} åªè‡ªé€‰åŸºé‡‘ï¼Œå·¦æ»‘æˆ–ç‚¹å‡»åˆ é™¤</div>` +
    watchlist.map(w=>{
      return `<div class="wm-result"><div class="r-info"><div class="r-name">${w.name}</div><div class="r-code">${w.code} Â· ${w.type||'åŸºé‡‘'}</div></div><button class="del" onclick="removeFromWatch('${w.code}')">åˆ é™¤</button></div>`;
    }).join('');
}

function removeFromWatch(code){
  watchlist = watchlist.filter(w=>w.code!==code);
  saveWatchlist();
  renderWatchManageList();
  renderWatchPickGrid();
}

// ==================== HOLDINGS MODAL ====================
let _pendingHoldingCode = '';
let _pendingHoldingName = '';

function openHoldingsModal(){
  const overlay = document.getElementById('modal-overlay');
  overlay.classList.add('show');
  _pendingHoldingCode = '';
  _pendingHoldingName = '';
  
  // Reset add form
  document.getElementById('holding-code-input').value = '';
  document.getElementById('holding-search-result').innerHTML = '';
  document.getElementById('holding-cost-row').style.display = 'none';
  document.getElementById('btn-add-holding').style.display = 'none';
  document.getElementById('cost-input').value = '';
  
  // Bind search button
  const searchBtn = document.getElementById('btn-search-holding');
  const newSearchBtn = searchBtn.cloneNode(true);
  searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn);
  newSearchBtn.addEventListener('click', function(e){ e.stopPropagation(); searchHoldingFund(); });
  
  // Bind add button
  const addBtn = document.getElementById('btn-add-holding');
  const newAddBtn = addBtn.cloneNode(true);
  addBtn.parentNode.replaceChild(newAddBtn, addBtn);
  newAddBtn.addEventListener('click', function(e){ e.stopPropagation(); addHolding(); });
  
  // Allow Enter key to trigger search
  const codeInput = document.getElementById('holding-code-input');
  codeInput.onkeydown = function(e){ if(e.key==='Enter') searchHoldingFund(); };
  
  // Render existing holdings list
  const list = document.getElementById('holdings-list');
  if(holdings.length===0){
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--sub);font-size:13px">æš‚æ— æŒä»“ï¼Œè¯·æœç´¢åŸºé‡‘ä»£ç æ·»åŠ </div>';
  } else {
    list.innerHTML = holdings.map(h=>{
      const info = FUND_DB.find(x=>x.code===h.code);
      const liveInfo = liveFundData[h.code];
      const name = info ? info.name : (liveInfo ? liveInfo.name : h.code);
      const type = info ? info.type : 'åŸºé‡‘';
      return `<div class="h-manage"><div class="hm-info"><div class="hm-name">${name}</div><div class="hm-detail">${h.code} Â· ${type} Â· Â¥${fmt(h.cost,0)}</div></div><button type="button" class="hm-del" data-del-code="${h.code}">åˆ é™¤</button></div>`;
    }).join('');
    list.querySelectorAll('.hm-del[data-del-code]').forEach(btn=>{
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        removeHolding(this.getAttribute('data-del-code'));
      });
    });
  }
}

function closeModal(){
  document.getElementById('modal-overlay').classList.remove('show');
}

async function searchHoldingFund(){
  const code = document.getElementById('holding-code-input').value.trim();
  if(!code || code.length<4){ alert('è¯·è¾“å…¥è‡³å°‘4ä½åŸºé‡‘ä»£ç '); return; }
  const resultEl = document.getElementById('holding-search-result');
  resultEl.innerHTML = `<div style="padding:10px;font-size:12px;color:var(--sub)"><span class="spinner"></span> æ­£åœ¨æœç´¢ ${code} ...</div>`;
  document.getElementById('holding-cost-row').style.display = 'none';
  document.getElementById('btn-add-holding').style.display = 'none';
  _pendingHoldingCode = '';
  _pendingHoldingName = '';
  
  try{
    const d = await fetchFundEstimate(code);
    if(d && d.name){
      liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name, gztime:d.gztime||'' };
      const exists = holdings.find(h=>h.code===code);
      const pct = parseFloat(d.gszzl);
      const c = pct>=0?'var(--up)':'var(--down)';
      resultEl.innerHTML = `<div style="padding:10px;background:var(--bg);border-radius:10px;margin-bottom:8px">
        <div style="font-size:13px;font-weight:600">${d.name}</div>
        <div style="font-size:11px;color:var(--sub);margin-top:2px">${code} Â· å‡€å€¼ ${fmt(parseFloat(d.dwjz),4)} Â· ä¼°å€¼ <span style="color:${c}">${sign(pct)}${fmt(pct)}%</span></div>
        ${exists ? '<div style="font-size:12px;color:var(--primary);margin-top:6px;font-weight:500">âœ… å·²åœ¨æŒä»“ä¸­</div>' : ''}
      </div>`;
      if(!exists){
        _pendingHoldingCode = code;
        _pendingHoldingName = d.name;
        document.getElementById('holding-cost-row').style.display = 'block';
        document.getElementById('btn-add-holding').style.display = 'block';
        document.getElementById('cost-input').focus();
      }
    } else {
      resultEl.innerHTML = `<div style="padding:10px;font-size:12px;color:var(--sub)">æœªæ‰¾åˆ°åŸºé‡‘ ${code}ï¼Œè¯·æ£€æŸ¥ä»£ç </div>`;
    }
  }catch(e){
    resultEl.innerHTML = `<div style="padding:10px;font-size:12px;color:var(--sub)">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä»£ç </div>`;
  }
}

function addHolding(){
  const code = _pendingHoldingCode;
  const cost = parseFloat(document.getElementById('cost-input').value);
  if(!code){ alert('è¯·å…ˆæœç´¢åŸºé‡‘'); return; }
  if(!cost||cost<=0){ alert('è¯·è¾“å…¥æŒä»“é‡‘é¢'); return; }
  if(holdings.find(h=>h.code===code)){ alert('è¯¥åŸºé‡‘å·²åœ¨æŒä»“ä¸­'); return; }
  holdings.push({code, name: _pendingHoldingName||'', cost});
  saveHoldings();
  addMessage({icon:'âœ…',avatar:'good',from:'æŒä»“æ›´æ–°',body:`å·²æ·»åŠ  <strong>${_pendingHoldingName||code}</strong>ï¼ŒæŒä»“é‡‘é¢ Â¥${fmt(cost,0)}ã€‚`});
  openHoldingsModal();
  renderFeed();
}

function removeHolding(code){
  const info = FUND_DB.find(f=>f.code===code);
  const before = holdings.length;
  holdings = holdings.filter(h=>h.code!==code);
  if(holdings.length < before){
    saveHoldings();
    addMessage({icon:'ğŸ—‘ï¸',avatar:'sys',from:'æŒä»“æ›´æ–°',body:`å·²åˆ é™¤æŒä»“ <strong>${info?info.name:code}</strong>`});
  }
  openHoldingsModal();
  renderFeed();
}

// ==================== MAIN REFRESH LOOP ====================
async function refresh(){
  const isLive = isTrading() || getMarketPhase()==='lunch';
  
  await Promise.all([fetchIndices(), fetchSectors()]);
  // Fetch holdings + watchlist fund data
  const allCodes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  for(const code of allCodes){
    try{
      const d = await fetchFundEstimate(code);
      if(d?.gsz) liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name||'', gztime:d.gztime||'' };
    }catch(e){}
    await new Promise(r=>setTimeout(r,120));
  }
  
  renderTopIndices();
  
  // Update bottom status
  const phase = getMarketPhase();
  const statusEl = document.getElementById('bottom-status');
  if(isLive){
    const now = new Date();
    statusEl.innerHTML = `ğŸŸ¢ å®æ—¶ç›‘æ§ Â· ${timeStr(now)}æ›´æ–° Â· ${holdings.length}æŒä»“ Â· ${watchlist.length}è‡ªé€‰`;
  } else {
    statusEl.innerHTML = `ğŸ”µ ${phase==='closed'||phase==='pre'?'ç›˜å¤–æ¨¡å¼':'åˆé—´ä¼‘å¸‚'} Â· ${holdings.length}æŒä»“ Â· ${watchlist.length}è‡ªé€‰`;
  }
  
  // Show analyze button during trading or always
  document.getElementById('btn-analyze').style.display = holdings.length>0?'block':'none';
  
  renderFeed();
}

function startEngine(){
  // Clock update every second
  setInterval(updateClock, 1000);
  updateClock();
  
  // Refresh data
  refresh();
  setInterval(refresh, isTrading()?30000:120000);
  

  
  // Message generation during trading
  setInterval(()=>{
    if(isTrading()) generateMarketMessages();
  }, 50000);
  
  // Scheduled tasks check
  setInterval(checkScheduledTasks, 30000);
  
  // Initial welcome message
  const phase = getMarketPhase();
  if(isTrading()){
    addMessage({icon:'ğŸ‘‹',avatar:'sys',from:'å°åŠ©ç†',body:`æ—©ä¸Šå¥½ï¼Aè‚¡æ­£åœ¨äº¤æ˜“ä¸­ï¼Œæˆ‘å°†å®æ—¶ç›‘æ§æ‚¨çš„æŒä»“å¹¶æ¨é€è¡Œæƒ…æ¶ˆæ¯ã€‚<br>ğŸ“‹ <strong>14:30</strong> å°†è¿›è¡Œå¤šAIç»¼åˆåˆ†æ Â· <strong>14:35</strong> ç»™å‡ºæ“ä½œå»ºè®®`});
    if(holdings.length===0){
      addMessage({icon:'ğŸ“‹',avatar:'sys',from:'å°åŠ©ç†',body:`æ‚¨è¿˜æ²¡æœ‰æ·»åŠ æŒä»“åŸºé‡‘ï¼Œç‚¹å‡»å³ä¸‹è§’ <strong>ğŸ“‹ æŒä»“</strong> æŒ‰é’®æ·»åŠ ï¼Œæˆ‘æ‰èƒ½ä¸ºæ‚¨åˆ†æå“¦ï¼`});
    }
  } else if(phase==='pre'||phase==='soon'){
    addMessage({icon:'ğŸŒ…',avatar:'sys',from:'å°åŠ©ç†',body:`æ—©ä¸Šå¥½ï¼Aè‚¡å³å°†å¼€ç›˜ï¼Œæˆ‘å·²å°±ç»ªï¼Œå¼€ç›˜åå°†è‡ªåŠ¨å¼€å§‹æ¨é€è¡Œæƒ…æ¶ˆæ¯ã€‚`});
  } else {
    addMessage({icon:'ğŸŒ™',avatar:'sys',from:'å°åŠ©ç†',body:`å½“å‰ä¸ºéäº¤æ˜“æ—¶æ®µã€‚Aè‚¡äº¤æ˜“æ—¶é—´ä¸ºå·¥ä½œæ—¥ 9:30-15:00ã€‚<br>æˆ‘å°†åœ¨å¼€ç›˜æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œä¸ºæ‚¨å®æ—¶æ¨é€è¡Œæƒ…å’Œåˆ†æã€‚<br>${holdings.length>0?`å½“å‰æŒæœ‰ ${holdings.length} åªåŸºé‡‘ã€‚`:'ç‚¹å‡» ğŸ“‹ æŒä»“ æ·»åŠ åŸºé‡‘ã€‚'}<br><br>ğŸ’¡ <strong>æ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡»ã€ŒğŸ§  ç«‹å³åˆ†æã€éšæ—¶æŸ¥çœ‹AIç ”åˆ¤ã€‚</strong>`});
  }
  
  // If we have holdings and haven't done analysis today, and it's after 14:30
  if(holdings.length>0){
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();
    if(h>14 || (h===14&&m>=30)){
      if(lastAnalysisDate!==todayStr()){
        // Auto-trigger analysis
        setTimeout(()=>runAnalysis().then(()=>setTimeout(()=>runRecommendations(),3000)), 2000);
      }
    }
  }
}

// Default holdings if empty
if(holdings.length===0){
  holdings = [
    {code:'000216',cost:25000},
    {code:'012414',cost:25000},
    {code:'011852',cost:20000},
    {code:'004814',cost:20000},
    {code:'257070',cost:10000},
  ];
  saveHoldings();
}

startEngine();
</script>
</body>
</html>
