<view class="container">

  <!-- ====== Header ====== -->
  <view class="card header-card">
    <view class="row">
      <view class="header-left">
        <text class="header-title">ğŸ“Š åŸºé‡‘å†³ç­–åŠ©æ‰‹</text>
        <view class="header-meta">
          <view class="status-dot {{marketDot}}"></view>
          <text class="sub">{{marketStatus}}</text>
          <text class="sub" style="margin-left:12rpx;">{{currentTime}}</text>
        </view>
      </view>
      <text class="chip {{sourceLabel === 'è¿œç¨‹æ•°æ®' ? 'blue' : 'gray'}}">{{sourceLabel}}</text>
    </view>
  </view>

  <!-- ====== æŒ‡æ•°è¡Œæƒ… ====== -->
  <view class="idx-grid">
    <view class="idx-item" wx:for="{{indices}}" wx:key="code">
      <text class="idx-name">{{item.name}}</text>
      <text class="idx-price">{{item.price}}</text>
      <text class="idx-pct pct-{{item.pctClass}}">{{item.pctStr}}</text>
    </view>
    <view wx:if="{{indices.length === 0}}" class="idx-item" style="width:100%;">
      <text class="sub">è¡Œæƒ…åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- ====== å¤§å®—å•†å“å®æ—¶è¡Œæƒ… ====== -->
  <view class="card" wx:if="{{commodities.length > 0}}">
    <view class="card-header">
      <text class="title">ğŸ“¦ å¤§å®—å•†å“</text>
      <text class="sub">æœŸè´§ä¸»åŠ›åˆçº¦</text>
    </view>
    <view class="comm-grid">
      <view class="comm-item {{item.anomaly ? 'comm-anomaly' : ''}}" wx:for="{{commodities}}" wx:key="code">
        <view class="comm-icon-row">
          <text class="comm-icon">{{item.icon}}</text>
          <text class="comm-name">{{item.short}}</text>
        </view>
        <text class="comm-price">{{item.price}}</text>
        <text class="comm-pct pct-{{item.pctClass}}">{{item.pctStr}}</text>
        <text class="comm-anomaly-tag" wx:if="{{item.anomaly}}">å¼‚åŠ¨</text>
      </view>
    </view>
  </view>

  <!-- ====== å®æ—¶çƒ­ç‚¹å¼‚åŠ¨ ====== -->
  <view class="card" wx:if="{{hotBreaking.length > 0}}">
    <view class="card-header">
      <text class="title">ğŸ”¥ å®æ—¶çƒ­ç‚¹ Â· å¼‚åŠ¨</text>
      <text class="chip red">{{hotBreaking.length}}æ¡</text>
    </view>
    <view class="breaking-list">
      <view class="breaking-item {{item.isGeo ? 'geo' : 'comm'}}" wx:for="{{hotBreaking}}" wx:key="id">
        <view class="breaking-top">
          <text class="breaking-cat">{{item.isGeo ? 'ğŸŒåœ°ç¼˜' : 'ğŸ“¦å•†å“'}}</text>
          <text class="breaking-title">{{item.title}}</text>
          <text class="chip sm {{item.impactClass}}">{{item.impact >= 0 ? '+' : ''}}{{item.impact}}</text>
        </view>
        <text class="breaking-reason" wx:if="{{item.reason}}">{{item.reason}}</text>
        <view class="breaking-bottom" wx:if="{{item.sectorsPos || item.sectorsNeg}}">
          <text class="breaking-pos" wx:if="{{item.sectorsPos}}">â–² {{item.sectorsPos}}</text>
          <text class="breaking-neg" wx:if="{{item.sectorsNeg}}">â–¼ {{item.sectorsNeg}}</text>
        </view>
        <text class="breaking-advice">ğŸ’¡ {{item.advice}}</text>
      </view>
    </view>
  </view>

  <!-- ====== æŒä»“æ¦‚è§ˆ ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">ğŸ’¼ æŒä»“æ¦‚è§ˆ</text>
      <view class="row">
        <text class="total-pct pct-{{totalPctClass}}">{{totalPct}}</text>
        <text class="sub" style="margin-left:12rpx;">å‡å€¼</text>
      </view>
    </view>

    <view wx:if="{{holdings.length === 0 && !loading}}" class="empty-state">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="sub">æš‚æ— æŒä»“</text>
      <button class="btn sm" style="margin-top:20rpx;" bindtap="goHoldings">å»æ·»åŠ </button>
    </view>

    <view class="holdings-grid" wx:if="{{holdings.length > 0}}">
      <view class="holding-card" wx:for="{{holdings}}" wx:key="code">
        <view class="row">
          <text class="h-name">{{item.name}}</text>
          <text class="h-pct pct-{{item.pctClass}}">{{item.pctStr}}</text>
        </view>
        <view class="row" style="margin-top:6rpx;">
          <text class="sub">{{item.code}} Â· {{item.type}}</text>
          <text class="sub" wx:if="{{item.estimate}}">ä¼°å€¼ {{item.estimate}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ====== å®ç›˜è¡ŒåŠ¨æŒ‡å— ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">ğŸ¯ å®ç›˜è¡ŒåŠ¨æŒ‡å—</text>
      <text class="chip {{overview.score >= 60 ? 'up' : overview.score <= 40 ? 'down' : 'gray'}}">
        {{overview.label}} Â· {{overview.score}}åˆ†
      </text>
    </view>
    <view class="overview-bar">
      <view class="ob-item red"><text class="ob-num">{{overview.buy}}</text><text class="ob-label">åŠ ä»“</text></view>
      <view class="ob-item green"><text class="ob-num">{{overview.sell}}</text><text class="ob-label">å‡ä»“</text></view>
      <view class="ob-item gray"><text class="ob-num">{{overview.hold}}</text><text class="ob-label">æŒæœ‰</text></view>
    </view>

    <view class="divider"></view>

    <view wx:if="{{plans.length === 0 && !loading}}" class="sub" style="text-align:center;padding:20rpx 0;">
      æ·»åŠ æŒä»“åå¯çœ‹ç ”åˆ¤å»ºè®®
    </view>

    <!-- ===== æ¯åªåŸºé‡‘çš„ä¸°å¯Œåˆ†æå¡ç‰‡ ===== -->
    <view class="ag-card action-{{item.action}}" wx:for="{{plans}}" wx:key="code" data-idx="{{index}}" bindtap="togglePlan">

      <!-- é¡¶éƒ¨: åç§° + ä»£ç  + æ¶¨è·Œ + è¡ŒåŠ¨æ ‡ç­¾ -->
      <view class="ag-top">
        <view class="ag-top-left">
          <text class="ag-name">{{item.name}}</text>
          <view class="row" style="margin-top:4rpx;">
            <text class="sub">{{item.code}} Â· {{item.type}}</text>
            <text class="ag-today-pct pct-{{item.pctClass}}" wx:if="{{item.pctStr !== 'å¾…å¼€ç›˜'}}"> {{item.pctStr}}</text>
          </view>
        </view>
        <view class="ag-top-right">
          <text class="ag-priority">#{{item.priority}}</text>
          <text class="ag-urgency ag-urgency-{{item.urgencyClass}}">{{item.urgency}}</text>
          <text class="ag-action-badge action-{{item.action}}">{{item.actionLabel}}</text>
        </view>
      </view>

      <!-- æŠ•ç¥¨æ¡: å› å­æŠ•ç¥¨ + å…±è¯† + æ³¢æ®µå»ºè®® -->
      <view class="ag-vote-strip">
        <view class="ag-vote-chip" wx:for="{{item.factors}}" wx:for-item="f" wx:key="name"
              wx:if="{{index < 4}}">
          <text class="ag-vote-label">{{f.name}}</text>
          <text class="ag-vote-val vote-{{f.dir}}">{{f.val}}</text>
        </view>
        <text class="ag-consensus-chip consensus-{{item.consensus === 'å…±è¯†çœ‹å¤š' || item.consensus === 'åå¤š' ? 'buy' : item.consensus === 'å…±è¯†çœ‹ç©º' || item.consensus === 'åç©º' ? 'sell' : 'hold'}}">
          {{item.consensus}}
        </text>
        <text class="ag-swing-chip" wx:if="{{item.swingAdvice !== 'â€”'}}">{{item.swingAdvice}}</text>
      </view>

      <!-- è¶‹åŠ¿ + æ³¢æ®µ + MA + èµ„é‡‘æµ -->
      <view class="ag-trend-row" wx:if="{{item.hasTrend}}">
        <text class="ag-trend-tag" style="color:{{item.dirColor}}">{{item.dirIcon}} {{item.dirText}}</text>
        <text class="ag-trend-tag" style="color:{{item.swingColor}}">{{item.swingIcon}} {{item.swingText}}</text>
        <text class="ag-trend-tag ag-ma-{{item.maStatus === 'å¤šå¤´æ’åˆ—' ? 'bull' : item.maStatus === 'ç©ºå¤´æ’åˆ—' ? 'bear' : 'mix'}}">{{item.maStatus}}</text>
        <text class="ag-trend-tag ag-flow-{{item.sectorFlowDir}}" wx:if="{{item.sectorFlowText}}">ğŸ’°{{item.sectorFlowText}}</text>
      </view>

      <!-- å…³é”®æŒ‡æ ‡æ¡ -->
      <view class="ag-metrics" wx:if="{{item.hasTrend}}">
        <text class="ag-metric">RSI {{item.rsi}}</text>
        <text class="ag-metric">5æ—¥ {{item.chg5d}}</text>
        <text class="ag-metric">20æ—¥ {{item.chg20d}}</text>
        <text class="ag-metric" wx:if="{{item.showDrawdown}}">è·é«˜ç‚¹ {{item.drawdown}}</text>
        <text class="ag-metric" wx:if="{{item.showRebound}}">ä»ä½ç‚¹ +{{item.rebound}}</text>
        <text class="ag-metric">æ³¢åŠ¨ {{item.volatility}}</text>
      </view>

      <!-- é£é™©æ ‡ç­¾ -->
      <view class="ag-risk-row">
        <text class="ag-risk-badge risk-{{item.riskLevel === 'é«˜é£é™©' ? 'high' : item.riskLevel === 'ä¸­é£é™©' ? 'mid' : 'low'}}">
          âš ï¸ {{item.riskLevel}} Â· {{item.riskScore}}åˆ†
        </text>
        <text class="sub">ğŸ”¥ {{item.tag}} Â· {{item.temperature}}Â°</text>
        <text class="ag-crowding" wx:if="{{item.crowding}}">{{item.crowding}}</text>
      </view>

      <!-- ===== å±•å¼€è¯¦æƒ…: ç™½è¯ç ”åˆ¤ ===== -->
      <view class="ag-detail" wx:if="{{item.expanded}}">
        <view class="ag-detail-divider"></view>

        <!-- ä¸€å¥è¯è¯Šæ–­ -->
        <view class="ag-tldr">
          <text class="ag-tldr-icon">ğŸ’¡</text>
          <text class="ag-tldr-text">{{item.advisor.tldr}}</text>
        </view>

        <!-- å››ç»´ä½“æ£€ -->
        <view class="ag-checkup">
          <view class="ag-checkup-item">
            <text class="ag-ck-label">ä¼°å€¼</text>
            <text class="ag-ck-val" style="color:{{item.advisor.valuation.color}}">{{item.advisor.valuation.label}}</text>
          </view>
          <view class="ag-checkup-item">
            <text class="ag-ck-label">è¶‹åŠ¿</text>
            <text class="ag-ck-val" style="color:{{item.advisor.trendLabel.color}}">{{item.advisor.trendLabel.label}}</text>
          </view>
          <view class="ag-checkup-item">
            <text class="ag-ck-label">é£å‘</text>
            <text class="ag-ck-val">{{item.advisor.windDir}}</text>
          </view>
          <view class="ag-checkup-item">
            <text class="ag-ck-label">éšæ‚£</text>
            <text class="ag-ck-val" style="font-size:20rpx;">{{item.advisor.biggestRisk}}</text>
          </view>
        </view>

        <!-- åŸå§‹æ•°æ® -->
        <view class="ag-raw-data">
          <text class="ag-raw-item">ä»Šæ—¥ {{item.advisor.rawData.todayPct}}</text>
          <text class="ag-raw-item">20æ—¥ {{item.advisor.rawData.chg20d}}</text>
          <text class="ag-raw-item">å›æ’¤ {{item.advisor.rawData.drawdown}}</text>
          <text class="ag-raw-item">æ³¢åŠ¨ {{item.advisor.rawData.volatility}}</text>
          <text class="ag-raw-item">RSI {{item.advisor.rawData.rsi}}</text>
          <text class="ag-raw-item">çƒ­åº¦ {{item.advisor.rawData.heat}}</text>
        </view>

        <!-- è¡ŒåŠ¨æ–¹æ¡ˆ -->
        <view class="ag-action-plan">
          <view class="ag-plan-row">
            <text class="ag-plan-label">ğŸ“‹ æ“ä½œ</text>
            <text class="ag-plan-val">{{item.advisor.operation}}</text>
          </view>
          <view class="ag-plan-row">
            <text class="ag-plan-label">ğŸ¯ æˆ˜æœ¯</text>
            <text class="ag-plan-val">{{item.advisor.tactics}}</text>
          </view>
          <view class="ag-plan-row">
            <text class="ag-plan-label">ğŸ›¡ï¸ æ­¢æŸ</text>
            <text class="ag-plan-val">{{item.advisor.stopLoss}}</text>
          </view>
        </view>

        <!-- é›·è¾¾å›¾ (ç”¨ CSS bars ä»£æ›¿ SVG) -->
        <view class="ag-radar">
          <view class="ag-radar-item">
            <text class="ag-radar-label">ä¼°å€¼åŠ›</text>
            <view class="ag-radar-bar"><view class="ag-radar-fill" style="width:{{item.advisor.radar.valuation}}%;"></view></view>
            <text class="ag-radar-num">{{item.advisor.radar.valuation}}</text>
          </view>
          <view class="ag-radar-item">
            <text class="ag-radar-label">çˆ†å‘åŠ›</text>
            <view class="ag-radar-bar"><view class="ag-radar-fill" style="width:{{item.advisor.radar.momentum}}%;"></view></view>
            <text class="ag-radar-num">{{item.advisor.radar.momentum}}</text>
          </view>
          <view class="ag-radar-item">
            <text class="ag-radar-label">é¡ºé£åº¦</text>
            <view class="ag-radar-bar"><view class="ag-radar-fill" style="width:{{item.advisor.radar.macro}}%;"></view></view>
            <text class="ag-radar-num">{{item.advisor.radar.macro}}</text>
          </view>
          <view class="ag-radar-item">
            <text class="ag-radar-label">é˜²å¾¡åŠ›</text>
            <view class="ag-radar-bar"><view class="ag-radar-fill" style="width:{{item.advisor.radar.defense}}%;"></view></view>
            <text class="ag-radar-num">{{item.advisor.radar.defense}}</text>
          </view>
          <view class="ag-radar-item">
            <text class="ag-radar-label">æƒ…ç»ªåº¦</text>
            <view class="ag-radar-bar"><view class="ag-radar-fill" style="width:{{item.advisor.radar.sentiment}}%;"></view></view>
            <text class="ag-radar-num">{{item.advisor.radar.sentiment}}</text>
          </view>
        </view>

        <text class="ag-expand-hint">â–² æ”¶èµ·è¯¦æƒ…</text>
      </view>

      <!-- æœªå±•å¼€æ—¶çš„å±•å¼€æç¤º -->
      <text class="ag-expand-hint" wx:if="{{!item.expanded}}">â–¼ å±•å¼€è¯¦ç»†åˆ†æ</text>
    </view>
  </view>

  <!-- ====== æ¨¡å‹ç»„åˆ ====== -->
  <view class="card">
    <view class="card-header" bindtap="toggleModel">
      <text class="title">ğŸ“ æ³¢æ®µç»„åˆ</text>
      <text class="sub">{{showModel ? 'æ”¶èµ· â–²' : 'å±•å¼€ â–¼'}}</text>
    </view>
    <view wx:if="{{showModel}}">
      <view class="model-section">
        <text class="model-section-title">æ ¸å¿ƒä»“ 60%</text>
        <view class="model-fund" wx:for="{{modelCore}}" wx:key="code">
          <view class="row">
            <text class="model-name">{{item.name}}</text>
            <text class="model-weight">{{item.weight}}%</text>
          </view>
          <text class="sub">{{item.code}} Â· {{item.type}}</text>
        </view>
      </view>
      <view class="divider"></view>
      <view class="model-section">
        <text class="model-section-title">å«æ˜Ÿä»“ 40%</text>
        <view class="model-fund" wx:for="{{modelSat}}" wx:key="code">
          <view class="row">
            <text class="model-name">{{item.name}}</text>
            <text class="model-weight">{{item.weight}}%</text>
          </view>
          <text class="sub">{{item.code}} Â· {{item.type}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ====== æ¿å—çƒ­åŠ› ====== -->
  <view class="card" wx:if="{{heatmap.length > 0}}">
    <view class="card-header">
      <text class="title">ğŸŒ¡ï¸ æ¿å—çƒ­åŠ›</text>
    </view>
    <view class="heat-grid">
      <view class="heat-chip" wx:for="{{heatmap}}" wx:key="tag"
            style="background:rgba({{item.temperature > 70 ? '239,68,68' : item.temperature > 50 ? '251,146,60' : '34,197,94'}}, {{item.temperature / 200}});">
        <text class="heat-tag">{{item.tag}}</text>
        <text class="heat-val">{{item.temperature}}Â°</text>
      </view>
    </view>
  </view>

  <!-- ====== çƒ­ç‚¹äº‹ä»¶ ====== -->
  <view class="card" wx:if="{{topEvents.length > 0}}">
    <view class="card-header">
      <text class="title">ğŸ“° çƒ­ç‚¹äº‹ä»¶</text>
      <text class="sub" bindtap="goSentiment">æ›´å¤š â€º</text>
    </view>
    <view class="event-item" wx:for="{{topEvents}}" wx:key="id">
      <view class="row">
        <text class="e-title">{{item.title}}</text>
        <text class="chip {{item.impactClass}}">{{item.impact >= 0 ? '+' : ''}}{{item.impact}}</text>
      </view>
      <text class="sub" style="margin-top:6rpx;">{{item.advice}}</text>
    </view>
  </view>

  <!-- ====== AI æ™ºèƒ½åˆ†æ ====== -->
  <view class="card">
    <view class="card-header sec-toggle" bindtap="toggleAI">
      <text class="title">ğŸ¤– AI æ™ºèƒ½åˆ†æ</text>
      <text class="toggle-arrow">{{showAI ? 'â–²' : 'â–¼'}}</text>
    </view>
    <view wx:if="{{!showAI}}" class="ai-summary-hint">
      <text class="sub">{{aiResult ? 'âœ… å·²æœ‰åˆ†æç»“æœï¼ˆ' + aiTime + 'ï¼‰' : 'ç‚¹å‡»å±•å¼€è¿è¡Œ AI åˆ†æ'}}</text>
    </view>
    <view wx:if="{{showAI}}">
      <view class="ai-action-bar">
        <button class="btn {{aiLoading ? 'disabled' : ''}}" size="mini" bindtap="triggerAI" disabled="{{aiLoading}}">
          {{aiLoading ? 'âš™ï¸ åˆ†æä¸­...' : 'ğŸš€ è¿è¡Œ AI åˆ†æ'}}
        </button>
        <text class="sub" wx:if="{{aiTime}}">{{aiTime}}</text>
      </view>

      <view wx:if="{{!aiHasKey && !aiResult}}" class="ai-no-key">
        <text class="sub">âš ï¸ æœªé…ç½® API Keyï¼Œè¯·åœ¨ã€Œè®¾ç½®ã€é¡µå¡«å†™</text>
      </view>

      <view wx:if="{{aiResult}}" class="ai-result">
        <!-- å¸‚åœºæ€»è§ˆ -->
        <view class="ai-market-bar">
          <text class="ai-market-text">{{aiResult.marketSummary}}</text>
          <text class="ai-risk-tag ai-risk-{{aiResult.riskClass}}">{{aiResult.riskLevel}}</text>
        </view>

        <!-- ä¿¡å·åˆ—è¡¨ -->
        <view class="ai-signal" wx:for="{{aiResult.signals}}" wx:key="code">
          <view class="ai-sig-top">
            <view class="ai-sig-left">
              <text class="ai-sig-name">{{item.name}}</text>
              <text class="sub">{{item.code}}</text>
            </view>
            <view class="ai-sig-badge ai-sig-{{item.actionClass}}">
              <text>{{item.actionLabel}}</text>
            </view>
          </view>
          <view class="ai-sig-bottom">
            <text class="ai-sig-reason">{{item.reason}}</text>
            <view class="ai-sig-meta">
              <text class="sub">ç½®ä¿¡åº¦ {{item.confidenceStr}}</text>
              <text class="sub" wx:if="{{item.urgency}}">Â· {{item.urgency}}ç´§æ€¥</text>
            </view>
          </view>
        </view>

        <!-- æ€»ä½“å»ºè®® -->
        <view wx:if="{{aiResult.overallAdvice}}" class="ai-overall">
          <text class="ai-overall-label">ğŸ“ æ€»ä½“å»ºè®®</text>
          <text class="ai-overall-text">{{aiResult.overallAdvice}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ====== æ›´æ–°æ—¶é—´ ====== -->
  <view class="footer-info">
    <text class="sub">æ•°æ®æ›´æ–°ï¼š{{updatedAt}}</text>
  </view>

</view>
