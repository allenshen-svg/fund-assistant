<view class="container">

  <!-- ====== å½“å‰æŒä»“ ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">ğŸ’¼ å½“å‰æŒä»“</text>
      <text class="sub">å…± {{list.length}} åª</text>
    </view>

    <view wx:if="{{list.length === 0 && !loading}}" class="empty-state">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="sub">æš‚æ— æŒä»“ï¼Œè¯·æ·»åŠ åŸºé‡‘</text>
    </view>

    <view class="h-item" wx:for="{{list}}" wx:key="code">
      <view class="h-main">
        <view class="h-left">
          <text class="h-name">{{item.name}}</text>
          <text class="sub">{{item.code}} Â· {{item.type}}</text>
        </view>
        <view class="h-right">
          <text class="h-pct pct-{{item.pctClass}}">{{item.pctStr}}</text>
          <text class="sub" wx:if="{{item.estimate}}">ä¼°å€¼ {{item.estimate}}</text>
        </view>
      </view>
      <view class="h-actions">
        <text class="del-btn" data-code="{{item.code}}" data-name="{{item.name}}" bindtap="removeHolding">åˆ é™¤</text>
      </view>
    </view>
  </view>

  <!-- ====== æ³¢æ®µç»„åˆï¼ˆæŒä»“åŸºé‡‘ï¼‰ ====== -->
  <view class="card">
    <view class="card-header sec-toggle" data-key="secSwing" bindtap="toggleSection">
      <text class="title">ğŸ“Š æ³¢æ®µç»„åˆ</text>
      <text class="toggle-arrow">{{secSwing ? 'â–²' : 'â–¼'}}</text>
    </view>
    <view class="sec-sub-header" wx:if="{{!secSwing}}">
      <text class="sub">åŸºäºæŒä»“åŸºé‡‘çš„æ³¢æ®µä¿¡å·åˆ†æ</text>
    </view>
    <view wx:if="{{secSwing}}">
      <view wx:if="{{swingLoading}}" class="loading-tip">
        <text>åŠ è½½è¶‹åŠ¿æ•°æ®ä¸­...</text>
      </view>
      <view wx:elif="{{swingItems.length === 0}}" class="empty-state">
        <text class="sub">æš‚æ— æŒä»“</text>
      </view>
      <view wx:else>
        <view class="swing-card swing-{{item.swingClass}}" wx:for="{{swingItems}}" wx:key="code">
          <view class="swing-top">
            <view class="swing-left">
              <text class="swing-name">{{item.name}}</text>
              <text class="sub">{{item.code}} Â· {{item.type}}</text>
            </view>
            <view class="swing-badge swing-badge-{{item.swingClass}}">
              <text>{{item.swingSignal}}</text>
            </view>
          </view>
          <view wx:if="{{item.hasTrend}}" class="swing-detail">
            <view class="swing-grid">
              <view class="sg-item">
                <text class="sg-label">5æ—¥æ¶¨å¹…</text>
                <text class="sg-val {{item.chg5dClass}}">{{item.chg5d}}</text>
              </view>
              <view class="sg-item">
                <text class="sg-label">20æ—¥æ¶¨å¹…</text>
                <text class="sg-val {{item.chg20dClass}}">{{item.chg20d}}</text>
              </view>
              <view class="sg-item">
                <text class="sg-label">RSI</text>
                <text class="sg-val">{{item.rsi}}</text>
              </view>
              <view class="sg-item">
                <text class="sg-label">å›æ’¤</text>
                <text class="sg-val pct-down">{{item.drawdown}}</text>
              </view>
              <view class="sg-item">
                <text class="sg-label">åå¼¹</text>
                <text class="sg-val pct-up">{{item.rebound}}</text>
              </view>
              <view class="sg-item">
                <text class="sg-label">å‡çº¿</text>
                <text class="sg-val">{{item.maStatus}}</text>
              </view>
            </view>
            <view wx:if="{{item.swingAdvice}}" class="swing-advice">
              <text class="sub">ğŸ’¡ {{item.swingAdvice}}</text>
            </view>
          </view>
          <view wx:else class="swing-nodata">
            <text class="sub">æ•°æ®ä¸è¶³ï¼Œæ— æ³•åˆ†æ</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ====== é¢„æµ‹è¿½è¸ª ====== -->
  <view class="card">
    <view class="card-header sec-toggle" data-key="secPred" bindtap="toggleSection">
      <text class="title">ğŸ¯ é¢„æµ‹è¿½è¸ª</text>
      <text class="toggle-arrow">{{secPred ? 'â–²' : 'â–¼'}}</text>
    </view>
    <view class="sec-sub-header" wx:if="{{!secPred}}">
      <text class="sub">è¿½è¸ªæ¯æ—¥æŠ•èµ„å»ºè®®çš„å‡†ç¡®ç‡</text>
    </view>
    <view wx:if="{{secPred}}">
      <!-- æ“ä½œæŒ‰é’® -->
      <view class="pred-actions">
        <button class="btn small" bindtap="snapshotPrediction" disabled="{{predTodayDone}}">
          ğŸ“¸ {{predTodayDone ? 'ä»Šæ—¥å·²å¿«ç…§' : 'ç«‹å³å¿«ç…§'}}
        </button>
        <button class="btn small ghost" bindtap="manualVerify">âœ… æ‰‹åŠ¨éªŒè¯</button>
      </view>

      <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
      <view wx:if="{{predStats && predStats.totalDays > 0}}" class="pred-stats-card">
        <view class="pred-stats-row">
          <view class="ps-item">
            <text class="ps-val big">{{predStats.totalDays}}</text>
            <text class="ps-label">è¿½è¸ªå¤©æ•°</text>
          </view>
          <view class="ps-item">
            <text class="ps-val big pct-up">{{predStats.accuracy > 0 ? predStats.accuracy.toFixed(0) + '%' : '--'}}</text>
            <text class="ps-label">æ€»å‡†ç¡®ç‡</text>
          </view>
          <view class="ps-item">
            <text class="ps-val">{{predStats.correctCount}}</text>
            <text class="ps-label">âœ… æ­£ç¡®</text>
          </view>
          <view class="ps-item">
            <text class="ps-val">{{predStats.wrongCount}}</text>
            <text class="ps-label">âŒ é”™è¯¯</text>
          </view>
        </view>
        <!-- å‡†ç¡®ç‡è¿›åº¦æ¡ -->
        <view class="pred-bar-wrap">
          <view class="pred-bar">
            <view class="pred-bar-fill" style="width: {{predStats.accuracy}}%;"></view>
          </view>
          <text class="sub" style="margin-top:4rpx;">å‡†ç¡®ç‡ {{predStats.accuracy.toFixed(1)}}%</text>
        </view>
      </view>
      <view wx:elif="{{predStats && predStats.totalDays === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ¯</text>
        <text class="sub">æš‚æ— è¿½è¸ªæ•°æ®ï¼Œç‚¹å‡»"ç«‹å³å¿«ç…§"å¼€å§‹è¿½è¸ª</text>
      </view>

      <!-- æœ€è¿‘éªŒè¯è¯¦æƒ… -->
      <view wx:if="{{predLatest}}" class="pred-latest">
        <view class="pred-latest-header">
          <text class="title">ğŸ“‹ æœ€è¿‘éªŒè¯ ({{predLatest.date}})</text>
          <text class="pred-acc-badge {{predLatest.accuracyClass}}">{{predLatest.accuracy}}</text>
        </view>
        <view class="pred-result-item" wx:for="{{predLatest.results}}" wx:key="name">
          <view class="pr-left">
            <text class="pr-icon">{{item.verdictIcon}}</text>
            <text class="pr-name">{{item.name}}</text>
          </view>
          <view class="pr-right">
            <text class="pr-pred">å»ºè®®: {{item.predLabel}}</text>
            <text class="pr-actual {{item.nextPctClass}}">æ¬¡æ—¥: {{item.nextPct}}</text>
          </view>
        </view>
      </view>

      <!-- å†å²è®°å½• -->
      <view wx:if="{{predHistory.length > 0}}" class="pred-history">
        <text class="sub-title">ğŸ“… å†å²å¿«ç…§</text>
        <view class="ph-item" wx:for="{{predHistory}}" wx:key="date">
          <view class="ph-left">
            <text class="ph-date">{{item.date}}</text>
            <text class="sub">{{item.timestamp}} Â· {{item.overallLabel}}</text>
          </view>
          <view class="ph-right">
            <text class="ph-acc {{item.verified ? 'verified' : 'pending'}}">{{item.accuracyStr}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ====== æ“ä½œæŒ‰é’® ====== -->
  <view class="action-btns">
    <button class="btn" bindtap="toggleAdd">â• æ·»åŠ åŸºé‡‘</button>
  </view>

</view>

<!-- ====== æ·»åŠ åŸºé‡‘å¼¹çª—ï¼ˆæµ®å±‚ï¼‰ ====== -->
<view class="modal-mask" wx:if="{{showAdd}}" bindtap="toggleAdd">
  <view class="modal-panel" catchtap="noop">
    <!-- æ ‡é¢˜æ  -->
    <view class="modal-header">
      <text class="title">â• æ·»åŠ åŸºé‡‘</text>
      <text class="modal-close" bindtap="toggleAdd">âœ•</text>
    </view>

    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-row">
      <input class="input search-input" type="number" maxlength="6"
             placeholder="è¾“å…¥6ä½åŸºé‡‘ä»£ç " value="{{code}}" focus="{{showAdd}}"
             placeholder-style="color: rgba(255,255,255,0.4);"
             bindinput="onCodeInput" bindconfirm="doSearchFund" />
      <button class="btn small search-btn" bindtap="doSearchFund"
              disabled="{{searching}}">{{searching ? 'æŸ¥è¯¢ä¸­...' : 'ğŸ” æŸ¥æ‰¾'}}</button>
    </view>

    <!-- æœç´¢ç»“æœ -->
    <view wx:if="{{searchResult}}" class="search-result">
      <view class="sr-info">
        <text class="sr-name">{{searchResult.name}}</text>
        <text class="sub">{{searchResult.code}} Â· {{searchResult.type}}</text>
        <text wx:if="{{searchResult.pct !== null}}" class="sr-pct pct-{{searchResult.pct >= 0 ? 'up' : 'down'}}">
          ä»Šæ—¥ä¼°å€¼: {{searchResult.pct >= 0 ? '+' : ''}}{{searchResult.pct}}%
        </text>
      </view>
      <button class="btn sr-add-btn" bindtap="addFromSearch">âœ… ç¡®è®¤æ·»åŠ </button>
    </view>

    <!-- æœç´¢é”™è¯¯ -->
    <view wx:if="{{searchError}}" class="search-error">
      <text class="sub">{{searchError}}</text>
    </view>

    <!-- æ‰‹åŠ¨è¾“å…¥ï¼ˆæœç´¢æœªæœæ—¶å±•å¼€ï¼‰ -->
    <view wx:if="{{searchError || (!searchResult && code.length === 6)}}" class="manual-section">
      <view class="manual-divider">
        <text class="sub">â”€â”€ æˆ–æ‰‹åŠ¨å¡«å†™ â”€â”€</text>
      </view>
      <view class="form-item">
        <text class="label">åŸºé‡‘åç§°</text>
        <input class="input" placeholder="ä¾‹å¦‚ åå®‰é»„é‡‘ETFè”æ¥A" value="{{name}}" bindinput="onNameInput" />
      </view>
      <view class="form-item">
        <text class="label">åŸºé‡‘ç±»å‹</text>
        <picker mode="selector" range="{{typeOptions}}" value="{{typeIndex}}" bindchange="onTypeChange">
          <view class="input picker-val">{{typeOptions[typeIndex]}} â–¾</view>
        </picker>
      </view>
      <button class="btn" style="margin-top:16rpx;" bindtap="addHolding">ç¡®è®¤æ·»åŠ </button>
    </view>
  </view>
</view>
