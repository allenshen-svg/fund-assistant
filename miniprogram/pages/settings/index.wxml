<view class="container">

  <!-- ====== 概况 ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">📊 数据概况</text>
    </view>
    <view class="stat-grid">
      <view class="stat-item">
        <text class="stat-num">{{holdingsCount}}</text>
        <text class="sub">持仓基金</text>
      </view>
      <view class="stat-item">
        <text class="stat-num">{{watchlistCount}}</text>
        <text class="sub">自选基金</text>
      </view>
      <view class="stat-item">
        <text class="stat-num {{isTradingDay ? 'pct-up' : 'pct-flat'}}">{{isTradingDay ? '是' : '否'}}</text>
        <text class="sub">交易日</text>
      </view>
      <view class="stat-item">
        <text class="stat-num" style="font-size:24rpx;">{{marketStatus}}</text>
        <text class="sub">市场状态</text>
      </view>
    </view>
  </view>

  <!-- ====== 数据源设置 ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">🔗 数据源设置</text>
    </view>
    <view class="row switch-row">
      <text class="set-label">优先使用远程数据</text>
      <switch checked="{{useRemote}}" bindchange="onSwitchRemote" color="#6c8aff"></switch>
    </view>

    <view class="form-item" style="margin-top:16rpx;">
      <text class="label">远程基地址</text>
      <input class="input" value="{{apiBase}}" bindinput="onApiInput"
             placeholder="https://allenshen-svg.github.io/fund-assistant" />
    </view>

    <view class="form-item" style="margin-top:16rpx;">
      <text class="label">舆情分析服务器地址</text>
      <input class="input" value="{{serverUrl}}" bindinput="onServerUrlInput"
             placeholder="http://your-server.com" />
      <text class="sub" style="margin-top:6rpx;font-size:22rpx;">ℹ️ 用于手动刷新舆情分析。填写云服务器公网地址，如 http://1.2.3.4</text>
    </view>

    <view class="btn-row">
      <button class="btn" size="mini" bindtap="save">💾 保存</button>
      <button class="btn ghost" size="mini" bindtap="testConnection">🔍 测试连接</button>
      <button class="btn ghost" size="mini" bindtap="copyApiBase">📋 复制地址</button>
    </view>

    <view wx:if="{{status}}" class="status-bar {{statusColor}}">
      <text>{{status}}</text>
    </view>
  </view>

  <!-- ====== AI 分析设置 ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">🤖 AI 分析设置</text>
    </view>

    <view class="form-item">
      <text class="label">AI 提供商</text>
      <picker mode="selector" range="{{aiProviders}}" range-key="name" value="{{aiProviderIndex}}" bindchange="onAIProviderChange">
        <view class="input picker-val">{{aiProviders[aiProviderIndex].name}} ▾</view>
      </picker>
    </view>

    <view class="form-item">
      <text class="label">模型选择</text>
      <picker mode="selector" range="{{aiModels}}" range-key="name" value="{{aiModelIndex}}" bindchange="onAIModelChange">
        <view class="input picker-val">{{aiModels[aiModelIndex].name}} ▾</view>
      </picker>
    </view>

    <view class="form-item">
      <text class="label">API Key</text>
      <input class="input" value="{{aiKey}}" bindinput="onAIKeyInput" password="true"
             placeholder="填入你的 API Key" />
    </view>

    <view class="btn-row">
      <button class="btn" size="mini" bindtap="saveAIKey">💾 保存 Key</button>
      <button class="btn ghost" size="mini" bindtap="testAIConnection">🔍 测试 AI</button>
    </view>

    <view wx:if="{{aiStatus}}" class="status-bar {{aiStatus.indexOf('✅') >= 0 ? 'green' : aiStatus.indexOf('❌') >= 0 ? 'orange' : ''}}">
      <text>{{aiStatus}}</text>
    </view>

    <view class="ai-hint">
      <text class="sub">💡 硅基流动提供免费额度，注册后获取 Key：</text>
      <text class="sub link" style="color:#6c8aff;">https://cloud.siliconflow.cn</text>
    </view>
  </view>

  <!-- ====== 数据管理 ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">🛠️ 数据管理</text>
    </view>
    <view class="set-item" bindtap="clearCache">
      <text class="set-label danger">🗑️ 清除所有缓存</text>
      <text class="sub">重置持仓、设置等数据</text>
    </view>
  </view>

  <!-- ====== 上线须知 ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">📋 上线前检查</text>
    </view>
    <view class="check-item">
      <text class="check-icon">1️⃣</text>
      <text class="sub">在微信公众平台配置 request 合法域名</text>
    </view>
    <view class="check-item">
      <text class="check-icon">2️⃣</text>
      <text class="sub">域名必须 HTTPS 且证书有效</text>
    </view>
    <view class="check-item">
      <text class="check-icon">3️⃣</text>
      <text class="sub">替换 project.config.json 中的 AppID</text>
    </view>
    <view class="check-item">
      <text class="check-icon">4️⃣</text>
      <text class="sub">远程请求失败时自动回退到本地样本</text>
    </view>
  </view>

  <!-- ====== 关于 ====== -->
  <view class="card">
    <view class="card-header">
      <text class="title">ℹ️ 关于</text>
    </view>
    <view class="about-info">
      <text class="sub">基金决策助手小程序 v{{version}}</text>
      <text class="sub">最后更新：{{updateDate}}</text>
      <text class="sub" style="margin-top:8rpx;">数据仅供参考，不构成投资建议</text>
    </view>
  </view>

</view>
