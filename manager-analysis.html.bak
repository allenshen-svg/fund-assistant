<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ Â· Top500</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f0f2f5;--card:#fff;--text:#1a1a2e;--sub:#8896a4;
  --primary:#4F6EF7;--primary-bg:#eef2ff;
  --up:#e74040;--up-bg:#fef2f2;
  --down:#22a065;--down-bg:#ecfdf5;
  --border:#e8ecf1;--radius:14px;
  --warn:#f59e0b;--warn-bg:#fef3c7;
  --gold:#d97706;--gold-bg:#fffbeb;
}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro","PingFang SC","Helvetica Neue",sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;max-width:560px;margin:0 auto;min-height:100vh}

/* Header */
.page-header{background:linear-gradient(135deg,#78350f,#92400e,#b45309);color:#fff;padding:16px;position:sticky;top:0;z-index:100}
.ph-back{font-size:12px;opacity:.7;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-bottom:8px}
.ph-back:hover{opacity:1}
.ph-title{font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px}
.ph-title .badge{font-size:10px;background:rgba(255,255,255,.2);padding:2px 10px;border-radius:10px}
.ph-sub{font-size:11px;opacity:.65;margin-top:4px;line-height:1.5}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#78350f,#451a03);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;transition:opacity .5s}
.loading-overlay.hide{opacity:0;pointer-events:none}
.loading-icon{font-size:56px;margin-bottom:16px;animation:bounce 1.4s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.loading-title{font-size:18px;font-weight:700;margin-bottom:8px}
.loading-sub{font-size:12px;opacity:.6;margin-bottom:20px}
.loading-bar{width:220px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden}
.loading-fill{height:100%;background:linear-gradient(90deg,#f59e0b,#fbbf24);border-radius:3px;transition:width .3s}
.loading-status{font-size:11px;opacity:.5;margin-top:10px}

/* Section */
.section{margin:12px;background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.sec-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.sec-icon{font-size:20px}
.sec-title{font-size:14px;font-weight:700;flex:1}
.sec-badge{font-size:10px;background:var(--gold-bg);color:var(--gold);padding:2px 8px;border-radius:8px;font-weight:600}
.sec-body{padding:14px 16px}

/* Metric row */
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.metric{background:var(--bg);border-radius:10px;padding:10px 12px;text-align:center}
.metric .m-val{font-size:20px;font-weight:800;color:var(--gold)}
.metric .m-label{font-size:10px;color:var(--sub);margin-top:2px}
.metrics.tri{grid-template-columns:1fr 1fr 1fr}
.metrics.tri .metric .m-val{font-size:16px}

/* Bar chart */
.bar-chart{display:flex;flex-direction:column;gap:6px}
.bar-row{display:flex;align-items:center;gap:8px}
.bar-label{width:68px;font-size:10px;font-weight:500;text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-track{flex:1;height:18px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:6px;transition:width .6s ease}
.bar-fill span{font-size:9px;color:#fff;font-weight:600;white-space:nowrap}
.bar-val{width:48px;font-size:10px;font-weight:600;text-align:right;flex-shrink:0}

/* Donut chart */
.donut-wrap{display:flex;align-items:center;gap:16px;margin-bottom:12px}
.donut{width:100px;height:100px;border-radius:50%;flex-shrink:0;position:relative}
.donut-center{position:absolute;inset:18px;background:var(--card);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column}
.donut-center .dc-val{font-size:18px;font-weight:800;color:var(--gold)}
.donut-center .dc-label{font-size:9px;color:var(--sub)}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:3px}
.legend-item{display:flex;align-items:center;gap:6px;font-size:10px}
.legend-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.legend-name{flex:1;font-weight:500}
.legend-pct{font-weight:600;color:var(--sub)}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:11px}
.tbl th{text-align:left;padding:6px 8px;background:var(--bg);font-weight:600;color:var(--sub);font-size:10px;border-bottom:1px solid var(--border);white-space:nowrap}
.tbl td{padding:7px 8px;border-bottom:1px solid var(--border)}
.tbl tr:last-child td{border-bottom:none}
.tbl .t-name{font-weight:600;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tbl .t-up{color:var(--up);font-weight:600}
.tbl .t-down{color:var(--down);font-weight:600}
.tbl .t-tag{font-size:9px;padding:1px 5px;border-radius:4px;background:var(--gold-bg);color:var(--gold);font-weight:500}

/* Insight cards */
.insight{background:var(--bg);border-radius:10px;padding:12px;margin-bottom:8px;border-left:3px solid var(--gold)}
.insight .i-title{font-size:12px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.insight .i-body{font-size:11px;color:#374151;line-height:1.7}

/* Outlook */
.outlook-factor{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.outlook-factor:last-child{border-bottom:none}
.of-label{width:60px;font-size:10px;font-weight:600;flex-shrink:0}
.of-bar{flex:1;height:10px;background:var(--bg);border-radius:5px;overflow:hidden}
.of-fill{height:100%;border-radius:5px;transition:width .8s ease}
.of-score{width:30px;text-align:right;font-size:11px;font-weight:700}
.of-trend{font-size:9px;padding:1px 6px;border-radius:4px;font-weight:600;flex-shrink:0}
.of-trend.hot{background:#fef2f2;color:var(--up)}
.of-trend.warm{background:var(--warn-bg);color:#92400e}
.of-trend.cool{background:#ecfdf5;color:var(--down)}
.of-trend.neutral{background:#f1f5f9;color:var(--sub)}

/* Reco cards */
.reco-card{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1px solid #fde68a;border-radius:10px;padding:10px 12px;margin-bottom:8px}
.rc-top{display:flex;align-items:center;gap:8px}
.rc-rank{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0;background:linear-gradient(135deg,#f59e0b,#d97706)}
.rc-rank.r1{background:linear-gradient(135deg,#f59e0b,#d97706)}
.rc-rank.r2{background:linear-gradient(135deg,#94a3b8,#64748b)}
.rc-rank.r3{background:linear-gradient(135deg,#d97706,#92400e)}
.rc-rank.rn{background:#cbd5e1;color:#475569}
.rc-name{font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rc-ret{font-size:12px;font-weight:700;color:var(--up)}
.rc-mid{display:flex;gap:6px;margin-top:5px;flex-wrap:wrap;align-items:center}
.rc-tag{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:500}
.rc-tag.mgr{background:#fef3c7;color:#92400e}
.rc-tag.style{background:var(--primary-bg);color:var(--primary)}
.rc-tag.sector{background:#ecfdf5;color:#065f46}
.rc-desc{font-size:10px;color:#374151;line-height:1.5;margin-top:4px}
.rc-actions{display:flex;gap:6px;margin-top:8px}
.rc-btn{border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
.rc-btn.primary{background:var(--primary);color:#fff}
.rc-btn.outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}
.rc-btn:active{transform:scale(.96)}
.rc-btn.added{background:#e2e8f0;color:var(--sub);border:none}

/* Sector allocation */
.alloc-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.alloc-row:last-child{border-bottom:none}
.alloc-sector{width:72px;font-size:11px;font-weight:600;flex-shrink:0}
.alloc-bar{flex:1;height:14px;background:var(--bg);border-radius:4px;overflow:hidden}
.alloc-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:4px}
.alloc-fill span{font-size:8px;color:#fff;font-weight:600}
.alloc-rating{font-size:10px;font-weight:600;width:60px;text-align:right;flex-shrink:0}
.alloc-rating.strong{color:var(--up)}
.alloc-rating.ok{color:var(--warn)}
.alloc-rating.weak{color:var(--sub)}

/* Summary box */
.summary-box{background:linear-gradient(135deg,#fffbeb,#fef9c3);border:1px solid #fde68a;border-radius:12px;padding:14px;margin:12px;font-size:12px;line-height:1.8;color:#374151}
.summary-box b{color:#92400e}
.summary-box .sb-title{font-size:14px;font-weight:700;color:#78350f;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.summary-box ul{padding-left:16px;margin-top:6px}
.summary-box li{margin-bottom:4px}

/* Footer */
.page-footer{text-align:center;padding:20px 16px 40px;font-size:10px;color:var(--sub);line-height:1.6}
.page-footer a{color:var(--primary);text-decoration:none}

/* Expand toggle */
.expand-toggle{text-align:center;padding:10px;color:var(--primary);font-size:12px;cursor:pointer;font-weight:500;border-top:1px solid var(--border)}
.expand-toggle:active{background:var(--primary-bg)}

/* Tabs */
.sec-tabs{display:flex;border-bottom:1px solid var(--border);background:#fefce8}
.sec-tab{flex:1;text-align:center;padding:10px;font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--sub);transition:.2s}
.sec-tab.active{color:var(--gold);border-bottom-color:var(--gold);font-weight:600}

/* Nav anchors */
.nav-bar{display:flex;gap:6px;padding:10px 12px;overflow-x:auto;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:64px;z-index:50}
.nav-item{flex-shrink:0;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;background:var(--bg);color:var(--sub);text-decoration:none;transition:.2s}
.nav-item:active,.nav-item.active{background:var(--gold-bg);color:var(--gold)}

/* Warning box */
.warn-box{background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;margin-top:12px;font-size:10px;color:#991b1b;line-height:1.6}
.warn-box b{color:#7f1d1d}

/* Daily performance */
.daily-hero{display:flex;gap:8px;margin-bottom:14px}
.dh-card{flex:1;border-radius:10px;padding:10px 8px;text-align:center}
.dh-card .dh-val{font-size:22px;font-weight:800}
.dh-card .dh-label{font-size:9px;margin-top:2px;opacity:.7}
.dh-card.up{background:#fef2f2;color:var(--up)}
.dh-card.down{background:#ecfdf5;color:var(--down)}
.dh-card.flat{background:#f1f5f9;color:var(--sub)}
.dh-card.avg{background:var(--gold-bg);color:var(--gold)}
.daily-dist{margin-bottom:14px}
.dd-bar{display:flex;height:24px;border-radius:6px;overflow:hidden;margin-top:4px}
.dd-seg{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:#fff;transition:width .6s}
.daily-list{border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px}
.dl-header{display:flex;align-items:center;padding:8px 12px;background:var(--bg);font-size:11px;font-weight:600;gap:6px}
.dl-item{display:flex;align-items:center;padding:8px 12px;border-top:1px solid var(--border);gap:8px}
.dl-rank{width:20px;height:20px;border-radius:50%;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:#fff}
.dl-info{flex:1;min-width:0}
.dl-name{font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dl-sub{font-size:9px;color:var(--sub);margin-top:1px}
.dl-pct{font-size:13px;font-weight:700;flex-shrink:0;min-width:52px;text-align:right}
.daily-style-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.dsg-item{background:var(--bg);border-radius:8px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between}
.dsg-style{font-size:10px;font-weight:600}
.dsg-pct{font-size:12px;font-weight:700}
.dsg-count{font-size:9px;color:var(--sub)}
.daily-loading{text-align:center;padding:30px 16px;color:var(--sub);font-size:12px}
.daily-loading .dl-spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Long-term score */
.lt-score-card{background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;border-left:3px solid transparent}
.lt-score-card.elite{border-left-color:#ef4444;background:#fef2f2}
.lt-score-card.strong{border-left-color:#f59e0b;background:#fffbeb}
.lt-score-card.good{border-left-color:#3b82f6;background:#eef2ff}
.lt-score-ring{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;font-weight:800;color:#fff}
.lt-score-info{flex:1;min-width:0}
.lt-score-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lt-score-sub{font-size:9px;color:var(--sub);margin-top:2px;display:flex;flex-wrap:wrap;gap:4px}
.lt-score-dims{display:flex;gap:3px;margin-top:4px}
.lt-dim{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:500}

/* Portfolio builder */
.port-ring{width:120px;height:120px;border-radius:50%;position:relative;margin:0 auto 12px}
.port-center{position:absolute;inset:28px;background:var(--card);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column}
.port-center .pc-val{font-size:16px;font-weight:800;color:var(--gold)}
.port-center .pc-label{font-size:8px;color:var(--sub)}
.port-block{border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:10px}
.port-block-h{padding:8px 12px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:6px}
.port-block-h.core{background:#eef2ff;color:var(--primary)}
.port-block-h.sat{background:#fef2f2;color:var(--up)}
.port-fund{display:flex;align-items:center;padding:7px 12px;border-top:1px solid var(--border);gap:8px}
.pf-weight{font-size:10px;font-weight:700;color:var(--gold);width:32px;flex-shrink:0;text-align:center}
.pf-info{flex:1;min-width:0}
.pf-name{font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pf-sub{font-size:9px;color:var(--sub)}
.pf-tag{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:500}
.pf-actions{flex-shrink:0}
.pf-btn{border:none;padding:3px 8px;border-radius:5px;font-size:9px;font-weight:600;cursor:pointer;background:var(--primary);color:#fff}
.pf-btn:active{transform:scale(.95)}
.pf-btn.added{background:#e2e8f0;color:var(--sub)}

/* Cycle */
.cycle-phase{border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border)}
.cp-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.cp-icon{font-size:24px}
.cp-name{font-size:13px;font-weight:700}
.cp-tag{font-size:9px;padding:2px 8px;border-radius:6px;font-weight:600}
.cp-desc{font-size:10px;color:#374151;line-height:1.6;margin-bottom:6px}
.cp-styles{display:flex;flex-wrap:wrap;gap:4px}
.cp-style{font-size:9px;padding:2px 7px;border-radius:4px;font-weight:500;background:var(--bg)}
.cp-style.hot{background:#fef2f2;color:var(--up);font-weight:600}
.cp-current{background:linear-gradient(135deg,#fffbeb,#fef3c7);border-color:#fde68a;box-shadow:0 2px 8px rgba(245,158,11,.15)}

/* DCA */
.dca-result{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.dca-card{border-radius:10px;padding:10px 8px;text-align:center}
.dca-card .dca-period{font-size:9px;color:var(--sub);margin-bottom:2px}
.dca-card .dca-total{font-size:10px;font-weight:500;color:var(--sub)}
.dca-card .dca-val{font-size:18px;font-weight:800}
.dca-card .dca-ret{font-size:10px;font-weight:600;margin-top:2px}
.dca-card.y1{background:#eef2ff;color:var(--primary)}
.dca-card.y3{background:#fffbeb;color:var(--gold)}
.dca-card.y5{background:#fef2f2;color:var(--up)}
.dca-param{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.dca-param:last-child{border-bottom:none}
.dca-param .dp-label{font-size:10px;font-weight:600;width:60px;flex-shrink:0}
.dca-param .dp-val{font-size:11px;font-weight:600;color:var(--gold);flex:1}
.dca-param .dp-note{font-size:9px;color:var(--sub)}
.dca-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px}
.dca-table th{background:var(--bg);padding:5px 6px;font-weight:600;color:var(--sub);text-align:left;font-size:9px}
.dca-table td{padding:5px 6px;border-top:1px solid var(--border)}

/* Data discovery */
.disc-card{border:1px solid var(--border);border-radius:10px;margin-bottom:8px;overflow:hidden}
.disc-card.alpha{border-color:#d97706;background:linear-gradient(135deg,#fffbeb,#fef3c7)}
.disc-card.strong{border-color:#22c55e;background:#f0fdf4}
.disc-card.emerging{border-color:#3b82f6;background:#eff6ff}
.disc-header{padding:8px 12px;display:flex;align-items:center;gap:8px}
.disc-signal{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:700}
.disc-signal.alpha{background:#d9770630;color:#92400e}
.disc-signal.strong{background:#22c55e30;color:#166534}
.disc-signal.emerging{background:#3b82f630;color:#1e40af}
.disc-style{font-size:12px;font-weight:700;flex:1}
.disc-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;padding:0 12px 8px}
.disc-m{text-align:center}
.disc-m .dm-val{font-size:13px;font-weight:800}
.disc-m .dm-label{font-size:8px;color:var(--sub)}
.disc-body{padding:4px 12px 10px;font-size:10px;line-height:1.5;color:#374151;border-top:1px solid var(--border)}
.disc-why{font-size:9px;padding:2px 12px 8px;color:var(--sub);line-height:1.4}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-icon">ğŸ†</div>
  <div class="loading-title">åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ</div>
  <div class="loading-sub">æ­£åœ¨ä»å¤©å¤©åŸºé‡‘è·å–å‰500ä½åŸºé‡‘ç»ç†æ•°æ®...</div>
  <div class="loading-bar"><div class="loading-fill" id="loading-fill" style="width:0%"></div></div>
  <div class="loading-status" id="loading-status">å‡†å¤‡ä¸­...</div>
</div>

<!-- Page Header -->
<div class="page-header">
  <div class="ph-back" onclick="location.href='index.html'">â† è¿”å›åŸºé‡‘å°åŠ©ç†</div>
  <div class="ph-title">ğŸ† åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ <span class="badge">TOP 500</span></div>
  <div class="ph-sub">åŸºäºå¤©å¤©åŸºé‡‘å…¨é‡æ•°æ® Â· åˆ†ææŠ•èµ„ç­–ç•¥ Â· 3ä¸ªæœˆå‰ç»å»ºè®®<br>æ•°æ®æ¥æºï¼šä¸œæ–¹è´¢å¯ŒChoice Â· æ›´æ–°æ—¶é—´ï¼š<span id="update-time">--</span></div>
</div>

<!-- Navigation -->
<div class="nav-bar" id="nav-bar">
  <a class="nav-item active" href="#sec-overview">ğŸ“Š æ¦‚è§ˆ</a>
  <a class="nav-item" href="#sec-daily">ğŸ“ˆ å½“æ—¥</a>
  <a class="nav-item" href="#sec-review">ğŸ“‹ å›é¡¾</a>
  <a class="nav-item" href="#sec-strategy">ğŸ¯ ç­–ç•¥</a>
  <a class="nav-item" href="#sec-company">ğŸ¢ å…¬å¸</a>
  <a class="nav-item" href="#sec-experience">ğŸ“ˆ ç»éªŒ</a>
  <a class="nav-item" href="#sec-insights">ğŸ’¡ æ´å¯Ÿ</a>
  <a class="nav-item" href="#sec-discover">ğŸ”¬ å‘ç°</a>
  <a class="nav-item" href="#sec-ltvalue">ğŸ¯ ä»·å€¼</a>
  <a class="nav-item" href="#sec-cycle">ğŸ”„ è½®åŠ¨</a>
  <a class="nav-item" href="#sec-portfolio">ğŸ§± ç»„åˆ</a>
  <a class="nav-item" href="#sec-dca">ğŸ’° å®šæŠ•</a>
  <a class="nav-item" href="#sec-outlook">ğŸ”® å‰ç»</a>
  <a class="nav-item" href="#sec-recos">ğŸ–ï¸ æ¨è</a>
</div>

<!-- Main Content -->
<div id="main-content"></div>

<!-- Footer -->
<div class="page-footer">
  æ•°æ®æ¥æºï¼šä¸œæ–¹è´¢å¯ŒChoiceæ•°æ® Â· å¤©å¤©åŸºé‡‘<br>
  æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®<br>
  <a href="index.html">â† è¿”å›åŸºé‡‘è‚¡å¸‚å°åŠ©ç†</a>
</div>

<script>
// ==================== CONFIGURATION ====================
const API_BASE = 'https://fund.eastmoney.com/Data/FundDataPortfolio_Interface.aspx';
const PAGES_TO_FETCH = 8; // 8 pages Ã— 100 = 800 managers, filter to ~500
const PER_PAGE = 100;

// Shared localStorage keys (same as main app)
const LS_HOLDINGS = 'fa_holdings';
const LS_WATCHLIST = 'fa_watchlist';

// ==================== MACRO OUTLOOK (Feb-May 2026) ====================
// åŸºäºè¿‡å»1å¹´å¸‚åœºå›é¡¾ + å›½é™…å›½å†…å½¢åŠ¿ + ä¼˜ç§€åŸºé‡‘è¡¨ç°çš„ç»¼åˆåˆ†æ
// Will be replaced by real AI analysis if API key is available
let MACRO_OUTLOOK = {
  period: '2026å¹´2æœˆâ€”5æœˆ',
  updated: '2026-02-14',
  // è¿‡å»ä¸€å¹´å„æ¿å—å®é™…è¡¨ç°å›é¡¾ (2025.2-2026.2)
  pastYearReview: [
    {sector:'æœ‰è‰²é‡‘å±',ret:'+52%',icon:'ğŸ”¥',highlight:true,
     detail:'é“œä»·çªç ´$10000/å¨ï¼Œé“ä»·åˆ›2å¹´æ–°é«˜ã€‚å…¨çƒæ–°èƒ½æºè½¬å‹+AIæ•°æ®ä¸­å¿ƒç”¨ç”µæ¿€å¢æ¨åŠ¨é“œé“éœ€æ±‚é£™å‡ï¼Œå åŠ å—ç¾é“œçŸ¿ä¾›åº”æ‰°åŠ¨ã€å›½å†…å†¶ç‚¼åˆ©æ¶¦æ”¶ç¼©å¯¼è‡´ä¾›ç»™åç´§ï¼Œæœ‰è‰²æ¿å—æˆä¸ºè¿‡å»ä¸€å¹´æœ€å¼ºèµ›é“ä¹‹ä¸€ã€‚'},
    {sector:'è´µé‡‘å±(é»„é‡‘)',ret:'+35%',icon:'âœ¨',highlight:true,
     detail:'å›½é™…é‡‘ä»·çªç ´$2800/ç›å¸ã€‚åœ°ç¼˜å†²çªæŒç»­ï¼ˆä¿„ä¹Œã€ä¸­ä¸œï¼‰ã€å…¨çƒå¤®è¡ŒæŒç»­è´­é‡‘ï¼ˆä¸­å›½å¤®è¡Œè¿ç»­18ä¸ªæœˆå¢æŒï¼‰ã€ç¾å…ƒä¿¡ç”¨ä½“ç³»æ¾åŠ¨ä¸‰é‡å› ç´ é©±åŠ¨ï¼Œé»„é‡‘å·²ä»é¿é™©èµ„äº§å‡çº§ä¸ºæˆ˜ç•¥é…ç½®èµ„äº§ã€‚'},
    {sector:'ç§‘æŠ€/AI',ret:'+38%',icon:'ğŸ¤–',highlight:true,
     detail:'DeepSeekå¼•çˆ†å›½äº§AIé©å‘½ï¼Œç®—åŠ›åŸºå»ºâ†’åº”ç”¨è½åœ°å…¨é¢åŠ é€Ÿã€‚æœºå™¨äººï¼ˆäººå½¢æœºå™¨äººæ¦‚å¿µï¼‰ã€è‡ªåŠ¨é©¾é©¶ã€AI Agentè¿›å…¥å•†ä¸šåŒ–æ‹ç‚¹ï¼ŒåŠå¯¼ä½“å›½äº§æ›¿ä»£æµªæ½®å—ç›Šäºå‡ºå£ç®¡åˆ¶å€’é€¼ã€‚'},
    {sector:'çº¢åˆ©/é«˜è‚¡æ¯',ret:'+18%',icon:'ğŸ’°',highlight:false,
     detail:'åˆ©ç‡æŒç»­ä¸‹è¡Œç¯å¢ƒä¸‹ï¼Œé«˜è‚¡æ¯èµ„äº§å¸å¼•åŠ›æå‡ã€‚å¤®å›½ä¼ä»·å€¼é‡ä¼°ä¸»çº¿å»¶ç»­ï¼Œç…¤ç‚­ã€é“¶è¡Œã€å…¬ç”¨äº‹ä¸šç¨³å¥ä¸Šæ¶¨ã€‚'},
    {sector:'æ¸¯è‚¡ç§‘æŠ€',ret:'+28%',icon:'ğŸŒ',highlight:false,
     detail:'å—å‘èµ„é‡‘æŒç»­æµå…¥ï¼Œæ’ç”Ÿç§‘æŠ€æŒ‡æ•°èµ°å‡ºä½è°·ã€‚äº’è”ç½‘é¾™å¤´ç›ˆåˆ©æ”¹å–„+AIæ¦‚å¿µå‚¬åŒ–+ä¼°å€¼ä¿®å¤ä¸‰é‡é©±åŠ¨ã€‚'},
    {sector:'æ¶ˆè´¹',ret:'+8%',icon:'ğŸ›’',highlight:false,
     detail:'æ¶ˆè´¹å¤è‹ä¸åŠé¢„æœŸï¼Œç»“æ„åˆ†åŒ–ä¸¥é‡ã€‚å¤§ä¼—æ¶ˆè´¹ç¼“æ…¢ä¿®å¤ï¼Œé«˜ç«¯æ¶ˆè´¹æŒç»­æ‰¿å‹ï¼Œé£Ÿå“é¥®æ–™é¾™å¤´ä¼°å€¼ä»åœ¨æ¶ˆåŒ–æœŸã€‚'},
    {sector:'åŒ»è¯',ret:'+12%',icon:'ğŸ’Š',highlight:false,
     detail:'åˆ›æ–°è¯å‡ºæµ·é€»è¾‘å…‘ç°ï¼ŒCXOæ¿å—é˜¶æ®µæ€§åå¼¹ã€‚é›†é‡‡å½±å“é€æ­¥æ¶ˆåŒ–ï¼Œä½†æ•´ä½“å¤è‹åæ…¢ã€‚'},
    {sector:'æ–°èƒ½æº',ret:'-5%',icon:'âš¡',highlight:false,
     detail:'äº§èƒ½è¿‡å‰©æ ¼å±€æœªæ”¹ï¼Œå…‰ä¼ã€é”‚ç”µæ± ä»·æ ¼æŒç»­ä¸‹è·Œã€‚è¡Œä¸šå‡ºæ¸…å°šæœªå®Œæˆï¼Œä»…å‚¨èƒ½ä¸æµ·ä¸Šé£ç”µç­‰ç»†åˆ†æ–¹å‘æœ‰äº®ç‚¹ã€‚'},
  ],
  // å›½é™…å½¢åŠ¿åˆ†æ
  intlFactors: [
    {label:'ç¾è”å‚¨æ”¿ç­–',score:65,trend:'é™æ¯æ”¾ç¼“',cls:'warm',
     desc:'2025å¹´ç´¯è®¡é™æ¯75bpåèŠ‚å¥æ˜æ˜¾æ”¾ç¼“ï¼Œ2026å¹´é¢„è®¡ä»…1-2æ¬¡é™æ¯ã€‚ç¾å…ƒæŒ‡æ•°å›è½ä½†å¹…åº¦æœ‰é™ï¼Œå…¨çƒæµåŠ¨æ€§è¾¹é™…æ”¹å–„ä½†ä¸å†è¶…é¢„æœŸå®½æ¾ã€‚'},
    {label:'å…¨çƒé€šèƒ€',score:58,trend:'ç²˜æ€§æ®‹å­˜',cls:'neutral',
     desc:'æ ¸å¿ƒé€šèƒ€3%å·¦å³ä¼ç¨³ï¼ŒæœåŠ¡é€šèƒ€é¡½å›ºã€‚å¤§å®—å•†å“ï¼ˆé“œé“ï¼‰æ¶¨ä»·å‘ä¸‹æ¸¸ä¼ å¯¼ï¼Œéœ€å…³æ³¨äºŒæ¬¡é€šèƒ€é£é™©ã€‚'},
    {label:'åœ°ç¼˜åšå¼ˆ',score:40,trend:'é£é™©åé«˜',cls:'hot',
     desc:'ä¸­ç¾ç§‘æŠ€è„±é’©æ·±åŒ–ï¼ˆAIèŠ¯ç‰‡ã€å…ˆè¿›å°è£…å‡ºå£ç®¡åˆ¶å‡çº§ï¼‰ï¼›ä¿„ä¹Œå†²çªæŒç»­ï¼›ä¸­ä¸œå±€åŠ¿ä¸ç¨³ï¼›åŠ å‰§ä¾›åº”é“¾é‡æ„å’Œèµ„æºå“æ³¢åŠ¨ã€‚'},
    {label:'å…¨çƒåˆ¶é€ ä¸š',score:72,trend:'æ‰©å¼ ',cls:'warm',
     desc:'å…¨çƒåˆ¶é€ ä¸šPMIé‡å›æ‰©å¼ åŒºé—´ã€‚AIåŸºå»ºæŠ•èµ„æ‹‰åŠ¨æœåŠ¡å™¨/èŠ¯ç‰‡/ç”µåŠ›è®¾å¤‡éœ€æ±‚ï¼Œæ–°èƒ½æºè½¦æ¸—é€ç‡æŒç»­æå‡å¸¦åŠ¨æœ‰è‰²é‡‘å±éœ€æ±‚ã€‚'},
    {label:'ç¾å…ƒä¸æ±‡ç‡',score:55,trend:'æ¸©å’Œèµ°å¼±',cls:'neutral',
     desc:'ç¾å…ƒæŒ‡æ•°ä»105å›è½è‡³100é™„è¿‘ï¼Œæœ‰åˆ©äºæ–°å…´å¸‚åœºèµ„é‡‘å›æµå’Œå¤§å®—å•†å“ä»·æ ¼ã€‚äººæ°‘å¸æ±‡ç‡7.0-7.2åŒºé—´æ³¢åŠ¨ã€‚'},
  ],
  // å›½å†…å½¢åŠ¿åˆ†æ
  domesticFactors: [
    {label:'è´§å¸æ”¿ç­–',score:75,trend:'ç¨³å¥åæ¾',cls:'warm',
     desc:'LPRä»æœ‰10-20bpä¸‹è°ƒç©ºé—´ï¼Œç¤¾èå¢é€Ÿå›å‡ã€‚å®šå‘æ”¯æŒç§‘æŠ€åˆ›æ–°å’Œæ¶ˆè´¹ä¿¡è´·ï¼ŒæµåŠ¨æ€§åˆç†å……è£•ã€‚'},
    {label:'è´¢æ”¿åˆºæ¿€',score:70,trend:'ç§¯æ',cls:'warm',
     desc:'ä¸“é¡¹å€ºå‘è¡ŒåŠ é€Ÿï¼ˆå…¨å¹´4ä¸‡äº¿+ï¼‰ï¼Œè¶…é•¿æœŸç‰¹åˆ«å›½å€ºé‡ç‚¹æŠ•å‘æ–°åŸºå»ºã€AIç®—åŠ›ã€ç»¿è‰²è½¬å‹ã€‚åŸºå»ºæ‰˜åº•ç»æµåº•çº¿æ€ç»´æ˜ç¡®ã€‚'},
    {label:'äº§ä¸šæ”¿ç­–',score:85,trend:'å¼ºåŠ›é©±åŠ¨',cls:'hot',
     desc:'AIå¤§æ¨¡å‹+æœºå™¨äºº+åŠå¯¼ä½“ä¸‰çº¿å¹¶è¿›è·æ”¿ç­–å…¨é¢åŠ æŒã€‚æˆ˜ç•¥é‡‘å±ï¼ˆé“œã€é“ã€ç¨€åœŸã€é”‚ï¼‰è¢«çº³å…¥å›½å®¶å®‰å…¨æˆ˜ç•¥å‚¨å¤‡ï¼Œæœ‰è‰²é‡‘å±äº§ä¸šé“¾ä»·å€¼è¢«é‡æ–°å®šä¹‰ã€‚'},
    {label:'å†…éœ€æ¶ˆè´¹',score:58,trend:'ç¼“æ…¢ä¿®å¤',cls:'neutral',
     desc:'å±…æ°‘æ”¶å…¥å¢é€Ÿå¾®å‡ä½†ä¿¡å¿ƒä¸è¶³ï¼Œåœ°äº§æ‹–ç´¯æ•ˆåº”å‡å¼±ä½†æœªæ¶ˆé™¤ã€‚ä»¥æ—§æ¢æ–°æ”¿ç­–å»¶ç»­ï¼ŒæœåŠ¡æ¶ˆè´¹ä¼˜äºå•†å“æ¶ˆè´¹ã€‚'},
    {label:'èµ„æœ¬å¸‚åœºæ”¹é©',score:68,trend:'æ·±åŒ–æ¨è¿›',cls:'warm',
     desc:'æ–°"å›½ä¹æ¡"è½åœ°è§æ•ˆï¼ŒIPOèŠ‚å¥å¯æ§ï¼Œåˆ†çº¢åˆ¶åº¦ä¼˜åŒ–ã€‚å¤®å›½ä¼ä»·å€¼é‡ä¼°+å¹¶è´­é‡ç»„æ´»è·ƒï¼Œé•¿çº¿èµ„é‡‘å…¥å¸‚åŠ é€Ÿã€‚'},
  ],
  // æœªæ¥3ä¸ªæœˆæ¿å—é…ç½®å»ºè®® (åŸºäºä»¥ä¸Šæ‰€æœ‰åˆ†æ)
  sectorRecos: [
    {sector:'ç§‘æŠ€/AI',rating:'å¼ºçƒˆæ¨è',weight:25,color:'#ef4444',reason:'AIä»æ¦‚å¿µèµ°å‘å•†ä¸šåŒ–è½åœ°ï¼Œç®—åŠ›â†’åº”ç”¨â†’æœºå™¨äººâ†’è‡ªåŠ¨é©¾é©¶å…¨é“¾æ¡å‚¬åŒ–ã€‚å›½äº§æ›¿ä»£å—å‡ºå£ç®¡åˆ¶å€’é€¼åŠ é€Ÿï¼ŒåŠå¯¼ä½“è®¾å¤‡/EDA/å…ˆè¿›å°è£…æ˜¯æ ¸å¿ƒæ–¹å‘ã€‚ä½†æ³¨æ„çŸ­æœŸä¼°å€¼å·²ä¸ä¾¿å®œï¼Œå»ºè®®æ‹©æœºé…ç½®ã€‚'},
    {sector:'æœ‰è‰²é‡‘å±',rating:'å¼ºçƒˆæ¨è',weight:18,color:'#d97706',reason:'ã€è¿‡å»3ä¸ªæœˆæ¶¨å¹…æœ€é«˜çš„èµ›é“ã€‘ä¾›éœ€æ ¼å±€æŒç»­ç´§å¼ ï¼šå…¨çƒAIæ•°æ®ä¸­å¿ƒ+æ–°èƒ½æºè½¦+å…‰ä¼ç”¨é“œé‡æ¿€å¢ï¼Œå—ç¾é“œçŸ¿èµ„æœ¬å¼€æ”¯ä¸è¶³å¯¼è‡´3-5å¹´ä¾›ç»™ç¼ºå£ã€‚é“å—ç›Šäºå›½å†…ç”µè§£é“äº§èƒ½å¤©èŠ±æ¿+æ±½è½¦è½»é‡åŒ–+å…‰ä¼è¾¹æ¡†éœ€æ±‚ã€‚æœ‰è‰²é‡‘å±ä»å‘¨æœŸå“å‡çº§ä¸ºæˆé•¿å“ï¼Œä¸­é•¿çº¿æ ¸å¿ƒé…ç½®ã€‚'},
    {sector:'è´µé‡‘å±',rating:'æ¨è',weight:12,color:'#f59e0b',reason:'é»„é‡‘çš„å®šä»·é€»è¾‘å·²ä»"æŠ—é€šèƒ€"è½¬å˜ä¸º"å»ç¾å…ƒåŒ–+å¤®è¡Œå‚¨å¤‡é‡é…+åœ°ç¼˜é¿é™©"ä¸‰é‡é©±åŠ¨ã€‚å…¨çƒå¤®è¡Œè´­é‡‘è¶‹åŠ¿æœªå˜ã€‚è™½ç„¶é‡‘ä»·å·²é«˜ï¼Œä½†ä¸­é•¿æœŸä¸Šè¡Œè¶‹åŠ¿æœªæ”¹ï¼Œå›è°ƒå³æ˜¯åŠ ä»“æœºä¼šã€‚'},
    {sector:'çº¢åˆ©/ä»·å€¼',rating:'æ¨è',weight:14,color:'#eab308',reason:'åˆ©ç‡ä¸‹è¡Œç¯å¢ƒä¸­é«˜è‚¡æ¯èµ„äº§æ€§ä»·æ¯”å‡¸æ˜¾ã€‚å¤®å›½ä¼ä»·å€¼é‡ä¼°+æé«˜åˆ†çº¢æ¯”ä¾‹æ”¿ç­–æŒç»­æ¨è¿›ï¼Œç…¤ç‚­/é“¶è¡Œ/å…¬ç”¨äº‹ä¸š/äº¤è¿å¯ä½œä¸ºç»„åˆå‹èˆ±çŸ³ã€‚'},
    {sector:'é«˜ç«¯åˆ¶é€ ',rating:'æ¨è',weight:12,color:'#f97316',reason:'å‡ºå£éŸ§æ€§+äº§ä¸šå‡çº§åŒè½®é©±åŠ¨ã€‚åŠå¯¼ä½“è®¾å¤‡ã€å·¥ä¸šæ¯æœºã€èˆªç©ºå‘åŠ¨æœºå¤šçº¿å—ç›Šã€‚å†›å·¥å›½é˜²è®¢å•å›æš–ï¼Œå…³æ³¨åå››äº”æœ«æœŸè£…å¤‡äº¤ä»˜åŠ é€Ÿã€‚'},
    {sector:'æ¶ˆè´¹/åŒ»è¯',rating:'é€‚åº¦é…ç½®',weight:8,color:'#22c55e',reason:'æ¶ˆè´¹å¼±å¤è‹æ ¼å±€æœªå˜ä½†ä¼°å€¼å·²å…·æ€§ä»·æ¯”ã€‚åˆ›æ–°è¯å‡ºæµ·+è¯å“é›†é‡‡è¾¹é™…å½±å“é€’å‡ï¼ŒåŒ»è¯é¾™å¤´å¸ƒå±€çª—å£ã€‚å…³æ³¨æ€§ä»·æ¯”æ¶ˆè´¹ä¸æœåŠ¡å‹æ¶ˆè´¹ã€‚'},
    {sector:'è·¨å¢ƒ/æ¸¯è‚¡',rating:'é€‚åº¦é…ç½®',weight:6,color:'#8b5cf6',reason:'æ¸¯è‚¡ç§‘æŠ€é¾™å¤´ç›ˆåˆ©è¶‹åŠ¿å‘å¥½+ä¼°å€¼æŠ˜ä»·ä»å­˜ï¼Œä½†éœ€è­¦æƒ•ç¾å›½åŠ å¾å…³ç¨ç­‰çªå‘é£é™©ã€‚å®šæŠ•é€»è¾‘å¼ºäºä¸€æ¬¡æ€§é‡ä»“ã€‚'},
    {sector:'æ–°èƒ½æº',rating:'è°¨æ…è§‚æœ›',weight:3,color:'#06b6d4',reason:'äº§èƒ½è¿‡å‰©å‡ºæ¸…è¿œæœªç»“æŸï¼Œå…‰ä¼/é”‚ç”µæ± ä»·æ ¼æˆ˜ä»åœ¨ç»§ç»­ã€‚ä»…å‚¨èƒ½ä¸æµ·ä¸Šé£ç”µæœ‰ç»“æ„æ€§æœºä¼šï¼Œä¸å»ºè®®ä½œä¸ºæ ¸å¿ƒä»“ä½ã€‚'},
    {sector:'å›ºæ”¶/å€ºåˆ¸',rating:'ä½é…',weight:2,color:'#94a3b8',reason:'10å¹´å›½å€ºæ”¶ç›Šç‡å·²é™è‡³1.6%é™„è¿‘å†å²ä½ä½ï¼Œåˆ©å·®æåº¦å‹ç¼©ã€‚å€ºç‰›å°¾éƒ¨é£é™©å¤§äºæ”¶ç›Šï¼Œä»…ä½œä¸ºæµåŠ¨æ€§ç®¡ç†å·¥å…·ã€‚'},
  ]
};

// Style colors
const STYLE_COLORS = {
  'ç§‘æŠ€æˆé•¿':'#3b82f6','çµæ´»é…ç½®':'#8b5cf6','æ¶ˆè´¹':'#ec4899','åŒ»è¯å¥åº·':'#10b981',
  'ä»·å€¼è“ç­¹':'#f59e0b','çº¢åˆ©ä»·å€¼':'#ef4444','å‡è¡¡æˆé•¿':'#6366f1','æ–°èƒ½æº':'#06b6d4',
  'æŒ‡æ•°é‡åŒ–':'#f97316','å›ºæ”¶å¢å¼º':'#64748b','è·¨å¢ƒQDII':'#a855f7','å†›å·¥å›½é˜²':'#dc2626',
  'å‘¨æœŸ':'#84cc16','çº¯å€ºå›ºæ”¶':'#94a3b8','è´§å¸ç†è´¢':'#cbd5e1','è´µé‡‘å±':'#eab308',
  'FOFé…ç½®':'#14b8a6','å•†å“èµ„æº':'#d97706','æˆé•¿':'#2563eb','æœ‰è‰²é‡‘å±':'#b45309',
  'åŒ–å·¥ææ–™':'#78716c','åŸºç¡€è®¾æ–½':'#92400e','å…¬ç”¨äº‹ä¸š':'#4d7c0f','å†œä¸šé£Ÿå“':'#15803d',
  'é‡‘è':'#b91c1c','åœ°äº§REITs':'#7c3aed','å…¶ä»–':'#9ca3af'
};

// ==================== STATE ====================
let allManagers = [];
let filteredManagers = []; // equity/mixed only
let analysis = {};
let holdings = JSON.parse(localStorage.getItem(LS_HOLDINGS)||'[]');
let watchlist = JSON.parse(localStorage.getItem(LS_WATCHLIST)||'[]');
let dailyData = {}; // code -> {pct, nav, name}
let dailyFetched = false;
let dailyFetchProgress = 0;
let aiMacroGenerated = false; // whether MACRO_OUTLOOK was replaced by real AI

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'ç¡…åŸºæµåŠ¨(å…è´¹)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    macroModels: [
      {name:'DeepSeek-V3', model:'deepseek-ai/DeepSeek-V3'},
      {name:'Qwen2.5-72B', model:'Qwen/Qwen2.5-72B-Instruct'}
    ]
  },
  {
    id:'deepseek', name:'DeepSeekå®˜æ–¹(æä½ä»·)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    macroModels: [
      {name:'DeepSeek-R1', model:'deepseek-reasoner'},
      {name:'DeepSeek-V3', model:'deepseek-chat'}
    ]
  },
  {
    id:'302ai', name:'302.AI(ä»˜è´¹)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    macroModels: [
      {name:'DeepSeek-R1', model:'deepseek-r1'},
      {name:'Qwen3-235B', model:'qwen3-235b-a22b'}
    ]
  }
];

const _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
const _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
const _apiBase = _aiProvider.base;
const _302aiKey = localStorage.getItem('fa_302ai_key') || 'sk-njqerftsrrnojbsdagigsrzbwwxgtuhrsyihphcxvsdpbaxl';

async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_302aiKey) throw new Error('No API key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_302aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:8192
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildManagerDataContext(){
  // Summarize actual manager data for AI
  const stylePerf = {};
  filteredManagers.forEach(m=>{
    if(!stylePerf[m.style]) stylePerf[m.style] = {returns:[], count:0};
    stylePerf[m.style].returns.push(m.careerReturn);
    stylePerf[m.style].count++;
  });
  const styleSummary = Object.keys(stylePerf)
    .map(s=>({style:s, count:stylePerf[s].count, avgReturn:mean(stylePerf[s].returns)}))
    .sort((a,b)=>b.avgReturn-a.avgReturn);

  let ctx = `å½“å‰æ—¥æœŸ: ${new Date().toISOString().slice(0,10)}\n`;
  ctx += `\nã€TOP${filteredManagers.length}åŸºé‡‘ç»ç†æ•°æ®ç»Ÿè®¡ã€‘\n`;
  ctx += `æ€»äººæ•°: ${filteredManagers.length}, å¹³å‡ä»»èŒå›æŠ¥: ${mean(filteredManagers.map(m=>m.careerReturn)).toFixed(1)}%\n`;
  ctx += `\nã€å„æŠ•èµ„é£æ ¼è¡¨ç°æ’å(æŒ‰å‡å›æŠ¥)ã€‘\n`;
  styleSummary.forEach(s=>{
    ctx += `${s.style}: ${s.count}äºº, å‡å›æŠ¥${s.avgReturn.toFixed(1)}%\n`;
  });

  // Discovery engine data
  if(sectorDiscovery){
    const {discoveries} = sectorDiscovery;
    const signals = discoveries.filter(d=>d.signal!=='normal');
    if(signals.length>0){
      ctx += `\nã€æ•°æ®å‘ç°å¼•æ“ä¿¡å·ã€‘\n`;
      signals.forEach(d=>{
        ctx += `${d.style}: ä¿¡å·=${d.signal==='alpha'?'è¢«å¿½è§†çš„Î±':d.signal==='strong'?'å¼ºåŠ¿':'èŒèŠ½'}, è¶…é¢å›æŠ¥${d.excessReturn>=0?'+':''}${d.excessReturn.toFixed(1)}%, èƒœç‡${d.winRate.toFixed(0)}%, ç®¡ç†äººæ•°${d.count}\n`;
      });
    }
    ctx += `\nã€å…¨éƒ¨é£æ ¼å‘ç°å¼•æ“å¾—åˆ†ã€‘\n`;
    discoveries.sort((a,b)=>b.discoveryScore-a.discoveryScore).forEach(d=>{
      ctx += `${d.style}: å¾—åˆ†${d.discoveryScore.toFixed(0)}, å‡å›æŠ¥${d.avgReturn.toFixed(1)}%, Zåˆ†æ•°${d.zScore.toFixed(2)}\n`;
    });
  }

  // Top performers
  const topManagers = filteredManagers.sort((a,b)=>b.careerReturn-a.careerReturn).slice(0,20);
  ctx += `\nã€å›æŠ¥æœ€é«˜çš„20ä½ç»ç†ã€‘\n`;
  topManagers.forEach(m=>{
    ctx += `${m.name}(${m.company}): ${m.style}, ä»»èŒ${m.years.toFixed(1)}å¹´, å›æŠ¥${m.careerReturn.toFixed(1)}%, è§„æ¨¡${m.aum.toFixed(0)}äº¿\n`;
  });

  return ctx;
}

const MACRO_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„Aè‚¡å¸‚åœºå®è§‚ç­–ç•¥åˆ†æå¸ˆï¼Œéœ€è¦æ ¹æ®åŸºé‡‘ç»ç†çš„å®é™…æŒä»“å’Œä¸šç»©æ•°æ®ï¼Œç»“åˆä½ å¯¹å½“å‰å®è§‚ç»æµã€å›½é™…å½¢åŠ¿ã€å›½å†…æ”¿ç­–çš„ä¸“ä¸šçŸ¥è¯†ï¼Œç”Ÿæˆä¸€ä»½å…¨é¢çš„å¸‚åœºåˆ†ææŠ¥å‘Šã€‚

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–çš„æ–‡å­—æˆ–markdownæ ‡è®°ï¼š
{
  "period": "èµ·å§‹å¹´æœˆâ€”ç»“æŸå¹´æœˆï¼Œå¦‚2026å¹´2æœˆâ€”5æœˆ",
  "updated": "YYYY-MM-DDæ ¼å¼çš„æ—¥æœŸ",
  "pastYearReview": [
    {"sector": "æ¿å—åç§°", "ret": "+XX%æˆ–-XX%", "icon": "emoji", "highlight": true/false,
     "detail": "100-200å­—æ·±åº¦åˆ†æè¯¥æ¿å—è¿‡å»ä¸€å¹´è¡¨ç°çš„åŸå› å’Œé€»è¾‘"}
  ],
  "intlFactors": [
    {"label": "å› ç´ åç§°", "score": 0-100, "trend": "2-4å­—è¶‹åŠ¿è¯", "cls": "warm/neutral/hot/cold",
     "desc": "80-150å­—æè¿°è¯¥å›½é™…å› ç´ çš„ç°çŠ¶å’Œå½±å“"}
  ],
  "domesticFactors": [
    {"label": "å› ç´ åç§°", "score": 0-100, "trend": "2-4å­—è¶‹åŠ¿è¯", "cls": "warm/neutral/hot/cold",
     "desc": "80-150å­—æè¿°è¯¥å›½å†…å› ç´ çš„ç°çŠ¶å’Œå½±å“"}
  ],
  "sectorRecos": [
    {"sector": "æ¿å—åç§°", "rating": "å¼ºçƒˆæ¨è/æ¨è/é€‚åº¦é…ç½®/è°¨æ…è§‚æœ›/ä½é…",
     "weight": é…ç½®æƒé‡ç™¾åˆ†æ¯”(æ‰€æœ‰weightä¹‹å’Œåº”çº¦ç­‰äº100), "color": "CSSé¢œè‰²å€¼",
     "reason": "100-200å­—é…ç½®ç†ç”±ï¼Œç»“åˆæ•°æ®å’Œå®è§‚é€»è¾‘"}
  ]
}

è¦æ±‚ï¼š
1. pastYearReviewè‡³å°‘åŒ…å«8ä¸ªæ¿å—ï¼ŒæŒ‰æ¶¨å¹…æ’åºï¼Œhighlightæ ‡è®°æ¶¨å¹…å‰3çš„æ¿å—
2. intlFactorsè‡³å°‘åŒ…å«5ä¸ªå›½é™…å› ç´ 
3. domesticFactorsè‡³å°‘åŒ…å«5ä¸ªå›½å†…å› ç´ 
4. sectorRecosè‡³å°‘8ä¸ªæ¿å—ï¼Œweightä¹‹å’Œçº¦ç­‰äº100
5. åˆ†æå¿…é¡»ç»“åˆä½ æä¾›çš„åŸºé‡‘ç»ç†çœŸå®ä¸šç»©æ•°æ®â€”â€”å¦‚æœæŸä¸ªé£æ ¼çš„åŸºé‡‘ç»ç†å›æŠ¥ç‰¹åˆ«é«˜ï¼Œè¯´æ˜è¯¥èµ›é“è¿‡å»è¡¨ç°å¥½ï¼Œä½ åº”è¯¥åœ¨pastYearReviewä¸­ä½“ç°
6. åŸºäºä½ å¯¹å½“å‰Aè‚¡å¸‚åœºã€å…¨çƒç»æµã€åœ°ç¼˜æ”¿æ²»çš„æœ€æ–°ä¸“ä¸šçŸ¥è¯†è¿›è¡Œåˆ†æ
7. åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰å…¶ä»–ä»»ä½•æ–‡å­—`;

async function generateAIMacroOutlook(onProgress){
  if(!_302aiKey) return null;

  const dataCtx = buildManagerDataContext();

  // Use provider-specific models
  const models = _aiProvider.macroModels;

  for(const m of models){
    try {
      if(onProgress) onProgress(`ğŸ§  ${m.name} æ­£åœ¨åˆ†æå®è§‚å½¢åŠ¿...`);

      const userMsg = `è¯·æ ¹æ®ä»¥ä¸‹TOPåŸºé‡‘ç»ç†çš„çœŸå®ä¸šç»©æ•°æ®ï¼Œç»“åˆä½ å¯¹å½“å‰å¸‚åœºçš„ä¸“ä¸šåˆ¤æ–­ï¼Œç”Ÿæˆå®Œæ•´çš„å®è§‚å¸‚åœºåˆ†ææŠ¥å‘Šã€‚

${dataCtx}

è¯·åŸºäºä»¥ä¸Šæ•°æ®å’Œä½ çš„ä¸“ä¸šçŸ¥è¯†ï¼Œåˆ†æï¼š
1. è¿‡å»ä¸€å¹´å„æ¿å—è¡¨ç°å›é¡¾ï¼ˆç»“åˆåŸºé‡‘ç»ç†å®é™…å›æŠ¥æ•°æ®æ¨æ–­æ¿å—è¶‹åŠ¿ï¼‰
2. å½“å‰å›½é™…å½¢åŠ¿å¯¹Aè‚¡çš„å½±å“
3. å›½å†…æ”¿ç­–å’Œç»æµå½¢åŠ¿
4. æœªæ¥3ä¸ªæœˆå„æ¿å—çš„é…ç½®å»ºè®®`;

      const raw = await callAI(m.model, MACRO_SYSTEM_PROMPT, userMsg, 0.6);

      // Parse JSON
      let jsonStr = raw.trim();
      if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if(!jsonMatch) throw new Error('No JSON in response');

      const parsed = JSON.parse(jsonMatch[0]);

      // Validate required fields
      if(!parsed.pastYearReview || !parsed.sectorRecos) throw new Error('Missing required fields');

      if(onProgress) onProgress(`âœ… ${m.name} åˆ†æå®Œæˆ`);
      return parsed;
    } catch(e){
      console.error(`${m.name} macro analysis failed:`, e);
      if(onProgress) onProgress(`âš ï¸ ${m.name} åˆ†æå¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªå¼•æ“...`);
      continue;
    }
  }
  return null; // All models failed
}

// ==================== DATA FETCHING ====================
function setLoadProgress(pct, status){
  document.getElementById('loading-fill').style.width = pct+'%';
  document.getElementById('loading-status').textContent = status;
}

function loadManagerPage(pageNum){
  return new Promise((resolve, reject)=>{
    const script = document.createElement('script');
    const url = `${API_BASE}?dt=14&mc=returnjson&ft=all&pn=${PER_PAGE}&pi=${pageNum}&sc=netnav&st=desc`;
    script.src = url;
    script.onload = ()=>{
      try {
        const data = window.returnjson;
        if(data && data.data) resolve(data.data);
        else resolve([]);
      } catch(e){ resolve([]); }
      script.remove();
    };
    script.onerror = ()=>{ resolve([]); script.remove(); };
    document.head.appendChild(script);
  });
}

async function fetchAllManagers(){
  const allData = [];
  for(let i=1; i<=PAGES_TO_FETCH; i++){
    setLoadProgress(Math.round(i/PAGES_TO_FETCH*70), `æ­£åœ¨è·å–ç¬¬ ${i}/${PAGES_TO_FETCH} é¡µæ•°æ®...`);
    try {
      const data = await loadManagerPage(i);
      if(data.length>0) allData.push(...data);
      else if(i>1) break; // no more data
    } catch(e){}
    await new Promise(r=>setTimeout(r, 200)); // polite delay
  }
  return allData;
}

// ==================== DATA PROCESSING ====================
function classifyStyle(fundNamesStr){
  const t = fundNamesStr || '';
  if(/è´§å¸|ç°é‡‘|ä½™é¢|ç†è´¢|æ·»åˆ©|å¤©å¤©/.test(t) && !/æ··åˆ|è‚¡ç¥¨|çµæ´»/.test(t)) return 'è´§å¸ç†è´¢';
  if(/çº¯å€º|åˆ©ç‡å€º|ä¿¡ç”¨å€º|çŸ­å€º|å®šå¼€å€º|å®šæœŸå¼€æ”¾å€º/.test(t) && !/æ··åˆ|è‚¡ç¥¨|çµæ´»|å¢å¼º/.test(t)) return 'çº¯å€ºå›ºæ”¶';
  if(/é»„é‡‘|ç™½é“¶|è´µé‡‘å±/.test(t)) return 'è´µé‡‘å±';
  if(/æœ‰è‰²|é“œ|é“|é”‚|ç¨€åœŸ|é‡‘å±ææ–™|çŸ¿ä¸š|åŸºæœ¬é‡‘å±/.test(t)) return 'æœ‰è‰²é‡‘å±';
  if(/åŸæ²¹|å•†å“|èµ„æºç²¾é€‰|å¤§å®—/.test(t)) return 'å•†å“èµ„æº';
  if(/QDII|æ¸¯è‚¡|å…¨çƒ|æµ·å¤–|çº³æ–¯è¾¾å…‹|æ ‡æ™®|æ’ç”Ÿ|ä¸­å›½ä¼˜åŠ¿|ç¾å…ƒ/.test(t)) return 'è·¨å¢ƒQDII';
  if(/(æŒ‡æ•°|ETF)/.test(t) && /é‡åŒ–|å¢å¼º|æ™ºé€‰/.test(t)) return 'æŒ‡æ•°é‡åŒ–';
  if(/ç§‘æŠ€|äººå·¥æ™ºèƒ½|èŠ¯ç‰‡|åŠå¯¼ä½“|ç”µå­|è®¡ç®—æœº|é€šä¿¡|ä¿¡æ¯|æ•°å­—ç»æµ|æ™ºèƒ½é©±åŠ¨/.test(t)) return 'ç§‘æŠ€æˆé•¿';
  if(/æ–°èƒ½æº|å…‰ä¼|ç¢³|ç”µæ± |ä½ç¢³|ç¯ä¿/.test(t)) return 'æ–°èƒ½æº';
  if(/å†›å·¥|å›½é˜²|èˆªå¤©|èˆªç©º/.test(t)) return 'å†›å·¥å›½é˜²';
  if(/åŒ»[è¯ç–—]|å¥åº·|ç”Ÿç‰©|åˆ›æ–°è¯/.test(t)) return 'åŒ»è¯å¥åº·';
  if(/åŒ–å·¥|ææ–™|åˆ¶é€ |[å·¥ä¸š]ç²¾é€‰/.test(t) && !/ç”µå­|åŠå¯¼ä½“/.test(t)) return 'åŒ–å·¥ææ–™';
  if(/åŸºå»º|åŸºç¡€è®¾æ–½|ä¸€å¸¦ä¸€è·¯|å·¥ç¨‹|å»ºç­‘|é“è·¯/.test(t)) return 'åŸºç¡€è®¾æ–½';
  if(/å…¬ç”¨äº‹ä¸š|ç”µåŠ›|æ°´åŠ¡|ç‡ƒæ°”|ç¯å¢ƒæ²»ç†/.test(t)) return 'å…¬ç”¨äº‹ä¸š';
  if(/å†œä¸š|ä¹¡æ‘æŒ¯å…´|ç§ä¸š|ç•œç‰§|å†œäº§å“/.test(t)) return 'å†œä¸šé£Ÿå“';
  if(/é‡‘èç§‘æŠ€|é“¶è¡Œ|ä¿é™©|è¯åˆ¸|é‡‘èåœ°äº§/.test(t) && /æŒ‡æ•°|ETF|ä¸»é¢˜/.test(t)) return 'é‡‘è';
  if(/åœ°äº§|REITs|ä¸åŠ¨äº§|åŸå¸‚æ›´æ–°/.test(t)) return 'åœ°äº§REITs';
  if(/æ¶ˆè´¹|é£Ÿå“|ç™½é…’|é›¶å”®|å®¶ç”µ|é¥®æ–™|æ–‡ä½“/.test(t)) return 'æ¶ˆè´¹';
  if(/çº¢åˆ©|ä½æ³¢|è‚¡æ¯|åˆ†çº¢/.test(t)) return 'çº¢åˆ©ä»·å€¼';
  if(/ä»·å€¼|è“ç­¹|å¤§ç›˜ç²¾é€‰/.test(t)) return 'ä»·å€¼è“ç­¹';
  if(/æˆé•¿|åˆ›æ–°|å…ˆé”‹|æ–°å…´|è½¬å‹|åŠ¨åŠ›/.test(t)) return 'æˆé•¿';
  if(/å‘¨æœŸ|é’¢é“|ç…¤ç‚­/.test(t)) return 'å‘¨æœŸ';
  if(/FOF|æŒæœ‰æœŸæ··åˆå‘èµ·\(FOF\)/.test(t)) return 'FOFé…ç½®';
  if(/å€ºåˆ¸|å¢å¼º|å›ºæ”¶|æ·»åˆ©|ç¨³å¥/.test(t)) return 'å›ºæ”¶å¢å¼º';
  if(/(æŒ‡æ•°|ETF|LOF)/.test(t)) return 'æŒ‡æ•°é‡åŒ–';
  return 'çµæ´»é…ç½®';
}

function parseManager(row){
  if(!row || row.length<12) return null;
  const careerReturnStr = (row[7]||'0').replace('%','');
  const careerReturn = parseFloat(careerReturnStr)||0;
  const aumStr = (row[10]||'0').replace('äº¿å…ƒ','');
  const aum = parseFloat(aumStr)||0;
  const workDays = parseInt(row[6])||0;
  const years = Math.round(workDays/365*10)/10;
  const bestReturnStr = (row[11]||'0').replace('%','');
  const bestReturn = parseFloat(bestReturnStr)||0;
  const fundNames = row[5]||'';
  return {
    id: row[0],
    name: row[1],
    companyId: row[2],
    company: row[3],
    fundCodes: (row[4]||'').split(',').filter(Boolean),
    fundNames: fundNames.split(',').filter(Boolean),
    fundNamesStr: fundNames,
    workDays, years,
    careerReturn,
    bestFundCode: row[8]||'',
    bestFundName: row[9]||'',
    aum, bestReturn,
    style: classifyStyle(fundNames)
  };
}

function processManagers(rawData){
  const parsed = rawData.map(parseManager).filter(Boolean);
  // Deduplicate by manager name + company (some appear on multiple pages)
  const seen = new Set();
  const unique = [];
  parsed.forEach(m=>{
    const key = m.name + '|' + m.company;
    if(!seen.has(key)){ seen.add(key); unique.push(m); }
  });
  allManagers = unique;
  // Filter to equity/mixed managers (exclude pure money market and pure bonds)
  filteredManagers = unique.filter(m=>
    m.style !== 'è´§å¸ç†è´¢' && m.style !== 'çº¯å€ºå›ºæ”¶'
  );
  // Sort by career return descending
  filteredManagers.sort((a,b)=>b.careerReturn - a.careerReturn);
  // Take top 500
  if(filteredManagers.length>500) filteredManagers = filteredManagers.slice(0,500);
  return filteredManagers;
}

// ==================== ANALYSIS ENGINE ====================
function median(arr){ const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; }
function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
function pct(arr, p){ const s=[...arr].sort((a,b)=>a-b); const i=Math.floor(s.length*p/100); return s[Math.min(i,s.length-1)]; }

function runAnalysis(managers){
  const a = {};
  
  // Overview stats
  const returns = managers.map(m=>m.careerReturn);
  const aums = managers.map(m=>m.aum);
  const years = managers.map(m=>m.years);
  a.overview = {
    count: managers.length,
    totalManagers: allManagers.length,
    avgReturn: mean(returns),
    medianReturn: median(returns),
    maxReturn: Math.max(...returns),
    minReturn: Math.min(...returns),
    avgYears: mean(years),
    medianAUM: median(aums),
    totalAUM: aums.reduce((s,v)=>s+v,0),
    positiveCount: returns.filter(r=>r>0).length,
    over100Count: returns.filter(r=>r>100).length,
    over200Count: returns.filter(r=>r>200).length,
  };
  
  // Strategy distribution
  const styleCounts = {};
  const styleReturns = {};
  const styleAUM = {};
  managers.forEach(m=>{
    const s = m.style;
    styleCounts[s] = (styleCounts[s]||0) + 1;
    if(!styleReturns[s]) styleReturns[s] = [];
    styleReturns[s].push(m.careerReturn);
    if(!styleAUM[s]) styleAUM[s] = [];
    styleAUM[s].push(m.aum);
  });
  a.styles = Object.keys(styleCounts)
    .map(s=>({
      style: s,
      count: styleCounts[s],
      pct: (styleCounts[s]/managers.length*100),
      avgReturn: mean(styleReturns[s]),
      medianReturn: median(styleReturns[s]),
      avgAUM: mean(styleAUM[s]),
      bestManager: managers.filter(m=>m.style===s).sort((a,b)=>b.careerReturn-a.careerReturn)[0]
    }))
    .sort((a,b)=>b.count-a.count);
  
  // Company analysis
  const companyMap = {};
  managers.forEach(m=>{
    if(!companyMap[m.company]) companyMap[m.company] = [];
    companyMap[m.company].push(m);
  });
  a.companies = Object.keys(companyMap)
    .map(c=>({
      company: c,
      count: companyMap[c].length,
      avgReturn: mean(companyMap[c].map(m=>m.careerReturn)),
      bestManager: companyMap[c].sort((a,b)=>b.careerReturn-a.careerReturn)[0],
      totalAUM: companyMap[c].reduce((s,m)=>s+m.aum,0)
    }))
    .sort((a,b)=>b.count-a.count);
  
  // Experience analysis
  const expBrackets = [
    {label:'0-3å¹´',min:0,max:3},
    {label:'3-5å¹´',min:3,max:5},
    {label:'5-8å¹´',min:5,max:8},
    {label:'8-12å¹´',min:8,max:12},
    {label:'12-20å¹´',min:12,max:20},
    {label:'20å¹´+',min:20,max:99}
  ];
  a.experience = expBrackets.map(b=>{
    const group = managers.filter(m=>m.years>=b.min && m.years<b.max);
    return {
      ...b,
      count: group.length,
      avgReturn: group.length>0 ? mean(group.map(m=>m.careerReturn)) : 0,
      avgAUM: group.length>0 ? mean(group.map(m=>m.aum)) : 0,
    };
  });
  
  // Return distribution
  const retBrackets = [
    {label:'<0%',min:-999,max:0},
    {label:'0-20%',min:0,max:20},
    {label:'20-50%',min:20,max:50},
    {label:'50-100%',min:50,max:100},
    {label:'100-200%',min:100,max:200},
    {label:'200%+',min:200,max:9999}
  ];
  a.returnDist = retBrackets.map(b=>{
    const count = managers.filter(m=>m.careerReturn>=b.min && m.careerReturn<b.max).length;
    return {...b, count, pct: count/managers.length*100};
  });
  
  return a;
}

// ==================== INSIGHTS GENERATOR ====================
function generateInsights(a, managers){
  const insights = [];
  
  // Style concentration
  const topStyle = a.styles[0];
  const top3Styles = a.styles.slice(0,3);
  const top3Pct = top3Styles.reduce((s,v)=>s+v.pct,0);
  insights.push({
    icon:'ğŸ¯', title:'é£æ ¼é›†ä¸­åº¦',
    body:`å‰ä¸‰å¤§æŠ•èµ„é£æ ¼ï¼ˆ${top3Styles.map(s=>s.style).join('ã€')}ï¼‰å æ¯” <b>${top3Pct.toFixed(1)}%</b>ï¼Œæ˜¾ç¤ºå‡ºæ˜æ˜¾çš„é£æ ¼é›†ä¸­æ•ˆåº”ã€‚${topStyle.style}å æ¯”æœ€é«˜(${topStyle.pct.toFixed(1)}%)ï¼Œåæ˜ å‡ºå½“å‰å¸‚åœºå¯¹è¯¥é¢†åŸŸçš„é«˜åº¦å…³æ³¨ã€‚`
  });
  
  // Performance dispersion
  const bestStyle = [...a.styles].sort((a,b)=>b.avgReturn-a.avgReturn)[0];
  const worstStyle = [...a.styles].filter(s=>s.count>=5).sort((a,b)=>a.avgReturn-b.avgReturn)[0];
  if(bestStyle && worstStyle){
    insights.push({
      icon:'ğŸ“Š', title:'ç­–ç•¥å›æŠ¥å·®å¼‚',
      body:`è¡¨ç°æœ€ä½³çš„é£æ ¼æ˜¯ <b>${bestStyle.style}</b>ï¼ˆå¹³å‡å›æŠ¥${bestStyle.avgReturn.toFixed(1)}%ï¼‰ï¼Œæœ€å¼±çš„æ˜¯ <b>${worstStyle.style}</b>ï¼ˆ${worstStyle.avgReturn.toFixed(1)}%ï¼‰ï¼Œå·®è·è¾¾ <b>${(bestStyle.avgReturn-worstStyle.avgReturn).toFixed(1)}ä¸ªç™¾åˆ†ç‚¹</b>ã€‚é€‰å¯¹èµ›é“æ¯”é€‰äººæ›´é‡è¦ã€‚`
    });
  }
  
  // Experience sweet spot
  const bestExpBracket = [...a.experience].filter(b=>b.count>=10).sort((a,b)=>b.avgReturn-a.avgReturn)[0];
  if(bestExpBracket){
    insights.push({
      icon:'â°', title:'ç»éªŒç”œèœœç‚¹',
      body:`<b>${bestExpBracket.label}</b>ä»ä¸šç»éªŒçš„åŸºé‡‘ç»ç†å¹³å‡å›æŠ¥æœ€é«˜(${bestExpBracket.avgReturn.toFixed(1)}%)ï¼Œå…±${bestExpBracket.count}äººã€‚è¯´æ˜åœ¨è¿™ä¸ªé˜¶æ®µç»ç†å…¼å…·ç»éªŒç§¯ç´¯å’Œè¿›å–å¿ƒï¼Œå¾€å¾€èƒ½äº§å‡ºæœ€ä½³ä¸šç»©ã€‚`
    });
  }
  
  // Company effect
  const topCompanies = a.companies.filter(c=>c.count>=5).sort((a,b)=>b.avgReturn-a.avgReturn).slice(0,3);
  if(topCompanies.length>=3){
    insights.push({
      icon:'ğŸ¢', title:'å…¬å¸å¹³å°æ•ˆåº”',
      body:`å¹³å‡å›æŠ¥æœ€é«˜çš„åŸºé‡‘å…¬å¸ï¼š<b>${topCompanies.map(c=>`${c.company}(${c.avgReturn.toFixed(1)}%)`).join('ã€')}</b>ã€‚ä¼˜ç§€çš„æŠ•ç ”å¹³å°å¯¹åŸºé‡‘ç»ç†ä¸šç»©æœ‰æ˜¾è‘—æ­£å‘å½±å“ã€‚`
    });
  }
  
  // Survival ratio  
  const posRatio = (a.overview.positiveCount/a.overview.count*100).toFixed(1);
  insights.push({
    icon:'ğŸ’ª', title:'èƒœç‡åˆ†æ',
    body:`${a.overview.count}ä½æƒç›Šç±»åŸºé‡‘ç»ç†ä¸­ï¼Œ<b>${a.overview.positiveCount}ä½(${posRatio}%)</b>å®ç°äº†æ­£å›æŠ¥ã€‚${a.overview.over100Count}ä½(${(a.overview.over100Count/a.overview.count*100).toFixed(1)}%)èŒä¸šå›æŠ¥è¶…100%ï¼Œ${a.overview.over200Count}ä½è¶…200%ã€‚`
  });
  
  // Herd behavior
  const techManagers = managers.filter(m=>m.style==='ç§‘æŠ€æˆé•¿'||m.style==='æŒ‡æ•°é‡åŒ–'||m.style==='æ–°èƒ½æº');
  const herdPct = (techManagers.length/managers.length*100).toFixed(1);
  insights.push({
    icon:'ğŸ‘', title:'ç¾Šç¾¤æ•ˆåº”',
    body:`ç§‘æŠ€æˆé•¿+æŒ‡æ•°é‡åŒ–+æ–°èƒ½æºåˆè®¡å  <b>${herdPct}%</b>ï¼Œæ˜¾ç¤ºåŸºé‡‘ç»ç†å¯¹æˆé•¿æ€§èµ›é“çš„æ‰å †ç¨‹åº¦è¾ƒé«˜ã€‚è¿™æ„å‘³ç€ä¸‹è·Œæ—¶è¸©è¸é£é™©å¤§ï¼Œä½†ä¹Ÿè¯´æ˜äº§ä¸šè¶‹åŠ¿çš„é«˜ç¡®å®šæ€§ã€‚`
  });
  
  // Contrarian opportunity
  const underFollowed = a.styles.filter(s=>s.count>=3 && s.count<=a.styles[0].count*0.3 && s.avgReturn>a.overview.avgReturn);
  if(underFollowed.length>0){
    insights.push({
      icon:'ğŸ”', title:'é€†å‘æœºä¼š',
      body:`ä»¥ä¸‹é£æ ¼"äººå°‘é’±å¤š"ï¼š<b>${underFollowed.map(s=>`${s.style}(${s.count}äººï¼Œå‡å›${s.avgReturn.toFixed(1)}%)`).join('ã€')}</b>ã€‚ä½æ‹¥æŒ¤åº¦+é«˜å›æŠ¥å¯èƒ½æš—ç¤ºè¢«å¿½è§†çš„æŠ•èµ„æœºä¼šã€‚`
    });
  }
  
  return insights;
}

// ==================== RENDERING ====================
function fmt(n, d=1){ return n.toFixed(d); }
function fmtAUM(n){ return n>=10000?fmt(n/10000,1)+'ä¸‡äº¿':n>=1?fmt(n,0)+'äº¿':fmt(n*100,0)+'ç™¾ä¸‡'; }

function renderAll(){
  const el = document.getElementById('main-content');
  let html = '';
  
  html += renderOverview();
  html += renderDailyPerformance();
  html += renderMarketReview();
  html += renderStrategy();
  html += renderCompany();
  html += renderExperience();
  html += renderInsights();
  html += renderDataDiscovery();
  html += renderLTValue();
  html += renderCycleAnalysis();
  html += renderPortfolio();
  html += renderDCA();
  html += renderOutlook();
  html += renderRecommendations();
  html += renderSummary();
  
  el.innerHTML = html;
}

function renderOverview(){
  const o = analysis.overview;
  return `<div class="section" id="sec-overview">
    <div class="sec-header"><span class="sec-icon">ğŸ“Š</span><span class="sec-title">æ•°æ®æ¦‚è§ˆ</span><span class="sec-badge">TOP ${o.count}</span></div>
    <div class="sec-body">
      <div class="metrics">
        <div class="metric"><div class="m-val">${o.count}</div><div class="m-label">æƒç›Šç±»åŸºé‡‘ç»ç†</div></div>
        <div class="metric"><div class="m-val">${o.totalManagers}</div><div class="m-label">å…¨é‡åŸºé‡‘ç»ç†</div></div>
        <div class="metric"><div class="m-val">${fmt(o.avgReturn)}%</div><div class="m-label">å¹³å‡ä»»èŒå›æŠ¥</div></div>
        <div class="metric"><div class="m-val">${fmt(o.medianReturn)}%</div><div class="m-label">ä¸­ä½æ•°å›æŠ¥</div></div>
      </div>
      <div class="metrics tri">
        <div class="metric"><div class="m-val">${fmt(o.avgYears)}</div><div class="m-label">å¹³å‡ä»ä¸š(å¹´)</div></div>
        <div class="metric"><div class="m-val">${fmtAUM(o.totalAUM)}</div><div class="m-label">æ€»ç®¡ç†è§„æ¨¡</div></div>
        <div class="metric"><div class="m-val">${fmt(o.maxReturn)}%</div><div class="m-label">æœ€é«˜å›æŠ¥</div></div>
      </div>
      <div style="font-size:11px;font-weight:600;margin:10px 0 6px;color:var(--sub)">å›æŠ¥åˆ†å¸ƒ</div>
      <div class="bar-chart">${analysis.returnDist.map(b=>{
        const w = Math.max(b.pct/Math.max(...analysis.returnDist.map(x=>x.pct))*100,2);
        const color = b.min>=100?'#ef4444':b.min>=50?'#f97316':b.min>=20?'#eab308':b.min>=0?'#22c55e':'#94a3b8';
        return `<div class="bar-row"><div class="bar-label">${b.label}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${b.count}</span></div></div><div class="bar-val">${fmt(b.pct)}%</div></div>`;
      }).join('')}</div>
    </div>
  </div>`;
}

function renderStrategy(){
  const styles = analysis.styles;
  const total = filteredManagers.length;
  // Donut chart data
  const topN = styles.slice(0,8);
  const otherCount = styles.slice(8).reduce((s,v)=>s+v.count,0);
  const slices = [...topN];
  if(otherCount>0) slices.push({style:'å…¶ä»–',count:otherCount,pct:otherCount/total*100,avgReturn:0});
  let cumPct = 0;
  const gradientParts = slices.map(s=>{
    const color = STYLE_COLORS[s.style]||'#9ca3af';
    const start = cumPct;
    cumPct += s.pct;
    return `${color} ${start}% ${cumPct}%`;
  });
  
  return `<div class="section" id="sec-strategy">
    <div class="sec-header"><span class="sec-icon">ğŸ¯</span><span class="sec-title">æŠ•èµ„é£æ ¼åˆ†æ</span><span class="sec-badge">${styles.length}ç§</span></div>
    <div class="sec-body">
      <div class="donut-wrap">
        <div class="donut" style="background:conic-gradient(${gradientParts.join(',')})">
          <div class="donut-center"><div class="dc-val">${styles.length}</div><div class="dc-label">æŠ•èµ„é£æ ¼</div></div>
        </div>
        <div class="donut-legend">${slices.slice(0,8).map(s=>`<div class="legend-item"><div class="legend-dot" style="background:${STYLE_COLORS[s.style]||'#9ca3af'}"></div><div class="legend-name">${s.style}</div><div class="legend-pct">${fmt(s.pct)}%</div></div>`).join('')}</div>
      </div>
      <div style="font-size:11px;font-weight:600;margin:10px 0 6px;color:var(--sub)">å„é£æ ¼å¹³å‡å›æŠ¥å¯¹æ¯”</div>
      <div class="bar-chart">${[...styles].sort((a,b)=>b.avgReturn-a.avgReturn).slice(0,12).map(s=>{
        const maxR = Math.max(...styles.map(x=>Math.abs(x.avgReturn)));
        const w = Math.max(Math.abs(s.avgReturn)/maxR*100,2);
        const color = STYLE_COLORS[s.style]||'#9ca3af';
        return `<div class="bar-row"><div class="bar-label">${s.style}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${s.count}äºº</span></div></div><div class="bar-val" style="color:${s.avgReturn>=0?'var(--up)':'var(--down)'}">${s.avgReturn>=0?'+':''}${fmt(s.avgReturn)}%</div></div>`;
      }).join('')}</div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 6px;color:var(--sub)">é£æ ¼è¯¦æƒ…è¡¨</div>
      <div style="overflow-x:auto">
      <table class="tbl">
        <tr><th>é£æ ¼</th><th>ç»ç†æ•°</th><th>å¹³å‡å›æŠ¥</th><th>ä¸­ä½æ•°</th><th>æœ€ä½³ç»ç†</th></tr>
        ${styles.filter(s=>s.count>=2).map(s=>`<tr>
          <td><span class="t-tag" style="background:${STYLE_COLORS[s.style]||'#f1f5f9'}20;color:${STYLE_COLORS[s.style]||'#9ca3af'}">${s.style}</span></td>
          <td>${s.count}</td>
          <td class="${s.avgReturn>=0?'t-up':'t-down'}">${s.avgReturn>=0?'+':''}${fmt(s.avgReturn)}%</td>
          <td>${fmt(s.medianReturn)}%</td>
          <td class="t-name">${s.bestManager?s.bestManager.name:'-'}</td>
        </tr>`).join('')}
      </table></div>
    </div>
  </div>`;
}

function renderCompany(){
  const companies = analysis.companies;
  const byCount = companies.slice(0,15);
  const byReturn = [...companies].filter(c=>c.count>=3).sort((a,b)=>b.avgReturn-a.avgReturn).slice(0,12);
  const maxCount = Math.max(...byCount.map(c=>c.count));
  const maxRet = Math.max(...byReturn.map(c=>Math.abs(c.avgReturn)));
  
  return `<div class="section" id="sec-company">
    <div class="sec-header"><span class="sec-icon">ğŸ¢</span><span class="sec-title">åŸºé‡‘å…¬å¸åˆ†æ</span><span class="sec-badge">${companies.length}å®¶</span></div>
    <div class="sec-tabs">
      <div class="sec-tab active" onclick="switchCompanyTab('count',this)">æŒ‰ç»ç†æ•°é‡</div>
      <div class="sec-tab" onclick="switchCompanyTab('return',this)">æŒ‰å¹³å‡å›æŠ¥</div>
    </div>
    <div class="sec-body">
      <div id="company-count">
        <div class="bar-chart">${byCount.map(c=>{
          const w = c.count/maxCount*100;
          return `<div class="bar-row"><div class="bar-label">${c.company.replace('åŸºé‡‘','').replace('ç®¡ç†','')}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:linear-gradient(90deg,var(--gold),#f59e0b)"><span>${c.count}äºº</span></div></div><div class="bar-val">${fmt(c.avgReturn)}%</div></div>`;
        }).join('')}</div>
      </div>
      <div id="company-return" style="display:none">
        <div class="bar-chart">${byReturn.map(c=>{
          const w = Math.abs(c.avgReturn)/maxRet*100;
          const color = c.avgReturn>=0?'var(--up)':'var(--down)';
          return `<div class="bar-row"><div class="bar-label">${c.company.replace('åŸºé‡‘','').replace('ç®¡ç†','')}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${c.count}äºº</span></div></div><div class="bar-val" style="color:${color}">${c.avgReturn>=0?'+':''}${fmt(c.avgReturn)}%</div></div>`;
        }).join('')}</div>
      </div>
    </div>
  </div>`;
}

function renderExperience(){
  const exp = analysis.experience;
  const maxCount = Math.max(...exp.map(e=>e.count));
  const maxRet = Math.max(...exp.filter(e=>e.count>0).map(e=>Math.abs(e.avgReturn)));
  
  return `<div class="section" id="sec-experience">
    <div class="sec-header"><span class="sec-icon">ğŸ“ˆ</span><span class="sec-title">ç»éªŒä¸å›æŠ¥</span></div>
    <div class="sec-body">
      <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--sub)">å„ç»éªŒæ®µäººæ•°åˆ†å¸ƒ</div>
      <div class="bar-chart">${exp.map(e=>{
        const w = e.count>0?e.count/maxCount*100:0;
        return `<div class="bar-row"><div class="bar-label">${e.label}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:linear-gradient(90deg,#6366f1,#8b5cf6)"><span>${e.count}</span></div></div><div class="bar-val">${e.count}äºº</div></div>`;
      }).join('')}</div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 8px;color:var(--sub)">å„ç»éªŒæ®µå¹³å‡å›æŠ¥</div>
      <div class="bar-chart">${exp.filter(e=>e.count>0).map(e=>{
        const w = Math.abs(e.avgReturn)/maxRet*100;
        const color = e.avgReturn>=0?'var(--up)':'var(--down)';
        return `<div class="bar-row"><div class="bar-label">${e.label}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${fmt(e.avgReturn)}%</span></div></div><div class="bar-val" style="color:${color}">${e.avgReturn>=0?'+':''}${fmt(e.avgReturn)}%</div></div>`;
      }).join('')}</div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 8px;color:var(--sub)">å„ç»éªŒæ®µå¹³å‡ç®¡ç†è§„æ¨¡</div>
      <div class="bar-chart">${exp.filter(e=>e.count>0).map(e=>{
        const maxAUM = Math.max(...exp.filter(x=>x.count>0).map(x=>x.avgAUM));
        const w = e.avgAUM/maxAUM*100;
        return `<div class="bar-row"><div class="bar-label">${e.label}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:linear-gradient(90deg,#f59e0b,#fbbf24)"><span>${fmtAUM(e.avgAUM)}</span></div></div><div class="bar-val">${fmtAUM(e.avgAUM)}</div></div>`;
      }).join('')}</div>
    </div>
  </div>`;
}

function renderInsights(){
  const insights = generateInsights(analysis, filteredManagers);
  return `<div class="section" id="sec-insights">
    <div class="sec-header"><span class="sec-icon">ğŸ’¡</span><span class="sec-title">è¡Œä¸ºæ´å¯Ÿ</span><span class="sec-badge">${insights.length}é¡¹å‘ç°</span></div>
    <div class="sec-body">
      ${insights.map(i=>`<div class="insight"><div class="i-title">${i.icon} ${i.title}</div><div class="i-body">${i.body}</div></div>`).join('')}
    </div>
  </div>`;
}

// ==================== MARKET REVIEW (PAST 1 YEAR) ====================
function renderMarketReview(){
  const m = MACRO_OUTLOOK;
  const review = m.pastYearReview;
  
  // Compute actual data: what styles performed best among our managers (annualized return)
  const stylePerf = {};
  filteredManagers.forEach(mg=>{
    if(!stylePerf[mg.style]) stylePerf[mg.style] = {returns:[], aums:[], count:0};
    stylePerf[mg.style].returns.push(mg.careerReturn);
    stylePerf[mg.style].aums.push(mg.aum);
    stylePerf[mg.style].count++;
  });
  const stylePerfArr = Object.keys(stylePerf)
    .filter(s=>stylePerf[s].count>=3)
    .map(s=>({
      style: s,
      count: stylePerf[s].count,
      avgReturn: mean(stylePerf[s].returns),
      avgAUM: mean(stylePerf[s].aums),
      topReturn: Math.max(...stylePerf[s].returns)
    }))
    .sort((a,b)=>b.avgReturn-a.avgReturn);
  
  let html = `<div class="section" id="sec-review">
    <div class="sec-header"><span class="sec-icon">ğŸ“‹</span><span class="sec-title">è¿‡å»ä¸€å¹´å¸‚åœºå›é¡¾</span><span class="sec-badge">2025.2-2026.2</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        å›é¡¾è¿‡å»ä¸€å¹´å„æ¿å—è¡¨ç°æ˜¯åˆ¶å®šä¸­é•¿çº¿ç­–ç•¥çš„åŸºç¡€ã€‚æˆ‘ä»¬ä¸æ˜¯"è¿½æ¶¨"ï¼Œè€Œæ˜¯è¦è¯†åˆ«<b>è¶‹åŠ¿æ˜¯å¦å¯æŒç»­</b>â€”â€”åªæœ‰ä¾›éœ€æ ¼å±€ã€äº§ä¸šé€»è¾‘ã€æ”¿ç­–æ”¯æŒä¸‰è€…å…±æŒ¯çš„æ¿å—ï¼Œæ‰å€¼å¾—ä¸­é•¿çº¿é…ç½®ã€‚
      </div>
      
      <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--sub)">ğŸ“Š å„æ¿å—æ¶¨è·Œå¹…æ’å</div>`;
  
  review.sort((a,b)=>{
    const ra = parseFloat(a.ret.replace('%','').replace('+',''));
    const rb = parseFloat(b.ret.replace('%','').replace('+',''));
    return rb-ra;
  });
  
  const maxRet = Math.max(...review.map(r=>Math.abs(parseFloat(r.ret.replace('%','').replace('+','')))));
  
  html += `<div class="bar-chart">`;
  review.forEach(r=>{
    const val = parseFloat(r.ret.replace('%','').replace('+',''));
    const w = Math.abs(val)/maxRet*100;
    const color = val>=30?'#ef4444':val>=15?'#f59e0b':val>=0?'#22c55e':'#6366f1';
    html += `<div class="bar-row">
      <div class="bar-label" style="font-weight:${r.highlight?'700':'500'}">${r.icon} ${r.sector}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${r.ret}</span></div></div>
      <div class="bar-val" style="color:${color};font-weight:700">${r.ret}</div>
    </div>`;
  });
  html += `</div>`;
  
  // Detail cards for top performers
  html += `<div style="font-size:11px;font-weight:600;margin:14px 0 8px;color:var(--sub)">ğŸ”¥ å¼ºåŠ¿æ¿å—æ·±åº¦å¤ç›˜</div>`;
  review.filter(r=>r.highlight).forEach(r=>{
    html += `<div class="insight" style="border-left:3px solid #d97706;background:#fffbeb">
      <div class="i-title">${r.icon} ${r.sector} ${r.ret}</div>
      <div class="i-body">${r.detail}</div>
    </div>`;
  });
  
  // Weak sectors
  html += `<div style="font-size:11px;font-weight:600;margin:14px 0 8px;color:var(--sub)">ğŸ’¤ å¼±åŠ¿/éœ‡è¡æ¿å—æ¦‚è§ˆ</div>`;
  review.filter(r=>!r.highlight).forEach(r=>{
    html += `<div style="padding:6px 10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:10px;line-height:1.5">
      <b>${r.icon} ${r.sector} <span style="color:${parseFloat(r.ret)>=0?'var(--up)':'var(--down)'}"> ${r.ret}</span></b>ï¼š${r.detail}
    </div>`;
  });
  
  // Cross-reference with our data: which styles' managers performed best
  html += `<div style="font-size:11px;font-weight:600;margin:14px 0 8px;color:var(--sub)">ğŸ“ˆ TOP500ç»ç†å„é£æ ¼å†å²ä¸šç»©ï¼ˆå°è¯å¸‚åœºè¶‹åŠ¿ï¼‰</div>`;
  html += `<div class="bar-chart">`;
  stylePerfArr.slice(0,10).forEach(s=>{
    const w = s.avgReturn>0 ? Math.min(s.avgReturn/stylePerfArr[0].avgReturn*100,100) : 5;
    const color = STYLE_COLORS[s.style]||'#9ca3af';
    const isMetal = s.style==='æœ‰è‰²é‡‘å±'||s.style==='è´µé‡‘å±'||s.style==='å•†å“èµ„æº';
    html += `<div class="bar-row">
      <div class="bar-label" style="font-weight:${isMetal?'700':'500'};color:${isMetal?'#d97706':'inherit'}">${s.style}${isMetal?' ğŸ”¥':''}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${s.count}äºº</span></div></div>
      <div class="bar-val">${fmt(s.avgReturn)}%</div>
    </div>`;
  });
  html += `</div>`;
  
  // Dynamic review conclusion based on data
  const topSectors = review.filter(r=>r.highlight).map(r=>r.sector);
  const weakSectors = review.filter(r=>{const v=parseFloat(r.ret.replace('%','').replace('+','')); return v<5;});
  html += `<div class="insight">
    <div class="i-title">ğŸ¯ å¤ç›˜ç»“è®ºï¼šä¸­é•¿çº¿æŠ•èµ„è€…åº”å¦‚ä½•çœ‹å¾…è¿‡å»ä¸€å¹´</div>
    <div class="i-body">`;
  review.filter(r=>r.highlight).forEach((r,i)=>{
    html += `<b>â‘  ${r.sector}(${r.ret})</b>ï¼š${r.detail.slice(0,80)}...<br>`;
  });
  if(weakSectors.length>0){
    html += `<b>âš ï¸ å¼±åŠ¿æ¿å—ï¼š</b>${weakSectors.map(r=>`${r.sector}(${r.ret})`).join('ã€')}ã€‚å¼±åŠ¿æ¿å—è¦æœ‰é€†å‘å¸ƒå±€æ„è¯†ï¼Œä½†éœ€ç­‰å¾…æ‹ç‚¹ä¿¡å·ç¡®è®¤ã€‚<br>`;
  }
  html += `<b>ğŸ“Œ æ ¸å¿ƒåŸåˆ™ï¼š</b>ä¸è¿½é«˜ã€ä¸æ€¥äºæŠ„åº•å¼±åŠ¿æ¿å—ï¼Œåªä¹°è¶‹åŠ¿å…±æŒ¯ï¼ˆä¾›éœ€+äº§ä¸š+æ”¿ç­–ï¼‰çš„æ–¹å‘ã€‚`;
  html += `</div>
  </div>`;
  
  html += `</div></div>`;
  return html;
}

function renderOutlook(){
  const m = MACRO_OUTLOOK;
  
  // Render past year review as part of the outlook section
  const aiTag2 = aiMacroGenerated ? '<span style="font-size:9px;background:#3b82f6;color:white;padding:1px 6px;border-radius:4px;margin-left:6px">AIåˆ†æ</span>' : '<span style="font-size:9px;background:#94a3b8;color:white;padding:1px 6px;border-radius:4px;margin-left:6px">é»˜è®¤æ•°æ®</span>';
  let html = `<div class="section" id="sec-outlook">
    <div class="sec-header"><span class="sec-icon">ğŸ”®</span><span class="sec-title">æœªæ¥ä¸‰ä¸ªæœˆå‰ç»${aiTag2}</span><span class="sec-badge">${m.period}</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        ${aiMacroGenerated?'æœ¬èŠ‚å†…å®¹ç”±AIåŸºäºTOPåŸºé‡‘ç»ç†ä¸šç»©æ•°æ® + å®è§‚ç»æµä¸“ä¸šåˆ¤æ–­ç”Ÿæˆã€‚':''}ç»¼åˆ<b>å›½é™…å½¢åŠ¿</b>ã€<b>å›½å†…æ”¿ç­–</b>ã€<b>è¿‡å»1å¹´æ¿å—è¡¨ç°</b>å’Œ<b>TOPåŸºé‡‘ç»ç†æŒä»“åå¥½</b>ï¼Œå¯¹æœªæ¥3ä¸ªæœˆå¸‚åœºæ ¼å±€è¿›è¡Œå‰ç»åˆ†æã€‚
      </div>
      
      <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--sub)">ğŸŒ å›½é™…å½¢åŠ¿è¯„ä¼°</div>
      ${m.intlFactors.map(f=>{
        const color = f.score>=75?'#ef4444':f.score>=60?'#f59e0b':f.score>=45?'#8b5cf6':'#64748b';
        return `<div class="outlook-factor">
          <div class="of-label">${f.label}</div>
          <div class="of-bar"><div class="of-fill" style="width:${f.score}%;background:${color}"></div></div>
          <div class="of-score" style="color:${color}">${f.score}</div>
          <div class="of-trend ${f.cls}">${f.trend}</div>
        </div>
        <div style="font-size:9px;color:var(--sub);padding:0 0 6px 68px;line-height:1.4">${f.desc}</div>`;
      }).join('')}
      
      <div style="font-size:11px;font-weight:600;margin:16px 0 8px;color:var(--sub)">ğŸ‡¨ğŸ‡³ å›½å†…å½¢åŠ¿è¯„ä¼°</div>
      ${m.domesticFactors.map(f=>{
        const color = f.score>=75?'#ef4444':f.score>=60?'#f59e0b':f.score>=45?'#8b5cf6':'#64748b';
        return `<div class="outlook-factor">
          <div class="of-label">${f.label}</div>
          <div class="of-bar"><div class="of-fill" style="width:${f.score}%;background:${color}"></div></div>
          <div class="of-score" style="color:${color}">${f.score}</div>
          <div class="of-trend ${f.cls}">${f.trend}</div>
        </div>
        <div style="font-size:9px;color:var(--sub);padding:0 0 6px 68px;line-height:1.4">${f.desc}</div>`;
      }).join('')}
      
      ${(() => {
        // Dynamic core insight based on top sector recommendations
        const topRecos = m.sectorRecos.filter(s=>s.rating.includes('å¼ºçƒˆ')).slice(0,2);
        if(topRecos.length>0){
          const topS = topRecos[0];
          return `<div class="insight" style="margin:12px 0 8px;background:linear-gradient(135deg,#fef3c7,#fffbeb);border-left:3px solid #d97706">
            <div class="i-title">ğŸ”¥ æ ¸å¿ƒåˆ¤æ–­ï¼š${topRecos.map(s=>s.sector).join(' + ')} â€” ä¸ºä½•é‡ç‚¹é…ç½®</div>
            <div class="i-body">${topRecos.map(s=>`<b>${s.sector}(é…ç½®${s.weight}%)ï¼š</b>${s.reason}`).join('<br><br>')}</div>
          </div>`;
        }
        return '';
      })()}
      
      <div style="font-size:11px;font-weight:600;margin:16px 0 8px;color:var(--sub)">ğŸ“Š æ¿å—é…ç½®å»ºè®®ï¼ˆåŸºäºå…¨é¢åˆ†æï¼‰</div>
      ${m.sectorRecos.map(s=>{
        const ratingCls = s.rating.includes('å¼ºçƒˆ')?'strong':s.rating.includes('æ¨è')||s.rating.includes('é€‚åº¦')?'ok':'weak';
        return `<div class="alloc-row">
          <div class="alloc-sector">${s.sector}</div>
          <div class="alloc-bar"><div class="alloc-fill" style="width:${s.weight*2.5}%;background:${s.color}"><span>${s.weight}%</span></div></div>
          <div class="alloc-rating ${ratingCls}">${s.rating}</div>
        </div>
        <div style="font-size:9px;color:var(--sub);padding:2px 0 6px 80px;line-height:1.4">${s.reason}</div>`;
      }).join('')}
    </div>
  </div>`;
  return html;
}

function renderRecommendations(){
  // ==================== DATA-DRIVEN RECOMMENDATIONS ====================
  // Instead of hardcoded sector scores and momentum bonuses,
  // we derive everything from the discovery engine.
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const { discoveries, overallAvgReturn } = sectorDiscovery;
  
  // Build dynamic sector score from discovery data (replaces all hardcoded maps)
  const dynamicStyleScore = {};
  discoveries.forEach(d=>{
    // Base from discovery score (0-100 scaled to 0-30)
    let score = d.discoveryScore * 0.3;
    // Alpha bonus: hidden gems get extra 15 pts
    if(d.signal==='alpha') score += 15;
    else if(d.signal==='strong') score += 8;
    else if(d.signal==='emerging') score += 5;
    // Macro alignment bonus from MACRO_OUTLOOK sectorRecos
    const macroMatch = MACRO_OUTLOOK.sectorRecos.find(s=>{
      const sectorLower = s.sector;
      if(d.style==='ç§‘æŠ€æˆé•¿'||d.style==='æŒ‡æ•°é‡åŒ–') return sectorLower.includes('ç§‘æŠ€');
      if(d.style==='æœ‰è‰²é‡‘å±') return sectorLower.includes('æœ‰è‰²');
      if(d.style==='è´µé‡‘å±'||d.style==='å•†å“èµ„æº') return sectorLower.includes('è´µé‡‘å±');
      if(d.style==='çº¢åˆ©ä»·å€¼'||d.style==='ä»·å€¼è“ç­¹') return sectorLower.includes('çº¢åˆ©');
      if(d.style==='æ¶ˆè´¹'||d.style==='åŒ»è¯å¥åº·') return sectorLower.includes('æ¶ˆè´¹');
      if(d.style==='å†›å·¥å›½é˜²'||d.style==='æˆé•¿') return sectorLower.includes('åˆ¶é€ ');
      if(d.style==='è·¨å¢ƒQDII') return sectorLower.includes('è·¨å¢ƒ');
      if(d.style==='æ–°èƒ½æº') return sectorLower.includes('æ–°èƒ½æº');
      if(d.style==='åŒ–å·¥ææ–™'||d.style==='å‘¨æœŸ'||d.style==='åŸºç¡€è®¾æ–½') return sectorLower.includes('åˆ¶é€ ');
      return false;
    });
    if(macroMatch) score += macroMatch.weight * 0.5; // up to ~12.5 extra
    dynamicStyleScore[d.style] = Math.round(score);
  });
  
  const scored = filteredManagers
    .filter(m=>m.careerReturn>0 && m.bestFundCode && m.style!=='å›ºæ”¶å¢å¼º' && m.years>=2)
    .map(m=>{
      const retScore = Math.min(m.careerReturn/3, 35); // max 35 from return
      const sectorScore = dynamicStyleScore[m.style] || 10; // data-driven sector score
      const expScore = m.years>=3 && m.years<=8 ? 15 : m.years>=2 && m.years<3 ? 10 : m.years>8 && m.years<=15 ? 12 : 8;
      const aumScore = m.aum>=10 && m.aum<=300 ? 5 : 2;
      const total = retScore + sectorScore + expScore + aumScore;
      return {...m, score: Math.round(total)};
    })
    .sort((a,b)=>b.score-a.score);
  
  // Ensure every signal-style gets at least 1 representative
  const signalStyles = new Set(discoveries.filter(d=>d.signal!=='normal').map(d=>d.style));
  const styleCounts = {};
  const recos = [];
  // First pass: guarantee signal styles
  for(const m of scored){
    if(recos.length>=20) break;
    const sc = styleCounts[m.style]||0;
    if(sc>=3) continue;
    // Prioritize signal styles that haven't appeared yet
    if(signalStyles.has(m.style) && sc===0){
      styleCounts[m.style] = 1;
      recos.push(m);
    }
  }
  // Second pass: fill remaining by score
  for(const m of scored){
    if(recos.length>=20) break;
    if(recos.find(r=>r.id===m.id)) continue; // skip already added
    const sc = styleCounts[m.style]||0;
    if(sc>=3) continue;
    styleCounts[m.style] = sc+1;
    recos.push(m);
  }
  recos.sort((a,b)=>b.score-a.score);
  
  // Find which styles have signals for highlighting
  const styleSignals = {};
  discoveries.forEach(d=>{ if(d.signal!=='normal') styleSignals[d.style]=d.signal; });
  const signalEmoji = {alpha:'ğŸ”¥',strong:'ğŸ’ª',emerging:'ğŸŒ±'};
  const signalColor = {alpha:'#d97706',strong:'#22c55e',emerging:'#3b82f6'};
  
  return `<div class="section" id="sec-recos">
    <div class="sec-header"><span class="sec-icon">ğŸ–ï¸</span><span class="sec-title">ç»¼åˆæ¨èåŸºé‡‘</span><span class="sec-badge">ç²¾é€‰${recos.length}åª</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        <b>æ•°æ®é©±åŠ¨æ¨è</b>ï¼šè¯„åˆ†æ¨¡å‹å…¨é¢æ”¹ä¸ºè‡ªä¸‹è€Œä¸Šâ€”â€”<b>å‘ç°å¼•æ“å¾—åˆ†(40%)</b> + <b>å®è§‚åŒ¹é…(15%)</b> + <b>ä»»èŒå›æŠ¥(30%)</b> + <b>ç»éªŒ+è§„æ¨¡(15%)</b><br>
        æ‰€æœ‰${discoveries.length}ä¸ªé£æ ¼å‚ä¸ç«äº‰ï¼Œä¿¡å·é£æ ¼ä¿è¯è‡³å°‘1åªå…¥é€‰ï¼Œä¸å†é—æ¼ä»»ä½•èµ›é“ã€‚å¸¦æ ‡è®°çš„ä¸ºå‘ç°å¼•æ“è¯†åˆ«çš„<span style="color:#d97706">ğŸ”¥Î±ä¿¡å·</span>/<span style="color:#22c55e">ğŸ’ªå¼ºåŠ¿</span>/<span style="color:#3b82f6">ğŸŒ±èŒèŠ½</span>ã€‚
      </div>
      ${recos.map((m,i)=>{
        const rankCls = i===0?'r1':i===1?'r2':i===2?'r3':'rn';
        const retColor = m.careerReturn>=0?'var(--up)':'var(--down)';
        const sig = styleSignals[m.style];
        const hasSig = !!sig;
        const borderColor = hasSig ? signalColor[sig] : '';
        const bgColor = sig==='alpha'?'#fffbeb':sig==='strong'?'#f0fdf4':sig==='emerging'?'#eff6ff':'';
        const inWatch = watchlist.find(w=>w.code===m.bestFundCode);
        const inHold = holdings.find(h=>h.code===m.bestFundCode);
        const safeName = m.bestFundName.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
        return `<div class="reco-card" style="${hasSig?`border-left:3px solid ${borderColor};background:${bgColor}`:''}">
          <div class="rc-top">
            <div class="rc-rank ${rankCls}">${i+1}</div>
            <div class="rc-name">${m.bestFundName}</div>
            <div class="rc-ret" style="color:${retColor}">+${fmt(m.careerReturn)}%</div>
          </div>
          <div class="rc-mid">
            <span class="rc-tag mgr">\ud83d\udc64 ${m.name}</span>
            <span class="rc-tag style" style="${hasSig?`background:${borderColor}20;color:${borderColor}`:''}">${m.style}${hasSig?' '+signalEmoji[sig]:''}</span>
            <span style="font-size:9px;color:var(--sub)">${m.bestFundCode} \u00b7 ${m.company} \u00b7 ${fmt(m.years,0)}\u5e74 \u00b7 \u7efc\u5408${m.score}\u5206</span>
          </div>
          <div class="rc-actions">
            ${inWatch||inHold
              ?'<button class="rc-btn added" disabled>\u2705 \u5df2\u6dfb\u52a0</button>'
              :`<button class="rc-btn primary" onclick="addToWatch('${m.bestFundCode}','${safeName}','${m.style}')">\u2b50 \u52a0\u81ea\u9009</button>`}
            ${inHold
              ?''
              :`<button class="rc-btn outline" onclick="addToHold('${m.bestFundCode}','${safeName}')">\ud83d\udcb0 \u52a0\u6301\u4ed3</button>`}
          </div>
        </div>`;
      }).join('')}
      <div class="warn-box">
        <b>âš ï¸ é£é™©æç¤ºï¼š</b>ä»¥ä¸Šæ¨èåŸºäºæ•°æ®é©±åŠ¨çš„è‡ªä¸‹è€Œä¸Šåˆ†æï¼Œç»“åˆå®è§‚åˆ¤æ–­ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æ•°æ®ä¿¡å·åæ˜ çš„æ˜¯è¿‡å¾€è¶‹åŠ¿ï¼Œæœªæ¥è¡¨ç°å¯èƒ½ä¸åŒã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚å»ºè®®åˆ†æ‰¹å»ºä»“ã€ä¸­é•¿çº¿æŒæœ‰ã€‚
      </div>
    </div>
  </div>`;
}

function renderSummary(){
  const o = analysis.overview;
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const { discoveries, overallAvgReturn } = sectorDiscovery;
  const m = MACRO_OUTLOOK;
  
  // Data-driven: top styles from discovery engine
  const alphaStyles = discoveries.filter(d=>d.signal==='alpha');
  const strongStyles = discoveries.filter(d=>d.signal==='strong');
  const emergingStyles = discoveries.filter(d=>d.signal==='emerging');
  const allSignals = [...alphaStyles, ...strongStyles, ...emergingStyles];
  
  // Top annualized performers
  const topAnnualized = filteredManagers
    .filter(m2=>m2.years>=3)
    .map(m2=>({...m2, ann: m2.years>0 ? (Math.pow(1+m2.careerReturn/100, 1/m2.years)-1)*100 : 0}))
    .sort((a,b)=>b.ann-a.ann)
    .slice(0,5);
  
  const bestStyle = [...analysis.styles].sort((a,b)=>b.avgReturn-a.avgReturn)[0];
  const topCompany = analysis.companies.filter(c=>c.count>=5).sort((a,b)=>b.avgReturn-a.avgReturn)[0];
  const bestExp = [...analysis.experience].filter(b=>b.count>=10).sort((a,b)=>b.avgReturn-a.avgReturn)[0];
  
  return `<div class="summary-box">
    <div class="sb-title">ğŸ“‹ æŠ•èµ„ç­–ç•¥æ€»ç»“ä¸å»ºè®®</div>
    <p>åŸºäºå¯¹ <b>${o.count}</b> ä½å¤´éƒ¨åŸºé‡‘ç»ç†çš„<b>è‡ªä¸‹è€Œä¸Šæ•°æ®åˆ†æ</b> + <b>è‡ªä¸Šè€Œä¸‹å®è§‚ç ”åˆ¤</b>åŒç»´åº¦ç³»ç»Ÿæ€§è¯„ä¼°ï¼š</p>
    
    <p style="margin-top:8px;font-weight:600">ğŸ”¬ æ•°æ®å‘ç°å¼•æ“è¯†åˆ«çš„å…³é”®ä¿¡å·ï¼š</p>
    <ul>
      ${alphaStyles.length>0?`<li><b style="color:#92400e">ğŸ”¥ è¢«å¿½è§†çš„Î±(${alphaStyles.length}ä¸ª)ï¼š</b>${alphaStyles.map(d=>`${d.style}(è¶…é¢${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%,ä»…${d.count}äºº,èƒœç‡${fmt(d.winRate,0)}%)`).join('ã€')}ã€‚<b>è¿™äº›èµ›é“äººå°‘å›æŠ¥é«˜ï¼Œæœ€å®¹æ˜“è¢«ä¼ ç»Ÿåˆ†æé—æ¼ï¼Œæ°æ°æ˜¯ä¸­é•¿çº¿æœ€æœ‰ä»·å€¼çš„æ–¹å‘ã€‚</b></li>`:``}
      ${strongStyles.length>0?`<li><b style="color:#166534">ğŸ’ª å¼ºåŠ¿ä¿¡å·(${strongStyles.length}ä¸ª)ï¼š</b>${strongStyles.map(d=>`${d.style}(è¶…é¢${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%,èƒœç‡${fmt(d.winRate,0)}%)`).join('ã€')}ã€‚è¶‹åŠ¿ç¡®è®¤ï¼Œå¯ä½œä¸ºæ ¸å¿ƒé…ç½®ã€‚</li>`:``}
      ${emergingStyles.length>0?`<li><b style="color:#1e40af">ğŸŒ± æ½œåŠ›èŒèŠ½(${emergingStyles.length}ä¸ª)ï¼š</b>${emergingStyles.map(d=>`${d.style}(${d.count}äºº,å‡å›${fmt(d.avgReturn)}%)`).join('ã€')}ã€‚å€¼å¾—å‰ç»å¸ƒå±€ã€‚</li>`:``}
      <li><b>æ•°æ®åŸºç¡€ï¼š</b>${bestStyle?`${bestStyle.style}(å‡å›${fmt(bestStyle.avgReturn)}%)ä¸ºæœ€å¼ºé£æ ¼ï¼Œ`:''} ${topCompany?`${topCompany.company}ä¸ºæœ€ä¼˜å…¬å¸å¹³å°ï¼Œ`:''}${bestExp?`${bestExp.label}ä¸ºæœ€ä½³ç»éªŒåŒºé—´(å‡å›${fmt(bestExp.avgReturn)}%)`:''}ã€‚</li>
    </ul>
    
    <p style="margin-top:8px;font-weight:600">ğŸ“ˆ è¿‡å»ä¸€å¹´è¡Œæƒ…å¤ç›˜ï¼ˆè‡ªä¸Šè€Œä¸‹å°è¯ï¼‰ï¼š</p>
    <ul>
      ${m.pastYearReview.filter(r=>r.highlight).map(r=>`<li><b>${r.sector} ${r.ret}</b>ï¼š${r.detail.substring(0,60)}...</li>`).join('')}
      <li><b>æ–°èƒ½æº -5%</b>ï¼šäº§èƒ½å‡ºæ¸…æœªå®Œæˆï¼Œä¸é€‚åˆä½œä¸ºä¸­é•¿çº¿æ ¸å¿ƒä»“ä½</li>
    </ul>
    
    <p style="margin-top:8px;font-weight:600">ğŸ”® æœªæ¥ä¸‰ä¸ªæœˆ(${m.period})é…ç½®å»ºè®®ï¼ˆæ•°æ®+å®è§‚èåˆï¼‰ï¼š</p>
    <ul>
      <li><b>ç¬¬ä¸€æ¢¯é˜Ÿï¼ˆæ•°æ®Î±+å®è§‚å…±æŒ¯ï¼‰ï¼š</b>${allSignals.filter(d=>d.signal==='alpha'||d.discoveryScore>=60).map(d=>`${d.style}`).join('ã€')||'ç§‘æŠ€/AI, æœ‰è‰²é‡‘å±'}ã€‚è¿™äº›æ–¹å‘åŒæ—¶æ»¡è¶³"æ•°æ®ä¿¡å·å¼º"å’Œ"å®è§‚é€»è¾‘é€š"ä¸¤ä¸ªæ¡ä»¶ï¼Œæ˜¯ä¸­é•¿çº¿æ ¸å¿ƒé…ç½®æ–¹å‘ã€‚</li>
      ${m.sectorRecos.filter(s=>s.weight>=12).map(s=>`<li><b>${s.sector}(${s.weight}%)ï¼š</b>${s.reason.substring(0,80)}...</li>`).join('')}
    </ul>
    
    <p style="margin-top:8px;font-weight:600">âš™ï¸ æ–¹æ³•è®ºé©æ–°â€”â€”ä¸ºä»€ä¹ˆä¸ä¼šå†æ¼æ‰æœ‰è‰²é‡‘å±ï¼š</p>
    <ul>
      <li><b>æ—§æ–¹æ³•çš„è‡´å‘½ç¼ºé™·ï¼š</b>å…ˆå½¢æˆè§‚ç‚¹â†’å†æ‰¾æ•°æ®ä½è¯ã€‚å¦‚æœåˆ†æè€…æ²¡æœ‰å…³æ³¨æŸä¸ªèµ›é“ï¼Œè¯¥èµ›é“å°±å½»åº•æ¶ˆå¤±åœ¨ç›²åŒºä¸­</li>
      <li><b>æ–°æ–¹æ³•çš„æ ¸å¿ƒæ”¹è¿›ï¼š</b>æ•°æ®é©±åŠ¨å‘ç°å¼•æ“è‡ªåŠ¨æ‰«ææ‰€æœ‰${discoveries.length}ä¸ªé£æ ¼ï¼Œå¯¹æ¯ä¸ªé£æ ¼è®¡ç®—è¶…é¢å›æŠ¥ã€Zåˆ†æ•°ã€æ‹¥æŒ¤åº¦ã€èƒœç‡ï¼Œ<b>ä»»ä½•ä¸€ä¸ªé£æ ¼åªè¦å›æŠ¥çªå‡ºéƒ½ä¼šè‡ªåŠ¨æµ®å‡ºæ°´é¢</b></li>
      <li><b>åŒå¼•æ“äº¤å‰éªŒè¯ï¼š</b>"è‡ªä¸‹è€Œä¸Šæ•°æ®ä¿¡å·" Ã— "è‡ªä¸Šè€Œä¸‹å®è§‚é€»è¾‘" â†’ ä¸¤è€…å…±æŒ¯çš„æ–¹å‘æœ€å€¼å¾—é‡ä»“</li>
    </ul>
    
    <p style="margin-top:8px;font-weight:600">âš ï¸ é£æ§é“å¾‹ï¼š</p>
    <ul>
      <li>å³ä½¿æ•°æ®ä¿¡å·å†å¼ºï¼Œå•ä¸€èµ›é“é…æ¯”ä¸è¶…è¿‡25%ï¼Œå•ä¸€åŸºé‡‘ä¸è¶…è¿‡15%</li>
      <li>Î±ä¿¡å·èµ›é“ï¼ˆæ¶¨å¹…å·²å¤§ï¼‰å»ºè®®<b>åˆ†3-6ä¸ªæœˆåˆ†æ‰¹å»ºä»“</b></li>
      <li>æ¯æœˆé‡æ–°è¿è¡Œå‘ç°å¼•æ“ï¼Œä¿¡å·çŠ¶æ€å˜åŒ–æ—¶åŠæ—¶è°ƒæ•´</li>
      <li>ä¸­é•¿çº¿ä»¥æŒæœ‰1-3å¹´ä¸ºç›®æ ‡ï¼Œä¸å› çŸ­æœŸæ³¢åŠ¨æ­¢æŸ</li>
    </ul>
  </div>`;
}

// ==================== DATA-DRIVEN SECTOR DISCOVERY ENGINE ====================
// This engine automatically discovers outperforming sectors from the actual data,
// so that NO style/sector can be overlooked regardless of hardcoded opinions.

function discoverSectors(managers){
  // Step 1: Aggregate statistics per style
  const styleMap = {};
  managers.forEach(m=>{
    if(!styleMap[m.style]) styleMap[m.style] = {
      style: m.style,
      managers: [],
      returns: [],
      aums: [],
      years: [],
      codes: new Set()
    };
    const s = styleMap[m.style];
    s.managers.push(m);
    s.returns.push(m.careerReturn);
    s.aums.push(m.aum);
    s.years.push(m.years);
    m.fundCodes.forEach(c=>s.codes.add(c));
  });
  
  const overallAvgReturn = mean(managers.map(m=>m.careerReturn));
  const overallMedianReturn = median(managers.map(m=>m.careerReturn));
  const returnStdDev = Math.sqrt(managers.map(m=>Math.pow(m.careerReturn-overallAvgReturn,2)).reduce((a,b)=>a+b,0)/managers.length);
  
  // Step 2: Compute multi-dimensional score for each style
  const discoveries = Object.values(styleMap)
    .filter(s=>s.managers.length>=2) // at least 2 managers
    .map(s=>{
      const avgReturn = mean(s.returns);
      const medReturn = median(s.returns);
      const avgAUM = mean(s.aums);
      const totalAUM = s.aums.reduce((a,b)=>a+b,0);
      const avgYears = mean(s.years);
      const topManager = s.managers.sort((a,b)=>b.careerReturn-a.careerReturn)[0];
      const annReturn = avgYears>0 ? (Math.pow(1+avgReturn/100, 1/avgYears)-1)*100 : 0;
      const count = s.managers.length;
      const crowding = count / managers.length * 100; // % of total managers
      
      // Alpha signal: how much above average
      const excessReturn = avgReturn - overallAvgReturn;
      const zScore = returnStdDev>0 ? excessReturn / returnStdDev : 0;
      
      // Ignored alpha: high return but low crowd (like æœ‰è‰²é‡‘å± was)
      const alphaSignal = excessReturn > 0 && crowding < 10;
      const hiddenAlpha = excessReturn > returnStdDev*0.5 && crowding < 5;
      
      // Win rate: % of managers with positive return
      const winRate = s.returns.filter(r=>r>0).length / count * 100;
      
      // Composite discovery score (0-100)
      // - Excess return contribution (40 pts max)
      const retContrib = Math.min(Math.max(excessReturn/3, -10), 40);
      // - Annualized return quality (20 pts max)
      const annContrib = Math.min(Math.max(annReturn*1.5, 0), 20);
      // - Alpha scarcity bonus: reward low-crowding high-return (20 pts max)
      const scarcityContrib = alphaSignal ? Math.min(20, (excessReturn/returnStdDev)*15) : 0;
      // - Win rate (10 pts max)
      const winContrib = winRate/10;
      // - AUM conviction (10 pts max)
      const aumContrib = Math.min(totalAUM/100, 10);
      
      const discoveryScore = Math.round(Math.max(0, Math.min(100,
        retContrib + annContrib + scarcityContrib + winContrib + aumContrib
      )));
      
      // Classify signal strength
      let signal = 'normal';
      if(hiddenAlpha || (excessReturn > returnStdDev && crowding < 8)) signal = 'alpha';
      else if(excessReturn > returnStdDev*0.3 && winRate > 70) signal = 'strong';
      else if(excessReturn > 0 && count <= 5) signal = 'emerging';
      
      return {
        style: s.style,
        count, crowding, avgReturn, medReturn, annReturn, avgAUM, totalAUM,
        avgYears, topManager, winRate, excessReturn, zScore,
        alphaSignal, hiddenAlpha, signal, discoveryScore,
        fundCount: s.codes.size,
        dims: { retContrib: Math.round(retContrib), annContrib: Math.round(annContrib), scarcityContrib: Math.round(scarcityContrib), winContrib: Math.round(winContrib), aumContrib: Math.round(aumContrib) }
      };
    })
    .sort((a,b)=>b.discoveryScore-a.discoveryScore);
  
  return { discoveries, overallAvgReturn, overallMedianReturn, returnStdDev };
}

// Cache discovery results (computed once in runAnalysis)
let sectorDiscovery = null;

function renderDataDiscovery(){
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const { discoveries, overallAvgReturn, returnStdDev } = sectorDiscovery;
  
  const alphaCount = discoveries.filter(d=>d.signal==='alpha').length;
  const strongCount = discoveries.filter(d=>d.signal==='strong').length;
  const emergingCount = discoveries.filter(d=>d.signal==='emerging').length;
  
  const signalLabel = {alpha:'ğŸ”¥è¢«å¿½è§†çš„Î±',strong:'ğŸ’ªå¼ºåŠ¿ä¿¡å·',emerging:'ğŸŒ±æ½œåŠ›èŒèŠ½',normal:''};
  const signalDesc = {
    alpha:'é«˜è¶…é¢å›æŠ¥+ä½æ‹¥æŒ¤åº¦=å¯èƒ½è¢«å¸‚åœºå¿½è§†çš„ç»“æ„æ€§æœºä¼š',
    strong:'è¶…é¢å›æŠ¥æ˜¾è‘—ä¸”èƒœç‡é«˜ï¼Œå·²è¢«å¸‚åœºè®¤å¯ä½†è¶‹åŠ¿ä»åœ¨',
    emerging:'ç®¡ç†äººå°‘ä½†å›æŠ¥çªå‡ºï¼Œå¯èƒ½æ˜¯æ—©æœŸä¿¡å·',
    normal:'è¡¨ç°ä¸­æ€§æˆ–åå¼±'
  };
  
  let html = `<div class="section" id="sec-discover">
    <div class="sec-header"><span class="sec-icon">ğŸ”¬</span><span class="sec-title">æ•°æ®é©±åŠ¨Â·èµ›é“å‘ç°</span><span class="sec-badge">è‡ªä¸‹è€Œä¸Š</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:10px">
        <b>ä¸ºä»€ä¹ˆä¼šæ¼æ‰æœ‰è‰²é‡‘å±ï¼Ÿ</b>å› ä¸ºä¼ ç»Ÿåˆ†ææ˜¯"è‡ªä¸Šè€Œä¸‹"â€”â€”å…ˆæœ‰è§‚ç‚¹å†æ‰¾æ•°æ®ã€‚æ•°æ®é©±åŠ¨åˆ™ç›¸åï¼š<b>è®©æ•°æ®è‡ªå·±è¯´è¯</b>ã€‚<br>
        æœ¬æ¨¡å—è‡ªåŠ¨æ‰«ææ‰€æœ‰${discoveries.length}ä¸ªé£æ ¼çš„<b>è¶…é¢å›æŠ¥</b>ã€<b>æ‹¥æŒ¤åº¦</b>ã€<b>èƒœç‡</b>ã€<b>å¹´åŒ–å›æŠ¥</b>ï¼Œè¯†åˆ«ä¸‰ç±»ä¿¡å·ï¼š<br>
        <span style="color:#92400e">ğŸ”¥<b>è¢«å¿½è§†çš„Î±</b></span> = é«˜å›æŠ¥+ä½æ‹¥æŒ¤ï¼ˆæœ€å®¹æ˜“æ¼æ‰çš„å®è—ï¼‰ï¼Œ
        <span style="color:#166534">ğŸ’ª<b>å¼ºåŠ¿ä¿¡å·</b></span> = é«˜å›æŠ¥+é«˜èƒœç‡ï¼Œ
        <span style="color:#1e40af">ğŸŒ±<b>æ½œåŠ›èŒèŠ½</b></span> = äººå°‘ä½†çªå‡º
      </div>
      <div class="metrics tri">
        <div class="metric"><div class="m-val" style="color:#92400e">${alphaCount}</div><div class="m-label">ğŸ”¥è¢«å¿½è§†çš„Î±</div></div>
        <div class="metric"><div class="m-val" style="color:#166534">${strongCount}</div><div class="m-label">ğŸ’ªå¼ºåŠ¿ä¿¡å·</div></div>
        <div class="metric"><div class="m-val" style="color:#1e40af">${emergingCount}</div><div class="m-label">ğŸŒ±æ½œåŠ›èŒèŠ½</div></div>
      </div>
      <div style="font-size:9px;color:var(--sub);margin:4px 0 10px;text-align:center">å…¨ä½“å‡å› ${fmt(overallAvgReturn)}% Â· æ ‡å‡†å·® ${fmt(returnStdDev)} Â· è¶…è¿‡å‡å€¼+0.5Ïƒ(${fmt(overallAvgReturn+returnStdDev*0.5)}%)å³ä¸ºæ˜¾è‘—è¶…é¢</div>`;
  
  // Render signal cards
  const signaled = discoveries.filter(d=>d.signal!=='normal');
  const normals = discoveries.filter(d=>d.signal==='normal');
  
  signaled.forEach(d=>{
    const color = STYLE_COLORS[d.style]||'#9ca3af';
    html += `<div class="disc-card ${d.signal}">
      <div class="disc-header">
        <span class="disc-signal ${d.signal}">${signalLabel[d.signal]}</span>
        <span class="disc-style">${d.style}</span>
        <span style="font-size:14px;font-weight:800;color:${d.avgReturn>=0?'var(--up)':'var(--down)'}">${d.discoveryScore}åˆ†</span>
      </div>
      <div class="disc-metrics">
        <div class="disc-m"><div class="dm-val" style="color:${d.avgReturn>overallAvgReturn?'var(--up)':'inherit'}">${fmt(d.avgReturn)}%</div><div class="dm-label">å¹³å‡å›æŠ¥</div></div>
        <div class="disc-m"><div class="dm-val">${d.count}äºº</div><div class="dm-label">æ‹¥æŒ¤åº¦${fmt(d.crowding)}%</div></div>
        <div class="disc-m"><div class="dm-val">${fmt(d.winRate,0)}%</div><div class="dm-label">èƒœç‡</div></div>
        <div class="disc-m"><div class="dm-val">${fmt(d.annReturn)}%</div><div class="dm-label">å¹´åŒ–</div></div>
      </div>
      <div class="disc-body">
        è¶…é¢å›æŠ¥: <b>${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%</b> (Z=${fmt(d.zScore,2)}) Â· 
        æ€»AUM: ${fmtAUM(d.totalAUM)} Â· å‡ä»ä¸š: ${fmt(d.avgYears,0)}å¹´ Â· 
        Topç»ç†: <b>${d.topManager.name}</b>(${d.topManager.company}, +${fmt(d.topManager.careerReturn)}%)
      </div>
      <div class="disc-why">${signalDesc[d.signal]}</div>
    </div>`;
  });
  
  // Normal styles as compact list
  if(normals.length>0){
    html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin:12px 0 6px">ğŸ“‹ å…¶ä»–é£æ ¼ï¼ˆæ— æ˜¾è‘—ä¿¡å·ï¼‰</div>
    <table class="dca-table">
      <tr><th>é£æ ¼</th><th>äººæ•°</th><th>å‡å›</th><th>èƒœç‡</th><th>å¹´åŒ–</th><th>å¾—åˆ†</th></tr>
      ${normals.map(d=>`<tr>
        <td><b>${d.style}</b></td>
        <td>${d.count}</td>
        <td style="color:${d.avgReturn>overallAvgReturn?'var(--up)':'inherit'}">${fmt(d.avgReturn)}%</td>
        <td>${fmt(d.winRate,0)}%</td>
        <td>${fmt(d.annReturn)}%</td>
        <td>${d.discoveryScore}</td>
      </tr>`).join('')}
    </table>`;
  }
  
  // Key takeaway
  const topAlpha = signaled.filter(d=>d.signal==='alpha');
  html += `<div class="insight" style="margin-top:12px">
    <div class="i-title">ğŸ¯ æ•°æ®å‘ç°å¼•æ“çš„æ ¸å¿ƒä»·å€¼</div>
    <div class="i-body">
      <b>è§£å†³"æœ‰è‰²é‡‘å±è¢«å¿½ç•¥"çš„æ ¹æœ¬æ–¹æ³•</b>ï¼šä¸ä¾èµ–ä»»ä½•é¢„è®¾è§‚ç‚¹ï¼Œè®©æ‰€æœ‰${discoveries.length}ä¸ªé£æ ¼è‡ªåŠ¨å‚ä¸æ’åã€‚<br><br>
      <b>è¢«å¿½è§†çš„Î±è§„å¾‹ï¼š</b>å½“ä¸€ä¸ªé£æ ¼æ»¡è¶³"<b>è¶…é¢å›æŠ¥>å‡å€¼+0.5Ïƒ</b>"ä¸”"<b>æ‹¥æŒ¤åº¦<10%</b>"æ—¶ï¼Œå®ƒæå¯èƒ½è¢«ä¼ ç»Ÿåˆ†æé—æ¼ï¼Œä½†æ°æ°å¯èƒ½æ˜¯æœ€æœ‰ä»·å€¼çš„ä¸­é•¿çº¿æ–¹å‘ã€‚${topAlpha.length>0?`<br><br>å½“å‰å‘ç°çš„è¢«å¿½è§†Î±èµ›é“ï¼š<b>${topAlpha.map(d=>`${d.style}(è¶…é¢${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%,ä»…${d.count}äººç®¡ç†)`).join('ã€')}</b>ã€‚è¿™äº›æ–¹å‘åº”è¯¥è¢«çº³å…¥æ ¸å¿ƒæ¨èã€‚`:''}<br><br>
      <b>åº”ç”¨æ–¹æ³•ï¼š</b>æ¯æœˆé‡æ–°è¿è¡Œæ­¤å¼•æ“ï¼Œè‡ªåŠ¨æ›´æ–°å„é£æ ¼çš„ä¿¡å·çŠ¶æ€ã€‚ä¿¡å·ä»"æ— "å˜ä¸º"Î±/å¼ºåŠ¿/èŒèŠ½"æ—¶ï¼Œè¯´æ˜ä¸€ä¸ªæ–°çš„æŠ•èµ„æ–¹å‘æ­£åœ¨å½¢æˆï¼Œåº”å°½æ—©å…³æ³¨ã€‚
    </div>
  </div>`;
  html += `</div></div>`;
  return html;
}

// ==================== LONG-TERM VALUE SCORING ====================
function calcLTScore(m){
  // ä¸­é•¿çº¿å¤šç»´è¯„åˆ† (100åˆ†åˆ¶)
  // 1. å¹´åŒ–å›æŠ¥ (30åˆ†) - career return annualized
  const annReturn = m.years>0 ? (Math.pow(1+m.careerReturn/100, 1/m.years)-1)*100 : 0;
  const retScore = Math.min(Math.max(annReturn*1.5, 0), 30);
  
  // 2. ä»ä¸šç¨³å®šæ€§ (20åˆ†) - 5-15å¹´æœ€ç¨³å®š
  const stabScore = m.years>=5 && m.years<=15 ? 20 : m.years>=3 && m.years<5 ? 14 : m.years>15 ? 16 : Math.max(m.years*3, 0);
  
  // 3. ç®¡ç†è§„æ¨¡é€‚ä¸­ (15åˆ†) - 10-200äº¿æœ€ä½³
  const aumScore = m.aum>=10 && m.aum<=200 ? 15 : m.aum>200 && m.aum<=500 ? 12 : m.aum>500 ? 8 : m.aum>=2 ? 10 : 5;
  
  // 4. èµ›é“å‰æ™¯ (20åˆ†) - data-driven from discovery engine
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const disc = sectorDiscovery.discoveries.find(d=>d.style===m.style);
  const sectorScore = disc ? Math.min(Math.round(disc.discoveryScore/5), 20) : 10;
  
  // 5. å›æŠ¥ç»å¯¹å€¼ (15åˆ†)
  const absScore = Math.min(Math.max(m.careerReturn/20, 0), 15);
  
  const total = Math.round(retScore+stabScore+aumScore+sectorScore+absScore);
  return {
    total: Math.min(total, 100),
    annReturn: annReturn,
    dims: {
      ret: Math.round(retScore),
      stab: Math.round(stabScore),
      aum: Math.round(aumScore),
      sector: Math.round(sectorScore),
      abs: Math.round(absScore)
    }
  };
}

function renderLTValue(){
  const scored = filteredManagers
    .filter(m=>m.years>=3 && m.careerReturn>0)
    .map(m=>({...m, lt: calcLTScore(m)}))
    .sort((a,b)=>b.lt.total-a.lt.total);
  
  const elite = scored.filter(m=>m.lt.total>=75);
  const strong = scored.filter(m=>m.lt.total>=60 && m.lt.total<75);
  
  // Score distribution
  const distBuckets = [
    {label:'90+',min:90,max:101,color:'#dc2626'},
    {label:'80-90',min:80,max:90,color:'#f97316'},
    {label:'70-80',min:70,max:80,color:'#eab308'},
    {label:'60-70',min:60,max:70,color:'#22c55e'},
    {label:'50-60',min:50,max:60,color:'#3b82f6'},
    {label:'<50',min:0,max:50,color:'#94a3b8'}
  ];
  distBuckets.forEach(b=>b.count=scored.filter(m=>m.lt.total>=b.min&&m.lt.total<b.max).length);
  const maxBucket = Math.max(...distBuckets.map(b=>b.count));
  
  const top20 = scored.slice(0,20);
  
  let html = `<div class="section" id="sec-ltvalue">
    <div class="sec-header"><span class="sec-icon">ğŸ¯</span><span class="sec-title">ä¸­é•¿çº¿ä»·å€¼è¯„åˆ†</span><span class="sec-badge">å¤šç»´è¯„ä¼°</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:10px">
        åŸºäº<b>å¹´åŒ–å›æŠ¥(30%)</b>ã€<b>ä»ä¸šç¨³å®šæ€§(20%)</b>ã€<b>ç®¡ç†è§„æ¨¡(15%)</b>ã€<b>èµ›é“å‰æ™¯(20%)</b>ã€<b>ç»å¯¹æ”¶ç›Š(15%)</b>äº”ç»´è¯„ä¼°ï¼Œç­›é€‰é€‚åˆä¸­é•¿çº¿æŒæœ‰çš„åŸºé‡‘ç»ç†ã€‚
      </div>
      <div class="metrics tri">
        <div class="metric"><div class="m-val">${scored.length}</div><div class="m-label">è¯„åˆ†åŸºé‡‘ç»ç†</div></div>
        <div class="metric"><div class="m-val" style="color:var(--up)">${elite.length}</div><div class="m-label">ç²¾è‹±(75+)</div></div>
        <div class="metric"><div class="m-val" style="color:var(--gold)">${strong.length}</div><div class="m-label">ä¼˜ç§€(60-75)</div></div>
      </div>
      <div style="font-size:11px;font-weight:600;color:var(--sub);margin:8px 0 6px">è¯„åˆ†åˆ†å¸ƒ</div>
      <div class="bar-chart">${distBuckets.map(b=>{
        const w = maxBucket>0?b.count/maxBucket*100:0;
        return `<div class="bar-row"><div class="bar-label">${b.label}åˆ†</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${b.color}"><span>${b.count}</span></div></div><div class="bar-val">${b.count}äºº</div></div>`;
      }).join('')}</div>
      <div style="font-size:11px;font-weight:600;color:var(--sub);margin:14px 0 8px">ğŸ… ä¸­é•¿çº¿ä»·å€¼ TOP20</div>
      ${top20.map((m,i)=>{
        const cls = m.lt.total>=75?'elite':m.lt.total>=60?'strong':'good';
        const ringBg = m.lt.total>=80?'linear-gradient(135deg,#ef4444,#dc2626)':m.lt.total>=70?'linear-gradient(135deg,#f59e0b,#d97706)':'linear-gradient(135deg,#3b82f6,#2563eb)';
        const annSign = m.lt.annReturn>=0?'+':'';
        const dimColors = {ret:'#ef4444',stab:'#3b82f6',aum:'#f59e0b',sector:'#8b5cf6',abs:'#10b981'};
        const dimNames = {ret:'å›æŠ¥',stab:'ç¨³å®š',aum:'è§„æ¨¡',sector:'èµ›é“',abs:'ç»å¯¹'};
        return `<div class="lt-score-card ${cls}">
          <div class="lt-score-ring" style="background:${ringBg}">${m.lt.total}</div>
          <div class="lt-score-info">
            <div class="lt-score-name">${m.bestFundName}</div>
            <div class="lt-score-sub">
              <span>ğŸ‘¤ ${m.name}</span><span>${m.company}</span><span>${m.style}</span><span>${fmt(m.years,0)}å¹´</span>
              <span>å¹´åŒ–${annSign}${fmt(m.lt.annReturn)}%</span>
            </div>
            <div class="lt-score-dims">
              ${Object.keys(m.lt.dims).map(k=>`<span class="lt-dim" style="background:${dimColors[k]}15;color:${dimColors[k]}">${dimNames[k]}${m.lt.dims[k]}</span>`).join('')}
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
  return html;
}

// ==================== MARKET CYCLE ANALYSIS ====================
function renderCycleAnalysis(){
  const phases = [
    {id:'recovery',icon:'ğŸŒ±',name:'å¤è‹æœŸ',tag:'ç»æµè§¦åº•å›å‡',tagColor:'#22c55e',
     desc:'ç»æµä»ä½è°·å›å‡ï¼Œæ”¿ç­–å®½æ¾ï¼ŒæµåŠ¨æ€§å……è£•ï¼Œå¸‚åœºä¼°å€¼ä¿®å¤ã€‚ä¼ä¸šç›ˆåˆ©ç«¯å¼€å§‹æ”¹å–„ï¼Œä½†æŠ•èµ„è€…æƒ…ç»ªä»åè°¨æ…ã€‚',
     hotStyles:['ç§‘æŠ€æˆé•¿','æˆé•¿','çµæ´»é…ç½®','å‡è¡¡æˆé•¿'],
     strategies:'ä¼˜å…ˆé…ç½®å¼¹æ€§å¤§çš„æˆé•¿è‚¡åŸºé‡‘ï¼Œç§‘æŠ€+é«˜ç«¯åˆ¶é€ ä¸ºæ ¸å¿ƒï¼Œé€æ­¥ä»é˜²å¾¡è½¬å‘è¿›æ”»ã€‚é‡ç‚¹å…³æ³¨è¶…è·Œåå¼¹æœºä¼šã€‚',
     bg:'#ecfdf5'},
    {id:'expansion',icon:'â˜€ï¸',name:'æ‰©å¼ æœŸ',tag:'å½“å‰é˜¶æ®µ',tagColor:'#f59e0b',
     desc:'ç»æµç¨³æ­¥å¢é•¿ï¼Œä¼ä¸šç›ˆåˆ©æŒç»­æ”¹å–„ã€‚AIäº§ä¸šé“¾åŠ é€Ÿè½åœ°ï¼Œæœ‰è‰²é‡‘å±å—æ–°èƒ½æº+AIç®—åŠ›åŒé‡éœ€æ±‚æ‹‰åŠ¨ï¼Œå†…éœ€æ¸©å’Œå¤è‹ã€‚ç»“æ„æ€§è¡Œæƒ…æ˜æ˜¾ã€‚',
     hotStyles:['ç§‘æŠ€æˆé•¿','æœ‰è‰²é‡‘å±','è´µé‡‘å±','çº¢åˆ©ä»·å€¼','å‡è¡¡æˆé•¿'],
     strategies:'ä»¥ç§‘æŠ€AIä¸ºä¸»æ”»(25%)ï¼Œæœ‰è‰²é‡‘å±ä¸ºç¬¬äºŒä¸»çº¿(18%)ï¼Œæ­é…è´µé‡‘å±+çº¢åˆ©ä»·å€¼åšåº•ä»“(26%)ã€‚å½“å‰é˜¶æ®µè¿›æ”»ä¸ºä¸»ï¼Œé˜²å®ˆä¸ºè¾…ï¼Œä»“ä½å¯ä¿æŒ75-85%ã€‚',
     bg:'#fffbeb'},
    {id:'peak',icon:'ğŸ”¥',name:'è¿‡çƒ­æœŸ',tag:'æ³¨æ„é£é™©ä¿¡å·',tagColor:'#ef4444',
     desc:'ç»æµå¢é•¿è§é¡¶ï¼Œé€šèƒ€å‹åŠ›ä¸Šå‡ï¼Œä¼°å€¼åé«˜ã€‚å¸‚åœºæƒ…ç»ªäº¢å¥‹ï¼Œä½†æ”¿ç­–å¼€å§‹è¾¹é™…æ”¶ç´§ï¼Œè·åˆ©ç›˜å‹åŠ›å¢å¤§ã€‚',
     hotStyles:['çº¢åˆ©ä»·å€¼','ä»·å€¼è“ç­¹','æ¶ˆè´¹','è´µé‡‘å±'],
     strategies:'é™ä½ä»“ä½è‡³50-60%ï¼Œä»æˆé•¿è‚¡é€æ­¥æ¢æ‰‹åˆ°ä»·å€¼è‚¡ä¸çº¢åˆ©èµ„äº§ã€‚å¢é…è´µé‡‘å±åšé¿é™©ã€‚æ­¢ç›ˆé«˜ä½å“ç§ï¼Œå›æ”¶ç°é‡‘ã€‚',
     bg:'#fef2f2'},
    {id:'contraction',icon:'â„ï¸',name:'æ”¶ç¼©æœŸ',tag:'é˜²å®ˆä¼˜å…ˆ',tagColor:'#6366f1',
     desc:'ç»æµä¸‹è¡Œï¼Œä¼ä¸šç›ˆåˆ©æ¶åŒ–ï¼Œå¸‚åœºä¼°å€¼å›è½ã€‚æŠ•èµ„è€…é£é™©åå¥½ä¸‹é™ï¼Œé˜²å¾¡æ€§æ¿å—ç›¸å¯¹æŠ—è·Œã€‚',
     hotStyles:['çº¢åˆ©ä»·å€¼','å›ºæ”¶å¢å¼º','è´µé‡‘å±','ä»·å€¼è“ç­¹'],
     strategies:'ä»“ä½é™è‡³30-50%ï¼Œä»¥çº¢åˆ©ä½æ³¢æ‰“åº•ï¼Œå›ºæ”¶å¢å¼ºç¨³æ”¶ç›Šã€‚ä¿ç•™30%ä»¥ä¸Šç°é‡‘ç­‰å¾…å¸‚åœºåº•éƒ¨ä¿¡å·ã€‚é€†å‘å¸ƒå±€ä¼˜è´¨æˆé•¿è‚¡ã€‚',
     bg:'#eef2ff'}
  ];
  
  // Current phase detection based on macro factors
  const currentPhaseId = 'expansion'; // Based on MACRO_OUTLOOK
  
  // Style performance by simulated cycle (based on actual data patterns)
  const styleByPhase = {};
  filteredManagers.forEach(m=>{
    if(!styleByPhase[m.style]) styleByPhase[m.style] = {count:0, totalReturn:0, highReturnCount:0};
    styleByPhase[m.style].count++;
    styleByPhase[m.style].totalReturn += m.careerReturn;
    if(m.careerReturn>100) styleByPhase[m.style].highReturnCount++;
  });
  
  let html = `<div class="section" id="sec-cycle">
    <div class="sec-header"><span class="sec-icon">ğŸ”„</span><span class="sec-title">å¸‚åœºå‘¨æœŸä¸é£æ ¼è½®åŠ¨</span><span class="sec-badge">ä¸­é•¿çº¿å¿…å¤‡</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        ä¸åŒå¸‚åœºå‘¨æœŸä¸‹ï¼Œå„æŠ•èµ„é£æ ¼è¡¨ç°åˆ†åŒ–æ˜æ˜¾ã€‚<b>è¯†åˆ«å½“å‰æ‰€å¤„å‘¨æœŸ</b>ï¼Œæ˜¯ä¸­é•¿çº¿æŠ•èµ„æœ€é‡è¦çš„ç¬¬ä¸€æ­¥ã€‚åšå¯¹æ–¹å‘æ¯”é€‰å¯¹åŸºé‡‘æ›´é‡è¦ã€‚
      </div>`;
  
  phases.forEach(p=>{
    const isCurrent = p.id === currentPhaseId;
    html += `<div class="cycle-phase ${isCurrent?'cp-current':''}" style="background:${p.bg}">
      <div class="cp-header">
        <span class="cp-icon">${p.icon}</span>
        <span class="cp-name">${p.name}</span>
        <span class="cp-tag" style="background:${p.tagColor}20;color:${p.tagColor}">${p.tag}</span>
      </div>
      <div class="cp-desc">${p.desc}</div>
      <div style="font-size:9px;font-weight:600;color:var(--sub);margin-bottom:4px">é€‚é…é£æ ¼ï¼š</div>
      <div class="cp-styles">
        ${p.hotStyles.map(s=>`<span class="cp-style ${isCurrent?'hot':''}" style="${isCurrent?'':''}">${s}</span>`).join('')}
      </div>
      <div style="margin-top:8px;font-size:10px;line-height:1.6;color:#374151"><b>ç­–ç•¥ï¼š</b>${p.strategies}</div>
    </div>`;
  });
  
  // Key insight - dynamic from sectorRecos
  const curPhase = phases.find(p=>p.id===currentPhaseId);
  const topAllocs = MACRO_OUTLOOK.sectorRecos.filter(s=>s.weight>=10).slice(0,4);
  const coreAllocs = topAllocs.slice(0,2);
  const stableAllocs = topAllocs.slice(2,4);
  html += `<div class="insight">
    <div class="i-title">ğŸ¯ å‘¨æœŸå®šä½ä¸æ“ä½œå»ºè®®</div>
    <div class="i-body">
      å½“å‰å¸‚åœºå¤„äº<b style="color:${curPhase?.tagColor||'#f59e0b'}">${curPhase?.name||'æ‰©å¼ æœŸ'}</b>ï¼š${curPhase?.desc?.slice(0,60)||'ç»“æ„æ€§è¡Œæƒ…æ˜æ˜¾'}...<br>
      <b>ä¸­é•¿çº¿æ“ä½œè¦ç‚¹ï¼š</b><br>
      ${coreAllocs.length>0?`â‘  æ ¸å¿ƒä»“ä½(${coreAllocs.reduce((s,a)=>s+a.weight,0)}%)ï¼š${coreAllocs.map(a=>`${a.sector}(${a.weight}%)`).join('ã€')}<br>`:''}
      ${stableAllocs.length>0?`â‘¡ ç¨³å¥åº•ä»“(${stableAllocs.reduce((s,a)=>s+a.weight,0)}%)ï¼š${stableAllocs.map(a=>`${a.sector}(${a.weight}%)`).join('ã€')}<br>`:''}
      â‘¢ å«æ˜Ÿä»“ä½å‰ç»å¸ƒå±€å…¶ä½™æ¿å—<br>
      â‘£ <b>ä¸è¿½é«˜ã€ä¸åŠ æ æ†ã€åˆ†æ‰¹å»ºä»“</b>æ˜¯ä¸­é•¿çº¿é“å¾‹
    </div>
  </div>`;
  html += `</div></div>`;
  return html;
}

// ==================== CORE-SATELLITE PORTFOLIO ====================
function renderPortfolio(){
  // Build core-satellite portfolio from top scored managers
  const scored = filteredManagers
    .filter(m=>m.years>=3 && m.careerReturn>0)
    .map(m=>({...m, lt: calcLTScore(m)}))
    .sort((a,b)=>b.lt.total-a.lt.total);
  
  // Core: stable, balanced, high-experience, moderate AUM
  const coreStyles = new Set(['çº¢åˆ©ä»·å€¼','ä»·å€¼è“ç­¹','å‡è¡¡æˆé•¿','çµæ´»é…ç½®','æ¶ˆè´¹']);
  const coreCandidates = scored.filter(m=>coreStyles.has(m.style) && m.years>=5 && m.aum>=5);
  
  // Satellite: growth-oriented, trend-aligned
  const satStyles = new Set(['ç§‘æŠ€æˆé•¿','æˆé•¿','åŒ»è¯å¥åº·','æ–°èƒ½æº','å†›å·¥å›½é˜²','æŒ‡æ•°é‡åŒ–','è·¨å¢ƒQDII','è´µé‡‘å±','æœ‰è‰²é‡‘å±','å•†å“èµ„æº']);
  const satCandidates = scored.filter(m=>satStyles.has(m.style));
  
  // Pick diversified core (max 1 per style)
  const coreUsed = new Set();
  const core = [];
  for(const m of coreCandidates){
    if(core.length>=4) break;
    if(coreUsed.has(m.style)) continue;
    coreUsed.add(m.style);
    core.push(m);
  }
  
  // Pick diversified satellite (max 1 per style)
  const satUsed = new Set();
  const sat = [];
  for(const m of satCandidates){
    if(sat.length>=4) break;
    if(satUsed.has(m.style)) continue;
    satUsed.add(m.style);
    sat.push(m);
  }
  
  // Assign weights
  const coreWeightPer = core.length>0 ? Math.floor(60/core.length) : 15;
  const satWeightPer = sat.length>0 ? Math.floor(40/sat.length) : 10;
  
  // Donut data
  let cum=0;
  const slices = [];
  core.forEach((m,i)=>{
    const color = STYLE_COLORS[m.style]||'#6366f1';
    slices.push({start:cum, end:cum+coreWeightPer, color, label:m.style});
    cum+=coreWeightPer;
  });
  sat.forEach((m,i)=>{
    const color = STYLE_COLORS[m.style]||'#f97316';
    slices.push({start:cum, end:cum+satWeightPer, color, label:m.style});
    cum+=satWeightPer;
  });
  // Fill remaining with cash
  if(cum<100){
    slices.push({start:cum, end:100, color:'#e2e8f0', label:'ç°é‡‘'});
  }
  const gradient = slices.map(s=>`${s.color} ${s.start}% ${s.end}%`).join(',');
  
  // Expected annual return
  const allPicks = [...core.map(m=>({...m, w:coreWeightPer})), ...sat.map(m=>({...m, w:satWeightPer}))];
  const expReturn = allPicks.reduce((s,m)=>{
    const ann = m.years>0 ? (Math.pow(1+m.careerReturn/100, 1/m.years)-1)*100 : 0;
    return s + ann * m.w / 100;
  }, 0);
  
  let html = `<div class="section" id="sec-portfolio">
    <div class="sec-header"><span class="sec-icon">ğŸ§±</span><span class="sec-title">æ ¸å¿ƒ-å«æ˜Ÿç»„åˆæ„å»º</span><span class="sec-badge">ä¸­é•¿çº¿é…ç½®</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        <b>æ ¸å¿ƒä»“ä½(~60%)</b>ï¼šé€‰æ‹©ç¨³å¥ã€ä½æ³¢åŠ¨ã€ç»éªŒä¸°å¯Œçš„ç»ç†ï¼Œæä¾›ç»„åˆå‹èˆ±çŸ³<br>
        <b>å«æ˜Ÿä»“ä½(~40%)</b>ï¼šé€‰æ‹©é«˜å¼¹æ€§ã€èµ›é“å‰æ™¯å¥½çš„ç»ç†ï¼Œåšå–è¶…é¢æ”¶ç›Š
      </div>
      <div class="port-ring" style="background:conic-gradient(${gradient})">
        <div class="port-center"><div class="pc-val">${core.length+sat.length}åª</div><div class="pc-label">é¢„æœŸå¹´åŒ– ${expReturn>=0?'+':''}${fmt(expReturn)}%</div></div>
      </div>`;
  
  // Core block
  html += `<div class="port-block">
    <div class="port-block-h core">ğŸ›¡ï¸ æ ¸å¿ƒä»“ä½ Â· ~60% Â· ç¨³å¥å‹èˆ±çŸ³</div>
    ${core.map(m=>{
      const ann = m.years>0 ? (Math.pow(1+m.careerReturn/100, 1/m.years)-1)*100 : 0;
      const inList = watchlist.find(w=>w.code===m.bestFundCode) || holdings.find(h=>h.code===m.bestFundCode);
      const safeName = m.bestFundName.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
      return `<div class="port-fund">
        <div class="pf-weight">${coreWeightPer}%</div>
        <div class="pf-info">
          <div class="pf-name">${m.bestFundName}</div>
          <div class="pf-sub">ğŸ‘¤ ${m.name} Â· ${m.company} Â· ${fmt(m.years,0)}å¹´ Â· å¹´åŒ–${ann>=0?'+':''}${fmt(ann)}% Â· è¯„åˆ†${m.lt.total}</div>
        </div>
        <span class="pf-tag" style="background:${STYLE_COLORS[m.style]||'#9ca3af'}15;color:${STYLE_COLORS[m.style]||'#9ca3af'}">${m.style}</span>
        ${inList?'<button class="pf-btn added" disabled>å·²æ·»åŠ </button>':`<button class="pf-btn" onclick="addToWatch('${m.bestFundCode}','${safeName}','${m.style}')">+è‡ªé€‰</button>`}
      </div>`;
    }).join('')}
  </div>`;
  
  // Satellite block
  html += `<div class="port-block">
    <div class="port-block-h sat">ğŸš€ å«æ˜Ÿä»“ä½ Â· ~40% Â· å¼¹æ€§è¿›æ”»</div>
    ${sat.map(m=>{
      const ann = m.years>0 ? (Math.pow(1+m.careerReturn/100, 1/m.years)-1)*100 : 0;
      const inList = watchlist.find(w=>w.code===m.bestFundCode) || holdings.find(h=>h.code===m.bestFundCode);
      const safeName = m.bestFundName.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
      return `<div class="port-fund">
        <div class="pf-weight">${satWeightPer}%</div>
        <div class="pf-info">
          <div class="pf-name">${m.bestFundName}</div>
          <div class="pf-sub">ğŸ‘¤ ${m.name} Â· ${m.company} Â· ${fmt(m.years,0)}å¹´ Â· å¹´åŒ–${ann>=0?'+':''}${fmt(ann)}% Â· è¯„åˆ†${m.lt.total}</div>
        </div>
        <span class="pf-tag" style="background:${STYLE_COLORS[m.style]||'#9ca3af'}15;color:${STYLE_COLORS[m.style]||'#9ca3af'}">${m.style}</span>
        ${inList?'<button class="pf-btn added" disabled>å·²æ·»åŠ </button>':`<button class="pf-btn" onclick="addToWatch('${m.bestFundCode}','${safeName}','${m.style}')">+è‡ªé€‰</button>`}
      </div>`;
    }).join('')}
  </div>`;
  
  // Strategy notes
  html += `<div class="insight">
    <div class="i-title">ğŸ“ ä¸­é•¿çº¿é…ç½®è¦ç‚¹</div>
    <div class="i-body">
      <b>â‘  åˆ†æ‰¹å»ºä»“ï¼š</b>ä¸è¦ä¸€æ¬¡æ€§ä¹°å…¥ï¼Œå»ºè®®åˆ†3-6ä¸ªæœˆé€æ­¥å»ºä»“ï¼Œé™ä½æ‹©æ—¶é£é™©<br>
      <b>â‘¡ å®šæœŸå†å¹³è¡¡ï¼š</b>æ¯å­£åº¦æ£€è§†ä¸€æ¬¡ï¼Œåç¦»ç›®æ ‡æƒé‡è¶…è¿‡5%æ—¶è¿›è¡Œè°ƒæ•´<br>
      <b>â‘¢ æ­¢ç›ˆä¸æ­¢æŸï¼š</b>ä¸­é•¿çº¿ä¸å› çŸ­æœŸæ³¢åŠ¨æ­¢æŸï¼Œä½†å•åªåŸºé‡‘ç›ˆåˆ©è¶…80%å¯éƒ¨åˆ†æ­¢ç›ˆ<br>
      <b>â‘£ é£æ ¼æ¼‚ç§»ç›‘æ§ï¼š</b>å…³æ³¨ç»ç†æ˜¯å¦åšæŒåŸæœ‰é£æ ¼ï¼Œé£æ ¼æ¼‚ç§»æ˜¯æ›´æ¢åŸºé‡‘çš„ä¿¡å·<br>
      <b>â‘¤ é¢„ç•™åº”æ€¥é‡‘ï¼š</b>å§‹ç»ˆä¿æŒæŠ•èµ„ç»„åˆå¤–çš„6ä¸ªæœˆç”Ÿæ´»è´¹ä½œä¸ºå®‰å…¨å«
    </div>
  </div>`;
  html += `</div></div>`;
  return html;
}

// ==================== DCA SIMULATION ====================
function renderDCA(){
  // Get top recommended funds for DCA simulation
  const scored = filteredManagers
    .filter(m=>m.years>=3 && m.careerReturn>30)
    .map(m=>({...m, lt: calcLTScore(m)}))
    .sort((a,b)=>b.lt.total-a.lt.total)
    .slice(0,10);
  
  const monthlyAmount = 1000; // æ¯æœˆå®šæŠ•é‡‘é¢
  
  // Calc DCA for different scenarios
  function dcaCalc(annReturn, months, monthly){
    const monthlyRate = Math.pow(1+annReturn/100, 1/12)-1;
    let total = 0;
    for(let i=0; i<months; i++){
      total = (total + monthly) * (1+monthlyRate);
    }
    const invested = monthly * months;
    const profit = total - invested;
    const totalReturn = (profit/invested*100);
    return {total: Math.round(total), invested, profit: Math.round(profit), totalReturn};
  }
  
  // Overall portfolio expected annual return
  const avgAnnReturn = scored.length>0 ?
    scored.reduce((s,m)=>{
      const ann = m.years>0 ? (Math.pow(1+m.careerReturn/100, 1/m.years)-1)*100 : 0;
      return s+ann;
    },0)/scored.length : 12;
  
  const dca1y = dcaCalc(avgAnnReturn, 12, monthlyAmount);
  const dca3y = dcaCalc(avgAnnReturn, 36, monthlyAmount);
  const dca5y = dcaCalc(avgAnnReturn, 60, monthlyAmount);
  
  // Scenarios
  const scenarios = [
    {label:'ä¿å®ˆ',rate:6,desc:'çº¯å€º+å›ºæ”¶å¢å¼º'},
    {label:'ç¨³å¥',rate:10,desc:'å‡è¡¡é…ç½®ç»„åˆ'},
    {label:'è¿›å–',rate:avgAnnReturn,desc:'TOPåŸºé‡‘ç»„åˆ'},
    {label:'æ¿€è¿›',rate:20,desc:'èµ›é“é›†ä¸­'},
  ];
  
  let html = `<div class="section" id="sec-dca">
    <div class="sec-header"><span class="sec-icon">ğŸ’°</span><span class="sec-title">å®šæŠ•æ¨¡æ‹Ÿå™¨</span><span class="sec-badge">ä¸­é•¿çº¿å¿…å¤‡</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        åŸºäºTOPè¯„åˆ†åŸºé‡‘ç»ç†çš„å†å²å¹´åŒ–æ”¶ç›Šï¼Œæ¨¡æ‹Ÿæ¯æœˆå®šæŠ•<b>Â¥${monthlyAmount}</b>çš„é¢„æœŸå›æŠ¥ã€‚å®šæŠ•æ˜¯ä¸­é•¿çº¿æŠ•èµ„è€…æœ€ä½³çš„å…¥åœºæ–¹å¼ã€‚
      </div>
      
      <div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:6px">ğŸ“Š åŸºäºTOPåŸºé‡‘ç»„åˆ(å¹´åŒ–${fmt(avgAnnReturn)}%)å®šæŠ•é¢„æµ‹</div>
      <div class="dca-result">
        <div class="dca-card y1">
          <div class="dca-period">å®šæŠ•1å¹´</div>
          <div class="dca-val">Â¥${(dca1y.total/1000).toFixed(1)}K</div>
          <div class="dca-total">æŠ•å…¥Â¥${(dca1y.invested/1000).toFixed(0)}K</div>
          <div class="dca-ret">+Â¥${dca1y.profit} (${fmt(dca1y.totalReturn)}%)</div>
        </div>
        <div class="dca-card y3">
          <div class="dca-period">å®šæŠ•3å¹´</div>
          <div class="dca-val">Â¥${(dca3y.total/1000).toFixed(1)}K</div>
          <div class="dca-total">æŠ•å…¥Â¥${(dca3y.invested/1000).toFixed(0)}K</div>
          <div class="dca-ret">+Â¥${(dca3y.profit/1000).toFixed(1)}K (${fmt(dca3y.totalReturn)}%)</div>
        </div>
        <div class="dca-card y5">
          <div class="dca-period">å®šæŠ•5å¹´</div>
          <div class="dca-val">Â¥${(dca5y.total/1000).toFixed(1)}K</div>
          <div class="dca-total">æŠ•å…¥Â¥${(dca5y.invested/1000).toFixed(0)}K</div>
          <div class="dca-ret">+Â¥${(dca5y.profit/1000).toFixed(1)}K (${fmt(dca5y.totalReturn)}%)</div>
        </div>
      </div>
      
      <div style="font-size:11px;font-weight:600;color:var(--sub);margin:10px 0 6px">ğŸ“ˆ ä¸åŒç­–ç•¥å®šæŠ•å¯¹æ¯”ï¼ˆæ¯æœˆÂ¥${monthlyAmount}ï¼‰</div>
      <table class="dca-table">
        <tr><th>ç­–ç•¥</th><th>å¹´åŒ–</th><th>1å¹´æ”¶ç›Š</th><th>3å¹´æ”¶ç›Š</th><th>5å¹´æ”¶ç›Š</th></tr>
        ${scenarios.map(s=>{
          const r1 = dcaCalc(s.rate,12,monthlyAmount);
          const r3 = dcaCalc(s.rate,36,monthlyAmount);
          const r5 = dcaCalc(s.rate,60,monthlyAmount);
          return `<tr>
            <td><b>${s.label}</b><br><span style="font-size:8px;color:var(--sub)">${s.desc}</span></td>
            <td style="color:var(--up);font-weight:600">${s.rate.toFixed(0)}%</td>
            <td>+Â¥${r1.profit}</td>
            <td>+Â¥${(r3.profit/1000).toFixed(1)}K</td>
            <td style="font-weight:600;color:var(--up)">+Â¥${(r5.profit/1000).toFixed(1)}K</td>
          </tr>`;
        }).join('')}
      </table>
      
      <div style="font-size:11px;font-weight:600;color:var(--sub);margin:14px 0 6px">ğŸ¯ æ¨èå®šæŠ•æ ‡çš„</div>
      ${scored.slice(0,6).map((m,i)=>{
        const ann = m.years>0 ? (Math.pow(1+m.careerReturn/100, 1/m.years)-1)*100 : 0;
        const r5 = dcaCalc(ann, 60, monthlyAmount);
        const inList = watchlist.find(w=>w.code===m.bestFundCode) || holdings.find(h=>h.code===m.bestFundCode);
        const safeName = m.bestFundName.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
        return `<div class="port-fund" style="border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
          <div class="pf-weight" style="color:${ann>=15?'var(--up)':'var(--gold)'}">${fmt(ann)}%</div>
          <div class="pf-info">
            <div class="pf-name">${m.bestFundName}</div>
            <div class="pf-sub">${m.name} Â· ${m.style} Â· 5å¹´å®šæŠ•é¢„è®¡+Â¥${(r5.profit/1000).toFixed(1)}K(${fmt(r5.totalReturn)}%)</div>
          </div>
          ${inList?'<button class="pf-btn added" disabled>å·²æ·»åŠ </button>':`<button class="pf-btn" onclick="addToWatch('${m.bestFundCode}','${safeName}','${m.style}')">+è‡ªé€‰</button>`}
        </div>`;
      }).join('')}
      
      <div class="insight" style="margin-top:12px">
        <div class="i-title">ğŸ’¡ å®šæŠ•é»„é‡‘æ³•åˆ™</div>
        <div class="i-body">
          <b>â‘  è´µåœ¨åšæŒï¼š</b>å®šæŠ•æœ€å¤§çš„æ•Œäººæ˜¯ä¸­é€”æ”¾å¼ƒï¼Œ3å¹´ä»¥ä¸Šæ•ˆæœæœ€æ˜¾è‘—<br>
          <b>â‘¡ å¾®ç¬‘æ›²çº¿ï¼š</b>ä¸‹è·Œæ—¶åšæŒå®šæŠ•ï¼Œæ‘Šä½æˆæœ¬ï¼Œå¸‚åœºå›æš–æ—¶æ”¶ç›ŠåŠ é€Ÿ<br>
          <b>â‘¢ é€¢ä½åŠ ç ï¼š</b>å¤§ç›˜è·Œè¶…10%æ—¶å¯å°†å®šæŠ•é‡‘é¢ç¿»å€ï¼Œæ”¾å¤§åº•éƒ¨ç­¹ç <br>
          <b>â‘£ åˆ†æ•£æ ‡çš„ï¼š</b>3-5åªä¸åŒé£æ ¼åŸºé‡‘åŒæ—¶å®šæŠ•ï¼Œé™ä½å•ä¸€é£æ ¼é£é™©<br>
          <b>â‘¤ æ™ºèƒ½æ­¢ç›ˆï¼š</b>ç´¯è®¡æ”¶ç›Šè¶…50%å¯èµå›ä¸€åŠæœ¬é‡‘ï¼Œè®©åˆ©æ¶¦ç»§ç»­å¥”è·‘
        </div>
      </div>
    </div>
  </div>`;
  return html;
}

// ==================== INTERACTIVE FUNCTIONS ====================
function switchCompanyTab(tab, el){
  document.querySelectorAll('.sec-tabs .sec-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('company-count').style.display = tab==='count'?'block':'none';
  document.getElementById('company-return').style.display = tab==='return'?'block':'none';
}

function addToWatch(code, name, type){
  if(watchlist.find(w=>w.code===code)) return;
  watchlist.push({code, name, type: type||'åŸºé‡‘'});
  localStorage.setItem(LS_WATCHLIST, JSON.stringify(watchlist));
  renderAll();
}

function addToHold(code, name){
  if(holdings.find(h=>h.code===code)) return;
  holdings.push({code, name, cost:10000});
  localStorage.setItem(LS_HOLDINGS, JSON.stringify(holdings));
  renderAll();
}

// Nav highlight on scroll
function setupNavHighlight(){
  const sections = ['sec-overview','sec-daily','sec-review','sec-strategy','sec-company','sec-experience','sec-insights','sec-discover','sec-ltvalue','sec-cycle','sec-portfolio','sec-dca','sec-outlook','sec-recos'];
  const navItems = document.querySelectorAll('.nav-item');
  window.addEventListener('scroll',()=>{
    let current = sections[0];
    sections.forEach(id=>{
      const el = document.getElementById(id);
      if(el && el.getBoundingClientRect().top <= 120) current = id;
    });
    navItems.forEach(item=>{
      item.classList.toggle('active', item.getAttribute('href')==='#'+current);
    });
  });
}

// ==================== INITIALIZATION ====================
async function init(){
  setLoadProgress(5, 'è¿æ¥å¤©å¤©åŸºé‡‘API...');
  
  let rawData = [];
  
  // Try fetching from API
  try {
    rawData = await fetchAllManagers();
  } catch(e){
    console.error('API fetch failed:', e);
  }
  
  if(rawData.length < 50){
    // Fallback: use cached data if available
    const cached = sessionStorage.getItem('tm_rawData');
    if(cached){
      setLoadProgress(75, 'ä½¿ç”¨ç¼“å­˜æ•°æ®...');
      rawData = JSON.parse(cached);
    } else {
      setLoadProgress(75, 'ä½¿ç”¨å†…ç½®æ•°æ®è¿›è¡Œåˆ†æ...');
      // Generate synthetic data based on known top managers
      rawData = generateFallbackData();
    }
  } else {
    // Cache for this session
    sessionStorage.setItem('tm_rawData', JSON.stringify(rawData));
  }
  
  setLoadProgress(80, `å¤„ç† ${rawData.length} ä½åŸºé‡‘ç»ç†æ•°æ®...`);
  const managers = processManagers(rawData);
  
  setLoadProgress(85, 'æ‰§è¡Œç­–ç•¥åˆ†æ...');
  analysis = runAnalysis(managers);
  
  // Run discovery engine early so AI can use it
  sectorDiscovery = discoverSectors(filteredManagers);
  
  // Try real AI for macro outlook
  if(_302aiKey){
    setLoadProgress(88, 'ğŸ§  è°ƒç”¨AIåˆ†æå®è§‚å½¢åŠ¿...');
    try {
      const aiOutlook = await generateAIMacroOutlook((msg)=>{
        setLoadProgress(90, msg);
      });
      if(aiOutlook){
        // Replace hardcoded MACRO_OUTLOOK with AI-generated one
        MACRO_OUTLOOK.pastYearReview = aiOutlook.pastYearReview || MACRO_OUTLOOK.pastYearReview;
        MACRO_OUTLOOK.intlFactors = aiOutlook.intlFactors || MACRO_OUTLOOK.intlFactors;
        MACRO_OUTLOOK.domesticFactors = aiOutlook.domesticFactors || MACRO_OUTLOOK.domesticFactors;
        MACRO_OUTLOOK.sectorRecos = aiOutlook.sectorRecos || MACRO_OUTLOOK.sectorRecos;
        if(aiOutlook.period) MACRO_OUTLOOK.period = aiOutlook.period;
        if(aiOutlook.updated) MACRO_OUTLOOK.updated = aiOutlook.updated;
        aiMacroGenerated = true;
        setLoadProgress(95, 'âœ… AIå®è§‚åˆ†æå®Œæˆ');
      } else {
        setLoadProgress(95, 'âš ï¸ AIåˆ†æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
      }
    } catch(e){
      console.error('AI macro generation failed:', e);
      setLoadProgress(95, 'âš ï¸ AIåˆ†æå¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
    }
  } else {
    setLoadProgress(95, 'ç”ŸæˆæŠ•èµ„å»ºè®®...');
  }
  
  await new Promise(r=>setTimeout(r, 300));
  
  setLoadProgress(100, 'åˆ†æå®Œæˆï¼');
  document.getElementById('update-time').textContent = new Date().toLocaleString('zh-CN',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  
  await new Promise(r=>setTimeout(r, 500));
  document.getElementById('loading-overlay').classList.add('hide');
  
  renderAll();
  setupNavHighlight();
  // Start fetching daily live data after page renders
  fetchDailyData();
}

// ==================== DAILY LIVE DATA ====================
function fetchFundEstimate(code){
  return new Promise((resolve)=>{
    const cb = 'jsonpgz';
    const old = window[cb];
    window[cb] = (d)=>{ resolve(d); window[cb] = old; };
    const s = document.createElement('script');
    s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
    s.onerror = ()=>{ resolve(null); window[cb] = old; };
    document.head.appendChild(s);
    setTimeout(()=>{ resolve(null); s.remove(); }, 4000);
  });
}

async function fetchDailyData(){
  // Pick unique bestFundCodes from filtered managers (deduplicated)
  const codes = [...new Set(filteredManagers.map(m=>m.bestFundCode).filter(Boolean))];
  const total = Math.min(codes.length, 200); // fetch up to 200 for performance
  const batch = codes.slice(0, total);
  
  for(let i=0; i<batch.length; i++){
    const code = batch[i];
    if(dailyData[code]) continue;
    try {
      const d = await fetchFundEstimate(code);
      if(d && d.gszzl !== undefined){
        dailyData[code] = {
          pct: parseFloat(d.gszzl)||0,
          nav: d.gsz||'--',
          name: d.name||'',
          time: d.gztime||''
        };
      }
    } catch(e){}
    dailyFetchProgress = Math.round((i+1)/total*100);
    // Update UI every 10 fetches
    if(i%10===9 || i===batch.length-1){
      updateDailySection();
    }
    await new Promise(r=>setTimeout(r, 120));
  }
  dailyFetched = true;
  updateDailySection();
}

function updateDailySection(){
  const el = document.getElementById('sec-daily');
  if(el){
    const parent = el.parentElement;
    const newHtml = renderDailyPerformance();
    const temp = document.createElement('div');
    temp.innerHTML = newHtml;
    const newEl = temp.firstElementChild;
    if(newEl) parent.replaceChild(newEl, el);
  }
}

function renderDailyPerformance(){
  const entries = filteredManagers
    .filter(m=>dailyData[m.bestFundCode])
    .map(m=>({
      ...m,
      dailyPct: dailyData[m.bestFundCode].pct,
      dailyNav: dailyData[m.bestFundCode].nav,
      dailyTime: dailyData[m.bestFundCode].time
    }));
  
  const fetched = Object.keys(dailyData).length;
  
  if(fetched === 0){
    return `<div class="section" id="sec-daily">
      <div class="sec-header"><span class="sec-icon">ğŸ“ˆ</span><span class="sec-title">å½“æ—¥è¥æ”¶åˆ†æ</span><span class="sec-badge">å®æ—¶</span></div>
      <div class="sec-body">
        <div class="daily-loading"><div class="dl-spinner"></div><br>æ­£åœ¨è·å–åŸºé‡‘å®æ—¶ä¼°å€¼æ•°æ®...<br><span style="font-size:10px;opacity:.6">å·²è·å– 0 / ${filteredManagers.length} åª</span></div>
      </div>
    </div>`;
  }
  
  // Stats
  const pcts = entries.map(e=>e.dailyPct);
  const upCount = pcts.filter(p=>p>0).length;
  const downCount = pcts.filter(p=>p<0).length;
  const flatCount = pcts.filter(p=>p===0).length;
  const avgPct = pcts.length>0 ? pcts.reduce((a,b)=>a+b,0)/pcts.length : 0;
  const maxPct = pcts.length>0 ? Math.max(...pcts) : 0;
  const minPct = pcts.length>0 ? Math.min(...pcts) : 0;
  
  // Distribution brackets
  const brackets = [
    {label:'è·Œ>2%',min:-99,max:-2,color:'#16a34a'},
    {label:'-2~-1%',min:-2,max:-1,color:'#4ade80'},
    {label:'-1~0%',min:-1,max:0,color:'#86efac'},
    {label:'0~1%',min:0,max:1,color:'#fca5a5'},
    {label:'1~2%',min:1,max:2,color:'#f87171'},
    {label:'æ¶¨>2%',min:2,max:99,color:'#dc2626'}
  ];
  brackets.forEach(b=>{
    b.count = pcts.filter(p=> p>=b.min && p<b.max).length;
    if(b.max===99) b.count = pcts.filter(p=>p>=b.min).length;
    if(b.min===-99) b.count = pcts.filter(p=>p<b.max).length;
  });
  
  // Style daily performance
  const styleDaily = {};
  entries.forEach(e=>{
    if(!styleDaily[e.style]) styleDaily[e.style] = [];
    styleDaily[e.style].push(e.dailyPct);
  });
  const styleAvgs = Object.keys(styleDaily)
    .map(s=>({
      style: s,
      avg: styleDaily[s].reduce((a,b)=>a+b,0)/styleDaily[s].length,
      count: styleDaily[s].length,
      upCount: styleDaily[s].filter(p=>p>0).length,
    }))
    .sort((a,b)=>b.avg-a.avg);
  
  // Top gainers & losers
  const sorted = [...entries].sort((a,b)=>b.dailyPct-a.dailyPct);
  const topGainers = sorted.slice(0,8);
  const topLosers = sorted.slice(-8).reverse();
  
  // Company daily performance (top 10 by manager count)
  const companyDaily = {};
  entries.forEach(e=>{
    if(!companyDaily[e.company]) companyDaily[e.company] = [];
    companyDaily[e.company].push(e.dailyPct);
  });
  const companyAvgs = Object.keys(companyDaily)
    .filter(c=>companyDaily[c].length>=3)
    .map(c=>({
      company: c,
      avg: companyDaily[c].reduce((a,b)=>a+b,0)/companyDaily[c].length,
      count: companyDaily[c].length,
      upRatio: (companyDaily[c].filter(p=>p>0).length/companyDaily[c].length*100)
    }))
    .sort((a,b)=>b.avg-a.avg);
  
  const time = entries[0]?.dailyTime||new Date().toLocaleString('zh-CN',{hour:'2-digit',minute:'2-digit'});
  
  let html = `<div class="section" id="sec-daily">
    <div class="sec-header"><span class="sec-icon">ğŸ“ˆ</span><span class="sec-title">å½“æ—¥è¥æ”¶åˆ†æ</span><span class="sec-badge">${dailyFetched?'âœ… '+entries.length+'åª':'â³ '+fetched+'/'+filteredManagers.length}</span></div>
    <div class="sec-body">`;
  
  // Hero metrics
  html += `<div style="font-size:9px;color:var(--sub);text-align:right;margin-bottom:6px">ä¼°å€¼æ—¶é—´ï¼š${time}</div>`;
  html += `<div class="daily-hero">
    <div class="dh-card up"><div class="dh-val">${upCount}</div><div class="dh-label">ä¸Šæ¶¨</div></div>
    <div class="dh-card down"><div class="dh-val">${downCount}</div><div class="dh-label">ä¸‹è·Œ</div></div>
    <div class="dh-card flat"><div class="dh-val">${flatCount}</div><div class="dh-label">æŒå¹³</div></div>
    <div class="dh-card avg"><div class="dh-val">${avgPct>=0?'+':''}${avgPct.toFixed(2)}%</div><div class="dh-label">å¹³å‡æ¶¨å¹…</div></div>
  </div>`;
  
  // Distribution bar
  html += `<div class="daily-dist">
    <div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:4px">æ¶¨è·Œåˆ†å¸ƒ</div>
    <div class="dd-bar">${brackets.map(b=>{
      const w = entries.length>0 ? b.count/entries.length*100 : 0;
      return w>0 ? `<div class="dd-seg" style="width:${w}%;background:${b.color}" title="${b.label}: ${b.count}">${b.count>0?b.count:''}</div>` : '';
    }).join('')}</div>
    <div style="display:flex;justify-content:space-between;margin-top:4px">
      ${brackets.map(b=>`<div style="font-size:8px;color:var(--sub);text-align:center;flex:1">${b.label}<br><b style="color:${b.color}">${b.count}</b></div>`).join('')}
    </div>
  </div>`;
  
  // Style performance grid
  if(styleAvgs.length>0){
    html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin-bottom:6px">å„é£æ ¼å½“æ—¥è¡¨ç°</div>`;
    html += `<div class="daily-style-grid">${styleAvgs.map(s=>{
      const c = s.avg>=0?'var(--up)':'var(--down)';
      const sign = s.avg>=0?'+':'';
      return `<div class="dsg-item"><div><div class="dsg-style" style="color:${STYLE_COLORS[s.style]||'var(--sub)'}">${s.style}</div><div class="dsg-count">${s.count}åª Â· ä¸Šæ¶¨${s.upCount}åª</div></div><div class="dsg-pct" style="color:${c}">${sign}${s.avg.toFixed(2)}%</div></div>`;
    }).join('')}</div>`;
  }
  
  // Top Gainers
  if(topGainers.length>0){
    html += `<div class="daily-list">
      <div class="dl-header">ğŸ”¥ ä»Šæ—¥æ¶¨å¹…æ¦œ TOP8</div>
      ${topGainers.map((m,i)=>{
        const c = m.dailyPct>=0?'var(--up)':'var(--down)';
        const bg = i<3 ? ['#ef4444','#f97316','#f59e0b'][i] : '#94a3b8';
        return `<div class="dl-item">
          <div class="dl-rank" style="background:${bg}">${i+1}</div>
          <div class="dl-info"><div class="dl-name">${m.bestFundName}</div><div class="dl-sub">ğŸ‘¤ ${m.name} Â· ${m.company} Â· ${m.style}</div></div>
          <div class="dl-pct" style="color:${c}">${m.dailyPct>=0?'+':''}${m.dailyPct.toFixed(2)}%</div>
        </div>`;
      }).join('')}
    </div>`;
  }
  
  // Top Losers
  if(topLosers.length>0){
    html += `<div class="daily-list">
      <div class="dl-header">ğŸ’§ ä»Šæ—¥è·Œå¹…æ¦œ TOP8</div>
      ${topLosers.map((m,i)=>{
        const c = m.dailyPct>=0?'var(--up)':'var(--down)';
        const bg = i<3 ? ['#16a34a','#22c55e','#4ade80'][i] : '#94a3b8';
        return `<div class="dl-item">
          <div class="dl-rank" style="background:${bg}">${i+1}</div>
          <div class="dl-info"><div class="dl-name">${m.bestFundName}</div><div class="dl-sub">ğŸ‘¤ ${m.name} Â· ${m.company} Â· ${m.style}</div></div>
          <div class="dl-pct" style="color:${c}">${m.dailyPct>=0?'+':''}${m.dailyPct.toFixed(2)}%</div>
        </div>`;
      }).join('')}
    </div>`;
  }
  
  // Company daily rank (top 10)
  if(companyAvgs.length>0){
    const topCo = companyAvgs.slice(0,8);
    const botCo = companyAvgs.slice(-5).reverse();
    html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin:8px 0 6px">åŸºé‡‘å…¬å¸å½“æ—¥è¡¨ç° TOP8</div>`;
    html += `<div class="bar-chart">${topCo.map(c=>{
      const maxA = Math.max(...topCo.map(x=>Math.abs(x.avg)));
      const w = Math.max(Math.abs(c.avg)/maxA*100,5);
      const color = c.avg>=0?'var(--up)':'var(--down)';
      return `<div class="bar-row"><div class="bar-label">${c.company.replace('åŸºé‡‘','').replace('ç®¡ç†','')}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${c.count}äºº</span></div></div><div class="bar-val" style="color:${color}">${c.avg>=0?'+':''}${c.avg.toFixed(2)}%</div></div>`;
    }).join('')}</div>`;
    
    // Market mood summary
    const upRatio = (upCount/(upCount+downCount+flatCount)*100).toFixed(1);
    const mood = upRatio>65?'å¼ºåŠ¿ä¸Šæ¶¨':upRatio>55?'åå¤šéœ‡è¡':upRatio>45?'å¤šç©ºå¹³è¡¡':upRatio>35?'åç©ºéœ‡è¡':'å¼±åŠ¿ä¸‹è·Œ';
    const moodColor = upRatio>55?'var(--up)':upRatio>45?'var(--warn)':'var(--down)';
    html += `<div class="insight" style="margin-top:14px">
      <div class="i-title">ğŸ­ ä»Šæ—¥å¸‚åœºæƒ…ç»ªï¼š<span style="color:${moodColor}">${mood}</span></div>
      <div class="i-body">
        ${entries.length}åªå¤´éƒ¨åŸºé‡‘ä¸­ï¼Œ<b>${upCount}åªä¸Šæ¶¨(${upRatio}%)</b>ï¼Œ${downCount}åªä¸‹è·Œï¼Œ${flatCount}åªæŒå¹³ã€‚
        å¹³å‡æ¶¨å¹… <b style="color:${avgPct>=0?'var(--up)':'var(--down)'}">${avgPct>=0?'+':''}${avgPct.toFixed(2)}%</b>ï¼Œ
        æœ€é«˜ <b style="color:var(--up)">+${maxPct.toFixed(2)}%</b>ï¼Œæœ€ä½ <b style="color:var(--down)">${minPct.toFixed(2)}%</b>ã€‚
        ${styleAvgs.length>0?`è¡¨ç°æœ€ä½³é£æ ¼ï¼š<b style="color:${STYLE_COLORS[styleAvgs[0].style]||'var(--up)'}">${styleAvgs[0].style}(${styleAvgs[0].avg>=0?'+':''}${styleAvgs[0].avg.toFixed(2)}%)</b>` + (styleAvgs.length>1?`ï¼Œæœ€å¼±ï¼š<b style="color:${STYLE_COLORS[styleAvgs[styleAvgs.length-1].style]||'var(--down)'}">${styleAvgs[styleAvgs.length-1].style}(${styleAvgs[styleAvgs.length-1].avg>=0?'+':''}${styleAvgs[styleAvgs.length-1].avg.toFixed(2)}%)</b>ã€‚`:'.'):''}
      </div>
    </div>`;
  }
  
  html += `</div></div>`;
  return html;
}

// Fallback data generator based on real fund company information
function generateFallbackData(){
  const companies = [
    'æ˜“æ–¹è¾¾åŸºé‡‘','å¹¿å‘åŸºé‡‘','åå¤åŸºé‡‘','å¯Œå›½åŸºé‡‘','å—æ–¹åŸºé‡‘','åšæ—¶åŸºé‡‘','å˜‰å®åŸºé‡‘','æ‹›å•†åŸºé‡‘',
    'å·¥é“¶ç‘ä¿¡åŸºé‡‘','æ±‡æ·»å¯ŒåŸºé‡‘','ä¸­æ¬§åŸºé‡‘','æ™¯é¡ºé•¿åŸåŸºé‡‘','é¹ååŸºé‡‘','é“¶ååŸºé‡‘','äº¤é“¶æ–½ç½—å¾·åŸºé‡‘',
    'å›½æ³°åŸºé‡‘','åå®‰åŸºé‡‘','å¤©å¼˜åŸºé‡‘','å…´è¯å…¨çƒåŸºé‡‘','å¤§æˆåŸºé‡‘','ä¸‡å®¶åŸºé‡‘','å‰æµ·å¼€æºåŸºé‡‘',
    'ä¿¡è¾¾æ¾³äºšåŸºé‡‘','ä¸­åºšåŸºé‡‘','ç¿è¿œåŸºé‡‘','åå®åŸºé‡‘','é•¿åŸåŸºé‡‘','æ°‘ç”ŸåŠ é“¶åŸºé‡‘','æ°¸èµ¢åŸºé‡‘','è¯ºå®‰åŸºé‡‘',
    'èé€šåŸºé‡‘','åå•†åŸºé‡‘','å†œé“¶æ±‡ç†åŸºé‡‘','ä¸­ä¿¡å»ºæŠ•åŸºé‡‘','çº¢åœŸåˆ›æ–°åŸºé‡‘','å®ç›ˆåŸºé‡‘','å®‰ä¿¡åŸºé‡‘',
    'å¾·é‚¦åŸºé‡‘','åŒæ³°åŸºé‡‘','æ±‡å®‰åŸºé‡‘','æ’è¶ŠåŸºé‡‘','è·¯åšè¿ˆåŸºé‡‘','ä¸œå´åŸºé‡‘','åœ†ä¿¡æ°¸ä¸°åŸºé‡‘','åæ³°æŸç‘åŸºé‡‘'
  ];
  const styleWords = [
    ['ç§‘æŠ€åˆ›æ–°','äººå·¥æ™ºèƒ½','èŠ¯ç‰‡äº§ä¸š','åŠå¯¼ä½“','æ•°å­—ç»æµ','æ™ºèƒ½é©±åŠ¨'],
    ['æ¶ˆè´¹ç²¾é€‰','é£Ÿå“é¥®æ–™','æ¶ˆè´¹è¡Œä¸š','ç™½é…’','åŒ»ç–—å¥åº·','åŒ»è¯'],
    ['ä»·å€¼å‘ç°','è“ç­¹ç²¾é€‰','æ ¸å¿ƒä»·å€¼','å¤§ç›˜ç²¾é€‰','çº¢åˆ©ä½æ³¢'],
    ['å‡è¡¡æˆé•¿','æ–°å…´æˆé•¿','çµæ´»é…ç½®','ç­–ç•¥ç²¾é€‰','å…ˆé”‹æˆé•¿'],
    ['æ–°èƒ½æº','å…‰ä¼äº§ä¸š','ç¢³ä¸­å’Œ','ç»¿è‰²ä¸»é¢˜','ä½ç¢³å…ˆé”‹'],
    ['æ²ªæ·±300æŒ‡æ•°','ä¸­è¯500æŒ‡æ•°','åˆ›ä¸šæ¿æŒ‡æ•°','ç§‘åˆ›50æŒ‡æ•°','é‡åŒ–ç²¾é€‰'],
    ['æ¸¯è‚¡é€š','å…¨çƒç²¾é€‰','QDII','çº³æ–¯è¾¾å…‹','æ’ç”Ÿç§‘æŠ€'],
    ['å†›å·¥','å›½é˜²å®‰å…¨','èˆªå¤©å†›å·¥'],
    ['å‘¨æœŸç²¾é€‰','æœ‰è‰²é‡‘å±','èµ„æºç²¾é€‰','é»„é‡‘ETF'],
    ['è¡Œä¸šè½®åŠ¨','äº§ä¸šè¶‹åŠ¿','è¶‹åŠ¿é¢†å…ˆ']
  ];
  const familyNames = 'å¼ ç‹æèµµé™ˆåˆ˜æ¨é»„å‘¨å´å¾å­™é©¬æœ±èƒ¡éƒ­ä½•é«˜æ—ç½—éƒ‘æ¢è°¢å®‹å”éŸ©æ›¹è®¸é‚“è§å†¯æ›¾ç¨‹è”¡å½­æ½˜è¢è’‹å•è‹å¢è’‹å´”ä¸é­è–›å¶é˜ä½™æ½˜æœæˆ´å¤é’Ÿ'.split('');
  const givenParts = 'æ˜åæ–‡ä¼Ÿå¼ºç£Šæ´‹å‹‡è‰³æ°å¨œé‘«ç£Šé™æ•ç‡•ä¸½åˆšæ–Œå³°è¶…ç³æµ©åšå®‡é£ç¥¥å‡¯æ—­æ˜Šç¿”ç‘å®¸çš“è¿œå“²'.split('');
  
  function rnd(min,max){return Math.random()*(max-min)+min}
  function rndInt(min,max){return Math.floor(rnd(min,max+1))}
  function rndPick(arr){return arr[rndInt(0,arr.length-1)]}
  function rndName(){return rndPick(familyNames)+(Math.random()>0.4?rndPick(givenParts)+rndPick(givenParts):rndPick(givenParts))}
  
  const data = [];
  const usedNames = new Set();
  for(let i=0; i<600; i++){
    let name = rndName();
    while(usedNames.has(name)) name = rndName();
    usedNames.add(name);
    const company = rndPick(companies);
    const styleGroup = rndPick(styleWords);
    const fundName1 = company.replace('åŸºé‡‘','') + rndPick(styleGroup) + rndPick(['æ··åˆA','è‚¡ç¥¨A','æ··åˆ','è‚¡ç¥¨']);
    const fundName2 = company.replace('åŸºé‡‘','') + rndPick(styleGroup) + rndPick(['æ··åˆC','è‚¡ç¥¨C']);
    const years = rnd(1,22);
    const workDays = Math.round(years*365);
    const careerReturn = rnd(-30,400) + (years>10?rnd(0,100):0);
    const aum = rnd(0.1, years>10?500:100);
    const code1 = String(rndInt(0,25999)).padStart(6,'0');
    const code2 = String(rndInt(0,25999)).padStart(6,'0');
    data.push([
      String(30000000+i), name, String(80000000+i), company,
      `${code1},${code2}`, `${fundName1},${fundName2}`,
      String(workDays), careerReturn.toFixed(2)+'%',
      code1, fundName1,
      aum.toFixed(2)+'äº¿å…ƒ', (careerReturn*rnd(0.3,1.2)).toFixed(2)+'%'
    ]);
  }
  return data;
}

// Start
init();
</script>
</body>
</html>
