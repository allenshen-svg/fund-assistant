<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ Â· Top500</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f0f2f5;--card:#fff;--text:#1a1a2e;--sub:#8896a4;
  --primary:#4F6EF7;--primary-bg:#eef2ff;
  --up:#e74040;--up-bg:#fef2f2;
  --down:#22a065;--down-bg:#ecfdf5;
  --border:#e8ecf1;--radius:14px;
  --warn:#f59e0b;--warn-bg:#fef3c7;
  --gold:#d97706;--gold-bg:#fffbeb;
}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro","PingFang SC","Helvetica Neue",sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;max-width:560px;margin:0 auto;min-height:100vh}

/* Header */
.page-header{background:linear-gradient(135deg,#78350f,#92400e,#b45309);color:#fff;padding:16px;position:sticky;top:0;z-index:100}
.ph-back{font-size:12px;opacity:.7;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-bottom:8px}
.ph-back:hover{opacity:1}
.ph-title{font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px}
.ph-title .badge{font-size:10px;background:rgba(255,255,255,.2);padding:2px 10px;border-radius:10px}
.ph-sub{font-size:11px;opacity:.65;margin-top:4px;line-height:1.5}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#78350f,#451a03);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;transition:opacity .5s}
.loading-overlay.hide{opacity:0;pointer-events:none}
.loading-icon{font-size:56px;margin-bottom:16px;animation:bounce 1.4s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.loading-title{font-size:18px;font-weight:700;margin-bottom:8px}
.loading-sub{font-size:12px;opacity:.6;margin-bottom:20px}
.loading-bar{width:220px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden}
.loading-fill{height:100%;background:linear-gradient(90deg,#f59e0b,#fbbf24);border-radius:3px;transition:width .3s}
.loading-status{font-size:11px;opacity:.5;margin-top:10px}

/* Section */
.section{margin:12px;background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.sec-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.sec-icon{font-size:20px}
.sec-title{font-size:14px;font-weight:700;flex:1}
.sec-badge{font-size:10px;background:var(--gold-bg);color:var(--gold);padding:2px 8px;border-radius:8px;font-weight:600}
.sec-body{padding:14px 16px}

/* Metric row */
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.metric{background:var(--bg);border-radius:10px;padding:10px 12px;text-align:center}
.metric .m-val{font-size:20px;font-weight:800;color:var(--gold)}
.metric .m-label{font-size:10px;color:var(--sub);margin-top:2px}
.metrics.tri{grid-template-columns:1fr 1fr 1fr}
.metrics.tri .metric .m-val{font-size:16px}

/* Bar chart */
.bar-chart{display:flex;flex-direction:column;gap:6px}
.bar-row{display:flex;align-items:center;gap:8px}
.bar-label{width:68px;font-size:10px;font-weight:500;text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-track{flex:1;height:18px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:6px;transition:width .6s ease}
.bar-fill span{font-size:9px;color:#fff;font-weight:600;white-space:nowrap}
.bar-val{width:48px;font-size:10px;font-weight:600;text-align:right;flex-shrink:0}

/* Insight cards */
.insight{background:var(--bg);border-radius:10px;padding:12px;margin-bottom:8px;border-left:3px solid var(--gold)}
.insight .i-title{font-size:12px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.insight .i-body{font-size:11px;color:#374151;line-height:1.7}

/* Outlook */
.outlook-factor{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.outlook-factor:last-child{border-bottom:none}
.of-label{width:60px;font-size:10px;font-weight:600;flex-shrink:0}
.of-bar{flex:1;height:10px;background:var(--bg);border-radius:5px;overflow:hidden}
.of-fill{height:100%;border-radius:5px;transition:width .8s ease}
.of-score{width:30px;text-align:right;font-size:11px;font-weight:700}
.of-trend{font-size:9px;padding:1px 6px;border-radius:4px;font-weight:600;flex-shrink:0}
.of-trend.hot{background:#fef2f2;color:var(--up)}
.of-trend.warm{background:var(--warn-bg);color:#92400e}
.of-trend.cool{background:#ecfdf5;color:var(--down)}
.of-trend.neutral{background:#f1f5f9;color:var(--sub)}

/* Reco cards */
.reco-card{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1px solid #fde68a;border-radius:10px;padding:10px 12px;margin-bottom:8px}
.rc-top{display:flex;align-items:center;gap:8px}
.rc-rank{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0;background:linear-gradient(135deg,#f59e0b,#d97706)}
.rc-rank.r1{background:linear-gradient(135deg,#f59e0b,#d97706)}
.rc-rank.r2{background:linear-gradient(135deg,#94a3b8,#64748b)}
.rc-rank.r3{background:linear-gradient(135deg,#d97706,#92400e)}
.rc-rank.rn{background:#cbd5e1;color:#475569}
.rc-name{font-size:12px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rc-ret{font-size:12px;font-weight:700;color:var(--up)}
.rc-mid{display:flex;gap:6px;margin-top:5px;flex-wrap:wrap;align-items:center}
.rc-tag{font-size:9px;padding:1px 5px;border-radius:4px;font-weight:500}
.rc-tag.mgr{background:#fef3c7;color:#92400e}
.rc-tag.style{background:var(--primary-bg);color:var(--primary)}
.rc-actions{display:flex;gap:6px;margin-top:8px}
.rc-btn{border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
.rc-btn.primary{background:var(--primary);color:#fff}
.rc-btn.outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}
.rc-btn:active{transform:scale(.96)}
.rc-btn.added{background:#e2e8f0;color:var(--sub);border:none}

/* Sector allocation */
.alloc-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.alloc-row:last-child{border-bottom:none}
.alloc-sector{width:72px;font-size:11px;font-weight:600;flex-shrink:0}
.alloc-bar{flex:1;height:14px;background:var(--bg);border-radius:4px;overflow:hidden}
.alloc-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:4px}
.alloc-fill span{font-size:8px;color:#fff;font-weight:600}
.alloc-rating{font-size:10px;font-weight:600;width:60px;text-align:right;flex-shrink:0}
.alloc-rating.strong{color:var(--up)}
.alloc-rating.ok{color:var(--warn)}
.alloc-rating.weak{color:var(--sub)}

/* Summary box */
.summary-box{background:linear-gradient(135deg,#fffbeb,#fef9c3);border:1px solid #fde68a;border-radius:12px;padding:14px;margin:12px;font-size:12px;line-height:1.8;color:#374151}
.summary-box b{color:#92400e}
.summary-box .sb-title{font-size:14px;font-weight:700;color:#78350f;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.summary-box ul{padding-left:16px;margin-top:6px}
.summary-box li{margin-bottom:4px}

/* Footer */
.page-footer{text-align:center;padding:20px 16px 40px;font-size:10px;color:var(--sub);line-height:1.6}
.page-footer a{color:var(--primary);text-decoration:none}

/* Nav anchors */
.nav-bar{display:flex;gap:6px;padding:10px 12px;overflow-x:auto;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:64px;z-index:50}
.nav-item{flex-shrink:0;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;background:var(--bg);color:var(--sub);text-decoration:none;transition:.2s}
.nav-item:active,.nav-item.active{background:var(--gold-bg);color:var(--gold)}

/* Warning box */
.warn-box{background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;margin-top:12px;font-size:10px;color:#991b1b;line-height:1.6}
.warn-box b{color:#7f1d1d}

/* Data discovery */
.disc-card{border:1px solid var(--border);border-radius:10px;margin-bottom:8px;overflow:hidden}
.disc-card.alpha{border-color:#d97706;background:linear-gradient(135deg,#fffbeb,#fef3c7)}
.disc-card.strong{border-color:#22c55e;background:#f0fdf4}
.disc-card.emerging{border-color:#3b82f6;background:#eff6ff}
.disc-header{padding:8px 12px;display:flex;align-items:center;gap:8px}
.disc-signal{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:700}
.disc-signal.alpha{background:#d9770630;color:#92400e}
.disc-signal.strong{background:#22c55e30;color:#166534}
.disc-signal.emerging{background:#3b82f630;color:#1e40af}
.disc-style{font-size:12px;font-weight:700;flex:1}
.disc-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;padding:0 12px 8px}
.disc-m{text-align:center}
.disc-m .dm-val{font-size:13px;font-weight:800}
.disc-m .dm-label{font-size:8px;color:var(--sub)}
.disc-body{padding:4px 12px 10px;font-size:10px;line-height:1.5;color:#374151;border-top:1px solid var(--border)}
.disc-why{font-size:9px;padding:2px 12px 8px;color:var(--sub);line-height:1.4}

/* Compact table (used in discovery) */
.compact-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px}
.compact-table th{background:var(--bg);padding:5px 6px;font-weight:600;color:var(--sub);text-align:left;font-size:9px}
.compact-table td{padding:5px 6px;border-top:1px solid var(--border)}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
 <div class="loading-icon"></div>
  <div class="loading-title">åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ</div>
  <div class="loading-sub">æ­£åœ¨ä»å¤©å¤©åŸºé‡‘è·å–å‰500ä½åŸºé‡‘ç»ç†æ•°æ®...</div>
  <div class="loading-bar"><div class="loading-fill" id="loading-fill" style="width:0%"></div></div>
  <div class="loading-status" id="loading-status">å‡†å¤‡ä¸­...</div>
</div>

<!-- Page Header -->
<div class="page-header">
  <div class="ph-back" onclick="location.href='index.html'">â† è¿”å›åŸºé‡‘å°åŠ©ç†</div>
 <div class="ph-title"> åŸºé‡‘ç»ç†è¡Œä¸ºåˆ†æ <span class="badge">TOP 500</span></div>
  <div class="ph-sub">ç²¾ç®€ç‰ˆ Â· èšç„¦æŠ•èµ„å†³ç­– Â· æ•°æ®é©±åŠ¨ä¿¡å· + åŸºé‡‘æ¨è<br>æ›´æ–°æ—¶é—´ï¼š<span id="update-time">--</span></div>
</div>

<!-- Navigation -->
<div class="nav-bar" id="nav-bar">
 <a class="nav-item active" href="#sec-overview"> æ¦‚è§ˆ</a>
 <a class="nav-item" href="#sec-review"> å›é¡¾</a>
 <a class="nav-item" href="#sec-discover"> ä¿¡å·</a>
 <a class="nav-item" href="#sec-outlook"> å‰ç»</a>
 <a class="nav-item" href="#sec-recos"> æ¨è</a>
 <a class="nav-item" href="#sec-summary"> æ€»ç»“</a>
</div>

<!-- Main Content -->
<div id="main-content"></div>

<!-- Footer -->
<div class="page-footer">
  æ•°æ®æ¥æºï¼šä¸œæ–¹è´¢å¯ŒChoiceæ•°æ® Â· å¤©å¤©åŸºé‡‘<br>
  æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®<br>
  <a href="index.html">â† è¿”å›åŸºé‡‘è‚¡å¸‚å°åŠ©ç†</a>
</div>

<script>
// ==================== CONFIGURATION ====================
const API_BASE = 'https://fund.eastmoney.com/Data/FundDataPortfolio_Interface.aspx';
const PAGES_TO_FETCH = 8;
const PER_PAGE = 100;

const LS_HOLDINGS = 'fa_holdings';
const LS_WATCHLIST = 'fa_watchlist';

// ==================== MACRO OUTLOOK ====================
let MACRO_OUTLOOK = {
  period: '2026å¹´2æœˆâ€”5æœˆ',
  updated: '2026-02-14',
  pastYearReview: [
    {sector:'æœ‰è‰²é‡‘å±',ret:'+52%',icon:'ğŸ”¥',highlight:true,
     detail:'é“œä»·çªç ´$10000/å¨ï¼Œé“ä»·åˆ›2å¹´æ–°é«˜ã€‚å…¨çƒæ–°èƒ½æºè½¬å‹+AIæ•°æ®ä¸­å¿ƒç”¨ç”µæ¿€å¢æ¨åŠ¨é“œé“éœ€æ±‚é£™å‡ï¼Œå åŠ å—ç¾é“œçŸ¿ä¾›åº”æ‰°åŠ¨ã€å›½å†…å†¶ç‚¼åˆ©æ¶¦æ”¶ç¼©å¯¼è‡´ä¾›ç»™åç´§ï¼Œæœ‰è‰²æ¿å—æˆä¸ºè¿‡å»ä¸€å¹´æœ€å¼ºèµ›é“ä¹‹ä¸€ã€‚'},
    {sector:'è´µé‡‘å±(é»„é‡‘)',ret:'+35%',icon:'âœ¨',highlight:true,
     detail:'å›½é™…é‡‘ä»·çªç ´$2800/ç›å¸ã€‚åœ°ç¼˜å†²çªæŒç»­ï¼ˆä¿„ä¹Œã€ä¸­ä¸œï¼‰ã€å…¨çƒå¤®è¡ŒæŒç»­è´­é‡‘ï¼ˆä¸­å›½å¤®è¡Œè¿ç»­18ä¸ªæœˆå¢æŒï¼‰ã€ç¾å…ƒä¿¡ç”¨ä½“ç³»æ¾åŠ¨ä¸‰é‡å› ç´ é©±åŠ¨ï¼Œé»„é‡‘å·²ä»é¿é™©èµ„äº§å‡çº§ä¸ºæˆ˜ç•¥é…ç½®èµ„äº§ã€‚'},
    {sector:'ç§‘æŠ€/AI',ret:'+38%',icon:'ğŸ¤–',highlight:true,
     detail:'DeepSeekå¼•çˆ†å›½äº§AIé©å‘½ï¼Œç®—åŠ›åŸºå»ºâ†’åº”ç”¨è½åœ°å…¨é¢åŠ é€Ÿã€‚æœºå™¨äººï¼ˆäººå½¢æœºå™¨äººæ¦‚å¿µï¼‰ã€è‡ªåŠ¨é©¾é©¶ã€AI Agentè¿›å…¥å•†ä¸šåŒ–æ‹ç‚¹ï¼ŒåŠå¯¼ä½“å›½äº§æ›¿ä»£æµªæ½®å—ç›Šäºå‡ºå£ç®¡åˆ¶å€’é€¼ã€‚'},
    {sector:'çº¢åˆ©/é«˜è‚¡æ¯',ret:'+18%',icon:'ğŸ’°',highlight:false,
     detail:'åˆ©ç‡æŒç»­ä¸‹è¡Œç¯å¢ƒä¸‹ï¼Œé«˜è‚¡æ¯èµ„äº§å¸å¼•åŠ›æå‡ã€‚å¤®å›½ä¼ä»·å€¼é‡ä¼°ä¸»çº¿å»¶ç»­ï¼Œç…¤ç‚­ã€é“¶è¡Œã€å…¬ç”¨äº‹ä¸šç¨³å¥ä¸Šæ¶¨ã€‚'},
    {sector:'æ¸¯è‚¡ç§‘æŠ€',ret:'+28%',icon:'ğŸŒ',highlight:false,
     detail:'å—å‘èµ„é‡‘æŒç»­æµå…¥ï¼Œæ’ç”Ÿç§‘æŠ€æŒ‡æ•°èµ°å‡ºä½è°·ã€‚äº’è”ç½‘é¾™å¤´ç›ˆåˆ©æ”¹å–„+AIæ¦‚å¿µå‚¬åŒ–+ä¼°å€¼ä¿®å¤ä¸‰é‡é©±åŠ¨ã€‚'},
    {sector:'æ¶ˆè´¹',ret:'+8%',icon:'ğŸ›’',highlight:false,
     detail:'æ¶ˆè´¹å¤è‹ä¸åŠé¢„æœŸï¼Œç»“æ„åˆ†åŒ–ä¸¥é‡ã€‚å¤§ä¼—æ¶ˆè´¹ç¼“æ…¢ä¿®å¤ï¼Œé«˜ç«¯æ¶ˆè´¹æŒç»­æ‰¿å‹ï¼Œé£Ÿå“é¥®æ–™é¾™å¤´ä¼°å€¼ä»åœ¨æ¶ˆåŒ–æœŸã€‚'},
    {sector:'åŒ»è¯',ret:'+12%',icon:'ğŸ’Š',highlight:false,
     detail:'åˆ›æ–°è¯å‡ºæµ·é€»è¾‘å…‘ç°ï¼ŒCXOæ¿å—é˜¶æ®µæ€§åå¼¹ã€‚é›†é‡‡å½±å“é€æ­¥æ¶ˆåŒ–ï¼Œä½†æ•´ä½“å¤è‹åæ…¢ã€‚'},
    {sector:'æ–°èƒ½æº',ret:'-5%',icon:'âš¡',highlight:false,
     detail:'äº§èƒ½è¿‡å‰©æ ¼å±€æœªæ”¹ï¼Œå…‰ä¼ã€é”‚ç”µæ± ä»·æ ¼æŒç»­ä¸‹è·Œã€‚è¡Œä¸šå‡ºæ¸…å°šæœªå®Œæˆï¼Œä»…å‚¨èƒ½ä¸æµ·ä¸Šé£ç”µç­‰ç»†åˆ†æ–¹å‘æœ‰äº®ç‚¹ã€‚'},
  ],
  intlFactors: [
    {label:'ç¾è”å‚¨æ”¿ç­–',score:65,trend:'é™æ¯æ”¾ç¼“',cls:'warm',
     desc:'2025å¹´ç´¯è®¡é™æ¯75bpåèŠ‚å¥æ˜æ˜¾æ”¾ç¼“ï¼Œ2026å¹´é¢„è®¡ä»…1-2æ¬¡é™æ¯ã€‚ç¾å…ƒæŒ‡æ•°å›è½ä½†å¹…åº¦æœ‰é™ï¼Œå…¨çƒæµåŠ¨æ€§è¾¹é™…æ”¹å–„ä½†ä¸å†è¶…é¢„æœŸå®½æ¾ã€‚'},
    {label:'å…¨çƒé€šèƒ€',score:58,trend:'ç²˜æ€§æ®‹å­˜',cls:'neutral',
     desc:'æ ¸å¿ƒé€šèƒ€3%å·¦å³ä¼ç¨³ï¼ŒæœåŠ¡é€šèƒ€é¡½å›ºã€‚å¤§å®—å•†å“ï¼ˆé“œé“ï¼‰æ¶¨ä»·å‘ä¸‹æ¸¸ä¼ å¯¼ï¼Œéœ€å…³æ³¨äºŒæ¬¡é€šèƒ€é£é™©ã€‚'},
    {label:'åœ°ç¼˜åšå¼ˆ',score:40,trend:'é£é™©åé«˜',cls:'hot',
     desc:'ä¸­ç¾ç§‘æŠ€è„±é’©æ·±åŒ–ï¼ˆAIèŠ¯ç‰‡ã€å…ˆè¿›å°è£…å‡ºå£ç®¡åˆ¶å‡çº§ï¼‰ï¼›ä¿„ä¹Œå†²çªæŒç»­ï¼›ä¸­ä¸œå±€åŠ¿ä¸ç¨³ï¼›åŠ å‰§ä¾›åº”é“¾é‡æ„å’Œèµ„æºå“æ³¢åŠ¨ã€‚'},
    {label:'å…¨çƒåˆ¶é€ ä¸š',score:72,trend:'æ‰©å¼ ',cls:'warm',
     desc:'å…¨çƒåˆ¶é€ ä¸šPMIé‡å›æ‰©å¼ åŒºé—´ã€‚AIåŸºå»ºæŠ•èµ„æ‹‰åŠ¨æœåŠ¡å™¨/èŠ¯ç‰‡/ç”µåŠ›è®¾å¤‡éœ€æ±‚ï¼Œæ–°èƒ½æºè½¦æ¸—é€ç‡æŒç»­æå‡å¸¦åŠ¨æœ‰è‰²é‡‘å±éœ€æ±‚ã€‚'},
    {label:'ç¾å…ƒä¸æ±‡ç‡',score:55,trend:'æ¸©å’Œèµ°å¼±',cls:'neutral',
     desc:'ç¾å…ƒæŒ‡æ•°ä»105å›è½è‡³100é™„è¿‘ï¼Œæœ‰åˆ©äºæ–°å…´å¸‚åœºèµ„é‡‘å›æµå’Œå¤§å®—å•†å“ä»·æ ¼ã€‚äººæ°‘å¸æ±‡ç‡7.0-7.2åŒºé—´æ³¢åŠ¨ã€‚'},
  ],
  domesticFactors: [
    {label:'è´§å¸æ”¿ç­–',score:75,trend:'ç¨³å¥åæ¾',cls:'warm',
     desc:'LPRä»æœ‰10-20bpä¸‹è°ƒç©ºé—´ï¼Œç¤¾èå¢é€Ÿå›å‡ã€‚å®šå‘æ”¯æŒç§‘æŠ€åˆ›æ–°å’Œæ¶ˆè´¹ä¿¡è´·ï¼ŒæµåŠ¨æ€§åˆç†å……è£•ã€‚'},
    {label:'è´¢æ”¿åˆºæ¿€',score:70,trend:'ç§¯æ',cls:'warm',
     desc:'ä¸“é¡¹å€ºå‘è¡ŒåŠ é€Ÿï¼ˆå…¨å¹´4ä¸‡äº¿+ï¼‰ï¼Œè¶…é•¿æœŸç‰¹åˆ«å›½å€ºé‡ç‚¹æŠ•å‘æ–°åŸºå»ºã€AIç®—åŠ›ã€ç»¿è‰²è½¬å‹ã€‚åŸºå»ºæ‰˜åº•ç»æµåº•çº¿æ€ç»´æ˜ç¡®ã€‚'},
    {label:'äº§ä¸šæ”¿ç­–',score:85,trend:'å¼ºåŠ›é©±åŠ¨',cls:'hot',
     desc:'AIå¤§æ¨¡å‹+æœºå™¨äºº+åŠå¯¼ä½“ä¸‰çº¿å¹¶è¿›è·æ”¿ç­–å…¨é¢åŠ æŒã€‚æˆ˜ç•¥é‡‘å±ï¼ˆé“œã€é“ã€ç¨€åœŸã€é”‚ï¼‰è¢«çº³å…¥å›½å®¶å®‰å…¨æˆ˜ç•¥å‚¨å¤‡ï¼Œæœ‰è‰²é‡‘å±äº§ä¸šé“¾ä»·å€¼è¢«é‡æ–°å®šä¹‰ã€‚'},
    {label:'å†…éœ€æ¶ˆè´¹',score:58,trend:'ç¼“æ…¢ä¿®å¤',cls:'neutral',
     desc:'å±…æ°‘æ”¶å…¥å¢é€Ÿå¾®å‡ä½†ä¿¡å¿ƒä¸è¶³ï¼Œåœ°äº§æ‹–ç´¯æ•ˆåº”å‡å¼±ä½†æœªæ¶ˆé™¤ã€‚ä»¥æ—§æ¢æ–°æ”¿ç­–å»¶ç»­ï¼ŒæœåŠ¡æ¶ˆè´¹ä¼˜äºå•†å“æ¶ˆè´¹ã€‚'},
    {label:'èµ„æœ¬å¸‚åœºæ”¹é©',score:68,trend:'æ·±åŒ–æ¨è¿›',cls:'warm',
     desc:'æ–°"å›½ä¹æ¡"è½åœ°è§æ•ˆï¼ŒIPOèŠ‚å¥å¯æ§ï¼Œåˆ†çº¢åˆ¶åº¦ä¼˜åŒ–ã€‚å¤®å›½ä¼ä»·å€¼é‡ä¼°+å¹¶è´­é‡ç»„æ´»è·ƒï¼Œé•¿çº¿èµ„é‡‘å…¥å¸‚åŠ é€Ÿã€‚'},
  ],
  sectorRecos: [
    {sector:'ç§‘æŠ€/AI',rating:'å¼ºçƒˆæ¨è',weight:25,color:'#ef4444',reason:'AIä»æ¦‚å¿µèµ°å‘å•†ä¸šåŒ–è½åœ°ï¼Œç®—åŠ›â†’åº”ç”¨â†’æœºå™¨äººâ†’è‡ªåŠ¨é©¾é©¶å…¨é“¾æ¡å‚¬åŒ–ã€‚å›½äº§æ›¿ä»£å—å‡ºå£ç®¡åˆ¶å€’é€¼åŠ é€Ÿï¼ŒåŠå¯¼ä½“è®¾å¤‡/EDA/å…ˆè¿›å°è£…æ˜¯æ ¸å¿ƒæ–¹å‘ã€‚ä½†æ³¨æ„çŸ­æœŸä¼°å€¼å·²ä¸ä¾¿å®œï¼Œå»ºè®®æ‹©æœºé…ç½®ã€‚'},
    {sector:'æœ‰è‰²é‡‘å±',rating:'å¼ºçƒˆæ¨è',weight:18,color:'#d97706',reason:'ä¾›éœ€æ ¼å±€æŒç»­ç´§å¼ ï¼šå…¨çƒAIæ•°æ®ä¸­å¿ƒ+æ–°èƒ½æºè½¦+å…‰ä¼ç”¨é“œé‡æ¿€å¢ï¼Œå—ç¾é“œçŸ¿èµ„æœ¬å¼€æ”¯ä¸è¶³å¯¼è‡´3-5å¹´ä¾›ç»™ç¼ºå£ã€‚é“å—ç›Šäºå›½å†…ç”µè§£é“äº§èƒ½å¤©èŠ±æ¿+æ±½è½¦è½»é‡åŒ–+å…‰ä¼è¾¹æ¡†éœ€æ±‚ã€‚æœ‰è‰²é‡‘å±ä»å‘¨æœŸå“å‡çº§ä¸ºæˆé•¿å“ï¼Œä¸­é•¿çº¿æ ¸å¿ƒé…ç½®ã€‚'},
    {sector:'è´µé‡‘å±',rating:'æ¨è',weight:12,color:'#f59e0b',reason:'é»„é‡‘çš„å®šä»·é€»è¾‘å·²ä»"æŠ—é€šèƒ€"è½¬å˜ä¸º"å»ç¾å…ƒåŒ–+å¤®è¡Œå‚¨å¤‡é‡é…+åœ°ç¼˜é¿é™©"ä¸‰é‡é©±åŠ¨ã€‚å…¨çƒå¤®è¡Œè´­é‡‘è¶‹åŠ¿æœªå˜ã€‚è™½ç„¶é‡‘ä»·å·²é«˜ï¼Œä½†ä¸­é•¿æœŸä¸Šè¡Œè¶‹åŠ¿æœªæ”¹ï¼Œå›è°ƒå³æ˜¯åŠ ä»“æœºä¼šã€‚'},
    {sector:'çº¢åˆ©/ä»·å€¼',rating:'æ¨è',weight:14,color:'#eab308',reason:'åˆ©ç‡ä¸‹è¡Œç¯å¢ƒä¸­é«˜è‚¡æ¯èµ„äº§æ€§ä»·æ¯”å‡¸æ˜¾ã€‚å¤®å›½ä¼ä»·å€¼é‡ä¼°+æé«˜åˆ†çº¢æ¯”ä¾‹æ”¿ç­–æŒç»­æ¨è¿›ï¼Œç…¤ç‚­/é“¶è¡Œ/å…¬ç”¨äº‹ä¸š/äº¤è¿å¯ä½œä¸ºç»„åˆå‹èˆ±çŸ³ã€‚'},
    {sector:'é«˜ç«¯åˆ¶é€ ',rating:'æ¨è',weight:12,color:'#f97316',reason:'å‡ºå£éŸ§æ€§+äº§ä¸šå‡çº§åŒè½®é©±åŠ¨ã€‚åŠå¯¼ä½“è®¾å¤‡ã€å·¥ä¸šæ¯æœºã€èˆªç©ºå‘åŠ¨æœºå¤šçº¿å—ç›Šã€‚å†›å·¥å›½é˜²è®¢å•å›æš–ï¼Œå…³æ³¨åå››äº”æœ«æœŸè£…å¤‡äº¤ä»˜åŠ é€Ÿã€‚'},
    {sector:'æ¶ˆè´¹/åŒ»è¯',rating:'é€‚åº¦é…ç½®',weight:8,color:'#22c55e',reason:'æ¶ˆè´¹å¼±å¤è‹æ ¼å±€æœªå˜ä½†ä¼°å€¼å·²å…·æ€§ä»·æ¯”ã€‚åˆ›æ–°è¯å‡ºæµ·+è¯å“é›†é‡‡è¾¹é™…å½±å“é€’å‡ï¼ŒåŒ»è¯é¾™å¤´å¸ƒå±€çª—å£ã€‚å…³æ³¨æ€§ä»·æ¯”æ¶ˆè´¹ä¸æœåŠ¡å‹æ¶ˆè´¹ã€‚'},
    {sector:'è·¨å¢ƒ/æ¸¯è‚¡',rating:'é€‚åº¦é…ç½®',weight:6,color:'#8b5cf6',reason:'æ¸¯è‚¡ç§‘æŠ€é¾™å¤´ç›ˆåˆ©è¶‹åŠ¿å‘å¥½+ä¼°å€¼æŠ˜ä»·ä»å­˜ï¼Œä½†éœ€è­¦æƒ•ç¾å›½åŠ å¾å…³ç¨ç­‰çªå‘é£é™©ã€‚å®šæŠ•é€»è¾‘å¼ºäºä¸€æ¬¡æ€§é‡ä»“ã€‚'},
    {sector:'æ–°èƒ½æº',rating:'è°¨æ…è§‚æœ›',weight:3,color:'#06b6d4',reason:'äº§èƒ½è¿‡å‰©å‡ºæ¸…è¿œæœªç»“æŸï¼Œå…‰ä¼/é”‚ç”µæ± ä»·æ ¼æˆ˜ä»åœ¨ç»§ç»­ã€‚ä»…å‚¨èƒ½ä¸æµ·ä¸Šé£ç”µæœ‰ç»“æ„æ€§æœºä¼šï¼Œä¸å»ºè®®ä½œä¸ºæ ¸å¿ƒä»“ä½ã€‚'},
    {sector:'å›ºæ”¶/å€ºåˆ¸',rating:'ä½é…',weight:2,color:'#94a3b8',reason:'10å¹´å›½å€ºæ”¶ç›Šç‡å·²é™è‡³1.6%é™„è¿‘å†å²ä½ä½ï¼Œåˆ©å·®æåº¦å‹ç¼©ã€‚å€ºç‰›å°¾éƒ¨é£é™©å¤§äºæ”¶ç›Šï¼Œä»…ä½œä¸ºæµåŠ¨æ€§ç®¡ç†å·¥å…·ã€‚'},
  ]
};

// Style colors
const STYLE_COLORS = {
  'ç§‘æŠ€æˆé•¿':'#3b82f6','çµæ´»é…ç½®':'#8b5cf6','æ¶ˆè´¹':'#ec4899','åŒ»è¯å¥åº·':'#10b981',
  'ä»·å€¼è“ç­¹':'#f59e0b','çº¢åˆ©ä»·å€¼':'#ef4444','å‡è¡¡æˆé•¿':'#6366f1','æ–°èƒ½æº':'#06b6d4',
  'æŒ‡æ•°é‡åŒ–':'#f97316','å›ºæ”¶å¢å¼º':'#64748b','è·¨å¢ƒQDII':'#a855f7','å†›å·¥å›½é˜²':'#dc2626',
  'å‘¨æœŸ':'#84cc16','çº¯å€ºå›ºæ”¶':'#94a3b8','è´§å¸ç†è´¢':'#cbd5e1','è´µé‡‘å±':'#eab308',
  'FOFé…ç½®':'#14b8a6','å•†å“èµ„æº':'#d97706','æˆé•¿':'#2563eb','æœ‰è‰²é‡‘å±':'#b45309',
  'åŒ–å·¥ææ–™':'#78716c','åŸºç¡€è®¾æ–½':'#92400e','å…¬ç”¨äº‹ä¸š':'#4d7c0f','å†œä¸šé£Ÿå“':'#15803d',
  'é‡‘è':'#b91c1c','åœ°äº§REITs':'#7c3aed','å…¶ä»–':'#9ca3af'
};

// ==================== STATE ====================
let allManagers = [];
let filteredManagers = [];
let analysis = {};
let holdings = JSON.parse(localStorage.getItem(LS_HOLDINGS)||'[]');
let watchlist = JSON.parse(localStorage.getItem(LS_WATCHLIST)||'[]');
let aiMacroGenerated = false;

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'ç¡…åŸºæµåŠ¨(å…è´¹)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    macroModels: [
      {name:'DeepSeek-V3', model:'deepseek-ai/DeepSeek-V3'},
      {name:'Qwen2.5-72B', model:'Qwen/Qwen2.5-72B-Instruct'}
    ]
  },
  {
    id:'deepseek', name:'DeepSeekå®˜æ–¹(æä½ä»·)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    macroModels: [
      {name:'DeepSeek-R1', model:'deepseek-reasoner'},
      {name:'DeepSeek-V3', model:'deepseek-chat'}
    ]
  },
  {
    id:'302ai', name:'302.AI(ä»˜è´¹)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    macroModels: [
      {name:'DeepSeek-R1', model:'deepseek-r1'},
      {name:'Qwen3-235B', model:'qwen3-235b-a22b'}
    ]
  }
];

const _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
const _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
const _apiBase = _aiProvider.base;
const _302aiKey = localStorage.getItem('fa_302ai_key') || '';

async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_302aiKey) throw new Error('No API key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_302aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:8192
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildManagerDataContext(){
  const stylePerf = {};
  filteredManagers.forEach(m=>{
    if(!stylePerf[m.style]) stylePerf[m.style] = {returns:[], count:0};
    stylePerf[m.style].returns.push(m.careerReturn);
    stylePerf[m.style].count++;
  });
  const styleSummary = Object.keys(stylePerf)
    .map(s=>({style:s, count:stylePerf[s].count, avgReturn:mean(stylePerf[s].returns)}))
    .sort((a,b)=>b.avgReturn-a.avgReturn);

  let ctx = `å½“å‰æ—¥æœŸ: ${new Date().toISOString().slice(0,10)}\n`;
  ctx += `\nã€TOP${filteredManagers.length}åŸºé‡‘ç»ç†æ•°æ®ç»Ÿè®¡ã€‘\n`;
  ctx += `æ€»äººæ•°: ${filteredManagers.length}, å¹³å‡ä»»èŒå›æŠ¥: ${mean(filteredManagers.map(m=>m.careerReturn)).toFixed(1)}%\n`;
  ctx += `\nã€å„æŠ•èµ„é£æ ¼è¡¨ç°æ’å(æŒ‰å‡å›æŠ¥)ã€‘\n`;
  styleSummary.forEach(s=>{
    ctx += `${s.style}: ${s.count}äºº, å‡å›æŠ¥${s.avgReturn.toFixed(1)}%\n`;
  });

  if(sectorDiscovery){
    const {discoveries} = sectorDiscovery;
    const signals = discoveries.filter(d=>d.signal!=='normal');
    if(signals.length>0){
      ctx += `\nã€æ•°æ®å‘ç°å¼•æ“ä¿¡å·ã€‘\n`;
      signals.forEach(d=>{
        ctx += `${d.style}: ä¿¡å·=${d.signal==='alpha'?'è¢«å¿½è§†çš„Î±':d.signal==='strong'?'å¼ºåŠ¿':'èŒèŠ½'}, è¶…é¢å›æŠ¥${d.excessReturn>=0?'+':''}${d.excessReturn.toFixed(1)}%, èƒœç‡${d.winRate.toFixed(0)}%, ç®¡ç†äººæ•°${d.count}\n`;
      });
    }
    ctx += `\nã€å…¨éƒ¨é£æ ¼å‘ç°å¼•æ“å¾—åˆ†ã€‘\n`;
    discoveries.sort((a,b)=>b.discoveryScore-a.discoveryScore).forEach(d=>{
      ctx += `${d.style}: å¾—åˆ†${d.discoveryScore.toFixed(0)}, å‡å›æŠ¥${d.avgReturn.toFixed(1)}%, Zåˆ†æ•°${d.zScore.toFixed(2)}\n`;
    });
  }

  const topManagers = filteredManagers.sort((a,b)=>b.careerReturn-a.careerReturn).slice(0,20);
  ctx += `\nã€å›æŠ¥æœ€é«˜çš„20ä½ç»ç†ã€‘\n`;
  topManagers.forEach(m=>{
    ctx += `${m.name}(${m.company}): ${m.style}, ä»»èŒ${m.years.toFixed(1)}å¹´, å›æŠ¥${m.careerReturn.toFixed(1)}%, è§„æ¨¡${m.aum.toFixed(0)}äº¿\n`;
  });
  return ctx;
}

const MACRO_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„Aè‚¡å¸‚åœºå®è§‚ç­–ç•¥åˆ†æå¸ˆï¼Œéœ€è¦æ ¹æ®åŸºé‡‘ç»ç†çš„å®é™…æŒä»“å’Œä¸šç»©æ•°æ®ï¼Œç»“åˆä½ å¯¹å½“å‰å®è§‚ç»æµã€å›½é™…å½¢åŠ¿ã€å›½å†…æ”¿ç­–çš„ä¸“ä¸šçŸ¥è¯†ï¼Œç”Ÿæˆä¸€ä»½å…¨é¢çš„å¸‚åœºåˆ†ææŠ¥å‘Šã€‚

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–çš„æ–‡å­—æˆ–markdownæ ‡è®°ï¼š
{
  "period": "èµ·å§‹å¹´æœˆâ€”ç»“æŸå¹´æœˆ",
  "updated": "YYYY-MM-DD",
  "pastYearReview": [
    {"sector": "æ¿å—åç§°", "ret": "+XX%æˆ–-XX%", "icon": "emoji", "highlight": true/false,
     "detail": "100-200å­—æ·±åº¦åˆ†æ"}
  ],
  "intlFactors": [
    {"label": "å› ç´ åç§°", "score": 0-100, "trend": "2-4å­—è¶‹åŠ¿è¯", "cls": "warm/neutral/hot/cold",
     "desc": "80-150å­—æè¿°"}
  ],
  "domesticFactors": [
    {"label": "å› ç´ åç§°", "score": 0-100, "trend": "2-4å­—è¶‹åŠ¿è¯", "cls": "warm/neutral/hot/cold",
     "desc": "80-150å­—æè¿°"}
  ],
  "sectorRecos": [
    {"sector": "æ¿å—åç§°", "rating": "å¼ºçƒˆæ¨è/æ¨è/é€‚åº¦é…ç½®/è°¨æ…è§‚æœ›/ä½é…",
     "weight": é…ç½®æƒé‡ç™¾åˆ†æ¯”, "color": "CSSé¢œè‰²å€¼",
     "reason": "100-200å­—é…ç½®ç†ç”±"}
  ]
}

è¦æ±‚ï¼š
1. pastYearReviewè‡³å°‘8ä¸ªæ¿å—ï¼Œhighlightæ ‡è®°æ¶¨å¹…å‰3
2. intlFactorsè‡³å°‘5ä¸ªï¼ŒdomesticFactorsè‡³å°‘5ä¸ª
3. sectorRecosè‡³å°‘8ä¸ªï¼Œweightä¹‹å’Œçº¦ç­‰äº100
4. ç»“åˆåŸºé‡‘ç»ç†çœŸå®ä¸šç»©æ•°æ®åˆ†æ
5. åªè¾“å‡ºJSON`;

async function generateAIMacroOutlook(onProgress){
  if(!_302aiKey) return null;
  const dataCtx = buildManagerDataContext();
  const models = _aiProvider.macroModels;
  for(const m of models){
    try {
 if(onProgress) onProgress(` ${m.name} æ­£åœ¨åˆ†æå®è§‚å½¢åŠ¿...`);
      const userMsg = `è¯·æ ¹æ®ä»¥ä¸‹TOPåŸºé‡‘ç»ç†çš„çœŸå®ä¸šç»©æ•°æ®ï¼Œç»“åˆä½ å¯¹å½“å‰å¸‚åœºçš„ä¸“ä¸šåˆ¤æ–­ï¼Œç”Ÿæˆå®Œæ•´çš„å®è§‚å¸‚åœºåˆ†ææŠ¥å‘Šã€‚\n\n${dataCtx}\n\nè¯·åˆ†æï¼š1.è¿‡å»ä¸€å¹´å„æ¿å—è¡¨ç° 2.å›½é™…å½¢åŠ¿ 3.å›½å†…å½¢åŠ¿ 4.æœªæ¥3ä¸ªæœˆé…ç½®å»ºè®®`;
      const raw = await callAI(m.model, MACRO_SYSTEM_PROMPT, userMsg, 0.6);
      let jsonStr = raw.trim();
      if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if(!jsonMatch) throw new Error('No JSON');
      const parsed = JSON.parse(jsonMatch[0]);
      if(!parsed.pastYearReview || !parsed.sectorRecos) throw new Error('Missing fields');
 if(onProgress) onProgress(` ${m.name} åˆ†æå®Œæˆ`);
      return parsed;
    } catch(e){
      console.error(`${m.name} failed:`, e);
 if(onProgress) onProgress(` ${m.name} å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
      continue;
    }
  }
  return null;
}

// ==================== DATA FETCHING ====================
function setLoadProgress(pct, status){
  document.getElementById('loading-fill').style.width = pct+'%';
  document.getElementById('loading-status').textContent = status;
}

function loadManagerPage(pageNum){
  return new Promise((resolve)=>{
    const script = document.createElement('script');
    const url = `${API_BASE}?dt=14&mc=returnjson&ft=all&pn=${PER_PAGE}&pi=${pageNum}&sc=netnav&st=desc`;
    script.src = url;
    script.onload = ()=>{
      try {
        const data = window.returnjson;
        if(data && data.data) resolve(data.data);
        else resolve([]);
      } catch(e){ resolve([]); }
      script.remove();
    };
    script.onerror = ()=>{ resolve([]); script.remove(); };
    document.head.appendChild(script);
  });
}

async function fetchAllManagers(){
  const allData = [];
  for(let i=1; i<=PAGES_TO_FETCH; i++){
    setLoadProgress(Math.round(i/PAGES_TO_FETCH*70), `æ­£åœ¨è·å–ç¬¬ ${i}/${PAGES_TO_FETCH} é¡µæ•°æ®...`);
    try {
      const data = await loadManagerPage(i);
      if(data.length>0) allData.push(...data);
      else if(i>1) break;
    } catch(e){}
    await new Promise(r=>setTimeout(r, 200));
  }
  return allData;
}

// ==================== DATA PROCESSING ====================
function classifyStyle(fundNamesStr){
  const t = fundNamesStr || '';
  if(/è´§å¸|ç°é‡‘|ä½™é¢|ç†è´¢|æ·»åˆ©|å¤©å¤©/.test(t) && !/æ··åˆ|è‚¡ç¥¨|çµæ´»/.test(t)) return 'è´§å¸ç†è´¢';
  if(/çº¯å€º|åˆ©ç‡å€º|ä¿¡ç”¨å€º|çŸ­å€º|å®šå¼€å€º|å®šæœŸå¼€æ”¾å€º/.test(t) && !/æ··åˆ|è‚¡ç¥¨|çµæ´»|å¢å¼º/.test(t)) return 'çº¯å€ºå›ºæ”¶';
  if(/é»„é‡‘|ç™½é“¶|è´µé‡‘å±/.test(t)) return 'è´µé‡‘å±';
  if(/æœ‰è‰²|é“œ|é“|é”‚|ç¨€åœŸ|é‡‘å±ææ–™|çŸ¿ä¸š|åŸºæœ¬é‡‘å±/.test(t)) return 'æœ‰è‰²é‡‘å±';
  if(/åŸæ²¹|å•†å“|èµ„æºç²¾é€‰|å¤§å®—/.test(t)) return 'å•†å“èµ„æº';
  if(/QDII|æ¸¯è‚¡|å…¨çƒ|æµ·å¤–|çº³æ–¯è¾¾å…‹|æ ‡æ™®|æ’ç”Ÿ|ä¸­å›½ä¼˜åŠ¿|ç¾å…ƒ/.test(t)) return 'è·¨å¢ƒQDII';
  if(/(æŒ‡æ•°|ETF)/.test(t) && /é‡åŒ–|å¢å¼º|æ™ºé€‰/.test(t)) return 'æŒ‡æ•°é‡åŒ–';
  if(/ç§‘æŠ€|äººå·¥æ™ºèƒ½|èŠ¯ç‰‡|åŠå¯¼ä½“|ç”µå­|è®¡ç®—æœº|é€šä¿¡|ä¿¡æ¯|æ•°å­—ç»æµ|æ™ºèƒ½é©±åŠ¨/.test(t)) return 'ç§‘æŠ€æˆé•¿';
  if(/æ–°èƒ½æº|å…‰ä¼|ç¢³|ç”µæ± |ä½ç¢³|ç¯ä¿/.test(t)) return 'æ–°èƒ½æº';
  if(/å†›å·¥|å›½é˜²|èˆªå¤©|èˆªç©º/.test(t)) return 'å†›å·¥å›½é˜²';
  if(/åŒ»[è¯ç–—]|å¥åº·|ç”Ÿç‰©|åˆ›æ–°è¯/.test(t)) return 'åŒ»è¯å¥åº·';
  if(/åŒ–å·¥|ææ–™|åˆ¶é€ |[å·¥ä¸š]ç²¾é€‰/.test(t) && !/ç”µå­|åŠå¯¼ä½“/.test(t)) return 'åŒ–å·¥ææ–™';
  if(/åŸºå»º|åŸºç¡€è®¾æ–½|ä¸€å¸¦ä¸€è·¯|å·¥ç¨‹|å»ºç­‘|é“è·¯/.test(t)) return 'åŸºç¡€è®¾æ–½';
  if(/å…¬ç”¨äº‹ä¸š|ç”µåŠ›|æ°´åŠ¡|ç‡ƒæ°”|ç¯å¢ƒæ²»ç†/.test(t)) return 'å…¬ç”¨äº‹ä¸š';
  if(/å†œä¸š|ä¹¡æ‘æŒ¯å…´|ç§ä¸š|ç•œç‰§|å†œäº§å“/.test(t)) return 'å†œä¸šé£Ÿå“';
  if(/é‡‘èç§‘æŠ€|é“¶è¡Œ|ä¿é™©|è¯åˆ¸|é‡‘èåœ°äº§/.test(t) && /æŒ‡æ•°|ETF|ä¸»é¢˜/.test(t)) return 'é‡‘è';
  if(/åœ°äº§|REITs|ä¸åŠ¨äº§|åŸå¸‚æ›´æ–°/.test(t)) return 'åœ°äº§REITs';
  if(/æ¶ˆè´¹|é£Ÿå“|ç™½é…’|é›¶å”®|å®¶ç”µ|é¥®æ–™|æ–‡ä½“/.test(t)) return 'æ¶ˆè´¹';
  if(/çº¢åˆ©|ä½æ³¢|è‚¡æ¯|åˆ†çº¢/.test(t)) return 'çº¢åˆ©ä»·å€¼';
  if(/ä»·å€¼|è“ç­¹|å¤§ç›˜ç²¾é€‰/.test(t)) return 'ä»·å€¼è“ç­¹';
  if(/æˆé•¿|åˆ›æ–°|å…ˆé”‹|æ–°å…´|è½¬å‹|åŠ¨åŠ›/.test(t)) return 'æˆé•¿';
  if(/å‘¨æœŸ|é’¢é“|ç…¤ç‚­/.test(t)) return 'å‘¨æœŸ';
  if(/FOF|æŒæœ‰æœŸæ··åˆå‘èµ·\(FOF\)/.test(t)) return 'FOFé…ç½®';
  if(/å€ºåˆ¸|å¢å¼º|å›ºæ”¶|æ·»åˆ©|ç¨³å¥/.test(t)) return 'å›ºæ”¶å¢å¼º';
  if(/(æŒ‡æ•°|ETF|LOF)/.test(t)) return 'æŒ‡æ•°é‡åŒ–';
  return 'çµæ´»é…ç½®';
}

function parseManager(row){
  if(!row || row.length<12) return null;
  const careerReturnStr = (row[7]||'0').replace('%','');
  const careerReturn = parseFloat(careerReturnStr)||0;
  const aumStr = (row[10]||'0').replace('äº¿å…ƒ','');
  const aum = parseFloat(aumStr)||0;
  const workDays = parseInt(row[6])||0;
  const years = Math.round(workDays/365*10)/10;
  const bestReturnStr = (row[11]||'0').replace('%','');
  const bestReturn = parseFloat(bestReturnStr)||0;
  const fundNames = row[5]||'';
  return {
    id: row[0], name: row[1], companyId: row[2], company: row[3],
    fundCodes: (row[4]||'').split(',').filter(Boolean),
    fundNames: fundNames.split(',').filter(Boolean),
    fundNamesStr: fundNames, workDays, years, careerReturn,
    bestFundCode: row[8]||'', bestFundName: row[9]||'',
    aum, bestReturn, style: classifyStyle(fundNames)
  };
}

function processManagers(rawData){
  const parsed = rawData.map(parseManager).filter(Boolean);
  const seen = new Set();
  const unique = [];
  parsed.forEach(m=>{
    const key = m.name + '|' + m.company;
    if(!seen.has(key)){ seen.add(key); unique.push(m); }
  });
  allManagers = unique;
  filteredManagers = unique.filter(m=> m.style !== 'è´§å¸ç†è´¢' && m.style !== 'çº¯å€ºå›ºæ”¶');
  filteredManagers.sort((a,b)=>b.careerReturn - a.careerReturn);
  if(filteredManagers.length>500) filteredManagers = filteredManagers.slice(0,500);
  return filteredManagers;
}

// ==================== ANALYSIS ENGINE ====================
function median(arr){ const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; }
function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }

function runAnalysis(managers){
  const a = {};
  const returns = managers.map(m=>m.careerReturn);
  const aums = managers.map(m=>m.aum);
  const years = managers.map(m=>m.years);
  a.overview = {
    count: managers.length,
    totalManagers: allManagers.length,
    avgReturn: mean(returns),
    medianReturn: median(returns),
    maxReturn: Math.max(...returns),
    minReturn: Math.min(...returns),
    avgYears: mean(years),
    totalAUM: aums.reduce((s,v)=>s+v,0),
    positiveCount: returns.filter(r=>r>0).length,
    over100Count: returns.filter(r=>r>100).length,
    over200Count: returns.filter(r=>r>200).length,
  };

  const styleCounts = {};
  const styleReturns = {};
  managers.forEach(m=>{
    styleCounts[m.style] = (styleCounts[m.style]||0) + 1;
    if(!styleReturns[m.style]) styleReturns[m.style] = [];
    styleReturns[m.style].push(m.careerReturn);
  });
  a.styles = Object.keys(styleCounts)
    .map(s=>({
      style: s, count: styleCounts[s],
      pct: (styleCounts[s]/managers.length*100),
      avgReturn: mean(styleReturns[s]),
      medianReturn: median(styleReturns[s]),
    }))
    .sort((a,b)=>b.count-a.count);

  const retBrackets = [
    {label:'<0%',min:-999,max:0},{label:'0-20%',min:0,max:20},
    {label:'20-50%',min:20,max:50},{label:'50-100%',min:50,max:100},
    {label:'100-200%',min:100,max:200},{label:'200%+',min:200,max:9999}
  ];
  a.returnDist = retBrackets.map(b=>{
    const count = managers.filter(m=>m.careerReturn>=b.min && m.careerReturn<b.max).length;
    return {...b, count, pct: count/managers.length*100};
  });
  return a;
}

// ==================== SECTOR DISCOVERY ENGINE ====================
let sectorDiscovery = null;

function discoverSectors(managers){
  const styleMap = {};
  managers.forEach(m=>{
    if(!styleMap[m.style]) styleMap[m.style] = {
      style: m.style, managers: [], returns: [], aums: [], years: [], codes: new Set()
    };
    const s = styleMap[m.style];
    s.managers.push(m);
    s.returns.push(m.careerReturn);
    s.aums.push(m.aum);
    s.years.push(m.years);
    m.fundCodes.forEach(c=>s.codes.add(c));
  });

  const overallAvgReturn = mean(managers.map(m=>m.careerReturn));
  const overallMedianReturn = median(managers.map(m=>m.careerReturn));
  const returnStdDev = Math.sqrt(managers.map(m=>Math.pow(m.careerReturn-overallAvgReturn,2)).reduce((a,b)=>a+b,0)/managers.length);

  const discoveries = Object.values(styleMap)
    .filter(s=>s.managers.length>=2)
    .map(s=>{
      const avgReturn = mean(s.returns);
      const medReturn = median(s.returns);
      const avgAUM = mean(s.aums);
      const totalAUM = s.aums.reduce((a,b)=>a+b,0);
      const avgYears = mean(s.years);
      const topManager = s.managers.sort((a,b)=>b.careerReturn-a.careerReturn)[0];
      const annReturn = avgYears>0 ? (Math.pow(1+avgReturn/100, 1/avgYears)-1)*100 : 0;
      const count = s.managers.length;
      const crowding = count / managers.length * 100;
      const excessReturn = avgReturn - overallAvgReturn;
      const zScore = returnStdDev>0 ? excessReturn / returnStdDev : 0;
      const alphaSignal = excessReturn > 0 && crowding < 10;
      const hiddenAlpha = excessReturn > returnStdDev*0.5 && crowding < 5;
      const winRate = s.returns.filter(r=>r>0).length / count * 100;

      const retContrib = Math.min(Math.max(excessReturn/3, -10), 40);
      const annContrib = Math.min(Math.max(annReturn*1.5, 0), 20);
      const scarcityContrib = alphaSignal ? Math.min(20, (excessReturn/returnStdDev)*15) : 0;
      const winContrib = winRate/10;
      const aumContrib = Math.min(totalAUM/100, 10);

      const discoveryScore = Math.round(Math.max(0, Math.min(100,
        retContrib + annContrib + scarcityContrib + winContrib + aumContrib
      )));

      let signal = 'normal';
      if(hiddenAlpha || (excessReturn > returnStdDev && crowding < 8)) signal = 'alpha';
      else if(excessReturn > returnStdDev*0.3 && winRate > 70) signal = 'strong';
      else if(excessReturn > 0 && count <= 5) signal = 'emerging';

      return {
        style: s.style, count, crowding, avgReturn, medReturn, annReturn, avgAUM, totalAUM,
        avgYears, topManager, winRate, excessReturn, zScore,
        alphaSignal, hiddenAlpha, signal, discoveryScore,
        fundCount: s.codes.size,
      };
    })
    .sort((a,b)=>b.discoveryScore-a.discoveryScore);

  return { discoveries, overallAvgReturn, overallMedianReturn, returnStdDev };
}

// ==================== RENDERING ====================
function fmt(n, d=1){ return n.toFixed(d); }
function fmtAUM(n){ return n>=10000?fmt(n/10000,1)+'ä¸‡äº¿':n>=1?fmt(n,0)+'äº¿':fmt(n*100,0)+'ç™¾ä¸‡'; }

function renderAll(){
  const el = document.getElementById('main-content');
  let html = '';
  html += renderOverview();
  html += renderMarketReview();
  html += renderDataDiscovery();
  html += renderOutlook();
  html += renderRecommendations();
  html += renderSummary();
  el.innerHTML = html;
}

// ===== 1. æ•°æ®æ¦‚è§ˆ =====
function renderOverview(){
  const o = analysis.overview;
  return `<div class="section" id="sec-overview">
 <div class="sec-header"><span class="sec-icon"></span><span class="sec-title">æ•°æ®æ¦‚è§ˆ</span><span class="sec-badge">TOP ${o.count}</span></div>
    <div class="sec-body">
      <div class="metrics">
        <div class="metric"><div class="m-val">${o.count}</div><div class="m-label">æƒç›Šç±»åŸºé‡‘ç»ç†</div></div>
        <div class="metric"><div class="m-val">${fmt(o.avgReturn)}%</div><div class="m-label">å¹³å‡ä»»èŒå›æŠ¥</div></div>
      </div>
      <div class="metrics tri">
        <div class="metric"><div class="m-val">${fmt(o.avgYears)}</div><div class="m-label">å¹³å‡ä»ä¸š(å¹´)</div></div>
        <div class="metric"><div class="m-val">${fmtAUM(o.totalAUM)}</div><div class="m-label">æ€»ç®¡ç†è§„æ¨¡</div></div>
        <div class="metric"><div class="m-val">${fmt(o.maxReturn)}%</div><div class="m-label">æœ€é«˜å›æŠ¥</div></div>
      </div>
      <div style="font-size:11px;font-weight:600;margin:6px 0 6px;color:var(--sub)">å›æŠ¥åˆ†å¸ƒ</div>
      <div class="bar-chart">${analysis.returnDist.map(b=>{
        const w = Math.max(b.pct/Math.max(...analysis.returnDist.map(x=>x.pct))*100,2);
        const color = b.min>=100?'#ef4444':b.min>=50?'#f97316':b.min>=20?'#eab308':b.min>=0?'#22c55e':'#94a3b8';
        return `<div class="bar-row"><div class="bar-label">${b.label}</div><div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${b.count}</span></div></div><div class="bar-val">${fmt(b.pct)}%</div></div>`;
      }).join('')}</div>
    </div>
  </div>`;
}

// ===== 2. è¿‡å»ä¸€å¹´å›é¡¾ï¼ˆç²¾ç®€ï¼‰ =====
function renderMarketReview(){
  const m = MACRO_OUTLOOK;
  const review = [...m.pastYearReview].sort((a,b)=>{
    const ra = parseFloat(a.ret.replace('%','').replace('+',''));
    const rb = parseFloat(b.ret.replace('%','').replace('+',''));
    return rb-ra;
  });
  const maxRet = Math.max(...review.map(r=>Math.abs(parseFloat(r.ret.replace('%','').replace('+','')))));

  const aiTag = aiMacroGenerated ? '<span style="font-size:9px;background:#3b82f6;color:white;padding:1px 6px;border-radius:4px;margin-left:6px">AI</span>' : '';

  let html = `<div class="section" id="sec-review">
 <div class="sec-header"><span class="sec-icon"></span><span class="sec-title">è¿‡å»ä¸€å¹´æ¿å—è¡¨ç°${aiTag}</span></div>
    <div class="sec-body">
      <div class="bar-chart">`;
  review.forEach(r=>{
    const val = parseFloat(r.ret.replace('%','').replace('+',''));
    const w = Math.abs(val)/maxRet*100;
    const color = val>=30?'#ef4444':val>=15?'#f59e0b':val>=0?'#22c55e':'#6366f1';
    html += `<div class="bar-row">
      <div class="bar-label" style="font-weight:${r.highlight?'700':'500'}">${r.icon} ${r.sector}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${w}%;background:${color}"><span>${r.ret}</span></div></div>
      <div class="bar-val" style="color:${color};font-weight:700">${r.ret}</div>
    </div>`;
  });
  html += `</div>`;

  const highlights = review.filter(r=>r.highlight);
  if(highlights.length>0){
    html += `<div class="insight" style="margin-top:12px">
 <div class="i-title"> å¼ºåŠ¿æ¿å—</div>
      <div class="i-body">${highlights.map(r=>`<b>${r.sector}(${r.ret})</b>ï¼š${r.detail.substring(0,80)}...`).join('<br>')}</div>
    </div>`;
  }
  html += `</div></div>`;
  return html;
}

// ===== 3. æ•°æ®é©±åŠ¨Â·èµ›é“å‘ç° =====
function renderDataDiscovery(){
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const { discoveries, overallAvgReturn, returnStdDev } = sectorDiscovery;

  const alphaCount = discoveries.filter(d=>d.signal==='alpha').length;
  const strongCount = discoveries.filter(d=>d.signal==='strong').length;
  const emergingCount = discoveries.filter(d=>d.signal==='emerging').length;

 const signalLabel = {alpha:'è¢«å¿½è§†çš„Î±',strong:'å¼ºåŠ¿ä¿¡å·',emerging:'æ½œåŠ›èŒèŠ½',normal:''};
  const signalDesc = {
    alpha:'é«˜è¶…é¢å›æŠ¥+ä½æ‹¥æŒ¤åº¦=å¯èƒ½è¢«å¸‚åœºå¿½è§†çš„ç»“æ„æ€§æœºä¼š',
    strong:'è¶…é¢å›æŠ¥æ˜¾è‘—ä¸”èƒœç‡é«˜ï¼Œå·²è¢«å¸‚åœºè®¤å¯ä½†è¶‹åŠ¿ä»åœ¨',
    emerging:'ç®¡ç†äººå°‘ä½†å›æŠ¥çªå‡ºï¼Œå¯èƒ½æ˜¯æ—©æœŸä¿¡å·',
    normal:'è¡¨ç°ä¸­æ€§æˆ–åå¼±'
  };

  let html = `<div class="section" id="sec-discover">
 <div class="sec-header"><span class="sec-icon"></span><span class="sec-title">æ•°æ®é©±åŠ¨Â·èµ›é“å‘ç°</span><span class="sec-badge">è‡ªä¸‹è€Œä¸Š</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:10px">
        è‡ªåŠ¨æ‰«ææ‰€æœ‰${discoveries.length}ä¸ªé£æ ¼çš„<b>è¶…é¢å›æŠ¥</b>ã€<b>æ‹¥æŒ¤åº¦</b>ã€<b>èƒœç‡</b>ï¼Œè¯†åˆ«ä¸‰ç±»ä¿¡å·ï¼š
 <span style="color:#92400e">Î±</span> = é«˜å›æŠ¥+ä½æ‹¥æŒ¤ï¼Œ
 <span style="color:#166534">å¼ºåŠ¿</span> = é«˜å›æŠ¥+é«˜èƒœç‡ï¼Œ
 <span style="color:#1e40af">èŒèŠ½</span> = äººå°‘ä½†çªå‡º
      </div>
      <div class="metrics tri">
 <div class="metric"><div class="m-val" style="color:#92400e">${alphaCount}</div><div class="m-label">è¢«å¿½è§†çš„Î±</div></div>
 <div class="metric"><div class="m-val" style="color:#166534">${strongCount}</div><div class="m-label">å¼ºåŠ¿ä¿¡å·</div></div>
 <div class="metric"><div class="m-val" style="color:#1e40af">${emergingCount}</div><div class="m-label">æ½œåŠ›èŒèŠ½</div></div>
      </div>
      <div style="font-size:9px;color:var(--sub);margin:4px 0 10px;text-align:center">å…¨ä½“å‡å› ${fmt(overallAvgReturn)}% Â· æ ‡å‡†å·® ${fmt(returnStdDev)} Â· è¶…å‡å€¼+0.5Ïƒ(${fmt(overallAvgReturn+returnStdDev*0.5)}%)å³ä¸ºæ˜¾è‘—è¶…é¢</div>`;

  const signaled = discoveries.filter(d=>d.signal!=='normal');
  const normals = discoveries.filter(d=>d.signal==='normal');

  signaled.forEach(d=>{
    html += `<div class="disc-card ${d.signal}">
      <div class="disc-header">
        <span class="disc-signal ${d.signal}">${signalLabel[d.signal]}</span>
        <span class="disc-style">${d.style}</span>
        <span style="font-size:14px;font-weight:800;color:${d.avgReturn>=0?'var(--up)':'var(--down)'}">${d.discoveryScore}åˆ†</span>
      </div>
      <div class="disc-metrics">
        <div class="disc-m"><div class="dm-val" style="color:${d.avgReturn>overallAvgReturn?'var(--up)':'inherit'}">${fmt(d.avgReturn)}%</div><div class="dm-label">å¹³å‡å›æŠ¥</div></div>
        <div class="disc-m"><div class="dm-val">${d.count}äºº</div><div class="dm-label">æ‹¥æŒ¤åº¦${fmt(d.crowding)}%</div></div>
        <div class="disc-m"><div class="dm-val">${fmt(d.winRate,0)}%</div><div class="dm-label">èƒœç‡</div></div>
        <div class="disc-m"><div class="dm-val">${fmt(d.annReturn)}%</div><div class="dm-label">å¹´åŒ–</div></div>
      </div>
      <div class="disc-body">
        è¶…é¢å›æŠ¥: <b>${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%</b> (Z=${fmt(d.zScore,2)}) Â·
        Topç»ç†: <b>${d.topManager.name}</b>(${d.topManager.company}, +${fmt(d.topManager.careerReturn)}%)
      </div>
      <div class="disc-why">${signalDesc[d.signal]}</div>
    </div>`;
  });

  if(normals.length>0){
 html += `<div style="font-size:11px;font-weight:600;color:var(--sub);margin:12px 0 6px"> å…¶ä»–é£æ ¼ï¼ˆæ— æ˜¾è‘—ä¿¡å·ï¼‰</div>
    <table class="compact-table">
      <tr><th>é£æ ¼</th><th>äººæ•°</th><th>å‡å›</th><th>èƒœç‡</th><th>å¹´åŒ–</th><th>å¾—åˆ†</th></tr>
      ${normals.map(d=>`<tr>
        <td><b>${d.style}</b></td>
        <td>${d.count}</td>
        <td style="color:${d.avgReturn>overallAvgReturn?'var(--up)':'inherit'}">${fmt(d.avgReturn)}%</td>
        <td>${fmt(d.winRate,0)}%</td>
        <td>${fmt(d.annReturn)}%</td>
        <td>${d.discoveryScore}</td>
      </tr>`).join('')}
    </table>`;
  }

  const topAlpha = signaled.filter(d=>d.signal==='alpha');
  html += `<div class="insight" style="margin-top:12px">
 <div class="i-title"> æ ¸å¿ƒä»·å€¼</div>
    <div class="i-body">
      è®©æ‰€æœ‰${discoveries.length}ä¸ªé£æ ¼è‡ªåŠ¨æ’åï¼Œä¸æ¼æ‰ä»»ä½•èµ›é“ã€‚${topAlpha.length>0?`å½“å‰Î±èµ›é“ï¼š<b>${topAlpha.map(d=>`${d.style}(è¶…é¢${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%)`).join('ã€')}</b>â€”â€”ä½æ‹¥æŒ¤+é«˜å›æŠ¥ï¼Œæœ€å®¹æ˜“è¢«ä¼ ç»Ÿåˆ†æé—æ¼ã€‚`:''}
    </div>
  </div>`;
  html += `</div></div>`;
  return html;
}

// ===== 4. æœªæ¥ä¸‰ä¸ªæœˆå‰ç» =====
function renderOutlook(){
  const m = MACRO_OUTLOOK;
  const aiTag = aiMacroGenerated ? '<span style="font-size:9px;background:#3b82f6;color:white;padding:1px 6px;border-radius:4px;margin-left:6px">AIåˆ†æ</span>' : '';

  let html = `<div class="section" id="sec-outlook">
 <div class="sec-header"><span class="sec-icon"></span><span class="sec-title">æœªæ¥ä¸‰ä¸ªæœˆå‰ç»${aiTag}</span><span class="sec-badge">${m.period}</span></div>
    <div class="sec-body">
 <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--sub)"> å›½é™…å½¢åŠ¿</div>
      ${m.intlFactors.map(f=>{
        const color = f.score>=75?'#ef4444':f.score>=60?'#f59e0b':f.score>=45?'#8b5cf6':'#64748b';
        return `<div class="outlook-factor">
          <div class="of-label">${f.label}</div>
          <div class="of-bar"><div class="of-fill" style="width:${f.score}%;background:${color}"></div></div>
          <div class="of-score" style="color:${color}">${f.score}</div>
          <div class="of-trend ${f.cls}">${f.trend}</div>
        </div>
        <div style="font-size:9px;color:var(--sub);padding:0 0 6px 68px;line-height:1.4">${f.desc}</div>`;
      }).join('')}

 <div style="font-size:11px;font-weight:600;margin:16px 0 8px;color:var(--sub)"> å›½å†…å½¢åŠ¿</div>
      ${m.domesticFactors.map(f=>{
        const color = f.score>=75?'#ef4444':f.score>=60?'#f59e0b':f.score>=45?'#8b5cf6':'#64748b';
        return `<div class="outlook-factor">
          <div class="of-label">${f.label}</div>
          <div class="of-bar"><div class="of-fill" style="width:${f.score}%;background:${color}"></div></div>
          <div class="of-score" style="color:${color}">${f.score}</div>
          <div class="of-trend ${f.cls}">${f.trend}</div>
        </div>
        <div style="font-size:9px;color:var(--sub);padding:0 0 6px 68px;line-height:1.4">${f.desc}</div>`;
      }).join('')}

      ${(() => {
        const topRecos = m.sectorRecos.filter(s=>s.rating.includes('å¼ºçƒˆ')).slice(0,2);
        if(topRecos.length>0){
          return `<div class="insight" style="margin:12px 0 8px;background:linear-gradient(135deg,#fef3c7,#fffbeb);border-left:3px solid #d97706">
 <div class="i-title"> æ ¸å¿ƒåˆ¤æ–­ï¼š${topRecos.map(s=>s.sector).join(' + ')}</div>
            <div class="i-body">${topRecos.map(s=>`<b>${s.sector}(${s.weight}%)ï¼š</b>${s.reason}`).join('<br><br>')}</div>
          </div>`;
        }
        return '';
      })()}

 <div style="font-size:11px;font-weight:600;margin:16px 0 8px;color:var(--sub)"> æ¿å—é…ç½®å»ºè®®</div>
      ${m.sectorRecos.map(s=>{
        const ratingCls = s.rating.includes('å¼ºçƒˆ')?'strong':s.rating.includes('æ¨è')||s.rating.includes('é€‚åº¦')?'ok':'weak';
        return `<div class="alloc-row">
          <div class="alloc-sector">${s.sector}</div>
          <div class="alloc-bar"><div class="alloc-fill" style="width:${s.weight*2.5}%;background:${s.color}"><span>${s.weight}%</span></div></div>
          <div class="alloc-rating ${ratingCls}">${s.rating}</div>
        </div>
        <div style="font-size:9px;color:var(--sub);padding:2px 0 6px 80px;line-height:1.4">${s.reason}</div>`;
      }).join('')}
    </div>
  </div>`;
  return html;
}

// ===== 5. ç»¼åˆæ¨èåŸºé‡‘ =====
function renderRecommendations(){
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const { discoveries, overallAvgReturn } = sectorDiscovery;

  const dynamicStyleScore = {};
  discoveries.forEach(d=>{
    let score = d.discoveryScore * 0.3;
    if(d.signal==='alpha') score += 15;
    else if(d.signal==='strong') score += 8;
    else if(d.signal==='emerging') score += 5;
    const macroMatch = MACRO_OUTLOOK.sectorRecos.find(s=>{
      const sectorLower = s.sector;
      if(d.style==='ç§‘æŠ€æˆé•¿'||d.style==='æŒ‡æ•°é‡åŒ–') return sectorLower.includes('ç§‘æŠ€');
      if(d.style==='æœ‰è‰²é‡‘å±') return sectorLower.includes('æœ‰è‰²');
      if(d.style==='è´µé‡‘å±'||d.style==='å•†å“èµ„æº') return sectorLower.includes('è´µé‡‘å±');
      if(d.style==='çº¢åˆ©ä»·å€¼'||d.style==='ä»·å€¼è“ç­¹') return sectorLower.includes('çº¢åˆ©');
      if(d.style==='æ¶ˆè´¹'||d.style==='åŒ»è¯å¥åº·') return sectorLower.includes('æ¶ˆè´¹');
      if(d.style==='å†›å·¥å›½é˜²'||d.style==='æˆé•¿') return sectorLower.includes('åˆ¶é€ ');
      if(d.style==='è·¨å¢ƒQDII') return sectorLower.includes('è·¨å¢ƒ');
      if(d.style==='æ–°èƒ½æº') return sectorLower.includes('æ–°èƒ½æº');
      if(d.style==='åŒ–å·¥ææ–™'||d.style==='å‘¨æœŸ'||d.style==='åŸºç¡€è®¾æ–½') return sectorLower.includes('åˆ¶é€ ');
      return false;
    });
    if(macroMatch) score += macroMatch.weight * 0.5;
    dynamicStyleScore[d.style] = Math.round(score);
  });

  const scored = filteredManagers
    .filter(m=>m.careerReturn>0 && m.bestFundCode && m.style!=='å›ºæ”¶å¢å¼º' && m.years>=2)
    .map(m=>{
      const retScore = Math.min(m.careerReturn/3, 35);
      const sectorScore = dynamicStyleScore[m.style] || 10;
      const expScore = m.years>=3 && m.years<=8 ? 15 : m.years>=2 && m.years<3 ? 10 : m.years>8 && m.years<=15 ? 12 : 8;
      const aumScore = m.aum>=10 && m.aum<=300 ? 5 : 2;
      const total = retScore + sectorScore + expScore + aumScore;
      return {...m, score: Math.round(total)};
    })
    .sort((a,b)=>b.score-a.score);

  const signalStyles = new Set(discoveries.filter(d=>d.signal!=='normal').map(d=>d.style));
  const styleCounts = {};
  const recos = [];
  for(const m of scored){
    if(recos.length>=20) break;
    const sc = styleCounts[m.style]||0;
    if(sc>=3) continue;
    if(signalStyles.has(m.style) && sc===0){
      styleCounts[m.style] = 1;
      recos.push(m);
    }
  }
  for(const m of scored){
    if(recos.length>=20) break;
    if(recos.find(r=>r.id===m.id)) continue;
    const sc = styleCounts[m.style]||0;
    if(sc>=3) continue;
    styleCounts[m.style] = sc+1;
    recos.push(m);
  }
  recos.sort((a,b)=>b.score-a.score);

  const styleSignals = {};
  discoveries.forEach(d=>{ if(d.signal!=='normal') styleSignals[d.style]=d.signal; });
 const signalEmoji = {alpha:'',strong:'',emerging:''};
  const signalColor = {alpha:'#d97706',strong:'#22c55e',emerging:'#3b82f6'};

  return `<div class="section" id="sec-recos">
 <div class="sec-header"><span class="sec-icon"></span><span class="sec-title">ç»¼åˆæ¨èåŸºé‡‘</span><span class="sec-badge">ç²¾é€‰${recos.length}åª</span></div>
    <div class="sec-body">
      <div style="font-size:10px;color:var(--sub);line-height:1.6;margin-bottom:12px">
        è¯„åˆ†ï¼š<b>å‘ç°å¼•æ“(40%)</b> + <b>å®è§‚åŒ¹é…(15%)</b> + <b>ä»»èŒå›æŠ¥(30%)</b> + <b>ç»éªŒè§„æ¨¡(15%)</b>ã€‚
 å¸¦æ ‡è®°ä¸º<span style="color:#d97706">Î±</span>/<span style="color:#22c55e">å¼ºåŠ¿</span>/<span style="color:#3b82f6">èŒèŠ½</span>ä¿¡å·ã€‚
      </div>
      ${recos.map((m,i)=>{
        const rankCls = i===0?'r1':i===1?'r2':i===2?'r3':'rn';
        const retColor = m.careerReturn>=0?'var(--up)':'var(--down)';
        const sig = styleSignals[m.style];
        const hasSig = !!sig;
        const borderColor = hasSig ? signalColor[sig] : '';
        const bgColor = sig==='alpha'?'#fffbeb':sig==='strong'?'#f0fdf4':sig==='emerging'?'#eff6ff':'';
        const inWatch = watchlist.find(w=>w.code===m.bestFundCode);
        const inHold = holdings.find(h=>h.code===m.bestFundCode);
        const safeName = m.bestFundName.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
        return `<div class="reco-card" style="${hasSig?`border-left:3px solid ${borderColor};background:${bgColor}`:''}">
          <div class="rc-top">
            <div class="rc-rank ${rankCls}">${i+1}</div>
            <div class="rc-name">${m.bestFundName}</div>
            <div class="rc-ret" style="color:${retColor}">+${fmt(m.careerReturn)}%</div>
          </div>
          <div class="rc-mid">
            <span class="rc-tag mgr">\ud83d\udc64 ${m.name}</span>
            <span class="rc-tag style" style="${hasSig?`background:${borderColor}20;color:${borderColor}`:''}">${m.style}${hasSig?' '+signalEmoji[sig]:''}</span>
            <span style="font-size:9px;color:var(--sub)">${m.bestFundCode} \u00b7 ${m.company} \u00b7 ${fmt(m.years,0)}\u5e74 \u00b7 \u7efc\u5408${m.score}\u5206</span>
          </div>
          <div class="rc-actions">
            ${inWatch||inHold
              ?'<button class="rc-btn added" disabled>\u2705 \u5df2\u6dfb\u52a0</button>'
              :`<button class="rc-btn primary" onclick="addToWatch('${m.bestFundCode}','${safeName}','${m.style}')">\u2b50 \u52a0\u81ea\u9009</button>`}
            ${inHold
              ?''
              :`<button class="rc-btn outline" onclick="addToHold('${m.bestFundCode}','${safeName}')">\ud83d\udcb0 \u52a0\u6301\u4ed3</button>`}
          </div>
        </div>`;
      }).join('')}
      <div class="warn-box">
 <b> é£é™©æç¤ºï¼š</b>ä»¥ä¸Šæ¨èåŸºäºæ•°æ®é©±åŠ¨åˆ†æï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚å†å²è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Šã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå»ºè®®åˆ†æ‰¹å»ºä»“ã€ä¸­é•¿çº¿æŒæœ‰ã€‚
      </div>
    </div>
  </div>`;
}

// ===== 6. æŠ•èµ„ç­–ç•¥æ€»ç»“ =====
function renderSummary(){
  const o = analysis.overview;
  if(!sectorDiscovery) sectorDiscovery = discoverSectors(filteredManagers);
  const { discoveries } = sectorDiscovery;
  const m = MACRO_OUTLOOK;

  const alphaStyles = discoveries.filter(d=>d.signal==='alpha');
  const strongStyles = discoveries.filter(d=>d.signal==='strong');
  const emergingStyles = discoveries.filter(d=>d.signal==='emerging');
  const allSignals = [...alphaStyles, ...strongStyles, ...emergingStyles];

  const bestStyle = [...analysis.styles].sort((a,b)=>b.avgReturn-a.avgReturn)[0];

  return `<div class="summary-box" id="sec-summary">
 <div class="sb-title"> æŠ•èµ„ç­–ç•¥æ€»ç»“</div>
    <p>åŸºäº <b>${o.count}</b> ä½å¤´éƒ¨åŸºé‡‘ç»ç†çš„æ•°æ®åˆ†æ + å®è§‚ç ”åˆ¤ï¼š</p>

    <ul>
 ${alphaStyles.length>0?`<li><b style="color:#92400e"> è¢«å¿½è§†çš„Î±(${alphaStyles.length}ä¸ª)ï¼š</b>${alphaStyles.map(d=>`${d.style}(è¶…é¢${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%, èƒœç‡${fmt(d.winRate,0)}%)`).join('ã€')}â€”â€”ä½æ‹¥æŒ¤+é«˜å›æŠ¥ï¼Œä¸­é•¿çº¿æœ€æœ‰ä»·å€¼ã€‚</li>`:''}
 ${strongStyles.length>0?`<li><b style="color:#166534"> å¼ºåŠ¿ä¿¡å·(${strongStyles.length}ä¸ª)ï¼š</b>${strongStyles.map(d=>`${d.style}(è¶…é¢${d.excessReturn>=0?'+':''}${fmt(d.excessReturn)}%)`).join('ã€')}â€”â€”è¶‹åŠ¿ç¡®è®¤ï¼Œå¯ä½œæ ¸å¿ƒé…ç½®ã€‚</li>`:''}
 ${emergingStyles.length>0?`<li><b style="color:#1e40af"> æ½œåŠ›èŒèŠ½(${emergingStyles.length}ä¸ª)ï¼š</b>${emergingStyles.map(d=>`${d.style}(${d.count}äºº)`).join('ã€')}â€”â€”å€¼å¾—å‰ç»å¸ƒå±€ã€‚</li>`:''}
      ${bestStyle?`<li><b>æœ€å¼ºé£æ ¼ï¼š</b>${bestStyle.style}(å‡å›${fmt(bestStyle.avgReturn)}%)</li>`:''}
    </ul>

 <p style="margin-top:8px;font-weight:600"> é…ç½®å»ºè®®ï¼ˆ${m.period}ï¼‰ï¼š</p>
    <ul>
      <li><b>ç¬¬ä¸€æ¢¯é˜Ÿï¼š</b>${allSignals.filter(d=>d.signal==='alpha'||d.discoveryScore>=60).map(d=>d.style).join('ã€')||'ç§‘æŠ€/AI, æœ‰è‰²é‡‘å±'}â€”â€”æ•°æ®+å®è§‚åŒé‡å…±æŒ¯ã€‚</li>
      ${m.sectorRecos.filter(s=>s.weight>=12).map(s=>`<li><b>${s.sector}(${s.weight}%)ï¼š</b>${s.reason.substring(0,60)}...</li>`).join('')}
    </ul>

 <p style="margin-top:8px;font-weight:600"> é£æ§é“å¾‹ï¼š</p>
    <ul>
      <li>å•ä¸€èµ›é“ä¸è¶…25%ï¼Œå•ä¸€åŸºé‡‘ä¸è¶…15%</li>
      <li>Î±ä¿¡å·èµ›é“å»ºè®®åˆ†3-6ä¸ªæœˆåˆ†æ‰¹å»ºä»“</li>
      <li>æ¯æœˆé‡æ–°è¿è¡Œå‘ç°å¼•æ“ï¼Œä¿¡å·å˜åŒ–æ—¶è°ƒæ•´</li>
    </ul>
  </div>`;
}

// ==================== INTEGRATION ====================
function addToWatch(code, name, type){
  if(watchlist.find(w=>w.code===code)) return;
  watchlist.push({code, name, type: type||'åŸºé‡‘'});
  localStorage.setItem(LS_WATCHLIST, JSON.stringify(watchlist));
  renderAll();
}

function addToHold(code, name){
  if(holdings.find(h=>h.code===code)) return;
  holdings.push({code, name, cost:10000});
  localStorage.setItem(LS_HOLDINGS, JSON.stringify(holdings));
  renderAll();
}

function setupNavHighlight(){
  const sections = ['sec-overview','sec-review','sec-discover','sec-outlook','sec-recos','sec-summary'];
  const navItems = document.querySelectorAll('.nav-item');
  window.addEventListener('scroll',()=>{
    let current = sections[0];
    sections.forEach(id=>{
      const el = document.getElementById(id);
      if(el && el.getBoundingClientRect().top <= 120) current = id;
    });
    navItems.forEach(item=>{
      item.classList.toggle('active', item.getAttribute('href')==='#'+current);
    });
  });
}

// ==================== INITIALIZATION ====================
async function init(){
  setLoadProgress(5, 'è¿æ¥å¤©å¤©åŸºé‡‘API...');

  let rawData = [];
  try {
    rawData = await fetchAllManagers();
  } catch(e){
    console.error('API fetch failed:', e);
  }

  if(rawData.length < 50){
    const cached = sessionStorage.getItem('tm_rawData');
    if(cached){
      setLoadProgress(75, 'ä½¿ç”¨ç¼“å­˜æ•°æ®...');
      rawData = JSON.parse(cached);
    } else {
      setLoadProgress(75, 'ä½¿ç”¨å†…ç½®æ•°æ®è¿›è¡Œåˆ†æ...');
      rawData = generateFallbackData();
    }
  } else {
    sessionStorage.setItem('tm_rawData', JSON.stringify(rawData));
  }

  setLoadProgress(80, `å¤„ç† ${rawData.length} ä½åŸºé‡‘ç»ç†æ•°æ®...`);
  const managers = processManagers(rawData);

  setLoadProgress(85, 'æ‰§è¡Œç­–ç•¥åˆ†æ...');
  analysis = runAnalysis(managers);
  sectorDiscovery = discoverSectors(filteredManagers);

  if(_302aiKey){
 setLoadProgress(88, ' è°ƒç”¨AIåˆ†æå®è§‚å½¢åŠ¿...');
    try {
      const aiOutlook = await generateAIMacroOutlook((msg)=>{
        setLoadProgress(90, msg);
      });
      if(aiOutlook){
        MACRO_OUTLOOK.pastYearReview = aiOutlook.pastYearReview || MACRO_OUTLOOK.pastYearReview;
        MACRO_OUTLOOK.intlFactors = aiOutlook.intlFactors || MACRO_OUTLOOK.intlFactors;
        MACRO_OUTLOOK.domesticFactors = aiOutlook.domesticFactors || MACRO_OUTLOOK.domesticFactors;
        MACRO_OUTLOOK.sectorRecos = aiOutlook.sectorRecos || MACRO_OUTLOOK.sectorRecos;
        if(aiOutlook.period) MACRO_OUTLOOK.period = aiOutlook.period;
        if(aiOutlook.updated) MACRO_OUTLOOK.updated = aiOutlook.updated;
        aiMacroGenerated = true;
 setLoadProgress(95, ' AIå®è§‚åˆ†æå®Œæˆ');
      } else {
 setLoadProgress(95, ' AIåˆ†æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
      }
    } catch(e){
      console.error('AI macro generation failed:', e);
 setLoadProgress(95, ' AIåˆ†æå¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
    }
  } else {
    setLoadProgress(95, 'ç”ŸæˆæŠ•èµ„å»ºè®®...');
  }

  await new Promise(r=>setTimeout(r, 300));
  setLoadProgress(100, 'åˆ†æå®Œæˆï¼');
  document.getElementById('update-time').textContent = new Date().toLocaleString('zh-CN',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

  await new Promise(r=>setTimeout(r, 500));
  document.getElementById('loading-overlay').classList.add('hide');

  renderAll();
  setupNavHighlight();
}

// ==================== FALLBACK DATA ====================
function generateFallbackData(){
  const companies = [
    'æ˜“æ–¹è¾¾åŸºé‡‘','å¹¿å‘åŸºé‡‘','åå¤åŸºé‡‘','å¯Œå›½åŸºé‡‘','å—æ–¹åŸºé‡‘','åšæ—¶åŸºé‡‘','å˜‰å®åŸºé‡‘','æ‹›å•†åŸºé‡‘',
    'å·¥é“¶ç‘ä¿¡åŸºé‡‘','æ±‡æ·»å¯ŒåŸºé‡‘','ä¸­æ¬§åŸºé‡‘','æ™¯é¡ºé•¿åŸåŸºé‡‘','é¹ååŸºé‡‘','é“¶ååŸºé‡‘','äº¤é“¶æ–½ç½—å¾·åŸºé‡‘',
    'å›½æ³°åŸºé‡‘','åå®‰åŸºé‡‘','å¤©å¼˜åŸºé‡‘','å…´è¯å…¨çƒåŸºé‡‘','å¤§æˆåŸºé‡‘','ä¸‡å®¶åŸºé‡‘','å‰æµ·å¼€æºåŸºé‡‘',
    'ä¿¡è¾¾æ¾³äºšåŸºé‡‘','ä¸­åºšåŸºé‡‘','ç¿è¿œåŸºé‡‘','åå®åŸºé‡‘','é•¿åŸåŸºé‡‘','æ°‘ç”ŸåŠ é“¶åŸºé‡‘','æ°¸èµ¢åŸºé‡‘','è¯ºå®‰åŸºé‡‘',
    'èé€šåŸºé‡‘','åå•†åŸºé‡‘','å†œé“¶æ±‡ç†åŸºé‡‘','ä¸­ä¿¡å»ºæŠ•åŸºé‡‘','çº¢åœŸåˆ›æ–°åŸºé‡‘','å®ç›ˆåŸºé‡‘','å®‰ä¿¡åŸºé‡‘',
    'å¾·é‚¦åŸºé‡‘','åŒæ³°åŸºé‡‘','æ±‡å®‰åŸºé‡‘','æ’è¶ŠåŸºé‡‘','è·¯åšè¿ˆåŸºé‡‘','ä¸œå´åŸºé‡‘','åœ†ä¿¡æ°¸ä¸°åŸºé‡‘','åæ³°æŸç‘åŸºé‡‘'
  ];
  const styleWords = [
    ['ç§‘æŠ€åˆ›æ–°','äººå·¥æ™ºèƒ½','èŠ¯ç‰‡äº§ä¸š','åŠå¯¼ä½“','æ•°å­—ç»æµ','æ™ºèƒ½é©±åŠ¨'],
    ['æ¶ˆè´¹ç²¾é€‰','é£Ÿå“é¥®æ–™','æ¶ˆè´¹è¡Œä¸š','ç™½é…’','åŒ»ç–—å¥åº·','åŒ»è¯'],
    ['ä»·å€¼å‘ç°','è“ç­¹ç²¾é€‰','æ ¸å¿ƒä»·å€¼','å¤§ç›˜ç²¾é€‰','çº¢åˆ©ä½æ³¢'],
    ['å‡è¡¡æˆé•¿','æ–°å…´æˆé•¿','çµæ´»é…ç½®','ç­–ç•¥ç²¾é€‰','å…ˆé”‹æˆé•¿'],
    ['æ–°èƒ½æº','å…‰ä¼äº§ä¸š','ç¢³ä¸­å’Œ','ç»¿è‰²ä¸»é¢˜','ä½ç¢³å…ˆé”‹'],
    ['æ²ªæ·±300æŒ‡æ•°','ä¸­è¯500æŒ‡æ•°','åˆ›ä¸šæ¿æŒ‡æ•°','ç§‘åˆ›50æŒ‡æ•°','é‡åŒ–ç²¾é€‰'],
    ['æ¸¯è‚¡é€š','å…¨çƒç²¾é€‰','QDII','çº³æ–¯è¾¾å…‹','æ’ç”Ÿç§‘æŠ€'],
    ['å†›å·¥','å›½é˜²å®‰å…¨','èˆªå¤©å†›å·¥'],
    ['å‘¨æœŸç²¾é€‰','æœ‰è‰²é‡‘å±','èµ„æºç²¾é€‰','é»„é‡‘ETF'],
    ['è¡Œä¸šè½®åŠ¨','äº§ä¸šè¶‹åŠ¿','è¶‹åŠ¿é¢†å…ˆ']
  ];
  const familyNames = 'å¼ ç‹æèµµé™ˆåˆ˜æ¨é»„å‘¨å´å¾å­™é©¬æœ±èƒ¡éƒ­ä½•é«˜æ—ç½—éƒ‘æ¢è°¢å®‹å”éŸ©æ›¹è®¸é‚“è§å†¯æ›¾ç¨‹è”¡å½­æ½˜è¢è’‹å•è‹å¢è’‹å´”ä¸é­è–›å¶é˜ä½™æ½˜æœæˆ´å¤é’Ÿ'.split('');
  const givenParts = 'æ˜åæ–‡ä¼Ÿå¼ºç£Šæ´‹å‹‡è‰³æ°å¨œé‘«ç£Šé™æ•ç‡•ä¸½åˆšæ–Œå³°è¶…ç³æµ©åšå®‡é£ç¥¥å‡¯æ—­æ˜Šç¿”ç‘å®¸çš“è¿œå“²'.split('');

  function rnd(min,max){return Math.random()*(max-min)+min}
  function rndInt(min,max){return Math.floor(rnd(min,max+1))}
  function rndPick(arr){return arr[rndInt(0,arr.length-1)]}
  function rndName(){return rndPick(familyNames)+(Math.random()>0.4?rndPick(givenParts)+rndPick(givenParts):rndPick(givenParts))}

  const data = [];
  const usedNames = new Set();
  for(let i=0; i<600; i++){
    let name = rndName();
    while(usedNames.has(name)) name = rndName();
    usedNames.add(name);
    const company = rndPick(companies);
    const styleGroup = rndPick(styleWords);
    const fundName1 = company.replace('åŸºé‡‘','') + rndPick(styleGroup) + rndPick(['æ··åˆA','è‚¡ç¥¨A','æ··åˆ','è‚¡ç¥¨']);
    const fundName2 = company.replace('åŸºé‡‘','') + rndPick(styleGroup) + rndPick(['æ··åˆC','è‚¡ç¥¨C']);
    const years = rnd(1,22);
    const workDays = Math.round(years*365);
    const careerReturn = rnd(-30,400) + (years>10?rnd(0,100):0);
    const aum = rnd(0.1, years>10?500:100);
    const code1 = String(rndInt(0,25999)).padStart(6,'0');
    const code2 = String(rndInt(0,25999)).padStart(6,'0');
    data.push([
      String(30000000+i), name, String(80000000+i), company,
      `${code1},${code2}`, `${fundName1},${fundName2}`,
      String(workDays), careerReturn.toFixed(2)+'%',
      code1, fundName1,
      aum.toFixed(2)+'äº¿å…ƒ', (careerReturn*rnd(0.3,1.2)).toFixed(2)+'%'
    ]);
  }
  return data;
}

// Start
init();
</script>
</body>
</html>
