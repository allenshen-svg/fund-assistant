<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>åŸºé‡‘å†³ç­–åŠ©æ‰‹</title>
<style>
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a2e; --sub: #8896a4;
  --border: #e8ecf1; --primary: #4F6EF7; --primary-bg: #eef2ff;
  --green: #22a065; --green-bg: #ecfdf5; --red: #e74040; --red-bg: #fef2f2;
  --yellow: #f59e0b; --yellow-bg: #fef3c7; --gray-bg: #f8fafc;
  --radius: 14px; --shadow: 0 1px 4px rgba(0,0,0,0.04);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro','PingFang SC','Helvetica Neue',sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; max-width:500px; margin:0 auto; min-height:100vh; padding-bottom:80px; }

/* Header â€” æ·±è‰²å¤§æ°”é£æ ¼ */
.header { background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; padding:16px 16px 14px; position:sticky; top:0; z-index:100; }
.header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.header-title { font-size:17px; font-weight:700; letter-spacing:0.5px; }
.header-gear { background:none; border:none; color:rgba(255,255,255,0.7); font-size:18px; cursor:pointer; padding:4px; transition:color .2s; }
.header-gear:hover { color:#fff; }
.market-status { display:flex; align-items:center; gap:8px; font-size:12px; opacity:0.9; }
.status-dot { width:7px; height:7px; border-radius:50%; display:inline-block; }
.status-dot.open { background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,0.6); animation:pulse 2s infinite; }
.status-dot.closed { background:#64748b; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.countdown { font-family:'SF Mono','Menlo',monospace; font-weight:600; font-size:13px; background:rgba(255,255,255,0.08); padding:3px 10px; border-radius:6px; letter-spacing:0.5px; }

/* Stats Bar */
.stats-bar { display:grid; grid-template-columns:1fr 1fr; gap:0; padding:0; background:var(--card); border-bottom:1px solid var(--border); box-shadow:var(--shadow); }
.stat-item { text-align:center; padding:14px 12px; }
.stat-item:first-child { border-right:1px solid var(--border); }
.stat-label { font-size:10px; color:var(--sub); margin-bottom:4px; letter-spacing:0.5px; text-transform:uppercase; }
.stat-value { font-size:22px; font-weight:800; font-variant-numeric:tabular-nums; }
.stat-value.up { color:var(--red); }
.stat-value.down { color:var(--green); }
.stat-sub { font-size:10px; color:var(--sub); margin-top:3px; }
.stat-sub .beat { color:var(--red); font-weight:600; }
.stat-sub .lose { color:var(--green); font-weight:600; }

/* AI Button */
.ai-btn-wrap { padding:14px 16px 8px; }
.ai-btn { width:100%; padding:13px 16px; border:none; border-radius:var(--radius); background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:white; font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .25s; box-shadow:0 2px 8px rgba(30,41,59,0.3); letter-spacing:0.3px; }
.ai-btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(30,41,59,0.35); }
.ai-btn:active { transform:translateY(0); }
.ai-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
.ai-btn .spinner-sm { width:16px; height:16px; border:2px solid rgba(255,255,255,0.2); border-top-color:white; border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.ai-progress { font-size:11px; color:var(--sub); text-align:center; padding:6px 16px 2px; min-height:20px; }

/* Section */
.section { padding:10px 16px 4px; }
.section-title { font-size:14px; font-weight:700; color:var(--text); margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.section-badge { font-size:9px; background:#1e293b; color:white; padding:2px 8px; border-radius:10px; font-weight:500; letter-spacing:0.3px; }

/* Signal Cards */
.signal-card { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:10px; box-shadow:var(--shadow); transition:all .25s; border:1px solid transparent; }
.signal-card.buy { border-left:4px solid var(--red); background:linear-gradient(135deg,#fff 92%,#fef2f2); }
.signal-card.sell { border-left:4px solid var(--green); background:linear-gradient(135deg,#fff 92%,#ecfdf5); }
.signal-card.hold { border-left:4px solid #cbd5e1; }
.signal-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.signal-fund { flex:1; }
.signal-name { font-size:14px; font-weight:600; }
.signal-code { font-size:10px; color:var(--sub); margin-top:2px; }
.signal-pct { font-size:17px; font-weight:800; min-width:70px; text-align:right; font-variant-numeric:tabular-nums; }
.signal-action { display:inline-flex; align-items:center; gap:4px; padding:4px 12px; border-radius:8px; font-size:12px; font-weight:600; }
.signal-action.buy { background:var(--red-bg); color:var(--red); }
.signal-action.sell { background:var(--green-bg); color:var(--green); }
.signal-action.hold { background:var(--gray-bg); color:var(--sub); }
.signal-urgency { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:500; }
.signal-urgency.high { background:#fee2e2; color:#dc2626; }
.signal-urgency.medium { background:var(--yellow-bg); color:var(--yellow); }
.signal-urgency.low { background:#f1f5f9; color:#64748b; }

/* Confidence Bar */
.conf-bar { display:flex; align-items:center; gap:6px; margin:8px 0; }
.conf-track { flex:1; height:5px; background:#e2e8f0; border-radius:3px; overflow:hidden; }
.conf-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.conf-fill.high { background:linear-gradient(90deg,#22a065,#16a34a); }
.conf-fill.mid { background:linear-gradient(90deg,#f59e0b,#eab308); }
.conf-fill.low { background:#94a3b8; }
.conf-text { font-size:10px; color:var(--sub); min-width:30px; }
.signal-reason { font-size:12px; color:#475569; line-height:1.65; }
.signal-engines { font-size:10px; color:var(--sub); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }

/* Reco Cards */
.reco-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); display:flex; align-items:center; gap:12px; transition:transform .2s; }
.reco-card:active { transform:scale(0.98); }
.reco-info { flex:1; }
.reco-name { font-size:13px; font-weight:600; }
.reco-meta { font-size:10px; color:var(--sub); margin-top:3px; line-height:1.4; }
.reco-expect { font-size:13px; font-weight:700; color:var(--red); }
.reco-add { background:#1e293b; color:white; border:none; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.reco-add:hover { background:#334155; }

/* Watch item */
.watch-item { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:6px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; transition:transform .2s; }
.watch-item:active { transform:scale(0.98); }
.watch-left { flex:1; min-width:0; }
.watch-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.watch-type { font-size:10px; color:var(--sub); margin-top:2px; }
.watch-pct { font-size:15px; font-weight:800; min-width:60px; text-align:right; font-variant-numeric:tabular-nums; }
.watch-signal { font-size:10px; padding:3px 8px; border-radius:6px; white-space:nowrap; font-weight:500; }
.watch-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:14px; padding:4px; transition:color .2s; }
.watch-del:hover { color:var(--red); }

/* Holding delete */
.hold-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:11px; padding:2px 4px; margin-left:4px; transition:color .2s; }
.hold-del:hover { color:var(--red); }

/* Empty state */
.empty { text-align:center; padding:32px 16px; color:var(--sub); font-size:12px; }
.empty-icon { font-size:36px; margin-bottom:10px; opacity:0.6; }

/* Bottom Bar */
.bottom-bar { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); display:flex; gap:10px; z-index:100; box-shadow:0 -2px 10px rgba(0,0,0,0.04); }
.bottom-btn { flex:1; padding:11px; border:none; border-radius:12px; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; letter-spacing:0.3px; }
.bottom-btn.primary { background:#1e293b; color:white; }
.bottom-btn.primary:hover { background:#334155; }
.bottom-btn.secondary { background:var(--gray-bg); color:var(--text); border:1px solid var(--border); }
.bottom-btn.secondary:hover { background:#eef2ff; }

/* Modal */
.modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:200; align-items:center; justify-content:center; }
.modal { background:var(--card); border-radius:20px; margin:16px; padding:24px; max-width:380px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.15); }
.modal h3 { font-size:17px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; }
.modal h3 button { background:none; border:none; font-size:18px; cursor:pointer; color:var(--sub); width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background .2s; }
.modal h3 button:hover { background:var(--gray-bg); }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; font-weight:600; color:var(--sub); margin-bottom:5px; letter-spacing:0.3px; text-transform:uppercase; }
.form-row input, .form-row select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; transition:border-color .2s; outline:none; background:var(--gray-bg); }
.form-row input:focus, .form-row select:focus { border-color:var(--primary); background:#fff; }
.form-btn { width:100%; padding:12px; border:none; border-radius:12px; background:#1e293b; color:white; font-size:14px; font-weight:600; cursor:pointer; transition:background .2s; letter-spacing:0.3px; }
.form-btn:hover { background:#334155; }

.spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto; }

/* Market summary */
.market-summary { font-size:12px; color:#475569; line-height:1.7; padding:14px 16px; background:var(--card); border-radius:var(--radius); margin-bottom:10px; box-shadow:var(--shadow); border-left:3px solid var(--primary); }
.provider-tag { font-size:9px; background:var(--primary-bg); color:var(--primary); padding:2px 8px; border-radius:10px; margin-left:6px; font-weight:500; }

/* Index Bar */
.idx-bar { background:linear-gradient(135deg,#0f172a,#1e293b); padding:10px 16px 12px; display:flex; gap:0; border-bottom:1px solid rgba(255,255,255,0.06); }
.idx-item { flex:1; text-align:center; position:relative; }
.idx-item+.idx-item { border-left:1px solid rgba(255,255,255,0.08); }
.idx-name { font-size:10px; color:rgba(251,191,36,0.75); letter-spacing:0.3px; }
.idx-val { font-size:14px; font-weight:700; color:#fff; margin-top:2px; font-variant-numeric:tabular-nums; }
.idx-pct { font-size:11px; font-weight:600; margin-top:1px; font-variant-numeric:tabular-nums; }
.idx-pct.up { color:#ef4444; }
.idx-pct.down { color:#22c55e; }
.idx-pct.flat { color:rgba(255,255,255,0.5); }

/* Portfolio Section */
.pf-section { padding:10px 16px 4px; }
.pf-tabs { display:flex; gap:0; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); margin-bottom:12px; }
.pf-tab { flex:1; padding:10px 8px; text-align:center; cursor:pointer; border:none; background:transparent; font-size:12px; font-weight:600; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; }
.pf-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.pf-tab .pf-tab-ratio { font-size:10px; font-weight:400; color:var(--sub); display:block; margin-top:2px; }
.pf-group { display:none; }
.pf-group.active { display:block; }
.pf-group-desc { font-size:11px; color:var(--sub); margin-bottom:10px; padding:0 2px; line-height:1.5; }
.pf-card { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.pf-card:active { transform:scale(0.98); }
.pf-card.swing-buy { border-left:3px solid var(--red); }
.pf-card.swing-sell { border-left:3px solid var(--green); }
.pf-card.swing-hold { border-left:3px solid #cbd5e1; }
.pf-top { display:flex; justify-content:space-between; align-items:flex-start; }
.pf-info { flex:1; min-width:0; }
.pf-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pf-code { font-size:10px; color:var(--sub); margin-top:1px; }
.pf-right { text-align:right; min-width:70px; }
.pf-pct { font-size:16px; font-weight:800; font-variant-numeric:tabular-nums; }
.pf-swing-tag { display:inline-block; font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; margin-top:3px; }
.pf-swing-tag.buy { background:var(--red-bg); color:var(--red); }
.pf-swing-tag.sell { background:var(--green-bg); color:var(--green); }
.pf-swing-tag.hold { background:var(--gray-bg); color:var(--sub); }
.pf-trend-row { display:flex; gap:6px; flex-wrap:wrap; font-size:10px; margin-top:8px; padding-top:7px; border-top:1px solid var(--border); }
.pf-trend-item { display:flex; align-items:center; gap:2px; }
.pf-trend-label { color:var(--sub); }
.pf-reason { font-size:11px; color:#64748b; margin-top:6px; line-height:1.4; }
.pf-actions { display:flex; gap:6px; margin-top:8px; }
.pf-act-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.pf-act-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.pf-act-btn.in-hold { background:rgba(34,160,101,0.08); color:var(--green); border-color:var(--green); cursor:default; font-weight:600; }
.pf-act-btn.in-watch { background:rgba(79,110,247,0.08); color:var(--primary); border-color:var(--primary); cursor:default; font-weight:600; }

/* Review Section */
.review-section { padding:10px 16px 4px; }
.review-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:var(--shadow); }
.review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.review-date { font-size:13px; font-weight:700; color:var(--text); }
.review-pnl { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.review-stats { display:flex; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
.review-stat { font-size:11px; display:flex; align-items:center; gap:4px; }
.review-stat-label { color:var(--sub); }
.review-stat-val { font-weight:600; }
.review-items { border-top:1px solid var(--border); padding-top:8px; }
.review-item { display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.03); font-size:12px; }
.review-item:last-child { border-bottom:none; }
.review-fund-name { flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; }
.review-pred { font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; }
.review-pred.buy { background:var(--red-bg); color:var(--red); }
.review-pred.sell { background:var(--green-bg); color:var(--green); }
.review-pred.hold { background:var(--gray-bg); color:var(--sub); }
.review-actual { font-weight:700; min-width:55px; text-align:right; font-variant-numeric:tabular-nums; }
.review-verdict { font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; white-space:nowrap; }
.review-verdict.correct { background:#ecfdf5; color:#16a34a; }
.review-verdict.wrong { background:#fef2f2; color:#dc2626; }
.review-verdict.neutral { background:#f8fafc; color:#64748b; }
.review-lesson { margin-top:8px; padding:8px 12px; background:#fffbeb; border-radius:8px; border:1px solid #fde68a; font-size:11px; color:#92400e; line-height:1.5; }
.review-toggle { font-size:11px; color:var(--primary); cursor:pointer; font-weight:500; }
.review-history-toggle { text-align:center; padding:8px; }

/* Simulation Portfolio */
.sim-section { padding:10px 16px 4px; }
.sim-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.sim-header-right { display:flex; align-items:center; gap:8px; }
.sim-toggle-icon { font-size:12px; color:var(--sub); transition:transform .2s; }
.sim-overview { background:linear-gradient(135deg,#0f172a,#1e293b); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 8px rgba(15,23,42,0.2); }
.sim-stat-row { display:flex; gap:0; }
.sim-stat { flex:1; text-align:center; position:relative; }
.sim-stat+.sim-stat { border-left:1px solid rgba(255,255,255,0.1); }
.sim-stat-label { font-size:9px; color:rgba(255,255,255,0.5); letter-spacing:0.3px; }
.sim-stat-val { font-size:18px; font-weight:800; margin-top:2px; font-variant-numeric:tabular-nums; }
.sim-target { margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); }
.sim-target span { color:rgba(255,255,255,0.6); }
.sim-progress { height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; }
.sim-progress-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.sim-compare { background:var(--card); border-radius:var(--radius); padding:12px 14px; margin-bottom:10px; box-shadow:var(--shadow); }
.sim-compare-title { font-size:12px; font-weight:700; margin-bottom:8px; }
.sim-compare-row { display:flex; gap:0; }
.sim-compare-item { flex:1; text-align:center; padding:4px 0; }
.sim-compare-item+.sim-compare-item { border-left:1px solid var(--border); }
.sim-compare-label { font-size:9px; color:var(--sub); display:block; }
.sim-compare-val { font-size:14px; font-weight:700; font-variant-numeric:tabular-nums; }
.sim-pos-card { background:var(--card); border-radius:10px; padding:10px 12px; margin-bottom:6px; box-shadow:var(--shadow); }
.sim-pos-top { display:flex; justify-content:space-between; align-items:flex-start; }
.sim-pos-info { flex:1; min-width:0; }
.sim-pos-name { font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.sim-pos-meta { font-size:9px; color:var(--sub); margin-top:1px; }
.sim-pos-right { text-align:right; min-width:60px; }
.sim-pos-pct { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.sim-pos-detail { display:flex; gap:8px; font-size:10px; color:var(--sub); margin-top:4px; padding-top:4px; border-top:1px solid var(--border); }
.sim-learn-card { background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:8px 10px; margin-bottom:6px; }
.sim-strategy-card { background:var(--card); border-radius:10px; padding:10px 14px; box-shadow:var(--shadow); margin-bottom:8px; }
.sim-param-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.sim-param { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.sp-label { font-size:9px; color:var(--sub); display:block; }
.sp-val { font-size:12px; font-weight:700; }
.sim-trade-item { display:flex; align-items:center; gap:6px; padding:6px 0; border-bottom:1px solid var(--border); font-size:11px; }
.sim-trade-item:last-child { border-bottom:none; }
.sim-chart { background:var(--card); border-radius:10px; padding:10px 12px; box-shadow:var(--shadow); }
.sim-chart-row { display:flex; align-items:center; gap:6px; padding:2px 0; }
.sim-chart-date { font-size:9px; color:var(--sub); min-width:36px; }
.sim-chart-bar { flex:1; height:10px; background:var(--bg); border-radius:3px; overflow:hidden; }
.sim-chart-val { font-size:9px; font-weight:600; min-width:42px; text-align:right; font-variant-numeric:tabular-nums; }

/* Manage Panel */
.manage-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:300; }
.manage-panel { position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--bg); border-radius:20px 20px 0 0; max-height:88vh; display:flex; flex-direction:column; animation:slideUp .3s ease; }
@keyframes slideUp { from{transform:translateX(-50%) translateY(100%)} to{transform:translateX(-50%) translateY(0)} }
.manage-header { display:flex; align-items:center; padding:16px 16px 0; gap:8px; }
.manage-tabs { flex:1; display:flex; gap:0; background:var(--card); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); }
.manage-tab { flex:1; padding:10px 12px; text-align:center; font-size:13px; font-weight:600; cursor:pointer; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; background:transparent; }
.manage-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.manage-count { font-size:10px; font-weight:400; background:rgba(0,0,0,0.06); padding:1px 6px; border-radius:8px; margin-left:2px; }
.manage-close { background:none; border:none; font-size:20px; cursor:pointer; color:var(--sub); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-close:hover { background:var(--card); color:var(--text); }
.manage-toolbar { display:flex; gap:8px; padding:12px 16px 8px; align-items:center; }
.manage-search { flex:1; padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; outline:none; background:var(--card); transition:border-color .2s; }
.manage-search:focus { border-color:var(--primary); }
.manage-add-btn { padding:9px 16px; border:none; border-radius:10px; background:#1e293b; color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.manage-add-btn:hover { background:#334155; }
.manage-body { flex:1; overflow-y:auto; padding:4px 16px 20px; -webkit-overflow-scrolling:touch; }
.manage-empty { text-align:center; padding:48px 16px; color:var(--sub); }
.manage-empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.manage-empty-text { font-size:13px; margin-bottom:16px; }
.manage-fund { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.manage-fund:active { transform:scale(0.98); }
.manage-fund-top { display:flex; justify-content:space-between; align-items:flex-start; }
.manage-fund-info { flex:1; min-width:0; }
.manage-fund-name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.manage-fund-meta { font-size:10px; color:var(--sub); margin-top:3px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.manage-fund-type { padding:1px 6px; border-radius:4px; background:var(--primary-bg); color:var(--primary); font-size:9px; font-weight:500; }
.manage-fund-right { display:flex; align-items:center; gap:10px; }
.manage-fund-pct { font-size:18px; font-weight:800; font-variant-numeric:tabular-nums; min-width:65px; text-align:right; }
.manage-fund-nav { font-size:10px; color:var(--sub); text-align:right; margin-top:2px; }
.manage-fund-del { background:none; border:1px solid #e2e8f0; color:#94a3b8; cursor:pointer; font-size:12px; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-fund-del:hover { background:#fef2f2; border-color:#fca5a5; color:var(--red); }
.manage-fund-trend { display:flex; gap:8px; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:10px; flex-wrap:wrap; }
.manage-fund-trend span { display:flex; align-items:center; gap:2px; }
.manage-fund-actions { display:flex; gap:6px; margin-top:8px; }
.manage-action-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.manage-action-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.manage-action-btn.danger { color:var(--red); border-color:#fca5a5; }
.manage-action-btn.danger:hover { background:var(--red); color:white; border-color:var(--red); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <span class="header-title">ğŸ“Š åŸºé‡‘å†³ç­–åŠ©æ‰‹</span>
    <div style="display:flex;gap:8px;align-items:center">
      <a href="manager-analysis.html" style="color:white;font-size:11px;opacity:0.8;text-decoration:none">TOP500</a>
      <button class="header-gear" onclick="openSettings()">âš™ï¸</button>
    </div>
  </div>
  <div class="market-status">
    <span class="status-dot" id="status-dot"></span>
    <span id="market-status-text">æ£€æµ‹ä¸­...</span>
    <span class="countdown" id="countdown">--:--:--</span>
  </div>
</div>

<!-- Index Bar -->
<div class="idx-bar" id="idx-bar">
  <div class="idx-item"><div class="idx-name">ä¸Šè¯</div><div class="idx-val" id="iv-sh">--</div><div class="idx-pct flat" id="ip-sh">--</div></div>
  <div class="idx-item"><div class="idx-name">æ·±è¯</div><div class="idx-val" id="iv-sz">--</div><div class="idx-pct flat" id="ip-sz">--</div></div>
  <div class="idx-item"><div class="idx-name">åˆ›ä¸šæ¿</div><div class="idx-val" id="iv-cy">--</div><div class="idx-pct flat" id="ip-cy">--</div></div>
  <div class="idx-item"><div class="idx-name">æ²ªæ·±300</div><div class="idx-val" id="iv-hs">--</div><div class="idx-pct flat" id="ip-hs">--</div></div>
</div>
<div class="idx-bar" id="idx-bar-2" style="padding-top:0;border-top:none">
  <div class="idx-item"><div class="idx-name">ğŸ¥‡ é»„é‡‘ETF</div><div class="idx-val" id="iv-au">--</div><div class="idx-pct flat" id="ip-au">--</div></div>
  <div class="idx-item"><div class="idx-name">ğŸ¥ˆ ç™½é“¶LOF</div><div class="idx-val" id="iv-ag">--</div><div class="idx-pct flat" id="ip-ag">--</div></div>
  <div class="idx-item"><div class="idx-name">ğŸ”© æœ‰è‰²é‡‘å±</div><div class="idx-val" id="iv-ys">--</div><div class="idx-pct flat" id="ip-ys">--</div></div>
</div>

<!-- Stats Bar -->
<div class="stats-bar" id="stats-bar">
  <div class="stat-item">
    <div class="stat-label">ä»Šæ—¥æŒä»“ç›ˆäº</div>
    <div class="stat-value" id="stat-today">--</div>
    <div class="stat-sub" id="stat-bench-today"></div>
  </div>
  <div class="stat-item">
    <div class="stat-label">æ²ªæ·±300ä»Šæ—¥</div>
    <div class="stat-value" id="stat-hs300">--</div>
    <div class="stat-sub" id="stat-bench-label">å¤§ç›˜åŸºå‡†</div>
  </div>
</div>

<!-- Portfolio Section -->
<div class="pf-section">
  <div class="section-title">ğŸ’¼ æ³¢æ®µç»„åˆ <span style="font-size:10px;color:var(--sub);font-weight:400">å®æ—¶è¶‹åŠ¿ Â· æ³¢æ®µä¿¡å·</span></div>
  <div class="pf-tabs">
    <div class="pf-tab active" onclick="switchPfTab('core')" id="pf-tab-core">ğŸ›¡ï¸ æ ¸å¿ƒä»“<span class="pf-tab-ratio">å»ºè®®60%</span></div>
    <div class="pf-tab" onclick="switchPfTab('satellite')" id="pf-tab-sat">ğŸš€ å«æ˜Ÿä»“<span class="pf-tab-ratio">å»ºè®®40%</span></div>
  </div>
  <div class="pf-group active" id="pf-group-core"></div>
  <div class="pf-group" id="pf-group-satellite"></div>
</div>

<!-- Simulation Portfolio -->
<div class="sim-section">
  <div class="section-title sim-header" onclick="toggleSimDetail()">
    <span>ğŸ¤– AIæ¨¡æ‹Ÿç›˜ <span style="font-size:10px;color:var(--sub);font-weight:400">50ä¸‡å»ºä»“ Â· AIè‡ªåŠ¨äº¤æ˜“</span></span>
    <div class="sim-header-right">
      <span id="sim-brief" style="font-size:12px;font-weight:700">--</span>
      <span class="sim-toggle-icon" id="sim-toggle-icon">â–¼</span>
    </div>
  </div>
  <div id="sim-container"></div>
</div>

<!-- AI Button -->
<div class="ai-btn-wrap">
  <button class="ai-btn" id="ai-btn" onclick="triggerAI()">
    ğŸ§  ä¸€é”®AIåˆ†æ Â· 4å¼•æ“ç ”åˆ¤
  </button>
  <div class="ai-progress" id="ai-progress"></div>
</div>

<!-- Market Summary (AI generated) -->
<div class="section" id="market-summary-section" style="display:none">
  <div id="market-summary"></div>
</div>

<!-- Daily Review -->
<div class="review-section" id="review-section" style="display:none">
  <div class="section-title">ğŸ“ æ¯æ—¥å¤ç›˜ <span style="font-size:10px;color:var(--sub);font-weight:400">æ˜¨æ—¥åˆ¤æ–­ vs ä»Šæ—¥ç»“æœ</span></div>
  <div id="review-container"></div>
  <div class="review-history-toggle" id="review-history-toggle" style="display:none">
    <span class="review-toggle" onclick="toggleReviewHistory()">ğŸ“‹ æŸ¥çœ‹å†å²å¤ç›˜è®°å½•</span>
  </div>
  <div id="review-history" style="display:none"></div>
</div>

<!-- Action Signals -->
<div class="section">
  <div class="section-title">ğŸ“‹ ä»Šæ—¥æ“ä½œä¿¡å· <span class="section-badge" id="signal-badge">ç­‰å¾…åˆ†æ</span></div>
  <div id="signals-container">
    <div class="empty"><div class="empty-icon">ğŸ“¥</div>æ·»åŠ æŒä»“åï¼ŒAIä¼šç»™å‡ºä»Šæ—¥æ“ä½œå»ºè®®</div>
  </div>
</div>

<!-- Watchlist Signals -->
<div class="section" id="watchlist-section" style="display:none">
  <div class="section-title">ğŸ‘ è‡ªé€‰è§‚å¯Ÿ</div>
  <div id="watchlist-container"></div>
</div>

<!-- AI Recommendations -->
<div class="section" id="reco-section" style="display:none">
  <div class="section-title">ğŸ¯ AIæ¨èå…³æ³¨ <span style="font-size:10px;color:var(--sub);font-weight:400">3æœˆç¨³å¥å¢é•¿è§†è§’</span></div>
  <div id="reco-container"></div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <button class="bottom-btn primary" onclick="openManagePanel('holding')">ğŸ’¼ æŒä»“ç®¡ç†</button>
  <button class="bottom-btn secondary" onclick="openManagePanel('watch')">ğŸ‘ è‡ªé€‰ç®¡ç†</button>
</div>

<!-- Manage Panel (Full Screen Slide Up) -->
<div class="manage-overlay" id="manage-overlay" onclick="if(event.target===this)closeManagePanel()">
  <div class="manage-panel">
    <div class="manage-header">
      <div class="manage-tabs">
        <div class="manage-tab active" id="manage-tab-holding" onclick="switchManageTab('holding')">ğŸ’¼ æŒä»“ <span class="manage-count" id="manage-holding-count">0</span></div>
        <div class="manage-tab" id="manage-tab-watch" onclick="switchManageTab('watch')">ğŸ‘ è‡ªé€‰ <span class="manage-count" id="manage-watch-count">0</span></div>
      </div>
      <button class="manage-close" onclick="closeManagePanel()">âœ•</button>
    </div>
    <div class="manage-toolbar">
      <input type="text" class="manage-search" id="manage-search" placeholder="ğŸ” æœç´¢åŸºé‡‘ä»£ç æˆ–åç§°..." oninput="renderManageList()">
      <button class="manage-add-btn" onclick="openAddModal(_manageTab)">+ æ·»åŠ </button>
    </div>
    <div class="manage-body" id="manage-body"></div>
  </div>
</div>

<!-- Add Fund Modal -->
<div class="modal-overlay" id="add-modal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal">
    <h3 id="add-modal-title">æ·»åŠ æŒä»“ <button onclick="closeAddModal()">âœ•</button></h3>
    <div class="form-row"><label>åŸºé‡‘ä»£ç </label><input type="text" id="add-code" placeholder="å¦‚ 000216" maxlength="6"></div>
    <div class="form-row"><label>åŸºé‡‘åç§° (é€‰å¡«ï¼Œå¯è‡ªåŠ¨è¯†åˆ«)</label><input type="text" id="add-name" placeholder="è‡ªåŠ¨è¯†åˆ«"></div>
    <div class="form-row" id="add-type-row"><label>ç±»å‹</label>
      <select id="add-type"><option value="å®½åŸº">å®½åŸº</option><option value="AI/ç§‘æŠ€">AI/ç§‘æŠ€</option><option value="é»„é‡‘">é»„é‡‘</option><option value="çº¢åˆ©">çº¢åˆ©</option><option value="å†›å·¥">å†›å·¥</option><option value="æ–°èƒ½æº">æ–°èƒ½æº</option><option value="æ¶ˆè´¹">æ¶ˆè´¹</option><option value="åŒ»è¯">åŒ»è¯</option><option value="åŠå¯¼ä½“">åŠå¯¼ä½“</option><option value="æœ‰è‰²é‡‘å±">æœ‰è‰²é‡‘å±</option><option value="QDII">QDII</option><option value="å…¶ä»–">å…¶ä»–</option></select>
    </div>
    <button class="form-btn" id="add-confirm-btn" onclick="confirmAdd()">ç¡®è®¤æ·»åŠ </button>
    <div style="margin-top:10px;font-size:10px;color:var(--sub)">
      <b>å¸¸ç”¨åŸºé‡‘é€ŸæŸ¥ï¼š</b><br>
      <span style="cursor:pointer;text-decoration:underline" onclick="quickAdd('000216','åå®‰é»„é‡‘ETFè”æ¥A','é»„é‡‘')">000216 åå®‰é»„é‡‘</span> Â·
      <span style="cursor:pointer;text-decoration:underline" onclick="quickAdd('012414','åå¤A500ETFè”æ¥A','å®½åŸº')">012414 åå¤A500</span> Â·
      <span style="cursor:pointer;text-decoration:underline" onclick="quickAdd('011852','å¤©å¼˜äº‘è®¡ç®—ETFè”æ¥A','AI/ç§‘æŠ€')">011852 å¤©å¼˜äº‘è®¡ç®—</span> Â·
      <span style="cursor:pointer;text-decoration:underline" onclick="quickAdd('004814','ä¸­æ¬§çº¢åˆ©ä¼˜äº«A','çº¢åˆ©')">004814 ä¸­æ¬§çº¢åˆ©</span>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="max-width:360px">
    <h3>âš™ï¸ è®¾ç½® <button onclick="closeSettings()">âœ•</button></h3>
    <div style="padding:6px 0">
      <div style="font-size:11px;font-weight:600;margin-bottom:8px">ğŸŒ AIæœåŠ¡å•†</div>
      <div id="provider-list"></div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 6px">API Key</div>
      <div class="form-row">
        <input type="password" id="input-key" placeholder="è¾“å…¥API Key" style="width:100%;font-size:12px">
      </div>
      <div id="provider-hint" style="font-size:10px;color:var(--sub);margin:-6px 0 10px"></div>
      <div style="font-size:11px;font-weight:600;margin:12px 0 6px">AIå¼•æ“æ¨¡å‹ï¼š</div>
      <div id="engine-list" style="font-size:11px"></div>
      <button class="form-btn" onclick="saveSettings()" style="margin-top:14px">ä¿å­˜è®¾ç½®</button>
      <div style="text-align:center;margin-top:8px">
        <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="toggleKeyVis()">æ˜¾ç¤º/éšè—Key</span>
        <span style="font-size:10px;color:var(--sub);margin-left:12px;cursor:pointer;text-decoration:underline" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</span>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== FUND DATABASE ====================
const FUND_DB = [
  {code:'000216',name:'åå®‰é»„é‡‘ETFè”æ¥A',type:'é»„é‡‘',baseNav:1.38},
  {code:'012414',name:'åå¤ä¸­è¯A500ETFè”æ¥A',type:'å®½åŸº',baseNav:1.25},
  {code:'011852',name:'å¤©å¼˜ä¸­è¯äº‘è®¡ç®—ä¸å¤§æ•°æ®ETFè”æ¥A',type:'AI/ç§‘æŠ€',baseNav:0.91},
  {code:'004814',name:'ä¸­æ¬§çº¢åˆ©ä¼˜äº«æ··åˆA',type:'çº¢åˆ©',baseNav:1.48},
  {code:'257070',name:'å›½æ³°ä¸­è¯å†›å·¥ETFè”æ¥A',type:'å†›å·¥',baseNav:1.12},
  {code:'003834',name:'åå¤èƒ½æºé©æ–°è‚¡ç¥¨A',type:'æ–°èƒ½æº',baseNav:1.65},
  {code:'161725',name:'æ‹›å•†ä¸­è¯ç™½é…’æŒ‡æ•°A',type:'ç™½é…’/æ¶ˆè´¹',baseNav:1.28},
  {code:'110011',name:'æ˜“æ–¹è¾¾ä¸­å°ç›˜æ··åˆ',type:'ä¸­å°ç›˜',baseNav:5.52},
  {code:'005827',name:'æ˜“æ–¹è¾¾è“ç­¹ç²¾é€‰æ··åˆ',type:'è“ç­¹',baseNav:2.05},
  {code:'001156',name:'ç”³ä¸‡è±ä¿¡ä¸­è¯åŠå¯¼ä½“æŒ‡æ•°A',type:'åŠå¯¼ä½“',baseNav:1.18},
  {code:'320007',name:'è¯ºå®‰æˆé•¿æ··åˆ',type:'åŠå¯¼ä½“/ç§‘æŠ€',baseNav:1.42},
  {code:'160119',name:'å—æ–¹ä¸­è¯500ETFè”æ¥A',type:'å®½åŸº',baseNav:1.55},
];

// æ¨èç»„åˆï¼šæ ¸å¿ƒä»“(ç¨³å¥é•¿æŒ) + å«æ˜Ÿä»“(æ³¢æ®µè¿›æ”»)
const MODEL_PORTFOLIO = {
  core: {
    label:'ğŸ›¡ï¸ æ ¸å¿ƒä»“', ratio:'60%',
    desc:'å‹èˆ±çŸ³é…ç½®ï¼Œé•¿æœŸæŒæœ‰ä¸ºä¸»ï¼Œè¿½æ±‚ç¨³å¥æ”¶ç›Šã€‚å®½åŸº+é»„é‡‘+çº¢åˆ©ä¸‰è§’ç»„åˆï¼Œä½ç›¸å…³æ€§åˆ†æ•£é£é™©ã€‚',
    funds: [
      {code:'012414',name:'åå¤ä¸­è¯A500ETFè”æ¥A',type:'å®½åŸº',alloc:'20%',reason:'Aè‚¡æ ¸å¿ƒ500èµ„äº§ï¼Œé•¿æœŸé…ç½®åŸºçŸ³'},
      {code:'007339',name:'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥C',type:'å®½åŸº',alloc:'15%',reason:'æ²ªæ·±300æ ¸å¿ƒè“ç­¹ï¼Œè´¹ç‡ä½ï¼ŒæµåŠ¨æ€§å¥½'},
      {code:'000216',name:'åå®‰é»„é‡‘ETFè”æ¥A',type:'é»„é‡‘',alloc:'15%',reason:'é¿é™©+æŠ—é€šèƒ€ï¼Œä¸è‚¡å¸‚ä½ç›¸å…³ï¼Œå¤®è¡ŒæŒç»­è´­é‡‘'},
      {code:'012643',name:'å¤©å¼˜çº¢åˆ©ä½æ³¢åŠ¨C',type:'çº¢åˆ©',alloc:'10%',reason:'é«˜è‚¡æ¯ä½æ³¢åŠ¨ï¼Œä¸‹è¡Œä¿æŠ¤å¼ºï¼Œç¨³å®šåˆ†çº¢'},
    ]
  },
  satellite: {
    label:'ğŸš€ å«æ˜Ÿä»“', ratio:'40%',
    desc:'å¼¹æ€§è¿›æ”»ä»“ä½ï¼Œç§¯æåšæ³¢æ®µâ€”â€”é€¢è·Œä¹°å…¥ã€é€¢æ¶¨æ­¢ç›ˆã€‚å…³æ³¨è¶‹åŠ¿å‘ä¸Šä¸”çŸ­æœŸå›è°ƒçš„å“ç§ã€‚',
    funds: [
      {code:'014832',name:'å¤©å¼˜ä¸­è¯æœ‰è‰²é‡‘å±ETFè”æ¥C',type:'æœ‰è‰²é‡‘å±',alloc:'10%',reason:'å…¨çƒé“œé“æ¶¨ä»·+æ–°åŸºå»ºéœ€æ±‚ï¼Œæ³¢åŠ¨å¤§æ³¢æ®µç©ºé—´è¶³'},
      {code:'015047',name:'å¹¿å‘äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',alloc:'8%',reason:'AIäº§ä¸šçˆ†å‘ï¼Œç®—åŠ›éœ€æ±‚æ—ºç››ï¼Œæˆé•¿æ€§å¼º'},
      {code:'001156',name:'ç”³ä¸‡è±ä¿¡ä¸­è¯åŠå¯¼ä½“æŒ‡æ•°A',type:'åŠå¯¼ä½“',alloc:'8%',reason:'å›½äº§æ›¿ä»£é€»è¾‘ç¡¬ï¼Œä¼°å€¼å¼¹æ€§å¤§'},
      {code:'257070',name:'å›½æ³°ä¸­è¯å†›å·¥ETFè”æ¥A',type:'å†›å·¥',alloc:'7%',reason:'åœ°ç¼˜å‚¬åŒ–+è£…å¤‡é‡‡è´­å‘¨æœŸï¼Œäº‹ä»¶é©±åŠ¨å‹æ³¢æ®µ'},
      {code:'013308',name:'æ˜“æ–¹è¾¾ä¸­è¯å…¨æŒ‡è¯åˆ¸å…¬å¸C',type:'é‡‘è',alloc:'7%',reason:'ç‰›å¸‚å…ˆé”‹ï¼Œæ”¿ç­–å—ç›Šå¼¹æ€§å“ç§ï¼ŒÎ²å±æ€§å¼º'},
    ]
  }
};

const RECO_FUND_POOL = [
  {code:'002610',name:'åšæ—¶é»„é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['é¿é™©','è´µé‡‘å±']},
  {code:'007929',name:'åå®‰é»„é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['é¿é™©','é»„é‡‘']},
  {code:'015047',name:'å¹¿å‘äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',tags:['AI','äº§ä¸šè¶‹åŠ¿']},
  {code:'017992',name:'æ˜“æ–¹è¾¾ä¸­è¯äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',tags:['AI','ç®—åŠ›']},
  {code:'014557',name:'ä¸‡å®¶ä¸­è¯èŠ¯ç‰‡äº§ä¸šæŒ‡æ•°C',type:'åŠå¯¼ä½“',tags:['èŠ¯ç‰‡','å›½äº§æ›¿ä»£']},
  {code:'013313',name:'åå®ä¸­è¯ç§‘æŠ€é¾™å¤´ETFè”æ¥C',type:'ç§‘æŠ€',tags:['ç§‘æŠ€é¾™å¤´','ç¡¬ç§‘æŠ€']},
  {code:'012860',name:'é•¿åŸå†›å·¥æˆé•¿ETFè”æ¥C',type:'å†›å·¥',tags:['å›½é˜²å†›å·¥','æˆ˜ç•¥']},
  {code:'013010',name:'å¤©å¼˜ä¸­è¯æ–°èƒ½æºè½¦ETFè”æ¥C',type:'æ–°èƒ½æº',tags:['æ–°èƒ½æºè½¦','ç”µæ± ']},
  {code:'012762',name:'å¤©å¼˜ä¸­è¯é£Ÿå“é¥®æ–™ETFè”æ¥C',type:'æ¶ˆè´¹',tags:['é£Ÿå“é¥®æ–™','å†…éœ€']},
  {code:'001550',name:'å¤©å¼˜ä¸­è¯åŒ»è¯100A',type:'åŒ»è¯',tags:['åŒ»è¯','åˆ›æ–°è¯']},
  {code:'012643',name:'å¤©å¼˜çº¢åˆ©ä½æ³¢åŠ¨C',type:'çº¢åˆ©',tags:['çº¢åˆ©','ä½æ³¢åŠ¨']},
  {code:'012070',name:'ä¸‡å®¶ä¸­è¯çº¢åˆ©ETFè”æ¥C',type:'çº¢åˆ©',tags:['é«˜è‚¡æ¯','ç¨³å¥']},
  {code:'007339',name:'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥C',type:'å®½åŸº',tags:['æ²ªæ·±300','æ ¸å¿ƒèµ„äº§']},
  {code:'006881',name:'å¤©å¼˜åˆ›ä¸šæ¿ETFè”æ¥C',type:'å®½åŸº',tags:['åˆ›ä¸šæ¿','æˆé•¿']},
  {code:'013601',name:'åå®‰ä¸­è¯A500ETFè”æ¥C',type:'å®½åŸº',tags:['A500','æ ¸å¿ƒ']},
  {code:'014832',name:'å¤©å¼˜ä¸­è¯æœ‰è‰²é‡‘å±ETFè”æ¥C',type:'æœ‰è‰²é‡‘å±',tags:['æœ‰è‰²','é“œé“']},
  {code:'013308',name:'æ˜“æ–¹è¾¾ä¸­è¯å…¨æŒ‡è¯åˆ¸å…¬å¸C',type:'é‡‘è',tags:['åˆ¸å•†','æ”¿ç­–å—ç›Š']},
];

const INDICES_CONFIG = [
  {name:'ä¸Šè¯',secid:'1.000001',group:'stock'},
  {name:'æ·±æˆ',secid:'0.399001',group:'stock'},
  {name:'åˆ›ä¸šæ¿',secid:'0.399006',group:'stock'},
  {name:'æ²ªæ·±300',secid:'1.000300',group:'benchmark'},
  {name:'é»„é‡‘ETF',secid:'1.518880',group:'commodity'},
  {name:'ç™½é“¶LOF',secid:'0.161226',group:'commodity'},
  {name:'æœ‰è‰²é‡‘å±',secid:'1.000819',group:'commodity'},
];

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'ç¡…åŸºæµåŠ¨(å…è´¹)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    desc:'å…è´¹å¼€æºæ¨¡å‹ï¼Œæ³¨å†Œå³ç”¨',
    link:'https://cloud.siliconflow.cn',
    models: [
      {id:'engine1', name:'DeepSeek-V3', icon:'ğŸ«˜', role:'æŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'deepseek-ai/DeepSeek-V3'},
      {id:'engine2', name:'Qwen2.5-72B', icon:'ğŸ”®', role:'å®è§‚ç»æµ+æ”¿ç­–é¢', model:'Qwen/Qwen2.5-72B-Instruct'},
      {id:'engine3', name:'DeepSeek-R1-32B', icon:'ğŸ”', role:'æ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-ai/DeepSeek-R1-Distill-Qwen-32B'},
      {id:'engine4', name:'Gemma-2-27B', icon:'â™Š', role:'å…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'google/gemma-2-27b-it'},
    ]
  },
  {
    id:'deepseek', name:'DeepSeekå®˜æ–¹(æä½ä»·)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    desc:'Â¥1/ç™¾ä¸‡tokenï¼Œå‡ ä¹å…è´¹',
    link:'https://platform.deepseek.com',
    models: [
      {id:'engine1', name:'DeepSeek-V3â‘ ', icon:'ğŸ«˜', role:'æŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'deepseek-chat'},
      {id:'engine2', name:'DeepSeek-V3â‘¡', icon:'ğŸ”®', role:'å®è§‚ç»æµ+æ”¿ç­–é¢', model:'deepseek-chat'},
      {id:'engine3', name:'DeepSeek-R1', icon:'ğŸ”', role:'æ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-reasoner'},
      {id:'engine4', name:'DeepSeek-V3â‘¢', icon:'â™Š', role:'å…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'deepseek-chat'},
    ]
  },
  {
    id:'302ai', name:'302.AI(ä»˜è´¹)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    desc:'èšåˆå¹³å°ï¼Œæ”¯æŒå¤šç§æ¨¡å‹',
    link:'https://302.ai',
    models: [
      {id:'engine1', name:'è±†åŒ…', icon:'ğŸ«˜', role:'æŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'doubao-1.5-pro-32k'},
      {id:'engine2', name:'é€šä¹‰åƒé—®', icon:'ğŸ”®', role:'å®è§‚ç»æµ+æ”¿ç­–é¢', model:'qwen3-235b-a22b'},
      {id:'engine3', name:'DeepSeek', icon:'ğŸ”', role:'æ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-r1'},
      {id:'engine4', name:'Gemini', icon:'â™Š', role:'å…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'gemini-2.5-flash'},
    ]
  }
];

let _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
let _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
let AI_ENGINES = _aiProvider.models;
let _apiBase = _aiProvider.base;

// ==================== STATE ====================
let holdings = JSON.parse(localStorage.getItem('fa_holdings')||'[]');
let watchlist = JSON.parse(localStorage.getItem('fa_watchlist')||'[]');
let liveIndices = {};
let liveFundData = {};
let liveSectors = [];
let fundHistoryData = {}; // { code: { navs: [{date,nav}], trend:{} } }
let _aiKey = localStorage.getItem('fa_302ai_key') || '';
let _analyzing = false;
let _analysisResult = null;
let _addMode = 'holding';
let _refreshTimer = null;
let _countdownTimer = null;
let dailyLog = JSON.parse(localStorage.getItem('fa_daily_log')||'[]'); // [{date, predictions:{code:{action,confidence,trend,reason}}, pnl:{code:pct}, avgPnl, hs300Pct}]
let simPortfolio = JSON.parse(localStorage.getItem('fa_sim_portfolio')||'null');
const SIM_INITIAL_CAPITAL = 500000;
const SIM_TARGET_MONTHLY = 10000;
const SIM_FEE_RATE = 0.0015;

function saveHoldings(){ localStorage.setItem('fa_holdings', JSON.stringify(holdings)); }
function saveWatchlist(){ localStorage.setItem('fa_watchlist', JSON.stringify(watchlist)); }
function saveKey(k){ _aiKey=k; localStorage.setItem('fa_302ai_key', k); }
function saveDailyLog(){ localStorage.setItem('fa_daily_log', JSON.stringify(dailyLog.slice(-30))); } // æœ€å¤šä¿ç•™30å¤©
function saveProvider(id){
  _aiProviderId=id;
  _aiProvider=AI_PROVIDERS.find(p=>p.id===id)||AI_PROVIDERS[0];
  AI_ENGINES=_aiProvider.models;
  _apiBase=_aiProvider.base;
  localStorage.setItem('fa_ai_provider',id);
}

// ==================== UTILITIES ====================
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function sign(n){ return n>=0?'+':''; }
function fmt(n){ return (typeof n==='number')?n.toFixed(2):'--'; }
function seededRand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

function getMarketStatus(){
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const t = h*60+m;
  if(day===0||day===6) return {status:'closed', text:'å‘¨æœ«ä¼‘å¸‚', countdown:null};
  if(t<570) return {status:'pre', text:'æœªå¼€ç›˜', countdown:null};
  if(t>=570&&t<690) return {status:'open', text:'äº¤æ˜“ä¸­Â·ä¸Šåˆ', countdown:900-t};
  if(t>=690&&t<780) return {status:'break', text:'åˆé—´ä¼‘å¸‚', countdown:900-t};
  if(t>=780&&t<900) return {status:'open', text:'äº¤æ˜“ä¸­Â·ä¸‹åˆ', countdown:900-t};
  return {status:'closed', text:'å·²æ”¶ç›˜', countdown:null};
}

function formatCountdown(mins){
  if(mins===null||mins<=0) return '00:00';
  const h = Math.floor(mins/60);
  const m = mins%60;
  const now = new Date();
  const s = 59 - now.getSeconds();
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ==================== JSONP ENGINE ====================
let _jcnt=0;
function jsonpFetch(url, opts={}){
  return new Promise((resolve, reject)=>{
    const cbName = opts.fixedCb || `_jp${++_jcnt}_${Date.now()}`;
    const timeout = opts.timeout || 8000;
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
    function cleanup(){ clearTimeout(timer); if(!opts.fixedCb) delete window[cbName]; try{script.remove();}catch(e){} }
    window[cbName] = function(data){ cleanup(); resolve(data); };
    let finalUrl = url;
    if(!opts.fixedCb) finalUrl += (url.includes('?')?'&':'?') + `cb=${cbName}`;
    finalUrl += (finalUrl.includes('?')?'&':'?') + `_t=${Date.now()}`;
    script.src = finalUrl;
    script.onerror = ()=>{ cleanup(); reject(new Error('network')); };
    document.head.appendChild(script);
  });
}

// ==================== DATA FETCHING ====================
async function fetchIndices(){
  try{
    const secids = INDICES_CONFIG.map(i=>i.secid).join(',');
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=${secids}&fields=f2,f3,f4,f12,f13,f14`);
    if(data?.data?.diff){
      data.data.diff.forEach(d=>{
        const key=`${d.f13}.${d.f12}`;
        if(d.f2!=='-'&&!isNaN(d.f2)) liveIndices[key]={name:d.f14,price:d.f2,pct:d.f3,change:d.f4};
      });
    }
  }catch(e){ console.error('fetchIndices:', e); }
}

async function fetchSectors(){
  try{
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=20&po=1&np=1&fltt=2&invt=2&fid=f3&fs=m:90+t:2&fields=f3,f14`);
    if(data?.data?.diff){
      liveSectors = data.data.diff.map(d=>({name:d.f14,pct:d.f3})).filter(d=>!isNaN(d.pct)).sort((a,b)=>b.pct-a.pct);
    }
  }catch(e){}
}

async function fetchFundEstimate(code){
  return new Promise((resolve, reject)=>{
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{ done(); reject(new Error('timeout')); }, 5000);
    function done(){ clearTimeout(timer); try{script.remove();}catch(e){} }
    window.jsonpgz = function(d){ done(); resolve(d); };
    script.src = `http://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
    script.onerror = ()=>{ done(); reject(new Error('error')); };
    document.head.appendChild(script);
  });
}

function getAllPortfolioCodes(){
  const pCodes = [];
  MODEL_PORTFOLIO.core.funds.forEach(f=>pCodes.push(f.code));
  MODEL_PORTFOLIO.satellite.funds.forEach(f=>pCodes.push(f.code));
  // åŒ…å«æ¨¡æ‹Ÿç›˜æŒä»“ä»£ç ï¼Œç¡®ä¿è·å–çœŸå®å¸‚åœºæ•°æ®
  if(simPortfolio && simPortfolio.positions){
    simPortfolio.positions.forEach(p=>pCodes.push(p.code));
  }
  return [...new Set(pCodes)];
}

async function fetchAllFunds(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  for(const code of codes){
    try{
      const d = await fetchFundEstimate(code);
      if(d?.gsz) liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name||'', gztime:d.gztime||'' };
    }catch(e){}
    await new Promise(r=>setTimeout(r,120));
  }
}

// ==================== HISTORICAL DATA & TREND ANALYSIS ====================
async function fetchFundHistory(code){
  // è·å–åŸºé‡‘å†å²å‡€å€¼ï¼ˆè¿‘1å¹´ï¼Œçº¦250ä¸ªäº¤æ˜“æ—¥ï¼‰
  try{
    const url = `https://api.fund.eastmoney.com/f10/lsjz?fundCode=${code}&pageIndex=1&pageSize=250`;
    const resp = await fetch(url, {headers:{'Referer':'https://fundf10.eastmoney.com/'}});
    if(!resp.ok) throw new Error('fetch fail');
    const json = await resp.json();
    if(json?.Data?.LSJZList){
      const navs = json.Data.LSJZList
        .map(d=>({date:d.FSRQ, nav:parseFloat(d.DWJZ)}))
        .filter(d=>!isNaN(d.nav))
        .reverse(); // æœ€æ—©åœ¨å‰
      return navs;
    }
  }catch(e){
    // å¤‡ç”¨JSONPæ–¹å¼
    try{
      const data = await jsonpFetch(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${getSecidForFund(code)}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=1&beg=0&end=20500101&lmt=250`);
      if(data?.data?.klines){
        return data.data.klines.map(k=>{
          const parts=k.split(',');
          return {date:parts[0], nav:parseFloat(parts[1])};
        }).filter(d=>!isNaN(d.nav));
      }
    }catch(e2){}
  }
  return null;
}

function getSecidForFund(code){
  // åŸºé‡‘ä»£ç æ˜ å°„åˆ°secidï¼ˆä¸Šäº¤æ‰€1.xxxï¼Œæ·±äº¤æ‰€0.xxxï¼‰
  const first = code.charAt(0);
  if(first==='5'||first==='6') return `1.${code}`;
  return `0.${code}`;
}

function analyzeTrend(navs){
  if(!navs || navs.length < 10) return null;

  const len = navs.length;
  const latest = navs[len-1].nav;
  const prices = navs.map(n=>n.nav);

  // å„å‘¨æœŸæ¶¨è·Œå¹…
  const pct = (cur,prev) => prev>0 ? ((cur-prev)/prev*100) : 0;
  const chg5d = len>5 ? pct(latest, prices[len-6]) : 0;    // è¿‘5æ—¥
  const chg20d = len>20 ? pct(latest, prices[len-21]) : 0;  // è¿‘1æœˆ
  const chg60d = len>60 ? pct(latest, prices[len-61]) : 0;  // è¿‘3æœˆ
  const chg120d = len>120 ? pct(latest, prices[len-121]) : 0; // è¿‘6æœˆ
  const chg250d = len>240 ? pct(latest, prices[0]) : 0;      // è¿‘1å¹´

  // å‡çº¿
  const ma = (n) => {
    if(len<n) return latest;
    let sum=0; for(let i=len-n;i<len;i++) sum+=prices[i];
    return sum/n;
  };
  const ma5 = ma(5), ma20 = ma(20), ma60 = ma(60);

  // è¿‘1å¹´æœ€é«˜/æœ€ä½
  const high1y = Math.max(...prices);
  const low1y = Math.min(...prices);
  const drawdownFromHigh = pct(latest, high1y); // è·é«˜ç‚¹å›æ’¤(è´Ÿæ•°)
  const reboundFromLow = pct(latest, low1y);     // è·ä½ç‚¹åå¼¹

  // è¶‹åŠ¿åˆ¤æ–­
  let trendDir = 'sideways';
  let trendScore = 0; // -100~100

  // å‡çº¿å¤šå¤´æ’åˆ—: ma5>ma20>ma60 â†’ å¼ºä¸Šå‡
  if(ma5>ma20 && ma20>ma60) trendScore += 30;
  else if(ma5<ma20 && ma20<ma60) trendScore -= 30;

  // ä¸­æœŸæ¶¨å¹…
  if(chg60d > 8) trendScore += 25;
  else if(chg60d > 3) trendScore += 15;
  else if(chg60d < -8) trendScore -= 25;
  else if(chg60d < -3) trendScore -= 15;

  // é•¿æœŸè¶‹åŠ¿
  if(chg250d > 15) trendScore += 20;
  else if(chg250d > 5) trendScore += 10;
  else if(chg250d < -15) trendScore -= 20;
  else if(chg250d < -5) trendScore -= 10;

  // ä»·æ ¼ä½ç½®
  if(latest > ma20 && latest > ma60) trendScore += 10;
  else if(latest < ma20 && latest < ma60) trendScore -= 10;

  if(trendScore >= 25) trendDir = 'strong_up';
  else if(trendScore >= 10) trendDir = 'up';
  else if(trendScore <= -25) trendDir = 'strong_down';
  else if(trendScore <= -10) trendDir = 'down';

  // æ³¢æ®µä½ç½®åˆ¤æ–­
  let swingPos = 'mid'; // å½“å‰å¤„äºæ³¢æ®µçš„ä»€ä¹ˆä½ç½®
  if(chg5d <= -3) swingPos = 'deep_dip';      // 5æ—¥æš´è·Œâ€”â€”æ·±åº¦å›è°ƒ
  else if(chg5d <= -1.5) swingPos = 'dip';     // 5æ—¥ä¸‹è·Œâ€”â€”å›è°ƒä¸­
  else if(chg5d >= 3) swingPos = 'surge';       // 5æ—¥æš´æ¶¨â€”â€”å†²é«˜
  else if(chg5d >= 1.5) swingPos = 'rally';     // 5æ—¥ä¸Šæ¶¨â€”â€”åå¼¹ä¸­

  // æ³¢æ®µå»ºè®®
  let swingAdvice = '';
  if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸Š+çŸ­æœŸå›è°ƒï¼Œæ³¢æ®µä¹°å…¥æœºä¼šï¼';
  } else if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸Š+çŸ­æœŸå†²é«˜ï¼Œå¯è€ƒè™‘éƒ¨åˆ†æ­¢ç›ˆ';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸‹+çŸ­æœŸåå¼¹ï¼Œå»ºè®®é€¢é«˜å‡ä»“';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸‹+ç»§ç»­ä¸‹è·Œï¼Œä¸å»ºè®®æŠ„åº•';
  } else if(trendDir==='sideways'){
    swingAdvice = 'éœ‡è¡æ ¼å±€ï¼Œç­‰å¾…æ–¹å‘æ˜ç¡®';
  }

  return {
    chg5d: +chg5d.toFixed(2),
    chg20d: +chg20d.toFixed(2),
    chg60d: +chg60d.toFixed(2),
    chg120d: +chg120d.toFixed(2),
    chg250d: +chg250d.toFixed(2),
    ma5: +ma5.toFixed(4), ma20: +ma20.toFixed(4), ma60: +ma60.toFixed(4),
    latest: +latest.toFixed(4),
    high1y: +high1y.toFixed(4), low1y: +low1y.toFixed(4),
    drawdownFromHigh: +drawdownFromHigh.toFixed(2),
    reboundFromLow: +reboundFromLow.toFixed(2),
    trendDir, trendScore, swingPos, swingAdvice,
    dataPoints: len
  };
}

async function fetchAllHistory(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  for(const code of codes){
    const navs = await fetchFundHistory(code);
    if(navs && navs.length>0){
      const trend = analyzeTrend(navs);
      fundHistoryData[code] = { navs, trend };
    }
    await new Promise(r=>setTimeout(r,200));
  }
}

function getFundData(code){
  if(liveFundData[code]) return {...liveFundData[code], _live:true};
  // å°è¯•ä»å†å²æ•°æ®å–æœ€æ–°çœŸå®å‡€å€¼
  const hd = fundHistoryData[code];
  if(hd && hd.navs && hd.navs.length>0){
    const latest = hd.navs[hd.navs.length-1];
    const prev = hd.navs.length>1 ? hd.navs[hd.navs.length-2] : latest;
    const pct = prev.nav>0 ? (latest.nav-prev.nav)/prev.nav*100 : 0;
    const nm = FUND_DB.find(x=>x.code===code)?.name || RECO_FUND_POOL.find(x=>x.code===code)?.name || code;
    return {gsz:latest.nav, dwjz:latest.nav, gszzl:+pct.toFixed(2), name:nm, gztime:latest.date, _live:false, _histFallback:true};
  }
  const f = FUND_DB.find(x=>x.code===code);
  const r = RECO_FUND_POOL.find(x=>x.code===code);
  const seed = parseInt(todayStr().replace(/-/g,''))+parseInt(code);
  const pct = (seededRand(seed)-0.46)*4;
  const dwjz = (f?f.baseNav:1)*(1+(seededRand(seed+100)-0.5)*0.3);
  const nm = f?f.name : r?r.name : code;
  return {gsz:dwjz*(1+pct/100), dwjz, gszzl:pct, name:nm, gztime:todayStr()+' 15:00', _live:false};
}

function getIndexData(cfg){
  if(liveIndices[cfg.secid]) return liveIndices[cfg.secid];
  const base={'1.000001':3340,'0.399001':10420,'0.399006':2110,'1.000300':4000,'1.518880':7.5,'0.161226':1.45,'1.000819':5200}[cfg.secid]||3000;
  const seed = parseInt(todayStr().replace(/-/g,''))+(cfg.secid.charCodeAt(2)||0)*137;
  const pct=(seededRand(seed)-0.46)*3;
  return {name:cfg.name, price:(base*(1+pct/100)).toFixed(2), pct:pct, change:(base*pct/100).toFixed(2)};
}

function fundName(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  const live = liveFundData[code];
  return info?.name || reco?.name || live?.name || h?.name || w?.name || code;
}

function fundType(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  return info?.type || reco?.type || h?.type || w?.type || '';
}

// ==================== AI ENGINE ====================
async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_aiKey) throw new Error('è¯·å…ˆé…ç½®API Key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:4096
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildContext(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const shData = getIndexData(INDICES_CONFIG[0]);
  const szData = getIndexData(INDICES_CONFIG[1]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const auData = getIndexData(INDICES_CONFIG[4]);
  const agData = getIndexData(INDICES_CONFIG[5]);
  const ysData = getIndexData(INDICES_CONFIG[6]);
  const topUp = liveSectors.filter(s=>s.pct>0).slice(0,6);
  const topDown = liveSectors.filter(s=>s.pct<0).slice(-4).reverse();

  let ctx = `å½“å‰æ—¥æœŸ: ${todayStr()}\n`;
  ctx += `ç”¨æˆ·ç›®æ ‡ï¼š3ä¸ªæœˆå†…ç¨³å¥å¢é•¿ï¼Œè·‘èµ¢æ²ªæ·±300æŒ‡æ•°\n\n`;
  ctx += `ã€å¤§ç›˜æŒ‡æ•°ã€‘\n`;
  ctx += `ä¸Šè¯æŒ‡æ•°: ${shData.price} (${sign(shData.pct)}${fmt(shData.pct)}%)\n`;
  ctx += `æ·±è¯æˆæŒ‡: ${szData.price} (${sign(szData.pct)}${fmt(szData.pct)}%)\n`;
  ctx += `åˆ›ä¸šæ¿æŒ‡: ${cyData.price} (${sign(cyData.pct)}${fmt(cyData.pct)}%)\n`;
  ctx += `æ²ªæ·±300: ${hs300.price} (${sign(hs300.pct)}${fmt(hs300.pct)}%)\n`;
  ctx += `\nã€å•†å“/è´µé‡‘å±ã€‘\n`;
  ctx += `é»„é‡‘ETF: ${auData.price} (${sign(auData.pct)}${fmt(auData.pct)}%)\n`;
  ctx += `ç™½é“¶LOF: ${agData.price} (${sign(agData.pct)}${fmt(agData.pct)}%)\n`;
  ctx += `æœ‰è‰²é‡‘å±æŒ‡æ•°: ${ysData.price} (${sign(ysData.pct)}${fmt(ysData.pct)}%)\n`;

  if(topUp.length>0){
    ctx += `\nã€ä»Šæ—¥é¢†æ¶¨æ¿å—ã€‘\n`;
    topUp.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }
  if(topDown.length>0){
    ctx += `\nã€ä»Šæ—¥é¢†è·Œæ¿å—ã€‘\n`;
    topDown.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }

  // æ„å»ºåŸºé‡‘è¶‹åŠ¿æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨çœŸå®å†å²æ•°æ®ï¼Œæ— æ•°æ®æ—¶ç”¨æ¿å—é€šç”¨æè¿°åšåå¤‡ï¼‰
  const SECTOR_FALLBACK = {
    'é»„é‡‘':'è¿‘æœŸé¿é™©éœ€æ±‚æ”¯æ’‘ï¼Œå…³æ³¨å¤®è¡Œè´­é‡‘åŠ¨æ€',
    'æœ‰è‰²é‡‘å±':'å…³æ³¨å…¨çƒå¤§å®—å•†å“ä»·æ ¼èµ°åŠ¿å’Œæ–°åŸºå»ºéœ€æ±‚',
    'AI/ç§‘æŠ€':'AIäº§ä¸šé©±åŠ¨ï¼Œå…³æ³¨ç®—åŠ›éœ€æ±‚å’Œäº§ä¸šæ”¿ç­–',
    'åŠå¯¼ä½“':'å›½äº§æ›¿ä»£é€»è¾‘æŒç»­ï¼Œæ³¨æ„ä¼°å€¼æ³¢åŠ¨',
    'å†›å·¥':'äº‹ä»¶é©±åŠ¨å‹ï¼Œå…³æ³¨åœ°ç¼˜æ”¿ç­–å‚¬åŒ–',
    'çº¢åˆ©':'é˜²å¾¡æ€§å¼ºï¼Œé€‚åˆé•¿æŒ',
    'å®½åŸº':'è·Ÿéšå¤§ç›˜èµ°åŠ¿',
    'æ–°èƒ½æº':'å…³æ³¨äº§èƒ½å‘¨æœŸå’Œæ”¿ç­–æ‹ç‚¹',
    'æ¶ˆè´¹':'å…³æ³¨å†…éœ€å¤è‹ä¿¡å·',
    'åŒ»è¯':'å…³æ³¨åˆ›æ–°è¯è¿›å±•',
  };

  function buildFundTrendDesc(code){
    const hd = fundHistoryData[code];
    if(!hd || !hd.trend) return '';
    const t = hd.trend;
    let desc = `ã€çœŸå®å†å²æ•°æ®åˆ†æã€‘`;
    desc += `è¶‹åŠ¿æ–¹å‘:${t.trendDir}(è¯„åˆ†${t.trendScore})`;
    desc += ` | è¿‘5æ—¥:${sign(t.chg5d)}${t.chg5d}%`;
    desc += ` | è¿‘20æ—¥:${sign(t.chg20d)}${t.chg20d}%`;
    desc += ` | è¿‘60æ—¥:${sign(t.chg60d)}${t.chg60d}%`;
    desc += ` | è¿‘250æ—¥:${sign(t.chg250d)}${t.chg250d}%`;
    desc += ` | è·å¹´é«˜ç‚¹:${t.drawdownFromHigh}%`;
    desc += ` | è·å¹´ä½ç‚¹:+${t.reboundFromLow}%`;
    desc += ` | MA5:${t.ma5} MA20:${t.ma20} MA60:${t.ma60} æœ€æ–°:${t.latest}`;
    desc += ` | æ³¢æ®µä½ç½®:${t.swingPos}`;
    if(t.swingAdvice) desc += ` | æ³¢æ®µå»ºè®®:${t.swingAdvice}`;
    return desc;
  }

  if(holdings.length>0){
    ctx += `\nã€ç”¨æˆ·æŒä»“åŸºé‡‘ã€‘\n`;
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      const tp = fundType(h.code);
      const trendDesc = buildFundTrendDesc(h.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(h.code)}(${h.code}) - ç±»å‹:${tp} - æŒä»“ - ä»Šæ—¥:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | æ¿å—å‚è€ƒ:${fallback}`;
      ctx += `\n`;
    });
  }

  if(watchlist.length>0){
    ctx += `\nã€ç”¨æˆ·è‡ªé€‰åŸºé‡‘ã€‘\n`;
    watchlist.forEach(w=>{
      const f = getFundData(w.code);
      const tp = fundType(w.code);
      const trendDesc = buildFundTrendDesc(w.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(w.code)}(${w.code}) - ç±»å‹:${tp} - è‡ªé€‰ - ä»Šæ—¥:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | æ¿å—å‚è€ƒ:${fallback}`;
      ctx += `\n`;
    });
  }

  const ownedCodes = new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)]);
  const pool = RECO_FUND_POOL.filter(f=>!ownedCodes.has(f.code)).slice(0,10);
  if(pool.length>0){
    ctx += `\nã€å€™é€‰åŸºé‡‘æ± (å¯æ¨èç»™ç”¨æˆ·ä¹°å…¥)ã€‘\n`;
    pool.forEach(f=>{ ctx += `${f.name}(${f.code}) - ç±»å‹:${f.type} - æ ‡ç­¾:${f.tags.join(',')}\n`; });
  }

  // æ³¨å…¥å†å²å¤ç›˜æ•™è®­ï¼Œè®©AIä»è¿‡å»çš„å¤±è¯¯ä¸­å­¦ä¹ 
  const reviewCtx = buildReviewContext();
  if(reviewCtx) ctx += reviewCtx;

  return ctx;
}

const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½æ“…é•¿æ³¢æ®µæ“ä½œå’Œè¶‹åŠ¿è·Ÿè¸ªçš„åŸºé‡‘æŠ•èµ„é¡¾é—®ã€‚ç”¨æˆ·çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š3ä¸ªæœˆå†…å®ç°ç¨³å¥å¢é•¿ï¼Œè·‘èµ¢æ²ªæ·±300æŒ‡æ•°ã€‚

â–  æ ¸å¿ƒæŠ•èµ„é€»è¾‘ï¼ˆä½ å¿…é¡»éµå®ˆï¼‰ï¼š
1. è¶‹åŠ¿ä¸ºç‹ï¼šå…ˆåˆ¤æ–­æ¯ä¸ªæ¿å—/åŸºé‡‘çš„ä¸­æœŸè¶‹åŠ¿ï¼ˆ3ä¸ªæœˆç»´åº¦ï¼‰æ˜¯ä¸Šå‡ã€éœ‡è¡è¿˜æ˜¯ä¸‹é™
2. é€¢è·Œä¹°å…¥ï¼šå¦‚æœä¸­æœŸè¶‹åŠ¿å‘ä¸Šï¼ŒçŸ­æœŸå¤§è·Œ(â‰¥1.5%)æ˜¯åŠ ä»“/å»ºä»“çš„å¥½æœºä¼šï¼Œè€Œä¸æ˜¯å‡ä»“ä¿¡å·ï¼
3. é€¢æ¶¨æ­¢ç›ˆï¼šå¦‚æœçŸ­æœŸæ¶¨å¹…è¿‡å¤§(è¿ç»­ä¸Šæ¶¨æˆ–å•æ—¥>3%)ï¼Œåº”è€ƒè™‘éƒ¨åˆ†æ­¢ç›ˆè€Œéè¿½é«˜
4. æ³¢æ®µæ€ç»´ï¼šæ ¸å¿ƒä»“ä½(å®½åŸº/çº¢åˆ©/é»„é‡‘)é•¿æŒä¸åŠ¨ï¼Œå«æ˜Ÿä»“ä½(è¡Œä¸šä¸»é¢˜)åšæ³¢æ®µâ€”â€”ä½å¸é«˜æŠ›
5. ä»“ä½ç®¡ç†ï¼šå»ºè®®å°†æŒä»“åˆ†ä¸ºæ ¸å¿ƒä»“(~60%ç¨³å¥å‹èˆ±çŸ³)å’Œå«æ˜Ÿä»“(~40%å¼¹æ€§è¿›æ”»)
6. è¶‹åŠ¿æ‹ç‚¹ï¼šåªæœ‰å½“ä¸­æœŸè¶‹åŠ¿ç¡®è®¤è½¬å‘ä¸‹è¡Œæ—¶ï¼Œæ‰å»ºè®®å‡ä»“

â–  æ“ä½œå†³ç­–æ¡†æ¶ï¼š
- ä¸­æœŸè¶‹åŠ¿â†‘ + ä»Šæ—¥å¤§è·Œ â†’ buy(åŠ ä»“/ä½å¸) âœ…
- ä¸­æœŸè¶‹åŠ¿â†‘ + ä»Šæ—¥å¤§æ¶¨ â†’ holdæˆ–sell(éƒ¨åˆ†æ­¢ç›ˆ)
- ä¸­æœŸè¶‹åŠ¿â†‘ + ä»Šæ—¥å¹³ç¨³ â†’ hold(æŒæœ‰)
- ä¸­æœŸè¶‹åŠ¿â†’ + ä»Šæ—¥å¤§è·Œ â†’ holdæˆ–buy(å°ä»“è¯•æ¢)
- ä¸­æœŸè¶‹åŠ¿â†“ + ä»»ä½•æƒ…å†µ â†’ sell(å‡ä»“é¿é™©)

â–  ä»“ä½åˆ†ç±»æŒ‡å¼•ï¼š
- æ ¸å¿ƒä»“(å‹èˆ±çŸ³)ï¼šå®½åŸºæŒ‡æ•°(A500/æ²ªæ·±300/ä¸­è¯500)ã€çº¢åˆ©ä½æ³¢ã€é»„é‡‘ â†’ é•¿æŒï¼Œåªåœ¨æç«¯æƒ…å†µè°ƒæ•´
- å«æ˜Ÿä»“(å¼¹æ€§)ï¼šAI/ç§‘æŠ€ã€æœ‰è‰²é‡‘å±ã€å†›å·¥ã€åŠå¯¼ä½“ã€æ–°èƒ½æºç­‰è¡Œä¸šä¸»é¢˜ â†’ ç§¯ææ³¢æ®µæ“ä½œï¼Œä½å¸é«˜æŠ›

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–çš„æ–‡å­—æˆ–markdownæ ‡è®°ï¼š
{
  "marketSummary": "80-120å­—çš„å¸‚åœºæ€»ç»“ï¼Œèšç„¦å¯¹ç”¨æˆ·æŒä»“çš„å½±å“å’Œ3ä¸ªæœˆå±•æœ›",
  "benchmarkView": "æ²ªæ·±300æœªæ¥3ä¸ªæœˆèµ°åŠ¿åˆ¤æ–­(30å­—)",
  "portfolioAdvice": {
    "coreRatio": "å»ºè®®æ ¸å¿ƒä»“å æ¯”ï¼Œå¦‚60%",
    "satRatio": "å»ºè®®å«æ˜Ÿä»“å æ¯”ï¼Œå¦‚40%",
    "advice": "30-50å­—çš„æ•´ä½“ä»“ä½è°ƒæ•´å»ºè®®"
  },
  "signals": [
    {
      "code": "åŸºé‡‘ä»£ç ",
      "posType": "core/satellite",
      "action": "buy/sell/hold",
      "urgency": "today/this_week/no_rush",
      "confidence": 60-95,
      "trend": "up/sideways/down",
      "reason": "60-120å­—ç†ç”±ï¼šâ‘ å…ˆè¯´ä¸­æœŸè¶‹åŠ¿åˆ¤æ–­ â‘¡å†ç»“åˆä»Šæ—¥è¡¨ç°ç»™å‡ºæ“ä½œé€»è¾‘ â‘¢è¯´æ˜å¦‚ä½•å¸®åŠ©è·‘èµ¢æ²ªæ·±300",
      "target3m": "+X%~+Y%"
    }
  ],
  "newPicks": [
    {
      "code": "æ¨èåŸºé‡‘ä»£ç (å¿…é¡»ä»å€™é€‰æ± ä¸­é€‰)",
      "reason": "40-60å­—æ¨èç†ç”±",
      "expected3m": "+X%~+Y%"
    }
  ]
}

è¦æ±‚ï¼š
1. signalså¿…é¡»è¦†ç›–ç”¨æˆ·æ‰€æœ‰æŒä»“å’Œè‡ªé€‰åŸºé‡‘ï¼Œcodeä¸ç”¨æˆ·æä¾›çš„å®Œå…¨ä¸€è‡´
2. action: buy=åŠ ä»“/å»ºä»“, sell=å‡ä»“/æ­¢ç›ˆ, hold=æŒæœ‰ä¸åŠ¨
3. posType: core=æ ¸å¿ƒä»“(å»ºè®®é•¿æŒ), satellite=å«æ˜Ÿä»“(å»ºè®®æ³¢æ®µ)
4. trend: up=ä¸­æœŸè¶‹åŠ¿å‘ä¸Š, sideways=éœ‡è¡, down=è¶‹åŠ¿å‘ä¸‹
5. urgency: today=ä»Šæ—¥æ”¶ç›˜å‰æ“ä½œ, this_week=æœ¬å‘¨å†…, no_rush=ä¸æ€¥
6. confidence: 60-95ä¹‹é—´çš„æ•´æ•°
7. reasonå¿…é¡»åŒ…å«è¶‹åŠ¿åˆ¤æ–­+æ“ä½œé€»è¾‘ï¼Œä¸èƒ½ä»…å‡­ä»Šæ—¥æ¶¨è·Œåšåˆ¤æ–­
8. ç‰¹åˆ«æ³¨æ„ï¼šè¶‹åŠ¿å‘ä¸Šçš„å“ç§çŸ­æœŸå›è°ƒæ˜¯ä¹°å…¥æœºä¼šï¼Œä¸è¦å› ä¸ºä»Šå¤©è·Œäº†å°±å»ºè®®å‡ä»“ï¼
9. newPicksæœ€å¤šæ¨è3åªï¼Œä»å€™é€‰æ± ä¸­é€‰æ‹©å½“å‰è¢«ä½ä¼°æˆ–æœ‰æ³¢æ®µæœºä¼šçš„
10. åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰å…¶ä»–ä»»ä½•æ–‡å­—`;

const ROLE_DESCS = {
  engine1: 'ä½ ç‰¹åˆ«æ“…é•¿æŠ€æœ¯åˆ†æå’Œè¶‹åŠ¿è·Ÿè¸ªã€‚è¯·é‡ç‚¹åˆ†æï¼šâ‘ æ¯ä¸ªåŸºé‡‘æ‰€å±æ¿å—çš„ä¸­æœŸè¶‹åŠ¿ï¼ˆè¿‡å»1-3ä¸ªæœˆèµ°åŠ¿æ–¹å‘ï¼‰â‘¡å½“å‰å¤„äºè¶‹åŠ¿ä¸­çš„ä»€ä¹ˆä½ç½®ï¼ˆå›è°ƒä½ç‚¹ï¼Ÿä¸Šå‡ä¸­é€”ï¼Ÿé«˜ä½ï¼Ÿï¼‰â‘¢çŸ­æœŸå›è°ƒæ˜¯å¦æ˜¯ä¸Šå‡è¶‹åŠ¿ä¸­çš„ä¹°å…¥æœºä¼šã€‚å…³é”®åˆ¤æ–­ï¼šå¦‚æœä¸€ä¸ªæ¿å—è¿‡å»3ä¸ªæœˆæ•´ä½“ä¸Šè¡Œã€ä»Šæ—¥å¤§è·Œï¼Œä½ åº”è¯¥è§†ä¸ºæ³¢æ®µä½å¸æœºä¼šè€Œéå‡ä»“ä¿¡å·ã€‚',
  engine2: 'ä½ ç‰¹åˆ«æ“…é•¿å®è§‚ç»æµå’Œæ”¿ç­–é¢åˆ†æã€‚è¯·é‡ç‚¹åˆ†æï¼šâ‘ å½“å‰å®è§‚æ”¿ç­–ç¯å¢ƒå¯¹å„è¡Œä¸šæ¿å—çš„ä¸­æœŸå½±å“ â‘¡æœ‰è‰²é‡‘å±ã€AIç§‘æŠ€ã€å†›å·¥ç­‰å‘¨æœŸæ€§/ä¸»é¢˜æ€§æ¿å—çš„æ”¿ç­–é©±åŠ¨åŠ› â‘¢å“ªäº›æ¿å—æœ‰æŒç»­çš„æ”¿ç­–å‚¬åŒ–ï¼ˆå¦‚æ–°åŸºå»ºã€å›½äº§æ›¿ä»£ã€ç¢³ä¸­å’Œã€çŸ¿äº§èµ„æºï¼‰ã€‚æ³¨æ„åŒºåˆ†æ”¿ç­–åˆ©å¥½ï¼ˆè¶‹åŠ¿æ”¯æ’‘ã€é€¢è·Œä¹°å…¥ï¼‰å’Œæ”¿ç­–åˆ©ç©ºï¼ˆè¶‹åŠ¿é€†è½¬ã€åº”å‡ä»“ï¼‰ã€‚',
  engine3: 'ä½ ç‰¹åˆ«æ“…é•¿æ·±åº¦åŸºæœ¬é¢å’Œè¡Œä¸šç ”ç©¶ã€‚è¯·é‡ç‚¹åˆ†æï¼šâ‘ å„è¡Œä¸šçš„æ™¯æ°”åº¦å‘¨æœŸä½ç½®ï¼ˆä¸Šè¡ŒåˆæœŸï¼Ÿç¹è£æœŸï¼Ÿè¡°é€€æœŸï¼Ÿï¼‰â‘¡ç›ˆåˆ©è¶‹åŠ¿æ˜¯å¦æ”¯æ’‘ä¸­æœŸä¸Šæ¶¨ â‘¢ä¼°å€¼æ˜¯å¦åˆç†ã€‚å¯¹äºæ™¯æ°”ä¸Šè¡ŒæœŸçš„è¡Œä¸šï¼ŒçŸ­æœŸæ³¢åŠ¨ä¸æ”¹é•¿æœŸè¶‹åŠ¿â€”â€”å¤§è·Œæ˜¯ä¹°å…¥æœºä¼šã€‚æ³¢æ®µæ“ä½œå…³æ³¨è¡Œä¸šæ™¯æ°”æ‹ç‚¹è€Œéæ—¥å†…æ¶¨è·Œã€‚',
  engine4: 'ä½ ç‰¹åˆ«æ“…é•¿å…¨çƒè§†è§’å’Œèµ„é‡‘æµå‘åˆ†æã€‚è¯·é‡ç‚¹åˆ†æï¼šâ‘ å…¨çƒå¤§å®—å•†å“èµ°åŠ¿å¯¹æœ‰è‰²é‡‘å±ã€é»„é‡‘ç­‰çš„å½±å“ â‘¡å¤–èµ„æµå‘å’Œè¡Œä¸šåå¥½ â‘¢åœ°ç¼˜æ”¿æ²»é£é™©ä¸‹çš„é¿é™©é…ç½® â‘£å“ªäº›æ¿å—åœ¨å…¨çƒè§†è§’ä¸‹ä»æœ‰ä¸Šè¡Œç©ºé—´ã€‚æ³¨æ„ï¼šå…¨çƒé“œé“ç­‰é‡‘å±ä»·æ ¼è¶‹åŠ¿å¦‚æœå‘ä¸Šï¼Œå›½å†…æœ‰è‰²é‡‘å±åŸºé‡‘çš„å›è°ƒå°±æ˜¯é…ç½®æœºä¼šã€‚'
};

async function runAIAnalysis(onProgress){
  if(_analyzing) return;
  _analyzing = true;

  const ctx = buildContext();
  const results = {};
  let done = 0;

  const promises = AI_ENGINES.map(async (eng) => {
    try {
      const roleMsg = ROLE_DESCS[eng.id] || '';
      const userMsg = `${roleMsg}\n\n${ctx}\n\nè¯·åŸºäºä»¥ä¸Šæ•°æ®å’Œä½ çš„ä¸“ä¸šçŸ¥è¯†ï¼Œç»™å‡ºæ“ä½œå»ºè®®ã€‚`;
      if(onProgress) onProgress(`${eng.icon} ${eng.name} åˆ†æä¸­...`, ++done);

      const raw = await callAI(eng.model, SYSTEM_PROMPT, userMsg, 0.7);

      let jsonStr = raw.trim();
      // Remove <think>...</think> blocks if present
      jsonStr = jsonStr.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
      if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if(!jsonMatch) throw new Error('No JSON');
      const parsed = JSON.parse(jsonMatch[0]);
      results[eng.id] = parsed;
      if(onProgress) onProgress(`âœ… ${eng.name} å®Œæˆ`, done);
    } catch(e) {
      console.error(`${eng.name} failed:`, e);
      if(onProgress) onProgress(`âš ï¸ ${eng.name} å¤±è´¥`, done);
    }
  });

  await Promise.all(promises);
  _analyzing = false;

  const successCount = Object.keys(results).length;
  if(successCount === 0) throw new Error('æ‰€æœ‰AIå¼•æ“è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyå’Œç½‘ç»œ');

  return synthesize(results);
}

function synthesize(results){
  const engines = Object.keys(results);
  const total = engines.length;

  const summaries = engines.map(e=>results[e].marketSummary).filter(Boolean);
  const benchViews = engines.map(e=>results[e].benchmarkView).filter(Boolean);

  // Merge signals per fund code
  const signalMap = {};
  engines.forEach(engId=>{
    const r = results[engId];
    (r.signals||[]).forEach(s=>{
      if(!signalMap[s.code]) signalMap[s.code] = [];
      signalMap[s.code].push({...s, engine:engId});
    });
  });

  // Synthesize per fund
  const synthesizedSignals = {};
  Object.keys(signalMap).forEach(code=>{
    const sigs = signalMap[code];
    const actions = sigs.map(s=>s.action);
    const buyCount = actions.filter(a=>a==='buy').length;
    const sellCount = actions.filter(a=>a==='sell').length;
    const holdCount = actions.filter(a=>a==='hold').length;

    // è¶‹åŠ¿æŠ•ç¥¨ï¼šä¼˜å…ˆç”¨çœŸå®å†å²æ•°æ®ï¼Œåå¤‡ç”¨AIå¼•æ“æŠ•ç¥¨
    const realTrend = fundHistoryData[code]?.trend;
    let trendConsensus;
    let todayPct;
    if(realTrend){
      // ä½¿ç”¨çœŸå®è®¡ç®—çš„è¶‹åŠ¿æ–¹å‘
      trendConsensus = (realTrend.trendDir==='strong_up'||realTrend.trendDir==='up') ? 'up'
        : (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') ? 'down' : 'sideways';
      // ä½¿ç”¨çœŸå®5æ—¥æ¶¨è·Œä½œä¸ºæ³¢æ®µå‚è€ƒ
      todayPct = getFundData(code)?.gszzl || 0;
    } else {
      // åå¤‡ï¼šAIå¼•æ“æŠ•ç¥¨
      const trends = sigs.map(s=>s.trend).filter(Boolean);
      const upTrends = trends.filter(t=>t==='up').length;
      const downTrends = trends.filter(t=>t==='down').length;
      trendConsensus = upTrends > downTrends ? 'up' : downTrends > upTrends ? 'down' : 'sideways';
      todayPct = getFundData(code)?.gszzl || 0;
    }

    let action = 'hold';
    if(buyCount > total/2) action = 'buy';
    else if(sellCount > total/2) action = 'sell';
    else if(buyCount > sellCount) action = 'buy';
    else if(sellCount > buyCount) action = 'sell';
    else {
      // æ‰“å¹³æˆ–å…¨holdæ—¶ï¼Œç”¨è¶‹åŠ¿+ä»Šæ—¥è¡¨ç°åšä¿®æ­£
      // è¶‹åŠ¿å‘ä¸Š + ä»Šæ—¥å¤§è·Œ(â‰¥1.5%) â†’ åŠ ä»“æœºä¼š
      if(trendConsensus === 'up' && todayPct <= -1.5 && buyCount >= 1) action = 'buy';
      // è¶‹åŠ¿å‘ä¸‹ + ä»Šæ—¥å¤§æ¶¨ â†’ å‡ä»“
      else if(trendConsensus === 'down' && todayPct >= 1.5 && sellCount >= 1) action = 'sell';
    }

    // é¢å¤–ä¿®æ­£ï¼šå¦‚æœè¶‹åŠ¿å‘ä¸Šä¸”ä»Šæ—¥è·Œå¹…â‰¥2%ï¼Œå³ä½¿holdå¤šæ•°ä¹Ÿå‡çº§ä¸ºbuyï¼ˆæ³¢æ®µé€»è¾‘æ ¸å¿ƒï¼‰
    if(trendConsensus === 'up' && todayPct <= -2.0 && action === 'hold' && buyCount >= 1) {
      action = 'buy';
    }
    // çœŸå®æ•°æ®å¢å¼ºï¼šå¦‚æœæœ‰å†å²æ•°æ®ä¸”è¶‹åŠ¿æ˜¯strong_upï¼Œè·Œå¹…â‰¥1.2%å°±è§¦å‘ä¹°å…¥
    if(realTrend && (realTrend.trendDir==='strong_up') && todayPct <= -1.2 && action === 'hold') {
      action = 'buy';
    }
    // çœŸå®æ•°æ®å¢å¼ºï¼šå¦‚æœè¶‹åŠ¿downä¸”è¿‘5æ—¥è¿˜åœ¨è·Œï¼Œå¼ºåˆ¶sellï¼ˆé™¤éæ‰€æœ‰AIå¼•æ“éƒ½ä¸å»ºè®®sellï¼‰
    if(realTrend && (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') && realTrend.chg5d < -2 && action === 'hold' && sellCount >= 1) {
      action = 'sell';
    }

    const urgencyOrder = {today:3, this_week:2, no_rush:1};
    const matchingSigs = sigs.filter(s=>s.action===action);
    const urgency = matchingSigs.length>0
      ? matchingSigs.sort((a,b)=>(urgencyOrder[b.urgency]||0)-(urgencyOrder[a.urgency]||0))[0].urgency
      : 'no_rush';

    const conf = matchingSigs.length>0
      ? Math.round(matchingSigs.reduce((s,x)=>s+(x.confidence||70),0)/matchingSigs.length)
      : 50;

    const bestReason = matchingSigs.sort((a,b)=>(b.reason?.length||0)-(a.reason?.length||0))[0]?.reason || 'æš‚æ— åˆ†æ';

    const target = matchingSigs.find(s=>s.target3m)?.target3m || '';

    const breakdown = sigs.map(s=>{
      const eng = AI_ENGINES.find(e=>e.id===s.engine);
      return `${eng?.icon||'ğŸ¤–'}${eng?.name||s.engine}: ${s.action==='buy'?'çœ‹å¤š':s.action==='sell'?'çœ‹ç©º':'ä¸­æ€§'}`;
    }).join(' Â· ');

    synthesizedSignals[code] = {
      action, urgency, confidence:conf, reason:bestReason,
      target3m:target, breakdown,
      posType: sigs[0]?.posType || (fundType(code).match(/å®½åŸº|çº¢åˆ©|é»„é‡‘/) ? 'core' : 'satellite'),
      trend: realTrend ? trendConsensus : (sigs.filter(s=>s.trend).map(s=>s.trend).sort((a,b)=>({'up':3,'sideways':2,'down':1}[b]||0)-({'up':3,'sideways':2,'down':1}[a]||0))[0] || 'sideways'),
      trendDetail: realTrend || null,
      buyCount, sellCount, holdCount, total
    };
  });

  // Merge new picks
  const pickMap = {};
  engines.forEach(engId=>{
    (results[engId].newPicks||[]).forEach(p=>{
      if(!pickMap[p.code]) pickMap[p.code] = {code:p.code, reasons:[], expected:[], count:0};
      pickMap[p.code].reasons.push(p.reason);
      pickMap[p.code].expected.push(p.expected3m);
      pickMap[p.code].count++;
    });
  });
  const picks = Object.values(pickMap)
    .sort((a,b)=>b.count-a.count)
    .slice(0,3)
    .map(p=>({
      code:p.code,
      name: fundName(p.code),
      type: fundType(p.code),
      reason: p.reasons[0],
      expected3m: p.expected[0]||'',
      endorsements: p.count
    }));

  // Merge portfolio advice
  const portAdvices = engines.map(e=>results[e].portfolioAdvice).filter(Boolean);
  const portfolioAdvice = portAdvices[0] || null;

  return {
    marketSummary: summaries[0] || '',
    benchmarkView: benchViews[0] || '',
    portfolioAdvice,
    signals: synthesizedSignals,
    picks,
    engineCount: total,
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
}

// ==================== RENDERING ====================
function renderAll(){
  renderCountdown();
  renderIndices();
  renderStats();
  renderPortfolio();
  renderSimBrief();
  renderSignals();
  renderWatchlist();
  renderRecos();
  renderReview();
}

function switchPfTab(tab){
  document.getElementById('pf-tab-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-tab-sat').classList.toggle('active', tab==='satellite');
  document.getElementById('pf-group-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-group-satellite').classList.toggle('active', tab==='satellite');
}

function renderPortfolio(){
  ['core','satellite'].forEach(groupKey=>{
    const group = MODEL_PORTFOLIO[groupKey];
    const container = document.getElementById(`pf-group-${groupKey}`);
    let html = `<div class="pf-group-desc">${group.desc}</div>`;

    group.funds.forEach(pf=>{
      const f = getFundData(pf.code);
      const td = fundHistoryData[pf.code]?.trend;
      const isHeld = holdings.some(h=>h.code===pf.code);
      const isWatched = watchlist.some(w=>w.code===pf.code);

      // Swing signal from trend data
      let swingClass = 'hold', swingText = 'ç­‰å¾…æ•°æ®';
      if(td){
        if(td.swingAdvice && td.swingAdvice.includes('ä¹°å…¥')){
          swingClass = 'buy'; swingText = 'âš¡ æ³¢æ®µä¹°å…¥';
        } else if(td.swingAdvice && (td.swingAdvice.includes('æ­¢ç›ˆ') || td.swingAdvice.includes('å‡ä»“'))){
          swingClass = 'sell'; swingText = 'ğŸ“¤ è€ƒè™‘æ­¢ç›ˆ';
        } else if(td.swingAdvice && td.swingAdvice.includes('ä¸å»ºè®®')){
          swingClass = 'sell'; swingText = 'â›” æš‚é¿';
        } else if(td.trendDir==='strong_up'||td.trendDir==='up'){
          swingClass = 'hold'; swingText = 'ğŸ“ˆ è¶‹åŠ¿å‘ä¸Š';
        } else if(td.trendDir==='strong_down'||td.trendDir==='down'){
          swingClass = 'sell'; swingText = 'ğŸ“‰ è¶‹åŠ¿åå¼±';
        } else {
          swingClass = 'hold'; swingText = 'ğŸ“Š éœ‡è¡è§‚æœ›';
        }
      }

      // Trend metrics
      let trendHtml = '';
      if(td){
        const mkVal = (v) => `<span style="color:${v>0?'var(--red)':v<0?'var(--green)':'var(--sub)'}">${v>0?'+':''}${v}%</span>`;
        trendHtml = `<div class="pf-trend-row">
          <div class="pf-trend-item"><span class="pf-trend-label">5æ—¥</span>${mkVal(td.chg5d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">20æ—¥</span>${mkVal(td.chg20d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">60æ—¥</span>${mkVal(td.chg60d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">å¹´</span>${mkVal(td.chg250d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">è·é«˜ç‚¹</span><span style="color:var(--sub)">${td.drawdownFromHigh}%</span></div>
        </div>`;
        if(td.swingAdvice){
          const advColor = td.swingAdvice.includes('ä¹°å…¥')?'var(--red)':td.swingAdvice.includes('å‡ä»“')||td.swingAdvice.includes('ä¸å»ºè®®')?'var(--green)':'var(--sub)';
          trendHtml += `<div style="font-size:10px;color:${advColor};margin-top:4px">ğŸ’¡ ${td.swingAdvice}</div>`;
        }
      }

      // Action buttons
      let actHtml = '';
      if(isHeld){
        actHtml = `<span class="pf-act-btn in-hold">âœ“ å·²æŒä»“</span>`;
      } else {
        actHtml = `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','holding')">+ åŠ å…¥æŒä»“</button>`;
      }
      if(isWatched){
        actHtml += `<span class="pf-act-btn in-watch">âœ“ å·²è‡ªé€‰</span>`;
      } else if(!isHeld){
        actHtml += `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','watch')">+ è‡ªé€‰</button>`;
      }

      html += `<div class="pf-card swing-${swingClass}">
        <div class="pf-top">
          <div class="pf-info">
            <div class="pf-name">${pf.name}</div>
            <div class="pf-code">${pf.code} Â· ${pf.type} Â· å»ºè®®é…ç½®${pf.alloc}</div>
          </div>
          <div class="pf-right">
            <div class="pf-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
            <div class="pf-swing-tag ${swingClass}">${swingText}</div>
          </div>
        </div>
        <div class="pf-reason">${pf.reason}</div>
        ${trendHtml}
        <div class="pf-actions">${actHtml}</div>
      </div>`;
    });

    container.innerHTML = html;
  });
}

function addFromPortfolio(code, name, type, mode){
  if(mode==='holding'){
    if(holdings.some(h=>h.code===code)) return;
    holdings.push({code, name, type});
    // åŒæ—¶ä»è‡ªé€‰ç§»é™¤
    watchlist = watchlist.filter(w=>w.code!==code);
    saveHoldings();
    saveWatchlist();
  } else {
    if(watchlist.some(w=>w.code===code)) return;
    if(holdings.some(h=>h.code===code)) return;
    watchlist.push({code, name, type});
    saveWatchlist();
  }
  renderPortfolio();
  renderSignals();
  renderWatchlist();
}

function renderIndices(){
  const cfgs = [
    {secid:'1.000001', vId:'iv-sh', pId:'ip-sh'},
    {secid:'0.399001', vId:'iv-sz', pId:'ip-sz'},
    {secid:'0.399006', vId:'iv-cy', pId:'ip-cy'},
    {secid:'1.000300', vId:'iv-hs', pId:'ip-hs'},
    {secid:'1.518880', vId:'iv-au', pId:'ip-au'},
    {secid:'0.161226', vId:'iv-ag', pId:'ip-ag'},
    {secid:'1.000819', vId:'iv-ys', pId:'ip-ys'},
  ];
  cfgs.forEach(c=>{
    const cfg = INDICES_CONFIG.find(x=>x.secid===c.secid);
    if(!cfg) return;
    const d = getIndexData(cfg);
    const vEl = document.getElementById(c.vId);
    const pEl = document.getElementById(c.pId);
    if(vEl) vEl.textContent = d.price;
    if(pEl){
      const pct = parseFloat(d.pct);
      pEl.textContent = `${pct>=0?'+':''}${(typeof pct==='number'?pct.toFixed(2):d.pct)}%`;
      pEl.className = 'idx-pct ' + (pct>0?'up':pct<0?'down':'flat');
    }
  });
}

function renderCountdown(){
  const ms = getMarketStatus();
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('market-status-text');
  const cd = document.getElementById('countdown');

  dot.className = 'status-dot ' + (ms.status==='open'?'open':'closed');
  text.textContent = ms.text;

  if(ms.countdown!==null && ms.countdown>0){
    cd.textContent = 'è·æ”¶ç›˜ ' + formatCountdown(ms.countdown);
    cd.style.display = '';
  } else if(ms.status==='open' && ms.countdown!==null && ms.countdown<=0){
    cd.textContent = 'å³å°†æ”¶ç›˜!';
    cd.style.display = '';
  } else {
    cd.textContent = ms.text;
  }
}

function renderStats(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  let totalPct = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      totalPct += f.gszzl;
    });
    totalPct /= holdings.length;
  }

  const statToday = document.getElementById('stat-today');
  statToday.textContent = holdings.length>0 ? `${sign(totalPct)}${fmt(totalPct)}%` : '--';
  statToday.className = 'stat-value ' + (holdings.length>0?(totalPct>=0?'up':'down'):'');

  const statHS300 = document.getElementById('stat-hs300');
  statHS300.textContent = `${sign(hs300.pct)}${fmt(hs300.pct)}%`;
  statHS300.className = 'stat-value ' + (hs300.pct>=0?'up':'down');

  const benchToday = document.getElementById('stat-bench-today');
  if(holdings.length>0){
    const diff = totalPct - hs300.pct;
    if(diff>=0) benchToday.innerHTML = `ä»Šæ—¥ <span class="beat">è·‘èµ¢å¤§ç›˜ +${fmt(diff)}%</span>`;
    else benchToday.innerHTML = `ä»Šæ—¥ <span class="lose">è½åå¤§ç›˜ ${fmt(diff)}%</span>`;
  } else {
    benchToday.textContent = 'æ·»åŠ æŒä»“æŸ¥çœ‹å¯¹æ¯”';
  }
}

function renderSignals(){
  const container = document.getElementById('signals-container');
  const badge = document.getElementById('signal-badge');

  if(holdings.length===0){
    container.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“¥</div>æ·»åŠ æŒä»“åï¼ŒAIä¼šç»™å‡ºä»Šæ—¥æ“ä½œå»ºè®®</div>';
    badge.textContent = 'æ— æŒä»“';
    return;
  }

  if(!_analysisResult){
    let html = '';
    holdings.forEach((h,i)=>{
      const f = getFundData(h.code);
      html += `<div class="signal-card hold">
        <div class="signal-top">
          <div class="signal-fund">
            <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="åˆ é™¤">âœ•</button></div>
            <div class="signal-code">${h.code} Â· ${fundType(h.code)}</div>
          </div>
          <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
        </div>
        <div style="font-size:11px;color:var(--sub)">ç‚¹å‡»ã€Œä¸€é”®AIåˆ†æã€è·å–æ“ä½œå»ºè®®</div>
      </div>`;
    });
    container.innerHTML = html;
    badge.textContent = 'ç­‰å¾…åˆ†æ';
    return;
  }

  const r = _analysisResult;
  badge.textContent = `${r.engineCount}å¼•æ“ Â· ${r.timestamp}`;

  let html = '';
  holdings.forEach((h,i)=>{
    const f = getFundData(h.code);
    const sig = r.signals[h.code];
    if(!sig){
      html += `<div class="signal-card hold">
        <div class="signal-top">
          <div class="signal-fund">
            <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="åˆ é™¤">âœ•</button></div>
            <div class="signal-code">${h.code}</div>
          </div>
          <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
        </div>
        <div style="font-size:11px;color:var(--sub)">AIæœªè¿”å›è¯¥åŸºé‡‘åˆ†æ</div>
      </div>`;
      return;
    }

    const actionText = sig.action==='buy'?'ğŸŸ¢ åŠ ä»“':sig.action==='sell'?'ğŸ”´ å‡ä»“':'âšª æŒæœ‰';
    const urgencyText = sig.urgency==='today'?'ä»Šæ—¥æ“ä½œ':sig.urgency==='this_week'?'æœ¬å‘¨å†…':'ä¸æ€¥';
    const confClass = sig.confidence>=75?'high':sig.confidence>=55?'mid':'low';
    const posLabel = sig.posType==='core'?'ğŸ›¡ï¸æ ¸å¿ƒä»“':'ğŸš€å«æ˜Ÿä»“';
    const posColor = sig.posType==='core'?'background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5':'background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4';
    const trendIcon = sig.trend==='up'?'ğŸ“ˆè¶‹åŠ¿â†‘':sig.trend==='down'?'ğŸ“‰è¶‹åŠ¿â†“':'ğŸ“Šéœ‡è¡';
    const trendColor = sig.trend==='up'?'color:var(--green)':sig.trend==='down'?'color:var(--red)':'color:var(--sub)';

    // æ„å»ºè¶‹åŠ¿è¯¦æƒ…è¡Œï¼ˆå¦‚æœæœ‰çœŸå®å†å²æ•°æ®ï¼‰
    let trendDetailHtml = '';
    const td = sig.trendDetail;
    if(td){
      const mkSpan = (label, val, suffix='%') => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span style="color:${c}">${label}${val>0?'+':''}${val}${suffix}</span>`;
      };
      trendDetailHtml = `<div style="display:flex;gap:8px;flex-wrap:wrap;font-size:10px;padding:4px 0;border-top:1px solid var(--border);margin-top:4px">
        ${mkSpan('5æ—¥:', td.chg5d)} ${mkSpan('20æ—¥:', td.chg20d)} ${mkSpan('60æ—¥:', td.chg60d)} ${mkSpan('å¹´:', td.chg250d)}
        <span style="color:var(--sub)">è·é«˜ç‚¹:${td.drawdownFromHigh}%</span>
      </div>`;
      if(td.swingAdvice){
        const advColor = td.swingAdvice.includes('ä¹°å…¥') ? 'var(--red)' : td.swingAdvice.includes('å‡ä»“') ? 'var(--green)' : 'var(--sub)';
        trendDetailHtml += `<div style="font-size:10px;color:${advColor};padding:2px 0">âš¡ ${td.swingAdvice}</div>`;
      }
    }

    html += `<div class="signal-card ${sig.action}">
      <div class="signal-top">
        <div class="signal-fund">
          <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="åˆ é™¤">âœ•</button></div>
          <div class="signal-code">${h.code} Â· ${fundType(h.code)}${sig.target3m?' Â· 3æœˆé¢„æœŸ:'+sig.target3m:''}</div>
        </div>
        <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px">
        <span class="signal-action ${sig.action}">${actionText}</span>
        <span class="signal-urgency ${sig.urgency==='today'?'high':sig.urgency==='this_week'?'medium':'low'}">${urgencyText}</span>
        <span style="font-size:10px;padding:1px 6px;border-radius:4px;${posColor}">${posLabel}</span>
        <span style="font-size:10px;${trendColor}">${trendIcon}</span>
      </div>
      <div class="conf-bar">
        <span class="conf-text">ç½®ä¿¡åº¦</span>
        <div class="conf-track"><div class="conf-fill ${confClass}" style="width:${sig.confidence}%"></div></div>
        <span class="conf-text" style="text-align:right;font-weight:600">${sig.confidence}%</span>
      </div>
      <div class="signal-reason">${sig.reason}</div>
      ${trendDetailHtml}
      <div class="signal-engines">${sig.breakdown}</div>
    </div>`;
  });

  container.innerHTML = html;
}

function renderWatchlist(){
  const section = document.getElementById('watchlist-section');
  const container = document.getElementById('watchlist-container');
  if(watchlist.length===0){ section.style.display='none'; return; }
  section.style.display='';

  let html = '';
  watchlist.forEach((w,i)=>{
    const f = getFundData(w.code);
    const sig = _analysisResult?.signals[w.code];
    const sigText = sig ? (sig.action==='buy'?'å»ºè®®ä¹°å…¥':sig.action==='sell'?'æš‚ä¸å»ºè®®':'å¯å…³æ³¨') : '';
    const sigColor = sig ? (sig.action==='buy'?'background:var(--green-bg);color:var(--green)':sig.action==='sell'?'background:var(--red-bg);color:var(--red)':'background:var(--gray-bg);color:var(--sub)') : '';
    const wTrend = fundHistoryData[w.code]?.trend;
    const trendBrief = wTrend ? ` Â· ${wTrend.trendDir==='strong_up'||wTrend.trendDir==='up'?'ğŸ“ˆ':'ğŸ“‰'}60æ—¥${wTrend.chg60d>0?'+':''}${wTrend.chg60d}%` : '';

    html += `<div class="watch-item">
      <div class="watch-left">
        <div class="watch-name">${fundName(w.code)} <span style="font-size:10px;color:var(--sub)">${w.code}</span></div>
        <div class="watch-type">${fundType(w.code)}${trendBrief}${sig?.target3m?' Â· 3æœˆ:'+sig.target3m:''}</div>
      </div>
      <span class="watch-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</span>
      ${sigText?`<span class="watch-signal" style="${sigColor}">${sigText}</span>`:''}
      <button class="watch-del" onclick="removeWatch(${i})">âœ•</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderRecos(){
  const section = document.getElementById('reco-section');
  const container = document.getElementById('reco-container');
  if(!_analysisResult || !_analysisResult.picks || _analysisResult.picks.length===0){
    section.style.display='none';
    return;
  }
  section.style.display='';

  let html = '';
  _analysisResult.picks.forEach(p=>{
    const reco = RECO_FUND_POOL.find(f=>f.code===p.code);
    html += `<div class="reco-card">
      <div class="reco-info">
        <div class="reco-name">${p.name||reco?.name||p.code}</div>
        <div class="reco-meta">${p.type||reco?.type||''} Â· ${p.endorsements}/${_analysisResult.engineCount}å¼•æ“æ¨è</div>
        <div class="reco-meta">${p.reason||''}</div>
      </div>
      ${p.expected3m?`<div class="reco-expect">${p.expected3m}</div>`:''}
      <button class="reco-add" onclick="addToWatchFromReco('${p.code}','${(p.name||reco?.name||'').replace(/'/g,"\\'")}','${p.type||reco?.type||''}')">+ è‡ªé€‰</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderMarketSummary(){
  const section = document.getElementById('market-summary-section');
  const container = document.getElementById('market-summary');
  if(!_analysisResult?.marketSummary){ section.style.display='none'; return; }
  section.style.display='';

  const pa = _analysisResult.portfolioAdvice;
  const portHtml = pa ? `<div style="margin-top:10px;padding:10px 14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0">
    <b style="font-size:12px;color:#1e293b">ğŸ’¼ ä»“ä½å»ºè®®</b><br>
    <span style="display:inline-flex;align-items:center;gap:6px;margin:6px 0"><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5">ğŸ›¡ï¸æ ¸å¿ƒä»“ ${pa.coreRatio||'60%'}</span>
    <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4">ğŸš€å«æ˜Ÿä»“ ${pa.satRatio||'40%'}</span></span><br>
    <span style="font-size:11px;color:#475569;line-height:1.5">${pa.advice||''}</span>
  </div>` : '';

  container.innerHTML = `<div class="market-summary">
    <b>ğŸ“ˆ å¸‚åœºç ”åˆ¤</b><span class="provider-tag">${_aiProvider.name}</span><br>
    ${_analysisResult.marketSummary}
    ${_analysisResult.benchmarkView?`<br><b>æ²ªæ·±300å±•æœ›ï¼š</b>${_analysisResult.benchmarkView}`:''}
    ${portHtml}
  </div>`;
}

// ==================== UI ACTIONS ====================
async function triggerAI(){
  if(_analyzing) return;
  if(!_aiKey){ alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key'); return; }
  if(holdings.length===0 && watchlist.length===0){ alert('è¯·å…ˆæ·»åŠ æŒä»“æˆ–è‡ªé€‰åŸºé‡‘'); return; }

  const btn = document.getElementById('ai-btn');
  const progress = document.getElementById('ai-progress');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-sm"></span> AIåˆ†æä¸­...';

  try {
    _analysisResult = await runAIAnalysis((msg, count)=>{
      progress.textContent = msg;
    });
    progress.textContent = `âœ… ${_analysisResult.engineCount}ä¸ªå¼•æ“åˆ†æå®Œæˆ`;
    saveTodayPredictions();
    // æ¨¡æ‹Ÿç›˜è‡ªåŠ¨äº¤æ˜“
    const simTrades = simAutoTrade();
    updateSimDaily();
    renderMarketSummary();
    renderSignals();
    renderWatchlist();
    renderRecos();
    renderReview();
    renderSimPortfolio();
    if(simTrades > 0) progress.textContent += ` Â· æ¨¡æ‹Ÿç›˜æ‰§è¡Œ${simTrades}ç¬”äº¤æ˜“`;
  } catch(e) {
    progress.textContent = `âŒ ${e.message}`;
  } finally {
    _analyzing = false;
    btn.disabled = false;
    btn.innerHTML = 'ğŸ§  ä¸€é”®AIåˆ†æ Â· 4å¼•æ“ç ”åˆ¤';
  }
}

function openAddModal(mode){
  _addMode = mode;
  document.getElementById('add-modal').style.display = 'flex';
  document.getElementById('add-modal-title').innerHTML = (mode==='holding'?'æ·»åŠ æŒä»“':'æ·»åŠ è‡ªé€‰') + ' <button onclick="closeAddModal()">âœ•</button>';
  document.getElementById('add-code').value = '';
  document.getElementById('add-name').value = '';
  document.getElementById('add-code').focus();
}
function closeAddModal(){ document.getElementById('add-modal').style.display='none'; }

function confirmAdd(){
  const code = document.getElementById('add-code').value.trim();
  if(!code || code.length<6){ alert('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç '); return; }

  const known = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
  const name = document.getElementById('add-name').value.trim() || known?.name || code;
  const type = document.getElementById('add-type').value || known?.type || 'å…¶ä»–';

  if(_addMode==='holding'){
    if(holdings.find(h=>h.code===code)){ alert('å·²å­˜åœ¨è¯¥æŒä»“'); return; }
    // å¦‚æœå·²åœ¨è‡ªé€‰ä¸­ï¼Œè‡ªåŠ¨ç§»é™¤ï¼ˆæŒä»“ä¼˜å…ˆçº§æ›´é«˜ï¼‰
    const wIdx = watchlist.findIndex(w=>w.code===code);
    if(wIdx>=0){ watchlist.splice(wIdx,1); saveWatchlist(); }
    holdings.push({code, name, type});
    saveHoldings();
  } else {
    if(holdings.find(h=>h.code===code)){ alert('è¯¥åŸºé‡‘å·²åœ¨æŒä»“ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ åˆ°è‡ªé€‰'); return; }
    if(watchlist.find(w=>w.code===code)){ alert('å·²å­˜åœ¨è¯¥è‡ªé€‰'); return; }
    watchlist.push({code, name, type});
    saveWatchlist();
  }

  closeAddModal();
  _analysisResult = null; // Clear old analysis
  loadData();
  // å¦‚æœç®¡ç†é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°åˆ—è¡¨
  if(document.getElementById('manage-overlay').style.display==='block'){
    renderManageList();
  }
}

function quickAdd(code, name, type){
  document.getElementById('add-code').value = code;
  document.getElementById('add-name').value = name;
  const sel = document.getElementById('add-type');
  for(let i=0;i<sel.options.length;i++){
    if(sel.options[i].value===type){ sel.selectedIndex=i; break; }
  }
}

function removeHolding(idx){
  if(!confirm(`ç¡®è®¤åˆ é™¤æŒä»“ã€Œ${holdings[idx]?.name||holdings[idx]?.code}ã€ï¼Ÿ`)) return;
  holdings.splice(idx,1);
  saveHoldings();
  _analysisResult = null;
  renderAll();
}

function removeWatch(idx){
  watchlist.splice(idx,1);
  saveWatchlist();
  renderWatchlist();
}

function addToWatchFromReco(code, name, type){
  if(watchlist.find(w=>w.code===code)){ alert('å·²åœ¨è‡ªé€‰ä¸­'); return; }
  watchlist.push({code, name, type});
  saveWatchlist();
  renderWatchlist();
}

// ==================== MANAGE PANEL ====================
let _manageTab = 'holding';

function openManagePanel(tab){
  _manageTab = tab || 'holding';
  document.getElementById('manage-overlay').style.display = 'block';
  document.getElementById('manage-search').value = '';
  switchManageTab(_manageTab);
}

function closeManagePanel(){
  document.getElementById('manage-overlay').style.display = 'none';
}

function switchManageTab(tab){
  _manageTab = tab;
  document.getElementById('manage-tab-holding').classList.toggle('active', tab==='holding');
  document.getElementById('manage-tab-watch').classList.toggle('active', tab==='watch');
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;
  document.getElementById('manage-search').placeholder = tab==='holding' ? 'ğŸ” æœç´¢æŒä»“åŸºé‡‘...' : 'ğŸ” æœç´¢è‡ªé€‰åŸºé‡‘...';
  renderManageList();
}

function renderManageList(){
  const body = document.getElementById('manage-body');
  const query = (document.getElementById('manage-search').value||'').trim().toLowerCase();
  const list = _manageTab==='holding' ? holdings : watchlist;
  const emptyIcon = _manageTab==='holding' ? 'ğŸ’¼' : 'ğŸ‘';
  const emptyLabel = _manageTab==='holding' ? 'æŒä»“' : 'è‡ªé€‰';

  // æ›´æ–°è®¡æ•°
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;

  if(list.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">${emptyIcon}</div>
      <div class="manage-empty-text">æš‚æ— ${emptyLabel}åŸºé‡‘</div>
      <button class="manage-add-btn" onclick="openAddModal('${_manageTab}')" style="margin:0 auto;display:block">+ æ·»åŠ ${emptyLabel}</button>
    </div>`;
    return;
  }

  // è¿‡æ»¤
  const filtered = list.filter((item,i)=>{
    if(!query) return true;
    const name = (fundName(item.code)||'').toLowerCase();
    return item.code.includes(query) || name.includes(query) || (item.name||'').toLowerCase().includes(query) || (item.type||'').toLowerCase().includes(query);
  });

  if(filtered.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">ğŸ”</div>
      <div class="manage-empty-text">æœªæ‰¾åˆ°åŒ¹é… "${query}" çš„åŸºé‡‘</div>
    </div>`;
    return;
  }

  let html = `<div style="font-size:10px;color:var(--sub);padding:4px 2px 8px">å…± ${filtered.length} åª${emptyLabel}åŸºé‡‘${query?' (æœç´¢ç»“æœ)':''}</div>`;

  filtered.forEach((item) => {
    const idx = list.indexOf(item);
    const fd = getFundData(item.code);
    const pctVal = parseFloat(fd?.gszzl) || 0;
    const pctColor = pctVal >= 0 ? 'var(--red)' : 'var(--green)';
    const pctSign = pctVal >= 0 ? '+' : '';
    const navVal = fd?.gsz || fd?.dwjz || '--';
    const navLabel = fd?._live ? 'å®æ—¶ä¼°å€¼' : 'å‡€å€¼';
    const name = fundName(item.code);
    const type = fundType(item.code);

    // è¶‹åŠ¿æ•°æ®
    const trend = fundHistoryData[item.code]?.trend;
    let trendHtml = '';
    if(trend){
      const mk = (label, val) => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span><span style="color:var(--sub)">${label}</span><span style="color:${c};font-weight:600">${val>0?'+':''}${val}%</span></span>`;
      };
      trendHtml = `<div class="manage-fund-trend">
        ${mk('5æ—¥', trend.chg5d)} ${mk('20æ—¥', trend.chg20d)} ${mk('60æ—¥', trend.chg60d)}
        <span><span style="color:var(--sub)">è·é«˜ç‚¹</span><span style="color:var(--green);font-weight:600">${trend.drawdownFromHigh}%</span></span>
      </div>`;
    }

    // æ“ä½œæŒ‰é’®
    let actionsHtml = '';
    if(_manageTab === 'holding'){
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToWatch(${idx})">â†’ ç§»è‡³è‡ªé€‰</button>
        <button class="manage-action-btn danger" onclick="removeFromManage('holding',${idx})">ğŸ—‘ åˆ é™¤</button>
      </div>`;
    } else {
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToHolding(${idx})">â†’ ç§»è‡³æŒä»“</button>
        <button class="manage-action-btn danger" onclick="removeFromManage('watch',${idx})">ğŸ—‘ åˆ é™¤</button>
      </div>`;
    }

    html += `<div class="manage-fund">
      <div class="manage-fund-top">
        <div class="manage-fund-info">
          <div class="manage-fund-name">${name}</div>
          <div class="manage-fund-meta">
            <span>${item.code}</span>
            <span class="manage-fund-type">${type}</span>
            <span>${navLabel}: ${typeof navVal==='number'?navVal.toFixed(4):navVal}</span>
          </div>
        </div>
        <div class="manage-fund-right">
          <div>
            <div class="manage-fund-pct" style="color:${pctColor}">${pctSign}${pctVal.toFixed(2)}%</div>
            <div class="manage-fund-nav">${fd?.gztime||''}</div>
          </div>
          <button class="manage-fund-del" onclick="removeFromManage('${_manageTab}',${idx})" title="åˆ é™¤">ğŸ—‘</button>
        </div>
      </div>
      ${trendHtml}
      ${actionsHtml}
    </div>`;
  });

  body.innerHTML = html;
}

function removeFromManage(type, idx){
  const list = type==='holding' ? holdings : watchlist;
  const item = list[idx];
  const label = type==='holding' ? 'æŒä»“' : 'è‡ªé€‰';
  if(!item) return;
  if(!confirm(`ç¡®è®¤åˆ é™¤${label}ã€Œ${item.name||fundName(item.code)||item.code}ã€ï¼Ÿ`)) return;

  list.splice(idx, 1);
  if(type==='holding'){
    saveHoldings();
    _analysisResult = null;
    renderAll();
  } else {
    saveWatchlist();
    renderWatchlist();
  }
  renderManageList();
}

function moveToWatch(holdingIdx){
  const item = holdings[holdingIdx];
  if(!item) return;
  if(watchlist.find(w=>w.code===item.code)){
    alert('è¯¥åŸºé‡‘å·²åœ¨è‡ªé€‰ä¸­');
    return;
  }
  holdings.splice(holdingIdx, 1);
  watchlist.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

function moveToHolding(watchIdx){
  const item = watchlist[watchIdx];
  if(!item) return;
  if(holdings.find(h=>h.code===item.code)){
    alert('è¯¥åŸºé‡‘å·²åœ¨æŒä»“ä¸­');
    return;
  }
  watchlist.splice(watchIdx, 1);
  holdings.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

// Settings
function openSettings(){
  document.getElementById('settings-modal').style.display = 'flex';
  document.getElementById('input-key').value = _aiKey || '';
  let phtml = '';
  AI_PROVIDERS.forEach(p=>{
    const sel = p.id===_aiProviderId;
    phtml += `<div onclick="selectProvider('${p.id}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:2px solid ${sel?'var(--primary)':'var(--border)'};border-radius:10px;margin-bottom:6px;cursor:pointer;background:${sel?'var(--primary-bg)':'white'};transition:all .2s">
      <div style="flex:1">
        <div style="font-weight:600;font-size:12px">${p.name} ${p.free?'<span style="font-size:9px;background:#22c55e;color:white;padding:1px 5px;border-radius:3px">å…è´¹</span>':''}</div>
        <div style="font-size:9px;color:var(--sub);margin-top:2px">${p.desc}</div>
      </div>
      <div style="width:18px;height:18px;border-radius:50%;border:2px solid ${sel?'var(--primary)':'#ccc'};display:flex;align-items:center;justify-content:center">
        ${sel?'<div style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>':''}
      </div>
    </div>`;
  });
  document.getElementById('provider-list').innerHTML = phtml;
  document.getElementById('provider-hint').innerHTML = `åœ¨ <a href='${_aiProvider.link}' target='_blank' style='color:var(--primary)'>${_aiProvider.name}</a> è·å–Key${_aiProvider.free?' (å…è´¹)':''}`;
  let ehtml = '';
  AI_ENGINES.forEach(eng=>{
    ehtml += `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${eng.icon}</span>
      <span style="flex:1;font-weight:500">${eng.name}</span>
      <span style="font-size:10px;color:var(--primary);background:var(--primary-bg);padding:1px 6px;border-radius:4px">${eng.model}</span>
    </div>`;
  });
  document.getElementById('engine-list').innerHTML = ehtml;
}
function selectProvider(id){ saveProvider(id); openSettings(); }
function closeSettings(){ document.getElementById('settings-modal').style.display='none'; }
function saveSettings(){
  const key = document.getElementById('input-key').value.trim();
  if(!key){ alert('è¯·è¾“å…¥API Key'); return; }
  saveKey(key);
  closeSettings();
  alert(`å·²ä¿å­˜ï¼å½“å‰: ${_aiProvider.name}`);
}
function toggleKeyVis(){
  const inp = document.getElementById('input-key');
  inp.type = inp.type==='password'?'text':'password';
}
function clearAllData(){
  if(!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ(æŒä»“ã€è‡ªé€‰ã€åˆ†æç»“æœç­‰)')) return;
  localStorage.removeItem('fa_holdings');
  localStorage.removeItem('fa_watchlist');
  localStorage.removeItem('fa_lastAnalysis');
  localStorage.removeItem('fa_lastReco');
  localStorage.removeItem('fa_daily_log');
  localStorage.removeItem('fa_sim_portfolio');
  location.reload();
}

// ==================== DAILY REVIEW SYSTEM ====================
// ä¿å­˜ä»Šæ—¥AIé¢„æµ‹å¿«ç…§
function saveTodayPredictions(){
  if(!_analysisResult || !_analysisResult.signals) return;
  const today = todayStr();

  // è®°å½•ä»Šæ—¥æ¯åªåŸºé‡‘çš„é¢„ä¼°æ¶¨è·Œ + é¢„æµ‹ä¿¡å·
  const pnl = {};
  const predictions = {};
  const allCodes = [...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)];
  allCodes.forEach(code=>{
    const f = getFundData(code);
    pnl[code] = +(f.gszzl||0).toFixed(2);
    const sig = _analysisResult.signals[code];
    if(sig){
      predictions[code] = {
        action: sig.action,
        confidence: sig.confidence,
        trend: sig.trend,
        reason: (sig.reason||'').slice(0,80),
        posType: sig.posType||''
      };
    }
  });

  // æŒä»“å¹³å‡ç›ˆäº
  let avgPnl = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{ avgPnl += (pnl[h.code]||0); });
    avgPnl = +(avgPnl/holdings.length).toFixed(2);
  }

  // æ²ªæ·±300
  const hs300 = getIndexData(INDICES_CONFIG[3]);

  // æ›´æ–°æˆ–æ–°å¢ä»Šæ—¥è®°å½•
  const idx = dailyLog.findIndex(d=>d.date===today);
  const entry = {
    date: today,
    predictions,
    pnl,
    avgPnl,
    hs300Pct: +(hs300.pct||0).toFixed(2),
    holdingCodes: holdings.map(h=>h.code),
    watchCodes: watchlist.map(w=>w.code),
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
  if(idx>=0) dailyLog[idx] = entry;
  else dailyLog.push(entry);

  saveDailyLog();
}

// ç”Ÿæˆæ¯æ—¥å¤ç›˜ï¼ˆå°†æ˜¨å¤©çš„é¢„æµ‹ä¸ä»Šæ—¥å®é™…è¡¨ç°å¯¹æ¯”ï¼‰
function generateDailyReview(){
  const today = todayStr();
  // æ‰¾æ˜¨å¤©ï¼ˆæˆ–æœ€è¿‘ä¸€ä¸ªæœ‰è®°å½•çš„äº¤æ˜“æ—¥ï¼‰çš„è®°å½•
  const pastEntries = dailyLog.filter(d=>d.date < today && d.predictions && Object.keys(d.predictions).length>0);
  if(pastEntries.length===0) return null;

  const yesterday = pastEntries[pastEntries.length-1];
  // ä»Šæ—¥å®é™…ç›ˆäºï¼ˆç”¨liveæ•°æ®ï¼‰
  const reviews = [];
  Object.keys(yesterday.predictions).forEach(code=>{
    const pred = yesterday.predictions[code];
    const todayData = getFundData(code);
    const actualPct = +(todayData?.gszzl||0).toFixed(2);

    // é¢„æµ‹æ˜¯å¦æ­£ç¡®
    let verdict = 'neutral'; // correct / wrong / neutral
    let lesson = '';
    if(pred.action==='buy'){
      if(actualPct > 0){ verdict='correct'; }
      else if(actualPct < -0.5){ verdict='wrong'; lesson=`å»ºè®®ä¹°å…¥ä½†ä»Šæ—¥è·Œ${actualPct}%ï¼Œå¯èƒ½ä½å¸æ—¶æœºæœªåˆ°æˆ–è¶‹åŠ¿åˆ¤æ–­éœ€ä¿®æ­£`; }
      else { verdict='neutral'; }
    } else if(pred.action==='sell'){
      if(actualPct < 0){ verdict='correct'; }
      else if(actualPct > 0.5){ verdict='wrong'; lesson=`å»ºè®®å‡ä»“ä½†ä»Šæ—¥æ¶¨${actualPct}%ï¼Œå¯èƒ½è¿‡æ—©ç¦»åœºé”™å¤±æ”¶ç›Š`; }
      else { verdict='neutral'; }
    } else { // hold
      if(Math.abs(actualPct) < 1){ verdict='correct'; }
      else if(actualPct < -1.5){ verdict='wrong'; lesson=`å»ºè®®æŒæœ‰ä½†ä»Šæ—¥è·Œ${actualPct}%ï¼ŒæœªåŠæ—¶æ­¢æŸæˆ–æœªè¯†åˆ«é£é™©ä¿¡å·`; }
      else if(actualPct > 2){ verdict='neutral'; lesson=`å»ºè®®æŒæœ‰ï¼Œä»Šæ—¥æ¶¨${actualPct}%ï¼Œä½†æœªå»ºè®®åŠ ä»“å¯èƒ½é”™å¤±æ³¢æ®µæœºä¼š`; }
    }

    reviews.push({
      code,
      name: fundName(code),
      predAction: pred.action,
      predConfidence: pred.confidence,
      predReason: pred.reason,
      actualPct,
      verdict,
      lesson
    });
  });

  // æ±‡æ€»
  const correct = reviews.filter(r=>r.verdict==='correct').length;
  const wrong = reviews.filter(r=>r.verdict==='wrong').length;
  const total = reviews.length;
  const accuracy = total>0 ? Math.round(correct/total*100) : 0;

  // æ˜¨æ—¥æŒä»“å¹³å‡
  const yesterdayAvg = yesterday.avgPnl||0;

  return {
    reviewDate: yesterday.date,
    todayDate: today,
    reviews,
    accuracy,
    correct,wrong,total,
    yesterdayAvg,
    yesterdayHs300: yesterday.hs300Pct||0
  };
}

// æ„å»ºå¤ç›˜ä¸Šä¸‹æ–‡ï¼ˆæ³¨å…¥AI promptï¼‰
function buildReviewContext(){
  const review = generateDailyReview();
  if(!review || review.reviews.length===0) return '';

  let ctx = `\nã€å†å²å¤ç›˜æ•™è®­ - è¯·ä»è¿‡å»çš„åˆ¤æ–­å¤±è¯¯ä¸­å­¦ä¹ ã€‘\n`;
  ctx += `ä¸Šæ¬¡åˆ†ææ—¥æœŸ:${review.reviewDate} â†’ ä»Šæ—¥éªŒè¯:${review.todayDate}\n`;
  ctx += `é¢„æµ‹å‡†ç¡®ç‡: ${review.accuracy}% (${review.correct}å¯¹/${review.wrong}é”™/${review.total}æ€»)\n`;

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  if(wrongOnes.length>0){
    ctx += `\nâš ï¸ åˆ¤æ–­å¤±è¯¯éœ€åæ€ï¼š\n`;
    wrongOnes.forEach(r=>{
      ctx += `- ${r.name}(${r.code}): é¢„æµ‹${r.predAction==='buy'?'ä¹°å…¥':r.predAction==='sell'?'å‡ä»“':'æŒæœ‰'} â†’ å®é™…${r.actualPct>0?'+':''}${r.actualPct}%`;
      if(r.lesson) ctx += ` | æ•™è®­:${r.lesson}`;
      ctx += `\n`;
    });
    ctx += `è¯·åœ¨ä»Šæ—¥åˆ†æä¸­ç‰¹åˆ«æ³¨æ„è¿™äº›å¤±è¯¯çš„åŒç±»å‹åŸºé‡‘ï¼Œé¿å…é‡å¤çŠ¯é”™ã€‚\n`;
  }

  const correctOnes = review.reviews.filter(r=>r.verdict==='correct');
  if(correctOnes.length>0){
    ctx += `\nâœ… åˆ¤æ–­æ­£ç¡®çš„ç»éªŒï¼š\n`;
    correctOnes.slice(0,3).forEach(r=>{
      ctx += `- ${r.name}: é¢„æµ‹${r.predAction==='buy'?'ä¹°å…¥':r.predAction==='sell'?'å‡ä»“':'æŒæœ‰'} â†’ å®é™…${r.actualPct>0?'+':''}${r.actualPct}% âœ“\n`;
    });
  }

  // åŠ å…¥æœ€è¿‘å‡ å¤©çš„ç›ˆäºè¶‹åŠ¿
  const recent = dailyLog.slice(-5).filter(d=>d.avgPnl!==undefined);
  if(recent.length>=2){
    ctx += `\nã€è¿‘æœŸæŒä»“ç›ˆäºèµ°åŠ¿ã€‘\n`;
    recent.forEach(d=>{
      ctx += `${d.date}: æŒä»“å¹³å‡${d.avgPnl>0?'+':''}${d.avgPnl}% | æ²ªæ·±300 ${d.hs300Pct>0?'+':''}${d.hs300Pct}%\n`;
    });
  }

  return ctx;
}

// æ¸²æŸ“å¤ç›˜UI
function renderReview(){
  const section = document.getElementById('review-section');
  const container = document.getElementById('review-container');
  const histToggle = document.getElementById('review-history-toggle');

  const review = generateDailyReview();

  if(!review || review.reviews.length===0){
    section.style.display = 'none';
    return;
  }
  section.style.display = '';

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  const accColor = review.accuracy>=70?'var(--green)':review.accuracy>=40?'var(--yellow)':'var(--red)';

  let html = `<div class="review-card">
    <div class="review-header">
      <div class="review-date">ğŸ“… ${review.reviewDate} â†’ ä»Šæ—¥éªŒè¯</div>
      <div class="review-pnl" style="color:${review.yesterdayAvg>=0?'var(--red)':'var(--green)'}">${review.yesterdayAvg>=0?'+':''}${review.yesterdayAvg}%</div>
    </div>
    <div class="review-stats">
      <div class="review-stat"><span class="review-stat-label">å‡†ç¡®ç‡</span><span class="review-stat-val" style="color:${accColor}">${review.accuracy}%</span></div>
      <div class="review-stat"><span class="review-stat-label">âœ…æ­£ç¡®</span><span class="review-stat-val" style="color:var(--green)">${review.correct}</span></div>
      <div class="review-stat"><span class="review-stat-label">âŒå¤±è¯¯</span><span class="review-stat-val" style="color:var(--red)">${review.wrong}</span></div>
      <div class="review-stat"><span class="review-stat-label">æ€»æ•°</span><span class="review-stat-val">${review.total}</span></div>
    </div>`;

  // å±•ç¤ºæ¯åªåŸºé‡‘çš„éªŒè¯ç»“æœ
  html += `<div class="review-items">`;
  // å…ˆæ˜¾ç¤ºé”™è¯¯çš„ï¼ˆé‡ç‚¹å…³æ³¨ï¼‰
  [...wrongOnes, ...review.reviews.filter(r=>r.verdict!=='wrong')].forEach(r=>{
    const predText = r.predAction==='buy'?'åŠ ä»“':r.predAction==='sell'?'å‡ä»“':'æŒæœ‰';
    const verdictText = r.verdict==='correct'?'âœ“å¯¹':r.verdict==='wrong'?'âœ—é”™':'â€”';
    const verdictClass = r.verdict;
    html += `<div class="review-item">
      <span class="review-fund-name">${r.name}</span>
      <span class="review-pred ${r.predAction}">${predText}</span>
      <span class="review-actual" style="color:${r.actualPct>=0?'var(--red)':'var(--green)'}">${r.actualPct>=0?'+':''}${r.actualPct}%</span>
      <span class="review-verdict ${verdictClass}">${verdictText}</span>
    </div>`;
  });
  html += `</div>`;

  // å¤±è¯¯æ•™è®­
  if(wrongOnes.length>0){
    const lessons = wrongOnes.filter(r=>r.lesson).map(r=>`â€¢ ${r.name}: ${r.lesson}`).join('<br>');
    if(lessons){
      html += `<div class="review-lesson">ğŸ“Œ <b>æ•™è®­æ€»ç»“</b><br>${lessons}</div>`;
    }
  }

  html += `</div>`;
  container.innerHTML = html;

  // å†å²è®°å½•
  if(dailyLog.length>1){
    histToggle.style.display = '';
  }
}

function toggleReviewHistory(){
  const histEl = document.getElementById('review-history');
  if(histEl.style.display==='none'){
    histEl.style.display = '';
    renderReviewHistory();
  } else {
    histEl.style.display = 'none';
  }
}

function renderReviewHistory(){
  const histEl = document.getElementById('review-history');
  const entries = dailyLog.slice().reverse().slice(0,10);
  if(entries.length===0){ histEl.innerHTML='<div style="text-align:center;font-size:11px;color:var(--sub);padding:12px">æš‚æ— å†å²è®°å½•</div>'; return; }

  let html = '';
  entries.forEach(entry=>{
    const holdPnlColor = entry.avgPnl>=0?'var(--red)':'var(--green)';
    const beatHs300 = entry.avgPnl > entry.hs300Pct;
    const predCount = Object.keys(entry.predictions||{}).length;
    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid var(--border);font-size:12px">
      <span style="color:var(--sub);min-width:80px">${entry.date}</span>
      <span style="font-weight:700;color:${holdPnlColor}">${entry.avgPnl>=0?'+':''}${entry.avgPnl}%</span>
      <span style="font-size:10px;color:var(--sub)">æ²ªæ·±300 ${entry.hs300Pct>=0?'+':''}${entry.hs300Pct}%</span>
      <span style="font-size:10px;padding:1px 6px;border-radius:4px;${beatHs300?'background:#ecfdf5;color:#16a34a':'background:#fef2f2;color:#dc2626'}">${beatHs300?'è·‘èµ¢':'è·‘è¾“'}</span>
      <span style="font-size:10px;color:var(--sub)">${predCount}åª</span>
      <span style="font-size:10px;color:var(--sub)">${entry.timestamp||''}</span>
    </div>`;
  });
  histEl.innerHTML = `<div style="background:var(--card);border-radius:var(--radius);padding:10px 14px;margin-top:4px;box-shadow:var(--shadow)">
    <div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--text)">ğŸ“Š æœ€è¿‘ç›ˆäºè®°å½•</div>
    ${html}
  </div>`;
}

// ==================== SIMULATION PORTFOLIO ====================
function saveSimPortfolio(){ localStorage.setItem('fa_sim_portfolio', JSON.stringify(simPortfolio)); }

function initSimPortfolio(){
  if(simPortfolio && simPortfolio.positions && simPortfolio.positions.length > 0) return;
  const today = todayStr();
  simPortfolio = {
    cash: 0, totalCapital: SIM_INITIAL_CAPITAL,
    positions: [], history: [], dailySnapshots: [],
    strategy: {
      coreRatio: 0.6, satRatio: 0.4,
      maxSinglePos: 0.15,
      stopLoss: -8, takeProfit: 20,
      dipBuyThreshold: -1.5, surgeSellThreshold: 3,
      rebalanceDays: 15,
    },
    created: today, targetMonthlyReturn: SIM_TARGET_MONTHLY,
    learningLog: [],
  };

  const allocations = [
    {code:'012414',name:'åå¤ä¸­è¯A500ETFè”æ¥A',type:'å®½åŸº',pct:20,group:'core'},
    {code:'007339',name:'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥C',type:'å®½åŸº',pct:15,group:'core'},
    {code:'000216',name:'åå®‰é»„é‡‘ETFè”æ¥A',type:'é»„é‡‘',pct:15,group:'core'},
    {code:'012643',name:'å¤©å¼˜çº¢åˆ©ä½æ³¢åŠ¨C',type:'çº¢åˆ©',pct:10,group:'core'},
    {code:'014832',name:'å¤©å¼˜ä¸­è¯æœ‰è‰²é‡‘å±ETFè”æ¥C',type:'æœ‰è‰²é‡‘å±',pct:10,group:'satellite'},
    {code:'015047',name:'å¹¿å‘äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',pct:8,group:'satellite'},
    {code:'001156',name:'ç”³ä¸‡è±ä¿¡ä¸­è¯åŠå¯¼ä½“æŒ‡æ•°A',type:'åŠå¯¼ä½“',pct:8,group:'satellite'},
    {code:'257070',name:'å›½æ³°ä¸­è¯å†›å·¥ETFè”æ¥A',type:'å†›å·¥',pct:7,group:'satellite'},
    {code:'013308',name:'æ˜“æ–¹è¾¾ä¸­è¯å…¨æŒ‡è¯åˆ¸å…¬å¸C',type:'é‡‘è',pct:7,group:'satellite'},
  ];

  let usedCash = 0;
  let hasRealData = false;
  allocations.forEach(a => {
    const amount = Math.round(SIM_INITIAL_CAPITAL * a.pct / 100);
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const fd = getFundData(a.code);
    // ä¼˜å…ˆç”¨çœŸå®æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰liveå°±ç”¨å†å²å‡€å€¼
    let nav;
    if(fd?._live){
      nav = fd.dwjz || fd.gsz; // ç”¨ç¡®è®¤å‡€å€¼
      hasRealData = true;
    } else if(fd?._histFallback){
      nav = fd.dwjz;
      hasRealData = true;
    } else {
      nav = fd?.dwjz || 1.0;
    }
    const shares = Math.floor(netAmount / nav * 100) / 100;
    simPortfolio.positions.push({
      code:a.code, name:a.name, type:a.type, group:a.group,
      shares, avgCost:nav, buyDate:today, targetPct:a.pct, investedAmount:amount,
      initNavSource: fd?._live ? 'live' : fd?._histFallback ? 'history' : 'fallback',
    });
    simPortfolio.history.push({
      date:today, action:'buy', code:a.code, name:a.name,
      amount, shares, nav, fee,
      reason:`åˆå§‹å»ºä»“Â·${a.group==='core'?'æ ¸å¿ƒä»“':'å«æ˜Ÿä»“'} ${a.pct}%é…æ¯”${fd?._live?'(å®æ—¶å‡€å€¼)':fd?._histFallback?'(å†å²å‡€å€¼)':'(å¾…æ ¡å‡†)'}`
    });
    usedCash += amount;
  });
  simPortfolio.cash = SIM_INITIAL_CAPITAL - usedCash;
  simPortfolio.dataQuality = hasRealData ? 'real' : 'pending';
  saveSimPortfolio();
}

function getSimNav(code){
  // æ”¶ç›˜åä¼˜å…ˆç”¨dwjz(ç¡®è®¤å‡€å€¼)ï¼Œç›˜ä¸­ç”¨gsz(ä¼°ç®—å‡€å€¼)
  const fd = getFundData(code);
  if(!fd) return null;
  const ms = getMarketStatus();
  if(ms.status==='open' || ms.status==='break'){
    return fd.gsz || fd.dwjz; // ç›˜ä¸­ç”¨ä¼°ç®—
  }
  return fd.dwjz || fd.gsz; // æ”¶ç›˜ç”¨ç¡®è®¤å‡€å€¼
}

function getSimTotalValue(){
  if(!simPortfolio) return SIM_INITIAL_CAPITAL;
  let total = simPortfolio.cash;
  simPortfolio.positions.forEach(pos => {
    const nav = getSimNav(pos.code) || pos.avgCost;
    total += pos.shares * nav;
  });
  return total;
}

function updateSimDaily(){
  if(!simPortfolio || !simPortfolio.positions) return;
  const today = todayStr();

  // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®æ•°æ®å¯ç”¨ï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªpositionæœ‰liveæ•°æ®ï¼‰
  let liveCount = 0;
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    if(fd?._live) liveCount++;
  });

  // å¦‚æœå·²å­˜åœ¨ä»Šæ—¥å¿«ç…§ï¼Œåªæœ‰å½“æ–°æ•°æ®è´¨é‡æ›´å¥½æ—¶æ‰æ›´æ–°
  const existingIdx = simPortfolio.dailySnapshots.findIndex(s => s.date === today);
  if(existingIdx >= 0 && liveCount <= (simPortfolio.dailySnapshots[existingIdx].liveDataCount||0)){
    return; // ç°æœ‰æ•°æ®è´¨é‡å·²ç»æ›´å¥½æˆ–ç›¸åŒï¼Œè·³è¿‡
  }

  let positionValue = 0;
  const posDetails = [];
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    const nav = getSimNav(pos.code) || pos.avgCost;
    const currentValue = pos.shares * nav;
    const pnl = currentValue - pos.investedAmount;
    const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
    positionValue += currentValue;
    posDetails.push({
      code:pos.code, nav:+nav.toFixed(4), value:Math.round(currentValue),
      pnl:Math.round(pnl), pnlPct:+pnlPct.toFixed(2),
      todayPct:+(fd?.gszzl||0).toFixed(2),
      isLive: !!(fd?._live),
    });
  });

  const totalValue = positionValue + simPortfolio.cash;
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  // å–å‰ä¸€å¤©ï¼ˆéä»Šå¤©ï¼‰çš„å¿«ç…§è®¡ç®—æ—¥å›æŠ¥
  const prevSnapshots = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const prevSnapshot = prevSnapshots.length > 0 ? prevSnapshots[prevSnapshots.length - 1] : null;
  const prevTotal = prevSnapshot ? prevSnapshot.totalValue : SIM_INITIAL_CAPITAL;
  const dailyReturn = (totalValue - prevTotal) / prevTotal * 100;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300Price = parseFloat(hs300.price) || 0;
  // åŸºå‡†ï¼šå–ç¬¬ä¸€å¤©æœ‰æ•ˆè®°å½•çš„hs300ä»·æ ¼
  const allSnaps = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const hs300Base = allSnaps.length > 0 ? allSnaps[0].hs300Base : hs300Price;
  const hs300CumPct = hs300Base > 0 ? (hs300Price / hs300Base - 1) * 100 : 0;

  const snapshot = {
    date:today, totalValue:Math.round(totalValue), cash:Math.round(simPortfolio.cash),
    positionValue:Math.round(positionValue), dailyReturn:+dailyReturn.toFixed(2),
    cumReturn:+cumReturn.toFixed(2), hs300Pct:+(hs300.pct||0).toFixed(2),
    hs300CumReturn:+hs300CumPct.toFixed(2), hs300Base, hs300Price,
    positions:posDetails, liveDataCount:liveCount,
    updatedAt: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
  };

  if(existingIdx >= 0){
    simPortfolio.dailySnapshots[existingIdx] = snapshot; // æ›´æ–°ä¸ºæ›´å¥½çš„æ•°æ®
  } else {
    simPortfolio.dailySnapshots.push(snapshot);
  }
  if(simPortfolio.dailySnapshots.length > 60) simPortfolio.dailySnapshots = simPortfolio.dailySnapshots.slice(-60);
  saveSimPortfolio();
}

function simTrade(code, action, amountOrPct, reason){
  if(!simPortfolio) return;
  const today = todayStr();
  const fd = getFundData(code);
  // åªç”¨æœ‰çœŸå®æ•°æ®çš„å‡€å€¼è¿›è¡Œäº¤æ˜“
  if(!fd?._live && !fd?._histFallback){
    console.warn(`simTrade: ${code} æ— çœŸå®æ•°æ®ï¼Œè·³è¿‡äº¤æ˜“`);
    return;
  }
  const nav = getSimNav(code) || fd?.gsz || fd?.dwjz || 1.0;
  const pos = simPortfolio.positions.find(p => p.code === code);

  if(action === 'buy'){
    const amount = (typeof amountOrPct==='number' && amountOrPct < 1) ? Math.round(getSimTotalValue() * amountOrPct) : amountOrPct;
    if(amount > simPortfolio.cash || amount < 100) return;
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const newShares = Math.floor(netAmount / nav * 100) / 100;
    if(pos){
      const totalInvested = pos.investedAmount + amount;
      pos.shares += newShares;
      pos.avgCost = totalInvested / pos.shares;
      pos.investedAmount = totalInvested;
    } else {
      const known = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
      simPortfolio.positions.push({
        code, name:known?.name||fd?.name||code, type:known?.type||'å…¶ä»–', group:'satellite',
        shares:newShares, avgCost:nav, buyDate:today, targetPct:0, investedAmount:amount,
      });
    }
    simPortfolio.cash -= amount;
    simPortfolio.history.push({date:today, action:'buy', code, name:pos?.name||code, amount, shares:newShares, nav, fee, reason});

  } else if(action === 'sell' && pos){
    const sellPct = (typeof amountOrPct==='number' && amountOrPct <= 1) ? amountOrPct : 0.5;
    const sellShares = Math.floor(pos.shares * sellPct * 100) / 100;
    if(sellShares < 0.01) return;
    const sellValue = Math.round(sellShares * nav);
    const fee = Math.round(sellValue * SIM_FEE_RATE * 0.5);
    pos.shares -= sellShares;
    pos.investedAmount = Math.round(pos.investedAmount * (1 - sellPct));
    simPortfolio.cash += (sellValue - fee);
    if(pos.shares < 0.01) simPortfolio.positions = simPortfolio.positions.filter(p => p.code !== code);
    simPortfolio.history.push({date:today, action:'sell', code, name:pos.name, amount:sellValue, shares:sellShares, nav, fee, reason});
  }
  saveSimPortfolio();
}

function simAutoTrade(){
  if(!simPortfolio || !_analysisResult) return 0;
  const strategy = simPortfolio.strategy;
  let tradesExecuted = 0;

  // 1. æ­¢ç›ˆæ­¢æŸæ£€æŸ¥
  [...simPortfolio.positions].forEach(pos => {
    const fd = getFundData(pos.code);
    if(!fd?._live && !fd?._histFallback) return; // åªç”¨çœŸå®æ•°æ®åšäº¤æ˜“å†³ç­–
    const nav = getSimNav(pos.code) || pos.avgCost;
    const pnlPct = (nav - pos.avgCost) / pos.avgCost * 100;
    if(pnlPct <= strategy.stopLoss && pos.group === 'satellite'){
      simTrade(pos.code, 'sell', 0.7, `â›”æ­¢æŸ: äº${pnlPct.toFixed(1)}%è¶…æ­¢æŸçº¿${strategy.stopLoss}%`);
      tradesExecuted++;
    }
    if(pnlPct >= strategy.takeProfit && pos.group === 'satellite'){
      simTrade(pos.code, 'sell', 0.4, `âœ…æ­¢ç›ˆ: èµš${pnlPct.toFixed(1)}%è¾¾æ­¢ç›ˆçº¿${strategy.takeProfit}%`);
      tradesExecuted++;
    }
  });

  // 2. AIä¿¡å·äº¤æ˜“
  simPortfolio.positions.forEach(pos => {
    const sig = _analysisResult.signals[pos.code];
    if(!sig) return;
    const fd = getFundData(pos.code);
    if(!fd?._live) return; // AIäº¤æ˜“åªç”¨å®æ—¶æ•°æ®
    const todayPct = fd?.gszzl || 0;

    if(sig.action==='buy' && sig.confidence>=65 && todayPct<=strategy.dipBuyThreshold){
      const posValue = pos.shares * (getSimNav(pos.code) || pos.avgCost);
      const totalValue = getSimTotalValue();
      if(posValue / totalValue < strategy.maxSinglePos){
        const addAmt = Math.min(Math.round(totalValue * 0.03), Math.round(simPortfolio.cash * 0.3));
        if(addAmt >= 1000){
          simTrade(pos.code, 'buy', addAmt, `AIåŠ ä»“(${sig.confidence}%ä¿¡å¿ƒ)+è·Œ${todayPct.toFixed(1)}%ä½å¸`);
          tradesExecuted++;
        }
      }
    }

    if(sig.action==='sell' && sig.confidence>=60 && todayPct>=strategy.surgeSellThreshold && pos.group==='satellite'){
      simTrade(pos.code, 'sell', 0.3, `AIå‡ä»“(${sig.confidence}%)+æ¶¨${todayPct.toFixed(1)}%æ­¢ç›ˆ`);
      tradesExecuted++;
    }
  });

  // 3. AIæ–°æ¨èå“ç§
  if(_analysisResult.picks && simPortfolio.cash > 20000){
    _analysisResult.picks.forEach(pick => {
      if(simPortfolio.positions.find(p => p.code === pick.code)) return;
      if(pick.endorsements >= 2){
        const amount = Math.min(Math.round(simPortfolio.cash * 0.15), 25000);
        if(amount >= 5000){
          simTrade(pick.code, 'buy', amount, `AIæ¨è(${pick.endorsements}å¼•æ“): ${(pick.reason||'').slice(0,40)}`);
          tradesExecuted++;
        }
      }
    });
  }

  // 4. ç­–ç•¥å­¦ä¹ 
  learnFromPerformance();
  saveSimPortfolio();
  return tradesExecuted;
}

function learnFromPerformance(){
  if(!simPortfolio || simPortfolio.dailySnapshots.length < 2) return;
  const today = todayStr();
  const snapshots = simPortfolio.dailySnapshots;
  const recent = snapshots.slice(-5);
  const avgDailyReturn = recent.reduce((s,d) => s + d.dailyReturn, 0) / recent.length;
  const strategy = simPortfolio.strategy;
  let lesson = '';
  let strategyChange = '';

  if(recent.length >= 3){
    const negDays = recent.filter(d => d.dailyReturn < 0).length;
    const posDays = recent.filter(d => d.dailyReturn > 0).length;
    if(negDays >= 4 && strategy.stopLoss > -6){
      strategy.stopLoss = Math.max(strategy.stopLoss - 1, -10);
      strategyChange = `è¿ç»­äºæŸ${negDays}å¤©â†’æ­¢æŸæ”¶ç´§è‡³${strategy.stopLoss}%`;
      lesson = 'å¸‚åœºæŒç»­èµ°å¼±ï¼Œå‡å°‘å«æ˜Ÿä»“æ•å£ï¼ŒåŠ å¼ºé£æ§';
    }
    if(posDays >= 4 && strategy.takeProfit < 25){
      strategy.takeProfit = Math.min(strategy.takeProfit + 2, 30);
      strategyChange = `è¿ç»­ç›ˆåˆ©${posDays}å¤©â†’æ­¢ç›ˆä¸Šè°ƒè‡³${strategy.takeProfit}%`;
      lesson = 'å¸‚åœºè¶‹åŠ¿è‰¯å¥½ï¼Œä¿æŒä»“ä½è®©åˆ©æ¶¦å¥”è·‘';
    }
  }

  // æ¿å—èƒœç‡åˆ†æ
  const latestSnap = snapshots[snapshots.length - 1];
  if(latestSnap?.positions){
    const winCount = latestSnap.positions.filter(p => p.todayPct > 0).length;
    const loseCount = latestSnap.positions.filter(p => p.todayPct < 0).length;
    if(loseCount > winCount && !lesson) lesson = `ä»Šæ—¥${loseCount}è·Œ/${winCount}æ¶¨ï¼Œæ³¨æ„å›è°ƒé£é™©`;
  }

  // é¢„æµ‹å‡†ç¡®ç‡åé¦ˆ
  const review = generateDailyReview();
  if(review && review.accuracy < 40 && !lesson){
    lesson = `AIé¢„æµ‹å‡†ç¡®ç‡ä»…${review.accuracy}%ï¼Œå‡å°‘é¢‘ç¹æ“ä½œ`;
    if(strategy.dipBuyThreshold > -2.5){
      strategy.dipBuyThreshold -= 0.5;
      strategyChange += (strategyChange?'ï¼›':'') + `åŠ ä»“é˜ˆå€¼â†’${strategy.dipBuyThreshold}%`;
    }
  }

  // æœˆåº¦å›æŠ¥æ£€æŸ¥
  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const daysRunning = snapshots.length;
  if(daysRunning >= 10){
    const monthlyPace = cumReturn / daysRunning * 22;
    if(monthlyPace < 1 && !lesson){
      lesson = `æœˆåŒ–æ”¶ç›Šç‡çº¦${monthlyPace.toFixed(1)}%ï¼Œä½äº2%ç›®æ ‡ï¼Œéœ€æé«˜è¿›æ”»æ€§`;
      if(strategy.dipBuyThreshold > -2.0){
        strategy.dipBuyThreshold = Math.max(strategy.dipBuyThreshold + 0.3, -1.0);
        strategyChange += (strategyChange?'ï¼›':'') + `é™ä½åŠ ä»“é—¨æ§›â†’${strategy.dipBuyThreshold.toFixed(1)}%`;
      }
    }
    if(monthlyPace > 5 && !lesson){
      lesson = `æœˆåŒ–çº¦${monthlyPace.toFixed(1)}%ï¼Œå¤§å¹…è¶…é¢ï¼Œé€‚å½“é”å®šåˆ©æ¶¦é˜²å›æ’¤`;
    }
  }

  if(lesson || strategyChange){
    simPortfolio.learningLog.push({
      date:today, lesson, strategyChange,
      cumReturn:+cumReturn.toFixed(2),
      avgDailyReturn:+avgDailyReturn.toFixed(3),
    });
    if(simPortfolio.learningLog.length > 30) simPortfolio.learningLog = simPortfolio.learningLog.slice(-30);
  }
  saveSimPortfolio();
}

function toggleSimDetail(){
  const container = document.getElementById('sim-container');
  const icon = document.getElementById('sim-toggle-icon');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = 'â–¼';
    renderSimPortfolio();
  } else {
    container.style.display = 'none';
    icon.textContent = 'â–¶';
  }
}

function renderSimBrief(){
  if(!simPortfolio) return;
  const totalValue = getSimTotalValue();
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  const brief = document.getElementById('sim-brief');
  if(brief){
    let liveCount = 0;
    simPortfolio.positions.forEach(p => { if(getFundData(p.code)?._live) liveCount++; });
    const total = simPortfolio.positions.length;
    const liveTag = liveCount===total ? 'ğŸŸ¢' : liveCount>0 ? 'ğŸŸ¡' : 'ğŸ”´';
    const color = cumProfit >= 0 ? 'var(--red)' : 'var(--green)';
    brief.innerHTML = `<span style="color:${color}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}å…ƒ</span> <span style="font-size:9px">${liveTag}${liveCount}/${total}</span>`;
  }
}

function renderSimPortfolio(){
  const container = document.getElementById('sim-container');
  if(!simPortfolio || !simPortfolio.positions){
    container.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div>æ¨¡æ‹Ÿç›˜åˆå§‹åŒ–ä¸­...</div>';
    return;
  }

  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  const targetPct = SIM_TARGET_MONTHLY / SIM_INITIAL_CAPITAL * 100;
  const progressPct = Math.min(100, Math.max(0, cumReturn / targetPct * 100));

  let realPnlPct = 0;
  if(holdings.length > 0){
    holdings.forEach(h => { realPnlPct += (getFundData(h.code).gszzl||0); });
    realPnlPct /= holdings.length;
  }

  const snapshots = simPortfolio.dailySnapshots;
  const latestSnap = snapshots[snapshots.length - 1];
  const todayReturn = latestSnap?.dailyReturn || 0;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300CumPct = latestSnap?.hs300CumReturn || 0;
  const beatMarket = cumReturn > hs300CumPct;

  let html = '';

  // æ¦‚è§ˆå¡ç‰‡
  html += `<div class="sim-overview">
    <div class="sim-stat-row">
      <div class="sim-stat"><div class="sim-stat-label">æ€»èµ„äº§</div><div class="sim-stat-val">${(totalValue/10000).toFixed(2)}<span style="font-size:11px">ä¸‡</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">ç´¯è®¡æ”¶ç›Š</div><div class="sim-stat-val" style="color:${cumProfit>=0?'#ef4444':'#22c55e'}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}<span style="font-size:11px">å…ƒ</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">ç°é‡‘</div><div class="sim-stat-val" style="font-size:14px">${(simPortfolio.cash/10000).toFixed(2)}<span style="font-size:10px">ä¸‡</span></div></div>
    </div>
    <div class="sim-target">
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
        <span>æœˆç›®æ ‡: +Â¥${SIM_TARGET_MONTHLY.toLocaleString()} (${targetPct.toFixed(1)}%)</span>
        <span style="font-weight:600;color:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'rgba(255,255,255,0.5)'}">
          ${cumProfit>=SIM_TARGET_MONTHLY?'âœ… å·²è¾¾æˆ':'è¿›åº¦ '+progressPct.toFixed(0)+'%'}
        </span>
      </div>
      <div class="sim-progress"><div class="sim-progress-fill" style="width:${progressPct}%;background:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'linear-gradient(90deg,#f59e0b,#ef4444)'}"></div></div>
    </div>
  </div>`;

  // å¯¹æ¯”å¡ç‰‡
  html += `<div class="sim-compare">
    <div class="sim-compare-title">ğŸ“Š ä»Šæ—¥å¯¹æ¯”</div>
    <div class="sim-compare-row">
      <div class="sim-compare-item">
        <span class="sim-compare-label">ğŸ¤– æ¨¡æ‹Ÿç›˜</span>
        <span class="sim-compare-val" style="color:${todayReturn>=0?'var(--red)':'var(--green)'}">${todayReturn>=0?'+':''}${todayReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">ğŸ’¼ çœŸå®æŒä»“</span>
        <span class="sim-compare-val" style="color:${realPnlPct>=0?'var(--red)':'var(--green)'}">${holdings.length>0?(realPnlPct>=0?'+':'')+realPnlPct.toFixed(2)+'%':'--'}</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">ğŸ“ˆ æ²ªæ·±300</span>
        <span class="sim-compare-val" style="color:${hs300.pct>=0?'var(--red)':'var(--green)'}">${hs300.pct>=0?'+':''}${fmt(hs300.pct)}%</span>
      </div>
    </div>
    <div class="sim-compare-row" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
      <div class="sim-compare-item">
        <span class="sim-compare-label">ç´¯è®¡æ”¶ç›Šç‡</span>
        <span class="sim-compare-val" style="color:${cumReturn>=0?'var(--red)':'var(--green)'}; font-weight:800">${cumReturn>=0?'+':''}${cumReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">vs æ²ªæ·±300</span>
        <span class="sim-compare-val" style="color:${beatMarket?'var(--red)':'var(--green)'}; font-weight:600">${beatMarket?'è·‘èµ¢':'è·‘è¾“'} ${Math.abs(cumReturn-hs300CumPct).toFixed(2)}%</span>
      </div>
    </div>
  </div>`;

  // æŒä»“æ˜ç»†
  html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px;display:flex;justify-content:space-between">
    <span>ğŸ“‹ æ¨¡æ‹ŸæŒä»“ (${simPortfolio.positions.length}åª)</span>
    <span style="font-weight:400;color:var(--sub);font-size:10px">å»ºä»“: ${simPortfolio.created}</span>
  </div>`;

  // æ•°æ®è´¨é‡ç»Ÿè®¡
  {
    let lc=0,hc=0,fc=0;
    simPortfolio.positions.forEach(p=>{const fd=getFundData(p.code);if(fd?._live)lc++;else if(fd?._histFallback)hc++;else fc++;});
    const tp=simPortfolio.positions.length;
    const ls=snapshots.length>0?snapshots[snapshots.length-1]:null;
    html += `<div style="font-size:9px;color:var(--sub);text-align:center;margin:6px 0;padding:4px 8px;background:rgba(255,255,255,0.03);border-radius:6px">
      æ•°æ®æº: ğŸŸ¢å®æ—¶${lc} ${hc>0?'ğŸŸ¡å†å²'+hc+' ':''}${fc>0?'ğŸ”´å¾…æ ¡å‡†'+fc+' ':''}Â· å…±${tp}åª ${ls?.updatedAt?'Â· æ›´æ–° '+ls.updatedAt:''}
    </div>`;
  }

  [...simPortfolio.positions]
    .sort((a,b) => a.group==='core'&&b.group!=='core' ? -1 : a.group!=='core'&&b.group==='core' ? 1 : 0)
    .forEach(pos => {
      const fd = getFundData(pos.code);
      const nav = getSimNav(pos.code) || pos.avgCost;
      const currentValue = pos.shares * nav;
      const pnl = currentValue - pos.investedAmount;
      const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
      const todayPct = fd?.gszzl || 0;
      const weight = currentValue / totalValue * 100;
      const g = pos.group === 'core' ? 'ğŸ›¡ï¸' : 'ğŸš€';
      const dataBadge = fd?._live ? 'ğŸŸ¢' : fd?._histFallback ? 'ğŸŸ¡' : 'ğŸ”´';
      html += `<div class="sim-pos-card">
        <div class="sim-pos-top">
          <div class="sim-pos-info">
            <div class="sim-pos-name">${g} ${pos.name} <span style="font-size:8px">${dataBadge}</span></div>
            <div class="sim-pos-meta">${pos.code} Â· ${pos.type} Â· ${weight.toFixed(1)}%</div>
          </div>
          <div class="sim-pos-right">
            <div class="sim-pos-pct" style="color:${todayPct>=0?'var(--red)':'var(--green)'}">${todayPct>=0?'+':''}${todayPct.toFixed(2)}%</div>
            <div style="font-size:10px;color:${pnlPct>=0?'var(--red)':'var(--green)'}">ç´¯è®¡${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%</div>
          </div>
        </div>
        <div class="sim-pos-detail">
          <span>Â¥${currentValue.toFixed(0)}</span>
          <span>æˆæœ¬Â¥${pos.investedAmount}</span>
          <span style="color:${pnl>=0?'var(--red)':'var(--green)'}">ç›ˆäº${pnl>=0?'+':''}Â¥${pnl.toFixed(0)}</span>
        </div>
      </div>`;
    });

  // ç­–ç•¥å‚æ•°
  html += `<div class="sim-strategy-card">
    <div style="font-size:11px;font-weight:600;margin-bottom:6px">âš™ï¸ å½“å‰ç­–ç•¥å‚æ•° <span style="font-weight:400;color:var(--sub);font-size:9px">AIè‡ªåŠ¨å­¦ä¹ è°ƒä¼˜</span></div>
    <div class="sim-param-grid">
      <div class="sim-param"><span class="sp-label">æ ¸å¿ƒ/å«æ˜Ÿ</span><span class="sp-val">${(simPortfolio.strategy.coreRatio*100).toFixed(0)}/${(simPortfolio.strategy.satRatio*100).toFixed(0)}</span></div>
      <div class="sim-param"><span class="sp-label">æ­¢æŸçº¿</span><span class="sp-val" style="color:var(--green)">${simPortfolio.strategy.stopLoss}%</span></div>
      <div class="sim-param"><span class="sp-label">æ­¢ç›ˆçº¿</span><span class="sp-val" style="color:var(--red)">+${simPortfolio.strategy.takeProfit}%</span></div>
      <div class="sim-param"><span class="sp-label">ä½å¸é˜ˆå€¼</span><span class="sp-val">${simPortfolio.strategy.dipBuyThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">å†²é«˜å‡ä»“</span><span class="sp-val">+${simPortfolio.strategy.surgeSellThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">å•åªä¸Šé™</span><span class="sp-val">${(simPortfolio.strategy.maxSinglePos*100).toFixed(0)}%</span></div>
    </div>
  </div>`;

  // å­¦ä¹ æ—¥å¿—
  if(simPortfolio.learningLog && simPortfolio.learningLog.length > 0){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">ğŸ§  ç­–ç•¥å­¦ä¹ æ—¥å¿—</div>`;
    simPortfolio.learningLog.slice(-5).reverse().forEach(log => {
      html += `<div class="sim-learn-card">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--sub)">
          <span>${log.date}</span><span>ç´¯è®¡${log.cumReturn>=0?'+':''}${log.cumReturn}%</span>
        </div>
        ${log.lesson ? `<div style="font-size:11px;margin-top:4px;line-height:1.5">ğŸ“Œ ${log.lesson}</div>` : ''}
        ${log.strategyChange ? `<div style="font-size:10px;color:var(--primary);margin-top:2px">âš™ï¸ ${log.strategyChange}</div>` : ''}
      </div>`;
    });
  }

  // äº¤æ˜“è®°å½•
  const recentTrades = (simPortfolio.history || []).slice(-8).reverse();
  if(recentTrades.length > 0){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">ğŸ“œ æœ€è¿‘äº¤æ˜“ <span style="font-weight:400;color:var(--sub)">(å…±${simPortfolio.history.length}ç¬”)</span></div>`;
    recentTrades.forEach(t => {
      const actionColor = t.action==='buy'?'var(--red)':'var(--green)';
      const actionIcon = t.action==='buy'?'ğŸŸ¢ä¹°':'ğŸ”´å–';
      html += `<div class="sim-trade-item">
        <span style="color:${actionColor};font-weight:600;min-width:36px">${actionIcon}</span>
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.name||t.code}</span>
        <span style="min-width:56px;text-align:right;font-weight:600">Â¥${t.amount.toLocaleString()}</span>
        <span style="min-width:70px;text-align:right;color:var(--sub)">${t.date}</span>
      </div>`;
    });
  }

  // æ”¶ç›Šèµ°åŠ¿
  if(snapshots.length >= 2){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">ğŸ“ˆ æ”¶ç›Šèµ°åŠ¿ (${snapshots.length}å¤©)</div><div class="sim-chart">`;
    const displaySnaps = snapshots.slice(-15);
    const maxRet = Math.max(...displaySnaps.map(s => Math.abs(s.cumReturn)), 0.1);
    displaySnaps.forEach(s => {
      const w = Math.abs(s.cumReturn) / maxRet * 100;
      const color = s.cumReturn >= 0 ? 'var(--red)' : 'var(--green)';
      html += `<div class="sim-chart-row">
        <span class="sim-chart-date">${s.date.slice(5)}</span>
        <div class="sim-chart-bar"><div style="width:${Math.max(w,2)}%;height:100%;background:${color};border-radius:3px"></div></div>
        <span class="sim-chart-val" style="color:${color}">${s.cumReturn>=0?'+':''}${s.cumReturn.toFixed(2)}%</span>
      </div>`;
    });
    html += `</div>`;
  }

  html += `<div style="text-align:center;margin-top:14px">
    <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="resetSimPortfolio()">ğŸ”„ é‡ç½®æ¨¡æ‹Ÿç›˜(50ä¸‡é‡æ–°å»ºä»“)</span>
  </div>`;

  container.innerHTML = html;
  renderSimBrief();
}

function resetSimPortfolio(){
  if(!confirm('ç¡®è®¤é‡ç½®æ¨¡æ‹Ÿç›˜ï¼Ÿå°†æ¸…é™¤æ‰€æœ‰æ¨¡æ‹Ÿäº¤æ˜“è®°å½•ï¼Œä»¥50ä¸‡é‡æ–°å»ºä»“ã€‚')) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  initSimPortfolio();
  updateSimDaily();
  renderSimPortfolio();
}

// ==================== INITIALIZATION ====================
async function loadData(){
  await Promise.all([fetchIndices(), fetchSectors(), fetchAllFunds()]);
  renderAll();
  // å¼‚æ­¥åŠ è½½å†å²æ•°æ®ï¼ˆä¸é˜»å¡ä¸»æ¸²æŸ“ï¼‰
  fetchAllHistory().then(()=>{
    console.log('å†å²è¶‹åŠ¿æ•°æ®åŠ è½½å®Œæˆ:', Object.keys(fundHistoryData).length, 'åªåŸºé‡‘');
  }).catch(e=>console.warn('å†å²æ•°æ®åŠ è½½å¤±è´¥:', e));
}

function startTimers(){
  _countdownTimer = setInterval(()=>{ renderCountdown(); }, 1000);

  _refreshTimer = setInterval(async ()=>{
    const ms = getMarketStatus();
    if(ms.status==='open' || ms.status==='break'){
      await Promise.all([fetchIndices(), fetchAllFunds()]);
      renderIndices();
      renderStats();
      if(_analysisResult) renderSignals();
      // åˆ·æ–°æ¨¡æ‹Ÿç›˜æ•°æ®ï¼ˆç”¨æœ€æ–°å¸‚åœºæ•°æ®æ›´æ–°ï¼‰
      updateSimDaily();
      renderSimBrief();
      if(document.getElementById('sim-container')?.style.display !== 'none'){
        renderSimPortfolio();
      }
    }
  }, 30000);
}

(async function init(){
  renderCountdown();
  renderAll();
  startTimers();
  await loadData();

  // åˆå§‹åŒ–æ¨¡æ‹Ÿç›˜
  initSimPortfolio();
  updateSimDaily();
  renderSimBrief();

  generateDailyReview();
  renderReview();

  // Auto-trigger AI if we have holdings/watchlist and API key
  if(_aiKey && (holdings.length>0 || watchlist.length>0)){
    triggerAI();
  }
})();
</script>
</body>
</html>
