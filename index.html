<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Âü∫ÈáëÂÜ≥Á≠ñÂä©Êâã</title>
<style>
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a2e; --sub: #8896a4;
  --border: #e8ecf1; --primary: #4F6EF7; --primary-bg: #eef2ff;
  --green: #22a065; --green-bg: #ecfdf5; --red: #e74040; --red-bg: #fef2f2;
  --yellow: #f59e0b; --yellow-bg: #fef3c7; --gray-bg: #f8fafc;
  --radius: 14px; --shadow: 0 1px 4px rgba(0,0,0,0.04);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro','PingFang SC','Helvetica Neue',sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; max-width:500px; margin:0 auto; min-height:100vh; padding-bottom:80px; }

/* Header ‚Äî Ê∑±Ëâ≤Â§ßÊ∞îÈ£éÊ†º */
.header { background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; padding:16px 16px 14px; position:sticky; top:0; z-index:100; }
.header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.header-title { font-size:17px; font-weight:700; letter-spacing:0.5px; }
.header-gear { background:none; border:none; color:rgba(255,255,255,0.7); font-size:18px; cursor:pointer; padding:4px; transition:color .2s; }
.header-gear:hover { color:#fff; }
.market-status { display:flex; align-items:center; gap:8px; font-size:12px; opacity:0.9; }
.status-dot { width:7px; height:7px; border-radius:50%; display:inline-block; }
.status-dot.open { background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,0.6); animation:pulse 2s infinite; }
.status-dot.closed { background:#64748b; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.countdown { font-family:'SF Mono','Menlo',monospace; font-weight:600; font-size:13px; background:rgba(255,255,255,0.08); padding:3px 10px; border-radius:6px; letter-spacing:0.5px; }

/* Stats Bar */
.stats-bar { display:grid; grid-template-columns:1fr 1fr; gap:0; padding:0; background:var(--card); border-bottom:1px solid var(--border); box-shadow:var(--shadow); }
.stat-item { text-align:center; padding:14px 12px; }
.stat-item:first-child { border-right:1px solid var(--border); }
.stat-label { font-size:10px; color:var(--sub); margin-bottom:4px; letter-spacing:0.5px; text-transform:uppercase; }
.stat-value { font-size:22px; font-weight:800; font-variant-numeric:tabular-nums; }
.stat-value.up { color:var(--red); }
.stat-value.down { color:var(--green); }
.stat-sub { font-size:10px; color:var(--sub); margin-top:3px; }
.stat-sub .beat { color:var(--red); font-weight:600; }
.stat-sub .lose { color:var(--green); font-weight:600; }

/* AI Button */
.ai-btn-wrap { padding:14px 16px 8px; }
.ai-btn { width:100%; padding:13px 16px; border:none; border-radius:var(--radius); background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:white; font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .25s; box-shadow:0 2px 8px rgba(30,41,59,0.3); letter-spacing:0.3px; }
.ai-btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(30,41,59,0.35); }
.ai-btn:active { transform:translateY(0); }
.ai-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
.ai-btn .spinner-sm { width:16px; height:16px; border:2px solid rgba(255,255,255,0.2); border-top-color:white; border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.ai-progress { font-size:11px; color:var(--sub); text-align:center; padding:6px 16px 2px; min-height:20px; }

/* Section */
.section { padding:10px 16px 4px; }
.section-title { font-size:14px; font-weight:700; color:var(--text); margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.section-badge { font-size:9px; background:#1e293b; color:white; padding:2px 8px; border-radius:10px; font-weight:500; letter-spacing:0.3px; }

/* Signal Cards */
.signal-card { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:10px; box-shadow:var(--shadow); transition:all .25s; border:1px solid transparent; }
.signal-card.buy { border-left:4px solid var(--red); background:linear-gradient(135deg,#fff 92%,#fef2f2); }
.signal-card.sell { border-left:4px solid var(--green); background:linear-gradient(135deg,#fff 92%,#ecfdf5); }
.signal-card.hold { border-left:4px solid #cbd5e1; }
.signal-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.signal-fund { flex:1; }
.signal-name { font-size:14px; font-weight:600; }
.signal-code { font-size:10px; color:var(--sub); margin-top:2px; }
.signal-pct { font-size:17px; font-weight:800; min-width:70px; text-align:right; font-variant-numeric:tabular-nums; }
.signal-action { display:inline-flex; align-items:center; gap:4px; padding:4px 12px; border-radius:8px; font-size:12px; font-weight:600; }
.signal-action.buy { background:var(--red-bg); color:var(--red); }
.signal-action.sell { background:var(--green-bg); color:var(--green); }
.signal-action.hold { background:var(--gray-bg); color:var(--sub); }
.signal-urgency { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:500; }
.signal-urgency.high { background:#fee2e2; color:#dc2626; }
.signal-urgency.medium { background:var(--yellow-bg); color:var(--yellow); }
.signal-urgency.low { background:#f1f5f9; color:#64748b; }

/* Confidence Bar */
.conf-bar { display:flex; align-items:center; gap:6px; margin:8px 0; }
.conf-track { flex:1; height:5px; background:#e2e8f0; border-radius:3px; overflow:hidden; }
.conf-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.conf-fill.high { background:linear-gradient(90deg,#22a065,#16a34a); }
.conf-fill.mid { background:linear-gradient(90deg,#f59e0b,#eab308); }
.conf-fill.low { background:#94a3b8; }
.conf-text { font-size:10px; color:var(--sub); min-width:30px; }
.signal-reason { font-size:12px; color:#475569; line-height:1.65; }
.signal-engines { font-size:10px; color:var(--sub); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }

/* Reco Cards */
.reco-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); display:flex; align-items:center; gap:12px; transition:transform .2s; }
.reco-card:active { transform:scale(0.98); }
.reco-info { flex:1; }
.reco-name { font-size:13px; font-weight:600; }
.reco-meta { font-size:10px; color:var(--sub); margin-top:3px; line-height:1.4; }
.reco-expect { font-size:13px; font-weight:700; color:var(--red); }
.reco-add { background:#1e293b; color:white; border:none; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.reco-add:hover { background:#334155; }

/* Watch item */
.watch-item { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:6px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; transition:transform .2s; }
.watch-item:active { transform:scale(0.98); }
.watch-left { flex:1; min-width:0; }
.watch-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.watch-type { font-size:10px; color:var(--sub); margin-top:2px; }
.watch-pct { font-size:15px; font-weight:800; min-width:60px; text-align:right; font-variant-numeric:tabular-nums; }
.watch-signal { font-size:10px; padding:3px 8px; border-radius:6px; white-space:nowrap; font-weight:500; }
.watch-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:14px; padding:4px; transition:color .2s; }
.watch-del:hover { color:var(--red); }

/* Holding delete */
.hold-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:11px; padding:2px 4px; margin-left:4px; transition:color .2s; }
.hold-del:hover { color:var(--red); }

/* Empty state */
.empty { text-align:center; padding:32px 16px; color:var(--sub); font-size:12px; }
.empty-icon { font-size:36px; margin-bottom:10px; opacity:0.6; }

/* Bottom Bar */
.bottom-bar { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); display:flex; gap:10px; z-index:100; box-shadow:0 -2px 10px rgba(0,0,0,0.04); }
.bottom-btn { flex:1; padding:11px; border:none; border-radius:12px; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; letter-spacing:0.3px; }
.bottom-btn.primary { background:#1e293b; color:white; }
.bottom-btn.primary:hover { background:#334155; }
.bottom-btn.secondary { background:var(--gray-bg); color:var(--text); border:1px solid var(--border); }
.bottom-btn.secondary:hover { background:#eef2ff; }

/* Modal */
.modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:400; align-items:center; justify-content:center; }
.fund-search-box { position:relative; margin-bottom:12px; }
.fund-search-box input { width:100%; padding:12px 14px 12px 36px; border:1.5px solid var(--border); border-radius:12px; font-size:14px; outline:none; background:var(--gray-bg); transition:border-color .2s,box-shadow .2s; }
.fund-search-box input:focus { border-color:var(--primary); background:#fff; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
.fund-search-box .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:var(--sub); pointer-events:none; }
.fund-search-results { max-height:260px; overflow-y:auto; border:1px solid var(--border); border-radius:12px; background:var(--card); }
.fund-search-results:empty { display:none; }
.fund-result-item { display:flex; align-items:center; padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--border); transition:background .15s; gap:10px; }
.fund-result-item:last-child { border-bottom:none; }
.fund-result-item:hover,.fund-result-item:active { background:var(--primary-bg); }
.fund-result-code { font-size:13px; font-weight:700; color:var(--primary); min-width:60px; font-variant-numeric:tabular-nums; }
.fund-result-name { font-size:12px; color:var(--text); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fund-result-type { font-size:9px; background:var(--gray-bg); color:var(--sub); padding:2px 6px; border-radius:6px; white-space:nowrap; }
.fund-search-hint { text-align:center; padding:20px 10px; font-size:11px; color:var(--sub); }
.fund-selected-card { display:flex; align-items:center; gap:10px; padding:12px 14px; background:linear-gradient(135deg,var(--primary-bg),#eef2ff); border:1.5px solid var(--primary); border-radius:12px; margin-bottom:14px; }
.fund-selected-card .sel-code { font-size:15px; font-weight:700; color:var(--primary); }
.fund-selected-card .sel-name { font-size:13px; color:var(--text); flex:1; }
.fund-selected-card .sel-clear { background:none; border:none; font-size:16px; color:var(--sub); cursor:pointer; padding:4px; }
.modal { background:var(--card); border-radius:20px; margin:16px; padding:24px; max-width:380px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.15); }
.modal h3 { font-size:17px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; }
.modal h3 button { background:none; border:none; font-size:18px; cursor:pointer; color:var(--sub); width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background .2s; }
.modal h3 button:hover { background:var(--gray-bg); }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; font-weight:600; color:var(--sub); margin-bottom:5px; letter-spacing:0.3px; text-transform:uppercase; }
.form-row input, .form-row select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; transition:border-color .2s; outline:none; background:var(--gray-bg); }
.form-row input:focus, .form-row select:focus { border-color:var(--primary); background:#fff; }
.form-btn { width:100%; padding:12px; border:none; border-radius:12px; background:#1e293b; color:white; font-size:14px; font-weight:600; cursor:pointer; transition:background .2s; letter-spacing:0.3px; }
.form-btn:hover { background:#334155; }

.spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto; }

/* Market summary */
.market-summary { font-size:12px; color:#475569; line-height:1.7; padding:14px 16px; background:var(--card); border-radius:var(--radius); margin-bottom:10px; box-shadow:var(--shadow); border-left:3px solid var(--primary); }
.provider-tag { font-size:9px; background:var(--primary-bg); color:var(--primary); padding:2px 8px; border-radius:10px; margin-left:6px; font-weight:500; }

/* Index Bar */
.idx-bar { background:linear-gradient(135deg,#0f172a,#1e293b); padding:10px 16px 12px; display:flex; gap:0; border-bottom:1px solid rgba(255,255,255,0.06); }
.idx-item { flex:1; text-align:center; position:relative; }
.idx-item+.idx-item { border-left:1px solid rgba(255,255,255,0.08); }
.idx-name { font-size:10px; color:rgba(251,191,36,0.75); letter-spacing:0.3px; }
.idx-val { font-size:14px; font-weight:700; color:#fff; margin-top:2px; font-variant-numeric:tabular-nums; }
.idx-pct { font-size:11px; font-weight:600; margin-top:1px; font-variant-numeric:tabular-nums; }
.idx-pct.up { color:#ef4444; }
.idx-pct.down { color:#22c55e; }
.idx-pct.flat { color:rgba(255,255,255,0.5); }

/* Portfolio Section */
.pf-section { padding:10px 16px 4px; }
.pf-tabs { display:flex; gap:0; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); margin-bottom:12px; }
.pf-tab { flex:1; padding:10px 8px; text-align:center; cursor:pointer; border:none; background:transparent; font-size:12px; font-weight:600; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; }
.pf-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.pf-tab .pf-tab-ratio { font-size:10px; font-weight:400; color:var(--sub); display:block; margin-top:2px; }
.pf-group { display:none; }
.pf-group.active { display:block; }
.pf-group-desc { font-size:11px; color:var(--sub); margin-bottom:10px; padding:0 2px; line-height:1.5; }
.pf-card { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.pf-card:active { transform:scale(0.98); }
.pf-card.swing-buy { border-left:3px solid var(--red); }
.pf-card.swing-sell { border-left:3px solid var(--green); }
.pf-card.swing-hold { border-left:3px solid #cbd5e1; }
.pf-top { display:flex; justify-content:space-between; align-items:flex-start; }
.pf-info { flex:1; min-width:0; }
.pf-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pf-code { font-size:10px; color:var(--sub); margin-top:1px; }
.pf-right { text-align:right; min-width:70px; }
.pf-pct { font-size:16px; font-weight:800; font-variant-numeric:tabular-nums; }
.pf-swing-tag { display:inline-block; font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; margin-top:3px; }
.pf-swing-tag.buy { background:var(--red-bg); color:var(--red); }
.pf-swing-tag.sell { background:var(--green-bg); color:var(--green); }
.pf-swing-tag.hold { background:var(--gray-bg); color:var(--sub); }
.pf-trend-row { display:flex; gap:6px; flex-wrap:wrap; font-size:10px; margin-top:8px; padding-top:7px; border-top:1px solid var(--border); }
.pf-trend-item { display:flex; align-items:center; gap:2px; }
.pf-trend-label { color:var(--sub); }
.pf-reason { font-size:11px; color:#64748b; margin-top:6px; line-height:1.4; }
.pf-actions { display:flex; gap:6px; margin-top:8px; }
.pf-act-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.pf-act-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.pf-act-btn.in-hold { background:rgba(34,160,101,0.08); color:var(--green); border-color:var(--green); cursor:default; font-weight:600; }
.pf-act-btn.in-watch { background:rgba(79,110,247,0.08); color:var(--primary); border-color:var(--primary); cursor:default; font-weight:600; }

/* Review Section */
.review-section { padding:10px 16px 4px; }
.review-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:var(--shadow); }
.review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.review-date { font-size:13px; font-weight:700; color:var(--text); }
.review-pnl { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.review-stats { display:flex; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
.review-stat { font-size:11px; display:flex; align-items:center; gap:4px; }
.review-stat-label { color:var(--sub); }
.review-stat-val { font-weight:600; }
.review-items { border-top:1px solid var(--border); padding-top:8px; }
.review-item { display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.03); font-size:12px; }
.review-item:last-child { border-bottom:none; }
.review-fund-name { flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; }
.review-pred { font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; }
.review-pred.buy { background:var(--red-bg); color:var(--red); }
.review-pred.sell { background:var(--green-bg); color:var(--green); }
.review-pred.hold { background:var(--gray-bg); color:var(--sub); }
.review-actual { font-weight:700; min-width:55px; text-align:right; font-variant-numeric:tabular-nums; }
.review-verdict { font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; white-space:nowrap; }
.review-verdict.correct { background:#ecfdf5; color:#16a34a; }
.review-verdict.wrong { background:#fef2f2; color:#dc2626; }
.review-verdict.neutral { background:#f8fafc; color:#64748b; }
.review-lesson { margin-top:8px; padding:8px 12px; background:#fffbeb; border-radius:8px; border:1px solid #fde68a; font-size:11px; color:#92400e; line-height:1.5; }
.review-toggle { font-size:11px; color:var(--primary); cursor:pointer; font-weight:500; }
.review-history-toggle { text-align:center; padding:8px; }

/* Simulation Portfolio */
.sim-section { padding:10px 16px 4px; }
.sim-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.sim-header-right { display:flex; align-items:center; gap:8px; }
.sim-toggle-icon { font-size:12px; color:var(--sub); transition:transform .2s; }
.sim-overview { background:linear-gradient(135deg,#0f172a,#1e293b); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 8px rgba(15,23,42,0.2); }
.sim-stat-row { display:flex; gap:0; }
.sim-stat { flex:1; text-align:center; position:relative; }
.sim-stat+.sim-stat { border-left:1px solid rgba(255,255,255,0.1); }
.sim-stat-label { font-size:9px; color:rgba(255,255,255,0.5); letter-spacing:0.3px; }
.sim-stat-val { font-size:18px; font-weight:800; margin-top:2px; font-variant-numeric:tabular-nums; }
.sim-target { margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); }
.sim-target span { color:rgba(255,255,255,0.6); }
.sim-progress { height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; }
.sim-progress-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.sim-compare { background:var(--card); border-radius:var(--radius); padding:12px 14px; margin-bottom:10px; box-shadow:var(--shadow); }
.sim-compare-title { font-size:12px; font-weight:700; margin-bottom:8px; }
.sim-compare-row { display:flex; gap:0; }
.sim-compare-item { flex:1; text-align:center; padding:4px 0; }
.sim-compare-item+.sim-compare-item { border-left:1px solid var(--border); }
.sim-compare-label { font-size:9px; color:var(--sub); display:block; }
.sim-compare-val { font-size:14px; font-weight:700; font-variant-numeric:tabular-nums; }
.sim-pos-card { background:var(--card); border-radius:10px; padding:10px 12px; margin-bottom:6px; box-shadow:var(--shadow); }
.sim-pos-top { display:flex; justify-content:space-between; align-items:flex-start; }
.sim-pos-info { flex:1; min-width:0; }
.sim-pos-name { font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.sim-pos-meta { font-size:9px; color:var(--sub); margin-top:1px; }
.sim-pos-right { text-align:right; min-width:60px; }
.sim-pos-pct { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.sim-pos-detail { display:flex; gap:8px; font-size:10px; color:var(--sub); margin-top:4px; padding-top:4px; border-top:1px solid var(--border); }
.sim-learn-card { background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:8px 10px; margin-bottom:6px; }
.sim-strategy-card { background:var(--card); border-radius:10px; padding:10px 14px; box-shadow:var(--shadow); margin-bottom:8px; }
.sim-param-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.sim-param { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.sp-label { font-size:9px; color:var(--sub); display:block; }
.sp-val { font-size:12px; font-weight:700; }
.sim-trade-item { display:flex; align-items:center; gap:6px; padding:6px 0; border-bottom:1px solid var(--border); font-size:11px; }
.sim-trade-item:last-child { border-bottom:none; }
.sim-chart { background:var(--card); border-radius:10px; padding:10px 12px; box-shadow:var(--shadow); }
.sim-chart-row { display:flex; align-items:center; gap:6px; padding:2px 0; }
.sim-chart-date { font-size:9px; color:var(--sub); min-width:36px; }
.sim-chart-bar { flex:1; height:10px; background:var(--bg); border-radius:3px; overflow:hidden; }
.sim-chart-val { font-size:9px; font-weight:600; min-width:42px; text-align:right; font-variant-numeric:tabular-nums; }

/* Manage Panel */
/* Data Intelligence Dashboard */
.data-intel { padding:10px 16px 4px; }
.data-intel-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.data-intel-header-right { display:flex; align-items:center; gap:8px; }
.data-intel-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.data-intel-brief { font-size:11px; font-weight:600; }
.data-intel-container { margin-top:8px; }
.macro-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.macro-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.macro-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.macro-item { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.macro-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.macro-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.macro-val.positive { color:var(--red); }
.macro-val.negative { color:var(--green); }
.macro-val.neutral { color:var(--sub); }
.news-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.news-item { display:flex; gap:6px; padding:5px 0; border-bottom:1px solid var(--border); align-items:flex-start; }
.news-item:last-child { border-bottom:none; }
.news-sentiment { font-size:12px; min-width:18px; text-align:center; }
.news-text { font-size:11px; color:var(--text); line-height:1.4; flex:1; }
.news-time { font-size:9px; color:var(--sub); min-width:36px; text-align:right; white-space:nowrap; }
.cap-flow-bar { height:8px; border-radius:4px; overflow:hidden; background:var(--bg); margin-top:2px; }
.cap-flow-fill { height:100%; border-radius:4px; }
.sentiment-meter { display:flex; align-items:center; gap:8px; padding:8px 0; }
.sentiment-bar { flex:1; height:10px; border-radius:5px; background:linear-gradient(90deg,var(--green),#fbbf24,var(--red)); position:relative; }
.sentiment-dot { width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #1e293b; position:absolute; top:-2px; transition:left .3s; }
.sentiment-label { font-size:10px; font-weight:700; min-width:40px; }
/* Global News Aggregation */
.global-news-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.global-news-sources { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px; }
.global-news-tag { font-size:8px; padding:2px 6px; border-radius:8px; background:var(--bg); color:var(--sub); font-weight:600; }
.global-news-tag.active { background:#3b82f6; color:#fff; }
.global-news-item { display:flex; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); align-items:flex-start; }
.global-news-item:last-child { border-bottom:none; }
.global-news-src { font-size:8px; color:#3b82f6; font-weight:700; min-width:32px; text-transform:uppercase; }
.global-news-title { font-size:11px; color:var(--text); line-height:1.4; flex:1; }
.global-news-title a { color:var(--text); text-decoration:none; }
.global-news-title a:hover { text-decoration:underline; }
.global-news-cat { font-size:8px; color:var(--sub); background:var(--bg); padding:1px 5px; border-radius:4px; white-space:nowrap; }
.global-news-time { font-size:9px; color:var(--sub); min-width:36px; text-align:right; white-space:nowrap; }
.global-news-summary { background:linear-gradient(135deg,#1e3a5f,#0f172a); color:#e2e8f0; border-radius:10px; padding:12px 14px; margin-bottom:8px; font-size:11px; line-height:1.6; }
.global-news-summary-title { font-size:11px; font-weight:700; margin-bottom:6px; color:#93c5fd; }
.global-news-impact { margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1); }
.global-news-impact-title { font-size:10px; font-weight:700; color:#fbbf24; margin-bottom:4px; }
.global-news-impact-item { font-size:10px; line-height:1.5; padding:2px 0; }
.global-news-sentiment { display:flex; justify-content:center; gap:16px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1); }
.global-news-sentiment-item { text-align:center; }
.global-news-sentiment-label { font-size:8px; color:rgba(255,255,255,0.5); }
.global-news-sentiment-val { font-size:14px; font-weight:700; }
.global-news-btn { display:block; width:100%; padding:8px; border:1px dashed rgba(59,130,246,0.4); background:transparent; color:#3b82f6; font-size:10px; border-radius:8px; cursor:pointer; text-align:center; margin-top:6px; transition:all .2s; }
.global-news-btn:hover { background:rgba(59,130,246,0.1); border-color:#3b82f6; }
.global-news-btn:disabled { opacity:0.5; cursor:not-allowed; }
/* Real-World Action Guide */
.action-guide { padding:12px 16px 6px; }
.action-guide-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.action-guide-header-right { display:flex; align-items:center; gap:8px; }
.action-guide-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.action-guide-brief { font-size:11px; font-weight:600; }
.action-guide-container { margin-top:8px; }
.ag-overview { background:linear-gradient(135deg,#1a1a2e,#16213e); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 12px rgba(22,33,62,0.25); }
.ag-score-row { display:flex; align-items:center; gap:14px; margin-bottom:10px; }
.ag-big-score { font-size:36px; font-weight:900; font-variant-numeric:tabular-nums; line-height:1; }
.ag-score-meta { flex:1; }
.ag-score-label { font-size:13px; font-weight:700; }
.ag-score-desc { font-size:10px; color:rgba(255,255,255,0.55); margin-top:2px; }
.ag-engines { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:10px; }
.ag-engine { background:rgba(255,255,255,0.06); border-radius:8px; padding:8px 6px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
.ag-engine-icon { font-size:16px; }
.ag-engine-name { font-size:8px; color:rgba(255,255,255,0.45); letter-spacing:0.3px; margin:2px 0; }
.ag-engine-vote { font-size:11px; font-weight:700; }
.ag-engine-conf { font-size:8px; color:rgba(255,255,255,0.4); margin-top:1px; }
.ag-advice-bar { background:rgba(255,255,255,0.08); border-radius:8px; padding:8px 12px; font-size:11px; line-height:1.5; }
.ag-advice-bar b { color:#fbbf24; }
.ag-fund-card { background:var(--card); border-radius:10px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); border-left:3px solid var(--border); transition:border-color .2s; }
.ag-fund-card.action-buy { border-left-color:var(--red); }
.ag-fund-card.action-sell { border-left-color:var(--green); }
.ag-fund-card.action-hold { border-left-color:var(--primary); }
.ag-fund-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
.ag-fund-name { font-size:13px; font-weight:700; }
.ag-fund-code { font-size:10px; color:var(--sub); }
.ag-fund-action { font-size:12px; font-weight:700; padding:2px 10px; border-radius:6px; }
.ag-fund-action.buy { background:var(--red-bg); color:var(--red); }
.ag-fund-action.sell { background:var(--green-bg); color:var(--green); }
.ag-fund-action.hold { background:var(--primary-bg); color:var(--primary); }
.ag-vote-strip { display:flex; gap:3px; margin-bottom:6px; }
.ag-vote-chip { font-size:8px; padding:1px 6px; border-radius:4px; font-weight:600; letter-spacing:0.2px; }
.ag-vote-chip.bullish { background:#fef2f2; color:#ef4444; }
.ag-vote-chip.bearish { background:#ecfdf5; color:#16a34a; }
.ag-vote-chip.neutral { background:#f8fafc; color:#94a3b8; }
.ag-reason { font-size:11px; color:#475569; line-height:1.5; margin-bottom:6px; }
.ag-metrics { display:flex; gap:4px; flex-wrap:wrap; }
.ag-metric { font-size:9px; padding:2px 6px; border-radius:4px; background:var(--bg); color:var(--sub); }
.ag-metric b { color:var(--text); font-weight:600; }
.ag-position-bar { margin-top:8px; }
.ag-pos-label { font-size:9px; color:var(--sub); display:flex; justify-content:space-between; margin-bottom:3px; }
.ag-pos-track { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; }
.ag-pos-fill { height:100%; border-radius:3px; transition:width .3s; }
.ag-summary { background:var(--card); border-radius:10px; padding:12px 14px; box-shadow:var(--shadow); border:1px dashed var(--border); }
.ag-summary-title { font-size:11px; font-weight:700; margin-bottom:6px; }
.ag-summary-text { font-size:11px; color:#475569; line-height:1.6; }
.ag-summary-text b { color:var(--text); }
.ag-disclaimer { font-size:9px; color:var(--sub); text-align:center; padding:6px 0; line-height:1.4; }

/* RL Brain Dashboard */
.rl-brain { padding:10px 16px 4px; }
.rl-brain-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.rl-brain-header-right { display:flex; align-items:center; gap:8px; }
.rl-brain-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.rl-brain-brief { font-size:11px; font-weight:600; }
.rl-brain-container { margin-top:8px; }
.rl-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.rl-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.rl-status { display:flex; align-items:center; gap:6px; margin-bottom:8px; }
.rl-status-dot { width:8px; height:8px; border-radius:50%; }
.rl-status-dot.active { background:#22c55e; animation:rlPulse 1.5s infinite; }
.rl-status-dot.idle { background:var(--sub); }
.rl-status-dot.training { background:#eab308; animation:rlPulse 0.5s infinite; }
.rl-status-text { font-size:10px; color:var(--sub); }
.rl-progress { width:100%; height:6px; background:var(--bg); border-radius:3px; overflow:hidden; margin:6px 0; }
.rl-progress-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,#3b82f6,#8b5cf6); transition:width .3s; }
.rl-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.rl-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.rl-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.rl-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.rl-chart { height:60px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.rl-train-btn { width:100%; padding:8px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:6px; }
.rl-train-btn.start { background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; }
.rl-train-btn.stop { background:#ef4444; color:white; }
.rl-train-btn:disabled { opacity:0.5; cursor:not-allowed; }
.rl-signal-row { display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom:1px solid var(--border); }
.rl-signal-row:last-child { border-bottom:none; }
.rl-signal-name { font-size:11px; flex:1; }
.rl-signal-action { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; }
.rl-signal-action.buy { background:rgba(239,68,68,0.1); color:var(--red); }
.rl-signal-action.sell { background:rgba(34,197,94,0.1); color:var(--green); }
.rl-signal-action.hold { background:rgba(148,163,184,0.1); color:var(--sub); }
.rl-signal-conf { font-size:10px; color:var(--sub); min-width:32px; text-align:right; }
.rl-qbar { display:flex; gap:2px; flex:1; }
.rl-qbar-seg { height:6px; border-radius:2px; min-width:2px; }
@keyframes rlPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
/* Backtest Dashboard */
.bt-section { padding:10px 16px 4px; }
.bt-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.bt-header-right { display:flex; align-items:center; gap:8px; }
.bt-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.bt-brief { font-size:11px; font-weight:600; }
.bt-container { margin-top:8px; }
.bt-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.bt-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.bt-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.bt-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.bt-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.bt-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.bt-chart { height:80px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.bt-trade-row { display:flex; align-items:center; gap:6px; padding:4px 0; border-bottom:1px solid var(--border); font-size:10px; }
.bt-trade-row:last-child { border-bottom:none; }
.bt-run-btn { width:100%; padding:8px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:6px; background:linear-gradient(135deg,#f59e0b,#ef4444); color:white; }
.bt-run-btn:disabled { opacity:0.5; cursor:not-allowed; }
.bt-kelly-bar { display:flex; height:16px; border-radius:4px; overflow:hidden; background:var(--bg); margin-top:4px; }
.bt-kelly-seg { height:100%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:white; transition:width .3s; }
.bt-dd-chart { height:50px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.bt-fund-row { display:flex; align-items:center; gap:6px; padding:5px 0; border-bottom:1px solid var(--border); }
.bt-fund-row:last-child { border-bottom:none; }
.bt-fund-name { font-size:11px; flex:1; }
.bt-fund-ret { font-size:11px; font-weight:700; min-width:50px; text-align:right; }
.bt-fund-sharpe { font-size:10px; color:var(--sub); min-width:40px; text-align:right; }
.bt-fund-mdd { font-size:10px; min-width:45px; text-align:right; }
.bt-fund-kelly { font-size:10px; font-weight:600; min-width:35px; text-align:right; }
/* Manage Panel */
.manage-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:300; }
.manage-panel { position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--bg); border-radius:20px 20px 0 0; max-height:88vh; display:flex; flex-direction:column; animation:slideUp .3s ease; }
@keyframes slideUp { from{transform:translateX(-50%) translateY(100%)} to{transform:translateX(-50%) translateY(0)} }
.manage-header { display:flex; align-items:center; padding:16px 16px 0; gap:8px; }
.manage-tabs { flex:1; display:flex; gap:0; background:var(--card); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); }
.manage-tab { flex:1; padding:10px 12px; text-align:center; font-size:13px; font-weight:600; cursor:pointer; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; background:transparent; }
.manage-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.manage-count { font-size:10px; font-weight:400; background:rgba(0,0,0,0.06); padding:1px 6px; border-radius:8px; margin-left:2px; }
.manage-close { background:none; border:none; font-size:20px; cursor:pointer; color:var(--sub); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-close:hover { background:var(--card); color:var(--text); }
.manage-toolbar { display:flex; gap:8px; padding:12px 16px 8px; align-items:center; }
.manage-search { flex:1; padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; outline:none; background:var(--card); transition:border-color .2s; }
.manage-search:focus { border-color:var(--primary); }
.manage-add-btn { padding:9px 16px; border:none; border-radius:10px; background:#1e293b; color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.manage-add-btn:hover { background:#334155; }
.manage-body { flex:1; overflow-y:auto; padding:4px 16px 20px; -webkit-overflow-scrolling:touch; }
.manage-empty { text-align:center; padding:48px 16px; color:var(--sub); }
.manage-empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.manage-empty-text { font-size:13px; margin-bottom:16px; }
.manage-fund { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.manage-fund:active { transform:scale(0.98); }
.manage-fund-top { display:flex; justify-content:space-between; align-items:flex-start; }
.manage-fund-info { flex:1; min-width:0; }
.manage-fund-name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.manage-fund-meta { font-size:10px; color:var(--sub); margin-top:3px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.manage-fund-type { padding:1px 6px; border-radius:4px; background:var(--primary-bg); color:var(--primary); font-size:9px; font-weight:500; }
.manage-fund-right { display:flex; align-items:center; gap:10px; }
.manage-fund-pct { font-size:18px; font-weight:800; font-variant-numeric:tabular-nums; min-width:65px; text-align:right; }
.manage-fund-nav { font-size:10px; color:var(--sub); text-align:right; margin-top:2px; }
.manage-fund-del { background:none; border:1px solid #e2e8f0; color:#94a3b8; cursor:pointer; font-size:12px; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-fund-del:hover { background:#fef2f2; border-color:#fca5a5; color:var(--red); }
.manage-fund-trend { display:flex; gap:8px; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:10px; flex-wrap:wrap; }
.manage-fund-trend span { display:flex; align-items:center; gap:2px; }
.manage-fund-actions { display:flex; gap:6px; margin-top:8px; }
.manage-action-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.manage-action-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.manage-action-btn.danger { color:var(--red); border-color:#fca5a5; }
.manage-action-btn.danger:hover { background:var(--red); color:white; border-color:var(--red); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <span class="header-title">üìä Âü∫ÈáëÂÜ≥Á≠ñÂä©Êâã</span>
    <div style="display:flex;gap:8px;align-items:center">
      <a href="manager-analysis.html" style="color:white;font-size:11px;opacity:0.8;text-decoration:none">TOP500</a>
      <button class="header-gear" onclick="openSettings()">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="market-status">
    <span class="status-dot" id="status-dot"></span>
    <span id="market-status-text">Ê£ÄÊµã‰∏≠...</span>
    <span class="countdown" id="countdown">--:--:--</span>
  </div>
</div>

<!-- Index Bar -->
<div class="idx-bar" id="idx-bar">
  <div class="idx-item"><div class="idx-name">‰∏äËØÅ</div><div class="idx-val" id="iv-sh">--</div><div class="idx-pct flat" id="ip-sh">--</div></div>
  <div class="idx-item"><div class="idx-name">Ê∑±ËØÅ</div><div class="idx-val" id="iv-sz">--</div><div class="idx-pct flat" id="ip-sz">--</div></div>
  <div class="idx-item"><div class="idx-name">Âàõ‰∏öÊùø</div><div class="idx-val" id="iv-cy">--</div><div class="idx-pct flat" id="ip-cy">--</div></div>
  <div class="idx-item"><div class="idx-name">Ê≤™Ê∑±300</div><div class="idx-val" id="iv-hs">--</div><div class="idx-pct flat" id="ip-hs">--</div></div>
</div>
<div class="idx-bar" id="idx-bar-2" style="padding-top:0;border-top:none">
  <div class="idx-item"><div class="idx-name">ü•á ÈªÑÈáëETF</div><div class="idx-val" id="iv-au">--</div><div class="idx-pct flat" id="ip-au">--</div></div>
  <div class="idx-item"><div class="idx-name">ü•à ÁôΩÈì∂LOF</div><div class="idx-val" id="iv-ag">--</div><div class="idx-pct flat" id="ip-ag">--</div></div>
  <div class="idx-item"><div class="idx-name">üî© ÊúâËâ≤ÈáëÂ±û</div><div class="idx-val" id="iv-ys">--</div><div class="idx-pct flat" id="ip-ys">--</div></div>
</div>

<!-- Stats Bar -->
<div class="stats-bar" id="stats-bar">
  <div class="stat-item">
    <div class="stat-label">‰ªäÊó•ÊåÅ‰ªìÁõà‰∫è</div>
    <div class="stat-value" id="stat-today">--</div>
    <div class="stat-sub" id="stat-bench-today"></div>
  </div>
  <div class="stat-item">
    <div class="stat-label">Ê≤™Ê∑±300‰ªäÊó•</div>
    <div class="stat-value" id="stat-hs300">--</div>
    <div class="stat-sub" id="stat-bench-label">Â§ßÁõòÂü∫ÂáÜ</div>
  </div>
</div>

<!-- Data Intelligence Dashboard -->
<div class="data-intel">
  <div class="section-title data-intel-header" onclick="toggleDataIntel()">
    <span>üì° Êï∞ÊçÆÊÉÖÊä•‰∏≠ÂøÉ <span style="font-size:10px;color:var(--sub);font-weight:400">ÂÆèËßÇ¬∑ËµÑÈáë¬∑ËàÜÊÉÖ</span></span>
    <div class="data-intel-header-right">
      <span id="data-intel-brief" class="data-intel-brief" style="color:var(--sub)">Âä†ËΩΩ‰∏≠...</span>
      <span class="data-intel-toggle" id="data-intel-toggle">‚ñ∂</span>
    </div>
  </div>
  <div id="data-intel-container" class="data-intel-container" style="display:none"></div>
</div>

<!-- RL Brain Dashboard -->
<div class="rl-brain">
  <div class="section-title rl-brain-header" onclick="toggleRLBrain()">
    <span>üß† RLÂº∫ÂåñÂ≠¶‰π†Â§ßËÑë <span style="font-size:10px;color:var(--sub);font-weight:400">DQN ¬∑ Double Q ¬∑ Adam</span></span>
    <div class="rl-brain-header-right">
      <span id="rl-brain-brief" class="rl-brain-brief" style="color:var(--sub)">Êú™ËÆ≠ÁªÉ</span>
      <span class="rl-brain-toggle" id="rl-brain-toggle">‚ñ∂</span>
    </div>
  </div>
  <div id="rl-brain-container" class="rl-brain-container" style="display:none"></div>
</div>

<!-- Backtest Dashboard -->
<div class="bt-section">
  <div class="section-title bt-header" onclick="toggleBacktest()">
    <span>üìà ÂõûÊµãÂºïÊìé <span style="font-size:10px;color:var(--sub);font-weight:400">RSIÁ≠ñÁï• ¬∑ Kelly‰ªì‰Ωç ¬∑ Sharpe</span></span>
    <div class="bt-header-right">
      <span id="bt-brief" class="bt-brief" style="color:var(--sub)">Êú™ÂõûÊµã</span>
      <span class="bt-toggle" id="bt-toggle">‚ñ∂</span>
    </div>
  </div>
  <div id="bt-container" class="bt-container" style="display:none"></div>
</div>

<!-- Simulation Portfolio -->
<div class="sim-section">
  <div class="section-title sim-header" onclick="toggleSimDetail()">
    <span>ü§ñ AIÊ®°ÊãüÁõò <span style="font-size:10px;color:var(--sub);font-weight:400">50‰∏áÂª∫‰ªì ¬∑ AIËá™Âä®‰∫§Êòì</span></span>
    <div class="sim-header-right">
      <span id="sim-brief" style="font-size:12px;font-weight:700">--</span>
      <span class="sim-toggle-icon" id="sim-toggle-icon">‚ñº</span>
    </div>
  </div>
  <div id="sim-container"></div>
</div>

<!-- Real-World Action Guide -->
<div class="action-guide">
  <div class="section-title action-guide-header" onclick="toggleActionGuide()">
    <span>üéØ ÂÆûÁõòË°åÂä®ÊåáÂçó <span style="font-size:10px;color:var(--sub);font-weight:400">‰∏âÂºïÊìéÂÖ±ËØÜ ¬∑ ÂÆûÊìçÂª∫ËÆÆ</span></span>
    <div class="action-guide-header-right">
      <span id="action-guide-brief" class="action-guide-brief" style="color:var(--sub)">Á≠âÂæÖÂàÜÊûê</span>
      <span class="action-guide-toggle" id="action-guide-toggle">‚ñº</span>
    </div>
  </div>
  <div id="action-guide-container" class="action-guide-container"></div>
</div>

<!-- Portfolio Section -->
<div class="pf-section">
  <div class="section-title">üíº Ê≥¢ÊÆµÁªÑÂêà <span style="font-size:10px;color:var(--sub);font-weight:400">ÂÆûÊó∂Ë∂ãÂäø ¬∑ Ê≥¢ÊÆµ‰ø°Âè∑</span></div>
  <div class="pf-tabs">
    <div class="pf-tab active" onclick="switchPfTab('core')" id="pf-tab-core">üõ°Ô∏è Ê†∏ÂøÉ‰ªì<span class="pf-tab-ratio">Âª∫ËÆÆ60%</span></div>
    <div class="pf-tab" onclick="switchPfTab('satellite')" id="pf-tab-sat">üöÄ Âç´Êòü‰ªì<span class="pf-tab-ratio">Âª∫ËÆÆ40%</span></div>
  </div>
  <div class="pf-group active" id="pf-group-core"></div>
  <div class="pf-group" id="pf-group-satellite"></div>
</div>

<!-- AI Button -->
<div class="ai-btn-wrap">
  <button class="ai-btn" id="ai-btn" onclick="triggerAI()">
    üß† ‰∏ÄÈîÆAIÂàÜÊûê ¬∑ 4ÂºïÊìéÁ†îÂà§
  </button>
  <div class="ai-progress" id="ai-progress"></div>
</div>

<!-- Market Summary (AI generated) -->
<div class="section" id="market-summary-section" style="display:none">
  <div id="market-summary"></div>
</div>

<!-- Daily Review -->
<div class="review-section" id="review-section" style="display:none">
  <div class="section-title">üìù ÊØèÊó•Â§çÁõò <span style="font-size:10px;color:var(--sub);font-weight:400">Êò®Êó•Âà§Êñ≠ vs ‰ªäÊó•ÁªìÊûú</span></div>
  <div id="review-container"></div>
  <div class="review-history-toggle" id="review-history-toggle" style="display:none">
    <span class="review-toggle" onclick="toggleReviewHistory()">üìã Êü•ÁúãÂéÜÂè≤Â§çÁõòËÆ∞ÂΩï</span>
  </div>
  <div id="review-history" style="display:none"></div>
</div>

<!-- Action Signals -->
<div class="section">
  <div class="section-title">üìã ‰ªäÊó•Êìç‰Ωú‰ø°Âè∑ <span class="section-badge" id="signal-badge">Á≠âÂæÖÂàÜÊûê</span></div>
  <div id="signals-container">
    <div class="empty"><div class="empty-icon">üì•</div>Ê∑ªÂä†ÊåÅ‰ªìÂêéÔºåAI‰ºöÁªôÂá∫‰ªäÊó•Êìç‰ΩúÂª∫ËÆÆ</div>
  </div>
</div>

<!-- Watchlist Signals -->
<div class="section" id="watchlist-section" style="display:none">
  <div class="section-title">üëÅ Ëá™ÈÄâËßÇÂØü</div>
  <div id="watchlist-container"></div>
</div>

<!-- AI Recommendations -->
<div class="section" id="reco-section" style="display:none">
  <div class="section-title">üéØ AIÊé®ËçêÂÖ≥Ê≥® <span style="font-size:10px;color:var(--sub);font-weight:400">3ÊúàÁ®≥ÂÅ•Â¢ûÈïøËßÜËßí</span></div>
  <div id="reco-container"></div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <button class="bottom-btn primary" onclick="openManagePanel('holding')">üíº ÊåÅ‰ªìÁÆ°ÁêÜ</button>
  <button class="bottom-btn secondary" onclick="openManagePanel('watch')">üëÅ Ëá™ÈÄâÁÆ°ÁêÜ</button>
</div>

<!-- Manage Panel (Full Screen Slide Up) -->
<div class="manage-overlay" id="manage-overlay" onclick="if(event.target===this)closeManagePanel()">
  <div class="manage-panel">
    <div class="manage-header">
      <div class="manage-tabs">
        <div class="manage-tab active" id="manage-tab-holding" onclick="switchManageTab('holding')">üíº ÊåÅ‰ªì <span class="manage-count" id="manage-holding-count">0</span></div>
        <div class="manage-tab" id="manage-tab-watch" onclick="switchManageTab('watch')">üëÅ Ëá™ÈÄâ <span class="manage-count" id="manage-watch-count">0</span></div>
      </div>
      <button class="manage-close" onclick="closeManagePanel()">‚úï</button>
    </div>
    <div class="manage-toolbar">
      <input type="text" class="manage-search" id="manage-search" placeholder="üîç ÊêúÁ¥¢Âü∫Èáë‰ª£Á†ÅÊàñÂêçÁß∞..." oninput="renderManageList()">
      <button class="manage-add-btn" onclick="openAddModal(_manageTab)">+ Ê∑ªÂä†</button>
    </div>
    <div class="manage-body" id="manage-body"></div>
  </div>
</div>

<!-- Add Fund Modal -->
<div class="modal-overlay" id="add-modal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal">
    <h3 id="add-modal-title">Ê∑ªÂä†ÊåÅ‰ªì <button onclick="closeAddModal()">‚úï</button></h3>
    <!-- ÊêúÁ¥¢Âå∫ -->
    <div id="add-search-area">
      <div class="fund-search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="add-search-input" placeholder="ËæìÂÖ•Âü∫Èáë‰ª£Á†ÅÊàñÂêçÁß∞ÊêúÁ¥¢..." oninput="onFundSearchInput()" autocomplete="off">
      </div>
      <div class="fund-search-results" id="add-search-results"></div>
      <div id="add-search-hint" class="fund-search-hint">ËæìÂÖ•Âü∫Èáë‰ª£Á†ÅÔºàÂ¶Ç 000216ÔºâÊàñÂÖ≥ÈîÆËØçÔºàÂ¶Ç„ÄåÈªÑÈáë„ÄçÔºâÊêúÁ¥¢</div>
    </div>
    <!-- Â∑≤ÈÄâ‰∏≠Âå∫ -->
    <div id="add-selected-area" style="display:none">
      <div class="fund-selected-card">
        <span class="sel-code" id="add-sel-code"></span>
        <span class="sel-name" id="add-sel-name"></span>
        <button class="sel-clear" onclick="clearFundSelection()" title="ÈáçÊñ∞ÈÄâÊã©">‚úï</button>
      </div>
      <div class="form-row" id="add-type-row"><label>Á±ªÂûã</label>
        <select id="add-type"><option value="ÂÆΩÂü∫">ÂÆΩÂü∫</option><option value="AI/ÁßëÊäÄ">AI/ÁßëÊäÄ</option><option value="ÈªÑÈáë">ÈªÑÈáë</option><option value="Á∫¢Âà©">Á∫¢Âà©</option><option value="ÂÜõÂ∑•">ÂÜõÂ∑•</option><option value="Êñ∞ËÉΩÊ∫ê">Êñ∞ËÉΩÊ∫ê</option><option value="Ê∂àË¥π">Ê∂àË¥π</option><option value="ÂåªËçØ">ÂåªËçØ</option><option value="ÂçäÂØº‰Ωì">ÂçäÂØº‰Ωì</option><option value="ÊúâËâ≤ÈáëÂ±û">ÊúâËâ≤ÈáëÂ±û</option><option value="QDII">QDII</option><option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option></select>
      </div>
      <button class="form-btn" onclick="confirmAdd()">Á°ÆËÆ§Ê∑ªÂä†</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="max-width:360px">
    <h3>‚öôÔ∏è ËÆæÁΩÆ <button onclick="closeSettings()">‚úï</button></h3>
    <div style="padding:6px 0">
      <div style="font-size:11px;font-weight:600;margin-bottom:8px">üåê AIÊúçÂä°ÂïÜ</div>
      <div id="provider-list"></div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 6px">API Key</div>
      <div class="form-row">
        <input type="password" id="input-key" placeholder="ËæìÂÖ•API Key" style="width:100%;font-size:12px">
      </div>
      <div id="provider-hint" style="font-size:10px;color:var(--sub);margin:-6px 0 10px"></div>
      <div style="font-size:11px;font-weight:600;margin:12px 0 6px">AIÂºïÊìéÊ®°ÂûãÔºö</div>
      <div id="engine-list" style="font-size:11px"></div>
      <button class="form-btn" onclick="saveSettings()" style="margin-top:14px">‰øùÂ≠òËÆæÁΩÆ</button>
      <div style="text-align:center;margin-top:8px">
        <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="toggleKeyVis()">ÊòæÁ§∫/ÈöêËóèKey</span>
        <span style="font-size:10px;color:var(--sub);margin-left:12px;cursor:pointer;text-decoration:underline" onclick="clearAllData()">Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ</span>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== FUND DATABASE ====================
const FUND_DB = [
  {code:'000216',name:'ÂçéÂÆâÈªÑÈáëETFËÅîÊé•A',type:'ÈªÑÈáë',baseNav:1.38},
  {code:'012414',name:'ÂçéÂ§è‰∏≠ËØÅA500ETFËÅîÊé•A',type:'ÂÆΩÂü∫',baseNav:1.25},
  {code:'011852',name:'Â§©Âºò‰∏≠ËØÅ‰∫ëËÆ°ÁÆó‰∏éÂ§ßÊï∞ÊçÆETFËÅîÊé•A',type:'AI/ÁßëÊäÄ',baseNav:0.91},
  {code:'004814',name:'‰∏≠Ê¨ßÁ∫¢Âà©‰ºò‰∫´Ê∑∑ÂêàA',type:'Á∫¢Âà©',baseNav:1.48},
  {code:'257070',name:'ÂõΩÊ≥∞‰∏≠ËØÅÂÜõÂ∑•ETFËÅîÊé•A',type:'ÂÜõÂ∑•',baseNav:1.12},
  {code:'003834',name:'ÂçéÂ§èËÉΩÊ∫êÈù©Êñ∞ËÇ°Á•®A',type:'Êñ∞ËÉΩÊ∫ê',baseNav:1.65},
  {code:'161725',name:'ÊãõÂïÜ‰∏≠ËØÅÁôΩÈÖíÊåáÊï∞A',type:'ÁôΩÈÖí/Ê∂àË¥π',baseNav:1.28},
  {code:'110011',name:'ÊòìÊñπËææ‰∏≠Â∞èÁõòÊ∑∑Âêà',type:'‰∏≠Â∞èÁõò',baseNav:5.52},
  {code:'005827',name:'ÊòìÊñπËææËìùÁ≠πÁ≤æÈÄâÊ∑∑Âêà',type:'ËìùÁ≠π',baseNav:2.05},
  {code:'001156',name:'Áî≥‰∏áËè±‰ø°‰∏≠ËØÅÂçäÂØº‰ΩìÊåáÊï∞A',type:'ÂçäÂØº‰Ωì',baseNav:1.18},
  {code:'320007',name:'ËØ∫ÂÆâÊàêÈïøÊ∑∑Âêà',type:'ÂçäÂØº‰Ωì/ÁßëÊäÄ',baseNav:1.42},
  {code:'160119',name:'ÂçóÊñπ‰∏≠ËØÅ500ETFËÅîÊé•A',type:'ÂÆΩÂü∫',baseNav:1.55},
];

// Êé®ËçêÁªÑÂêàÔºöÊ†∏ÂøÉ‰ªì(Á®≥ÂÅ•ÈïøÊåÅ) + Âç´Êòü‰ªì(Ê≥¢ÊÆµËøõÊîª)
const MODEL_PORTFOLIO = {
  core: {
    label:'üõ°Ô∏è Ê†∏ÂøÉ‰ªì', ratio:'60%',
    desc:'ÂéãËà±Áü≥ÈÖçÁΩÆÔºåÈïøÊúüÊåÅÊúâ‰∏∫‰∏ªÔºåËøΩÊ±ÇÁ®≥ÂÅ•Êî∂Áõä„ÄÇÂÆΩÂü∫+ÈªÑÈáë+Á∫¢Âà©‰∏âËßíÁªÑÂêàÔºå‰ΩéÁõ∏ÂÖ≥ÊÄßÂàÜÊï£È£éÈô©„ÄÇ',
    funds: [
      {code:'012414',name:'ÂçéÂ§è‰∏≠ËØÅA500ETFËÅîÊé•A',type:'ÂÆΩÂü∫',alloc:'20%',reason:'AËÇ°Ê†∏ÂøÉ500ËµÑ‰∫ßÔºåÈïøÊúüÈÖçÁΩÆÂü∫Áü≥'},
      {code:'007339',name:'ÊòìÊñπËææÊ≤™Ê∑±300ETFËÅîÊé•C',type:'ÂÆΩÂü∫',alloc:'15%',reason:'Ê≤™Ê∑±300Ê†∏ÂøÉËìùÁ≠πÔºåË¥πÁéá‰ΩéÔºåÊµÅÂä®ÊÄßÂ•Ω'},
      {code:'000216',name:'ÂçéÂÆâÈªÑÈáëETFËÅîÊé•A',type:'ÈªÑÈáë',alloc:'15%',reason:'ÈÅøÈô©+ÊäóÈÄöËÉÄÔºå‰∏éËÇ°Â∏Ç‰ΩéÁõ∏ÂÖ≥ÔºåÂ§ÆË°åÊåÅÁª≠Ë¥≠Èáë'},
      {code:'012643',name:'Â§©ÂºòÁ∫¢Âà©‰ΩéÊ≥¢Âä®C',type:'Á∫¢Âà©',alloc:'10%',reason:'È´òËÇ°ÊÅØ‰ΩéÊ≥¢Âä®Ôºå‰∏ãË°å‰øùÊä§Âº∫ÔºåÁ®≥ÂÆöÂàÜÁ∫¢'},
    ]
  },
  satellite: {
    label:'üöÄ Âç´Êòü‰ªì', ratio:'40%',
    desc:'ÂºπÊÄßËøõÊîª‰ªì‰ΩçÔºåÁßØÊûÅÂÅöÊ≥¢ÊÆµ‚Äî‚ÄîÈÄ¢Ë∑å‰π∞ÂÖ•„ÄÅÈÄ¢Ê∂®Ê≠¢Áõà„ÄÇÂÖ≥Ê≥®Ë∂ãÂäøÂêë‰∏ä‰∏îÁü≠ÊúüÂõûË∞ÉÁöÑÂìÅÁßç„ÄÇ',
    funds: [
      {code:'014832',name:'Â§©Âºò‰∏≠ËØÅÊúâËâ≤ÈáëÂ±ûETFËÅîÊé•C',type:'ÊúâËâ≤ÈáëÂ±û',alloc:'10%',reason:'ÂÖ®ÁêÉÈìúÈìùÊ∂®‰ª∑+Êñ∞Âü∫Âª∫ÈúÄÊ±ÇÔºåÊ≥¢Âä®Â§ßÊ≥¢ÊÆµÁ©∫Èó¥Ë∂≥'},
      {code:'015047',name:'ÂπøÂèë‰∫∫Â∑•Êô∫ËÉΩETFËÅîÊé•C',type:'AI/ÁßëÊäÄ',alloc:'8%',reason:'AI‰∫ß‰∏öÁàÜÂèëÔºåÁÆóÂäõÈúÄÊ±ÇÊó∫ÁõõÔºåÊàêÈïøÊÄßÂº∫'},
      {code:'001156',name:'Áî≥‰∏áËè±‰ø°‰∏≠ËØÅÂçäÂØº‰ΩìÊåáÊï∞A',type:'ÂçäÂØº‰Ωì',alloc:'8%',reason:'ÂõΩ‰∫ßÊõø‰ª£ÈÄªËæëÁ°¨Ôºå‰º∞ÂÄºÂºπÊÄßÂ§ß'},
      {code:'257070',name:'ÂõΩÊ≥∞‰∏≠ËØÅÂÜõÂ∑•ETFËÅîÊé•A',type:'ÂÜõÂ∑•',alloc:'7%',reason:'Âú∞ÁºòÂÇ¨Âåñ+Ë£ÖÂ§áÈááË¥≠Âë®ÊúüÔºå‰∫ã‰ª∂È©±Âä®ÂûãÊ≥¢ÊÆµ'},
      {code:'013308',name:'ÊòìÊñπËææ‰∏≠ËØÅÂÖ®ÊåáËØÅÂà∏ÂÖ¨Âè∏C',type:'ÈáëËûç',alloc:'7%',reason:'ÁâõÂ∏ÇÂÖàÈîãÔºåÊîøÁ≠ñÂèóÁõäÂºπÊÄßÂìÅÁßçÔºåŒ≤Â±ûÊÄßÂº∫'},
    ]
  }
};

const RECO_FUND_POOL = [
  {code:'002610',name:'ÂçöÊó∂ÈªÑÈáëETFËÅîÊé•C',type:'ÈªÑÈáë',tags:['ÈÅøÈô©','Ë¥µÈáëÂ±û']},
  {code:'007929',name:'ÂçéÂÆâÈªÑÈáëETFËÅîÊé•C',type:'ÈªÑÈáë',tags:['ÈÅøÈô©','ÈªÑÈáë']},
  {code:'015047',name:'ÂπøÂèë‰∫∫Â∑•Êô∫ËÉΩETFËÅîÊé•C',type:'AI/ÁßëÊäÄ',tags:['AI','‰∫ß‰∏öË∂ãÂäø']},
  {code:'017992',name:'ÊòìÊñπËææ‰∏≠ËØÅ‰∫∫Â∑•Êô∫ËÉΩETFËÅîÊé•C',type:'AI/ÁßëÊäÄ',tags:['AI','ÁÆóÂäõ']},
  {code:'014557',name:'‰∏áÂÆ∂‰∏≠ËØÅËäØÁâá‰∫ß‰∏öÊåáÊï∞C',type:'ÂçäÂØº‰Ωì',tags:['ËäØÁâá','ÂõΩ‰∫ßÊõø‰ª£']},
  {code:'013313',name:'ÂçéÂÆù‰∏≠ËØÅÁßëÊäÄÈæôÂ§¥ETFËÅîÊé•C',type:'ÁßëÊäÄ',tags:['ÁßëÊäÄÈæôÂ§¥','Á°¨ÁßëÊäÄ']},
  {code:'012860',name:'ÈïøÂüéÂÜõÂ∑•ÊàêÈïøETFËÅîÊé•C',type:'ÂÜõÂ∑•',tags:['ÂõΩÈò≤ÂÜõÂ∑•','ÊàòÁï•']},
  {code:'013010',name:'Â§©Âºò‰∏≠ËØÅÊñ∞ËÉΩÊ∫êËΩ¶ETFËÅîÊé•C',type:'Êñ∞ËÉΩÊ∫ê',tags:['Êñ∞ËÉΩÊ∫êËΩ¶','ÁîµÊ±†']},
  {code:'012762',name:'Â§©Âºò‰∏≠ËØÅÈ£üÂìÅÈ•ÆÊñôETFËÅîÊé•C',type:'Ê∂àË¥π',tags:['È£üÂìÅÈ•ÆÊñô','ÂÜÖÈúÄ']},
  {code:'001550',name:'Â§©Âºò‰∏≠ËØÅÂåªËçØ100A',type:'ÂåªËçØ',tags:['ÂåªËçØ','ÂàõÊñ∞ËçØ']},
  {code:'012643',name:'Â§©ÂºòÁ∫¢Âà©‰ΩéÊ≥¢Âä®C',type:'Á∫¢Âà©',tags:['Á∫¢Âà©','‰ΩéÊ≥¢Âä®']},
  {code:'012070',name:'‰∏áÂÆ∂‰∏≠ËØÅÁ∫¢Âà©ETFËÅîÊé•C',type:'Á∫¢Âà©',tags:['È´òËÇ°ÊÅØ','Á®≥ÂÅ•']},
  {code:'007339',name:'ÊòìÊñπËææÊ≤™Ê∑±300ETFËÅîÊé•C',type:'ÂÆΩÂü∫',tags:['Ê≤™Ê∑±300','Ê†∏ÂøÉËµÑ‰∫ß']},
  {code:'006881',name:'Â§©ÂºòÂàõ‰∏öÊùøETFËÅîÊé•C',type:'ÂÆΩÂü∫',tags:['Âàõ‰∏öÊùø','ÊàêÈïø']},
  {code:'013601',name:'ÂçéÂÆâ‰∏≠ËØÅA500ETFËÅîÊé•C',type:'ÂÆΩÂü∫',tags:['A500','Ê†∏ÂøÉ']},
  {code:'014832',name:'Â§©Âºò‰∏≠ËØÅÊúâËâ≤ÈáëÂ±ûETFËÅîÊé•C',type:'ÊúâËâ≤ÈáëÂ±û',tags:['ÊúâËâ≤','ÈìúÈìù']},
  {code:'013308',name:'ÊòìÊñπËææ‰∏≠ËØÅÂÖ®ÊåáËØÅÂà∏ÂÖ¨Âè∏C',type:'ÈáëËûç',tags:['Âà∏ÂïÜ','ÊîøÁ≠ñÂèóÁõä']},
];

const INDICES_CONFIG = [
  {name:'‰∏äËØÅ',secid:'1.000001',group:'stock'},
  {name:'Ê∑±Êàê',secid:'0.399001',group:'stock'},
  {name:'Âàõ‰∏öÊùø',secid:'0.399006',group:'stock'},
  {name:'Ê≤™Ê∑±300',secid:'1.000300',group:'benchmark'},
  {name:'ÈªÑÈáëETF',secid:'1.518880',group:'commodity'},
  {name:'ÁôΩÈì∂LOF',secid:'0.161226',group:'commodity'},
  {name:'ÊúâËâ≤ÈáëÂ±û',secid:'1.000819',group:'commodity'},
];

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'Á°ÖÂü∫ÊµÅÂä®(ÂÖçË¥π)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    desc:'ÂÖçË¥πÂºÄÊ∫êÊ®°ÂûãÔºåÊ≥®ÂÜåÂç≥Áî®',
    link:'https://cloud.siliconflow.cn',
    models: [
      {id:'engine1', name:'DeepSeek-V3', icon:'ü´ò', role:'ÊäÄÊúØÂàÜÊûê+ÈáèÂåñÂõ†Â≠ê', model:'deepseek-ai/DeepSeek-V3'},
      {id:'engine2', name:'Qwen2.5-72B', icon:'üîÆ', role:'ÂÆèËßÇÁªèÊµé+ÊîøÁ≠ñÈù¢', model:'Qwen/Qwen2.5-72B-Instruct'},
      {id:'engine3', name:'DeepSeek-R1-32B', icon:'üîç', role:'Ê∑±Â∫¶Âü∫Êú¨Èù¢+Ë°å‰∏öÁ†îÁ©∂', model:'deepseek-ai/DeepSeek-R1-Distill-Qwen-32B'},
      {id:'engine4', name:'Gemma-2-27B', icon:'‚ôä', role:'ÂÖ®ÁêÉËßÜËßí+È£éÈô©ËØÑ‰º∞', model:'google/gemma-2-27b-it'},
    ]
  },
  {
    id:'deepseek', name:'DeepSeekÂÆòÊñπ(ÊûÅ‰Ωé‰ª∑)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    desc:'¬•1/Áôæ‰∏átokenÔºåÂá†‰πéÂÖçË¥π',
    link:'https://platform.deepseek.com',
    models: [
      {id:'engine1', name:'DeepSeek-V3‚ë†', icon:'ü´ò', role:'ÊäÄÊúØÂàÜÊûê+ÈáèÂåñÂõ†Â≠ê', model:'deepseek-chat'},
      {id:'engine2', name:'DeepSeek-V3‚ë°', icon:'üîÆ', role:'ÂÆèËßÇÁªèÊµé+ÊîøÁ≠ñÈù¢', model:'deepseek-chat'},
      {id:'engine3', name:'DeepSeek-R1', icon:'üîç', role:'Ê∑±Â∫¶Âü∫Êú¨Èù¢+Ë°å‰∏öÁ†îÁ©∂', model:'deepseek-reasoner'},
      {id:'engine4', name:'DeepSeek-V3‚ë¢', icon:'‚ôä', role:'ÂÖ®ÁêÉËßÜËßí+È£éÈô©ËØÑ‰º∞', model:'deepseek-chat'},
    ]
  },
  {
    id:'302ai', name:'302.AI(‰ªòË¥π)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    desc:'ËÅöÂêàÂπ≥Âè∞ÔºåÊîØÊåÅÂ§öÁßçÊ®°Âûã',
    link:'https://302.ai',
    models: [
      {id:'engine1', name:'Ë±ÜÂåÖ', icon:'ü´ò', role:'ÊäÄÊúØÂàÜÊûê+ÈáèÂåñÂõ†Â≠ê', model:'doubao-1.5-pro-32k'},
      {id:'engine2', name:'ÈÄö‰πâÂçÉÈóÆ', icon:'üîÆ', role:'ÂÆèËßÇÁªèÊµé+ÊîøÁ≠ñÈù¢', model:'qwen3-235b-a22b'},
      {id:'engine3', name:'DeepSeek', icon:'üîç', role:'Ê∑±Â∫¶Âü∫Êú¨Èù¢+Ë°å‰∏öÁ†îÁ©∂', model:'deepseek-r1'},
      {id:'engine4', name:'Gemini', icon:'‚ôä', role:'ÂÖ®ÁêÉËßÜËßí+È£éÈô©ËØÑ‰º∞', model:'gemini-2.5-flash'},
    ]
  }
];

let _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
let _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
let AI_ENGINES = _aiProvider.models;
let _apiBase = _aiProvider.base;

// ==================== STATE ====================
let holdings = JSON.parse(localStorage.getItem('fa_holdings')||'[]');
let watchlist = JSON.parse(localStorage.getItem('fa_watchlist')||'[]');
let liveIndices = {};
let liveFundData = {};
let liveSectors = [];
let fundHistoryData = {}; // { code: { navs: [{date,nav}], trend:{} } }
let _aiKey = localStorage.getItem('fa_302ai_key') || '';
let _analyzing = false;
let _analysisResult = null;
let _addMode = 'holding';
let _refreshTimer = null;
let _countdownTimer = null;
let dailyLog = JSON.parse(localStorage.getItem('fa_daily_log')||'[]'); // [{date, predictions:{code:{action,confidence,trend,reason}}, pnl:{code:pct}, avgPnl, hs300Pct}]
let simPortfolio = JSON.parse(localStorage.getItem('fa_sim_portfolio')||'null');
const SIM_INITIAL_CAPITAL = 500000;
const SIM_TARGET_MONTHLY = 10000;
const SIM_FEE_RATE = 0.0015;

// ==================== DATA INTELLIGENCE STATE ====================
let macroData = { cpi:null, ppi:null, pmi:null, gdp:null, m2:null }; // ÂÆèËßÇÁªèÊµéÊï∞ÊçÆ
let sectorCapFlow = []; // ÊùøÂùóËµÑÈáëÊµÅÂêë
let newsHeadlines = []; // Ë¥¢ÁªèÊñ∞Èóª
let newsSentiment = { score:50, label:'‰∏≠ÊÄß', bullCount:0, bearCount:0 }; // ËàÜÊÉÖÁªºÂêàÂæóÂàÜ0-100
let globalNews = []; // ÂõΩÈôÖÊñ∞ÈóªËÅöÂêà
let globalNewsSummary = null; // AIÂõΩÈôÖÊñ∞ÈóªÊëòË¶Å { summary, impact, sentiment }
let _globalNewsLoading = false;
let _dataIntelLoaded = false;

// ==================== RL BRAIN STATE ====================
let rlAgent = null;
let rlTrainer = null;
let _rlModelLoaded = false;
let _rlTraining = false;
let _rlSignals = {}; // { code: { action, actionName, confidence, qValues } }
const RL_STATE_SIZE = 18; // 15‚Üí18: +backtestSharpe +backtestKelly +backtestRSI
const RL_ACTION_SIZE = 3; // 0=hold, 1=buy, 2=sell
const RL_ACTION_NAMES = ['ÊåÅÊúâ','‰π∞ÂÖ•','ÂçñÂá∫'];
const RL_STORAGE_KEY = 'fa_rl_brain';

// ==================== BACKTEST STATE ====================
let btResults = {}; // { code: { totalReturn, sharpe, maxDD, kellyFraction, winRate, trades, equity, drawdown } }
let btSummary = null;
let _btRunning = false;
const BT_STORAGE_KEY = 'fa_backtest';
const BT_FEE = 0.0015; // ÂçïËæπÊâãÁª≠Ë¥π
const BT_RSI_PERIOD = 14;
const BT_RSI_BUY = 70; // RSI<70Êó∂ÂÖÅËÆ∏‰π∞ÂÖ•
const BT_RSI_SELL = 75; // RSI>75ËÄÉËôëÂçñÂá∫
const BT_MOMENTUM_BUY = 0.01; // È¢ÑÊµãÊ∂®ÂπÖ>1%‰π∞ÂÖ•
const BT_RISK_FREE = 0.025; // Âπ¥ÂåñÊó†È£éÈô©Âà©Áéá

function saveHoldings(){ localStorage.setItem('fa_holdings', JSON.stringify(holdings)); }
function saveWatchlist(){ localStorage.setItem('fa_watchlist', JSON.stringify(watchlist)); }
function saveKey(k){ _aiKey=k; localStorage.setItem('fa_302ai_key', k); }
function saveDailyLog(){ localStorage.setItem('fa_daily_log', JSON.stringify(dailyLog.slice(-30))); } // ÊúÄÂ§ö‰øùÁïô30Â§©
function saveProvider(id){
  _aiProviderId=id;
  _aiProvider=AI_PROVIDERS.find(p=>p.id===id)||AI_PROVIDERS[0];
  AI_ENGINES=_aiProvider.models;
  _apiBase=_aiProvider.base;
  localStorage.setItem('fa_ai_provider',id);
}

// ==================== UTILITIES ====================
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function sign(n){ return n>=0?'+':''; }
function fmt(n){ return (typeof n==='number')?n.toFixed(2):'--'; }
function seededRand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

// AËÇ°ËäÇÂÅáÊó•‰ºëÂ∏ÇÊó•ÂéÜ(YYYY-MM-DD)
const CN_HOLIDAYS_2025 = ['2025-01-01','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-03','2025-02-04','2025-04-04','2025-05-01','2025-05-02','2025-05-05','2025-06-02','2025-10-01','2025-10-02','2025-10-03','2025-10-06','2025-10-07','2025-10-08'];
const CN_HOLIDAYS_2026 = ['2026-01-01','2026-01-02','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-23','2026-02-24','2026-04-06','2026-05-01','2026-05-04','2026-05-05','2026-06-01','2026-10-01','2026-10-02','2026-10-05','2026-10-06','2026-10-07','2026-10-08'];
const CN_HOLIDAYS = new Set([...CN_HOLIDAYS_2025, ...CN_HOLIDAYS_2026]);
// ÈÉ®ÂàÜÂë®Êú´Ë∞É‰ºëË°•Áè≠Êó•
const CN_WORKDAYS = new Set(['2025-01-26','2025-02-08','2025-04-27','2025-09-28','2025-10-11','2026-02-14','2026-02-28','2026-10-10']);

function isTradingDay(dateStr){
  if(!dateStr) dateStr = todayStr();
  if(CN_HOLIDAYS.has(dateStr)) return false;
  if(CN_WORKDAYS.has(dateStr)) return true;
  const d = new Date(dateStr); const day = d.getDay();
  return day!==0 && day!==6;
}

function getMarketStatus(){
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const t = h*60+m;
  const today = todayStr();
  // ËäÇÂÅáÊó•
  if(CN_HOLIDAYS.has(today)) return {status:'closed', text:'ËäÇÂÅáÊó•‰ºëÂ∏Ç', countdown:null, isHoliday:true};
  // Âë®Êú´(ÈùûË°•Áè≠)
  if((day===0||day===6) && !CN_WORKDAYS.has(today)) return {status:'closed', text:'Âë®Êú´‰ºëÂ∏Ç', countdown:null};
  if(t<570) return {status:'pre', text:'Êú™ÂºÄÁõò', countdown:null};
  if(t>=570&&t<690) return {status:'open', text:'‰∫§Êòì‰∏≠¬∑‰∏äÂçà', countdown:900-t};
  if(t>=690&&t<780) return {status:'break', text:'ÂçàÈó¥‰ºëÂ∏Ç', countdown:900-t};
  if(t>=780&&t<900) return {status:'open', text:'‰∫§Êòì‰∏≠¬∑‰∏ãÂçà', countdown:900-t};
  return {status:'closed', text:'Â∑≤Êî∂Áõò', countdown:null};
}

function formatCountdown(mins){
  if(mins===null||mins<=0) return '00:00';
  const h = Math.floor(mins/60);
  const m = mins%60;
  const now = new Date();
  const s = 59 - now.getSeconds();
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ==================== JSONP ENGINE ====================
let _jcnt=0;
function jsonpFetch(url, opts={}){
  return new Promise((resolve, reject)=>{
    const cbName = opts.fixedCb || `_jp${++_jcnt}_${Date.now()}`;
    const timeout = opts.timeout || 8000;
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
    function cleanup(){ clearTimeout(timer); if(!opts.fixedCb) delete window[cbName]; try{script.remove();}catch(e){} }
    window[cbName] = function(data){ cleanup(); resolve(data); };
    let finalUrl = url;
    if(!opts.fixedCb) finalUrl += (url.includes('?')?'&':'?') + `cb=${cbName}`;
    finalUrl += (finalUrl.includes('?')?'&':'?') + `_t=${Date.now()}`;
    script.src = finalUrl;
    script.onerror = ()=>{ cleanup(); reject(new Error('network')); };
    document.head.appendChild(script);
  });
}

// ==================== DATA FETCHING ====================
async function fetchIndices(){
  try{
    const secids = INDICES_CONFIG.map(i=>i.secid).join(',');
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=${secids}&fields=f2,f3,f4,f12,f13,f14`);
    if(data?.data?.diff){
      data.data.diff.forEach(d=>{
        const key=`${d.f13}.${d.f12}`;
        if(d.f2!=='-'&&!isNaN(d.f2)) liveIndices[key]={name:d.f14,price:d.f2,pct:d.f3,change:d.f4};
      });
    }
  }catch(e){ console.error('fetchIndices:', e); }
}

async function fetchSectors(){
  try{
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=20&po=1&np=1&fltt=2&invt=2&fid=f3&fs=m:90+t:2&fields=f3,f14`);
    if(data?.data?.diff){
      liveSectors = data.data.diff.map(d=>({name:d.f14,pct:d.f3})).filter(d=>!isNaN(d.pct)).sort((a,b)=>b.pct-a.pct);
    }
  }catch(e){}
}

// fundgz API Âõ∫ÂÆöÂõûË∞ÉÂêç jsonpgzÔºå‰ΩÜÂìçÂ∫îÂåÖÂê´ fundcode Â≠óÊÆµÔºåÁî®‰∫éÂåπÈÖç
const _fundEstimateWaiters = {}; // code -> {resolve, reject, timer, cleanup}
async function fetchFundEstimate(code){
  return new Promise((resolve, reject)=>{
    // Â¶ÇÊûúÂ∑≤ÊúâËØ•‰ª£Á†ÅÁöÑËØ∑Ê±ÇÔºåÂÖàÊ∏ÖÁêÜ
    if(_fundEstimateWaiters[code]){
      clearTimeout(_fundEstimateWaiters[code].timer);
      _fundEstimateWaiters[code].reject(new Error('replaced'));
      delete _fundEstimateWaiters[code];
    }
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{
      cleanup();
      reject(new Error('timeout'));
    }, 8000);
    function cleanup(){
      clearTimeout(timer);
      delete _fundEstimateWaiters[code];
      try{ script.remove(); }catch(e){}
    }
    _fundEstimateWaiters[code] = { resolve, reject, timer, cleanup };
    script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
    script.onerror = ()=>{ cleanup(); reject(new Error('error')); };
    document.head.appendChild(script);
  });
}
// ÂÖ®Â±ÄÂõûË∞ÉÔºöÈÄöËøá fundcode ÂàÜÂèëÁªôÂØπÂ∫îÁöÑ waiter
window.jsonpgz = function(d){
  const code = d && d.fundcode;
  if(code && _fundEstimateWaiters[code]){
    const w = _fundEstimateWaiters[code];
    w.cleanup();
    w.resolve(d);
  }
};

function getAllPortfolioCodes(){
  const pCodes = [];
  MODEL_PORTFOLIO.core.funds.forEach(f=>pCodes.push(f.code));
  MODEL_PORTFOLIO.satellite.funds.forEach(f=>pCodes.push(f.code));
  // ÂåÖÂê´Ê®°ÊãüÁõòÊåÅ‰ªì‰ª£Á†ÅÔºåÁ°Æ‰øùËé∑ÂèñÁúüÂÆûÂ∏ÇÂú∫Êï∞ÊçÆ
  if(simPortfolio && simPortfolio.positions){
    simPortfolio.positions.forEach(p=>pCodes.push(p.code));
  }
  return [...new Set(pCodes)];
}

async function fetchAllFunds(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  // Âπ∂Ë°åËØ∑Ê±ÇÔºàÊØè‰∏™‰ª£Á†ÅÈÄöËøá fundcode Â≠óÊÆµÂàÜÂèëÔºå‰∏çÂÜ≤Á™ÅÔºâ
  // ÂàÜÊâπÔºöÊØèÊâπ5‰∏™ÔºåÈÅøÂÖçÊµèËßàÂô®Âπ∂ÂèëÈôêÂà∂
  for(let i=0; i<codes.length; i+=5){
    const batch = codes.slice(i, i+5);
    await Promise.allSettled(batch.map(async code=>{
      try{
        const d = await fetchFundEstimate(code);
        if(d?.gsz) liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name||'', gztime:d.gztime||'' };
      }catch(e){}
    }));
  }
}

// ==================== DATA INTELLIGENCE: MACRO + NEWS + SENTIMENT ====================
const MACRO_TOKEN = '894050c76af8597a853f5b408b759f5d';
const MACRO_BASE = 'https://datacenter.eastmoney.com/api/data/v1/get';

async function fetchMacroData(){
  const apis = [
    { key:'cpi', report:'RPT_ECONOMY_CPI', cols:'REPORT_DATE,TIME,NATIONAL_SAME,NATIONAL_SEQUENTIAL', sort:'REPORT_DATE', size:3 },
    { key:'ppi', report:'RPT_ECONOMY_PPI', cols:'REPORT_DATE,TIME,BASE_SAME,BASE_ACCUMULATE', sort:'REPORT_DATE', size:3 },
    { key:'pmi', report:'RPT_ECONOMY_PMI', cols:'REPORT_DATE,TIME,MAKE_INDEX,NMAKE_INDEX', sort:'REPORT_DATE', size:3 },
    { key:'gdp', report:'RPT_ECONOMY_GDP', cols:'REPORT_DATE,TIME,SUM_SAME,SECOND_SAME,THIRD_SAME', sort:'REPORT_DATE', size:2 },
    { key:'m2', report:'RPT_ECONOMY_CURRENCY_SUPPLY', cols:'REPORT_DATE,TIME,BASIC_CURRENCY,BASIC_CURRENCY_SAME,FREE_CASH_SAME', sort:'REPORT_DATE', size:3 },
  ];
  await Promise.allSettled(apis.map(async api=>{
    try{
      const url = `${MACRO_BASE}?reportName=${api.report}&columns=${api.cols}&pageSize=${api.size}&sortColumns=${api.sort}&sortTypes=-1&token=${MACRO_TOKEN}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if(json?.success && json?.result?.data){
        macroData[api.key] = json.result.data;
      }
    }catch(e){ console.warn('fetchMacro '+api.key+':', e); }
  }));
}

async function fetchSectorCapFlow(){
  try{
    // ÊùøÂùó‰∏ªÂäõËµÑÈáëÊµÅÂêë top10
    const data = await jsonpFetch('https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=10&po=1&np=1&fltt=2&invt=2&fid=f62&fs=m:90+t:2&fields=f12,f14,f62,f184,f66,f69,f72,f75');
    if(data?.data?.diff){
      sectorCapFlow = data.data.diff.map(d=>({
        name: d.f14,
        mainNet: d.f62,           // ‰∏ªÂäõÂáÄÊµÅÂÖ•(ÂÖÉ)
        mainNetPct: d.f184,       // ‰∏ªÂäõÂáÄÊµÅÂÖ•Âç†ÊØî%
        superBig: d.f66,          // Ë∂ÖÂ§ßÂçïÂáÄÊµÅÂÖ•
        big: d.f69,               // Â§ßÂçïÂáÄÊµÅÂÖ•
        mid: d.f72,               // ‰∏≠ÂçïÂáÄÊµÅÂÖ•
        small: d.f75,             // Â∞èÂçïÂáÄÊµÅÂÖ•
      })).filter(d=>d.mainNet && d.mainNet!=='-');
    }
  }catch(e){ console.warn('fetchSectorCapFlow:', e); }
}

async function fetchNewsHeadlines(){
  try{
    // Êñ∞Êµ™Ë¥¢ÁªèÊªöÂä®Êñ∞Èóª
    const data = await jsonpFetch('https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&k=&num=15&page=1');
    if(data?.result?.data){
      newsHeadlines = data.result.data.map(d=>({
        title: d.title || '',
        time: d.ctime ? new Date(d.ctime*1000).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) : '',
        url: d.url || '',
        category: d.category || '',
      })).filter(n=>n.title);
      analyzeNewsSentiment();
    }
  }catch(e){
    console.warn('fetchNews:', e);
    // Â§áÁî®: Â∞ùËØïÁõ¥Êé•fetch
    try{
      const resp = await fetch('https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&num=15&page=1');
      const data = await resp.json();
      if(data?.result?.data){
        newsHeadlines = data.result.data.map(d=>({
          title: d.title || '',
          time: d.ctime ? new Date(d.ctime*1000).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) : '',
          url: d.url || '',
        })).filter(n=>n.title);
        analyzeNewsSentiment();
      }
    }catch(e2){}
  }
}

function analyzeNewsSentiment(){
  // NLPÊÉÖÁª™ÂàÜÊûê: Âü∫‰∫éÂÖ≥ÈîÆËØçÁöÑË¥¢ÁªèÊñ∞ÈóªÊÉÖÁª™Âà§Êñ≠
  const bullWords = ['‰∏äÊ∂®','Â§ßÊ∂®','Ê∂®ÂÅú','È£ôÂçá','Êñ∞È´ò','Á™ÅÁ†¥','Âà©Â•Ω','Â¢ûÈïø','ÂõûÂçá','ÂõûÊöñ','ÂèçÂºπ','Â§çËãè','Ë∂ÖÈ¢ÑÊúü','‰πêËßÇ','Âä†ÈÄü','ÊîæÈáè','Âº∫Âäø','ÁâõÂ∏Ç','ÊèêÊåØ','Êâ©Âº†','ÁßØÊûÅ','Â•ΩËΩ¨','Ëµ∞È´ò','ÊîÄÂçá','‰∏äÊâ¨','Êö¥Ê∂®','ÊãâÂçá','ÂàõÊñ∞È´ò'];
  const bearWords = ['‰∏ãË∑å','Â§ßË∑å','Ë∑åÂÅú','Êö¥Ë∑å','Â¥©','Âà©Á©∫','‰∏ãÊªë','ËêéÁº©','‰ΩéËø∑','ÊÇ≤ËßÇ','Êî∂Á¥ß','Áº©Èáè','Âº±Âäø','ÁÜäÂ∏Ç','ÊÅ∂Âåñ','Ë°∞ÈÄÄ','‰∏ãË°å','Ëµ∞‰Ωé','ÂàõÊñ∞‰Ωé','Á†¥‰Ωç','ÊùÄË∑å','ÈáçÊå´','Êö¥Èõ∑','ÁàÜ‰ªì','È£éÈô©','Âç±Êú∫','Âà∂Ë£Å','Âä†ÊÅØ','ÈÄöËÉÄ','Á¥ßÁº©'];

  let bullCount = 0, bearCount = 0;
  newsHeadlines.forEach(n=>{
    const t = n.title;
    let bull = 0, bear = 0;
    bullWords.forEach(w=>{ if(t.includes(w)) bull++; });
    bearWords.forEach(w=>{ if(t.includes(w)) bear++; });
    if(bull > bear) { bullCount++; n.sentiment = 'bull'; }
    else if(bear > bull) { bearCount++; n.sentiment = 'bear'; }
    else { n.sentiment = 'neutral'; }
  });

  const total = newsHeadlines.length || 1;
  const score = Math.round(50 + (bullCount - bearCount) / total * 50);
  const clampedScore = Math.max(0, Math.min(100, score));
  let label = '‰∏≠ÊÄß';
  if(clampedScore >= 70) label = 'ÂÅè‰πêËßÇ';
  else if(clampedScore >= 80) label = 'Âæà‰πêËßÇ';
  else if(clampedScore <= 30) label = 'ÂÅèÊÇ≤ËßÇ';
  else if(clampedScore <= 20) label = 'ÂæàÊÇ≤ËßÇ';
  else if(clampedScore >= 55) label = 'Áï•ÂÅèÂ§ö';
  else if(clampedScore <= 45) label = 'Áï•ÂÅèÁ©∫';

  newsSentiment = { score:clampedScore, label, bullCount, bearCount, total };
}

// ==================== GLOBAL NEWS AGGREGATION ====================
// ËÅöÂêàÂõΩÈôÖÂçÅÂ§ßÊñ∞ÈóªÊ∫êÁöÑÊîøÊ≤ª/ÁªèÊµéÊñ∞ÈóªÔºåAIÊëòË¶Å+ÊäïËµÑÂΩ±ÂìçÂàÜÊûê
const GLOBAL_NEWS_SOURCES = [
  { id:'nyt-world', name:'NYT', label:'Á∫ΩÁ∫¶Êó∂Êä•', url:'https://rss.nytimes.com/services/xml/rss/nyt/World.xml' },
  { id:'nyt-biz', name:'NYT-Biz', label:'Á∫ΩÁ∫¶Êó∂Êä•¬∑ÂïÜ‰∏ö', url:'https://rss.nytimes.com/services/xml/rss/nyt/Business.xml' },
  { id:'nyt-pol', name:'NYT-Pol', label:'Á∫ΩÁ∫¶Êó∂Êä•¬∑ÊîøÊ≤ª', url:'https://rss.nytimes.com/services/xml/rss/nyt/Politics.xml' },
  { id:'wsj', name:'WSJ', label:'ÂçéÂ∞îË°óÊó•Êä•', url:'https://feeds.a.dj.com/rss/RSSWorldNews.xml' },
  { id:'bbc-world', name:'BBC', label:'BBC World', url:'https://feeds.bbci.co.uk/news/world/rss.xml' },
  { id:'bbc-biz', name:'BBC-Biz', label:'BBC Business', url:'https://feeds.bbci.co.uk/news/business/rss.xml' },
  { id:'guardian', name:'Guardian', label:'Âç´Êä•', url:'https://www.theguardian.com/world/rss' },
  { id:'cnbc', name:'CNBC', label:'CNBC', url:'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114' },
  { id:'cnn', name:'CNN', label:'CNN', url:'http://rss.cnn.com/rss/edition_world.rss' },
  { id:'ft', name:'FT', label:'ÈáëËûçÊó∂Êä•', url:'https://www.ft.com/rss/home' },
];

const GLOBAL_NEWS_KEYWORDS = /politic|econom|trade|tariff|sanctions?|central.bank|interest.rate|inflation|gdp|recession|federal.reserve|treasury|fiscal|monetary|geopolitic|war|conflict|election|government|tax|debt|deficit|market|stock|bond|currency|oil|energy|china|ukraine|russia|nato|eu\b|trump|biden|congress|parliament|summit|g7|g20|imf|world.bank|fed\b|ecb|boj|pboc|opec/i;

async function fetchGlobalNews(){
  _globalNewsLoading = true;
  const allItems = [];
  const rss2jsonBase = 'https://api.rss2json.com/v1/api.json?rss_url=';

  // Âπ∂Ë°åÊãâÂèñÊâÄÊúâRSSÊ∫ê
  const fetches = GLOBAL_NEWS_SOURCES.map(async src => {
    try {
      const resp = await fetch(rss2jsonBase + encodeURIComponent(src.url), { signal: AbortSignal.timeout(10000) });
      const data = await resp.json();
      if(data.status === 'ok' && data.items){
        return data.items.map(item => ({
          title: (item.title||'').replace(/<[^>]+>/g,'').trim(),
          description: (item.description||'').replace(/<[^>]+>/g,'').trim().slice(0,200),
          url: item.link || '',
          time: item.pubDate || '',
          source: src.name,
          sourceLabel: src.label,
          categories: (item.categories||[]).join(', '),
        }));
      }
    } catch(e) { console.warn(`fetchGlobalNews[${src.id}]:`, e); }
    return [];
  });

  const results = await Promise.allSettled(fetches);
  results.forEach(r => {
    if(r.status==='fulfilled' && r.value) allItems.push(...r.value);
  });

  // ËøáÊª§: Âè™‰øùÁïôÊîøÊ≤ª/ÁªèÊµéÁõ∏ÂÖ≥Êñ∞Èóª
  const filtered = allItems.filter(item => {
    const text = `${item.title} ${item.description} ${item.categories}`;
    return GLOBAL_NEWS_KEYWORDS.test(text);
  });

  // ÊåâÊó∂Èó¥ÊéíÂ∫è(ÊúÄÊñ∞‰ºòÂÖà)ÔºåÂéªÈáç(Ê†áÈ¢òÁõ∏‰ººÂ∫¶)
  filtered.sort((a,b) => new Date(b.time) - new Date(a.time));
  const seen = new Set();
  globalNews = [];
  for(const item of filtered){
    const key = item.title.toLowerCase().replace(/[^a-z0-9]/g,'').slice(0,40);
    if(!seen.has(key) && globalNews.length < 30){
      seen.add(key);
      // Ëã±ÊñáÊÉÖÁª™ÂàÜÊûê
      const t = `${item.title} ${item.description}`.toLowerCase();
      const bullEn = ['growth','surge','rally','gain','optimis','boost','strong','recover','rise','soar','boom','expand','record high','upturn','bullish'];
      const bearEn = ['crash','fall','drop','decline','recession','crisis','war','conflict','sanctions','tariff','inflation','fear','risk','slump','plunge','downturn','bearish','threat','turmoil','collapse','uncertainty'];
      let bs=0, brs=0;
      bullEn.forEach(w=>{ if(t.includes(w)) bs++; });
      bearEn.forEach(w=>{ if(t.includes(w)) brs++; });
      item.sentiment = bs>brs ? 'bull' : brs>bs ? 'bear' : 'neutral';
      item.timeFormatted = item.time ? new Date(item.time).toLocaleString('zh-CN',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
      globalNews.push(item);
    }
  }

  _globalNewsLoading = false;
  console.log(`[GlobalNews] Fetched ${allItems.length} ‚Üí filtered ${globalNews.length} political/economic items`);

  // Ëá™Âä®ÁøªËØëÊ†áÈ¢ò
  if(globalNews.length > 0) translateGlobalNews();
}

async function translateGlobalNews(){
  if(!globalNews.length) return;
  // Â∑≤ÊúâÁøªËØëÂàôË∑≥Ëøá
  if(globalNews[0].titleCN) return;
  const titles = globalNews.slice(0,30).map((n,i)=>`${i+1}. ${n.title}`).join('\n');
  try {
    const resp = await callAI(`Â∞Ü‰ª•‰∏ãËã±ÊñáÊñ∞ÈóªÊ†áÈ¢òÈÄêÊù°ÁøªËØë‰∏∫ÁÆÄÊ¥ÅÁöÑ‰∏≠ÊñáÔºå‰øùÊåÅÁºñÂè∑Ê†ºÂºèÔºåÊØèÊù°‰∏ÄË°åÔºåÂè™ËæìÂá∫ÁøªËØëÁªìÊûúÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïËß£ÈáäÔºö\n\n${titles}`);
    if(resp){
      const lines = resp.trim().split('\n').filter(l=>l.trim());
      lines.forEach(line=>{
        const m = line.match(/^(\d+)\.\s*(.+)/);
        if(m){
          const idx = parseInt(m[1]) - 1;
          if(idx>=0 && idx<globalNews.length) globalNews[idx].titleCN = m[2].trim();
        }
      });
      console.log(`[GlobalNews] Translated ${lines.length} titles to CN`);
      // Âà∑Êñ∞UI
      if(document.getElementById('data-intel-container')?.style.display!=='none') renderDataIntel();
    }
  } catch(e){ console.warn('translateGlobalNews:', e); }
}

function getGlobalNewsSentiment(){
  if(!globalNews.length) return { score:50, label:'Êó†Êï∞ÊçÆ', bullCount:0, bearCount:0, total:0 };
  const bullCount = globalNews.filter(n=>n.sentiment==='bull').length;
  const bearCount = globalNews.filter(n=>n.sentiment==='bear').length;
  const total = globalNews.length;
  const raw = 50 + (bullCount - bearCount) / total * 50;
  const score = Math.max(0, Math.min(100, Math.round(raw)));
  let label = '‰∏≠ÊÄß';
  if(score >= 70) label = 'ÂõΩÈôÖÂÅè‰πêËßÇ';
  else if(score >= 58) label = 'Áï•ÂÅèÊ≠£Èù¢';
  else if(score <= 30) label = 'ÂõΩÈôÖÂÅèÊÇ≤ËßÇ';
  else if(score <= 42) label = 'Áï•ÂÅèË¥üÈù¢';
  return { score, label, bullCount, bearCount, total };
}

async function summarizeGlobalNewsAI(){
  if(!globalNews.length) return;
  if(globalNewsSummary) return; // Â∑≤ÊúâÊëòË¶ÅÔºå‰∏çÈáçÂ§çËØ∑Ê±Ç
  const headlines = globalNews.slice(0,20).map((n,i)=>`${i+1}. [${n.source}] ${n.title}${n.description?' ‚Äî '+n.description.slice(0,80):''}`).join('\n');
  const prompt = `‰Ω†ÊòØ‰∏Ä‰ΩçËµÑÊ∑±ÂõΩÈôÖÊîøÊ≤ªÁªèÊµéÂàÜÊûêÂ∏àÔºå‰∏ìÊ≥®‰∫éÂÖ®ÁêÉÂÆèËßÇÂΩ¢ÂäøÂØπ‰∏≠ÂõΩËµÑÊú¨Â∏ÇÂú∫ÁöÑÂΩ±ÂìçÂàÜÊûê„ÄÇ

‰ª•‰∏ãÊòØ‰ªäÊó•ÂÖ®ÁêÉ‰∏ªË¶ÅÊñ∞ÈóªÂ™í‰Ωì(ÂçéÂ∞îË°óÊó•Êä•„ÄÅÁ∫ΩÁ∫¶Êó∂Êä•„ÄÅBBC„ÄÅCNN„ÄÅCNBC„ÄÅÂç´Êä•Á≠â)ÁöÑÊúÄÊñ∞ÊîøÊ≤ªÁªèÊµéÁ±ªÊñ∞ÈóªÊ†áÈ¢òÊëòË¶Å:

${headlines}

ËØ∑ÂÆåÊàê‰ª•‰∏ã‰ªªÂä°(Áî®‰∏≠ÊñáÂõûÁ≠î):
1. „ÄêÂõΩÈôÖÂΩ¢ÂäøÊ¶ÇËßà„ÄëÁî®3-4Âè•ËØùÊ¶ÇÊã¨ÂΩìÂâçÂÖ®ÁêÉÊîøÊ≤ªÁªèÊµé‰∏ªË¶ÅÂä®ÊÄÅ
2. „ÄêÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄëÂàóÂá∫3-5‰∏™ÊúÄÈáçË¶ÅÁöÑÂõΩÈôÖ‰∫ã‰ª∂ÔºåÊØè‰∏™‰∫ã‰ª∂‰∏ÄÂè•ËØùÊèèËø∞
3. „ÄêÂØπAËÇ°/‰∏≠ÂõΩÂ∏ÇÂú∫ÂΩ±Âìç„ÄëÂàÜÊûêËøô‰∫õÂõΩÈôÖÊñ∞ÈóªÂØπ‰∏≠ÂõΩËÇ°Â∏Ç„ÄÅÂü∫ÈáëÂ∏ÇÂú∫ÂèØËÉΩÁöÑÂΩ±Âìç:
   - Âà©Â•ΩÂõ†Á¥†(Â¶ÇÊúâ)
   - Âà©Á©∫Âõ†Á¥†(Â¶ÇÊúâ)
   - ÂèóÂΩ±ÂìçÁöÑË°å‰∏ö/ÊùøÂùó
4. „ÄêÊäïËµÑÂª∫ËÆÆ„ÄëÂü∫‰∫éÂõΩÈôÖÂΩ¢ÂäøÔºåÁªôÂá∫2-3Êù°ÂÖ∑‰ΩìÁöÑÂü∫ÈáëÊäïËµÑÊìç‰ΩúÂª∫ËÆÆ
5. „ÄêÊÉÖÁª™ËØÑÂàÜ„ÄëÁªôÂá∫Êï¥‰ΩìÂõΩÈôÖÁéØÂ¢ÉÂØπ‰∏≠ÂõΩÂ∏ÇÂú∫ÁöÑÂΩ±ÂìçËØÑÂàÜ(0-100Ôºå50‰∏∫‰∏≠ÊÄßÔºå>50ÂÅèÊ≠£Èù¢)

ËØ∑‰∏•Ê†ºÊåâ‰ª•‰∏ãJSONÊ†ºÂºèËøîÂõû(‰∏çË¶ÅÂåÖÂê´markdown‰ª£Á†ÅÂùóÊ†áËÆ∞):
{"overview":"...","keyEvents":["‰∫ã‰ª∂1","‰∫ã‰ª∂2","‰∫ã‰ª∂3"],"impact":{"positive":["..."],"negative":["..."],"sectors":["Ë°å‰∏ö1","Ë°å‰∏ö2"]},"advice":["Âª∫ËÆÆ1","Âª∫ËÆÆ2"],"score":60}`;

  try {
    const resp = await callAI(prompt, 'json_object');
    if(resp){
      let parsed;
      try { parsed = JSON.parse(resp); } catch(e) {
        // Â∞ùËØïÊèêÂèñJSON
        const m = resp.match(/\{[\s\S]*\}/);
        if(m) parsed = JSON.parse(m[0]);
      }
      if(parsed){
        globalNewsSummary = parsed;
        console.log('[GlobalNews] AI summary generated');
      }
    }
  } catch(e) { console.warn('summarizeGlobalNewsAI:', e); }
}

function getMacroSummary(){
  // ÁªºÂêàÂÆèËßÇ‰ø°Âè∑: Êâ©Âº†/Êî∂Áº©/‰∏≠ÊÄß
  let signals = [];
  if(macroData.pmi?.[0]){
    const pmi = macroData.pmi[0].MAKE_INDEX;
    signals.push({ name:'PMI', value:pmi, signal: pmi>=50?'Êâ©Âº†':'Êî∂Áº©', positive:pmi>=50 });
  }
  if(macroData.cpi?.[0]){
    const cpi = macroData.cpi[0].NATIONAL_SAME;
    signals.push({ name:'CPI', value:cpi+'%', signal: cpi>3?'ÈÄöËÉÄÂéãÂäõ':cpi<0?'ÈÄöÁº©È£éÈô©':'Ê∏©Âíå', positive:cpi>=0&&cpi<=3 });
  }
  if(macroData.ppi?.[0]){
    const ppi = macroData.ppi[0].BASE_SAME;
    signals.push({ name:'PPI', value:ppi+'%', signal: ppi>0?'Â∑•‰∏öÂìÅÊ∂®‰ª∑':'Â∑•‰∏öÂìÅÈôç‰ª∑', positive:ppi>-1 });
  }
  if(macroData.m2?.[0]){
    const m2 = macroData.m2[0].BASIC_CURRENCY_SAME;
    signals.push({ name:'M2Â¢ûÈÄü', value:m2+'%', signal: m2>10?'ÊµÅÂä®ÊÄßÂÆΩÊùæ':m2<8?'ÊµÅÂä®ÊÄßÂÅèÁ¥ß':'ÈÄÇ‰∏≠', positive:m2>=8 });
  }
  if(macroData.gdp?.[0]){
    const gdp = macroData.gdp[0].SUM_SAME;
    signals.push({ name:'GDP', value:gdp+'%', signal: gdp>=5?'Á®≥ÂÅ•Â¢ûÈïø':gdp>=4?'Â¢ûÈÄüÊîæÁºì':'Â¢ûÈÄüÂÅè‰Ωé', positive:gdp>=5 });
  }
  const positiveCount = signals.filter(s=>s.positive).length;
  const overallSignal = positiveCount >= 4 ? 'ÂÆèËßÇÂÅèÊöñ' : positiveCount >= 2 ? 'ÂÆèËßÇ‰∏≠ÊÄß' : 'ÂÆèËßÇÂÅèÂÜ∑';
  return { signals, overallSignal, positiveCount };
}

function getCapFlowSummary(){
  if(!sectorCapFlow.length) return { topInflow:[], topOutflow:[], netTotal:0 };
  const sorted = [...sectorCapFlow].sort((a,b)=>(b.mainNet||0)-(a.mainNet||0));
  const topInflow = sorted.filter(s=>s.mainNet>0).slice(0,5);
  const topOutflow = sorted.filter(s=>s.mainNet<0).slice(-5).reverse();
  const netTotal = sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0),0);
  return { topInflow, topOutflow, netTotal };
}

async function fetchAllDataIntel(){
  await Promise.allSettled([
    fetchMacroData(),
    fetchSectorCapFlow(),
    fetchNewsHeadlines(),
    fetchGlobalNews(),
  ]);
  _dataIntelLoaded = true;
  renderDataIntelBrief();
  // ÂºÇÊ≠•Ëß¶ÂèëÂõΩÈôÖÊñ∞ÈóªAIÊëòË¶Å(‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ã)
  if(globalNews.length > 0){
    // Âπ∂Ë°åËß¶ÂèëÁøªËØëÂíåAIÊëòË¶Å(‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ã)
    translateGlobalNews();
    summarizeGlobalNewsAI().then(()=>{ if(document.getElementById('data-intel-container')?.style.display!=='none') renderDataIntel(); });
  }
}

// ==================== RL BRAIN: DEEP Q-NETWORK ====================
// Á∫ØJavaScriptÂÆûÁé∞ÁöÑÂº∫ÂåñÂ≠¶‰π†‰∫§ÊòìÂ§ßËÑëÔºåÊó†Â§ñÈÉ®‰æùËµñ
// ÁÆóÊ≥ï: Double DQN + Experience Replay + Target Network + Adam Optimizer
// Áä∂ÊÄÅÁ©∫Èó¥: 15Áª¥ (Âä®Èáè√ó4 + Ê≥¢Âä®Áéá√ó2 + RSI + MACD + MA + ÂõûÊí§ + ÊåÅ‰ªì + PnL + ÂÆèËßÇ + ËàÜÊÉÖ + ËµÑÈáë)
// Âä®‰ΩúÁ©∫Èó¥: 3 (ÊåÅÊúâ/‰π∞ÂÖ•/ÂçñÂá∫)
// Â•ñÂä±ËÆæËÆ°: ËµÑ‰∫ßÂ¢ûÂÄº(+) ¬∑ ‰∫èÊçü(-) ¬∑ ÂõûÊí§ÊÉ©ÁΩö(-) ¬∑ ËøáÂ∫¶‰∫§Êòì(-)

// --- Math Utilities ---
function rlRand(scale){
  const u1=Math.random(),u2=Math.random();
  return Math.sqrt(-2*Math.log(u1||1e-10))*Math.cos(2*Math.PI*u2)*scale;
}
function rlClip(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function rlArgmax(arr){let m=0;for(let i=1;i<arr.length;i++)if(arr[i]>arr[m])m=i;return m;}
function rlSoftmax(arr){
  const mx=Math.max(...arr);
  const ex=arr.map(v=>Math.exp(v-mx));
  const s=ex.reduce((a,b)=>a+b,0);
  return ex.map(v=>v/s);
}

// --- Neural Network (Adam Optimizer, He Init, Huber Loss) ---
class RLNetwork{
  constructor(sizes){
    this.sizes=sizes;
    this.nL=sizes.length-1;
    this.W=[];this.b=[];
    this.mW=[];this.vW=[];this.mb=[];this.vb=[];
    this.t=0;
    for(let i=0;i<this.nL;i++){
      const inS=sizes[i],outS=sizes[i+1];
      const scale=Math.sqrt(2.0/inS);
      const w=new Float32Array(outS*inS);
      for(let k=0;k<w.length;k++)w[k]=rlRand(scale);
      this.W.push(w);
      this.b.push(new Float32Array(outS));
      this.mW.push(new Float32Array(outS*inS));
      this.vW.push(new Float32Array(outS*inS));
      this.mb.push(new Float32Array(outS));
      this.vb.push(new Float32Array(outS));
    }
  }
  forward(input){
    let a=Float32Array.from(input);
    this._c=[{a}];
    for(let i=0;i<this.nL;i++){
      const inS=this.sizes[i],outS=this.sizes[i+1];
      const z=new Float32Array(outS);
      for(let r=0;r<outS;r++){
        let s=this.b[i][r];
        const off=r*inS;
        for(let c=0;c<inS;c++)s+=this.W[i][off+c]*a[c];
        z[r]=s;
      }
      if(i<this.nL-1){
        a=new Float32Array(outS);
        for(let r=0;r<outS;r++)a[r]=z[r]>0?z[r]:0; // ReLU
      } else {
        a=z; // linear output
      }
      this._c.push({z,a});
    }
    return a;
  }
  trainStep(input,target,lr){
    const out=this.forward(input);
    const n=out.length;
    let loss=0;
    let dA=new Float32Array(n);
    for(let i=0;i<n;i++){
      const d=out[i]-target[i];
      if(Math.abs(d)<1){loss+=0.5*d*d;dA[i]=d;} // Huber loss
      else{loss+=Math.abs(d)-0.5;dA[i]=d>0?1:-1;}
    }
    this.t++;
    const b1=0.9,b2=0.999,eps=1e-8;
    for(let l=this.nL-1;l>=0;l--){
      const inS=this.sizes[l],outS=this.sizes[l+1];
      const aIn=this._c[l].a;
      // ReLU gradient for hidden layers
      if(l<this.nL-1){
        const z=this._c[l+1].z;
        for(let i=0;i<outS;i++)if(z[i]<=0)dA[i]=0;
      }
      // Weight gradients + Adam update
      for(let i=0;i<outS;i++){
        const off=i*inS;
        for(let j=0;j<inS;j++){
          const g=dA[i]*aIn[j];
          const k=off+j;
          this.mW[l][k]=b1*this.mW[l][k]+(1-b1)*g;
          this.vW[l][k]=b2*this.vW[l][k]+(1-b2)*g*g;
          const mh=this.mW[l][k]/(1-Math.pow(b1,this.t));
          const vh=this.vW[l][k]/(1-Math.pow(b2,this.t));
          this.W[l][k]-=lr*mh/(Math.sqrt(vh)+eps);
        }
        // Bias Adam
        this.mb[l][i]=b1*this.mb[l][i]+(1-b1)*dA[i];
        this.vb[l][i]=b2*this.vb[l][i]+(1-b2)*dA[i]*dA[i];
        const mbh=this.mb[l][i]/(1-Math.pow(b1,this.t));
        const vbh=this.vb[l][i]/(1-Math.pow(b2,this.t));
        this.b[l][i]-=lr*mbh/(Math.sqrt(vbh)+eps);
      }
      // Propagate gradient
      if(l>0){
        const dAPrev=new Float32Array(inS);
        for(let j=0;j<inS;j++){
          let s=0;
          for(let i=0;i<outS;i++)s+=this.W[l][i*inS+j]*dA[i];
          dAPrev[j]=s;
        }
        dA=dAPrev;
      }
    }
    return loss;
  }
  clone(){
    const net=new RLNetwork(this.sizes);
    for(let i=0;i<this.nL;i++){
      net.W[i]=new Float32Array(this.W[i]);
      net.b[i]=new Float32Array(this.b[i]);
    }
    return net;
  }
  toJSON(){
    return{sizes:this.sizes,W:this.W.map(w=>Array.from(w)),b:this.b.map(b=>Array.from(b)),t:this.t};
  }
  static fromJSON(d){
    const net=new RLNetwork(d.sizes);
    for(let i=0;i<net.nL;i++){
      net.W[i]=Float32Array.from(d.W[i]);
      net.b[i]=Float32Array.from(d.b[i]);
    }
    net.t=d.t||0;
    return net;
  }
}

// --- DQN Agent (Double DQN) ---
class DQNAgent{
  constructor(stateSize,actionSize){
    this.stateSize=stateSize;
    this.actionSize=actionSize;
    this.qNet=new RLNetwork([stateSize,64,32,actionSize]);
    this.targetNet=this.qNet.clone();
    this.memory=[];
    this.maxMemory=10000;
    this.batchSize=32;
    this.gamma=0.99;
    this.epsilon=1.0;
    this.epsilonMin=0.02;
    this.epsilonDecay=0.998;
    this.lr=0.001;
    this.targetUpdateFreq=200;
    this.trainSteps=0;
    this.totalReward=0;
  }
  act(state,explore=true){
    if(explore&&Math.random()<this.epsilon)return Math.floor(Math.random()*this.actionSize);
    return rlArgmax(this.qNet.forward(state));
  }
  getQValues(state){return this.qNet.forward(state);}
  remember(s,a,r,s2,done){
    if(this.memory.length>=this.maxMemory)this.memory.shift();
    this.memory.push({s,a,r,s2,done});
  }
  replay(){
    if(this.memory.length<this.batchSize*2)return 0;
    let totalLoss=0;
    for(let i=0;i<this.batchSize;i++){
      const exp=this.memory[Math.floor(Math.random()*this.memory.length)];
      const q=this.qNet.forward(exp.s);
      const target=Float32Array.from(q);
      if(exp.done){
        target[exp.a]=exp.r;
      }else{
        // Double DQN: online selects action, target evaluates
        const bestA=rlArgmax(this.qNet.forward(exp.s2));
        const nextQ=this.targetNet.forward(exp.s2);
        target[exp.a]=exp.r+this.gamma*nextQ[bestA];
      }
      totalLoss+=this.qNet.trainStep(exp.s,target,this.lr);
    }
    this.trainSteps++;
    if(this.trainSteps%this.targetUpdateFreq===0)this.targetNet=this.qNet.clone();
    if(this.epsilon>this.epsilonMin)this.epsilon*=this.epsilonDecay;
    return totalLoss/this.batchSize;
  }
  toJSON(){
    return{qNet:this.qNet.toJSON(),epsilon:this.epsilon,trainSteps:this.trainSteps,totalReward:this.totalReward};
  }
  static fromJSON(d){
    const a=new DQNAgent(d.qNet.sizes[0],d.qNet.sizes[d.qNet.sizes.length-1]);
    a.qNet=RLNetwork.fromJSON(d.qNet);
    a.targetNet=a.qNet.clone();
    a.epsilon=d.epsilon||0.02;
    a.trainSteps=d.trainSteps||0;
    a.totalReward=d.totalReward||0;
    return a;
  }
}

// --- Market Environment (Gym-style) ---
class MarketEnv{
  constructor(navArray, code){
    this.navs=navArray; // [{date,nav},...] sorted by date
    this._code=code||''; // fund code for backtest data lookup
    this.lookback=20;
    this.fee=0.0015;
  }
  reset(){
    this.idx=this.lookback;
    this.pos=0; // 0=cash,1=long
    this.entryPrice=0;
    this.portfolio=1.0;
    this.peakPf=1.0;
    this.trades=0;
    return this._state();
  }
  _state(){
    const p=[];
    for(let i=this.idx-this.lookback;i<=this.idx;i++)p.push(this.navs[i].nav);
    const cur=p[p.length-1];
    const n=p.length;
    const rets=[];
    for(let i=1;i<n;i++)rets.push((p[i]-p[i-1])/p[i-1]);
    const ret1=rets[rets.length-1]||0;
    const sum=(a,k)=>{const sl=a.slice(-k);return sl.reduce((s,v)=>s+v,0);};
    const std=(a)=>{if(a.length<2)return 0;const m=a.reduce((s,v)=>s+v,0)/a.length;return Math.sqrt(a.reduce((s,v)=>s+(v-m)**2,0)/a.length);};
    const rsiCalc=(a)=>{let g=0,l=0;a.forEach(r=>{if(r>0)g+=r;else l+=Math.abs(r);});if(!l)return 100;if(!g)return 0;return 100-100/(1+g/l);};
    const ema=(arr,period)=>{const k=2/(period+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;};
    const ma=(arr,k)=>arr.slice(-k).reduce((s,v)=>s+v,0)/Math.min(arr.length,k);
    const rsi=rsiCalc(rets.slice(-14));
    const ema12=ema(p,12),ema26=ema(p,26);
    const macd=(ema12-ema26)/cur;
    const ma20=ma(p,20);
    const maPos=(cur-ma20)/ma20;
    const maxP=Math.max(...p.slice(-20));
    const dd=(cur-maxP)/maxP;
    const pnl=this.pos===1?(cur-this.entryPrice)/this.entryPrice:0;
    // ‰ªéÂõûÊµãÁªìÊûúÊ≥®ÂÖ•ÂéÜÂè≤Á≠ñÁï•ÁâπÂæÅ
    const btR = typeof btResults!=='undefined' ? btResults[this._code] : null;
    const btSharpe = btR ? btR.sharpe : 0;
    const btKelly = btR ? btR.finalKelly : 0.05;
    const btRSI = btR?.lastRSI || 50;
    return Float32Array.from([
      rlClip(ret1*100,-5,5),
      rlClip(sum(rets,5)*100,-15,15),
      rlClip(sum(rets,10)*100,-25,25),
      rlClip(sum(rets,20)*100,-40,40),
      rlClip(std(rets.slice(-5))*100,0,10),
      rlClip(std(rets.slice(-20))*100,0,10),
      (rsi-50)/50,
      rlClip(macd*100,-5,5),
      rlClip(maPos*10,-3,3),
      rlClip(dd*10,-5,0),
      this.pos,
      rlClip(pnl*10,-5,5),
      0,0,0, // macro/sentiment/capflow filled at inference
      rlClip(btSharpe,-2,3),       // [15] ÂõûÊµãSharpe
      rlClip(btKelly*10,-1,3),     // [16] ÂõûÊµãKelly‰ªì‰Ωç
      (btRSI-50)/50                // [17] ÂõûÊµãÂΩìÂâçRSI
    ]);
  }
  step(action){
    const prev=this.navs[this.idx].nav;
    this.idx++;
    const done=this.idx>=this.navs.length-1;
    const cur=this.navs[this.idx].nav;
    const dr=(cur-prev)/prev;
    let reward=0;
    if(action===1&&this.pos===0){
      this.pos=1;this.entryPrice=cur;
      this.portfolio*=(1-this.fee);this.trades++;
      reward=-0.001;
    }else if(action===2&&this.pos===1){
      const pnl=(cur-this.entryPrice)/this.entryPrice;
      this.portfolio*=(1+pnl)*(1-this.fee);
      this.pos=0;this.entryPrice=0;this.trades++;
      reward=pnl*10;
    }else if(action===1&&this.pos===1){
      reward=dr*5; // already long, hold
    }else if(action===2&&this.pos===0){
      reward=-dr*2; // no position, can't sell
    }else if(this.pos===1){
      reward=dr*5; // holding
    }else{
      reward=dr<0?Math.abs(dr)*2:-dr*1; // cash
    }
    this.peakPf=Math.max(this.peakPf,this.portfolio);
    const mdd=(this.portfolio-this.peakPf)/this.peakPf;
    if(mdd<-0.05)reward-=0.05;
    if(mdd<-0.10)reward-=0.1;
    const tradeRate=this.trades/(this.idx-this.lookback+1);
    if(tradeRate>0.3)reward-=0.02;
    return{state:this._state(),reward,done};
  }
}

// --- RL Training Pipeline ---
class RLTrainer{
  constructor(){
    this.agent=null;
    this.isTraining=false;
    this.episode=0;
    this.maxEpisodes=50;
    this.metrics={rewards:[],losses:[],portfolios:[],winRate:0,avgReturn:0,sharpe:0,bestReturn:-Infinity,totalTrades:0};
    this._data=[];
  }
  prepare(){
    this._data=[];
    for(const code of Object.keys(fundHistoryData)){
      const hd=fundHistoryData[code];
      if(!hd||!hd.navs||hd.navs.length<60)continue;
      const navArr=hd.navs.map(n=>({date:n[0],nav:parseFloat(n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length>=60)this._data.push({code,navs:navArr});
    }
    this.agent=new DQNAgent(RL_STATE_SIZE,RL_ACTION_SIZE);
    this.metrics={rewards:[],losses:[],portfolios:[],winRate:0,avgReturn:0,sharpe:0,bestReturn:-Infinity,totalTrades:0};
    this.episode=0;
    return this._data.length;
  }
  async train(onProgress){
    if(!this._data.length)return;
    this.isTraining=true;
    for(let ep=0;ep<this.maxEpisodes&&this.isTraining;ep++){
      this.episode=ep;
      let epR=0,epL=0,epSteps=0,epPfs=[],epTrades=0;
      const shuffled=[...this._data].sort(()=>Math.random()-0.5);
      for(const{code,navs}of shuffled){
        const env=new MarketEnv(navs,code);
        let state=env.reset(),done=false;
        while(!done){
          const action=this.agent.act(state,true);
          const r=env.step(action);
          this.agent.remember(state,action,r.reward,r.state,r.done);
          state=r.state;done=r.done;
          epR+=r.reward;epSteps++;
          if(epSteps%4===0&&this.agent.memory.length>=this.agent.batchSize*2){
            epL+=this.agent.replay();
          }
        }
        epPfs.push(env.portfolio);
        epTrades+=env.trades;
      }
      const avgPf=epPfs.reduce((s,v)=>s+v,0)/epPfs.length;
      const avgRet=(avgPf-1)*100;
      const wr=epPfs.filter(p=>p>1).length/epPfs.length*100;
      this.metrics.rewards.push(epR/Math.max(1,epSteps));
      this.metrics.losses.push(epL/Math.max(1,Math.floor(epSteps/4)));
      this.metrics.portfolios.push(avgRet);
      this.metrics.winRate=wr;
      this.metrics.avgReturn=avgRet;
      this.metrics.totalTrades=epTrades;
      if(avgRet>this.metrics.bestReturn)this.metrics.bestReturn=avgRet;
      const rc=this.metrics.portfolios.slice(-10);
      if(rc.length>=3){
        const mu=rc.reduce((s,v)=>s+v,0)/rc.length;
        const sd=Math.sqrt(rc.reduce((s,v)=>s+(v-mu)**2,0)/rc.length);
        this.metrics.sharpe=sd>0?mu/sd:0;
      }
      if(onProgress)onProgress(ep+1,this.maxEpisodes,this.metrics);
      if(ep%2===0)await new Promise(r=>setTimeout(r,0));
    }
    this.isTraining=false;
    this.agent.totalReward=this.metrics.rewards.reduce((s,v)=>s+v,0);
    this.saveModel();
    return this.metrics;
  }
  stop(){this.isTraining=false;}
  generateSignals(){
    if(!this.agent)return{};
    const signals={};
    const codes=[...holdings.map(h=>h.code),...watchlist.map(w=>w.code)];
    for(const code of codes){
      const hd=fundHistoryData[code];
      if(!hd||!hd.navs||hd.navs.length<25)continue;
      const navArr=hd.navs.map(n=>({date:n[0],nav:parseFloat(n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length<25)continue;
      const env=new MarketEnv(navArr,code);
      env.idx=navArr.length-1;
      const simPos=simPortfolio?.positions?.find(p=>p.code===code);
      env.pos=simPos?1:0;
      if(simPos)env.entryPrice=simPos.avgCost;
      const state=env._state();
      // Inject live macro/sentiment/capital signals
      if(_dataIntelLoaded){
        const ds=generateDataSignal();
        state[12]=rlClip((ds.score-50)/25,-2,2);
        state[13]=rlClip((newsSentiment.score-50)/25,-2,2);
        const cn=sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0),0);
        state[14]=rlClip(cn/1e10,-2,2);
      }
      const q=this.agent.getQValues(state);
      const action=rlArgmax(q);
      const probs=rlSoftmax(Array.from(q));
      signals[code]={
        action,
        actionName:RL_ACTION_NAMES[action],
        confidence:Math.round(probs[action]*100),
        qValues:Array.from(q),
        probabilities:probs
      };
    }
    _rlSignals=signals;
    return signals;
  }
  saveModel(){
    if(!this.agent)return;
    try{
      localStorage.setItem(RL_STORAGE_KEY,JSON.stringify({
        agent:this.agent.toJSON(),
        metrics:this.metrics,
        episode:this.episode,
        timestamp:Date.now()
      }));
      _rlModelLoaded=true;
      console.log('RLÊ®°ÂûãÂ∑≤‰øùÂ≠ò, ËÆ≠ÁªÉÊ≠•Êï∞:',this.agent.trainSteps);
    }catch(e){console.warn('RLÊ®°Âûã‰øùÂ≠òÂ§±Ë¥•:',e);}
  }
  loadModel(){
    try{
      const raw=localStorage.getItem(RL_STORAGE_KEY);
      if(!raw)return false;
      const d=JSON.parse(raw);
      // Ê£ÄÊü•Ê®°ÂûãÁª¥Â∫¶ÊòØÂê¶ÂåπÈÖç(15‚Üí18ËøÅÁßªÂÖºÂÆπ)
      const savedSize = d.agent?.qNet?.sizes?.[0] || 0;
      if(savedSize !== RL_STATE_SIZE){
        console.warn(`RLÊ®°ÂûãÁª¥Â∫¶‰∏çÂåπÈÖç(‰øùÂ≠ò:${savedSize} ÂΩìÂâç:${RL_STATE_SIZE})ÔºåÈúÄÈáçÊñ∞ËÆ≠ÁªÉ`);
        localStorage.removeItem(RL_STORAGE_KEY);
        return false;
      }
      this.agent=DQNAgent.fromJSON(d.agent);
      this.metrics=d.metrics||this.metrics;
      this.episode=d.episode||0;
      _rlModelLoaded=true;
      console.log('RLÊ®°ÂûãÂ∑≤Âä†ËΩΩ, ËÆ≠ÁªÉÊ≠•Êï∞:',this.agent.trainSteps);
      return true;
    }catch(e){console.warn('RLÊ®°ÂûãÂä†ËΩΩÂ§±Ë¥•:',e);return false;}
  }
}

// ==================== HISTORICAL DATA & TREND ANALYSIS ====================
async function fetchFundHistory(code){
  // Ëé∑ÂèñÂü∫ÈáëÂéÜÂè≤ÂáÄÂÄºÔºàËøë1Âπ¥ÔºåÁ∫¶250‰∏™‰∫§ÊòìÊó•Ôºâ
  try{
    const url = `https://api.fund.eastmoney.com/f10/lsjz?fundCode=${code}&pageIndex=1&pageSize=250`;
    const resp = await fetch(url, {headers:{'Referer':'https://fundf10.eastmoney.com/'}});
    if(!resp.ok) throw new Error('fetch fail');
    const json = await resp.json();
    if(json?.Data?.LSJZList){
      const navs = json.Data.LSJZList
        .map(d=>({date:d.FSRQ, nav:parseFloat(d.DWJZ)}))
        .filter(d=>!isNaN(d.nav))
        .reverse(); // ÊúÄÊó©Âú®Ââç
      return navs;
    }
  }catch(e){
    // Â§áÁî®JSONPÊñπÂºè
    try{
      const data = await jsonpFetch(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${getSecidForFund(code)}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=1&beg=0&end=20500101&lmt=250`);
      if(data?.data?.klines){
        return data.data.klines.map(k=>{
          const parts=k.split(',');
          return {date:parts[0], nav:parseFloat(parts[1])};
        }).filter(d=>!isNaN(d.nav));
      }
    }catch(e2){}
  }
  return null;
}

function getSecidForFund(code){
  // Âü∫Èáë‰ª£Á†ÅÊò†Â∞ÑÂà∞secidÔºà‰∏ä‰∫§ÊâÄ1.xxxÔºåÊ∑±‰∫§ÊâÄ0.xxxÔºâ
  const first = code.charAt(0);
  if(first==='5'||first==='6') return `1.${code}`;
  return `0.${code}`;
}

function analyzeTrend(navs){
  if(!navs || navs.length < 10) return null;

  const len = navs.length;
  const latest = navs[len-1].nav;
  const prices = navs.map(n=>n.nav);

  // ÂêÑÂë®ÊúüÊ∂®Ë∑åÂπÖ
  const pct = (cur,prev) => prev>0 ? ((cur-prev)/prev*100) : 0;
  const chg5d = len>5 ? pct(latest, prices[len-6]) : 0;    // Ëøë5Êó•
  const chg20d = len>20 ? pct(latest, prices[len-21]) : 0;  // Ëøë1Êúà
  const chg60d = len>60 ? pct(latest, prices[len-61]) : 0;  // Ëøë3Êúà
  const chg120d = len>120 ? pct(latest, prices[len-121]) : 0; // Ëøë6Êúà
  const chg250d = len>240 ? pct(latest, prices[0]) : 0;      // Ëøë1Âπ¥

  // ÂùáÁ∫ø
  const ma = (n) => {
    if(len<n) return latest;
    let sum=0; for(let i=len-n;i<len;i++) sum+=prices[i];
    return sum/n;
  };
  const ma5 = ma(5), ma20 = ma(20), ma60 = ma(60);

  // Ëøë1Âπ¥ÊúÄÈ´ò/ÊúÄ‰Ωé
  const high1y = Math.max(...prices);
  const low1y = Math.min(...prices);
  const drawdownFromHigh = pct(latest, high1y); // Ë∑ùÈ´òÁÇπÂõûÊí§(Ë¥üÊï∞)
  const reboundFromLow = pct(latest, low1y);     // Ë∑ù‰ΩéÁÇπÂèçÂºπ

  // Ë∂ãÂäøÂà§Êñ≠
  let trendDir = 'sideways';
  let trendScore = 0; // -100~100

  // ÂùáÁ∫øÂ§öÂ§¥ÊéíÂàó: ma5>ma20>ma60 ‚Üí Âº∫‰∏äÂçá
  if(ma5>ma20 && ma20>ma60) trendScore += 30;
  else if(ma5<ma20 && ma20<ma60) trendScore -= 30;

  // ‰∏≠ÊúüÊ∂®ÂπÖ
  if(chg60d > 8) trendScore += 25;
  else if(chg60d > 3) trendScore += 15;
  else if(chg60d < -8) trendScore -= 25;
  else if(chg60d < -3) trendScore -= 15;

  // ÈïøÊúüË∂ãÂäø
  if(chg250d > 15) trendScore += 20;
  else if(chg250d > 5) trendScore += 10;
  else if(chg250d < -15) trendScore -= 20;
  else if(chg250d < -5) trendScore -= 10;

  // ‰ª∑Ê†º‰ΩçÁΩÆ
  if(latest > ma20 && latest > ma60) trendScore += 10;
  else if(latest < ma20 && latest < ma60) trendScore -= 10;

  if(trendScore >= 25) trendDir = 'strong_up';
  else if(trendScore >= 10) trendDir = 'up';
  else if(trendScore <= -25) trendDir = 'strong_down';
  else if(trendScore <= -10) trendDir = 'down';

  // Ê≥¢ÊÆµ‰ΩçÁΩÆÂà§Êñ≠
  let swingPos = 'mid'; // ÂΩìÂâçÂ§Ñ‰∫éÊ≥¢ÊÆµÁöÑ‰ªÄ‰πà‰ΩçÁΩÆ
  if(chg5d <= -3) swingPos = 'deep_dip';      // 5Êó•Êö¥Ë∑å‚Äî‚ÄîÊ∑±Â∫¶ÂõûË∞É
  else if(chg5d <= -1.5) swingPos = 'dip';     // 5Êó•‰∏ãË∑å‚Äî‚ÄîÂõûË∞É‰∏≠
  else if(chg5d >= 3) swingPos = 'surge';       // 5Êó•Êö¥Ê∂®‚Äî‚ÄîÂÜ≤È´ò
  else if(chg5d >= 1.5) swingPos = 'rally';     // 5Êó•‰∏äÊ∂®‚Äî‚ÄîÂèçÂºπ‰∏≠

  // Ê≥¢ÊÆµÂª∫ËÆÆ
  let swingAdvice = '';
  if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = 'Ë∂ãÂäøÂêë‰∏ä+Áü≠ÊúüÂõûË∞ÉÔºåÊ≥¢ÊÆµ‰π∞ÂÖ•Êú∫‰ºöÔºÅ';
  } else if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = 'Ë∂ãÂäøÂêë‰∏ä+Áü≠ÊúüÂÜ≤È´òÔºåÂèØËÄÉËôëÈÉ®ÂàÜÊ≠¢Áõà';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = 'Ë∂ãÂäøÂêë‰∏ã+Áü≠ÊúüÂèçÂºπÔºåÂª∫ËÆÆÈÄ¢È´òÂáè‰ªì';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = 'Ë∂ãÂäøÂêë‰∏ã+ÁªßÁª≠‰∏ãË∑åÔºå‰∏çÂª∫ËÆÆÊäÑÂ∫ï';
  } else if(trendDir==='sideways'){
    swingAdvice = 'ÈúáËç°Ê†ºÂ±ÄÔºåÁ≠âÂæÖÊñπÂêëÊòéÁ°Æ';
  }

  return {
    chg5d: +chg5d.toFixed(2),
    chg20d: +chg20d.toFixed(2),
    chg60d: +chg60d.toFixed(2),
    chg120d: +chg120d.toFixed(2),
    chg250d: +chg250d.toFixed(2),
    ma5: +ma5.toFixed(4), ma20: +ma20.toFixed(4), ma60: +ma60.toFixed(4),
    latest: +latest.toFixed(4),
    high1y: +high1y.toFixed(4), low1y: +low1y.toFixed(4),
    drawdownFromHigh: +drawdownFromHigh.toFixed(2),
    reboundFromLow: +reboundFromLow.toFixed(2),
    trendDir, trendScore, swingPos, swingAdvice,
    dataPoints: len
  };
}

async function fetchAllHistory(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  for(const code of codes){
    const navs = await fetchFundHistory(code);
    if(navs && navs.length>0){
      const trend = analyzeTrend(navs);
      fundHistoryData[code] = { navs, trend };
    }
    await new Promise(r=>setTimeout(r,200));
  }
}

function getFundData(code){
  if(liveFundData[code]) return {...liveFundData[code], _live:true};
  // Â∞ùËØï‰ªéÂéÜÂè≤Êï∞ÊçÆÂèñÊúÄÊñ∞ÁúüÂÆûÂáÄÂÄº
  const hd = fundHistoryData[code];
  if(hd && hd.navs && hd.navs.length>0){
    const latest = hd.navs[hd.navs.length-1];
    const prev = hd.navs.length>1 ? hd.navs[hd.navs.length-2] : latest;
    const pct = prev.nav>0 ? (latest.nav-prev.nav)/prev.nav*100 : 0;
    const nm = FUND_DB.find(x=>x.code===code)?.name || RECO_FUND_POOL.find(x=>x.code===code)?.name || code;
    return {gsz:latest.nav, dwjz:latest.nav, gszzl:+pct.toFixed(2), name:nm, gztime:latest.date, _live:false, _histFallback:true};
  }
  const f = FUND_DB.find(x=>x.code===code);
  const r = RECO_FUND_POOL.find(x=>x.code===code);
  const seed = parseInt(todayStr().replace(/-/g,''))+parseInt(code);
  const pct = (seededRand(seed)-0.46)*4;
  const dwjz = (f?f.baseNav:1)*(1+(seededRand(seed+100)-0.5)*0.3);
  const nm = f?f.name : r?r.name : code;
  return {gsz:dwjz*(1+pct/100), dwjz, gszzl:pct, name:nm, gztime:todayStr()+' 15:00', _live:false};
}

function getIndexData(cfg){
  if(liveIndices[cfg.secid]) return liveIndices[cfg.secid];
  const base={'1.000001':3340,'0.399001':10420,'0.399006':2110,'1.000300':4000,'1.518880':7.5,'0.161226':1.45,'1.000819':5200}[cfg.secid]||3000;
  const seed = parseInt(todayStr().replace(/-/g,''))+(cfg.secid.charCodeAt(2)||0)*137;
  const pct=(seededRand(seed)-0.46)*3;
  return {name:cfg.name, price:(base*(1+pct/100)).toFixed(2), pct:pct, change:(base*pct/100).toFixed(2)};
}

function fundName(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  const live = liveFundData[code];
  return info?.name || reco?.name || live?.name || h?.name || w?.name || code;
}

function fundType(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  return info?.type || reco?.type || h?.type || w?.type || '';
}

// ==================== AI ENGINE ====================
async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_aiKey) throw new Error('ËØ∑ÂÖàÈÖçÁΩÆAPI Key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:4096
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildContext(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const shData = getIndexData(INDICES_CONFIG[0]);
  const szData = getIndexData(INDICES_CONFIG[1]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const auData = getIndexData(INDICES_CONFIG[4]);
  const agData = getIndexData(INDICES_CONFIG[5]);
  const ysData = getIndexData(INDICES_CONFIG[6]);
  const topUp = liveSectors.filter(s=>s.pct>0).slice(0,6);
  const topDown = liveSectors.filter(s=>s.pct<0).slice(-4).reverse();

  let ctx = `ÂΩìÂâçÊó•Êúü: ${todayStr()}\n`;
  ctx += `Áî®Êà∑ÁõÆÊ†áÔºö3‰∏™ÊúàÂÜÖÁ®≥ÂÅ•Â¢ûÈïøÔºåË∑ëËµ¢Ê≤™Ê∑±300ÊåáÊï∞\n\n`;
  ctx += `„ÄêÂ§ßÁõòÊåáÊï∞„Äë\n`;
  ctx += `‰∏äËØÅÊåáÊï∞: ${shData.price} (${sign(shData.pct)}${fmt(shData.pct)}%)\n`;
  ctx += `Ê∑±ËØÅÊàêÊåá: ${szData.price} (${sign(szData.pct)}${fmt(szData.pct)}%)\n`;
  ctx += `Âàõ‰∏öÊùøÊåá: ${cyData.price} (${sign(cyData.pct)}${fmt(cyData.pct)}%)\n`;
  ctx += `Ê≤™Ê∑±300: ${hs300.price} (${sign(hs300.pct)}${fmt(hs300.pct)}%)\n`;
  ctx += `\n„ÄêÂïÜÂìÅ/Ë¥µÈáëÂ±û„Äë\n`;
  ctx += `ÈªÑÈáëETF: ${auData.price} (${sign(auData.pct)}${fmt(auData.pct)}%)\n`;
  ctx += `ÁôΩÈì∂LOF: ${agData.price} (${sign(agData.pct)}${fmt(agData.pct)}%)\n`;
  ctx += `ÊúâËâ≤ÈáëÂ±ûÊåáÊï∞: ${ysData.price} (${sign(ysData.pct)}${fmt(ysData.pct)}%)\n`;

  if(topUp.length>0){
    ctx += `\n„Äê‰ªäÊó•È¢ÜÊ∂®ÊùøÂùó„Äë\n`;
    topUp.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }
  if(topDown.length>0){
    ctx += `\n„Äê‰ªäÊó•È¢ÜË∑åÊùøÂùó„Äë\n`;
    topDown.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }

  // ÊûÑÂª∫Âü∫ÈáëË∂ãÂäøÊï∞ÊçÆÔºà‰ºòÂÖà‰ΩøÁî®ÁúüÂÆûÂéÜÂè≤Êï∞ÊçÆÔºåÊó†Êï∞ÊçÆÊó∂Áî®ÊùøÂùóÈÄöÁî®ÊèèËø∞ÂÅöÂêéÂ§áÔºâ
  const SECTOR_FALLBACK = {
    'ÈªÑÈáë':'ËøëÊúüÈÅøÈô©ÈúÄÊ±ÇÊîØÊíëÔºåÂÖ≥Ê≥®Â§ÆË°åË¥≠ÈáëÂä®ÊÄÅ',
    'ÊúâËâ≤ÈáëÂ±û':'ÂÖ≥Ê≥®ÂÖ®ÁêÉÂ§ßÂÆóÂïÜÂìÅ‰ª∑Ê†ºËµ∞ÂäøÂíåÊñ∞Âü∫Âª∫ÈúÄÊ±Ç',
    'AI/ÁßëÊäÄ':'AI‰∫ß‰∏öÈ©±Âä®ÔºåÂÖ≥Ê≥®ÁÆóÂäõÈúÄÊ±ÇÂíå‰∫ß‰∏öÊîøÁ≠ñ',
    'ÂçäÂØº‰Ωì':'ÂõΩ‰∫ßÊõø‰ª£ÈÄªËæëÊåÅÁª≠ÔºåÊ≥®ÊÑè‰º∞ÂÄºÊ≥¢Âä®',
    'ÂÜõÂ∑•':'‰∫ã‰ª∂È©±Âä®ÂûãÔºåÂÖ≥Ê≥®Âú∞ÁºòÊîøÁ≠ñÂÇ¨Âåñ',
    'Á∫¢Âà©':'Èò≤Âæ°ÊÄßÂº∫ÔºåÈÄÇÂêàÈïøÊåÅ',
    'ÂÆΩÂü∫':'Ë∑üÈöèÂ§ßÁõòËµ∞Âäø',
    'Êñ∞ËÉΩÊ∫ê':'ÂÖ≥Ê≥®‰∫ßËÉΩÂë®ÊúüÂíåÊîøÁ≠ñÊãêÁÇπ',
    'Ê∂àË¥π':'ÂÖ≥Ê≥®ÂÜÖÈúÄÂ§çËãè‰ø°Âè∑',
    'ÂåªËçØ':'ÂÖ≥Ê≥®ÂàõÊñ∞ËçØËøõÂ±ï',
  };

  function buildFundTrendDesc(code){
    const hd = fundHistoryData[code];
    if(!hd || !hd.trend) return '';
    const t = hd.trend;
    let desc = `„ÄêÁúüÂÆûÂéÜÂè≤Êï∞ÊçÆÂàÜÊûê„Äë`;
    desc += `Ë∂ãÂäøÊñπÂêë:${t.trendDir}(ËØÑÂàÜ${t.trendScore})`;
    desc += ` | Ëøë5Êó•:${sign(t.chg5d)}${t.chg5d}%`;
    desc += ` | Ëøë20Êó•:${sign(t.chg20d)}${t.chg20d}%`;
    desc += ` | Ëøë60Êó•:${sign(t.chg60d)}${t.chg60d}%`;
    desc += ` | Ëøë250Êó•:${sign(t.chg250d)}${t.chg250d}%`;
    desc += ` | Ë∑ùÂπ¥È´òÁÇπ:${t.drawdownFromHigh}%`;
    desc += ` | Ë∑ùÂπ¥‰ΩéÁÇπ:+${t.reboundFromLow}%`;
    desc += ` | MA5:${t.ma5} MA20:${t.ma20} MA60:${t.ma60} ÊúÄÊñ∞:${t.latest}`;
    desc += ` | Ê≥¢ÊÆµ‰ΩçÁΩÆ:${t.swingPos}`;
    if(t.swingAdvice) desc += ` | Ê≥¢ÊÆµÂª∫ËÆÆ:${t.swingAdvice}`;
    return desc;
  }

  if(holdings.length>0){
    ctx += `\n„ÄêÁî®Êà∑ÊåÅ‰ªìÂü∫Èáë„Äë\n`;
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      const tp = fundType(h.code);
      const trendDesc = buildFundTrendDesc(h.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(h.code)}(${h.code}) - Á±ªÂûã:${tp} - ÊåÅ‰ªì - ‰ªäÊó•:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | ÊùøÂùóÂèÇËÄÉ:${fallback}`;
      ctx += `\n`;
    });
  }

  if(watchlist.length>0){
    ctx += `\n„ÄêÁî®Êà∑Ëá™ÈÄâÂü∫Èáë„Äë\n`;
    watchlist.forEach(w=>{
      const f = getFundData(w.code);
      const tp = fundType(w.code);
      const trendDesc = buildFundTrendDesc(w.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(w.code)}(${w.code}) - Á±ªÂûã:${tp} - Ëá™ÈÄâ - ‰ªäÊó•:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | ÊùøÂùóÂèÇËÄÉ:${fallback}`;
      ctx += `\n`;
    });
  }

  const ownedCodes = new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)]);
  const pool = RECO_FUND_POOL.filter(f=>!ownedCodes.has(f.code)).slice(0,10);
  if(pool.length>0){
    ctx += `\n„ÄêÂÄôÈÄâÂü∫ÈáëÊ±†(ÂèØÊé®ËçêÁªôÁî®Êà∑‰π∞ÂÖ•)„Äë\n`;
    pool.forEach(f=>{ ctx += `${f.name}(${f.code}) - Á±ªÂûã:${f.type} - Ê†áÁ≠æ:${f.tags.join(',')}\n`; });
  }

  // Ê≥®ÂÖ•ÂéÜÂè≤Â§çÁõòÊïôËÆ≠ÔºåËÆ©AI‰ªéËøáÂéªÁöÑÂ§±ËØØ‰∏≠Â≠¶‰π†
  const reviewCtx = buildReviewContext();
  if(reviewCtx) ctx += reviewCtx;

  // Ê≥®ÂÖ•Êï∞ÊçÆÊÉÖÊä•ÔºöÂÆèËßÇÁªèÊµé + ËµÑÈáëÊµÅÂêë + Êñ∞ÈóªËàÜÊÉÖ
  if(_dataIntelLoaded){
    ctx += buildDataIntelContext();
  }

  // Ê≥®ÂÖ•RLÂº∫ÂåñÂ≠¶‰π†‰ø°Âè∑
  if(_rlModelLoaded){
    ctx += buildRLContext();
  }

  // Ê≥®ÂÖ•ÂõûÊµãÁªìÊûú
  if(btSummary){
    ctx += buildBTContext();
  }

  return ctx;
}

function buildDataIntelContext(){
  let ctx = '\n„Äêüì° Êï∞ÊçÆÊÉÖÊä•‰∏≠ÂøÉ ‚Äî Â§öÁª¥Â∫¶ÂàÜÊûê„Äë\n';

  // ÂÆèËßÇÁªèÊµé
  const macro = getMacroSummary();
  ctx += '\n‚ñ† ÂÆèËßÇÁªèÊµéÊåáÊ†á:\n';
  macro.signals.forEach(s=>{
    ctx += `  ${s.name}: ${s.value} (${s.signal}) ${s.positive?'‚úÖ':'‚ö†Ô∏è'}\n`;
  });
  ctx += `  ÁªºÂêàÂÆèËßÇ‰ø°Âè∑: ${macro.overallSignal} (${macro.positiveCount}/5È°πÊ≠£Èù¢)\n`;
  // PMIË∂ãÂäø
  if(macroData.pmi && macroData.pmi.length>=2){
    ctx += `  PMIË∂ãÂäø: ${macroData.pmi.map(d=>d.TIME?.replace('‰ªΩ','')+':'+d.MAKE_INDEX).join(' ‚Üí ')}\n`;
  }
  // CPIË∂ãÂäø
  if(macroData.cpi && macroData.cpi.length>=2){
    ctx += `  CPIË∂ãÂäø: ${macroData.cpi.map(d=>d.TIME?.replace('‰ªΩ','')+':'+d.NATIONAL_SAME+'%').join(' ‚Üí ')}\n`;
  }

  // ÊùøÂùóËµÑÈáëÊµÅÂêë
  const capFlow = getCapFlowSummary();
  if(sectorCapFlow.length>0){
    ctx += '\n‚ñ† ÊùøÂùó‰∏ªÂäõËµÑÈáëÊµÅÂêë(‰ªäÊó•):\n';
    ctx += `  ÂÖ®Â∏ÇÂú∫‰∏ªÂäõÂáÄÊµÅÂÖ•: ${(capFlow.netTotal/1e8).toFixed(1)}‰∫ø\n`;
    capFlow.topInflow.slice(0,5).forEach(s=>{
      ctx += `  üü¢ ${s.name}: +${(s.mainNet/1e8).toFixed(1)}‰∫ø\n`;
    });
    capFlow.topOutflow.slice(0,3).forEach(s=>{
      ctx += `  üî¥ ${s.name}: ${(s.mainNet/1e8).toFixed(1)}‰∫ø\n`;
    });
    // ÂåπÈÖçÁî®Êà∑ÊåÅ‰ªìÁöÑÊùøÂùóËµÑÈáëÊµÅ
    const holdTypes = new Set([...holdings.map(h=>h.type||''), ...watchlist.map(w=>w.type||'')]);
    const relevantFlows = sectorCapFlow.filter(s=> [...holdTypes].some(t=>s.name.includes(t)||t.includes(s.name)));
    if(relevantFlows.length>0){
      ctx += '  [‰∏éÁî®Êà∑ÊåÅ‰ªìÁõ∏ÂÖ≥ÊùøÂùóËµÑÈáëÊµÅ]:\n';
      relevantFlows.forEach(s=>{ ctx += `    ${s.name}: ${(s.mainNet/1e8).toFixed(1)}‰∫ø(‰∏ªÂäõÂáÄÂç†ÊØî${s.mainNetPct}%)\n`; });
    }
  }

  // Êñ∞ÈóªËàÜÊÉÖ
  ctx += '\n‚ñ† Ë¥¢ÁªèÊñ∞ÈóªËàÜÊÉÖÂàÜÊûê(NLP):\n';
  ctx += `  ËàÜÊÉÖÊåáÊï∞: ${newsSentiment.score}/100 (${newsSentiment.label})\n`;
  ctx += `  Âà©Â•ΩÊñ∞Èóª: ${newsSentiment.bullCount}Êù° | Âà©Á©∫Êñ∞Èóª: ${newsSentiment.bearCount}Êù°\n`;
  if(newsHeadlines.length>0){
    ctx += '  [ÈáçË¶ÅË¥¢ÁªèÊñ∞Èóª]:\n';
    newsHeadlines.slice(0,8).forEach(n=>{
      const tag = n.sentiment==='bull'?'üü¢Âà©Â•Ω':n.sentiment==='bear'?'üî¥Âà©Á©∫':'‚ö™‰∏≠ÊÄß';
      ctx += `    ${tag} ${n.title}\n`;
    });
  }

  // ÂõΩÈôÖÊñ∞ÈóªËÅöÂêà
  if(globalNews.length > 0){
    const gSent = getGlobalNewsSentiment();
    ctx += '\n‚ñ† üåç ÂõΩÈôÖÊñ∞ÈóªËÅöÂêà(ÂÖ®ÁêÉÂçÅÂ§ßÂ™í‰Ωì ¬∑ ÊîøÊ≤ªÁªèÊµé):\n';
    ctx += `  ÂõΩÈôÖËàÜÊÉÖÊåáÊï∞: ${gSent.score}/100 (${gSent.label}) Ê≠£Èù¢${gSent.bullCount}Êù°/Ë¥üÈù¢${gSent.bearCount}Êù°/ÂÖ±${gSent.total}Êù°\n`;
    ctx += '  [ÈáçË¶ÅÂõΩÈôÖÊñ∞Èóª]:\n';
    globalNews.slice(0,12).forEach(n=>{
      const tag = n.sentiment==='bull'?'üü¢Ê≠£Èù¢':n.sentiment==='bear'?'üî¥Ë¥üÈù¢':'‚ö™‰∏≠ÊÄß';
      ctx += `    [${n.source}] ${tag} ${n.titleCN||n.title}\n`;
    });
    if(globalNewsSummary){
      ctx += '  [AIÂõΩÈôÖÂΩ¢ÂäøÂàÜÊûêÊëòË¶Å]:\n';
      if(globalNewsSummary.overview) ctx += `    Ê¶ÇËßà: ${globalNewsSummary.overview}\n`;
      if(globalNewsSummary.impact?.positive) ctx += `    Âà©Â•Ω: ${globalNewsSummary.impact.positive.join('; ')}\n`;
      if(globalNewsSummary.impact?.negative) ctx += `    Âà©Á©∫: ${globalNewsSummary.impact.negative.join('; ')}\n`;
      if(globalNewsSummary.impact?.sectors) ctx += `    ÂèóÂΩ±ÂìçÊùøÂùó: ${globalNewsSummary.impact.sectors.join('„ÄÅ')}\n`;
      if(globalNewsSummary.advice) ctx += `    ÊäïËµÑÂª∫ËÆÆ: ${globalNewsSummary.advice.join('; ')}\n`;
      ctx += `    AIËØÑÂàÜ: ${globalNewsSummary.score||50}/100\n`;
    }
  }

  // ÁªºÂêàÊï∞ÊçÆ‰ø°Âè∑
  const dataSignal = generateDataSignal();
  ctx += `\n‚ñ† ÁªºÂêàÊï∞ÊçÆ‰ø°Âè∑: ${dataSignal.icon} ${dataSignal.label} (ËØÑÂàÜ${dataSignal.score}/100)\n`;
  ctx += `  Âª∫ËÆÆ: ${dataSignal.advice}\n`;
  ctx += '\n‚ö†Ô∏è ËØ∑ÁªìÂêà‰ª•‰∏äÂÆèËßÇÊï∞ÊçÆ„ÄÅËµÑÈáëÊµÅÂêë„ÄÅÂõΩÂÜÖËàÜÊÉÖ‰ª•ÂèäÂõΩÈôÖÊñ∞ÈóªÂΩ¢ÂäøÂàÜÊûêÔºåÂØπ‰Ω†ÁöÑÊìç‰ΩúÂª∫ËÆÆËøõË°åÈ™åËØÅÂíåË∞ÉÊï¥„ÄÇÊï∞ÊçÆÈ©±Âä®ÂÜ≥Á≠ñÔºåÂáèÂ∞ë‰∏ªËßÇÂÅèÂ∑Æ„ÄÇ\n';

  return ctx;
}


const SYSTEM_PROMPT = `‰Ω†ÊòØ‰∏Ä‰ΩçÊìÖÈïøÊ≥¢ÊÆµÊìç‰ΩúÂíåË∂ãÂäøË∑üË∏™ÁöÑÂü∫ÈáëÊäïËµÑÈ°æÈóÆÔºåÊã•Êúâ‰∏∞ÂØåÁöÑÈáèÂåñÂàÜÊûêÂíåÂ§öÂõ†Â≠êÊ®°ÂûãÁªèÈ™å„ÄÇÁî®Êà∑ÁöÑÊ†∏ÂøÉÁõÆÊ†áÊòØÔºö3‰∏™ÊúàÂÜÖÂÆûÁé∞Á®≥ÂÅ•Â¢ûÈïøÔºåË∑ëËµ¢Ê≤™Ê∑±300ÊåáÊï∞„ÄÇ

‚ñ† ‰Ω†ÁöÑÊï∞ÊçÆÊ∫êÔºàÊåâÈáçË¶ÅÂ∫¶ÊéíÂ∫èÔºâÔºö
1. Â∏ÇÂú∫Êï∞ÊçÆÔºöÂü∫ÈáëÂéÜÂè≤ÂáÄÂÄº(NAV)Ë∂ãÂäøÂàÜÊûê„ÄÅÁõ∏ÂÖ≥ÊåáÊï∞(Ê≤™Ê∑±300/‰∏äËØÅ/Âàõ‰∏öÊùø)Ë°åÊÉÖ„ÄÅETFÂÆûÊó∂‰ª∑Ê†º
2. ÂÆèËßÇÁªèÊµéÊï∞ÊçÆÔºöPMI(Âà∂ÈÄ†‰∏öÊôØÊ∞îÂ∫¶)„ÄÅCPI/PPI(ÈÄöËÉÄ)„ÄÅGDPÂ¢ûÈÄü„ÄÅM2Ë¥ßÂ∏Å‰æõÂ∫î(ÊµÅÂä®ÊÄß)
3. Âè¶Á±ªÊï∞ÊçÆÔºöÊùøÂùó‰∏ªÂäõËµÑÈáëÊµÅÂêë(Ë∂ÖÂ§ßÂçï/Â§ßÂçï/‰∏≠Âçï/Â∞èÂçï)„ÄÅË¥¢ÁªèÊñ∞ÈóªNLPÊÉÖÁª™ÂàÜÊûê(Âà©Â•Ω/Âà©Á©∫ËØÜÂà´)„ÄÅÁ§æ‰∫§ËàÜÊÉÖÁÉ≠Â∫¶ÊåáÊï∞
4. ÂéÜÂè≤Â§çÁõòÔºöËøáÂæÄAIÈ¢ÑÊµãvsÂÆûÈôÖÊ∂®Ë∑åÂØπÊØî„ÄÅÂáÜÁ°ÆÁéáÁªüËÆ°„ÄÅÈîôËØØÊïôËÆ≠
5. RLÂº∫ÂåñÂ≠¶‰π†‰ø°Âè∑ÔºöÂü∫‰∫éDouble DQN(18Áª¥Áä∂ÊÄÅÁ©∫Èó¥Âê´ÂõûÊµãÁâπÂæÅ)ËÆ≠ÁªÉÁöÑÁ≠ñÁï•ÁΩëÁªúÔºåÁõ¥Êé•ËæìÂá∫‰π∞ÂÖ•/ÂçñÂá∫/ÊåÅÊúâÂÜ≥Á≠ñÂèäQÂÄºÁΩÆ‰ø°Â∫¶ÔºåÊîØÊåÅÂú®Á∫øÂ≠¶‰π†ÂèçÈ¶à
6. Á≠ñÁï•ÂõûÊµã(Backtesting)ÔºöÂü∫‰∫éÂéÜÂè≤NAVÁöÑRSIÁ≠ñÁï•ÂõûÊµãÁªìÊûúÔºåËûçÂêàRL‰ø°Âè∑‰Ωú‰∏∫ËæÖÂä©Êù°‰ª∂ÔºåÂåÖÊã¨Sharpe Ratio„ÄÅÊúÄÂ§ßÂõûÊí§„ÄÅËÉúÁéá„ÄÅÂáØÂà©‰ªì‰Ωç„ÄÇÂõûÊµãSharpe<0ÁöÑÂìÅÁßçÈúÄÁâπÂà´Ë∞®ÊÖé
7. ‰∏âÂºïÊìéÊäïÁ•®ÂÖ±ËØÜÔºöAI/RL/ÂõûÊµã‰∏âÁ≥ªÁªüÂä†ÊùÉÊäïÁ•®ÂÜ≥Á≠ñÔºåÂÖ®Á•®‰∏ÄËá¥Êó∂Âä†Â§ß‰ªì‰ΩçÔºà√ó1.4ÔºâÔºåÊúâÂàÜÊ≠ßÊó∂Áº©Âáè‰ªì‰ΩçÔºà√ó0.4Ôºâ

‚ñ† Ê†∏ÂøÉÊäïËµÑÈÄªËæëÔºà‰Ω†ÂøÖÈ°ªÈÅµÂÆàÔºâÔºö
1. Ë∂ãÂäø‰∏∫ÁéãÔºöÂÖàÂà§Êñ≠ÊØè‰∏™ÊùøÂùó/Âü∫ÈáëÁöÑ‰∏≠ÊúüË∂ãÂäøÔºà3‰∏™ÊúàÁª¥Â∫¶ÔºâÊòØ‰∏äÂçá„ÄÅÈúáËç°ËøòÊòØ‰∏ãÈôç
2. ÈÄ¢Ë∑å‰π∞ÂÖ•ÔºöÂ¶ÇÊûú‰∏≠ÊúüË∂ãÂäøÂêë‰∏äÔºåÁü≠ÊúüÂ§ßË∑å(‚â•1.5%)ÊòØÂä†‰ªì/Âª∫‰ªìÁöÑÂ•ΩÊú∫‰ºöÔºåËÄå‰∏çÊòØÂáè‰ªì‰ø°Âè∑ÔºÅ
3. ÈÄ¢Ê∂®Ê≠¢ÁõàÔºöÂ¶ÇÊûúÁü≠ÊúüÊ∂®ÂπÖËøáÂ§ß(ËøûÁª≠‰∏äÊ∂®ÊàñÂçïÊó•>3%)ÔºåÂ∫îËÄÉËôëÈÉ®ÂàÜÊ≠¢ÁõàËÄåÈùûËøΩÈ´ò
4. Ê≥¢ÊÆµÊÄùÁª¥ÔºöÊ†∏ÂøÉ‰ªì‰Ωç(ÂÆΩÂü∫/Á∫¢Âà©/ÈªÑÈáë)ÈïøÊåÅ‰∏çÂä®ÔºåÂç´Êòü‰ªì‰Ωç(Ë°å‰∏ö‰∏ªÈ¢ò)ÂÅöÊ≥¢ÊÆµ‚Äî‚Äî‰ΩéÂê∏È´òÊäõ
5. ‰ªì‰ΩçÁÆ°ÁêÜÔºöÂª∫ËÆÆÂ∞ÜÊåÅ‰ªìÂàÜ‰∏∫Ê†∏ÂøÉ‰ªì(~60%Á®≥ÂÅ•ÂéãËà±Áü≥)ÂíåÂç´Êòü‰ªì(~40%ÂºπÊÄßËøõÊîª)
6. Ë∂ãÂäøÊãêÁÇπÔºöÂè™ÊúâÂΩì‰∏≠ÊúüË∂ãÂäøÁ°ÆËÆ§ËΩ¨Âêë‰∏ãË°åÊó∂ÔºåÊâçÂª∫ËÆÆÂáè‰ªì

‚ñ† Êìç‰ΩúÂÜ≥Á≠ñÊ°ÜÊû∂Ôºö
- ‰∏≠ÊúüË∂ãÂäø‚Üë + ‰ªäÊó•Â§ßË∑å ‚Üí buy(Âä†‰ªì/‰ΩéÂê∏) ‚úÖ
- ‰∏≠ÊúüË∂ãÂäø‚Üë + ‰ªäÊó•Â§ßÊ∂® ‚Üí holdÊàñsell(ÈÉ®ÂàÜÊ≠¢Áõà)
- ‰∏≠ÊúüË∂ãÂäø‚Üë + ‰ªäÊó•Âπ≥Á®≥ ‚Üí hold(ÊåÅÊúâ)
- ‰∏≠ÊúüË∂ãÂäø‚Üí + ‰ªäÊó•Â§ßË∑å ‚Üí holdÊàñbuy(Â∞è‰ªìËØïÊé¢)
- ‰∏≠ÊúüË∂ãÂäø‚Üì + ‰ªª‰ΩïÊÉÖÂÜµ ‚Üí sell(Âáè‰ªìÈÅøÈô©)

‚ñ† ‰ªì‰ΩçÂàÜÁ±ªÊåáÂºïÔºö
- Ê†∏ÂøÉ‰ªì(ÂéãËà±Áü≥)ÔºöÂÆΩÂü∫ÊåáÊï∞(A500/Ê≤™Ê∑±300/‰∏≠ËØÅ500)„ÄÅÁ∫¢Âà©‰ΩéÊ≥¢„ÄÅÈªÑÈáë ‚Üí ÈïøÊåÅÔºåÂè™Âú®ÊûÅÁ´ØÊÉÖÂÜµË∞ÉÊï¥
- Âç´Êòü‰ªì(ÂºπÊÄß)ÔºöAI/ÁßëÊäÄ„ÄÅÊúâËâ≤ÈáëÂ±û„ÄÅÂÜõÂ∑•„ÄÅÂçäÂØº‰Ωì„ÄÅÊñ∞ËÉΩÊ∫êÁ≠âË°å‰∏ö‰∏ªÈ¢ò ‚Üí ÁßØÊûÅÊ≥¢ÊÆµÊìç‰ΩúÔºå‰ΩéÂê∏È´òÊäõ

‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãJSONÊ†ºÂºèÂõûÂ§çÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÈ¢ùÂ§ñÁöÑÊñáÂ≠óÊàñmarkdownÊ†áËÆ∞Ôºö
{
  "marketSummary": "80-120Â≠óÁöÑÂ∏ÇÂú∫ÊÄªÁªìÔºåËÅöÁÑ¶ÂØπÁî®Êà∑ÊåÅ‰ªìÁöÑÂΩ±ÂìçÂíå3‰∏™ÊúàÂ±ïÊúõ",
  "benchmarkView": "Ê≤™Ê∑±300Êú™Êù•3‰∏™ÊúàËµ∞ÂäøÂà§Êñ≠(30Â≠ó)",
  "portfolioAdvice": {
    "coreRatio": "Âª∫ËÆÆÊ†∏ÂøÉ‰ªìÂç†ÊØîÔºåÂ¶Ç60%",
    "satRatio": "Âª∫ËÆÆÂç´Êòü‰ªìÂç†ÊØîÔºåÂ¶Ç40%",
    "advice": "30-50Â≠óÁöÑÊï¥‰Ωì‰ªì‰ΩçË∞ÉÊï¥Âª∫ËÆÆ"
  },
  "signals": [
    {
      "code": "Âü∫Èáë‰ª£Á†Å",
      "posType": "core/satellite",
      "action": "buy/sell/hold",
      "urgency": "today/this_week/no_rush",
      "confidence": 60-95,
      "trend": "up/sideways/down",
      "reason": "60-120Â≠óÁêÜÁî±Ôºö‚ë†ÂÖàËØ¥‰∏≠ÊúüË∂ãÂäøÂà§Êñ≠ ‚ë°ÂÜçÁªìÂêà‰ªäÊó•Ë°®Áé∞ÁªôÂá∫Êìç‰ΩúÈÄªËæë ‚ë¢ËØ¥ÊòéÂ¶Ç‰ΩïÂ∏ÆÂä©Ë∑ëËµ¢Ê≤™Ê∑±300",
      "target3m": "+X%~+Y%"
    }
  ],
  "newPicks": [
    {
      "code": "Êé®ËçêÂü∫Èáë‰ª£Á†Å(ÂøÖÈ°ª‰ªéÂÄôÈÄâÊ±†‰∏≠ÈÄâ)",
      "reason": "40-60Â≠óÊé®ËçêÁêÜÁî±",
      "expected3m": "+X%~+Y%"
    }
  ]
}

Ë¶ÅÊ±ÇÔºö
1. signalsÂøÖÈ°ªË¶ÜÁõñÁî®Êà∑ÊâÄÊúâÊåÅ‰ªìÂíåËá™ÈÄâÂü∫ÈáëÔºåcode‰∏éÁî®Êà∑Êèê‰æõÁöÑÂÆåÂÖ®‰∏ÄËá¥
2. action: buy=Âä†‰ªì/Âª∫‰ªì, sell=Âáè‰ªì/Ê≠¢Áõà, hold=ÊåÅÊúâ‰∏çÂä®
3. posType: core=Ê†∏ÂøÉ‰ªì(Âª∫ËÆÆÈïøÊåÅ), satellite=Âç´Êòü‰ªì(Âª∫ËÆÆÊ≥¢ÊÆµ)
4. trend: up=‰∏≠ÊúüË∂ãÂäøÂêë‰∏ä, sideways=ÈúáËç°, down=Ë∂ãÂäøÂêë‰∏ã
5. urgency: today=‰ªäÊó•Êî∂ÁõòÂâçÊìç‰Ωú, this_week=Êú¨Âë®ÂÜÖ, no_rush=‰∏çÊÄ•
6. confidence: 60-95‰πãÈó¥ÁöÑÊï¥Êï∞
7. reasonÂøÖÈ°ªÂåÖÂê´Ë∂ãÂäøÂà§Êñ≠+Êìç‰ΩúÈÄªËæëÔºå‰∏çËÉΩ‰ªÖÂá≠‰ªäÊó•Ê∂®Ë∑åÂÅöÂà§Êñ≠
8. ÁâπÂà´Ê≥®ÊÑèÔºöË∂ãÂäøÂêë‰∏äÁöÑÂìÅÁßçÁü≠ÊúüÂõûË∞ÉÊòØ‰π∞ÂÖ•Êú∫‰ºöÔºå‰∏çË¶ÅÂõ†‰∏∫‰ªäÂ§©Ë∑å‰∫ÜÂ∞±Âª∫ËÆÆÂáè‰ªìÔºÅ
9. newPicksÊúÄÂ§öÊé®Ëçê3Âè™Ôºå‰ªéÂÄôÈÄâÊ±†‰∏≠ÈÄâÊã©ÂΩìÂâçË¢´‰Ωé‰º∞ÊàñÊúâÊ≥¢ÊÆµÊú∫‰ºöÁöÑ
10. Âè™ËæìÂá∫JSONÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñ‰ªª‰ΩïÊñáÂ≠ó`;

const ROLE_DESCS = {
  engine1: '‰Ω†ÁâπÂà´ÊìÖÈïøÊäÄÊúØÂàÜÊûê„ÄÅÈáèÂåñÂõ†Â≠êÂíåË∂ãÂäøË∑üË∏™„ÄÇËØ∑ÈáçÁÇπÂàÜÊûêÔºö‚ë†ÊØè‰∏™Âü∫ÈáëÊâÄÂ±ûÊùøÂùóÁöÑ‰∏≠ÊúüË∂ãÂäøÔºàËøáÂéª1-3‰∏™ÊúàËµ∞ÂäøÊñπÂêë+ÂùáÁ∫øÁ≥ªÁªüÔºâ‚ë°ÂΩìÂâçÂ§Ñ‰∫éË∂ãÂäø‰∏≠ÁöÑ‰ªÄ‰πà‰ΩçÁΩÆÔºàÂõûË∞É‰ΩéÁÇπÔºü‰∏äÂçá‰∏≠ÈÄîÔºüÈ´ò‰ΩçÔºüÔºâ‚ë¢Áü≠ÊúüÂõûË∞ÉÊòØÂê¶ÊòØ‰∏äÂçáË∂ãÂäø‰∏≠ÁöÑ‰π∞ÂÖ•Êú∫‰ºö„ÄÇËØ∑ÁâπÂà´ÂÖ≥Ê≥®Êï∞ÊçÆÊÉÖÊä•‰∏≠ÁöÑ„ÄåÊùøÂùó‰∏ªÂäõËµÑÈáëÊµÅÂêë„ÄçÂíå„ÄåÂéÜÂè≤NAVË∂ãÂäøÊï∞ÊçÆ„Äç„ÄÇÂ¶ÇÊûúËµÑÈáëÊåÅÁª≠ÊµÅÂÖ•+‰∏≠ÊúüË∂ãÂäøÂêë‰∏ä+Áü≠ÊúüÂõûË∞ÉÔºåËøôÊòØÂº∫‰π∞ÂÖ•‰ø°Âè∑„ÄÇ',
  engine2: '‰Ω†ÁâπÂà´ÊìÖÈïøÂÆèËßÇÁªèÊµéÂíåÊîøÁ≠ñÈù¢ÂàÜÊûê„ÄÇËØ∑ÈáçÁÇπÂÖ≥Ê≥®Êï∞ÊçÆÊÉÖÊä•‰∏≠ÁöÑ„ÄåÂÆèËßÇÁªèÊµéÊåáÊ†á„ÄçÔºö‚ë†PMIÊòØÂê¶Âú®Ëç£ÊûØÁ∫ø‰∏äÊñπÔºàÂà∂ÈÄ†‰∏öÊôØÊ∞îÂ∫¶Áõ¥Êé•ÂΩ±ÂìçÂë®ÊúüËÇ°Ôºâ‚ë°CPI/PPIËµ∞ÂäøÔºàÈÄöËÉÄÁéØÂ¢ÉÂà©Â•ΩÊúâËâ≤ÈáëÂ±û/ËµÑÊ∫êÁ±ªÔºâ‚ë¢M2Â¢ûÈÄüÔºàÊµÅÂä®ÊÄßÊòØÂê¶ÂÆΩÊùæÔºåÂÆΩÊùæÁéØÂ¢ÉÂà©Â•ΩÊàêÈïøËÇ°Ôºâ‚ë£GDPÂ¢ûÈÄüË∂ãÂäø„ÄÇÁªìÂêàÂÆèËßÇÊï∞ÊçÆÂà§Êñ≠ÂêÑË°å‰∏öÊùøÂùóÁöÑ‰∏≠ÊúüÊîøÁ≠ñÈ©±Âä®Âäõ„ÄÇ',
  engine3: '‰Ω†ÁâπÂà´ÊìÖÈïøÊ∑±Â∫¶Âü∫Êú¨Èù¢ÂíåË°å‰∏öÁ†îÁ©∂„ÄÇËØ∑ÈáçÁÇπÂàÜÊûêÔºö‚ë†ÂêÑË°å‰∏öÁöÑÊôØÊ∞îÂ∫¶Âë®Êúü‰ΩçÁΩÆÔºàÁªìÂêàPMI„ÄÅPPIÊï∞ÊçÆÈ™åËØÅÔºâ‚ë°ÊùøÂùó‰∏ªÂäõËµÑÈáëÂçïÊµÅÂêëÊòØÂê¶Á°ÆËÆ§Ë°å‰∏öÊôØÊ∞îÔºàÂ§ßËµÑÈáëÊåÅÁª≠ÊµÅÂÖ•=Êú∫ÊûÑËÆ§ÂêåÔºâ‚ë¢ÁõàÂà©Ë∂ãÂäøÊòØÂê¶ÊîØÊíë‰∏≠Êúü‰∏äÊ∂®„ÄÇÂØπ‰∫éÊôØÊ∞î‰∏äË°åÊúü+ËµÑÈáëÊµÅÂÖ•ÁöÑË°å‰∏öÔºåÁü≠ÊúüÊ≥¢Âä®‰∏çÊîπÈïøÊúüË∂ãÂäø‚Äî‚ÄîÂ§ßË∑åÊòØ‰π∞ÂÖ•Êú∫‰ºö„ÄÇ',
  engine4: '‰Ω†ÁâπÂà´ÊìÖÈïøÂÖ®ÁêÉËßÜËßí„ÄÅËµÑÈáëÊµÅÂêëÂíåËàÜÊÉÖÂàÜÊûê„ÄÇËØ∑ÈáçÁÇπÂÖ≥Ê≥®Ôºö‚ë†Êï∞ÊçÆÊÉÖÊä•‰∏≠ÁöÑ„ÄåË¥¢ÁªèÊñ∞ÈóªËàÜÊÉÖ„ÄçÔºàNLPÊÉÖÁª™ÊåáÊï∞ÂÅèÂ§öËøòÊòØÂÅèÁ©∫ÔºüÔºâ‚ë°ÊùøÂùóËµÑÈáëÊµÅÂêë‰∏≠ÁöÑÂ§ßÂçïË∂ÖÂ§ßÂçïÊñπÂêëÔºà‰ª£Ë°®Êú∫ÊûÑÊÄÅÂ∫¶Ôºâ‚ë¢ÂÖ®ÁêÉÂ§ßÂÆóÂïÜÂìÅËµ∞Âäø+Âú∞ÁºòÈ£éÈô© ‚ë£Êñ∞Èóª‰∏≠ÊèêÂà∞ÁöÑÈ£éÈô©ÁÇπÂíåÂÇ¨ÂåñÂâÇ„ÄÇÁªìÂêàËàÜÊÉÖÁªºÂêà‰ø°Âè∑ÁªôÂá∫È£éÈô©Ë∞ÉÊï¥ÂêéÁöÑ‰ªì‰ΩçÂª∫ËÆÆ„ÄÇ'
};

async function runAIAnalysis(onProgress){
  if(_analyzing) return;
  _analyzing = true;

  const ctx = buildContext();
  const results = {};
  let done = 0;

  const promises = AI_ENGINES.map(async (eng) => {
    try {
      const roleMsg = ROLE_DESCS[eng.id] || '';
      const userMsg = `${roleMsg}\n\n${ctx}\n\nËØ∑Âü∫‰∫é‰ª•‰∏äÊï∞ÊçÆÂíå‰Ω†ÁöÑ‰∏ì‰∏öÁü•ËØÜÔºåÁªôÂá∫Êìç‰ΩúÂª∫ËÆÆ„ÄÇ`;
      if(onProgress) onProgress(`${eng.icon} ${eng.name} ÂàÜÊûê‰∏≠...`, ++done);

      const raw = await callAI(eng.model, SYSTEM_PROMPT, userMsg, 0.7);

      let jsonStr = raw.trim();
      // Remove <think>...</think> blocks if present
      jsonStr = jsonStr.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
      if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if(!jsonMatch) throw new Error('No JSON');
      const parsed = JSON.parse(jsonMatch[0]);
      results[eng.id] = parsed;
      if(onProgress) onProgress(`‚úÖ ${eng.name} ÂÆåÊàê`, done);
    } catch(e) {
      console.error(`${eng.name} failed:`, e);
      if(onProgress) onProgress(`‚ö†Ô∏è ${eng.name} Â§±Ë¥•`, done);
    }
  });

  await Promise.all(promises);
  _analyzing = false;

  const successCount = Object.keys(results).length;
  if(successCount === 0) throw new Error('ÊâÄÊúâAIÂºïÊìéË∞ÉÁî®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•API KeyÂíåÁΩëÁªú');

  return synthesize(results);
}

function synthesize(results){
  const engines = Object.keys(results);
  const total = engines.length;

  const summaries = engines.map(e=>results[e].marketSummary).filter(Boolean);
  const benchViews = engines.map(e=>results[e].benchmarkView).filter(Boolean);

  // Merge signals per fund code
  const signalMap = {};
  engines.forEach(engId=>{
    const r = results[engId];
    (r.signals||[]).forEach(s=>{
      if(!signalMap[s.code]) signalMap[s.code] = [];
      signalMap[s.code].push({...s, engine:engId});
    });
  });

  // Synthesize per fund
  const synthesizedSignals = {};
  Object.keys(signalMap).forEach(code=>{
    const sigs = signalMap[code];
    const actions = sigs.map(s=>s.action);
    const buyCount = actions.filter(a=>a==='buy').length;
    const sellCount = actions.filter(a=>a==='sell').length;
    const holdCount = actions.filter(a=>a==='hold').length;

    // Ë∂ãÂäøÊäïÁ•®Ôºö‰ºòÂÖàÁî®ÁúüÂÆûÂéÜÂè≤Êï∞ÊçÆÔºåÂêéÂ§áÁî®AIÂºïÊìéÊäïÁ•®
    const realTrend = fundHistoryData[code]?.trend;
    let trendConsensus;
    let todayPct;
    if(realTrend){
      // ‰ΩøÁî®ÁúüÂÆûËÆ°ÁÆóÁöÑË∂ãÂäøÊñπÂêë
      trendConsensus = (realTrend.trendDir==='strong_up'||realTrend.trendDir==='up') ? 'up'
        : (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') ? 'down' : 'sideways';
      // ‰ΩøÁî®ÁúüÂÆû5Êó•Ê∂®Ë∑å‰Ωú‰∏∫Ê≥¢ÊÆµÂèÇËÄÉ
      todayPct = getFundData(code)?.gszzl || 0;
    } else {
      // ÂêéÂ§áÔºöAIÂºïÊìéÊäïÁ•®
      const trends = sigs.map(s=>s.trend).filter(Boolean);
      const upTrends = trends.filter(t=>t==='up').length;
      const downTrends = trends.filter(t=>t==='down').length;
      trendConsensus = upTrends > downTrends ? 'up' : downTrends > upTrends ? 'down' : 'sideways';
      todayPct = getFundData(code)?.gszzl || 0;
    }

    let action = 'hold';
    if(buyCount > total/2) action = 'buy';
    else if(sellCount > total/2) action = 'sell';
    else if(buyCount > sellCount) action = 'buy';
    else if(sellCount > buyCount) action = 'sell';
    else {
      // ÊâìÂπ≥ÊàñÂÖ®holdÊó∂ÔºåÁî®Ë∂ãÂäø+‰ªäÊó•Ë°®Áé∞ÂÅö‰øÆÊ≠£
      // Ë∂ãÂäøÂêë‰∏ä + ‰ªäÊó•Â§ßË∑å(‚â•1.5%) ‚Üí Âä†‰ªìÊú∫‰ºö
      if(trendConsensus === 'up' && todayPct <= -1.5 && buyCount >= 1) action = 'buy';
      // Ë∂ãÂäøÂêë‰∏ã + ‰ªäÊó•Â§ßÊ∂® ‚Üí Âáè‰ªì
      else if(trendConsensus === 'down' && todayPct >= 1.5 && sellCount >= 1) action = 'sell';
    }

    // È¢ùÂ§ñ‰øÆÊ≠£ÔºöÂ¶ÇÊûúË∂ãÂäøÂêë‰∏ä‰∏î‰ªäÊó•Ë∑åÂπÖ‚â•2%ÔºåÂç≥‰ΩøholdÂ§öÊï∞‰πüÂçáÁ∫ß‰∏∫buyÔºàÊ≥¢ÊÆµÈÄªËæëÊ†∏ÂøÉÔºâ
    if(trendConsensus === 'up' && todayPct <= -2.0 && action === 'hold' && buyCount >= 1) {
      action = 'buy';
    }
    // ÁúüÂÆûÊï∞ÊçÆÂ¢ûÂº∫ÔºöÂ¶ÇÊûúÊúâÂéÜÂè≤Êï∞ÊçÆ‰∏îË∂ãÂäøÊòØstrong_upÔºåË∑åÂπÖ‚â•1.2%Â∞±Ëß¶Âèë‰π∞ÂÖ•
    if(realTrend && (realTrend.trendDir==='strong_up') && todayPct <= -1.2 && action === 'hold') {
      action = 'buy';
    }
    // ÁúüÂÆûÊï∞ÊçÆÂ¢ûÂº∫ÔºöÂ¶ÇÊûúË∂ãÂäødown‰∏îËøë5Êó•ËøòÂú®Ë∑åÔºåÂº∫Âà∂sellÔºàÈô§ÈùûÊâÄÊúâAIÂºïÊìéÈÉΩ‰∏çÂª∫ËÆÆsellÔºâ
    if(realTrend && (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') && realTrend.chg5d < -2 && action === 'hold' && sellCount >= 1) {
      action = 'sell';
    }

    const urgencyOrder = {today:3, this_week:2, no_rush:1};
    const matchingSigs = sigs.filter(s=>s.action===action);
    const urgency = matchingSigs.length>0
      ? matchingSigs.sort((a,b)=>(urgencyOrder[b.urgency]||0)-(urgencyOrder[a.urgency]||0))[0].urgency
      : 'no_rush';

    const conf = matchingSigs.length>0
      ? Math.round(matchingSigs.reduce((s,x)=>s+(x.confidence||70),0)/matchingSigs.length)
      : 50;

    const bestReason = matchingSigs.sort((a,b)=>(b.reason?.length||0)-(a.reason?.length||0))[0]?.reason || 'ÊöÇÊó†ÂàÜÊûê';

    const target = matchingSigs.find(s=>s.target3m)?.target3m || '';

    const breakdown = sigs.map(s=>{
      const eng = AI_ENGINES.find(e=>e.id===s.engine);
      return `${eng?.icon||'ü§ñ'}${eng?.name||s.engine}: ${s.action==='buy'?'ÁúãÂ§ö':s.action==='sell'?'ÁúãÁ©∫':'‰∏≠ÊÄß'}`;
    }).join(' ¬∑ ');

    synthesizedSignals[code] = {
      action, urgency, confidence:conf, reason:bestReason,
      target3m:target, breakdown,
      posType: sigs[0]?.posType || (fundType(code).match(/ÂÆΩÂü∫|Á∫¢Âà©|ÈªÑÈáë/) ? 'core' : 'satellite'),
      trend: realTrend ? trendConsensus : (sigs.filter(s=>s.trend).map(s=>s.trend).sort((a,b)=>({'up':3,'sideways':2,'down':1}[b]||0)-({'up':3,'sideways':2,'down':1}[a]||0))[0] || 'sideways'),
      trendDetail: realTrend || null,
      buyCount, sellCount, holdCount, total
    };
  });

  // Merge new picks
  const pickMap = {};
  engines.forEach(engId=>{
    (results[engId].newPicks||[]).forEach(p=>{
      if(!pickMap[p.code]) pickMap[p.code] = {code:p.code, reasons:[], expected:[], count:0};
      pickMap[p.code].reasons.push(p.reason);
      pickMap[p.code].expected.push(p.expected3m);
      pickMap[p.code].count++;
    });
  });
  const picks = Object.values(pickMap)
    .sort((a,b)=>b.count-a.count)
    .slice(0,3)
    .map(p=>({
      code:p.code,
      name: fundName(p.code),
      type: fundType(p.code),
      reason: p.reasons[0],
      expected3m: p.expected[0]||'',
      endorsements: p.count
    }));

  // Merge portfolio advice
  const portAdvices = engines.map(e=>results[e].portfolioAdvice).filter(Boolean);
  const portfolioAdvice = portAdvices[0] || null;

  return {
    marketSummary: summaries[0] || '',
    benchmarkView: benchViews[0] || '',
    portfolioAdvice,
    signals: synthesizedSignals,
    picks,
    engineCount: total,
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
}

// ==================== RENDERING ====================
function renderAll(){
  renderCountdown();
  renderIndices();
  renderStats();
  renderPortfolio();
  renderSimBrief();
  renderActionGuide();
  renderSignals();
  renderWatchlist();
  renderRecos();
  renderReview();
}

function switchPfTab(tab){
  document.getElementById('pf-tab-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-tab-sat').classList.toggle('active', tab==='satellite');
  document.getElementById('pf-group-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-group-satellite').classList.toggle('active', tab==='satellite');
}

function renderPortfolio(){
  ['core','satellite'].forEach(groupKey=>{
    const group = MODEL_PORTFOLIO[groupKey];
    const container = document.getElementById(`pf-group-${groupKey}`);
    let html = `<div class="pf-group-desc">${group.desc}</div>`;

    group.funds.forEach(pf=>{
      const f = getFundData(pf.code);
      const td = fundHistoryData[pf.code]?.trend;
      const isHeld = holdings.some(h=>h.code===pf.code);
      const isWatched = watchlist.some(w=>w.code===pf.code);

      // Swing signal from trend data
      let swingClass = 'hold', swingText = 'Á≠âÂæÖÊï∞ÊçÆ';
      if(td){
        if(td.swingAdvice && td.swingAdvice.includes('‰π∞ÂÖ•')){
          swingClass = 'buy'; swingText = '‚ö° Ê≥¢ÊÆµ‰π∞ÂÖ•';
        } else if(td.swingAdvice && (td.swingAdvice.includes('Ê≠¢Áõà') || td.swingAdvice.includes('Âáè‰ªì'))){
          swingClass = 'sell'; swingText = 'üì§ ËÄÉËôëÊ≠¢Áõà';
        } else if(td.swingAdvice && td.swingAdvice.includes('‰∏çÂª∫ËÆÆ')){
          swingClass = 'sell'; swingText = '‚õî ÊöÇÈÅø';
        } else if(td.trendDir==='strong_up'||td.trendDir==='up'){
          swingClass = 'hold'; swingText = 'üìà Ë∂ãÂäøÂêë‰∏ä';
        } else if(td.trendDir==='strong_down'||td.trendDir==='down'){
          swingClass = 'sell'; swingText = 'üìâ Ë∂ãÂäøÂÅèÂº±';
        } else {
          swingClass = 'hold'; swingText = 'üìä ÈúáËç°ËßÇÊúõ';
        }
      }

      // Trend metrics
      let trendHtml = '';
      if(td){
        const mkVal = (v) => `<span style="color:${v>0?'var(--red)':v<0?'var(--green)':'var(--sub)'}">${v>0?'+':''}${v}%</span>`;
        trendHtml = `<div class="pf-trend-row">
          <div class="pf-trend-item"><span class="pf-trend-label">5Êó•</span>${mkVal(td.chg5d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">20Êó•</span>${mkVal(td.chg20d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">60Êó•</span>${mkVal(td.chg60d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">Âπ¥</span>${mkVal(td.chg250d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">Ë∑ùÈ´òÁÇπ</span><span style="color:var(--sub)">${td.drawdownFromHigh}%</span></div>
        </div>`;
        if(td.swingAdvice){
          const advColor = td.swingAdvice.includes('‰π∞ÂÖ•')?'var(--red)':td.swingAdvice.includes('Âáè‰ªì')||td.swingAdvice.includes('‰∏çÂª∫ËÆÆ')?'var(--green)':'var(--sub)';
          trendHtml += `<div style="font-size:10px;color:${advColor};margin-top:4px">üí° ${td.swingAdvice}</div>`;
        }
      }

      // Action buttons
      let actHtml = '';
      if(isHeld){
        actHtml = `<span class="pf-act-btn in-hold">‚úì Â∑≤ÊåÅ‰ªì</span>`;
      } else {
        actHtml = `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','holding')">+ Âä†ÂÖ•ÊåÅ‰ªì</button>`;
      }
      if(isWatched){
        actHtml += `<span class="pf-act-btn in-watch">‚úì Â∑≤Ëá™ÈÄâ</span>`;
      } else if(!isHeld){
        actHtml += `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','watch')">+ Ëá™ÈÄâ</button>`;
      }

      html += `<div class="pf-card swing-${swingClass}">
        <div class="pf-top">
          <div class="pf-info">
            <div class="pf-name">${pf.name}</div>
            <div class="pf-code">${pf.code} ¬∑ ${pf.type} ¬∑ Âª∫ËÆÆÈÖçÁΩÆ${pf.alloc}</div>
          </div>
          <div class="pf-right">
            <div class="pf-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
            <div class="pf-swing-tag ${swingClass}">${swingText}</div>
          </div>
        </div>
        <div class="pf-reason">${pf.reason}</div>
        ${trendHtml}
        <div class="pf-actions">${actHtml}</div>
      </div>`;
    });

    container.innerHTML = html;
  });
}

function addFromPortfolio(code, name, type, mode){
  if(mode==='holding'){
    if(holdings.some(h=>h.code===code)) return;
    holdings.push({code, name, type});
    // ÂêåÊó∂‰ªéËá™ÈÄâÁßªÈô§
    watchlist = watchlist.filter(w=>w.code!==code);
    saveHoldings();
    saveWatchlist();
  } else {
    if(watchlist.some(w=>w.code===code)) return;
    if(holdings.some(h=>h.code===code)) return;
    watchlist.push({code, name, type});
    saveWatchlist();
  }
  renderPortfolio();
  renderSignals();
  renderWatchlist();
}

function renderIndices(){
  const cfgs = [
    {secid:'1.000001', vId:'iv-sh', pId:'ip-sh'},
    {secid:'0.399001', vId:'iv-sz', pId:'ip-sz'},
    {secid:'0.399006', vId:'iv-cy', pId:'ip-cy'},
    {secid:'1.000300', vId:'iv-hs', pId:'ip-hs'},
    {secid:'1.518880', vId:'iv-au', pId:'ip-au'},
    {secid:'0.161226', vId:'iv-ag', pId:'ip-ag'},
    {secid:'1.000819', vId:'iv-ys', pId:'ip-ys'},
  ];
  cfgs.forEach(c=>{
    const cfg = INDICES_CONFIG.find(x=>x.secid===c.secid);
    if(!cfg) return;
    const d = getIndexData(cfg);
    const vEl = document.getElementById(c.vId);
    const pEl = document.getElementById(c.pId);
    if(vEl) vEl.textContent = d.price;
    if(pEl){
      const pct = parseFloat(d.pct);
      pEl.textContent = `${pct>=0?'+':''}${(typeof pct==='number'?pct.toFixed(2):d.pct)}%`;
      pEl.className = 'idx-pct ' + (pct>0?'up':pct<0?'down':'flat');
    }
  });
}

function renderCountdown(){
  const ms = getMarketStatus();
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('market-status-text');
  const cd = document.getElementById('countdown');

  dot.className = 'status-dot ' + (ms.status==='open'?'open':'closed');
  text.textContent = ms.text;

  if(ms.countdown!==null && ms.countdown>0){
    cd.textContent = 'Ë∑ùÊî∂Áõò ' + formatCountdown(ms.countdown);
    cd.style.display = '';
  } else if(ms.status==='open' && ms.countdown!==null && ms.countdown<=0){
    cd.textContent = 'Âç≥Â∞ÜÊî∂Áõò!';
    cd.style.display = '';
  } else {
    cd.textContent = ms.text;
  }
}

function renderStats(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  let totalPct = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      totalPct += f.gszzl;
    });
    totalPct /= holdings.length;
  }

  const statToday = document.getElementById('stat-today');
  statToday.textContent = holdings.length>0 ? `${sign(totalPct)}${fmt(totalPct)}%` : '--';
  statToday.className = 'stat-value ' + (holdings.length>0?(totalPct>=0?'up':'down'):'');

  const statHS300 = document.getElementById('stat-hs300');
  statHS300.textContent = `${sign(hs300.pct)}${fmt(hs300.pct)}%`;
  statHS300.className = 'stat-value ' + (hs300.pct>=0?'up':'down');

  const benchToday = document.getElementById('stat-bench-today');
  if(holdings.length>0){
    const diff = totalPct - hs300.pct;
    if(diff>=0) benchToday.innerHTML = `‰ªäÊó• <span class="beat">Ë∑ëËµ¢Â§ßÁõò +${fmt(diff)}%</span>`;
    else benchToday.innerHTML = `‰ªäÊó• <span class="lose">ËêΩÂêéÂ§ßÁõò ${fmt(diff)}%</span>`;
  } else {
    benchToday.textContent = 'Ê∑ªÂä†ÊåÅ‰ªìÊü•ÁúãÂØπÊØî';
  }
}

// ==================== REAL-WORLD ACTION GUIDE ====================
// ‰∏âÂºïÊìéÈó≠ÁéØÔºöAI‰ø°Âè∑ + RLÂÜ≥Á≠ñ + ÂõûÊµãÈ™åËØÅ ‚Üí ÂÆûÁõòÊìç‰ΩúÂª∫ËÆÆ
function toggleActionGuide(){
  const container = document.getElementById('action-guide-container');
  const icon = document.getElementById('action-guide-toggle');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = '‚ñº';
    renderActionGuide();
  } else {
    container.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

function getTriEngineVote(code){
  // === ÂºïÊìé1: AI‰ø°Âè∑ ===
  const aiSig = _analysisResult?.signals?.[code];
  let aiVote = 0, aiConf = 0, aiReason = '';
  if(aiSig){
    aiVote = aiSig.action === 'buy' ? 1 : aiSig.action === 'sell' ? -1 : 0;
    aiConf = aiSig.confidence || 0;
    aiReason = aiSig.reason || '';
  }
  // === ÂºïÊìé2: RL‰ø°Âè∑ ===
  const rlSig = _rlSignals[code];
  let rlVote = 0, rlConf = 0;
  if(rlSig){
    rlVote = rlSig.action === 1 ? 1 : rlSig.action === 2 ? -1 : 0;
    rlConf = rlSig.confidence || 0;
  }
  // === ÂºïÊìé3: ÂõûÊµã‰ø°Âè∑ ===
  const btR = btResults[code];
  let btVote = 0, btConf = 0;
  if(btR){
    const rsi = btR.lastRSI || 50;
    const sharpe = btR.sharpe || 0;
    if(rsi < 40 && sharpe > 0){ btVote = 1; btConf = 70; }
    else if(rsi < 50 && sharpe > 0.5){ btVote = 1; btConf = 60; }
    else if(rsi > 75){ btVote = -1; btConf = 75; }
    else if(rsi > 65 && sharpe < 0){ btVote = -1; btConf = 65; }
    else { btVote = 0; btConf = 40; }
  }
  // === Âä†ÊùÉÊäïÁ•® ===
  const aiW = Math.min(aiConf, 95) / 100;
  const rlW = Math.min(rlConf, 95) / 100;
  const btW = Math.min(Math.abs(btR?.sharpe||0)/2, 0.8);
  const totalW = aiW + rlW + btW || 1;
  const score = (aiVote * aiW + rlVote * rlW + btVote * btW) / totalW;

  const votes = [aiVote, rlVote, btVote].filter(v => v !== 0);
  const buyVotes = votes.filter(v => v > 0).length;
  const sellVotes = votes.filter(v => v < 0).length;
  let consensusMult = 1.0;
  if(Math.max(buyVotes, sellVotes) >= 3) consensusMult = 1.4;
  else if(Math.max(buyVotes, sellVotes) >= 2 && votes.length >= 2) consensusMult = 1.15;
  else if(buyVotes > 0 && sellVotes > 0) consensusMult = 0.4;

  // ÁªºÂêàÂÜ≥Á≠ñ
  let action = 'hold', actionLabel = 'üîµ ÊåÅÊúâËßÇÊúõ';
  const effConf = aiConf * consensusMult;
  if(score > 0.2 && effConf >= 55){ action = 'buy'; actionLabel = 'üü¢ Âª∫ËÆÆÂä†‰ªì'; }
  else if(score < -0.2 && effConf >= 50){ action = 'sell'; actionLabel = 'üî¥ Âª∫ËÆÆÂáè‰ªì'; }
  else if(score > 0.1){ actionLabel = 'üîµ ÂÅèÂ§öÊåÅÊúâ'; }
  else if(score < -0.1){ actionLabel = 'üîµ ÂÅèÁ©∫ÊåÅÊúâ'; }

  // KellyÂª∫ËÆÆ‰ªì‰Ωç
  const kelly = btR?.finalKelly || 0.05;
  const adjKelly = Math.min(kelly * consensusMult, 0.25);

  return {
    action, actionLabel, score, consensusMult,
    buyVotes, sellVotes,
    ai: { vote: aiVote, conf: aiConf, reason: aiReason, label: aiVote>0?'‰π∞ÂÖ•':aiVote<0?'ÂçñÂá∫':'ÊåÅÊúâ' },
    rl: { vote: rlVote, conf: rlConf, label: rlSig?.actionName||'--' },
    bt: { vote: btVote, conf: btConf, sharpe: btR?.sharpe||0, rsi: btR?.lastRSI||50, maxDD: btR?.maxDD||0, winRate: btR?.winRate||0, kelly: adjKelly },
    effConf: Math.round(effConf),
  };
}

function renderActionGuide(){
  const container = document.getElementById('action-guide-container');
  const brief = document.getElementById('action-guide-brief');
  if(!container) return;

  if(holdings.length === 0){
    container.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon">üéØ</div>Ê∑ªÂä†ÊåÅ‰ªìÂêéÔºåËøôÈáå‰ºöÊòæÁ§∫‰∏âÂºïÊìéÈó≠ÁéØÁöÑÂÆûÁõòÊìç‰ΩúÂª∫ËÆÆ</div>';
    if(brief) brief.textContent = 'Êó†ÊåÅ‰ªì';
    return;
  }

  // ‰∏∫ÊØè‰∏™ÊåÅ‰ªìËÆ°ÁÆó‰∏âÂºïÊìéÊäïÁ•®
  const plans = [];
  let totalBuy = 0, totalSell = 0, totalHold = 0;
  holdings.forEach(h => {
    const vote = getTriEngineVote(h.code);
    const fd = getFundData(h.code);
    const td = fundHistoryData[h.code]?.trend;
    plans.push({ code: h.code, fd, td, vote });
    if(vote.action === 'buy') totalBuy++;
    else if(vote.action === 'sell') totalSell++;
    else totalHold++;
  });

  // Êï¥‰ΩìÁªÑÂêàËØÑÂàÜ (0-100)
  const avgScore = plans.reduce((s,p) => s + p.vote.score, 0) / plans.length;
  const overallScore = Math.round(Math.max(0, Math.min(100, 50 + avgScore * 50)));
  const ds = _dataIntelLoaded ? generateDataSignal() : null;

  // Êï¥‰ΩìÂª∫ËÆÆ
  let overallAdvice = '', overallColor = '#94a3b8', overallLabel = '‰∏≠ÊÄßËßÇÊúõ';
  if(overallScore >= 70){ overallLabel = 'ÁßØÊûÅÂä†‰ªì'; overallColor = '#ef4444'; overallAdvice = '‰∏âÂºïÊìéÂ§öÊï∞ÁúãÂ§öÔºåÂ∏ÇÂú∫ÁéØÂ¢ÉÂÅèÁßØÊûÅ„ÄÇÂª∫ËÆÆÊåâKelly‰ªì‰ΩçÈÄêÊ≠•Âä†‰ªìÁúãÂ§öÂìÅÁßçÔºåÊéßÂà∂ÂçïÁ¨î‰∏çË∂ÖÁªÑÂêà5%„ÄÇ'; }
  else if(overallScore >= 58){ overallLabel = 'ÂÅèÂ§öÊåÅÊúâ'; overallColor = '#f59e0b'; overallAdvice = '‰ø°Âè∑ÂÅèÊ≠£Èù¢ÔºåÁª¥ÊåÅÁé∞Êúâ‰ªì‰Ωç‰∏∫‰∏ª„ÄÇÂèØÂú®ÂõûË∞ÉÊó∂ÂØπÈ´òÂÖ±ËØÜÂìÅÁßçÂ∞èÂπÖ‰ΩéÂê∏ÔºåÊéßÂà∂ËäÇÂ•è„ÄÇ'; }
  else if(overallScore >= 42){ overallLabel = '‰∏≠ÊÄßËßÇÊúõ'; overallColor = '#94a3b8'; overallAdvice = '‰ø°Âè∑ÂàÜÊ≠ßËæÉÂ§ßÊàñÊï∞ÊçÆ‰∏çË∂≥„ÄÇÂª∫ËÆÆÊåÅÊúâ‰∏çÂä®ÔºåÁ≠âÂæÖÂºïÊìé‰ø°Âè∑Ë∂ã‰∫é‰∏ÄËá¥ÂêéÂÜçË°åÂä®„ÄÇ'; }
  else if(overallScore >= 30){ overallLabel = 'ÂÅèÁ©∫Ë∞®ÊÖé'; overallColor = '#f59e0b'; overallAdvice = 'ÈÉ®ÂàÜÂºïÊìéÁúãÁ©∫„ÄÇÂª∫ËÆÆÂÖàÂáè‰ªìÈ´òÈ£éÈô©Âç´Êòü‰ªìÂìÅÁßçÔºå‰øùÁïôÊ†∏ÂøÉ‰ªì„ÄÇÊñ∞ËµÑÈáëÊöÇ‰∏çÂÖ•Âú∫„ÄÇ'; }
  else { overallLabel = 'Èò≤Âæ°Âáè‰ªì'; overallColor = '#22c55e'; overallAdvice = 'Â§öÂºïÊìéÁúãÁ©∫„ÄÇÂª∫ËÆÆ‰∏ªÂä®Âáè‰ªìÂç´Êòü‰ªìÔºåÂ¢ûÂä†Áé∞ÈáëÊØî‰æãÔºåÁ≠âÂæÖÂ∏ÇÂú∫‰ºÅÁ®≥‰ø°Âè∑„ÄÇ'; }
  if(ds) overallAdvice += ` [ÂÆèËßÇÁéØÂ¢É: ${ds.label}(${ds.score})]`;

  // ÂºïÊìéÊÄªÊäïÁ•®Ê±áÊÄª
  const engAI = plans.filter(p => p.vote.ai.vote > 0).length;
  const engRL = plans.filter(p => p.vote.rl.vote > 0).length;
  const engBT = plans.filter(p => p.vote.bt.vote > 0).length;
  const engAISell = plans.filter(p => p.vote.ai.vote < 0).length;
  const engRLSell = plans.filter(p => p.vote.rl.vote < 0).length;
  const engBTSell = plans.filter(p => p.vote.bt.vote < 0).length;

  // Brief
  if(brief){
    const hasAnalysis = _analysisResult || _rlModelLoaded || btSummary;
    if(!hasAnalysis){
      brief.innerHTML = '<span style="color:var(--sub)">ÁÇπÂáªAIÂàÜÊûê</span>';
    } else {
      const briefColor = overallScore >= 58 ? 'var(--red)' : overallScore <= 42 ? 'var(--green)' : 'var(--sub)';
      brief.innerHTML = `<span style="color:${briefColor}">${overallLabel} ${overallScore}</span>`;
    }
  }

  let html = '';

  // 1. Êï¥‰ΩìÊ¶ÇËßàÂç°
  html += `<div class="ag-overview">`;
  html += `<div class="ag-score-row">`;
  html += `<div class="ag-big-score" style="color:${overallColor}">${overallScore}</div>`;
  html += `<div class="ag-score-meta"><div class="ag-score-label" style="color:${overallColor}">${overallLabel}</div>`;
  html += `<div class="ag-score-desc">ÁªºÂêàËØÑÂàÜÔºöAI‰ø°Âè∑√óÂõûÊµãÈ™åËØÅ√óRLÂÜ≥Á≠ñ√óÂÆèËßÇÊï∞ÊçÆ</div></div></div>`;

  // ‰∏âÂºïÊìéÊäïÁ•®Ê¶ÇËßà
  html += `<div class="ag-engines">`;
  html += `<div class="ag-engine"><div class="ag-engine-icon">ü§ñ</div><div class="ag-engine-name">AIÂàÜÊûê</div>`;
  html += `<div class="ag-engine-vote" style="color:${engAI>engAISell?'#f87171':engAISell>engAI?'#4ade80':'rgba(255,255,255,0.5)'}">${engAI}‰π∞ ${engAISell}Âçñ</div>`;
  html += `<div class="ag-engine-conf">${_analysisResult ? _analysisResult.engineCount+'ÂºïÊìé' : 'Êú™ÂàÜÊûê'}</div></div>`;

  html += `<div class="ag-engine"><div class="ag-engine-icon">üß†</div><div class="ag-engine-name">RLÂ§ßËÑë</div>`;
  html += `<div class="ag-engine-vote" style="color:${engRL>engRLSell?'#f87171':engRLSell>engRL?'#4ade80':'rgba(255,255,255,0.5)'}">${engRL}‰π∞ ${engRLSell}Âçñ</div>`;
  html += `<div class="ag-engine-conf">${_rlModelLoaded ? 'E'+(rlTrainer?.episode||0)+1 : 'Êú™ËÆ≠ÁªÉ'}</div></div>`;

  html += `<div class="ag-engine"><div class="ag-engine-icon">üìà</div><div class="ag-engine-name">ÂõûÊµãÂºïÊìé</div>`;
  html += `<div class="ag-engine-vote" style="color:${engBT>engBTSell?'#f87171':engBTSell>engBT?'#4ade80':'rgba(255,255,255,0.5)'}">${engBT}‰π∞ ${engBTSell}Âçñ</div>`;
  html += `<div class="ag-engine-conf">${btSummary ? 'Sharpe '+btSummary.avgSharpe.toFixed(1) : 'Êú™ÂõûÊµã'}</div></div>`;
  html += `</div>`;

  // Êï¥‰ΩìÂª∫ËÆÆ
  html += `<div class="ag-advice-bar"><b>üìå ‰ªäÊó•Êìç‰ΩúÂª∫ËÆÆÔºö</b>${overallAdvice}</div>`;
  html += `</div>`;

  // 2. ÈÄêÂè™Âü∫ÈáëÊìç‰ΩúÂç°Áâá
  // ÊéíÂ∫èÔºöÂçñÂá∫‰ºòÂÖà(È£éÊéß‰ºòÂÖà)ÔºåÁÑ∂Âêé‰π∞ÂÖ•ÔºåÊúÄÂêéÊåÅÊúâ
  const order = {sell: 0, buy: 1, hold: 2};
  plans.sort((a,b) => (order[a.vote.action]||2) - (order[b.vote.action]||2));

  plans.forEach(p => {
    const { code, fd, td, vote } = p;
    const todayPct = fd?.gszzl || 0;
    const pctColor = todayPct >= 0 ? 'var(--red)' : 'var(--green)';

    html += `<div class="ag-fund-card action-${vote.action}">`;
    html += `<div class="ag-fund-top">`;
    html += `<div><div class="ag-fund-name">${fundName(code)}</div><div class="ag-fund-code">${code} ¬∑ ${fundType(code)} ¬∑ ‰ªäÊó• <span style="color:${pctColor}">${todayPct>=0?'+':''}${fmt(todayPct)}%</span></div></div>`;
    html += `<span class="ag-fund-action ${vote.action}">${vote.actionLabel}</span>`;
    html += `</div>`;

    // ‰∏âÂºïÊìéÊäïÁ•®Êù°
    html += `<div class="ag-vote-strip">`;
    const mkChip = (name, v, conf) => {
      const cls = v > 0 ? 'bullish' : v < 0 ? 'bearish' : 'neutral';
      const txt = v > 0 ? '‰π∞' : v < 0 ? 'Âçñ' : 'ÊåÅ';
      return `<span class="ag-vote-chip ${cls}">${name}:${txt}${conf>0?' '+conf+'%':''}</span>`;
    };
    html += mkChip('AI', vote.ai.vote, vote.ai.conf);
    html += mkChip('RL', vote.rl.vote, vote.rl.conf);
    html += mkChip('BT', vote.bt.vote, vote.bt.conf);
    // ÂÖ±ËØÜÊ†áÁ≠æ
    if(vote.buyVotes >= 2 && vote.sellVotes === 0) html += `<span class="ag-vote-chip bullish">‚úìÂÖ±ËØÜÁúãÂ§ö√ó${vote.consensusMult.toFixed(1)}</span>`;
    else if(vote.sellVotes >= 2 && vote.buyVotes === 0) html += `<span class="ag-vote-chip bearish">‚úìÂÖ±ËØÜÁúãÁ©∫√ó${vote.consensusMult.toFixed(1)}</span>`;
    else if(vote.buyVotes > 0 && vote.sellVotes > 0) html += `<span class="ag-vote-chip neutral">‚ö†ÂàÜÊ≠ß√ó${vote.consensusMult.toFixed(1)}</span>`;
    html += `</div>`;

    // Êìç‰ΩúÁêÜÁî±
    let reason = '';
    if(vote.action === 'buy'){
      reason = `ÂÖ±ËØÜÁúãÂ§ö(${vote.buyVotes}/3Á•®)`;
      if(vote.ai.conf > 0) reason += `ÔºåAIÁΩÆ‰ø°${vote.ai.conf}%`;
      if(vote.bt.sharpe > 0) reason += `ÔºåÂõûÊµãSharpe ${vote.bt.sharpe.toFixed(1)}Ë°®Áé∞‰ºò`;
      if(td?.swingAdvice?.includes('‰π∞ÂÖ•')) reason += `ÔºåÊ≥¢ÊÆµ‰ø°Âè∑ÊîØÊíë`;
      reason += `„ÄÇÂª∫ËÆÆÁî®ÊÄª‰ªì‰ΩçÁöÑ${(vote.bt.kelly*100).toFixed(0)}%(Kelly)ÂàÜÊâπÂä†‰ªì`;
    } else if(vote.action === 'sell'){
      reason = `ÂÖ±ËØÜÂÅèÁ©∫(${vote.sellVotes}/3Á•®)`;
      if(vote.bt.rsi > 70) reason += `ÔºåRSI=${vote.bt.rsi.toFixed(0)}Ë∂Ö‰π∞Âå∫`;
      if(vote.bt.sharpe < 0) reason += `ÔºåÂõûÊµãSharpe ${vote.bt.sharpe.toFixed(1)}‰∏ç‰Ω≥`;
      if(vote.bt.maxDD < -0.15) reason += `ÔºåÊúÄÂ§ßÂõûÊí§${(vote.bt.maxDD*100).toFixed(0)}%ËæÉÈ´ò`;
      reason += `„ÄÇÂª∫ËÆÆÂÖàÂáè30-50%‰ªì‰ΩçËêΩË¢ã`;
    } else {
      reason = '‰ø°Âè∑Êú™ËææÂÖ±ËØÜÈòàÂÄºÔºåÁª¥ÊåÅÁé∞Êúâ‰ªì‰ΩçËßÇÊúõ';
      if(vote.ai.conf > 0 && vote.ai.reason) reason += `„ÄÇAIÂèÇËÄÉÔºö${vote.ai.reason.slice(0,50)}`;
    }
    html += `<div class="ag-reason">${reason}</div>`;

    // Ê†∏ÂøÉÊåáÊ†á
    html += `<div class="ag-metrics">`;
    html += `<span class="ag-metric">ÂÖ±ËØÜ <b>${vote.effConf}%</b></span>`;
    html += `<span class="ag-metric">Sharpe <b style="color:${vote.bt.sharpe>0?'var(--red)':'var(--green)'}">${vote.bt.sharpe.toFixed(2)}</b></span>`;
    html += `<span class="ag-metric">RSI <b>${vote.bt.rsi.toFixed(0)}</b></span>`;
    html += `<span class="ag-metric">Kelly <b>${(vote.bt.kelly*100).toFixed(0)}%</b></span>`;
    html += `<span class="ag-metric">ËÉúÁéá <b>${(vote.bt.winRate*100).toFixed(0)}%</b></span>`;
    if(td) html += `<span class="ag-metric">60Êó• <b style="color:${td.chg60d>=0?'var(--red)':'var(--green)'}">${td.chg60d>0?'+':''}${td.chg60d}%</b></span>`;
    html += `</div>`;

    // Kelly‰ªì‰ΩçÊù°
    const kellyPct = Math.round(vote.bt.kelly * 100);
    html += `<div class="ag-position-bar">`;
    html += `<div class="ag-pos-label"><span>Âª∫ËÆÆ‰ªì‰Ωç (ÂçäKelly)</span><span>${Math.round(kellyPct/2)}%~${kellyPct}%</span></div>`;
    const barColor = vote.action === 'buy' ? 'var(--red)' : vote.action === 'sell' ? 'var(--green)' : 'var(--primary)';
    html += `<div class="ag-pos-track"><div class="ag-pos-fill" style="width:${Math.min(kellyPct, 100)}%;background:${barColor}"></div></div>`;
    html += `</div>`;

    html += `</div>`; // end ag-fund-card
  });

  // 3. ÊâßË°åÊëòË¶Å & ÂØπÊØîÊ®°ÊãüÁõò
  html += `<div class="ag-summary">`;
  html += `<div class="ag-summary-title">üìä ÊâßË°åÊëòË¶Å</div>`;
  html += `<div class="ag-summary-text">`;
  html += `‰ªäÊó•Âª∫ËÆÆÔºö<b style="color:var(--red)">${totalBuy}Âè™Âä†‰ªì</b> ¬∑ <b style="color:var(--green)">${totalSell}Âè™Âáè‰ªì</b> ¬∑ <b>${totalHold}Âè™ÊåÅÊúâ</b><br>`;

  // ‰∏éÊ®°ÊãüÁõò‰ªäÊó•Êìç‰ΩúÂØπÊØî
  if(simPortfolio?.history){
    const today = todayStr();
    const todayTrades = simPortfolio.history.filter(h => h.date === today);
    if(todayTrades.length > 0){
      html += `<b>Ê®°ÊãüÁõò‰ªäÊó•Êìç‰ΩúÔºö</b>${todayTrades.length}Á¨î ‚Äî `;
      todayTrades.slice(0,3).forEach(t => {
        html += `${t.action==='buy'?'üü¢‰π∞':'üî¥Âçñ'}${fundName(t.code).slice(0,4)} `;
      });
      if(todayTrades.length > 3) html += `‚Ä¶Á≠â${todayTrades.length}Á¨î`;
      html += '<br>';
    }
    const totalVal = getSimTotalValue();
    const cumR = (totalVal - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
    html += `Ê®°ÊãüÁõòÁ¥ØËÆ°Êî∂Áõä: <b style="color:${cumR>=0?'var(--red)':'var(--green)'}">${cumR>=0?'+':''}${cumR.toFixed(2)}%</b> ‚Äî ÂèØÂèÇËÄÉÊ®°ÊãüÁõòÈ™åËØÅ‰∏âÂºïÊìé‰ø°Âè∑ÂèØÈù†ÊÄß<br>`;
  }

  html += `<br><b>‚ö†Ô∏è Êìç‰ΩúÂéüÂàôÔºö</b><br>`;
  html += `‚ë† ÂàÜÊâπÊâßË°åÔºöÂçïÊ¨°Êìç‰Ωú‰∏çË∂ÖÊÄª‰ªì‰Ωç5%ÔºåÂàÜ2-3Ê¨°ÂÆåÊàê<br>`;
  html += `‚ë° Ê†∏ÂøÉ‰ªì‰ºòÂÖàÔºöÊ†∏ÂøÉ‰ªì(ÂÆΩÂü∫/ÂÄ∫Âü∫)‰øùÊåÅ60%Â∫ï‰ªìÔºåÂç´Êòü‰ªìÁÅµÊ¥ªË∞ÉÊï¥<br>`;
  html += `‚ë¢ ‰ø°Âè∑ÂàÜÊ≠ßÊó∂‰∏çÂä®ÔºöÂºïÊìéÊäïÁ•®<2Á•®‰∏ÄËá¥Êó∂ÔºåËßÇÊúõ‰∏∫‰∏ª<br>`;
  html += `‚ë£ Ê≠¢Êçü‰ºòÂÖàÔºö‰ªª‰ΩïÂìÅÁßç‰∫èÊçüË∂Ö5%Á´ãÂç≥Âáè‰ªìÔºå‰∏çÁ≠â‰ø°Âè∑`;
  html += `</div></div>`;

  html += `<div class="ag-disclaimer">‚ö†Ô∏è ‰ª•‰∏äÂª∫ËÆÆÂü∫‰∫éAI/RL/ÂõûÊµã‰∏âÂºïÊìéÈáèÂåñÂàÜÊûêÔºå‰ªÖ‰æõÂèÇËÄÉÔºå‰∏çÊûÑÊàêÊäïËµÑÂª∫ËÆÆ„ÄÇÊäïËµÑÊúâÈ£éÈô©ÔºåÂÜ≥Á≠ñÈúÄË∞®ÊÖé„ÄÇ</div>`;

  container.innerHTML = html;
}

function renderSignals(){
  const container = document.getElementById('signals-container');
  const badge = document.getElementById('signal-badge');

  if(holdings.length===0){
    container.innerHTML = '<div class="empty"><div class="empty-icon">üì•</div>Ê∑ªÂä†ÊåÅ‰ªìÂêéÔºåAI‰ºöÁªôÂá∫‰ªäÊó•Êìç‰ΩúÂª∫ËÆÆ</div>';
    badge.textContent = 'Êó†ÊåÅ‰ªì';
    return;
  }

  if(!_analysisResult){
    let html = '';
    holdings.forEach((h,i)=>{
      const f = getFundData(h.code);
      html += `<div class="signal-card hold">
        <div class="signal-top">
          <div class="signal-fund">
            <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="Âà†Èô§">‚úï</button></div>
            <div class="signal-code">${h.code} ¬∑ ${fundType(h.code)}</div>
          </div>
          <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
        </div>
        <div style="font-size:11px;color:var(--sub)">ÁÇπÂáª„Äå‰∏ÄÈîÆAIÂàÜÊûê„ÄçËé∑ÂèñÊìç‰ΩúÂª∫ËÆÆ</div>
      </div>`;
    });
    container.innerHTML = html;
    badge.textContent = 'Á≠âÂæÖÂàÜÊûê';
    return;
  }

  const r = _analysisResult;
  badge.textContent = `${r.engineCount}ÂºïÊìé ¬∑ ${r.timestamp}`;

  let html = '';
  holdings.forEach((h,i)=>{
    const f = getFundData(h.code);
    const sig = r.signals[h.code];
    if(!sig){
      html += `<div class="signal-card hold">
        <div class="signal-top">
          <div class="signal-fund">
            <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="Âà†Èô§">‚úï</button></div>
            <div class="signal-code">${h.code}</div>
          </div>
          <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
        </div>
        <div style="font-size:11px;color:var(--sub)">AIÊú™ËøîÂõûËØ•Âü∫ÈáëÂàÜÊûê</div>
      </div>`;
      return;
    }

    const actionText = sig.action==='buy'?'üü¢ Âä†‰ªì':sig.action==='sell'?'üî¥ Âáè‰ªì':'‚ö™ ÊåÅÊúâ';
    const urgencyText = sig.urgency==='today'?'‰ªäÊó•Êìç‰Ωú':sig.urgency==='this_week'?'Êú¨Âë®ÂÜÖ':'‰∏çÊÄ•';
    const confClass = sig.confidence>=75?'high':sig.confidence>=55?'mid':'low';
    const posLabel = sig.posType==='core'?'üõ°Ô∏èÊ†∏ÂøÉ‰ªì':'üöÄÂç´Êòü‰ªì';
    const posColor = sig.posType==='core'?'background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5':'background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4';
    const trendIcon = sig.trend==='up'?'üìàË∂ãÂäø‚Üë':sig.trend==='down'?'üìâË∂ãÂäø‚Üì':'üìäÈúáËç°';
    const trendColor = sig.trend==='up'?'color:var(--green)':sig.trend==='down'?'color:var(--red)':'color:var(--sub)';

    // ÊûÑÂª∫Ë∂ãÂäøËØ¶ÊÉÖË°åÔºàÂ¶ÇÊûúÊúâÁúüÂÆûÂéÜÂè≤Êï∞ÊçÆÔºâ
    let trendDetailHtml = '';
    const td = sig.trendDetail;
    if(td){
      const mkSpan = (label, val, suffix='%') => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span style="color:${c}">${label}${val>0?'+':''}${val}${suffix}</span>`;
      };
      trendDetailHtml = `<div style="display:flex;gap:8px;flex-wrap:wrap;font-size:10px;padding:4px 0;border-top:1px solid var(--border);margin-top:4px">
        ${mkSpan('5Êó•:', td.chg5d)} ${mkSpan('20Êó•:', td.chg20d)} ${mkSpan('60Êó•:', td.chg60d)} ${mkSpan('Âπ¥:', td.chg250d)}
        <span style="color:var(--sub)">Ë∑ùÈ´òÁÇπ:${td.drawdownFromHigh}%</span>
      </div>`;
      if(td.swingAdvice){
        const advColor = td.swingAdvice.includes('‰π∞ÂÖ•') ? 'var(--red)' : td.swingAdvice.includes('Âáè‰ªì') ? 'var(--green)' : 'var(--sub)';
        trendDetailHtml += `<div style="font-size:10px;color:${advColor};padding:2px 0">‚ö° ${td.swingAdvice}</div>`;
      }
    }

    html += `<div class="signal-card ${sig.action}">
      <div class="signal-top">
        <div class="signal-fund">
          <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="Âà†Èô§">‚úï</button></div>
          <div class="signal-code">${h.code} ¬∑ ${fundType(h.code)}${sig.target3m?' ¬∑ 3ÊúàÈ¢ÑÊúü:'+sig.target3m:''}</div>
        </div>
        <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px">
        <span class="signal-action ${sig.action}">${actionText}</span>
        <span class="signal-urgency ${sig.urgency==='today'?'high':sig.urgency==='this_week'?'medium':'low'}">${urgencyText}</span>
        <span style="font-size:10px;padding:1px 6px;border-radius:4px;${posColor}">${posLabel}</span>
        <span style="font-size:10px;${trendColor}">${trendIcon}</span>
      </div>
      <div class="conf-bar">
        <span class="conf-text">ÁΩÆ‰ø°Â∫¶</span>
        <div class="conf-track"><div class="conf-fill ${confClass}" style="width:${sig.confidence}%"></div></div>
        <span class="conf-text" style="text-align:right;font-weight:600">${sig.confidence}%</span>
      </div>
      <div class="signal-reason">${sig.reason}</div>
      ${trendDetailHtml}
      <div class="signal-engines">${sig.breakdown}</div>
    </div>`;
  });

  container.innerHTML = html;
}

function renderWatchlist(){
  const section = document.getElementById('watchlist-section');
  const container = document.getElementById('watchlist-container');
  if(watchlist.length===0){ section.style.display='none'; return; }
  section.style.display='';

  let html = '';
  watchlist.forEach((w,i)=>{
    const f = getFundData(w.code);
    const sig = _analysisResult?.signals[w.code];
    const sigText = sig ? (sig.action==='buy'?'Âª∫ËÆÆ‰π∞ÂÖ•':sig.action==='sell'?'ÊöÇ‰∏çÂª∫ËÆÆ':'ÂèØÂÖ≥Ê≥®') : '';
    const sigColor = sig ? (sig.action==='buy'?'background:var(--green-bg);color:var(--green)':sig.action==='sell'?'background:var(--red-bg);color:var(--red)':'background:var(--gray-bg);color:var(--sub)') : '';
    const wTrend = fundHistoryData[w.code]?.trend;
    const trendBrief = wTrend ? ` ¬∑ ${wTrend.trendDir==='strong_up'||wTrend.trendDir==='up'?'üìà':'üìâ'}60Êó•${wTrend.chg60d>0?'+':''}${wTrend.chg60d}%` : '';

    html += `<div class="watch-item">
      <div class="watch-left">
        <div class="watch-name">${fundName(w.code)} <span style="font-size:10px;color:var(--sub)">${w.code}</span></div>
        <div class="watch-type">${fundType(w.code)}${trendBrief}${sig?.target3m?' ¬∑ 3Êúà:'+sig.target3m:''}</div>
      </div>
      <span class="watch-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</span>
      ${sigText?`<span class="watch-signal" style="${sigColor}">${sigText}</span>`:''}
      <button class="watch-del" onclick="removeWatch(${i})">‚úï</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderRecos(){
  const section = document.getElementById('reco-section');
  const container = document.getElementById('reco-container');
  if(!_analysisResult || !_analysisResult.picks || _analysisResult.picks.length===0){
    section.style.display='none';
    return;
  }
  section.style.display='';

  let html = '';
  _analysisResult.picks.forEach(p=>{
    const reco = RECO_FUND_POOL.find(f=>f.code===p.code);
    html += `<div class="reco-card">
      <div class="reco-info">
        <div class="reco-name">${p.name||reco?.name||p.code}</div>
        <div class="reco-meta">${p.type||reco?.type||''} ¬∑ ${p.endorsements}/${_analysisResult.engineCount}ÂºïÊìéÊé®Ëçê</div>
        <div class="reco-meta">${p.reason||''}</div>
      </div>
      ${p.expected3m?`<div class="reco-expect">${p.expected3m}</div>`:''}
      <button class="reco-add" onclick="addToWatchFromReco('${p.code}','${(p.name||reco?.name||'').replace(/'/g,"\\'")}','${p.type||reco?.type||''}')">+ Ëá™ÈÄâ</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderMarketSummary(){
  const section = document.getElementById('market-summary-section');
  const container = document.getElementById('market-summary');
  if(!_analysisResult?.marketSummary){ section.style.display='none'; return; }
  section.style.display='';

  const pa = _analysisResult.portfolioAdvice;
  const portHtml = pa ? `<div style="margin-top:10px;padding:10px 14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0">
    <b style="font-size:12px;color:#1e293b">üíº ‰ªì‰ΩçÂª∫ËÆÆ</b><br>
    <span style="display:inline-flex;align-items:center;gap:6px;margin:6px 0"><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5">üõ°Ô∏èÊ†∏ÂøÉ‰ªì ${pa.coreRatio||'60%'}</span>
    <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4">üöÄÂç´Êòü‰ªì ${pa.satRatio||'40%'}</span></span><br>
    <span style="font-size:11px;color:#475569;line-height:1.5">${pa.advice||''}</span>
  </div>` : '';

  container.innerHTML = `<div class="market-summary">
    <b>üìà Â∏ÇÂú∫Á†îÂà§</b><span class="provider-tag">${_aiProvider.name}</span><br>
    ${_analysisResult.marketSummary}
    ${_analysisResult.benchmarkView?`<br><b>Ê≤™Ê∑±300Â±ïÊúõÔºö</b>${_analysisResult.benchmarkView}`:''}
    ${portHtml}
  </div>`;
}

// ==================== UI ACTIONS ====================
async function triggerAI(){
  if(_analyzing) return;
  if(!_aiKey){ alert('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI Key'); return; }
  if(holdings.length===0 && watchlist.length===0){ alert('ËØ∑ÂÖàÊ∑ªÂä†ÊåÅ‰ªìÊàñËá™ÈÄâÂü∫Èáë'); return; }

  const btn = document.getElementById('ai-btn');
  const progress = document.getElementById('ai-progress');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-sm"></span> AIÂàÜÊûê‰∏≠...';

  try {
    _analysisResult = await runAIAnalysis((msg, count)=>{
      progress.textContent = msg;
    });
    progress.textContent = `‚úÖ ${_analysisResult.engineCount}‰∏™ÂºïÊìéÂàÜÊûêÂÆåÊàê`;
    saveTodayPredictions();
    // Ê®°ÊãüÁõòËá™Âä®‰∫§Êòì
    const simTrades = simAutoTrade();
    updateSimDaily();
    renderMarketSummary();
    renderActionGuide();
    renderSignals();
    renderWatchlist();
    renderRecos();
    renderReview();
    renderSimPortfolio();
    if(simTrades > 0) progress.textContent += ` ¬∑ Ê®°ÊãüÁõòÊâßË°å${simTrades}Á¨î‰∫§Êòì`;
  } catch(e) {
    progress.textContent = `‚ùå ${e.message}`;
  } finally {
    _analyzing = false;
    btn.disabled = false;
    btn.innerHTML = 'üß† ‰∏ÄÈîÆAIÂàÜÊûê ¬∑ 4ÂºïÊìéÁ†îÂà§';
  }
}

let _selectedFund = null; // {code, name}
let _searchTimer = null;

function openAddModal(mode){
  _addMode = mode;
  _selectedFund = null;
  document.getElementById('add-modal').style.display = 'flex';
  document.getElementById('add-modal-title').innerHTML = (mode==='holding'?'‚ûï Ê∑ªÂä†ÊåÅ‰ªì':'‚ûï Ê∑ªÂä†Ëá™ÈÄâ') + ' <button onclick="closeAddModal()">‚úï</button>';
  document.getElementById('add-search-area').style.display = '';
  document.getElementById('add-selected-area').style.display = 'none';
  document.getElementById('add-search-input').value = '';
  document.getElementById('add-search-results').innerHTML = '';
  document.getElementById('add-search-hint').style.display = '';
  setTimeout(()=>document.getElementById('add-search-input').focus(), 100);
}

function closeAddModal(){ document.getElementById('add-modal').style.display='none'; _selectedFund=null; }

function onFundSearchInput(){
  const q = (document.getElementById('add-search-input').value||'').trim();
  const resultsEl = document.getElementById('add-search-results');
  const hintEl = document.getElementById('add-search-hint');

  if(q.length === 0){
    resultsEl.innerHTML = '';
    hintEl.style.display = '';
    hintEl.textContent = 'ËæìÂÖ•Âü∫Èáë‰ª£Á†ÅÔºàÂ¶Ç 000216ÔºâÊàñÂÖ≥ÈîÆËØçÔºàÂ¶Ç„ÄåÈªÑÈáë„ÄçÔºâÊêúÁ¥¢';
    return;
  }
  hintEl.style.display = 'none';

  // ÂÖàÊêúÊú¨Âú∞
  const localResults = searchLocalFunds(q);
  if(localResults.length > 0){
    renderSearchResults(localResults);
  }

  // Â¶ÇÊûúÊòØÁ∫ØÊï∞Â≠ó‰∏îÈïøÂ∫¶>=3ÔºåÂú®Á∫øÊêúÁ¥¢
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(async ()=>{
    if(/^\d{3,6}$/.test(q)){
      // Êï∞Â≠ó‰ª£Á†ÅÔºö‰ºòÂÖàÁî®ÊêúÁ¥¢Êé•Âè£ÔºàÁã¨Á´ãÂõûË∞ÉÔºå‰∏çÈòªÂ°ûÔºâ
      if(localResults.length===0) resultsEl.innerHTML = '<div class="fund-search-hint">üîç Ê≠£Âú®Êü•ËØ¢...</div>';
      try {
        const results = [];
        // ÊêúÁ¥¢Êé•Âè£ÔºàÁã¨Á´ãÂõûË∞ÉÂêçÔºåÊó†ÂÜ≤Á™ÅÔºâ‰Ωú‰∏∫‰∏ªË¶ÅÊù•Ê∫ê
        const sugResults = await searchFundsOnline(q);
        if(sugResults.length > 0) results.push(...sugResults);
        // Â¶ÇÊûúÊêúÁ¥¢Êé•Âè£Ê≤°ËøîÂõûÁªìÊûú‰∏îÊòØÂÆåÊï¥6‰ΩçÔºåÂÜçÂ∞ùËØï‰º∞ÂÄºÊé•Âè£
        if(results.length === 0 && q.length === 6){
          try {
            const d = await fetchFundEstimate(q);
            if(d && d.name) results.push({code:q, name:d.name, source:'online'});
          } catch(e){}
        }
        if(results.length > 0){
          renderSearchResults(dedupeResults(results, localResults));
        } else if(localResults.length===0){
          resultsEl.innerHTML = '<div class="fund-search-hint">‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂü∫ÈáëÔºåËØ∑Ê£ÄÊü•‰ª£Á†Å</div>';
        }
      } catch(e){
        if(localResults.length===0) resultsEl.innerHTML = '<div class="fund-search-hint">‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂü∫Èáë</div>';
      }
    } else if(q.length >= 2){
      // ÂÖ≥ÈîÆÂ≠óÊêúÁ¥¢ ‚Äî Â∞ùËØïÂú®Á∫øÊ®°Á≥äÊêúÁ¥¢
      try {
        const onlineResults = await searchFundsOnline(q);
        if(onlineResults.length > 0){
          const merged = dedupeResults(onlineResults, localResults);
          renderSearchResults(merged);
        } else if(localResults.length===0){
          resultsEl.innerHTML = '<div class="fund-search-hint">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂü∫ÈáëÔºåËØïËØïËæìÂÖ•ÂÆåÊï¥6‰Ωç‰ª£Á†Å</div>';
        }
      } catch(e) { /* keep local results */ }
    }
  }, 400);
}

function searchLocalFunds(q){
  const ql = q.toLowerCase();
  const all = [...FUND_DB, ...RECO_FUND_POOL];
  const seen = new Set();
  return all.filter(f=>{
    if(seen.has(f.code)) return false;
    seen.add(f.code);
    return f.code.includes(ql) || (f.name||'').toLowerCase().includes(ql) || (f.type||'').toLowerCase().includes(ql);
  }).slice(0, 20).map(f=>({code:f.code, name:f.name, type:f.type, source:'local'}));
}

function searchFundsOnline(keyword){
  return new Promise((resolve)=>{
    const cbName = '_fundSearchCb_' + Date.now();
    const script = document.createElement('script');
    const timer = setTimeout(()=>{ cleanup(); resolve([]); }, 5000);
    window[cbName] = function(data){
      clearTimeout(timer);
      cleanup();
      try {
        const items = (data && data.Datas) ? data.Datas : [];
        resolve(items.slice(0, 20).map(d=>({
          code: d.CODE || d.code || '',
          name: d.NAME || d.name || '',
          source: 'online'
        })).filter(d=>d.code && d.code.length===6));
      } catch(e){ resolve([]); }
    };
    script.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?callback=${cbName}&m=1&key=${encodeURIComponent(keyword)}`;
    script.onerror = ()=>{ clearTimeout(timer); cleanup(); resolve([]); };
    document.head.appendChild(script);
    function cleanup(){ try{delete window[cbName]; script.remove();}catch(e){} }
  });
}

function dedupeResults(primary, secondary){
  const codes = new Set(primary.map(f=>f.code));
  return [...primary, ...secondary.filter(f=>!codes.has(f.code))].slice(0,20);
}

function renderSearchResults(results){
  const el = document.getElementById('add-search-results');
  if(!results || results.length===0){ el.innerHTML=''; return; }
  el.innerHTML = results.map(f=>{
    const typeTag = f.type ? `<span class="fund-result-type">${f.type}</span>` : '';
    return `<div class="fund-result-item" onclick="selectFundResult('${f.code}','${(f.name||'').replace(/'/g,"\\'")}')"><span class="fund-result-code">${f.code}</span><span class="fund-result-name">${f.name||''}</span>${typeTag}</div>`;
  }).join('');
}

function selectFundResult(code, name){
  _selectedFund = {code, name};
  // ÂàáÂà∞Â∑≤ÈÄâ‰∏≠Áä∂ÊÄÅ
  document.getElementById('add-search-area').style.display = 'none';
  document.getElementById('add-selected-area').style.display = '';
  document.getElementById('add-sel-code').textContent = code;
  document.getElementById('add-sel-name').textContent = name;
  // Ëá™Âä®ÈÄâÁ±ªÂûã
  const localMatch = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
  const type = localMatch?.type || guessFundType(name);
  autoSelectType(type);
}

function clearFundSelection(){
  _selectedFund = null;
  document.getElementById('add-search-area').style.display = '';
  document.getElementById('add-selected-area').style.display = 'none';
  document.getElementById('add-search-input').focus();
}

function guessFundType(name){
  if(!name) return 'ÂÖ∂‰ªñ';
  const n = name.toLowerCase();
  if(n.includes('ÈªÑÈáë') || n.includes('Ë¥µÈáëÂ±û')) return 'ÈªÑÈáë';
  if(n.includes('ÂçäÂØº‰Ωì') || n.includes('ËäØÁâá')) return 'ÂçäÂØº‰Ωì';
  if(n.includes('ÂÜõÂ∑•') || n.includes('ÂõΩÈò≤')) return 'ÂÜõÂ∑•';
  if(n.includes('Á∫¢Âà©') || n.includes('È´òËÇ°ÊÅØ')) return 'Á∫¢Âà©';
  if(n.includes('Êñ∞ËÉΩÊ∫ê') || n.includes('ÂÖâ‰ºè') || n.includes('ÁîµÊ±†')) return 'Êñ∞ËÉΩÊ∫ê';
  if(n.includes('Ê∂àË¥π') || n.includes('ÁôΩÈÖí') || n.includes('È£üÂìÅ')) return 'Ê∂àË¥π';
  if(n.includes('ÂåªËçØ') || n.includes('ÂåªÁñó') || n.includes('ÂàõÊñ∞ËçØ')) return 'ÂåªËçØ';
  if(n.includes('ÊúâËâ≤') || n.includes('Èìú') || n.includes('Èìù')) return 'ÊúâËâ≤ÈáëÂ±û';
  if(n.includes('‰∫∫Â∑•Êô∫ËÉΩ') || n.includes('ai') || n.includes('‰∫ëËÆ°ÁÆó') || n.includes('ÁßëÊäÄ') || n.includes('‰ø°ÊÅØ')) return 'AI/ÁßëÊäÄ';
  if(n.includes('Á∫≥ÊñØËææÂÖã') || n.includes('Ê†áÊôÆ') || n.includes('ÁæéÂõΩ') || n.includes('qdii') || n.includes('Êµ∑Â§ñ')) return 'QDII';
  if(n.includes('300') || n.includes('500') || n.includes('Ê≤™Ê∑±') || n.includes('‰∏≠ËØÅ') || n.includes('Âàõ‰∏öÊùø') || n.includes('‰∏äËØÅ')) return 'ÂÆΩÂü∫';
  return 'ÂÖ∂‰ªñ';
}

function autoSelectType(type){
  const sel = document.getElementById('add-type');
  for(let i=0;i<sel.options.length;i++){
    if(sel.options[i].value===type){ sel.selectedIndex=i; break; }
  }
}

function confirmAdd(){
  if(!_selectedFund || !_selectedFund.code){ alert('ËØ∑ÂÖàÊêúÁ¥¢Âπ∂ÈÄâÊã©‰∏Ä‰∏™Âü∫Èáë'); return; }
  const code = _selectedFund.code;
  const name = _selectedFund.name || code;
  const type = document.getElementById('add-type').value || 'ÂÖ∂‰ªñ';

  if(_addMode==='holding'){
    if(holdings.find(h=>h.code===code)){ alert('Â∑≤Â≠òÂú®ËØ•ÊåÅ‰ªì'); return; }
    // Â¶ÇÊûúÂ∑≤Âú®Ëá™ÈÄâ‰∏≠ÔºåËá™Âä®ÁßªÈô§ÔºàÊåÅ‰ªì‰ºòÂÖàÁ∫ßÊõ¥È´òÔºâ
    const wIdx = watchlist.findIndex(w=>w.code===code);
    if(wIdx>=0){ watchlist.splice(wIdx,1); saveWatchlist(); }
    holdings.push({code, name, type});
    saveHoldings();
  } else {
    if(holdings.find(h=>h.code===code)){ alert('ËØ•Âü∫ÈáëÂ∑≤Âú®ÊåÅ‰ªì‰∏≠ÔºåÊó†ÈúÄÈáçÂ§çÊ∑ªÂä†Âà∞Ëá™ÈÄâ'); return; }
    if(watchlist.find(w=>w.code===code)){ alert('Â∑≤Â≠òÂú®ËØ•Ëá™ÈÄâ'); return; }
    watchlist.push({code, name, type});
    saveWatchlist();
  }

  closeAddModal();
  _analysisResult = null; // Clear old analysis
  loadData();
  // Â¶ÇÊûúÁÆ°ÁêÜÈù¢ÊùøÊâìÂºÄÔºåÂà∑Êñ∞ÂàóË°®
  if(document.getElementById('manage-overlay').style.display==='block'){
    renderManageList();
  }
}

function removeHolding(idx){
  if(!confirm(`Á°ÆËÆ§Âà†Èô§ÊåÅ‰ªì„Äå${holdings[idx]?.name||holdings[idx]?.code}„ÄçÔºü`)) return;
  holdings.splice(idx,1);
  saveHoldings();
  _analysisResult = null;
  renderAll();
}

function removeWatch(idx){
  watchlist.splice(idx,1);
  saveWatchlist();
  renderWatchlist();
}

function addToWatchFromReco(code, name, type){
  if(watchlist.find(w=>w.code===code)){ alert('Â∑≤Âú®Ëá™ÈÄâ‰∏≠'); return; }
  watchlist.push({code, name, type});
  saveWatchlist();
  renderWatchlist();
}

// ==================== MANAGE PANEL ====================
let _manageTab = 'holding';

function openManagePanel(tab){
  _manageTab = tab || 'holding';
  document.getElementById('manage-overlay').style.display = 'block';
  document.getElementById('manage-search').value = '';
  switchManageTab(_manageTab);
}

function closeManagePanel(){
  document.getElementById('manage-overlay').style.display = 'none';
}

function switchManageTab(tab){
  _manageTab = tab;
  document.getElementById('manage-tab-holding').classList.toggle('active', tab==='holding');
  document.getElementById('manage-tab-watch').classList.toggle('active', tab==='watch');
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;
  document.getElementById('manage-search').placeholder = tab==='holding' ? 'üîç ÊêúÁ¥¢ÊåÅ‰ªìÂü∫Èáë...' : 'üîç ÊêúÁ¥¢Ëá™ÈÄâÂü∫Èáë...';
  renderManageList();
}

function renderManageList(){
  const body = document.getElementById('manage-body');
  const query = (document.getElementById('manage-search').value||'').trim().toLowerCase();
  const list = _manageTab==='holding' ? holdings : watchlist;
  const emptyIcon = _manageTab==='holding' ? 'üíº' : 'üëÅ';
  const emptyLabel = _manageTab==='holding' ? 'ÊåÅ‰ªì' : 'Ëá™ÈÄâ';

  // Êõ¥Êñ∞ËÆ°Êï∞
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;

  if(list.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">${emptyIcon}</div>
      <div class="manage-empty-text">ÊöÇÊó†${emptyLabel}Âü∫Èáë</div>
      <button class="manage-add-btn" onclick="openAddModal('${_manageTab}')" style="margin:0 auto;display:block">+ Ê∑ªÂä†${emptyLabel}</button>
    </div>`;
    return;
  }

  // ËøáÊª§
  const filtered = list.filter((item,i)=>{
    if(!query) return true;
    const name = (fundName(item.code)||'').toLowerCase();
    return item.code.includes(query) || name.includes(query) || (item.name||'').toLowerCase().includes(query) || (item.type||'').toLowerCase().includes(query);
  });

  if(filtered.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">üîç</div>
      <div class="manage-empty-text">Êú™ÊâæÂà∞ÂåπÈÖç "${query}" ÁöÑÂü∫Èáë</div>
    </div>`;
    return;
  }

  let html = `<div style="font-size:10px;color:var(--sub);padding:4px 2px 8px">ÂÖ± ${filtered.length} Âè™${emptyLabel}Âü∫Èáë${query?' (ÊêúÁ¥¢ÁªìÊûú)':''}</div>`;

  filtered.forEach((item) => {
    const idx = list.indexOf(item);
    const fd = getFundData(item.code);
    const pctVal = parseFloat(fd?.gszzl) || 0;
    const pctColor = pctVal >= 0 ? 'var(--red)' : 'var(--green)';
    const pctSign = pctVal >= 0 ? '+' : '';
    const navVal = fd?.gsz || fd?.dwjz || '--';
    const navLabel = fd?._live ? 'ÂÆûÊó∂‰º∞ÂÄº' : 'ÂáÄÂÄº';
    const name = fundName(item.code);
    const type = fundType(item.code);

    // Ë∂ãÂäøÊï∞ÊçÆ
    const trend = fundHistoryData[item.code]?.trend;
    let trendHtml = '';
    if(trend){
      const mk = (label, val) => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span><span style="color:var(--sub)">${label}</span><span style="color:${c};font-weight:600">${val>0?'+':''}${val}%</span></span>`;
      };
      trendHtml = `<div class="manage-fund-trend">
        ${mk('5Êó•', trend.chg5d)} ${mk('20Êó•', trend.chg20d)} ${mk('60Êó•', trend.chg60d)}
        <span><span style="color:var(--sub)">Ë∑ùÈ´òÁÇπ</span><span style="color:var(--green);font-weight:600">${trend.drawdownFromHigh}%</span></span>
      </div>`;
    }

    // Êìç‰ΩúÊåâÈíÆ
    let actionsHtml = '';
    if(_manageTab === 'holding'){
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToWatch(${idx})">‚Üí ÁßªËá≥Ëá™ÈÄâ</button>
        <button class="manage-action-btn danger" onclick="removeFromManage('holding',${idx})">üóë Âà†Èô§</button>
      </div>`;
    } else {
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToHolding(${idx})">‚Üí ÁßªËá≥ÊåÅ‰ªì</button>
        <button class="manage-action-btn danger" onclick="removeFromManage('watch',${idx})">üóë Âà†Èô§</button>
      </div>`;
    }

    html += `<div class="manage-fund">
      <div class="manage-fund-top">
        <div class="manage-fund-info">
          <div class="manage-fund-name">${name}</div>
          <div class="manage-fund-meta">
            <span>${item.code}</span>
            <span class="manage-fund-type">${type}</span>
            <span>${navLabel}: ${typeof navVal==='number'?navVal.toFixed(4):navVal}</span>
          </div>
        </div>
        <div class="manage-fund-right">
          <div>
            <div class="manage-fund-pct" style="color:${pctColor}">${pctSign}${pctVal.toFixed(2)}%</div>
            <div class="manage-fund-nav">${fd?.gztime||''}</div>
          </div>
          <button class="manage-fund-del" onclick="removeFromManage('${_manageTab}',${idx})" title="Âà†Èô§">üóë</button>
        </div>
      </div>
      ${trendHtml}
      ${actionsHtml}
    </div>`;
  });

  body.innerHTML = html;
}

function removeFromManage(type, idx){
  const list = type==='holding' ? holdings : watchlist;
  const item = list[idx];
  const label = type==='holding' ? 'ÊåÅ‰ªì' : 'Ëá™ÈÄâ';
  if(!item) return;
  if(!confirm(`Á°ÆËÆ§Âà†Èô§${label}„Äå${item.name||fundName(item.code)||item.code}„ÄçÔºü`)) return;

  list.splice(idx, 1);
  if(type==='holding'){
    saveHoldings();
    _analysisResult = null;
    renderAll();
  } else {
    saveWatchlist();
    renderWatchlist();
  }
  renderManageList();
}

function moveToWatch(holdingIdx){
  const item = holdings[holdingIdx];
  if(!item) return;
  if(watchlist.find(w=>w.code===item.code)){
    alert('ËØ•Âü∫ÈáëÂ∑≤Âú®Ëá™ÈÄâ‰∏≠');
    return;
  }
  holdings.splice(holdingIdx, 1);
  watchlist.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

function moveToHolding(watchIdx){
  const item = watchlist[watchIdx];
  if(!item) return;
  if(holdings.find(h=>h.code===item.code)){
    alert('ËØ•Âü∫ÈáëÂ∑≤Âú®ÊåÅ‰ªì‰∏≠');
    return;
  }
  watchlist.splice(watchIdx, 1);
  holdings.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

// Settings
function openSettings(){
  document.getElementById('settings-modal').style.display = 'flex';
  document.getElementById('input-key').value = _aiKey || '';
  let phtml = '';
  AI_PROVIDERS.forEach(p=>{
    const sel = p.id===_aiProviderId;
    phtml += `<div onclick="selectProvider('${p.id}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:2px solid ${sel?'var(--primary)':'var(--border)'};border-radius:10px;margin-bottom:6px;cursor:pointer;background:${sel?'var(--primary-bg)':'white'};transition:all .2s">
      <div style="flex:1">
        <div style="font-weight:600;font-size:12px">${p.name} ${p.free?'<span style="font-size:9px;background:#22c55e;color:white;padding:1px 5px;border-radius:3px">ÂÖçË¥π</span>':''}</div>
        <div style="font-size:9px;color:var(--sub);margin-top:2px">${p.desc}</div>
      </div>
      <div style="width:18px;height:18px;border-radius:50%;border:2px solid ${sel?'var(--primary)':'#ccc'};display:flex;align-items:center;justify-content:center">
        ${sel?'<div style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>':''}
      </div>
    </div>`;
  });
  document.getElementById('provider-list').innerHTML = phtml;
  document.getElementById('provider-hint').innerHTML = `Âú® <a href='${_aiProvider.link}' target='_blank' style='color:var(--primary)'>${_aiProvider.name}</a> Ëé∑ÂèñKey${_aiProvider.free?' (ÂÖçË¥π)':''}`;
  let ehtml = '';
  AI_ENGINES.forEach(eng=>{
    ehtml += `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${eng.icon}</span>
      <span style="flex:1;font-weight:500">${eng.name}</span>
      <span style="font-size:10px;color:var(--primary);background:var(--primary-bg);padding:1px 6px;border-radius:4px">${eng.model}</span>
    </div>`;
  });
  document.getElementById('engine-list').innerHTML = ehtml;
}
function selectProvider(id){ saveProvider(id); openSettings(); }
function closeSettings(){ document.getElementById('settings-modal').style.display='none'; }
function saveSettings(){
  const key = document.getElementById('input-key').value.trim();
  if(!key){ alert('ËØ∑ËæìÂÖ•API Key'); return; }
  saveKey(key);
  closeSettings();
  alert(`Â∑≤‰øùÂ≠òÔºÅÂΩìÂâç: ${_aiProvider.name}`);
}
function toggleKeyVis(){
  const inp = document.getElementById('input-key');
  inp.type = inp.type==='password'?'text':'password';
}
function clearAllData(){
  if(!confirm('Á°ÆËÆ§Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÔºü(ÊåÅ‰ªì„ÄÅËá™ÈÄâ„ÄÅÂàÜÊûêÁªìÊûúÁ≠â)')) return;
  localStorage.removeItem('fa_holdings');
  localStorage.removeItem('fa_watchlist');
  localStorage.removeItem('fa_lastAnalysis');
  localStorage.removeItem('fa_lastReco');
  localStorage.removeItem('fa_daily_log');
  localStorage.removeItem('fa_sim_portfolio');
  location.reload();
}

// ==================== DAILY REVIEW SYSTEM ====================
// ‰øùÂ≠ò‰ªäÊó•AIÈ¢ÑÊµãÂø´ÁÖß
function saveTodayPredictions(){
  if(!_analysisResult || !_analysisResult.signals) return;
  const today = todayStr();

  // ËÆ∞ÂΩï‰ªäÊó•ÊØèÂè™Âü∫ÈáëÁöÑÈ¢Ñ‰º∞Ê∂®Ë∑å + È¢ÑÊµã‰ø°Âè∑
  const pnl = {};
  const predictions = {};
  const allCodes = [...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)];
  allCodes.forEach(code=>{
    const f = getFundData(code);
    pnl[code] = +(f.gszzl||0).toFixed(2);
    const sig = _analysisResult.signals[code];
    if(sig){
      predictions[code] = {
        action: sig.action,
        confidence: sig.confidence,
        trend: sig.trend,
        reason: (sig.reason||'').slice(0,80),
        posType: sig.posType||''
      };
    }
  });

  // ÊåÅ‰ªìÂπ≥ÂùáÁõà‰∫è
  let avgPnl = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{ avgPnl += (pnl[h.code]||0); });
    avgPnl = +(avgPnl/holdings.length).toFixed(2);
  }

  // Ê≤™Ê∑±300
  const hs300 = getIndexData(INDICES_CONFIG[3]);

  // Êõ¥Êñ∞ÊàñÊñ∞Â¢û‰ªäÊó•ËÆ∞ÂΩï
  const idx = dailyLog.findIndex(d=>d.date===today);
  const entry = {
    date: today,
    predictions,
    pnl,
    avgPnl,
    hs300Pct: +(hs300.pct||0).toFixed(2),
    holdingCodes: holdings.map(h=>h.code),
    watchCodes: watchlist.map(w=>w.code),
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
  if(idx>=0) dailyLog[idx] = entry;
  else dailyLog.push(entry);

  saveDailyLog();
}

// ÁîüÊàêÊØèÊó•Â§çÁõòÔºàÂ∞ÜÊò®Â§©ÁöÑÈ¢ÑÊµã‰∏é‰ªäÊó•ÂÆûÈôÖË°®Áé∞ÂØπÊØîÔºâ
function generateDailyReview(){
  const today = todayStr();
  // ÊâæÊò®Â§©ÔºàÊàñÊúÄËøë‰∏Ä‰∏™ÊúâËÆ∞ÂΩïÁöÑ‰∫§ÊòìÊó•ÔºâÁöÑËÆ∞ÂΩï
  const pastEntries = dailyLog.filter(d=>d.date < today && d.predictions && Object.keys(d.predictions).length>0);
  if(pastEntries.length===0) return null;

  const yesterday = pastEntries[pastEntries.length-1];
  // ‰ªäÊó•ÂÆûÈôÖÁõà‰∫èÔºàÁî®liveÊï∞ÊçÆÔºâ
  const reviews = [];
  Object.keys(yesterday.predictions).forEach(code=>{
    const pred = yesterday.predictions[code];
    const todayData = getFundData(code);
    const actualPct = +(todayData?.gszzl||0).toFixed(2);

    // È¢ÑÊµãÊòØÂê¶Ê≠£Á°Æ
    let verdict = 'neutral'; // correct / wrong / neutral
    let lesson = '';
    if(pred.action==='buy'){
      if(actualPct > 0){ verdict='correct'; }
      else if(actualPct < -0.5){ verdict='wrong'; lesson=`Âª∫ËÆÆ‰π∞ÂÖ•‰ΩÜ‰ªäÊó•Ë∑å${actualPct}%ÔºåÂèØËÉΩ‰ΩéÂê∏Êó∂Êú∫Êú™Âà∞ÊàñË∂ãÂäøÂà§Êñ≠ÈúÄ‰øÆÊ≠£`; }
      else { verdict='neutral'; }
    } else if(pred.action==='sell'){
      if(actualPct < 0){ verdict='correct'; }
      else if(actualPct > 0.5){ verdict='wrong'; lesson=`Âª∫ËÆÆÂáè‰ªì‰ΩÜ‰ªäÊó•Ê∂®${actualPct}%ÔºåÂèØËÉΩËøáÊó©Á¶ªÂú∫ÈîôÂ§±Êî∂Áõä`; }
      else { verdict='neutral'; }
    } else { // hold
      if(Math.abs(actualPct) < 1){ verdict='correct'; }
      else if(actualPct < -1.5){ verdict='wrong'; lesson=`Âª∫ËÆÆÊåÅÊúâ‰ΩÜ‰ªäÊó•Ë∑å${actualPct}%ÔºåÊú™ÂèäÊó∂Ê≠¢ÊçüÊàñÊú™ËØÜÂà´È£éÈô©‰ø°Âè∑`; }
      else if(actualPct > 2){ verdict='neutral'; lesson=`Âª∫ËÆÆÊåÅÊúâÔºå‰ªäÊó•Ê∂®${actualPct}%Ôºå‰ΩÜÊú™Âª∫ËÆÆÂä†‰ªìÂèØËÉΩÈîôÂ§±Ê≥¢ÊÆµÊú∫‰ºö`; }
    }

    reviews.push({
      code,
      name: fundName(code),
      predAction: pred.action,
      predConfidence: pred.confidence,
      predReason: pred.reason,
      actualPct,
      verdict,
      lesson
    });
  });

  // Ê±áÊÄª
  const correct = reviews.filter(r=>r.verdict==='correct').length;
  const wrong = reviews.filter(r=>r.verdict==='wrong').length;
  const total = reviews.length;
  const accuracy = total>0 ? Math.round(correct/total*100) : 0;

  // Êò®Êó•ÊåÅ‰ªìÂπ≥Âùá
  const yesterdayAvg = yesterday.avgPnl||0;

  return {
    reviewDate: yesterday.date,
    todayDate: today,
    reviews,
    accuracy,
    correct,wrong,total,
    yesterdayAvg,
    yesterdayHs300: yesterday.hs300Pct||0
  };
}

// ÊûÑÂª∫Â§çÁõò‰∏ä‰∏ãÊñáÔºàÊ≥®ÂÖ•AI promptÔºâ
function buildReviewContext(){
  const review = generateDailyReview();
  if(!review || review.reviews.length===0) return '';

  let ctx = `\n„ÄêÂéÜÂè≤Â§çÁõòÊïôËÆ≠ - ËØ∑‰ªéËøáÂéªÁöÑÂà§Êñ≠Â§±ËØØ‰∏≠Â≠¶‰π†„Äë\n`;
  ctx += `‰∏äÊ¨°ÂàÜÊûêÊó•Êúü:${review.reviewDate} ‚Üí ‰ªäÊó•È™åËØÅ:${review.todayDate}\n`;
  ctx += `È¢ÑÊµãÂáÜÁ°ÆÁéá: ${review.accuracy}% (${review.correct}ÂØπ/${review.wrong}Èîô/${review.total}ÊÄª)\n`;

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  if(wrongOnes.length>0){
    ctx += `\n‚ö†Ô∏è Âà§Êñ≠Â§±ËØØÈúÄÂèçÊÄùÔºö\n`;
    wrongOnes.forEach(r=>{
      ctx += `- ${r.name}(${r.code}): È¢ÑÊµã${r.predAction==='buy'?'‰π∞ÂÖ•':r.predAction==='sell'?'Âáè‰ªì':'ÊåÅÊúâ'} ‚Üí ÂÆûÈôÖ${r.actualPct>0?'+':''}${r.actualPct}%`;
      if(r.lesson) ctx += ` | ÊïôËÆ≠:${r.lesson}`;
      ctx += `\n`;
    });
    ctx += `ËØ∑Âú®‰ªäÊó•ÂàÜÊûê‰∏≠ÁâπÂà´Ê≥®ÊÑèËøô‰∫õÂ§±ËØØÁöÑÂêåÁ±ªÂûãÂü∫ÈáëÔºåÈÅøÂÖçÈáçÂ§çÁäØÈîô„ÄÇ\n`;
  }

  const correctOnes = review.reviews.filter(r=>r.verdict==='correct');
  if(correctOnes.length>0){
    ctx += `\n‚úÖ Âà§Êñ≠Ê≠£Á°ÆÁöÑÁªèÈ™åÔºö\n`;
    correctOnes.slice(0,3).forEach(r=>{
      ctx += `- ${r.name}: È¢ÑÊµã${r.predAction==='buy'?'‰π∞ÂÖ•':r.predAction==='sell'?'Âáè‰ªì':'ÊåÅÊúâ'} ‚Üí ÂÆûÈôÖ${r.actualPct>0?'+':''}${r.actualPct}% ‚úì\n`;
    });
  }

  // Âä†ÂÖ•ÊúÄËøëÂá†Â§©ÁöÑÁõà‰∫èË∂ãÂäø
  const recent = dailyLog.slice(-5).filter(d=>d.avgPnl!==undefined);
  if(recent.length>=2){
    ctx += `\n„ÄêËøëÊúüÊåÅ‰ªìÁõà‰∫èËµ∞Âäø„Äë\n`;
    recent.forEach(d=>{
      ctx += `${d.date}: ÊåÅ‰ªìÂπ≥Âùá${d.avgPnl>0?'+':''}${d.avgPnl}% | Ê≤™Ê∑±300 ${d.hs300Pct>0?'+':''}${d.hs300Pct}%\n`;
    });
  }

  return ctx;
}

// Ê∏≤ÊüìÂ§çÁõòUI
function renderReview(){
  const section = document.getElementById('review-section');
  const container = document.getElementById('review-container');
  const histToggle = document.getElementById('review-history-toggle');

  const review = generateDailyReview();

  if(!review || review.reviews.length===0){
    section.style.display = 'none';
    return;
  }
  section.style.display = '';

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  const accColor = review.accuracy>=70?'var(--green)':review.accuracy>=40?'var(--yellow)':'var(--red)';

  let html = `<div class="review-card">
    <div class="review-header">
      <div class="review-date">üìÖ ${review.reviewDate} ‚Üí ‰ªäÊó•È™åËØÅ</div>
      <div class="review-pnl" style="color:${review.yesterdayAvg>=0?'var(--red)':'var(--green)'}">${review.yesterdayAvg>=0?'+':''}${review.yesterdayAvg}%</div>
    </div>
    <div class="review-stats">
      <div class="review-stat"><span class="review-stat-label">ÂáÜÁ°ÆÁéá</span><span class="review-stat-val" style="color:${accColor}">${review.accuracy}%</span></div>
      <div class="review-stat"><span class="review-stat-label">‚úÖÊ≠£Á°Æ</span><span class="review-stat-val" style="color:var(--green)">${review.correct}</span></div>
      <div class="review-stat"><span class="review-stat-label">‚ùåÂ§±ËØØ</span><span class="review-stat-val" style="color:var(--red)">${review.wrong}</span></div>
      <div class="review-stat"><span class="review-stat-label">ÊÄªÊï∞</span><span class="review-stat-val">${review.total}</span></div>
    </div>`;

  // Â±ïÁ§∫ÊØèÂè™Âü∫ÈáëÁöÑÈ™åËØÅÁªìÊûú
  html += `<div class="review-items">`;
  // ÂÖàÊòæÁ§∫ÈîôËØØÁöÑÔºàÈáçÁÇπÂÖ≥Ê≥®Ôºâ
  [...wrongOnes, ...review.reviews.filter(r=>r.verdict!=='wrong')].forEach(r=>{
    const predText = r.predAction==='buy'?'Âä†‰ªì':r.predAction==='sell'?'Âáè‰ªì':'ÊåÅÊúâ';
    const verdictText = r.verdict==='correct'?'‚úìÂØπ':r.verdict==='wrong'?'‚úóÈîô':'‚Äî';
    const verdictClass = r.verdict;
    html += `<div class="review-item">
      <span class="review-fund-name">${r.name}</span>
      <span class="review-pred ${r.predAction}">${predText}</span>
      <span class="review-actual" style="color:${r.actualPct>=0?'var(--red)':'var(--green)'}">${r.actualPct>=0?'+':''}${r.actualPct}%</span>
      <span class="review-verdict ${verdictClass}">${verdictText}</span>
    </div>`;
  });
  html += `</div>`;

  // Â§±ËØØÊïôËÆ≠
  if(wrongOnes.length>0){
    const lessons = wrongOnes.filter(r=>r.lesson).map(r=>`‚Ä¢ ${r.name}: ${r.lesson}`).join('<br>');
    if(lessons){
      html += `<div class="review-lesson">üìå <b>ÊïôËÆ≠ÊÄªÁªì</b><br>${lessons}</div>`;
    }
  }

  html += `</div>`;
  container.innerHTML = html;

  // ÂéÜÂè≤ËÆ∞ÂΩï
  if(dailyLog.length>1){
    histToggle.style.display = '';
  }
}

function toggleReviewHistory(){
  const histEl = document.getElementById('review-history');
  if(histEl.style.display==='none'){
    histEl.style.display = '';
    renderReviewHistory();
  } else {
    histEl.style.display = 'none';
  }
}

function renderReviewHistory(){
  const histEl = document.getElementById('review-history');
  const entries = dailyLog.slice().reverse().slice(0,10);
  if(entries.length===0){ histEl.innerHTML='<div style="text-align:center;font-size:11px;color:var(--sub);padding:12px">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>'; return; }

  let html = '';
  entries.forEach(entry=>{
    const holdPnlColor = entry.avgPnl>=0?'var(--red)':'var(--green)';
    const beatHs300 = entry.avgPnl > entry.hs300Pct;
    const predCount = Object.keys(entry.predictions||{}).length;
    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid var(--border);font-size:12px">
      <span style="color:var(--sub);min-width:80px">${entry.date}</span>
      <span style="font-weight:700;color:${holdPnlColor}">${entry.avgPnl>=0?'+':''}${entry.avgPnl}%</span>
      <span style="font-size:10px;color:var(--sub)">Ê≤™Ê∑±300 ${entry.hs300Pct>=0?'+':''}${entry.hs300Pct}%</span>
      <span style="font-size:10px;padding:1px 6px;border-radius:4px;${beatHs300?'background:#ecfdf5;color:#16a34a':'background:#fef2f2;color:#dc2626'}">${beatHs300?'Ë∑ëËµ¢':'Ë∑ëËæì'}</span>
      <span style="font-size:10px;color:var(--sub)">${predCount}Âè™</span>
      <span style="font-size:10px;color:var(--sub)">${entry.timestamp||''}</span>
    </div>`;
  });
  histEl.innerHTML = `<div style="background:var(--card);border-radius:var(--radius);padding:10px 14px;margin-top:4px;box-shadow:var(--shadow)">
    <div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--text)">üìä ÊúÄËøëÁõà‰∫èËÆ∞ÂΩï</div>
    ${html}
  </div>`;
}

// ==================== SIMULATION PORTFOLIO ====================
function saveSimPortfolio(){ localStorage.setItem('fa_sim_portfolio', JSON.stringify(simPortfolio)); }

function initSimPortfolio(){
  if(simPortfolio && simPortfolio.positions && simPortfolio.positions.length > 0) return;
  // ÈúÄË¶ÅÊúâÁúüÂÆûÊåÅ‰ªìÊâçËÉΩÂàùÂßãÂåñ
  if(holdings.length === 0){
    simPortfolio = null;
    return;
  }
  buildSimFromHoldings();
}

function buildSimFromHoldings(){
  const today = todayStr();
  simPortfolio = {
    cash: 0, totalCapital: SIM_INITIAL_CAPITAL,
    positions: [], history: [], dailySnapshots: [],
    strategy: {
      coreRatio: 0.6, satRatio: 0.4,
      maxSinglePos: 0.25,
      stopLoss: -8, takeProfit: 20,
      dipBuyThreshold: -1.5, surgeSellThreshold: 3,
      rebalanceDays: 15,
    },
    created: today, targetMonthlyReturn: SIM_TARGET_MONTHLY,
    syncSource: 'holdings', // Ê†áËÆ∞Êù•Ê∫ê
    learningLog: [],
  };

  // Ê†πÊçÆÁî®Êà∑ÊåÅ‰ªìÁ≠âÊùÉÂàÜÈÖçËµÑÈáë
  const n = holdings.length;
  const perFundPct = Math.floor(90 / n); // 90%ÂàÜÈÖçÔºå10%ÁïôÁé∞Èáë
  let usedCash = 0;
  let hasRealData = false;
  const CORE_TYPES = new Set(['ÂÆΩÂü∫','ÈªÑÈáë','Á∫¢Âà©','ÂÄ∫Âà∏']);

  holdings.forEach((h, i) => {
    // ÊúÄÂêé‰∏ÄÂè™Âü∫ÈáëÊääÂâ©‰Ωô90%ÂÖ®Áªô
    const pct = (i === n-1) ? (90 - perFundPct * (n-1)) : perFundPct;
    const amount = Math.round(SIM_INITIAL_CAPITAL * pct / 100);
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const fd = getFundData(h.code);
    let nav;
    if(fd?._live){
      nav = fd.dwjz || fd.gsz;
      hasRealData = true;
    } else if(fd?._histFallback){
      nav = fd.dwjz;
      hasRealData = true;
    } else {
      nav = fd?.dwjz || 1.0;
    }
    const shares = Math.floor(netAmount / nav * 100) / 100;
    const group = CORE_TYPES.has(h.type) ? 'core' : 'satellite';
    simPortfolio.positions.push({
      code:h.code, name:h.name||fundName(h.code)||h.code, type:h.type||'ÂÖ∂‰ªñ', group,
      shares, avgCost:nav, buyDate:today, targetPct:pct, investedAmount:amount,
      initNavSource: fd?._live ? 'live' : fd?._histFallback ? 'history' : 'fallback',
    });
    simPortfolio.history.push({
      date:today, action:'buy', code:h.code, name:h.name||h.code,
      amount, shares, nav, fee,
      reason:`‰ªéÊåÅ‰ªìÂêåÊ≠•¬∑${group==='core'?'Ê†∏ÂøÉ':'Âç´Êòü'} ${pct}%ÈÖçÊØî${fd?._live?' (ÂÆûÊó∂)':fd?._histFallback?' (ÂéÜÂè≤)':' (ÂæÖÊ†°ÂáÜ)'}`
    });
    usedCash += amount;
  });
  simPortfolio.cash = SIM_INITIAL_CAPITAL - usedCash;
  simPortfolio.dataQuality = hasRealData ? 'real' : 'pending';
  saveSimPortfolio();
}

function getSimNav(code){
  // Êî∂ÁõòÂêé‰ºòÂÖàÁî®dwjz(Á°ÆËÆ§ÂáÄÂÄº)ÔºåÁõò‰∏≠Áî®gsz(‰º∞ÁÆóÂáÄÂÄº)
  const fd = getFundData(code);
  if(!fd) return null;
  const ms = getMarketStatus();
  if(ms.status==='open' || ms.status==='break'){
    return fd.gsz || fd.dwjz; // Áõò‰∏≠Áî®‰º∞ÁÆó
  }
  return fd.dwjz || fd.gsz; // Êî∂ÁõòÁî®Á°ÆËÆ§ÂáÄÂÄº
}

function getSimTotalValue(){
  if(!simPortfolio) return SIM_INITIAL_CAPITAL;
  let total = simPortfolio.cash;
  simPortfolio.positions.forEach(pos => {
    const nav = getSimNav(pos.code) || pos.avgCost;
    total += pos.shares * nav;
  });
  return total;
}

function updateSimDaily(){
  if(!simPortfolio || !simPortfolio.positions) return;
  const today = todayStr();
  // Âè™Âú®‰∫§ÊòìÊó•Êõ¥Êñ∞Âø´ÁÖß
  if(!isTradingDay(today)) return;

  // Ê£ÄÊü•ÊòØÂê¶ÊúâÁúüÂÆûÊï∞ÊçÆÂèØÁî®ÔºàËá≥Â∞ëÊúâ‰∏Ä‰∏™positionÊúâliveÊï∞ÊçÆÔºâ
  let liveCount = 0;
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    if(fd?._live) liveCount++;
  });

  // Â¶ÇÊûúÂ∑≤Â≠òÂú®‰ªäÊó•Âø´ÁÖßÔºåÂè™ÊúâÂΩìÊñ∞Êï∞ÊçÆË¥®ÈáèÊõ¥Â•ΩÊó∂ÊâçÊõ¥Êñ∞
  const existingIdx = simPortfolio.dailySnapshots.findIndex(s => s.date === today);
  if(existingIdx >= 0 && liveCount <= (simPortfolio.dailySnapshots[existingIdx].liveDataCount||0)){
    return; // Áé∞ÊúâÊï∞ÊçÆË¥®ÈáèÂ∑≤ÁªèÊõ¥Â•ΩÊàñÁõ∏ÂêåÔºåË∑≥Ëøá
  }

  let positionValue = 0;
  const posDetails = [];
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    const nav = getSimNav(pos.code) || pos.avgCost;
    const currentValue = pos.shares * nav;
    const pnl = currentValue - pos.investedAmount;
    const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
    positionValue += currentValue;
    posDetails.push({
      code:pos.code, nav:+nav.toFixed(4), value:Math.round(currentValue),
      pnl:Math.round(pnl), pnlPct:+pnlPct.toFixed(2),
      todayPct:+(fd?.gszzl||0).toFixed(2),
      isLive: !!(fd?._live),
    });
  });

  const totalValue = positionValue + simPortfolio.cash;
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  // ÂèñÂâç‰∏ÄÂ§©ÔºàÈùû‰ªäÂ§©ÔºâÁöÑÂø´ÁÖßËÆ°ÁÆóÊó•ÂõûÊä•
  const prevSnapshots = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const prevSnapshot = prevSnapshots.length > 0 ? prevSnapshots[prevSnapshots.length - 1] : null;
  const prevTotal = prevSnapshot ? prevSnapshot.totalValue : SIM_INITIAL_CAPITAL;
  const dailyReturn = (totalValue - prevTotal) / prevTotal * 100;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300Price = parseFloat(hs300.price) || 0;
  // Âü∫ÂáÜÔºöÂèñÁ¨¨‰∏ÄÂ§©ÊúâÊïàËÆ∞ÂΩïÁöÑhs300‰ª∑Ê†º
  const allSnaps = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const hs300Base = allSnaps.length > 0 ? allSnaps[0].hs300Base : hs300Price;
  const hs300CumPct = hs300Base > 0 ? (hs300Price / hs300Base - 1) * 100 : 0;

  const snapshot = {
    date:today, totalValue:Math.round(totalValue), cash:Math.round(simPortfolio.cash),
    positionValue:Math.round(positionValue), dailyReturn:+dailyReturn.toFixed(2),
    cumReturn:+cumReturn.toFixed(2), hs300Pct:+(hs300.pct||0).toFixed(2),
    hs300CumReturn:+hs300CumPct.toFixed(2), hs300Base, hs300Price,
    positions:posDetails, liveDataCount:liveCount,
    updatedAt: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
  };

  if(existingIdx >= 0){
    simPortfolio.dailySnapshots[existingIdx] = snapshot; // Êõ¥Êñ∞‰∏∫Êõ¥Â•ΩÁöÑÊï∞ÊçÆ
  } else {
    simPortfolio.dailySnapshots.push(snapshot);
  }
  if(simPortfolio.dailySnapshots.length > 60) simPortfolio.dailySnapshots = simPortfolio.dailySnapshots.slice(-60);
  saveSimPortfolio();
}

function simTrade(code, action, amountOrPct, reason){
  if(!simPortfolio) return;
  const today = todayStr();
  const fd = getFundData(code);
  // Âè™Áî®ÊúâÁúüÂÆûÊï∞ÊçÆÁöÑÂáÄÂÄºËøõË°å‰∫§Êòì
  if(!fd?._live && !fd?._histFallback){
    console.warn(`simTrade: ${code} Êó†ÁúüÂÆûÊï∞ÊçÆÔºåË∑≥Ëøá‰∫§Êòì`);
    return;
  }
  const nav = getSimNav(code) || fd?.gsz || fd?.dwjz || 1.0;
  const pos = simPortfolio.positions.find(p => p.code === code);

  if(action === 'buy'){
    const amount = (typeof amountOrPct==='number' && amountOrPct < 1) ? Math.round(getSimTotalValue() * amountOrPct) : amountOrPct;
    if(amount > simPortfolio.cash || amount < 100) return;
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const newShares = Math.floor(netAmount / nav * 100) / 100;
    if(pos){
      const totalInvested = pos.investedAmount + amount;
      pos.shares += newShares;
      pos.avgCost = totalInvested / pos.shares;
      pos.investedAmount = totalInvested;
    } else {
      const known = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
      simPortfolio.positions.push({
        code, name:known?.name||fd?.name||code, type:known?.type||'ÂÖ∂‰ªñ', group:'satellite',
        shares:newShares, avgCost:nav, buyDate:today, targetPct:0, investedAmount:amount,
      });
    }
    simPortfolio.cash -= amount;
    simPortfolio.history.push({date:today, action:'buy', code, name:pos?.name||code, amount, shares:newShares, nav, fee, reason});

  } else if(action === 'sell' && pos){
    const sellPct = (typeof amountOrPct==='number' && amountOrPct <= 1) ? amountOrPct : 0.5;
    const sellShares = Math.floor(pos.shares * sellPct * 100) / 100;
    if(sellShares < 0.01) return;
    const sellValue = Math.round(sellShares * nav);
    const fee = Math.round(sellValue * SIM_FEE_RATE * 0.5);
    pos.shares -= sellShares;
    pos.investedAmount = Math.round(pos.investedAmount * (1 - sellPct));
    simPortfolio.cash += (sellValue - fee);
    if(pos.shares < 0.01) simPortfolio.positions = simPortfolio.positions.filter(p => p.code !== code);
    simPortfolio.history.push({date:today, action:'sell', code, name:pos.name, amount:sellValue, shares:sellShares, nav, fee, reason});
  }
  saveSimPortfolio();
}

function simAutoTrade(){
  if(!simPortfolio || !_analysisResult) return 0;
  // Âè™Âú®‰∫§ÊòìÊó•‰∫§ÊòìÊó∂ÊÆµÊâßË°å
  const ms = getMarketStatus();
  if(ms.status!=='open' && ms.status!=='break' && ms.status!=='closed') return 0;
  if(!isTradingDay()) return 0;
  const strategy = simPortfolio.strategy;
  let tradesExecuted = 0;

  // Êï∞ÊçÆÊÉÖÊä•‰ø°Âè∑Á≥ªÊï∞: Ê†πÊçÆÂÆèËßÇ+ËµÑÈáë+ËàÜÊÉÖË∞ÉËäÇ‰∫§ÊòìÊøÄËøõÂ∫¶
  const dataSignal = _dataIntelLoaded ? generateDataSignal() : { score:50 };
  const dsScore = dataSignal.score; // 0-100, 50=‰∏≠ÊÄß
  // buyMult: 1.0(‰∏≠ÊÄß), 0.5(ÁÜäÂ∏Ç)~1.5(ÁâõÂ∏Ç)
  const buyMult = 0.5 + dsScore / 100;
  // sellMult: ÂèçÂêë, ÁÜäÂ∏ÇÂçñÊõ¥Â§ö
  const sellMult = 1.5 - dsScore / 100;
  // ‰ø°ÂøÉÈó®ÊßõË∞ÉËäÇ: ÁâõÂ∏ÇÈôç‰Ωé‰π∞ÂÖ•Èó®ÊßõÔºåÁÜäÂ∏ÇÊèêÈ´ò
  const confAdj = Math.round((50 - dsScore) * 0.15); // ¬±7.5

  // 1. Ê≠¢ÁõàÊ≠¢ÊçüÊ£ÄÊü•ÔºàÊï∞ÊçÆ‰ø°Âè∑ÂΩ±ÂìçÊ≠¢ÊçüÂπÖÂ∫¶Ôºâ
  const dynStopLoss = strategy.stopLoss + (dsScore < 40 ? 1 : dsScore > 60 ? -1 : 0);
  const dynTakeProfit = strategy.takeProfit + (dsScore > 65 ? 3 : dsScore < 35 ? -2 : 0);

  [...simPortfolio.positions].forEach(pos => {
    const fd = getFundData(pos.code);
    if(!fd?._live && !fd?._histFallback) return;
    const nav = getSimNav(pos.code) || pos.avgCost;
    const pnlPct = (nav - pos.avgCost) / pos.avgCost * 100;
    if(pnlPct <= dynStopLoss && pos.group === 'satellite'){
      const sellPct = Math.min(0.9, 0.7 * sellMult);
      simTrade(pos.code, 'sell', sellPct, `‚õîÊ≠¢Êçü: ‰∫è${pnlPct.toFixed(1)}%Ë∂ÖÁ∫ø${dynStopLoss}% [Êï∞ÊçÆ‰ø°Âè∑${dsScore}]`);
      tradesExecuted++;
    }
    if(pnlPct >= dynTakeProfit && pos.group === 'satellite'){
      const sellPct = Math.min(0.6, 0.4 * sellMult);
      simTrade(pos.code, 'sell', sellPct, `‚úÖÊ≠¢Áõà: Ëµö${pnlPct.toFixed(1)}%Ëææ${dynTakeProfit}% [Êï∞ÊçÆ‰ø°Âè∑${dsScore}]`);
      tradesExecuted++;
    }
  });

  // 2. ‰∏âÂºïÊìéÊäïÁ•®ÂÖ±ËØÜ‰∫§ÊòìÁ≥ªÁªüÔºàAI + RL + BacktestÔºâ
  const buyConfThreshold = Math.max(50, 65 + confAdj);
  const sellConfThreshold = Math.max(45, 60 + confAdj);

  simPortfolio.positions.forEach(pos => {
    const sig = _analysisResult.signals[pos.code];
    if(!sig) return;
    const fd = getFundData(pos.code);
    if(!fd?._live) return;
    const todayPct = fd?.gszzl || 0;

    // Ê£ÄÊü•ËØ•ÊùøÂùóÁöÑËµÑÈáëÊµÅÂêë
    const posType = pos.type || '';
    const sectorFlow = sectorCapFlow.find(s => posType && (s.name.includes(posType) || posType.includes(s.name)));
    const sectorBullish = sectorFlow && sectorFlow.mainNet > 0;
    const sectorBearish = sectorFlow && sectorFlow.mainNet < -1e8;

    // === ‰∏âÂºïÊìéÊäïÁ•®ÂÖ±ËØÜ ===
    const rlSig = _rlSignals[pos.code];
    const btR = btResults[pos.code];

    // ÂºïÊìé1: AI‰ø°Âè∑ÊäïÁ•®
    const aiVote = sig.action === 'buy' ? 1 : sig.action === 'sell' ? -1 : 0;
    const aiWeight = Math.min(sig.confidence, 95) / 100; // 0~0.95

    // ÂºïÊìé2: RL‰ø°Âè∑ÊäïÁ•®
    let rlVote = 0, rlWeight = 0;
    if(rlSig){
      rlVote = rlSig.action === 1 ? 1 : rlSig.action === 2 ? -1 : 0;
      rlWeight = Math.min(rlSig.confidence, 95) / 100;
    }

    // ÂºïÊìé3: ÂõûÊµã‰ø°Âè∑ÊäïÁ•®(Âü∫‰∫éÂΩìÂâçRSI+Sharpe+Ë∂ãÂäø)
    let btVote = 0, btWeight = 0;
    if(btR){
      const rsiVal = btR.lastRSI || 50;
      const sharpeVal = btR.sharpe || 0;
      // RSI<40+Sharpe>0 ‚Üí ‰π∞ÂÖ•‰ø°Âè∑; RSI>70+‰ªª‰Ωï ‚Üí ÂçñÂá∫‰ø°Âè∑
      if(rsiVal < 40 && sharpeVal > 0) btVote = 1;
      else if(rsiVal < 50 && sharpeVal > 0.5) btVote = 1;
      else if(rsiVal > 75) btVote = -1;
      else if(rsiVal > 65 && sharpeVal < 0) btVote = -1;
      btWeight = Math.min(Math.abs(sharpeVal) / 2, 0.8); // SharpeË∂äÈ´òÊùÉÈáçË∂äÂ§ß
      if(btR.winRate > 0.5) btWeight = Math.min(btWeight + 0.1, 0.9);
    }

    // Âä†ÊùÉÊäïÁ•®: ÂæóÂàÜ ‚àà [-1, 1]
    const totalWeight = aiWeight + rlWeight + btWeight || 1;
    const consensusScore = (aiVote * aiWeight + rlVote * rlWeight + btVote * btWeight) / totalWeight;

    // ÁªüËÆ°‰∏ÄËá¥ÊÄß: Â§öÂ∞ëÂºïÊìéÂêåÊñπÂêë
    const votes = [aiVote, rlVote, btVote].filter(v => v !== 0);
    const buyVotes = votes.filter(v => v > 0).length;
    const sellVotes = votes.filter(v => v < 0).length;
    const consensus = Math.max(buyVotes, sellVotes); // ÊúÄÂ§ßÂêåÂêëÁ•®Êï∞
    const unanimousBuy = buyVotes >= 2 && sellVotes === 0; // Ëá≥Â∞ë2Á•®ÁúãÂ§öÊó†ÂèçÂØπ
    const unanimousSell = sellVotes >= 2 && buyVotes === 0; // Ëá≥Â∞ë2Á•®ÁúãÁ©∫Êó†ÂèçÂØπ

    // ÂÖ±ËØÜ‰πòÊï∞: ÂÖ®Á•®‰∏ÄËá¥‚Üí1.3ÂÄçÔºå2Á•®‚Üí1.0ÂÄçÔºåÂàÜÊ≠ß‚Üí0.5ÂÄç
    let consensusMult = 1.0;
    if(consensus >= 3) consensusMult = 1.4; // ‰∏âÂºïÊìéÂÖ®Á•®
    else if(consensus >= 2 && votes.length >= 2) consensusMult = 1.15; // Â§öÊï∞Á•®
    else if(buyVotes > 0 && sellVotes > 0) consensusMult = 0.4; // ÊúâÂàÜÊ≠ß,Â§ßÂπÖÁº©Èáè

    // ÊúâÊïàÁΩÆ‰ø°Â∫¶ = AIÁΩÆ‰ø°Â∫¶ √ó ÂÖ±ËØÜ‰πòÊï∞
    const effConf = sig.confidence * consensusMult;
    const rlTag = rlSig ? ` RL:${rlSig.actionName}${rlSig.confidence}%` : '';
    const btTag = btR ? ` BT:${btR.sharpe>0?'‚ñ≤':'‚ñº'}${btR.sharpe.toFixed(1)}` : '';
    const voteTag = ` ÊäïÁ•®[${buyVotes}‰π∞/${sellVotes}Âçñ]√ó${consensusMult.toFixed(1)}`;

    if(sig.action==='buy' && effConf>=buyConfThreshold && todayPct<=strategy.dipBuyThreshold){
      const posValue = pos.shares * (getSimNav(pos.code) || pos.avgCost);
      const totalValue = getSimTotalValue();
      if(posValue / totalValue < strategy.maxSinglePos){
        // Kelly‰ªì‰ΩçÊéßÂà∂: Áî®ÂõûÊµãKellyÂàÜÊï∞ÈôêÂà∂Âä†‰ªìÊØî‰æã √ó ÂÖ±ËØÜÁ≥ªÊï∞
        const kellyLimit = btR?.finalKelly || 0.05;
        let addPct = Math.min(0.03 * buyMult * consensusMult, kellyLimit);
        if(sectorBullish) addPct *= 1.3;
        if(unanimousBuy) addPct *= 1.2; // ÂÖ®Á•®ÁúãÂ§öÂä†Á†Å
        // ÂõûÊµãSharpeËøáÊª§: Sharpe<0‰∏çÂä†‰ªì
        if(btR && btR.sharpe < 0) addPct = 0;
        const addAmt = Math.min(Math.round(totalValue * addPct), Math.round(simPortfolio.cash * 0.3));
        if(addAmt >= 1000){
          const kellyTag = btR ? ` K:${(kellyLimit*100).toFixed(0)}%` : '';
          const reason = `AIÂä†‰ªì(${sig.confidence}%)+Ë∑å${todayPct.toFixed(1)}%‰ΩéÂê∏ [${voteTag} Êï∞ÊçÆ${dsScore}${sectorBullish?' ÊùøÂùóÊµÅÂÖ•':''}${rlTag}${btTag}${kellyTag}]`;
          simTrade(pos.code, 'buy', addAmt, reason);
          tradesExecuted++;
        }
      }
    }

    if(sig.action==='sell' && effConf>=sellConfThreshold && todayPct>=strategy.surgeSellThreshold && pos.group==='satellite'){
      let sellPct = 0.3 * sellMult * consensusMult;
      if(sectorBearish) sellPct = Math.min(0.5, sellPct * 1.3);
      if(unanimousSell) sellPct = Math.min(0.7, sellPct * 1.3); // ÂÖ®Á•®ÁúãÁ©∫Âä†Â§ßÂçñÂá∫
      sellPct = Math.max(0.1, Math.min(0.8, sellPct));
      simTrade(pos.code, 'sell', sellPct, `AIÂáè‰ªì(${sig.confidence}%)+Ê∂®${todayPct.toFixed(1)}% [${voteTag} Êï∞ÊçÆ${dsScore}${sectorBearish?' ÊùøÂùóÊµÅÂá∫':''}${rlTag}${btTag}]`);
      tradesExecuted++;
    }
  });

  // 3. AIÊñ∞Êé®ËçêÂìÅÁßçÔºà‰∏âÂºïÊìéÂÖ±ËØÜËøáÊª§Ôºâ
  if(_analysisResult.picks && simPortfolio.cash > 20000 && dsScore >= 40){
    const minEndorsements = dsScore >= 60 ? 1 : 2;
    _analysisResult.picks.forEach(pick => {
      if(simPortfolio.positions.find(p => p.code === pick.code)) return;
      // ÂõûÊµãËøáÊª§: Â¶ÇÊûúÂõûÊµãSharpe<0‰∏îÊî∂Áõä‰∏∫Ë¥üÔºåË∑≥Ëøá
      const pickBT = btResults[pick.code];
      if(pickBT && pickBT.sharpe < 0 && pickBT.totalReturn < 0) return;
      // RLËøáÊª§: Â¶ÇÊûúRLÂº∫ÁÉàÁúãÁ©∫(ÂçñÂá∫‰∏î>60%ÁΩÆ‰ø°)ÔºåË∑≥Ëøá
      const pickRL = _rlSignals[pick.code];
      if(pickRL && pickRL.action === 2 && pickRL.confidence > 60) return;
      // ‰∏âÂºïÊìéÊñ∞ÂìÅÁßçÊäïÁ•®
      const pickAiVote = 1; // AIÊé®Ëçê=ÁúãÂ§ö
      const pickRlVote = pickRL ? (pickRL.action===1 ? 1 : pickRL.action===2 ? -1 : 0) : 0;
      const pickBtVote = (pickBT && pickBT.sharpe > 0 && pickBT.lastRSI < 60) ? 1 :
                         (pickBT && pickBT.sharpe < 0) ? -1 : 0;
      const pickBuyVotes = [pickAiVote, pickRlVote, pickBtVote].filter(v=>v>0).length;
      const pickSellVotes = [pickAiVote, pickRlVote, pickBtVote].filter(v=>v<0).length;
      const pickConsensusMult = pickBuyVotes >= 3 ? 1.4 : pickBuyVotes >= 2 ? 1.1 :
                                pickSellVotes > 0 ? 0.5 : 0.8;

      if(pick.endorsements >= minEndorsements){
        // Kelly‰ªì‰Ωç: Áî®ÂõûÊµãKelly √ó ÂÖ±ËØÜÁ≥ªÊï∞
        const pickKelly = pickBT?.finalKelly || 0.1;
        const basePct = Math.min(dsScore >= 60 ? 0.18 : 0.12, pickKelly * 1.5) * pickConsensusMult;
        const amount = Math.min(Math.round(simPortfolio.cash * basePct), 25000);
        if(amount >= 5000){
          const kTag = pickBT ? ` Sharpe:${pickBT.sharpe.toFixed(1)} Kelly:${(pickKelly*100).toFixed(0)}%` : '';
          const rlTag2 = pickRL ? ` RL:${pickRL.action===1?'‰π∞':pickRL.action===2?'Âçñ':'ÊåÅ'}${pickRL.confidence}%` : '';
          simTrade(pick.code, 'buy', amount, `AIÊé®Ëçê(${pick.endorsements}ÂºïÊìé) [ÊäïÁ•®${pickBuyVotes}‰π∞√ó${pickConsensusMult.toFixed(1)} Êï∞ÊçÆ${dsScore}${kTag}${rlTag2}]: ${(pick.reason||'').slice(0,30)}`);
          tradesExecuted++;
        }
      }
    });
  }

  // 4. Á≠ñÁï•Â≠¶‰π†
  learnFromPerformance();
  // 5. RLÂú®Á∫øÂ≠¶‰π†ÂèçÈ¶àÔºöÁî®Ê®°ÊãüÁõò‰∫§ÊòìÁªìÊûúËøõË°åÂ¢ûÈáèËÆ≠ÁªÉ
  if(tradesExecuted > 0) rlOnlineLearning();
  saveSimPortfolio();
  return tradesExecuted;
}

// ==================== RLÂú®Á∫øÂ≠¶‰π† (Online Learning from Sim Trades) ====================
function rlOnlineLearning(){
  if(!_rlModelLoaded || !rlTrainer?.agent || !simPortfolio?.history) return;
  const today = todayStr();
  const todayTrades = simPortfolio.history.filter(h => h.date === today);
  if(!todayTrades.length) return;

  let onlineReplayCount = 0;
  for(const trade of todayTrades){
    const code = trade.code;
    const hd = fundHistoryData[code];
    if(!hd?.navs || hd.navs.length < 25) continue;
    const navArr = hd.navs.map(n=>({date:n[0],nav:parseFloat(n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
    if(navArr.length < 25) continue;

    // ÊûÑÂª∫ÂΩìÂâçÁä∂ÊÄÅ
    const env = new MarketEnv(navArr, code);
    env.idx = navArr.length - 1;
    const simPos = simPortfolio.positions.find(p => p.code === code);
    env.pos = simPos ? 1 : 0;
    if(simPos) env.entryPrice = simPos.avgCost;
    const state = env._state();
    // Ê≥®ÂÖ•ÂÆèËßÇ/ËàÜÊÉÖ/ËµÑÈáëÊµÅ
    if(_dataIntelLoaded){
      const ds = generateDataSignal();
      state[12] = rlClip((ds.score-50)/25, -2, 2);
      state[13] = rlClip((newsSentiment.score-50)/25, -2, 2);
      const cn = sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0), 0);
      state[14] = rlClip(cn/1e10, -2, 2);
    }

    // Êò†Â∞Ñ‰∫§ÊòìÂä®‰ΩúÂà∞RL action
    const action = trade.action === 'buy' ? 1 : trade.action === 'sell' ? 2 : 0;

    // ËÆ°ÁÆóÂç≥Êó∂Â•ñÂä±: Âü∫‰∫éÂΩìÊó•‰∫§ÊòìÂêéÊåÅ‰ªìË°®Áé∞
    let reward = 0;
    const fd = getFundData(code);
    const todayPct = (fd?.gszzl || 0) / 100;
    if(action === 1){ // ‰π∞ÂÖ•
      reward = todayPct > 0 ? todayPct * 5 : todayPct * 8; // ‰π∞ÂØπÂ•ñÂä±Ôºå‰π∞ÈîôÊâÅÁΩö
    } else if(action === 2){ // ÂçñÂá∫
      reward = todayPct < 0 ? Math.abs(todayPct) * 5 : -todayPct * 3; // ÂçñÂØπÂ•ñÂä±ÔºåÂçñÈîôËΩªÁΩö
    }
    // ÁªÑÂêàÁ∫ßÂ•ñÂä±Âä†Êàê
    const totalValue = getSimTotalValue();
    const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL;
    reward += rlClip(cumReturn * 2, -0.5, 0.5);

    // ÊûÑÂª∫‰∏ã‰∏ÄÁä∂ÊÄÅ(Áî®ÂΩìÂâçÁä∂ÊÄÅÁï•ÂæÆÂÅèÁßª)
    const nextState = Float32Array.from(state);
    nextState[10] = simPos ? 1 : 0; // Êõ¥Êñ∞ÊåÅ‰ªìÁä∂ÊÄÅ

    // ÂñµÂÖ•ÁªèÈ™åÂπ∂ÂÅöÂ∞èÊâπÈáèËÆ≠ÁªÉ
    rlTrainer.agent.remember(state, action, reward, nextState, false);
    onlineReplayCount++;
  }

  // Â¢ûÈáèËÆ≠ÁªÉ: ÊØèÊ¨°Âú®Á∫øÂ≠¶‰π†ÂÅöÂ∞ëÈáèReplay
  if(onlineReplayCount > 0 && rlTrainer.agent.memory.length >= rlTrainer.agent.batchSize * 2){
    const onlineBatches = Math.min(onlineReplayCount * 2, 8);
    for(let i = 0; i < onlineBatches; i++){
      rlTrainer.agent.replay();
    }
    // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊ®°Âûã
    rlTrainer.saveModel();
    // ÈáçÊñ∞ÁîüÊàê‰ø°Âè∑
    rlTrainer.generateSignals();
    renderRLBrief();
    console.log(`RLÂú®Á∫øÂ≠¶‰π†: ${onlineReplayCount}Êù°ÁªèÈ™å¬∑${onlineBatches}Ê¨°Replay¬∑Œµ=${rlTrainer.agent.epsilon.toFixed(4)}`);
  }
}

function learnFromPerformance(){
  if(!simPortfolio || simPortfolio.dailySnapshots.length < 2) return;
  const today = todayStr();
  const snapshots = simPortfolio.dailySnapshots;
  const recent = snapshots.slice(-5);
  const avgDailyReturn = recent.reduce((s,d) => s + d.dailyReturn, 0) / recent.length;
  const strategy = simPortfolio.strategy;
  let lesson = '';
  let strategyChange = '';

  if(recent.length >= 3){
    const negDays = recent.filter(d => d.dailyReturn < 0).length;
    const posDays = recent.filter(d => d.dailyReturn > 0).length;
    if(negDays >= 4 && strategy.stopLoss > -6){
      strategy.stopLoss = Math.max(strategy.stopLoss - 1, -10);
      strategyChange = `ËøûÁª≠‰∫èÊçü${negDays}Â§©‚ÜíÊ≠¢ÊçüÊî∂Á¥ßËá≥${strategy.stopLoss}%`;
      lesson = 'Â∏ÇÂú∫ÊåÅÁª≠Ëµ∞Âº±ÔºåÂáèÂ∞ëÂç´Êòü‰ªìÊïûÂè£ÔºåÂä†Âº∫È£éÊéß';
    }
    if(posDays >= 4 && strategy.takeProfit < 25){
      strategy.takeProfit = Math.min(strategy.takeProfit + 2, 30);
      strategyChange = `ËøûÁª≠ÁõàÂà©${posDays}Â§©‚ÜíÊ≠¢Áõà‰∏äË∞ÉËá≥${strategy.takeProfit}%`;
      lesson = 'Â∏ÇÂú∫Ë∂ãÂäøËâØÂ•ΩÔºå‰øùÊåÅ‰ªì‰ΩçËÆ©Âà©Ê∂¶Â•îË∑ë';
    }
  }

  // ÊùøÂùóËÉúÁéáÂàÜÊûê
  const latestSnap = snapshots[snapshots.length - 1];
  if(latestSnap?.positions){
    const winCount = latestSnap.positions.filter(p => p.todayPct > 0).length;
    const loseCount = latestSnap.positions.filter(p => p.todayPct < 0).length;
    if(loseCount > winCount && !lesson) lesson = `‰ªäÊó•${loseCount}Ë∑å/${winCount}Ê∂®ÔºåÊ≥®ÊÑèÂõûË∞ÉÈ£éÈô©`;
  }

  // È¢ÑÊµãÂáÜÁ°ÆÁéáÂèçÈ¶à
  const review = generateDailyReview();
  if(review && review.accuracy < 40 && !lesson){
    lesson = `AIÈ¢ÑÊµãÂáÜÁ°ÆÁéá‰ªÖ${review.accuracy}%ÔºåÂáèÂ∞ëÈ¢ëÁπÅÊìç‰Ωú`;
    if(strategy.dipBuyThreshold > -2.5){
      strategy.dipBuyThreshold -= 0.5;
      strategyChange += (strategyChange?'Ôºõ':'') + `Âä†‰ªìÈòàÂÄº‚Üí${strategy.dipBuyThreshold}%`;
    }
  }

  // ÊúàÂ∫¶ÂõûÊä•Ê£ÄÊü•
  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const daysRunning = snapshots.length;
  if(daysRunning >= 10){
    const monthlyPace = cumReturn / daysRunning * 22;
    if(monthlyPace < 1 && !lesson){
      lesson = `ÊúàÂåñÊî∂ÁõäÁéáÁ∫¶${monthlyPace.toFixed(1)}%Ôºå‰Ωé‰∫é2%ÁõÆÊ†áÔºåÈúÄÊèêÈ´òËøõÊîªÊÄß`;
      if(strategy.dipBuyThreshold > -2.0){
        strategy.dipBuyThreshold = Math.max(strategy.dipBuyThreshold + 0.3, -1.0);
        strategyChange += (strategyChange?'Ôºõ':'') + `Èôç‰ΩéÂä†‰ªìÈó®Êßõ‚Üí${strategy.dipBuyThreshold.toFixed(1)}%`;
      }
    }
    if(monthlyPace > 5 && !lesson){
      lesson = `ÊúàÂåñÁ∫¶${monthlyPace.toFixed(1)}%ÔºåÂ§ßÂπÖË∂ÖÈ¢ùÔºåÈÄÇÂΩìÈîÅÂÆöÂà©Ê∂¶Èò≤ÂõûÊí§`;
    }
  }

  if(lesson || strategyChange){
    simPortfolio.learningLog.push({
      date:today, lesson, strategyChange,
      cumReturn:+cumReturn.toFixed(2),
      avgDailyReturn:+avgDailyReturn.toFixed(3),
    });
    if(simPortfolio.learningLog.length > 30) simPortfolio.learningLog = simPortfolio.learningLog.slice(-30);
  }
  saveSimPortfolio();
}

// ==================== DATA INTELLIGENCE RENDERING ====================
function toggleDataIntel(){
  const container = document.getElementById('data-intel-container');
  const icon = document.getElementById('data-intel-toggle');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = '‚ñº';
    renderDataIntel();
  } else {
    container.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

function renderDataIntelBrief(){
  const el = document.getElementById('data-intel-brief');
  if(!el) return;
  if(!_dataIntelLoaded){ el.innerHTML = '<span style="color:var(--sub)">Âä†ËΩΩ‰∏≠...</span>'; return; }
  const macro = getMacroSummary();
  const sentColor = newsSentiment.score>=55 ? 'var(--red)' : newsSentiment.score<=45 ? 'var(--green)' : 'var(--sub)';
  el.innerHTML = `<span style="color:${macro.positiveCount>=3?'var(--red)':'var(--green)'}">${macro.overallSignal}</span> ¬∑ <span style="color:${sentColor}">ËàÜÊÉÖ${newsSentiment.label}</span>`;
}

function renderDataIntel(){
  const container = document.getElementById('data-intel-container');
  if(!container) return;
  if(!_dataIntelLoaded){
    container.innerHTML = '<div style="text-align:center;padding:20px;font-size:11px;color:var(--sub)"><div class="spinner"></div><div style="margin-top:8px">Êï∞ÊçÆÂä†ËΩΩ‰∏≠...</div></div>';
    return;
  }
  let html = '';

  // 1. ÂÆèËßÇÁªèÊµéÈù¢Êùø
  const macro = getMacroSummary();
  html += '<div class="macro-card"><div class="macro-card-title">üìä ÂÆèËßÇÁªèÊµéÊåáÊ†á <span style="font-size:9px;font-weight:400;color:var(--sub)">‰∏úÊñπË¥¢ÂØåÊï∞ÊçÆ‰∏≠ÂøÉ</span></div>';
  html += '<div class="macro-grid">';
  macro.signals.forEach(s=>{
    const cls = s.positive ? 'positive' : 'negative';
    html += `<div class="macro-item"><span class="macro-label">${s.name}</span><span class="macro-val ${cls}">${s.value}</span><span class="macro-label">${s.signal}</span></div>`;
  });
  html += '</div>';
  // Ë∂ãÂäøÂØπÊØîÔºàÂ¶ÇÊûúÊúâÂ§öÊúüÊï∞ÊçÆÔºâ
  if(macroData.pmi && macroData.pmi.length>=2){
    const curr = macroData.pmi[0].MAKE_INDEX;
    const prev = macroData.pmi[1].MAKE_INDEX;
    const trend = curr>prev ? 'üìàÁéØÊØîÊîπÂñÑ' : curr<prev ? 'üìâÁéØÊØîËµ∞Âº±' : '‚û°Ô∏èÊåÅÂπ≥';
    html += `<div style="font-size:9px;color:var(--sub);margin-top:6px;text-align:center">Âà∂ÈÄ†‰∏öPMIË∂ãÂäø: ${macroData.pmi[1].TIME?.replace('‰ªΩ','')}: ${prev} ‚Üí ${macroData.pmi[0].TIME?.replace('‰ªΩ','')}: ${curr} ${trend}</div>`;
  }
  html += '</div>';

  // 2. ÊùøÂùóËµÑÈáëÊµÅÂêë
  const capFlow = getCapFlowSummary();
  if(sectorCapFlow.length > 0){
    html += '<div class="macro-card"><div class="macro-card-title">üí∞ ÊùøÂùó‰∏ªÂäõËµÑÈáëÊµÅÂêë <span style="font-size:9px;font-weight:400;color:var(--sub)">‰ªäÊó•ÂÆûÊó∂</span></div>';
    const maxAbs = Math.max(...sectorCapFlow.map(s=>Math.abs(s.mainNet||0)), 1);
    // Net total
    const netBillion = capFlow.netTotal / 1e8;
    const netColor = netBillion >= 0 ? 'var(--red)' : 'var(--green)';
    html += `<div style="text-align:center;margin-bottom:8px;font-size:11px">ÂÖ®Â∏ÇÂú∫‰∏ªÂäõÂáÄÊµÅÂÖ•: <span style="color:${netColor};font-weight:700">${netBillion>=0?'+':''}${netBillion.toFixed(1)}‰∫ø</span></div>`;
    // Top inflow
    capFlow.topInflow.slice(0,4).forEach(s=>{
      const val = (s.mainNet/1e8).toFixed(1);
      const w = Math.min(100, Math.abs(s.mainNet)/maxAbs*100);
      html += `<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px"><span style="min-width:56px;font-weight:600">${s.name}</span><div class="cap-flow-bar" style="flex:1"><div class="cap-flow-fill" style="width:${w}%;background:var(--red)"></div></div><span style="min-width:46px;text-align:right;color:var(--red);font-weight:600">+${val}‰∫ø</span></div>`;
    });
    // Top outflow
    capFlow.topOutflow.slice(0,3).forEach(s=>{
      const val = (s.mainNet/1e8).toFixed(1);
      const w = Math.min(100, Math.abs(s.mainNet)/maxAbs*100);
      html += `<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px"><span style="min-width:56px;font-weight:600">${s.name}</span><div class="cap-flow-bar" style="flex:1"><div class="cap-flow-fill" style="width:${w}%;background:var(--green)"></div></div><span style="min-width:46px;text-align:right;color:var(--green);font-weight:600">${val}‰∫ø</span></div>`;
    });
    html += '</div>';
  }

  // 3. ËàÜÊÉÖ/Êñ∞ÈóªÊÉÖÁª™
  html += '<div class="macro-card"><div class="macro-card-title">üì∞ Ë¥¢ÁªèËàÜÊÉÖÂàÜÊûê <span style="font-size:9px;font-weight:400;color:var(--sub)">NLPÊÉÖÁª™ËØÜÂà´ ¬∑ Êñ∞Êµ™Ë¥¢Áªè</span></div>';
  // Sentiment meter
  const sentColor = newsSentiment.score>=60 ? 'var(--red)' : newsSentiment.score<=40 ? 'var(--green)' : '#f59e0b';
  html += `<div class="sentiment-meter"><span style="font-size:9px;color:var(--green)">ÊÇ≤ËßÇ</span><div class="sentiment-bar"><div class="sentiment-dot" style="left:calc(${newsSentiment.score}% - 7px);border-color:${sentColor}"></div></div><span style="font-size:9px;color:var(--red)">‰πêËßÇ</span></div>`;
  html += `<div style="text-align:center;font-size:11px;margin-bottom:8px">ÊÉÖÁª™ÊåáÊï∞: <span style="color:${sentColor};font-weight:700">${newsSentiment.score}</span>/100 ¬∑ <span style="font-weight:600">${newsSentiment.label}</span> <span style="font-size:9px;color:var(--sub)">(Âà©Â•Ω${newsSentiment.bullCount}Êù° / Âà©Á©∫${newsSentiment.bearCount}Êù° / ÂÖ±${newsSentiment.total}Êù°)</span></div>`;
  // News headlines
  if(newsHeadlines.length > 0){
    const displayNews = newsHeadlines.slice(0, 8);
    displayNews.forEach(n=>{
      const icon = n.sentiment==='bull' ? 'üü¢' : n.sentiment==='bear' ? 'üî¥' : '‚ö™';
      html += `<div class="news-item"><span class="news-sentiment">${icon}</span><span class="news-text">${n.title}</span><span class="news-time">${n.time}</span></div>`;
    });
  } else {
    html += '<div style="text-align:center;padding:10px;font-size:11px;color:var(--sub)">ÊöÇÊó†Êñ∞ÈóªÊï∞ÊçÆ</div>';
  }
  html += '</div>';

  // 4. üåç ÂõΩÈôÖÊñ∞ÈóªËÅöÂêà
  html += '<div class="macro-card"><div class="macro-card-title">üåç ÂõΩÈôÖÊñ∞ÈóªËÅöÂêà <span style="font-size:9px;font-weight:400;color:var(--sub)">ÂÖ®ÁêÉÂçÅÂ§ßÂ™í‰Ωì ¬∑ ÊîøÊ≤ªÁªèÊµé</span></div>';
  if(_globalNewsLoading){
    html += '<div style="text-align:center;padding:12px;font-size:11px;color:var(--sub)"><div class="spinner"></div><div style="margin-top:6px">Ê≠£Âú®ËÅöÂêàÂõΩÈôÖÊñ∞Èóª...</div></div>';
  } else if(globalNews.length > 0){
    // Êù•Ê∫êÊ†áÁ≠æ
    const srcCounts = {};
    globalNews.forEach(n=>{ srcCounts[n.source] = (srcCounts[n.source]||0)+1; });
    html += '<div class="global-news-sources">';
    Object.entries(srcCounts).sort((a,b)=>b[1]-a[1]).forEach(([src,cnt])=>{
      html += `<span class="global-news-tag active">${src} ${cnt}</span>`;
    });
    html += '</div>';
    // ÂõΩÈôÖÊñ∞ÈóªÊÉÖÁª™
    const gSent = getGlobalNewsSentiment();
    const gSentColor = gSent.score>=58 ? '#ef4444' : gSent.score<=42 ? '#22c55e' : '#f59e0b';
    html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px 10px;background:var(--bg);border-radius:8px">`;
    html += `<span style="font-size:9px;color:var(--sub)">ÂõΩÈôÖËàÜÊÉÖ</span>`;
    html += `<div style="flex:1;height:6px;border-radius:3px;background:linear-gradient(90deg,#22c55e,#fbbf24,#ef4444);position:relative"><div style="width:10px;height:10px;border-radius:50%;background:#fff;border:2px solid ${gSentColor};position:absolute;top:-2px;left:calc(${gSent.score}% - 5px);transition:left .3s"></div></div>`;
    html += `<span style="font-size:11px;font-weight:700;color:${gSentColor}">${gSent.score}</span>`;
    html += `<span style="font-size:9px;color:var(--sub)">${gSent.label}</span>`;
    html += `</div>`;
    // Êñ∞ÈóªÂàóË°®
    globalNews.slice(0,10).forEach(n=>{
      const icon = n.sentiment==='bull'?'üü¢':n.sentiment==='bear'?'üî¥':'‚ö™';
      html += `<div class="global-news-item">`;
      html += `<span class="global-news-src">${n.source}</span>`;
      html += `<span style="font-size:11px;min-width:14px">${icon}</span>`;
      const displayTitle = n.titleCN || n.title;
      html += `<span class="global-news-title"><a href="${n.url}" target="_blank" rel="noopener">${displayTitle}</a>${n.titleCN?'<div style="font-size:9px;color:var(--sub);margin-top:1px">'+n.title+'</div>':''}</span>`;
      html += `<span class="global-news-time">${n.timeFormatted}</span>`;
      html += `</div>`;
    });
    // AIÊëòË¶ÅÊåâÈíÆÊàñÂ∑≤ÊúâÊëòË¶Å
    if(globalNewsSummary){
      html += renderGlobalNewsSummaryHTML();
    } else {
      html += `<button class="global-news-btn" onclick="triggerGlobalNewsSummary()" ${_globalNewsLoading?'disabled':''}>ü§ñ AIÂàÜÊûêÂõΩÈôÖÂΩ¢Âäø & ÊäïËµÑÂΩ±Âìç</button>`;
    }
  } else {
    html += '<div style="text-align:center;padding:12px;font-size:11px;color:var(--sub)">ÊöÇÊó†ÂõΩÈôÖÊñ∞ÈóªÊï∞ÊçÆ</div>';
    html += `<button class="global-news-btn" onclick="manualFetchGlobalNews()">üîÑ ÊâãÂä®Âä†ËΩΩÂõΩÈôÖÊñ∞Èóª</button>`;
  }
  html += '</div>';

  // 5. ÁªºÂêàÊï∞ÊçÆ‰ø°Âè∑
  html += '<div class="macro-card" style="background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff">';
  html += '<div class="macro-card-title" style="color:rgba(255,255,255,0.9)">ü§ñ AIÊï∞ÊçÆ‰ø°Âè∑ÁªºÂêà <span style="font-size:9px;font-weight:400;color:rgba(255,255,255,0.5)">ÂõõÁª¥Â∫¶ËûçÂêà</span></div>';
  const dataSignal = generateDataSignal();
  const gSentForSignal = getGlobalNewsSentiment();
  const gSentSignalColor = gSentForSignal.score>=58?'#ef4444':gSentForSignal.score<=42?'#22c55e':'#fbbf24';
  html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-top:6px">`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">ÂÆèËßÇÈù¢</div><div style="font-size:12px;font-weight:700;color:${macro.positiveCount>=3?'#ef4444':'#22c55e'}">${macro.overallSignal}</div></div>`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">ËµÑÈáëÈù¢</div><div style="font-size:12px;font-weight:700;color:${capFlow.netTotal>=0?'#ef4444':'#22c55e'}">${capFlow.netTotal>=0?'ËµÑÈáëÊµÅÂÖ•':'ËµÑÈáëÊµÅÂá∫'}</div></div>`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">ËàÜÊÉÖÈù¢</div><div style="font-size:12px;font-weight:700;color:${sentColor}">${newsSentiment.label}</div></div>`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">ÂõΩÈôÖÈù¢</div><div style="font-size:12px;font-weight:700;color:${gSentSignalColor}">${globalNews.length>0?gSentForSignal.label:'Âä†ËΩΩ‰∏≠'}</div></div>`;
  html += '</div>';
  html += `<div style="text-align:center;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)"><div style="font-size:10px;color:rgba(255,255,255,0.5)">ÁªºÂêà‰ø°Âè∑</div><div style="font-size:16px;font-weight:800;margin-top:2px;color:${dataSignal.color}">${dataSignal.icon} ${dataSignal.label}</div><div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">${dataSignal.advice}</div></div>`;
  html += '</div>';

  container.innerHTML = html;
}

function generateDataSignal(){
  let score = 50; // 50=‰∏≠ÊÄß
  // ÂÆèËßÇÈù¢ ¬±15
  const macro = getMacroSummary();
  score += (macro.positiveCount - 2.5) * 6;
  // ËµÑÈáëÈù¢ ¬±15
  const capFlow = getCapFlowSummary();
  if(capFlow.netTotal > 5e9) score += 15;
  else if(capFlow.netTotal > 0) score += 8;
  else if(capFlow.netTotal < -5e9) score -= 15;
  else if(capFlow.netTotal < 0) score -= 8;
  // ËàÜÊÉÖÈù¢ ¬±10
  score += (newsSentiment.score - 50) * 0.2;
  // ÂõΩÈôÖËàÜÊÉÖÈù¢ ¬±8
  if(globalNews.length > 0){
    const gSent = getGlobalNewsSentiment();
    score += (gSent.score - 50) * 0.16;
    // AIËØÑÂàÜÂä†ÊùÉ
    if(globalNewsSummary?.score) score += (globalNewsSummary.score - 50) * 0.08;
  }
  // PMIÁâπÊÆäÊùÉÈáç
  if(macroData.pmi?.[0]){
    const pmi = macroData.pmi[0].MAKE_INDEX;
    if(pmi >= 51) score += 5;
    else if(pmi < 49) score -= 5;
  }

  score = Math.max(0, Math.min(100, Math.round(score)));
  if(score >= 70) return { score, label:'ÁßØÊûÅÁúãÂ§ö', icon:'üü¢', color:'#ef4444', advice:'ÂÆèËßÇ+ËµÑÈáë+ËàÜÊÉÖ+ÂõΩÈôÖÂõõÁª¥ÂÖ±ÊåØÂÅèÂ§öÔºåÂèØÈÄÇÂΩìÂ¢ûÈÖç' };
  if(score >= 58) return { score, label:'Ë∞®ÊÖéÂÅèÂ§ö', icon:'üü°', color:'#f59e0b', advice:'Â§öÊï∞ÊåáÊ†áÂÅèÊ≠£Èù¢ÔºåÁª¥ÊåÅ‰ªì‰Ωç„ÄÅÂèØ‰ΩéÂê∏' };
  if(score >= 42) return { score, label:'‰∏≠ÊÄßËßÇÊúõ', icon:'‚ö™', color:'rgba(255,255,255,0.7)', advice:'‰ø°Âè∑ÂàÜÊ≠ßËæÉÂ§ßÔºåÁª¥ÊåÅÁé∞ÊúâÈÖçÁΩÆ‰∏çÂÆúÊøÄËøõ' };
  if(score >= 30) return { score, label:'Ë∞®ÊÖéÂÅèÁ©∫', icon:'üü†', color:'#f59e0b', advice:'ÈÉ®ÂàÜÊåáÊ†áËµ∞Âº±ÔºåÊéßÂà∂‰ªì‰Ωç„ÄÅÈôç‰ΩéÈ£éÈô©ÊïûÂè£' };
  return { score, label:'Èò≤Âæ°‰∏∫‰∏ª', icon:'üî¥', color:'#22c55e', advice:'Â§öÁª¥Â∫¶‰ø°Âè∑ÂÅèË¥üÈù¢ÔºåÂª∫ËÆÆÈôç‰Ωé‰ªì‰Ωç„ÄÅÂ¢ûÂä†Áé∞Èáë' };
}

// ==================== GLOBAL NEWS RENDERING HELPERS ====================
function renderGlobalNewsSummaryHTML(){
  const s = globalNewsSummary;
  if(!s) return '';
  let html = '<div class="global-news-summary">';
  html += '<div class="global-news-summary-title">ü§ñ AIÂõΩÈôÖÂΩ¢ÂäøÂàÜÊûê</div>';
  if(s.overview) html += `<div style="margin-bottom:8px">${s.overview}</div>`;
  if(s.keyEvents && s.keyEvents.length){
    html += '<div style="margin-bottom:6px"><span style="font-size:10px;font-weight:700;color:#93c5fd">üìå ÂÖ≥ÈîÆ‰∫ã‰ª∂:</span></div>';
    s.keyEvents.forEach(e=>{ html += `<div class="global-news-impact-item">‚Ä¢ ${e}</div>`; });
  }
  if(s.impact){
    html += '<div class="global-news-impact">';
    html += '<div class="global-news-impact-title">üìä ÂØπ‰∏≠ÂõΩÂ∏ÇÂú∫ÂΩ±ÂìçÂàÜÊûê</div>';
    if(s.impact.positive && s.impact.positive.length){
      html += '<div style="margin-bottom:4px"><span style="color:#4ade80;font-size:10px;font-weight:600">‚úÖ Âà©Â•ΩÂõ†Á¥†:</span></div>';
      s.impact.positive.forEach(p=>{ html += `<div class="global-news-impact-item" style="color:#86efac">  ${p}</div>`; });
    }
    if(s.impact.negative && s.impact.negative.length){
      html += '<div style="margin-bottom:4px;margin-top:4px"><span style="color:#f87171;font-size:10px;font-weight:600">‚ö†Ô∏è Âà©Á©∫Âõ†Á¥†:</span></div>';
      s.impact.negative.forEach(p=>{ html += `<div class="global-news-impact-item" style="color:#fca5a5">  ${p}</div>`; });
    }
    if(s.impact.sectors && s.impact.sectors.length){
      html += `<div style="margin-top:4px;font-size:10px"><span style="color:#93c5fd;font-weight:600">üè≠ ÂèóÂΩ±ÂìçÊùøÂùó: </span><span style="color:#e2e8f0">${s.impact.sectors.join('„ÄÅ')}</span></div>`;
    }
    html += '</div>';
  }
  if(s.advice && s.advice.length){
    html += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">';
    html += '<div style="font-size:10px;font-weight:700;color:#fbbf24;margin-bottom:4px">üí° ÊäïËµÑÂª∫ËÆÆ</div>';
    s.advice.forEach(a=>{ html += `<div class="global-news-impact-item" style="color:#fde68a">‚Ä¢ ${a}</div>`; });
    html += '</div>';
  }
  // ÊÉÖÁª™ËØÑÂàÜ
  const aiScore = s.score || 50;
  const aiColor = aiScore>=60 ? '#4ade80' : aiScore<=40 ? '#f87171' : '#fbbf24';
  html += `<div class="global-news-sentiment"><div class="global-news-sentiment-item"><div class="global-news-sentiment-label">AIËØÑÂàÜ</div><div class="global-news-sentiment-val" style="color:${aiColor}">${aiScore}</div></div></div>`;
  html += '</div>';
  return html;
}

async function triggerGlobalNewsSummary(){
  const btn = event?.target;
  if(btn){ btn.disabled=true; btn.textContent='ü§ñ AIÂàÜÊûê‰∏≠...'; }
  await summarizeGlobalNewsAI();
  renderDataIntel();
}

async function manualFetchGlobalNews(){
  const btn = event?.target;
  if(btn){ btn.disabled=true; btn.textContent='‚è≥ Âä†ËΩΩ‰∏≠...'; }
  await fetchGlobalNews();
  renderDataIntel();
  // Ëá™Âä®Ëß¶ÂèëAIÂàÜÊûê
  if(globalNews.length > 0) triggerGlobalNewsSummary();
}

// ==================== RL BRAIN RENDERING ====================
function toggleRLBrain(){
  const c=document.getElementById('rl-brain-container');
  const i=document.getElementById('rl-brain-toggle');
  if(c.style.display==='none'){c.style.display='block';i.textContent='‚ñº';renderRLBrain();}
  else{c.style.display='none';i.textContent='‚ñ∂';}
}

function renderRLBrief(){
  const el=document.getElementById('rl-brain-brief');
  if(!el)return;
  if(_rlTraining){
    el.style.color='#eab308';
    el.textContent=`ËÆ≠ÁªÉ‰∏≠ E${(rlTrainer?.episode||0)+1}/${rlTrainer?.maxEpisodes||50}`;
    return;
  }
  if(!_rlModelLoaded||!rlTrainer?.agent){
    el.style.color='var(--sub)';el.textContent='Êú™ËÆ≠ÁªÉ';return;
  }
  const sigs=Object.values(_rlSignals);
  if(!sigs.length){el.style.color='var(--sub)';el.textContent=`Â∑≤ËÆ≠ÁªÉ¬∑E${rlTrainer.episode+1}`;return;}
  const buys=sigs.filter(s=>s.action===1).length;
  const sells=sigs.filter(s=>s.action===2).length;
  const holds=sigs.filter(s=>s.action===0).length;
  let txt='üß† ';
  if(buys>0)txt+=`‰π∞${buys} `;
  if(sells>0)txt+=`Âçñ${sells} `;
  if(holds>0)txt+=`ÊåÅ${holds}`;
  const avgConf=Math.round(sigs.reduce((s,v)=>s+v.confidence,0)/sigs.length);
  el.style.color=buys>sells?'var(--red)':sells>buys?'var(--green)':'var(--sub)';
  el.textContent=txt.trim()+` (${avgConf}%)`;
}

function renderRLBrain(){
  const container=document.getElementById('rl-brain-container');
  if(!container||container.style.display==='none')return;
  const hasModel=_rlModelLoaded&&rlTrainer?.agent;
  const m=rlTrainer?.metrics||{};
  const sClass=_rlTraining?'training':hasModel?'active':'idle';
  const sTxt=_rlTraining?
    `ËÆ≠ÁªÉ‰∏≠ Episode ${(rlTrainer.episode||0)+1}/${rlTrainer.maxEpisodes}`:
    hasModel?`Â∑≤Â∞±Áª™ ¬∑ ${rlTrainer.agent.trainSteps}Ê≠•ËÆ≠ÁªÉ ¬∑ Œµ=${rlTrainer.agent.epsilon.toFixed(3)}`:'Ê®°ÂûãÊú™ËÆ≠ÁªÉ';

  let html='';
  // Status + Metrics card
  html+=`<div class="rl-card"><div class="rl-card-title">üß† DQNÂº∫ÂåñÂ≠¶‰π†ÂºïÊìé</div>`;
  html+=`<div class="rl-status"><span class="rl-status-dot ${sClass}"></span><span class="rl-status-text">${sTxt}</span></div>`;
  if(_rlTraining&&rlTrainer){
    const pct=Math.round((rlTrainer.episode+1)/rlTrainer.maxEpisodes*100);
    html+=`<div class="rl-progress"><div class="rl-progress-fill" style="width:${pct}%"></div></div>`;
  }
  if(hasModel){
    html+=`<div class="rl-metrics">`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Âπ≥ÂùáÊî∂Áõä</span><span class="rl-metric-val" style="color:${(m.avgReturn||0)>=0?'var(--red)':'var(--green)'}">${(m.avgReturn||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">ËÉúÁéá</span><span class="rl-metric-val">${(m.winRate||0).toFixed(0)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Sharpe</span><span class="rl-metric-val">${(m.sharpe||0).toFixed(2)}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">ÊúÄ‰Ω≥ÂõûÊä•</span><span class="rl-metric-val" style="color:var(--red)">${(m.bestReturn||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">ËÆ≠ÁªÉËΩÆÊ¨°</span><span class="rl-metric-val">${(rlTrainer.episode||0)+1}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Êé¢Á¥¢ÁéáŒµ</span><span class="rl-metric-val">${rlTrainer.agent.epsilon.toFixed(3)}</span></div>`;
    html+=`</div>`;
    if(m.portfolios&&m.portfolios.length>1)html+=renderRLChart(m.portfolios,'Êî∂ÁõäÁéá%');
  }
  // Train button
  if(_rlTraining){
    html+=`<button class="rl-train-btn stop" onclick="stopRLTraining()">‚èπ ÂÅúÊ≠¢ËÆ≠ÁªÉ</button>`;
  }else{
    const dc=Object.keys(fundHistoryData).length;
    html+=`<button class="rl-train-btn start" onclick="startRLTraining()" ${dc<1?'disabled title="ÈúÄË¶ÅÂÖàÂä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ"':''}>`;
    html+=hasModel?'üîÑ ÈáçÊñ∞ËÆ≠ÁªÉ (Double DQN)':'üöÄ ÂºÄÂßãËÆ≠ÁªÉ (Double DQN)';
    html+=`</button>`;
  }
  html+=`</div>`;

  // RL Signals card
  if(hasModel&&Object.keys(_rlSignals).length>0){
    html+=`<div class="rl-card"><div class="rl-card-title">üìä RLÂÜ≥Á≠ñ‰ø°Âè∑ <span style="font-size:9px;color:var(--sub);font-weight:400">QÂÄºÈ©±Âä®</span></div>`;
    for(const code of Object.keys(_rlSignals)){
      const sig=_rlSignals[code];
      const name=fundName(code);
      const ac=sig.action===1?'buy':sig.action===2?'sell':'hold';
      // Q-value bar visualization
      const qAbs=sig.qValues.map(v=>Math.abs(v));
      const qMax=Math.max(...qAbs,0.01);
      html+=`<div class="rl-signal-row">`;
      html+=`<span class="rl-signal-name">${name}</span>`;
      html+=`<div class="rl-qbar">`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[0]/qMax*30}px;background:var(--sub);opacity:0.5" title="Q(ÊåÅÊúâ)=${sig.qValues[0].toFixed(2)}"></div>`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[1]/qMax*30}px;background:var(--red);opacity:0.6" title="Q(‰π∞ÂÖ•)=${sig.qValues[1].toFixed(2)}"></div>`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[2]/qMax*30}px;background:var(--green);opacity:0.6" title="Q(ÂçñÂá∫)=${sig.qValues[2].toFixed(2)}"></div>`;
      html+=`</div>`;
      html+=`<span class="rl-signal-action ${ac}">${sig.actionName}</span>`;
      html+=`<span class="rl-signal-conf">${sig.confidence}%</span>`;
      html+=`</div>`;
    }
    html+=`</div>`;
  }

  // Architecture info
  html+=`<div class="rl-card"><div class="rl-card-title">‚öôÔ∏è Ê®°ÂûãÊû∂ÊûÑ</div>`;
  html+=`<div style="font-size:10px;color:var(--sub);line-height:1.6">`;
  html+=`<b>ÁÆóÊ≥ï:</b> Double DQN + Experience Replay + Adam Optimizer + Âú®Á∫øÂ≠¶‰π†<br>`;
  html+=`<b>ÁΩëÁªú:</b> [${RL_STATE_SIZE}] ‚Üí 64(ReLU) ‚Üí 32(ReLU) ‚Üí [${RL_ACTION_SIZE}]<br>`;
  html+=`<b>Áä∂ÊÄÅ:</b> Âä®Èáè(1/5/10/20Êó•) ¬∑ Ê≥¢Âä®Áéá(5/20Êó•) ¬∑ RSI ¬∑ MACD ¬∑ MAÂÅèÁ¶ª ¬∑ ÂõûÊí§ ¬∑ ÊåÅ‰ªì ¬∑ PnL ¬∑ ÂÆèËßÇ ¬∑ ËàÜÊÉÖ ¬∑ ËµÑÈáë ¬∑ <b style="color:#8b5cf6">ÂõûÊµãSharpe ¬∑ Kelly‰ªì‰Ωç ¬∑ ÂõûÊµãRSI</b><br>`;
  html+=`<b>Âä®‰Ωú:</b> ÊåÅÊúâ(0) / ‰π∞ÂÖ•(1) / ÂçñÂá∫(2)<br>`;
  html+=`<b>Â•ñÂä±:</b> ËµÑ‰∫ßÂ¢ûÂÄº(+) ¬∑ ‰∫èÊçü(-) ¬∑ ËøáÂ∫¶‰∫§ÊòìÊÉ©ÁΩö(-) ¬∑ ÂõûÊí§ÊÉ©ÁΩö(-) ¬∑ <b style="color:#f59e0b">Âú®Á∫øÂ≠¶‰π†ÂèçÈ¶à</b><br>`;
  html+=`<b>Ë∂ÖÂèÇ:</b> Œ≥=0.99 ¬∑ ŒµË°∞Âáè=0.998 ¬∑ batch=32 ¬∑ ËÆ∞ÂøÜÂ∫ì=10K ¬∑ ÁõÆÊ†áÁΩëÁªúÊõ¥Êñ∞=200Ê≠•<br>`;
  html+=`<b>ËÆ≠ÁªÉ:</b> Âü∫‰∫éÂÖ®ÈÉ®ÊåÅ‰ªì/Ëá™ÈÄâÂü∫ÈáëÂéÜÂè≤NAV(Ëøë1Âπ¥)ËÆ≠ÁªÉ ¬∑ ÊØèËΩÆÈÅçÂéÜÊâÄÊúâÂü∫Èáë<br>`;
  html+=`<b>Èó≠ÁéØ:</b> <span style="color:#22d3ee">ÂõûÊµãÁâπÂæÅÊ≥®ÂÖ• ‚Üí ‰∏âÂºïÊìéÊäïÁ•® ‚Üí Ê®°ÊãüÁõòÂú®Á∫øÂ≠¶‰π† ‚Üí RL‰ø°Âè∑Êõ¥Êñ∞</span>`;
  html+=`</div></div>`;

  container.innerHTML=html;
}

function renderRLChart(data,label){
  if(!data||data.length<2)return'';
  const max=Math.max(...data),min=Math.min(...data);
  const range=max-min||1;
  const h=50,w=100;
  const pts=data.map((v,i)=>{
    const x=(i/(data.length-1))*w;
    const y=h-((v-min)/range)*h;
    return`${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  let s=`<div class="rl-chart"><svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s+=`<defs><linearGradient id="rlGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#8b5cf6" stop-opacity="0.3"/><stop offset="100%" stop-color="#8b5cf6" stop-opacity="0.02"/></linearGradient></defs>`;
  s+=`<polygon points="0,${h+2} ${pts} ${w},${h+2}" fill="url(#rlGrad)"/>`;
  s+=`<polyline points="${pts}" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>`;
  // Zero line
  const zeroY=h-((-min)/range)*h;
  if(zeroY>0&&zeroY<h)s+=`<line x1="0" y1="${zeroY.toFixed(1)}" x2="${w}" y2="${zeroY.toFixed(1)}" stroke="rgba(255,255,255,0.15)" stroke-dasharray="2,2"/>`;
  s+=`</svg>`;
  s+=`<div style="position:absolute;bottom:2px;left:4px;font-size:8px;color:var(--sub)">${label}: ${data[data.length-1].toFixed(1)}</div>`;
  s+=`<div style="position:absolute;bottom:2px;right:4px;font-size:8px;color:var(--sub)">E${data.length}</div>`;
  s+=`</div>`;
  return s;
}

async function startRLTraining(){
  if(_rlTraining)return;
  if(!rlTrainer)rlTrainer=new RLTrainer();
  const count=rlTrainer.prepare();
  if(count===0){
    alert('Ê≤°ÊúâË∂≥Â§üÁöÑÂéÜÂè≤Êï∞ÊçÆËøõË°åËÆ≠ÁªÉ„ÄÇËØ∑ÂÖàÊ∑ªÂä†ÊåÅ‰ªìÂü∫ÈáëÂπ∂Á≠âÂæÖÂéÜÂè≤Êï∞ÊçÆÂä†ËΩΩ„ÄÇ\n\nÂΩìÂâçÂ∑≤Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ: '+Object.keys(fundHistoryData).length+' Âè™Âü∫Èáë');
    return;
  }
  _rlTraining=true;
  renderRLBrain();renderRLBrief();
  console.log(`RLËÆ≠ÁªÉÂºÄÂßã: ${count}Âè™Âü∫ÈáëÂéÜÂè≤Êï∞ÊçÆ, ${rlTrainer.maxEpisodes}ËΩÆËÆ≠ÁªÉ`);

  await rlTrainer.train((ep,total,metrics)=>{
    renderRLBrain();renderRLBrief();
  });

  _rlTraining=false;_rlModelLoaded=true;
  rlTrainer.generateSignals();
  renderRLBrain();renderRLBrief();
  console.log('RLËÆ≠ÁªÉÂÆåÊàê:',rlTrainer.metrics);
}

function stopRLTraining(){
  if(rlTrainer)rlTrainer.stop();
  _rlTraining=false;
  renderRLBrain();renderRLBrief();
}

// Build RL context for AI prompt
function buildRLContext(){
  if(!_rlModelLoaded||!rlTrainer?.agent||!Object.keys(_rlSignals).length)return'';
  let ctx='\n„Äêüß† RLÂº∫ÂåñÂ≠¶‰π†‰ø°Âè∑ (DQN)„Äë\n';
  ctx+=`Ê®°Âûã: Double DQN(18Áª¥) ¬∑ Â∑≤ËÆ≠ÁªÉ${rlTrainer.episode+1}ËΩÆ ¬∑ ${rlTrainer.agent.trainSteps}Ê≠• ¬∑ Âê´ÂõûÊµãÁâπÂæÅ+Âú®Á∫øÂ≠¶‰π†\n`;
  ctx+=`ÊåáÊ†á: ËÉúÁéá${(rlTrainer.metrics.winRate||0).toFixed(0)}% ¬∑ Âπ≥ÂùáÊî∂Áõä${(rlTrainer.metrics.avgReturn||0).toFixed(1)}% ¬∑ Sharpe${(rlTrainer.metrics.sharpe||0).toFixed(2)}\n`;
  ctx+='‰∏™ËÇ°RLÂÜ≥Á≠ñ:\n';
  for(const[code,sig]of Object.entries(_rlSignals)){
    const name=fundName(code);
    const qStr=sig.qValues.map(v=>v.toFixed(2)).join('/');
    ctx+=`  ${name}(${code}): ${sig.actionName}(ÁΩÆ‰ø°${sig.confidence}%) Q[ÊåÅ/‰π∞/Âçñ]=[${qStr}]\n`;
  }
  ctx+='‚ö†Ô∏è RL‰ø°Âè∑Â∑≤ËûçÂêàÂõûÊµãÁâπÂæÅ(Sharpe/Kelly/RSI)Âπ∂ÈÄöËøáÊ®°ÊãüÁõò‰∫§ÊòìÂú®Á∫øÂ≠¶‰π†„ÄÇ‰∏âÂºïÊìéÊäïÁ•®ÂÖ±ËØÜ: AI/RL/ÂõûÊµãÂ§öÊï∞Á•®ÂÜ≥Á≠ñÔºåÂàÜÊ≠ßÊó∂Áº©Âáè‰ªì‰Ωç„ÄÇ\n';
  return ctx;
}

function toggleSimDetail(){
  const container = document.getElementById('sim-container');
  const icon = document.getElementById('sim-toggle-icon');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = '‚ñº';
    renderSimPortfolio();
  } else {
    container.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

function renderSimBrief(){
  const brief = document.getElementById('sim-brief');
  if(!brief) return;
  if(!simPortfolio || !simPortfolio.positions || simPortfolio.positions.length===0){
    brief.innerHTML = holdings.length>0 ? '<span style="color:var(--sub)">ÂæÖÂª∫‰ªì</span>' : '<span style="color:var(--sub)">ÈúÄÊåÅ‰ªì</span>';
    return;
  }
  const totalValue = getSimTotalValue();
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  let liveCount = 0;
  simPortfolio.positions.forEach(p => { if(getFundData(p.code)?._live) liveCount++; });
  const total = simPortfolio.positions.length;
  const liveTag = liveCount===total ? 'üü¢' : liveCount>0 ? 'üü°' : 'üî¥';
  const color = cumProfit >= 0 ? 'var(--red)' : 'var(--green)';
  brief.innerHTML = `<span style="color:${color}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}ÂÖÉ</span> <span style="font-size:9px">${liveTag}${liveCount}/${total}</span>`;
}

function renderSimPortfolio(){
  const container = document.getElementById('sim-container');
  if(!simPortfolio || !simPortfolio.positions || simPortfolio.positions.length===0){
    const msg = holdings.length===0
      ? 'ËØ∑ÂÖàÊ∑ªÂä†ÊåÅ‰ªìÂü∫Èáë<br><span style="font-size:11px;color:var(--sub)">Ê®°ÊãüÁõòÂ∞ÜÂü∫‰∫éÊÇ®ÁöÑÊåÅ‰ªìËá™Âä®Âª∫‰ªì</span>'
      : '<span>ÊåÅ‰ªìÂ∑≤Â∞±Áª™ÔºåÁÇπÂáªÂª∫‰ªìÂºÄÂßãÊ®°Êãü</span><br><button class="form-btn" style="width:auto;padding:8px 20px;margin-top:10px;font-size:12px" onclick="syncSimFromHoldings()">üöÄ ‰ªéÊåÅ‰ªìÂºÄÂßãÂª∫‰ªì</button>';
    container.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div>${msg}</div>`;
    return;
  }

  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  const targetPct = SIM_TARGET_MONTHLY / SIM_INITIAL_CAPITAL * 100;
  const progressPct = Math.min(100, Math.max(0, cumReturn / targetPct * 100));

  let realPnlPct = 0;
  if(holdings.length > 0){
    holdings.forEach(h => { realPnlPct += (getFundData(h.code).gszzl||0); });
    realPnlPct /= holdings.length;
  }

  const snapshots = simPortfolio.dailySnapshots;
  const latestSnap = snapshots[snapshots.length - 1];
  const todayReturn = latestSnap?.dailyReturn || 0;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300CumPct = latestSnap?.hs300CumReturn || 0;
  const beatMarket = cumReturn > hs300CumPct;

  let html = '';

  // Ê¶ÇËßàÂç°Áâá
  html += `<div class="sim-overview">
    <div class="sim-stat-row">
      <div class="sim-stat"><div class="sim-stat-label">ÊÄªËµÑ‰∫ß</div><div class="sim-stat-val">${(totalValue/10000).toFixed(2)}<span style="font-size:11px">‰∏á</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">Á¥ØËÆ°Êî∂Áõä</div><div class="sim-stat-val" style="color:${cumProfit>=0?'#ef4444':'#22c55e'}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}<span style="font-size:11px">ÂÖÉ</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">Áé∞Èáë</div><div class="sim-stat-val" style="font-size:14px">${(simPortfolio.cash/10000).toFixed(2)}<span style="font-size:10px">‰∏á</span></div></div>
    </div>
    <div class="sim-target">
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
        <span>ÊúàÁõÆÊ†á: +¬•${SIM_TARGET_MONTHLY.toLocaleString()} (${targetPct.toFixed(1)}%)</span>
        <span style="font-weight:600;color:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'rgba(255,255,255,0.5)'}">
          ${cumProfit>=SIM_TARGET_MONTHLY?'‚úÖ Â∑≤ËææÊàê':'ËøõÂ∫¶ '+progressPct.toFixed(0)+'%'}
        </span>
      </div>
      <div class="sim-progress"><div class="sim-progress-fill" style="width:${progressPct}%;background:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'linear-gradient(90deg,#f59e0b,#ef4444)'}"></div></div>
    </div>
  </div>`;

  // ÂØπÊØîÂç°Áâá
  html += `<div class="sim-compare">
    <div class="sim-compare-title">üìä ‰ªäÊó•ÂØπÊØî</div>
    <div class="sim-compare-row">
      <div class="sim-compare-item">
        <span class="sim-compare-label">ü§ñ Ê®°ÊãüÁõò</span>
        <span class="sim-compare-val" style="color:${todayReturn>=0?'var(--red)':'var(--green)'}">${todayReturn>=0?'+':''}${todayReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">üíº ÁúüÂÆûÊåÅ‰ªì</span>
        <span class="sim-compare-val" style="color:${realPnlPct>=0?'var(--red)':'var(--green)'}">${holdings.length>0?(realPnlPct>=0?'+':'')+realPnlPct.toFixed(2)+'%':'--'}</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">üìà Ê≤™Ê∑±300</span>
        <span class="sim-compare-val" style="color:${hs300.pct>=0?'var(--red)':'var(--green)'}">${hs300.pct>=0?'+':''}${fmt(hs300.pct)}%</span>
      </div>
    </div>
    <div class="sim-compare-row" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
      <div class="sim-compare-item">
        <span class="sim-compare-label">Á¥ØËÆ°Êî∂ÁõäÁéá</span>
        <span class="sim-compare-val" style="color:${cumReturn>=0?'var(--red)':'var(--green)'}; font-weight:800">${cumReturn>=0?'+':''}${cumReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">vs Ê≤™Ê∑±300</span>
        <span class="sim-compare-val" style="color:${beatMarket?'var(--red)':'var(--green)'}; font-weight:600">${beatMarket?'Ë∑ëËµ¢':'Ë∑ëËæì'} ${Math.abs(cumReturn-hs300CumPct).toFixed(2)}%</span>
      </div>
    </div>
  </div>`;

  // ÊåÅ‰ªìÊòéÁªÜ
  const syncLabel = simPortfolio.syncSource==='holdings' ? ' ¬∑ Êù•Ëá™ÊåÅ‰ªì' : '';
  html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px;display:flex;justify-content:space-between">
    <span>üìã Ê®°ÊãüÊåÅ‰ªì (${simPortfolio.positions.length}Âè™)</span>
    <span style="font-weight:400;color:var(--sub);font-size:10px">Âª∫‰ªì: ${simPortfolio.created}${syncLabel}</span>
  </div>`;

  // Êï∞ÊçÆË¥®ÈáèÁªüËÆ°
  {
    let lc=0,hc=0,fc=0;
    simPortfolio.positions.forEach(p=>{const fd=getFundData(p.code);if(fd?._live)lc++;else if(fd?._histFallback)hc++;else fc++;});
    const tp=simPortfolio.positions.length;
    const ls=snapshots.length>0?snapshots[snapshots.length-1]:null;
    html += `<div style="font-size:9px;color:var(--sub);text-align:center;margin:6px 0;padding:4px 8px;background:rgba(255,255,255,0.03);border-radius:6px">
      Êï∞ÊçÆÊ∫ê: üü¢ÂÆûÊó∂${lc} ${hc>0?'üü°ÂéÜÂè≤'+hc+' ':''}${fc>0?'üî¥ÂæÖÊ†°ÂáÜ'+fc+' ':''}¬∑ ÂÖ±${tp}Âè™ ${ls?.updatedAt?'¬∑ Êõ¥Êñ∞ '+ls.updatedAt:''}
    </div>`;
  }

  [...simPortfolio.positions]
    .sort((a,b) => a.group==='core'&&b.group!=='core' ? -1 : a.group!=='core'&&b.group==='core' ? 1 : 0)
    .forEach(pos => {
      const fd = getFundData(pos.code);
      const nav = getSimNav(pos.code) || pos.avgCost;
      const currentValue = pos.shares * nav;
      const pnl = currentValue - pos.investedAmount;
      const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
      const todayPct = fd?.gszzl || 0;
      const weight = currentValue / totalValue * 100;
      const g = pos.group === 'core' ? 'üõ°Ô∏è' : 'üöÄ';
      const dataBadge = fd?._live ? 'üü¢' : fd?._histFallback ? 'üü°' : 'üî¥';
      html += `<div class="sim-pos-card">
        <div class="sim-pos-top">
          <div class="sim-pos-info">
            <div class="sim-pos-name">${g} ${pos.name} <span style="font-size:8px">${dataBadge}</span></div>
            <div class="sim-pos-meta">${pos.code} ¬∑ ${pos.type} ¬∑ ${weight.toFixed(1)}%</div>
          </div>
          <div class="sim-pos-right">
            <div class="sim-pos-pct" style="color:${todayPct>=0?'var(--red)':'var(--green)'}">${todayPct>=0?'+':''}${todayPct.toFixed(2)}%</div>
            <div style="font-size:10px;color:${pnlPct>=0?'var(--red)':'var(--green)'}">Á¥ØËÆ°${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%</div>
          </div>
        </div>
        <div class="sim-pos-detail">
          <span>¬•${currentValue.toFixed(0)}</span>
          <span>ÊàêÊú¨¬•${pos.investedAmount}</span>
          <span style="color:${pnl>=0?'var(--red)':'var(--green)'}">Áõà‰∫è${pnl>=0?'+':''}¬•${pnl.toFixed(0)}</span>
        </div>
      </div>`;
    });

  // Á≠ñÁï•ÂèÇÊï∞
  html += `<div class="sim-strategy-card">
    <div style="font-size:11px;font-weight:600;margin-bottom:6px">‚öôÔ∏è ÂΩìÂâçÁ≠ñÁï•ÂèÇÊï∞ <span style="font-weight:400;color:var(--sub);font-size:9px">AIËá™Âä®Â≠¶‰π†Ë∞É‰ºò</span></div>
    <div class="sim-param-grid">
      <div class="sim-param"><span class="sp-label">Ê†∏ÂøÉ/Âç´Êòü</span><span class="sp-val">${(simPortfolio.strategy.coreRatio*100).toFixed(0)}/${(simPortfolio.strategy.satRatio*100).toFixed(0)}</span></div>
      <div class="sim-param"><span class="sp-label">Ê≠¢ÊçüÁ∫ø</span><span class="sp-val" style="color:var(--green)">${simPortfolio.strategy.stopLoss}%</span></div>
      <div class="sim-param"><span class="sp-label">Ê≠¢ÁõàÁ∫ø</span><span class="sp-val" style="color:var(--red)">+${simPortfolio.strategy.takeProfit}%</span></div>
      <div class="sim-param"><span class="sp-label">‰ΩéÂê∏ÈòàÂÄº</span><span class="sp-val">${simPortfolio.strategy.dipBuyThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">ÂÜ≤È´òÂáè‰ªì</span><span class="sp-val">+${simPortfolio.strategy.surgeSellThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">ÂçïÂè™‰∏äÈôê</span><span class="sp-val">${(simPortfolio.strategy.maxSinglePos*100).toFixed(0)}%</span></div>
    </div>
  </div>`;

  // Â≠¶‰π†Êó•Âøó
  if(simPortfolio.learningLog && simPortfolio.learningLog.length > 0){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">üß† Á≠ñÁï•Â≠¶‰π†Êó•Âøó</div>`;
    simPortfolio.learningLog.slice(-5).reverse().forEach(log => {
      html += `<div class="sim-learn-card">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--sub)">
          <span>${log.date}</span><span>Á¥ØËÆ°${log.cumReturn>=0?'+':''}${log.cumReturn}%</span>
        </div>
        ${log.lesson ? `<div style="font-size:11px;margin-top:4px;line-height:1.5">üìå ${log.lesson}</div>` : ''}
        ${log.strategyChange ? `<div style="font-size:10px;color:var(--primary);margin-top:2px">‚öôÔ∏è ${log.strategyChange}</div>` : ''}
      </div>`;
    });
  }

  // ‰∫§ÊòìËÆ∞ÂΩï
  const recentTrades = (simPortfolio.history || []).slice(-8).reverse();
  if(recentTrades.length > 0){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">üìú ÊúÄËøë‰∫§Êòì <span style="font-weight:400;color:var(--sub)">(ÂÖ±${simPortfolio.history.length}Á¨î)</span></div>`;
    recentTrades.forEach(t => {
      const actionColor = t.action==='buy'?'var(--red)':'var(--green)';
      const actionIcon = t.action==='buy'?'üü¢‰π∞':'üî¥Âçñ';
      html += `<div class="sim-trade-item">
        <span style="color:${actionColor};font-weight:600;min-width:36px">${actionIcon}</span>
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.name||t.code}</span>
        <span style="min-width:56px;text-align:right;font-weight:600">¬•${t.amount.toLocaleString()}</span>
        <span style="min-width:70px;text-align:right;color:var(--sub)">${t.date}</span>
      </div>`;
    });
  }

  // Êî∂ÁõäËµ∞Âäø
  if(snapshots.length >= 2){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">üìà Êî∂ÁõäËµ∞Âäø (${snapshots.length}Â§©)</div><div class="sim-chart">`;
    const displaySnaps = snapshots.slice(-15);
    const maxRet = Math.max(...displaySnaps.map(s => Math.abs(s.cumReturn)), 0.1);
    displaySnaps.forEach(s => {
      const w = Math.abs(s.cumReturn) / maxRet * 100;
      const color = s.cumReturn >= 0 ? 'var(--red)' : 'var(--green)';
      html += `<div class="sim-chart-row">
        <span class="sim-chart-date">${s.date.slice(5)}</span>
        <div class="sim-chart-bar"><div style="width:${Math.max(w,2)}%;height:100%;background:${color};border-radius:3px"></div></div>
        <span class="sim-chart-val" style="color:${color}">${s.cumReturn>=0?'+':''}${s.cumReturn.toFixed(2)}%</span>
      </div>`;
    });
    html += `</div>`;
  }

  // ‰∫§ÊòìÊó•/‰ºëÂ∏ÇÁä∂ÊÄÅ
  const msSim = getMarketStatus();
  const tradingTag = isTradingDay() ? (msSim.status==='open'?'üü¢ ‰∫§Êòì‰∏≠':'‚è∏ '+msSim.text) : 'üî¥ ‰ªäÊó•‰ºëÂ∏Ç';
  html += `<div style="text-align:center;margin:10px 0 4px;font-size:10px;color:var(--sub)">${tradingTag}${msSim.isHoliday?' (ËäÇÂÅáÊó•)':''}</div>`;

  html += `<div style="text-align:center;margin-top:8px;display:flex;gap:10px;justify-content:center">
    <span style="font-size:10px;color:var(--primary);cursor:pointer;text-decoration:underline" onclick="syncSimFromHoldings()">üîÑ ÂêåÊ≠•ÊåÅ‰ªìÈáçÂª∫</span>
    <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="resetSimPortfolio()">‚Ü© ÈáçÁΩÆÊ®°ÊãüÁõò</span>
  </div>`;

  container.innerHTML = html;
  renderSimBrief();
}

function resetSimPortfolio(){
  if(holdings.length === 0){ alert('ËØ∑ÂÖàÊ∑ªÂä†ÊåÅ‰ªìÂü∫ÈáëÔºåÊ®°ÊãüÁõòÂ∞ÜÂü∫‰∫éÊÇ®ÁöÑÊåÅ‰ªìÂª∫‰ªì'); return; }
  if(!confirm(`Á°ÆËÆ§ÈáçÁΩÆÊ®°ÊãüÁõòÔºü\n\nÂ∞Ü‰ª•50‰∏áËµÑÈáëÔºåÊåâÊÇ®ÂΩìÂâç${holdings.length}Âè™ÊåÅ‰ªìÁ≠âÊùÉÂª∫‰ªì„ÄÇ`)) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  buildSimFromHoldings();
  updateSimDaily();
  renderSimPortfolio();
  renderSimBrief();
}

function syncSimFromHoldings(){
  if(holdings.length === 0){ alert('ËØ∑ÂÖàÊ∑ªÂä†ÊåÅ‰ªìÂü∫Èáë'); return; }
  if(!confirm(`ÂêåÊ≠•ÊåÅ‰ªìÂà∞Ê®°ÊãüÁõòÔºü\n\nÂ∞ÜÈáçÁΩÆÊ®°ÊãüÁõòÔºå‰ª•50‰∏áËµÑÈáëÊåâÊÇ®ÂΩìÂâç${holdings.length}Âè™ÊåÅ‰ªìÈáçÊñ∞Âª∫‰ªì„ÄÇ\n‚ö†Ô∏è ÊâÄÊúâÊ®°Êãü‰∫§ÊòìËÆ∞ÂΩïÂ∞ÜË¢´Ê∏ÖÈô§„ÄÇ`)) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  buildSimFromHoldings();
  updateSimDaily();
  renderSimPortfolio();
  renderSimBrief();
}

// ==================== INITIALIZATION ====================
async function loadData(){
  await Promise.all([fetchIndices(), fetchSectors(), fetchAllFunds()]);
  renderAll();
  // ÂºÇÊ≠•Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆÂíåÊï∞ÊçÆÊÉÖÊä•Ôºà‰∏çÈòªÂ°û‰∏ªÊ∏≤ÊüìÔºâ
  fetchAllHistory().then(()=>{
    console.log('ÂéÜÂè≤Ë∂ãÂäøÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', Object.keys(fundHistoryData).length, 'Âè™Âü∫Èáë');
    // ÂéÜÂè≤Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåÂàùÂßãÂåñRLÂ§ßËÑë
    initRLBrain();
    // Ëá™Âä®ËøêË°åÂõûÊµãÔºàÂ¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÁªìÊûúÔºâ
    if(!btSummary && Object.keys(fundHistoryData).length > 0){
      console.log('Ëá™Âä®ÂêØÂä®ÂõûÊµã...');
      setTimeout(()=>runBacktest(), 500);
    }
  }).catch(e=>console.warn('ÂéÜÂè≤Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', e));
  // Êï∞ÊçÆÊÉÖÊä•‰∏≠ÂøÉÔºöÂÆèËßÇ+ËµÑÈáë+ËàÜÊÉÖ
  fetchAllDataIntel().then(()=>{
    console.log('Êï∞ÊçÆÊÉÖÊä•Âä†ËΩΩÂÆåÊàê: ÂÆèËßÇ/ËµÑÈáë/ËàÜÊÉÖ');
    renderDataIntelBrief();
  }).catch(e=>console.warn('Êï∞ÊçÆÊÉÖÊä•Âä†ËΩΩÂ§±Ë¥•:', e));
}

function startTimers(){
  _countdownTimer = setInterval(()=>{ renderCountdown(); }, 1000);

  _refreshTimer = setInterval(async ()=>{
    const ms = getMarketStatus();
    if(ms.status==='open' || ms.status==='break'){
      await Promise.all([fetchIndices(), fetchAllFunds()]);
      renderIndices();
      renderStats();
      if(_analysisResult) renderSignals();
      // Âà∑Êñ∞Ê®°ÊãüÁõòÊï∞ÊçÆÔºàÁî®ÊúÄÊñ∞Â∏ÇÂú∫Êï∞ÊçÆÊõ¥Êñ∞Ôºâ
      updateSimDaily();
      renderSimBrief();
      if(document.getElementById('sim-container')?.style.display !== 'none'){
        renderSimPortfolio();
      }
      // Âà∑Êñ∞Êï∞ÊçÆÊÉÖÊä•ÔºàËµÑÈáëÊµÅÂíåÊñ∞ÈóªÊØè30sÊõ¥Êñ∞Ôºâ
      fetchSectorCapFlow().catch(()=>{});
      fetchNewsHeadlines().then(()=>{
        renderDataIntelBrief();
        if(document.getElementById('data-intel-container')?.style.display !== 'none'){
          renderDataIntel();
        }
      }).catch(()=>{});
    }
  }, 30000);
}

(async function init(){
  renderCountdown();
  renderAll();
  startTimers();
  await loadData();

  // ÂàùÂßãÂåñÊ®°ÊãüÁõò
  initSimPortfolio();
  updateSimDaily();
  renderSimBrief();

  generateDailyReview();
  renderReview();

  // ÂàùÂßãÂåñRLËÆ≠ÁªÉÂô®ÔºàÂ∞ùËØïÂä†ËΩΩÂ∑≤‰øùÂ≠òÊ®°ÂûãÔºâ
  rlTrainer = new RLTrainer();
  if(rlTrainer.loadModel()){
    renderRLBrief();
  }

  // Âä†ËΩΩÂõûÊµãÁºìÂ≠ò
  loadBTResults();

  // Auto-trigger AI if we have holdings/watchlist and API key
  if(_aiKey && (holdings.length>0 || watchlist.length>0)){
    triggerAI();
  }
})();

// RL Brain initialization (called after history data loads)
function initRLBrain(){
  if(!rlTrainer)rlTrainer=new RLTrainer();
  if(_rlModelLoaded && rlTrainer.agent){
    rlTrainer.generateSignals();
    renderRLBrief();
    if(document.getElementById('rl-brain-container')?.style.display!=='none')renderRLBrain();
    console.log('RL‰ø°Âè∑Â∑≤Êõ¥Êñ∞:', Object.keys(_rlSignals).length, 'Âè™Âü∫Èáë');
  }
}

// ==================== BACKTEST ENGINE ====================
// Á∫ØJSÂÆûÁé∞: RSIÁ≠ñÁï•ËøáÊª§ + Kelly‰ªì‰ΩçÁÆ°ÁêÜ + ÂÆåÊï¥ÂõûÊµãÊåáÊ†á
// Á≠ñÁï•: È¢ÑÊµãÊ∂®ÂπÖ>1% + RSI<70 ‚Üí ‰π∞ÂÖ•; RSI>75 ‚Üí ÂçñÂá∫
// ‰ªì‰Ωç: Kelly f* = (bp-q)/b

function btCalcRSI(prices, period){
  const rsi = new Array(prices.length).fill(50);
  if(prices.length < period + 1) return rsi;
  let avgGain = 0, avgLoss = 0;
  for(let i = 1; i <= period; i++){
    const d = prices[i] - prices[i-1];
    if(d > 0) avgGain += d; else avgLoss += Math.abs(d);
  }
  avgGain /= period; avgLoss /= period;
  rsi[period] = avgLoss === 0 ? 100 : 100 - 100/(1 + avgGain/avgLoss);
  for(let i = period + 1; i < prices.length; i++){
    const d = prices[i] - prices[i-1];
    avgGain = (avgGain * (period-1) + (d > 0 ? d : 0)) / period;
    avgLoss = (avgLoss * (period-1) + (d < 0 ? Math.abs(d) : 0)) / period;
    rsi[i] = avgLoss === 0 ? 100 : 100 - 100/(1 + avgGain/avgLoss);
  }
  return rsi;
}

function btCalcMA(prices, period){
  const ma = [];
  for(let i = 0; i < prices.length; i++){
    if(i < period - 1){ ma.push(prices[i]); continue; }
    let s = 0; for(let j = i - period + 1; j <= i; j++) s += prices[j];
    ma.push(s / period);
  }
  return ma;
}

function btCalcMACD(prices){
  // EMA12, EMA26, MACD signal
  const ema = (arr, k) => {
    const mult = 2/(k+1); const r = [arr[0]];
    for(let i=1;i<arr.length;i++) r.push(arr[i]*mult+r[i-1]*(1-mult));
    return r;
  };
  const e12 = ema(prices, 12), e26 = ema(prices, 26);
  const dif = e12.map((v,i) => v - e26[i]);
  const dea = ema(dif, 9);
  return { dif, dea, hist: dif.map((v,i) => 2*(v-dea[i])) };
}

function btCalcVolatility(prices, period){
  const vol = [];
  for(let i = 0; i < prices.length; i++){
    if(i < period){ vol.push(0); continue; }
    const rets = [];
    for(let j = i-period+1; j <= i; j++) rets.push((prices[j]-prices[j-1])/prices[j-1]);
    const mu = rets.reduce((s,v)=>s+v,0)/rets.length;
    const variance = rets.reduce((s,v)=>s+(v-mu)**2,0)/rets.length;
    vol.push(Math.sqrt(variance));
  }
  return vol;
}

// ÂáØÂà©ÂÖ¨Âºè: f* = (b*p - q) / b
function kellyFraction(winRate, avgWin, avgLoss){
  if(avgLoss === 0 || winRate <= 0) return 0;
  const b = Math.abs(avgWin / avgLoss); // ËµîÁéá = Âπ≥ÂùáÁõàÂà©/Âπ≥Âùá‰∫èÊçü
  const p = winRate;
  const q = 1 - p;
  let f = (b * p - q) / b;
  f = Math.max(0, Math.min(0.25, f)); // ÈôêÂà∂ÊúÄÂ§ß‰ªì‰Ωç25% (ÂçäKelly)
  return f;
}

// ÂçïÂè™Âü∫ÈáëÂõûÊµã
function backtestFund(navArray, code){
  if(!navArray || navArray.length < 60) return null;
  const prices = navArray.map(n => typeof n.nav === 'number' ? n.nav : parseFloat(n.nav || n[1]));
  const dates = navArray.map(n => n.date || n[0]);
  const n = prices.length;

  // ÊäÄÊúØÊåáÊ†á
  const rsi = btCalcRSI(prices, BT_RSI_PERIOD);
  const ma5 = btCalcMA(prices, 5);
  const ma20 = btCalcMA(prices, 20);
  const macd = btCalcMACD(prices);
  const vol20 = btCalcVolatility(prices, 20);

  // ÂõûÊµãÁä∂ÊÄÅ
  let cash = 100000;
  const initialCash = cash;
  let shares = 0;
  let entryPrice = 0;
  let position = 0; // 0~1 ‰ªì‰ΩçÊØî‰æã
  const trades = [];
  const equity = []; // ÂáÄÂÄºÊõ≤Á∫ø
  const drawdown = []; // ÂõûÊí§Êõ≤Á∫ø
  let peak = initialCash;
  let wins = 0, losses = 0;
  let totalWinAmt = 0, totalLossAmt = 0;
  let _currentKelly = 0;

  // ÊªöÂä®ÁªüËÆ°(Áî®‰∫éKelly)
  const recentTrades = []; // ÊúÄËøëNÊ¨°‰∫§ÊòìÁöÑÁõà‰∫èÁéá

  const startIdx = Math.max(26, BT_RSI_PERIOD + 1); // Á°Æ‰øùÊåáÊ†áÂ∑≤ËÆ°ÁÆó

  for(let i = startIdx; i < n; i++){
    const price = prices[i];
    const totalValue = cash + shares * price;
    equity.push({ date: dates[i], value: totalValue / initialCash });
    peak = Math.max(peak, totalValue);
    drawdown.push({ date: dates[i], dd: (totalValue - peak) / peak });

    // È¢ÑÊµãÊòéÊó•Ê∂®ÂπÖ(ÁÆÄÂåñ: Áî®Âä®Èáè+MACD+MAË∂ãÂäø‰º∞ÁÆó)
    const ret5d = i >= 5 ? (prices[i] - prices[i-5])/prices[i-5] : 0;
    const macdHist = macd.hist[i];
    const maTrend = (ma5[i] - ma20[i]) / ma20[i];
    const predictedReturn = ret5d * 0.3 + macdHist / price * 50 + maTrend * 2;

    // ËÆ°ÁÆóÊªöÂä®Kelly
    if(recentTrades.length >= 5){
      const wt = recentTrades.filter(r => r > 0);
      const lt = recentTrades.filter(r => r <= 0);
      const wr = wt.length / recentTrades.length;
      const aw = wt.length > 0 ? wt.reduce((s,v)=>s+v,0)/wt.length : 0.01;
      const al = lt.length > 0 ? Math.abs(lt.reduce((s,v)=>s+v,0)/lt.length) : 0.01;
      _currentKelly = kellyFraction(wr, aw, al);
    } else {
      _currentKelly = 0.05; // ÈªòËÆ§5%‰ªì‰Ωç
    }

    // === RLËûçÂêàÂõûÊµãÁ≠ñÁï•‰ø°Âè∑ ===
    // Âú®ÂõûÊµã‰∏≠ÂºïÂÖ•RL‰ø°Âè∑‰Ωú‰∏∫ËæÖÂä©Á°ÆËÆ§Êù°‰ª∂
    let rlBuyBoost = 0, rlSellBoost = 0;
    if(_rlModelLoaded && rlTrainer?.agent && typeof _rlSignals !== 'undefined'){
      const rlSig = _rlSignals[code];
      if(rlSig){
        if(rlSig.action === 1 && rlSig.confidence > 40) rlBuyBoost = 0.3; // RLÁúãÂ§öÂä†Âº∫‰π∞ÂÖ•
        if(rlSig.action === 2 && rlSig.confidence > 40) rlSellBoost = 0.3; // RLÁúãÁ©∫Âä†Âº∫ÂçñÂá∫
        if(rlSig.action === 2 && rlSig.confidence > 60) rlBuyBoost = -0.5; // RLÂº∫ÁÉàÁúãÁ©∫ÊäëÂà∂‰π∞ÂÖ•
        if(rlSig.action === 1 && rlSig.confidence > 60) rlSellBoost = -0.5; // RLÂº∫ÁÉàÁúãÂ§öÊäëÂà∂ÂçñÂá∫
      }
    }

    // ‰π∞ÂÖ•: È¢ÑÊµãÊ∂®ÂπÖ>1% + RSI<70 + MA5>MA20(Ë∂ãÂäøÂêë‰∏ä) + RL‰ø°Âè∑ËûçÂêà
    const adjMomentumBuy = BT_MOMENTUM_BUY * (1 - rlBuyBoost); // RLÁúãÂ§öÊó∂Èôç‰ΩéÈó®Êßõ
    if(predictedReturn > adjMomentumBuy && rsi[i] < BT_RSI_BUY && ma5[i] > ma20[i] && position < 0.9){
      const kellyAdj = _currentKelly * (1 + rlBuyBoost); // RLÁúãÂ§öÊó∂ÊîæÂ§ßKelly
      const targetPos = Math.min(position + kellyAdj, 0.95);
      const addPos = targetPos - position;
      if(addPos > 0.02){
        const buyAmt = Math.round(totalValue * addPos);
        const fee = Math.round(buyAmt * BT_FEE);
        const buyShares = (buyAmt - fee) / price;
        if(cash >= buyAmt){
          cash -= buyAmt;
          shares += buyShares;
          if(position === 0) entryPrice = price;
          else entryPrice = (entryPrice * position + price * addPos) / (position + addPos);
          position = targetPos;
          trades.push({
            date: dates[i], action: 'buy', price, shares: buyShares, amount: buyAmt,
            rsi: rsi[i], kelly: kellyAdj, predicted: predictedReturn, rlBoost: rlBuyBoost, fee
          });
        }
      }
    }

    // ÂçñÂá∫: RSI>75 Êàñ Ë∂ãÂäøÂèçËΩ¨(MA5<MA20‰∏îÊåÅ‰ªì) Êàñ Ê≠¢Êçü(-5%) + RLËûçÂêà
    const pnlPct = position > 0 ? (price - entryPrice) / entryPrice : 0;
    const adjRsiSell = BT_RSI_SELL - Math.round(rlSellBoost * 10); // RLÁúãÁ©∫Êó∂Èôç‰ΩéÂçñÂá∫RSIÈó®Êßõ
    const shouldSell = (rsi[i] > adjRsiSell && position > 0.2)
      || (ma5[i] < ma20[i] && position > 0.3 && macdHist < 0)
      || (pnlPct < -0.05 && position > 0); // Ê≠¢Êçü

    if(shouldSell && position > 0){
      let sellRatio = 0.5 * (1 + rlSellBoost); // RLÁúãÁ©∫Êó∂ÊîæÂ§ßÂçñÂá∫ÊØî‰æã
      if(rsi[i] > 80) sellRatio = 0.8;
      if(pnlPct < -0.05) sellRatio = 1.0; // Ê≠¢ÊçüÂÖ®Âçñ
      if(ma5[i] < ma20[i] && macdHist < -0.001) sellRatio = Math.max(sellRatio, 0.7);
      sellRatio = Math.min(sellRatio, 1.0);

      const sellShares = Math.floor(shares * sellRatio * 100) / 100;
      const sellAmt = Math.round(sellShares * price);
      const fee = Math.round(sellAmt * BT_FEE);
      cash += sellAmt - fee;
      shares -= sellShares;
      position = shares * price / (cash + shares * price);

      const tradeReturn = (price - entryPrice) / entryPrice;
      recentTrades.push(tradeReturn);
      if(recentTrades.length > 20) recentTrades.shift();
      if(tradeReturn > 0){ wins++; totalWinAmt += tradeReturn; }
      else{ losses++; totalLossAmt += Math.abs(tradeReturn); }

      trades.push({
        date: dates[i], action: 'sell', price, shares: sellShares, amount: sellAmt,
        rsi: rsi[i], pnl: (tradeReturn*100).toFixed(2)+'%', reason:
          pnlPct<-0.05?'Ê≠¢Êçü':rsi[i]>80?'RSIË∂Ö‰π∞':ma5[i]<ma20[i]?'Ë∂ãÂäøÂèçËΩ¨':'Ëé∑Âà©‰∫ÜÁªì', fee
      });

      if(shares < 0.01){ shares = 0; position = 0; entryPrice = 0; }
    }
  }

  // ÊúÄÁªàËØÑ‰º∞
  const finalValue = cash + shares * prices[n-1];
  const totalReturn = (finalValue - initialCash) / initialCash;
  const tradingDays = equity.length;
  const annualFactor = 250;

  // Âπ¥ÂåñÊî∂Áõä
  const years = tradingDays / annualFactor;
  const annualReturn = years > 0 ? Math.pow(1 + totalReturn, 1/years) - 1 : totalReturn;

  // Êó•Êî∂ÁõäÁéáÂ∫èÂàó
  const dailyReturns = [];
  for(let i = 1; i < equity.length; i++){
    dailyReturns.push(equity[i].value / equity[i-1].value - 1);
  }
  const avgDaily = dailyReturns.length > 0 ? dailyReturns.reduce((s,v)=>s+v,0)/dailyReturns.length : 0;
  const stdDaily = dailyReturns.length > 1 ? Math.sqrt(dailyReturns.reduce((s,v)=>s+(v-avgDaily)**2,0)/(dailyReturns.length-1)) : 1;

  // Sharpe Ratio (Âπ¥Âåñ)
  const dailyRF = BT_RISK_FREE / annualFactor;
  const sharpe = stdDaily > 0 ? (avgDaily - dailyRF) / stdDaily * Math.sqrt(annualFactor) : 0;

  // Max Drawdown
  const maxDD = drawdown.length > 0 ? Math.min(...drawdown.map(d=>d.dd)) : 0;

  // Calmar Ratio
  const calmar = maxDD !== 0 ? annualReturn / Math.abs(maxDD) : 0;

  // Sortino Ratio (‰∏ãË°åÊ†áÂáÜÂ∑Æ)
  const downReturns = dailyReturns.filter(r => r < 0);
  const downDev = downReturns.length > 0 ? Math.sqrt(downReturns.reduce((s,v)=>s+v*v,0)/downReturns.length) : stdDaily;
  const sortino = downDev > 0 ? (avgDaily - dailyRF) / downDev * Math.sqrt(annualFactor) : 0;

  // Win Rate & Kelly (Êï¥‰Ωì)
  const totalTrades = wins + losses;
  const winRate = totalTrades > 0 ? wins / totalTrades : 0;
  const avgWin = wins > 0 ? totalWinAmt / wins : 0;
  const avgLoss = losses > 0 ? totalLossAmt / losses : 0.01;
  const finalKelly = kellyFraction(winRate, avgWin, avgLoss);

  // Buy & HoldÂØπÊØî
  const bhReturn = (prices[n-1] - prices[startIdx]) / prices[startIdx];

  return {
    code, totalReturn, annualReturn, sharpe, sortino, calmar,
    maxDD, winRate, wins, losses, totalTrades,
    avgWin, avgLoss, finalKelly,
    bhReturn, // Buy & Hold
    equity, drawdown, trades,
    tradingDays, years,
    finalValue, initialCash,
    lastRSI: rsi[n-1],
    currentKelly: _currentKelly
  };
}

// ÂÖ®ÈÉ®Âü∫ÈáëÂõûÊµã
async function runBacktest(){
  if(_btRunning) return;
  _btRunning = true;
  btResults = {};

  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  if(codes.length === 0){
    alert('ËØ∑ÂÖàÊ∑ªÂä†ÊåÅ‰ªìÊàñËá™ÈÄâÂü∫Èáë');
    _btRunning = false;
    return;
  }

  renderBTBrief();
  renderBacktest();

  let completed = 0;
  const allEquity = [];

  for(const code of codes){
    const hd = fundHistoryData[code];
    if(!hd || !hd.navs || hd.navs.length < 60) continue;

    const navArr = hd.navs.map(n => typeof n === 'object' && n.nav !== undefined ?
      n : { date: n[0], nav: parseFloat(n[1]) }
    ).filter(n => !isNaN(n.nav) && n.nav > 0);

    const result = backtestFund(navArr, code);
    if(result){
      btResults[code] = result;
      allEquity.push(result);
      completed++;
    }

    // ‰∏çÈòªÂ°ûUI
    if(completed % 2 === 0) await new Promise(r => setTimeout(r, 0));
  }

  // ÁªÑÂêàÂõûÊµãÊ±áÊÄª
  if(Object.keys(btResults).length > 0){
    const results = Object.values(btResults);
    const avgReturn = results.reduce((s,r)=>s+r.totalReturn,0)/results.length;
    const avgSharpe = results.reduce((s,r)=>s+r.sharpe,0)/results.length;
    const worstDD = Math.min(...results.map(r=>r.maxDD));
    const avgWinRate = results.reduce((s,r)=>s+r.winRate,0)/results.length;
    const avgKelly = results.reduce((s,r)=>s+r.finalKelly,0)/results.length;
    const avgBH = results.reduce((s,r)=>s+r.bhReturn,0)/results.length;
    const totalTrades = results.reduce((s,r)=>s+r.totalTrades,0);
    const bestFund = results.reduce((a,b)=>a.sharpe>b.sharpe?a:b);
    const worstFund = results.reduce((a,b)=>a.sharpe<b.sharpe?a:b);

    btSummary = {
      avgReturn, avgSharpe, worstDD, avgWinRate, avgKelly, avgBH,
      totalTrades, fundCount: results.length,
      bestFund: bestFund.code, worstFund: worstFund.code,
      excessReturn: avgReturn - avgBH, // Ë∂ÖÈ¢ùÊî∂Áõä
      timestamp: Date.now()
    };

    // ‰øùÂ≠òÂà∞localStorage
    try{
      localStorage.setItem(BT_STORAGE_KEY, JSON.stringify({
        results: Object.fromEntries(Object.entries(btResults).map(([k,v])=>
          [k, { code:v.code, totalReturn:v.totalReturn, annualReturn:v.annualReturn, sharpe:v.sharpe, sortino:v.sortino, calmar:v.calmar, maxDD:v.maxDD, winRate:v.winRate, wins:v.wins, losses:v.losses, totalTrades:v.totalTrades, avgWin:v.avgWin, avgLoss:v.avgLoss, finalKelly:v.finalKelly, bhReturn:v.bhReturn, lastRSI:v.lastRSI, currentKelly:v.currentKelly, tradingDays:v.tradingDays }]
        )),
        summary: btSummary
      }));
    }catch(e){ console.warn('ÂõûÊµãÁªìÊûú‰øùÂ≠òÂ§±Ë¥•:', e); }
  }

  _btRunning = false;
  renderBTBrief();
  renderBacktest();
  console.log('ÂõûÊµãÂÆåÊàê:', Object.keys(btResults).length, 'Âè™Âü∫Èáë', btSummary);
}

// ==================== BACKTEST RENDERING ====================

function toggleBacktest(){
  const c = document.getElementById('bt-container');
  const icon = document.getElementById('bt-toggle');
  if(c.style.display === 'none'){
    c.style.display = 'block'; icon.textContent = '‚ñº';
    renderBacktest();
  } else {
    c.style.display = 'none'; icon.textContent = '‚ñ∂';
  }
}

function renderBTBrief(){
  const el = document.getElementById('bt-brief');
  if(!el) return;
  if(_btRunning){
    el.style.color = '#eab308';
    el.textContent = `ÂõûÊµã‰∏≠...${Object.keys(btResults).length}Âè™`;
    return;
  }
  if(!btSummary){
    el.style.color = 'var(--sub)'; el.textContent = 'Êú™ÂõûÊµã'; return;
  }
  const ret = (btSummary.avgReturn*100).toFixed(1);
  const sh = btSummary.avgSharpe.toFixed(2);
  el.style.color = btSummary.avgReturn >= 0 ? 'var(--red)' : 'var(--green)';
  el.textContent = `Êî∂Áõä${ret}% ¬∑ Sharpe ${sh}`;
}

function renderBacktest(){
  const container = document.getElementById('bt-container');
  if(!container || container.style.display === 'none') return;

  const hasResults = btSummary && Object.keys(btResults).length > 0;
  let html = '';

  // Run Button + Status
  html += `<div class="bt-card"><div class="bt-card-title">üìä Á≠ñÁï•ÂõûÊµãÂºïÊìé</div>`;
  html += `<div style="font-size:10px;color:var(--sub);margin-bottom:6px">`;
  html += `Á≠ñÁï•: È¢ÑÊµãÊ∂®ÂπÖ>1% + RSI<${BT_RSI_BUY} ‚Üí ‰π∞ÂÖ• | RSI>${BT_RSI_SELL}ÊàñË∂ãÂäøÂèçËΩ¨ ‚Üí ÂçñÂá∫<br>`;
  html += `‰ªì‰Ωç: Kelly f*=(bp-q)/b ¬∑ ÂçïÊ¨°ÊúÄÂ§ß25%(ÂçäKelly) ¬∑ ÊÄª‰ªì‰Ωç‚â§95%`;
  html += `</div>`;
  if(_btRunning){
    html += `<button class="bt-run-btn" disabled>‚è≥ ÂõûÊµã‰∏≠... (${Object.keys(btResults).length}Âè™)</button>`;
  } else {
    const dc = Object.keys(fundHistoryData).length;
    html += `<button class="bt-run-btn" onclick="runBacktest()" ${dc<1?'disabled title="ÈúÄË¶ÅÂÖàÂä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ"':''}>`;
    html += hasResults ? 'üîÑ ÈáçÊñ∞ÂõûÊµã (RSI+Kelly)' : 'üöÄ ÂºÄÂßãÂõûÊµã (RSI+Kelly)';
    html += `</button>`;
  }
  html += `</div>`;

  if(!hasResults){
    container.innerHTML = html;
    return;
  }

  const s = btSummary;
  const results = Object.values(btResults);

  // Summary Metrics
  html += `<div class="bt-card"><div class="bt-card-title">üìà ÁªÑÂêàÂõûÊµãÊ¶ÇËßà <span style="font-size:9px;color:var(--sub);font-weight:400">${s.fundCount}Âè™Âü∫Èáë</span></div>`;
  html += `<div class="bt-metrics">`;
  html += btMetricHTML('Âπ≥ÂùáÊî∂Áõä', (s.avgReturn*100).toFixed(1)+'%', s.avgReturn>=0?'var(--red)':'var(--green)');
  html += btMetricHTML('Sharpe', s.avgSharpe.toFixed(2), s.avgSharpe>=1?'var(--red)':s.avgSharpe>=0?'#f59e0b':'var(--green)');
  html += btMetricHTML('ÊúÄÂ§ßÂõûÊí§', (s.worstDD*100).toFixed(1)+'%', 'var(--green)');
  html += btMetricHTML('ËÉúÁéá', (s.avgWinRate*100).toFixed(0)+'%', s.avgWinRate>=0.5?'var(--red)':'var(--sub)');
  html += btMetricHTML('Kelly‰ªì‰Ωç', (s.avgKelly*100).toFixed(1)+'%', '#8b5cf6');
  html += btMetricHTML('Ë∂ÖÈ¢ùÊî∂Áõä', (s.excessReturn>0?'+':'')+(s.excessReturn*100).toFixed(1)+'%', s.excessReturn>=0?'var(--red)':'var(--green)');
  html += `</div>`;

  // Kelly‰ªì‰ΩçÂèØËßÜÂåñ
  const kellyPct = Math.round(s.avgKelly * 100);
  const cashPct = 100 - kellyPct;
  html += `<div style="font-size:9px;color:var(--sub);margin-top:8px">ÂáØÂà©Âª∫ËÆÆ‰ªì‰Ωç</div>`;
  html += `<div class="bt-kelly-bar">`;
  html += `<div class="bt-kelly-seg" style="width:${kellyPct}%;background:linear-gradient(90deg,#3b82f6,#8b5cf6)">${kellyPct}%‰ªì</div>`;
  html += `<div class="bt-kelly-seg" style="width:${cashPct}%;background:rgba(148,163,184,0.2);color:var(--sub)">${cashPct}%Áé∞Èáë</div>`;
  html += `</div>`;
  html += `</div>`;

  // Equity Chart (ÁªÑÂêàÂπ≥ÂùáÂáÄÂÄºÊõ≤Á∫ø)
  const bestResult = btResults[s.bestFund];
  if(bestResult && bestResult.equity.length > 2){
    html += `<div class="bt-card"><div class="bt-card-title">üìâ ÂáÄÂÄº & ÂõûÊí§Êõ≤Á∫ø <span style="font-size:9px;color:var(--sub);font-weight:400">${fundName(s.bestFund)}(ÊúÄ‰ºòSharpe)</span></div>`;
    html += renderBTChart(bestResult.equity, bestResult.bhReturn);
    html += `<div style="margin-top:4px">`;
    html += renderBTDDChart(bestResult.drawdown);
    html += `</div></div>`;
  }

  // Per-fund results
  html += `<div class="bt-card"><div class="bt-card-title">üìã ÂêÑÂü∫ÈáëÂõûÊµãËØ¶ÊÉÖ</div>`;
  html += `<div style="display:flex;gap:4px;padding:3px 0;border-bottom:1px solid var(--border);margin-bottom:4px">`;
  html += `<span style="font-size:9px;color:var(--sub);flex:1">Âü∫Èáë</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:50px;text-align:right">Êî∂ÁõäÁéá</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:40px;text-align:right">Sharpe</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:45px;text-align:right">ÊúÄÂ§ßÂõûÊí§</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:35px;text-align:right">Kelly</span>`;
  html += `</div>`;
  const sorted = results.sort((a,b) => b.sharpe - a.sharpe);
  sorted.forEach(r => {
    const retColor = r.totalReturn >= 0 ? 'var(--red)' : 'var(--green)';
    const shColor = r.sharpe >= 1 ? 'var(--red)' : r.sharpe >= 0 ? '#f59e0b' : 'var(--green)';
    html += `<div class="bt-fund-row">`;
    html += `<span class="bt-fund-name">${fundName(r.code)}</span>`;
    html += `<span class="bt-fund-ret" style="color:${retColor}">${(r.totalReturn*100).toFixed(1)}%</span>`;
    html += `<span class="bt-fund-sharpe" style="color:${shColor}">${r.sharpe.toFixed(2)}</span>`;
    html += `<span class="bt-fund-mdd" style="color:var(--green)">${(r.maxDD*100).toFixed(1)}%</span>`;
    html += `<span class="bt-fund-kelly" style="color:#8b5cf6">${(r.finalKelly*100).toFixed(0)}%</span>`;
    html += `</div>`;
  });
  html += `</div>`;

  // Trading history (ÊúÄËøë10Á¨î)
  const allTrades = [];
  results.forEach(r => {
    r.trades.slice(-5).forEach(t => allTrades.push({...t, code: r.code}));
  });
  allTrades.sort((a,b) => b.date.localeCompare(a.date));

  if(allTrades.length > 0){
    html += `<div class="bt-card"><div class="bt-card-title">üìù ÊúÄËøë‰∫§ÊòìËÆ∞ÂΩï <span style="font-size:9px;color:var(--sub);font-weight:400">${s.totalTrades}Á¨îÊÄª‰∫§Êòì</span></div>`;
    allTrades.slice(0, 10).forEach(t => {
      const ac = t.action === 'buy' ? 'üü¢‰π∞' : 'üî¥Âçñ';
      const extra = t.action === 'sell' ? ` ${t.pnl} ${t.reason||''}` : ` RSI:${t.rsi?.toFixed(0)} Kelly:${(t.kelly*100)?.toFixed(0)}%`;
      html += `<div class="bt-trade-row">`;
      html += `<span style="min-width:60px">${t.date?.slice(5)}</span>`;
      html += `<span style="min-width:24px">${ac}</span>`;
      html += `<span style="flex:1">${fundName(t.code)}</span>`;
      html += `<span style="color:var(--sub);text-align:right">${extra}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Architecture
  html += `<div class="bt-card"><div class="bt-card-title">‚öôÔ∏è ÂõûÊµãÂèÇÊï∞</div>`;
  html += `<div style="font-size:10px;color:var(--sub);line-height:1.6">`;
  html += `<b>Êï∞ÊçÆ:</b> Âü∫ÈáëÂéÜÂè≤NAV(Ëøë1Âπ¥~250‰∫§ÊòìÊó•)<br>`;
  html += `<b>‰π∞ÂÖ•Êù°‰ª∂:</b> È¢ÑÊµãÊ∂®ÂπÖ>1% + RSI(14)<${BT_RSI_BUY} + MA5>MA20<br>`;
  html += `<b>ÂçñÂá∫Êù°‰ª∂:</b> RSI>${BT_RSI_SELL} / Ë∂ãÂäøÂèçËΩ¨(MA5<MA20+MACD<0) / Ê≠¢Êçü(-5%)<br>`;
  html += `<b>‰ªì‰ΩçÁÆ°ÁêÜ:</b> Kelly f*=(b¬∑p-q)/b ¬∑ ÂçäKelly(max 25%) ¬∑ ÊªöÂä®20Ê¨°‰∫§ÊòìÁªüËÆ°<br>`;
  html += `<b>ÊâãÁª≠Ë¥π:</b> ${(BT_FEE*100).toFixed(2)}% ÂçïËæπ<br>`;
  html += `<b>È£éÊéß:</b> ÊÄª‰ªì‰Ωç‚â§95% ¬∑ Ê≠¢Êçü-5% ¬∑ RSIË∂Ö‰π∞Âáè‰ªì<br>`;
  html += `<b>ÊåáÊ†á:</b> Sharpe=(R-Rf)/œÉ¬∑‚àö250 ¬∑ Sortino(‰∏ãË°åÊ≥¢Âä®) ¬∑ Calmar(Âπ¥Âåñ/ÊúÄÂ§ßÂõûÊí§) ¬∑ Kelly<br>`;
  html += `<b>Èó≠ÁéØ:</b> <span style="color:#22d3ee">RL‰ø°Âè∑ËûçÂêà‰π∞Âçñ ¬∑ ‰∏âÂºïÊìéÊäïÁ•®ÂÖ±ËØÜ ¬∑ ÂõûÊµãÁâπÂæÅÊ≥®ÂÖ•RLÁä∂ÊÄÅ</span>`;
  html += `</div></div>`;

  container.innerHTML = html;
}

function btMetricHTML(label, val, color){
  return `<div class="bt-metric"><span class="bt-metric-label">${label}</span><span class="bt-metric-val" style="color:${color||'var(--text)'}">${val}</span></div>`;
}

function renderBTChart(equity, bhReturn){
  if(!equity || equity.length < 2) return '';
  const vals = equity.map(e => e.value);
  const max = Math.max(...vals), min = Math.min(...vals);
  const range = max - min || 0.01;
  const h = 70, w = 100;

  let strategyPts = '', bhPts = '';
  const step = Math.max(1, Math.floor(vals.length / 200));
  for(let i = 0; i < vals.length; i += step){
    const x = (i / (vals.length-1)) * w;
    const y = h - ((vals[i] - min) / range) * h;
    strategyPts += `${x.toFixed(1)},${y.toFixed(1)} `;
    // Buy & Hold line
    const bhVal = 1 + (vals[i] - 1) * 0; // ÁÆÄÂåñ: Á∫øÊÄß
    const bhV = 1 + (bhReturn * i / (vals.length-1));
    const bhY = h - ((bhV - min) / range) * h;
    bhPts += `${x.toFixed(1)},${bhY.toFixed(1)} `;
  }

  let s = `<div class="bt-chart"><svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  // BH line
  s += `<polyline points="${bhPts.trim()}" fill="none" stroke="rgba(148,163,184,0.4)" stroke-width="1" stroke-dasharray="2,2"/>`;
  // Strategy line
  s += `<defs><linearGradient id="btGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f59e0b" stop-opacity="0.25"/><stop offset="100%" stop-color="#f59e0b" stop-opacity="0.02"/></linearGradient></defs>`;
  s += `<polygon points="0,${h+2} ${strategyPts.trim()} ${w},${h+2}" fill="url(#btGrad)"/>`;
  s += `<polyline points="${strategyPts.trim()}" fill="none" stroke="#f59e0b" stroke-width="1.5"/>`;
  // 1.0 line
  const oneY = h - ((1 - min) / range) * h;
  if(oneY > 0 && oneY < h) s += `<line x1="0" y1="${oneY.toFixed(1)}" x2="${w}" y2="${oneY.toFixed(1)}" stroke="rgba(255,255,255,0.15)" stroke-dasharray="2,2"/>`;
  s += `</svg>`;
  s += `<div style="position:absolute;top:2px;left:4px;font-size:8px;color:#f59e0b">‚óèÁ≠ñÁï• ${(vals[vals.length-1]*100-100).toFixed(1)}%</div>`;
  s += `<div style="position:absolute;top:2px;right:4px;font-size:8px;color:var(--sub)">‚óèB&H ${(bhReturn*100).toFixed(1)}%</div>`;
  s += `</div>`;
  return s;
}

function renderBTDDChart(drawdown){
  if(!drawdown || drawdown.length < 2) return '';
  const vals = drawdown.map(d => d.dd);
  const minDD = Math.min(...vals);
  const range = Math.abs(minDD) || 0.01;
  const h = 40, w = 100;

  let pts = '';
  const step = Math.max(1, Math.floor(vals.length / 200));
  for(let i = 0; i < vals.length; i += step){
    const x = (i / (vals.length-1)) * w;
    const y = (Math.abs(vals[i]) / range) * h;
    pts += `${x.toFixed(1)},${y.toFixed(1)} `;
  }

  let s = `<div class="bt-dd-chart"><svg viewBox="0 0 ${w} ${h+2}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s += `<defs><linearGradient id="ddGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ef4444" stop-opacity="0.02"/><stop offset="100%" stop-color="#ef4444" stop-opacity="0.3"/></linearGradient></defs>`;
  s += `<polygon points="0,0 ${pts.trim()} ${w},0" fill="url(#ddGrad)"/>`;
  s += `<polyline points="${pts.trim()}" fill="none" stroke="#ef4444" stroke-width="1"/>`;
  s += `</svg>`;
  s += `<div style="position:absolute;bottom:2px;left:4px;font-size:8px;color:#ef4444">ÂõûÊí§ ${(minDD*100).toFixed(1)}%</div>`;
  s += `</div>`;
  return s;
}

// Build backtest context for AI prompt
function buildBTContext(){
  if(!btSummary || Object.keys(btResults).length === 0) return '';
  let ctx = '\n„Äêüìà Á≠ñÁï•ÂõûÊµãÁªìÊûú (RSI+Kelly+RLËûçÂêà)„Äë\n';
  ctx += `Á≠ñÁï•: È¢ÑÊµãÊ∂®ÂπÖ>1%‰∏îRSI<${BT_RSI_BUY}‰π∞ÂÖ• | RSI>${BT_RSI_SELL}ÊàñË∂ãÂäøÂèçËΩ¨ÂçñÂá∫ | Kelly‰ªì‰ΩçÁÆ°ÁêÜ | RL‰ø°Âè∑ËæÖÂä©\n`;
  ctx += `ÂÖ±ËØÜ: ‰∏âÂºïÊìé(AI+RL+ÂõûÊµã)Âä†ÊùÉÊäïÁ•® ¬∑ ÂÖ®Á•®‰∏ÄËá¥√ó1.4 ¬∑ Â§öÊï∞Á•®√ó1.15 ¬∑ ÂàÜÊ≠ß√ó0.4\n`;
  ctx += `ÁªÑÂêà: Âπ≥ÂùáÊî∂Áõä${(btSummary.avgReturn*100).toFixed(1)}% ¬∑ Sharpe ${btSummary.avgSharpe.toFixed(2)} ¬∑ ÊúÄÂ§ßÂõûÊí§${(btSummary.worstDD*100).toFixed(1)}% ¬∑ ËÉúÁéá${(btSummary.avgWinRate*100).toFixed(0)}%\n`;
  ctx += `Ë∂ÖÈ¢ùÊî∂Áõä(vs Buy&Hold): ${(btSummary.excessReturn*100).toFixed(1)}%\n`;
  ctx += `KellyÂª∫ËÆÆÂπ≥Âùá‰ªì‰Ωç: ${(btSummary.avgKelly*100).toFixed(1)}%\n`;
  ctx += 'ÂêÑÂü∫ÈáëÂõûÊµã:\n';
  Object.values(btResults).sort((a,b)=>b.sharpe-a.sharpe).forEach(r => {
    ctx += `  ${fundName(r.code)}(${r.code}): Êî∂Áõä${(r.totalReturn*100).toFixed(1)}% ¬∑ Sharpe ${r.sharpe.toFixed(2)} ¬∑ ÂõûÊí§${(r.maxDD*100).toFixed(1)}% ¬∑ ËÉúÁéá${(r.winRate*100).toFixed(0)}% ¬∑ Kelly‰ªì‰Ωç${(r.finalKelly*100).toFixed(0)}% ¬∑ ÂΩìÂâçRSI ${r.lastRSI?.toFixed(0)}\n`;
  });
  ctx += '‚ö†Ô∏è ÂõûÊµãÂ∑≤ËûçÂêàRL‰ø°Âè∑„ÄÇ‰∏âÂºïÊìéÊäïÁ•®ÂÖ±ËØÜÁ≥ªÁªü: AI/RL/ÂõûÊµãÂ§öÊï∞Á•®‚ÜíÂä†Â§ß‰ªì‰Ωç, ÂàÜÊ≠ß‚ÜíÁº©Âáè‰ªì‰Ωç„ÄÇÈ´òSharpeÂü∫ÈáëÂèØÂä†ÈÖçÔºåSharpe<0ÈúÄË∞®ÊÖé„ÄÇ\n';
  return ctx;
}

// Load saved backtest results
function loadBTResults(){
  try{
    const raw = localStorage.getItem(BT_STORAGE_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    if(d.summary) btSummary = d.summary;
    if(d.results){
      for(const[k,v]of Object.entries(d.results)){
        btResults[k] = v; // partial results (no equity/trades/drawdown arrays)
      }
    }
    renderBTBrief();
    console.log('ÂõûÊµãÁªìÊûúÂ∑≤Âä†ËΩΩ:', Object.keys(btResults).length, 'Âè™Âü∫Èáë');
  }catch(e){ console.warn('ÂõûÊµãÁªìÊûúÂä†ËΩΩÂ§±Ë¥•:', e); }
}
</script>
</body>
</html>
