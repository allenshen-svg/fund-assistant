<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>åŸºé‡‘å†³ç­–åŠ©æ‰‹</title>
<style>
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a2e; --sub: #8896a4;
  --border: #e8ecf1; --primary: #4F6EF7; --primary-bg: #eef2ff;
  --green: #22a065; --green-bg: #ecfdf5; --red: #e74040; --red-bg: #fef2f2;
  --yellow: #f59e0b; --yellow-bg: #fef3c7; --gray-bg: #f8fafc;
  --radius: 14px; --shadow: 0 1px 4px rgba(0,0,0,0.04);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro','PingFang SC','Helvetica Neue',sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; max-width:500px; margin:0 auto; min-height:100vh; padding-bottom:80px; }

/* Header â€” æ·±è‰²å¤§æ°”é£æ ¼ */
.header { background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; padding:16px 16px 14px; position:sticky; top:0; z-index:100; }
.header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.header-title { font-size:17px; font-weight:700; letter-spacing:0.5px; }
.header-gear { background:none; border:none; color:rgba(255,255,255,0.7); font-size:18px; cursor:pointer; padding:4px; transition:color .2s; }
.header-gear:hover { color:#fff; }
.market-status { display:flex; align-items:center; gap:8px; font-size:12px; opacity:0.9; }
.status-dot { width:7px; height:7px; border-radius:50%; display:inline-block; }
.status-dot.open { background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,0.6); animation:pulse 2s infinite; }
.status-dot.closed { background:#64748b; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.countdown { font-family:'SF Mono','Menlo',monospace; font-weight:600; font-size:13px; background:rgba(255,255,255,0.08); padding:3px 10px; border-radius:6px; letter-spacing:0.5px; }

/* Stats Bar */
.stats-bar { display:grid; grid-template-columns:1fr 1fr; gap:0; padding:0; background:var(--card); border-bottom:1px solid var(--border); box-shadow:var(--shadow); }
.stat-item { text-align:center; padding:14px 12px; }
.stat-item:first-child { border-right:1px solid var(--border); }
.stat-label { font-size:10px; color:var(--sub); margin-bottom:4px; letter-spacing:0.5px; text-transform:uppercase; }
.stat-value { font-size:22px; font-weight:800; font-variant-numeric:tabular-nums; }
.stat-value.up { color:var(--red); }
.stat-value.down { color:var(--green); }
.stat-sub { font-size:10px; color:var(--sub); margin-top:3px; }
.stat-sub .beat { color:var(--red); font-weight:600; }
.stat-sub .lose { color:var(--green); font-weight:600; }

/* AI Button */
.ai-btn-wrap { padding:14px 16px 8px; }
.ai-btn { width:100%; padding:13px 16px; border:none; border-radius:var(--radius); background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:white; font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .25s; box-shadow:0 2px 8px rgba(30,41,59,0.3); letter-spacing:0.3px; }
.ai-btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(30,41,59,0.35); }
.ai-btn:active { transform:translateY(0); }
.ai-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
.ai-btn .spinner-sm { width:16px; height:16px; border:2px solid rgba(255,255,255,0.2); border-top-color:white; border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.ai-progress { font-size:11px; color:var(--sub); text-align:center; padding:6px 16px 2px; min-height:20px; }

/* Section */
.section { padding:10px 16px 4px; }
.section-title { font-size:14px; font-weight:700; color:var(--text); margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.section-badge { font-size:9px; background:#1e293b; color:white; padding:2px 8px; border-radius:10px; font-weight:500; letter-spacing:0.3px; }

/* Signal Cards */
.signal-card { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:10px; box-shadow:var(--shadow); transition:all .25s; border:1px solid transparent; }
.signal-card.buy { border-left:4px solid var(--red); background:linear-gradient(135deg,#fff 92%,#fef2f2); }
.signal-card.sell { border-left:4px solid var(--green); background:linear-gradient(135deg,#fff 92%,#ecfdf5); }
.signal-card.hold { border-left:4px solid #cbd5e1; }
.signal-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.signal-fund { flex:1; }
.signal-name { font-size:14px; font-weight:600; }
.signal-code { font-size:10px; color:var(--sub); margin-top:2px; }
.signal-pct { font-size:17px; font-weight:800; min-width:70px; text-align:right; font-variant-numeric:tabular-nums; }
.signal-action { display:inline-flex; align-items:center; gap:4px; padding:4px 12px; border-radius:8px; font-size:12px; font-weight:600; }
.signal-action.buy { background:var(--red-bg); color:var(--red); }
.signal-action.sell { background:var(--green-bg); color:var(--green); }
.signal-action.hold { background:var(--gray-bg); color:var(--sub); }
.signal-urgency { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:500; }
.signal-urgency.high { background:#fee2e2; color:#dc2626; }
.signal-urgency.medium { background:var(--yellow-bg); color:var(--yellow); }
.signal-urgency.low { background:#f1f5f9; color:#64748b; }

/* Confidence Bar */
.conf-bar { display:flex; align-items:center; gap:6px; margin:8px 0; }
.conf-track { flex:1; height:5px; background:#e2e8f0; border-radius:3px; overflow:hidden; }
.conf-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.conf-fill.high { background:linear-gradient(90deg,#22a065,#16a34a); }
.conf-fill.mid { background:linear-gradient(90deg,#f59e0b,#eab308); }
.conf-fill.low { background:#94a3b8; }
.conf-text { font-size:10px; color:var(--sub); min-width:30px; }
.signal-reason { font-size:12px; color:#475569; line-height:1.65; }
.signal-engines { font-size:10px; color:var(--sub); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }

/* Reco Cards */
.reco-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); display:flex; align-items:center; gap:12px; transition:transform .2s; }
.reco-card:active { transform:scale(0.98); }
.reco-info { flex:1; }
.reco-name { font-size:13px; font-weight:600; }
.reco-meta { font-size:10px; color:var(--sub); margin-top:3px; line-height:1.4; }
.reco-expect { font-size:13px; font-weight:700; color:var(--red); }
.reco-add { background:#1e293b; color:white; border:none; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.reco-add:hover { background:#334155; }

/* Watch item */
.watch-item { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:6px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; transition:transform .2s; }
.watch-item:active { transform:scale(0.98); }
.watch-left { flex:1; min-width:0; }
.watch-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.watch-type { font-size:10px; color:var(--sub); margin-top:2px; }
.watch-pct { font-size:15px; font-weight:800; min-width:60px; text-align:right; font-variant-numeric:tabular-nums; }
.watch-signal { font-size:10px; padding:3px 8px; border-radius:6px; white-space:nowrap; font-weight:500; }
.watch-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:14px; padding:4px; transition:color .2s; }
.watch-del:hover { color:var(--red); }

/* Holding delete */
.hold-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:11px; padding:2px 4px; margin-left:4px; transition:color .2s; }
.hold-del:hover { color:var(--red); }

/* Empty state */
.empty { text-align:center; padding:32px 16px; color:var(--sub); font-size:12px; }
.empty-icon { font-size:36px; margin-bottom:10px; opacity:0.6; }

/* Bottom Bar */
.bottom-bar { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); display:flex; gap:10px; z-index:100; box-shadow:0 -2px 10px rgba(0,0,0,0.04); }
.bottom-btn { flex:1; padding:11px; border:none; border-radius:12px; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; letter-spacing:0.3px; }
.bottom-btn.primary { background:#1e293b; color:white; }
.bottom-btn.primary:hover { background:#334155; }
.bottom-btn.secondary { background:var(--gray-bg); color:var(--text); border:1px solid var(--border); }
.bottom-btn.secondary:hover { background:#eef2ff; }

/* Modal */
.modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:400; align-items:center; justify-content:center; }
.fund-search-box { position:relative; margin-bottom:12px; }
.fund-search-box input { width:100%; padding:12px 14px 12px 36px; border:1.5px solid var(--border); border-radius:12px; font-size:14px; outline:none; background:var(--gray-bg); transition:border-color .2s,box-shadow .2s; }
.fund-search-box input:focus { border-color:var(--primary); background:#fff; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
.fund-search-box .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:var(--sub); pointer-events:none; }
.fund-search-results { max-height:260px; overflow-y:auto; border:1px solid var(--border); border-radius:12px; background:var(--card); }
.fund-search-results:empty { display:none; }
.fund-result-item { display:flex; align-items:center; padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--border); transition:background .15s; gap:10px; }
.fund-result-item:last-child { border-bottom:none; }
.fund-result-item:hover,.fund-result-item:active { background:var(--primary-bg); }
.fund-result-code { font-size:13px; font-weight:700; color:var(--primary); min-width:60px; font-variant-numeric:tabular-nums; }
.fund-result-name { font-size:12px; color:var(--text); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fund-result-type { font-size:9px; background:var(--gray-bg); color:var(--sub); padding:2px 6px; border-radius:6px; white-space:nowrap; }
.fund-search-hint { text-align:center; padding:20px 10px; font-size:11px; color:var(--sub); }
.fund-selected-card { display:flex; align-items:center; gap:10px; padding:12px 14px; background:linear-gradient(135deg,var(--primary-bg),#eef2ff); border:1.5px solid var(--primary); border-radius:12px; margin-bottom:14px; }
.fund-selected-card .sel-code { font-size:15px; font-weight:700; color:var(--primary); }
.fund-selected-card .sel-name { font-size:13px; color:var(--text); flex:1; }
.fund-selected-card .sel-clear { background:none; border:none; font-size:16px; color:var(--sub); cursor:pointer; padding:4px; }
.modal { background:var(--card); border-radius:20px; margin:16px; padding:24px; max-width:380px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.15); }
.modal h3 { font-size:17px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; }
.modal h3 button { background:none; border:none; font-size:18px; cursor:pointer; color:var(--sub); width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background .2s; }
.modal h3 button:hover { background:var(--gray-bg); }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; font-weight:600; color:var(--sub); margin-bottom:5px; letter-spacing:0.3px; text-transform:uppercase; }
.form-row input, .form-row select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; transition:border-color .2s; outline:none; background:var(--gray-bg); }
.form-row input:focus, .form-row select:focus { border-color:var(--primary); background:#fff; }
.form-btn { width:100%; padding:12px; border:none; border-radius:12px; background:#1e293b; color:white; font-size:14px; font-weight:600; cursor:pointer; transition:background .2s; letter-spacing:0.3px; }
.form-btn:hover { background:#334155; }

.spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto; }

/* Market summary */
.market-summary { font-size:12px; color:#475569; line-height:1.7; padding:14px 16px; background:var(--card); border-radius:var(--radius); margin-bottom:10px; box-shadow:var(--shadow); border-left:3px solid var(--primary); }
.provider-tag { font-size:9px; background:var(--primary-bg); color:var(--primary); padding:2px 8px; border-radius:10px; margin-left:6px; font-weight:500; }

/* Index Bar */
.idx-bar { background:linear-gradient(135deg,#0f172a,#1e293b); padding:10px 16px 12px; display:flex; gap:0; border-bottom:1px solid rgba(255,255,255,0.06); }
.idx-item { flex:1; text-align:center; position:relative; }
.idx-item+.idx-item { border-left:1px solid rgba(255,255,255,0.08); }
.idx-name { font-size:10px; color:rgba(251,191,36,0.75); letter-spacing:0.3px; }
.idx-val { font-size:14px; font-weight:700; color:#fff; margin-top:2px; font-variant-numeric:tabular-nums; }
.idx-pct { font-size:11px; font-weight:600; margin-top:1px; font-variant-numeric:tabular-nums; }
.idx-pct.up { color:#ef4444; }
.idx-pct.down { color:#22c55e; }
.idx-pct.flat { color:rgba(255,255,255,0.5); }

/* Portfolio Section */
.pf-section { padding:10px 16px 4px; }
.pf-tabs { display:flex; gap:0; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); margin-bottom:12px; }
.pf-tab { flex:1; padding:10px 8px; text-align:center; cursor:pointer; border:none; background:transparent; font-size:12px; font-weight:600; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; }
.pf-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.pf-tab .pf-tab-ratio { font-size:10px; font-weight:400; color:var(--sub); display:block; margin-top:2px; }
.pf-group { display:none; }
.pf-group.active { display:block; }
.pf-group-desc { font-size:11px; color:var(--sub); margin-bottom:10px; padding:0 2px; line-height:1.5; }
.pf-card { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.pf-card:active { transform:scale(0.98); }
.pf-card.swing-buy { border-left:3px solid var(--red); }
.pf-card.swing-sell { border-left:3px solid var(--green); }
.pf-card.swing-hold { border-left:3px solid #cbd5e1; }
.pf-top { display:flex; justify-content:space-between; align-items:flex-start; }
.pf-info { flex:1; min-width:0; }
.pf-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pf-code { font-size:10px; color:var(--sub); margin-top:1px; }
.pf-right { text-align:right; min-width:70px; }
.pf-pct { font-size:16px; font-weight:800; font-variant-numeric:tabular-nums; }
.pf-swing-tag { display:inline-block; font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; margin-top:3px; }
.pf-swing-tag.buy { background:var(--red-bg); color:var(--red); }
.pf-swing-tag.sell { background:var(--green-bg); color:var(--green); }
.pf-swing-tag.hold { background:var(--gray-bg); color:var(--sub); }
.pf-trend-row { display:flex; gap:6px; flex-wrap:wrap; font-size:10px; margin-top:8px; padding-top:7px; border-top:1px solid var(--border); }
.pf-trend-item { display:flex; align-items:center; gap:2px; }
.pf-trend-label { color:var(--sub); }
.pf-reason { font-size:11px; color:#64748b; margin-top:6px; line-height:1.4; }
.pf-actions { display:flex; gap:6px; margin-top:8px; }
.pf-act-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.pf-act-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.pf-act-btn.in-hold { background:rgba(34,160,101,0.08); color:var(--green); border-color:var(--green); cursor:default; font-weight:600; }
.pf-act-btn.in-watch { background:rgba(79,110,247,0.08); color:var(--primary); border-color:var(--primary); cursor:default; font-weight:600; }

/* Review Section */
.review-section { padding:10px 16px 4px; }
.review-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:var(--shadow); }
.review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.review-date { font-size:13px; font-weight:700; color:var(--text); }
.review-pnl { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.review-stats { display:flex; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
.review-stat { font-size:11px; display:flex; align-items:center; gap:4px; }
.review-stat-label { color:var(--sub); }
.review-stat-val { font-weight:600; }
.review-items { border-top:1px solid var(--border); padding-top:8px; }
.review-item { display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.03); font-size:12px; }
.review-item:last-child { border-bottom:none; }
.review-fund-name { flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; }
.review-pred { font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; }
.review-pred.buy { background:var(--red-bg); color:var(--red); }
.review-pred.sell { background:var(--green-bg); color:var(--green); }
.review-pred.hold { background:var(--gray-bg); color:var(--sub); }
.review-actual { font-weight:700; min-width:55px; text-align:right; font-variant-numeric:tabular-nums; }
.review-verdict { font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; white-space:nowrap; }
.review-verdict.correct { background:#ecfdf5; color:#16a34a; }
.review-verdict.wrong { background:#fef2f2; color:#dc2626; }
.review-verdict.neutral { background:#f8fafc; color:#64748b; }
.review-lesson { margin-top:8px; padding:8px 12px; background:#fffbeb; border-radius:8px; border:1px solid #fde68a; font-size:11px; color:#92400e; line-height:1.5; }
.review-toggle { font-size:11px; color:var(--primary); cursor:pointer; font-weight:500; }
.review-history-toggle { text-align:center; padding:8px; }

/* Simulation Portfolio */
.sim-section { padding:10px 16px 4px; }
.sim-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.sim-header-right { display:flex; align-items:center; gap:8px; }
.sim-toggle-icon { font-size:12px; color:var(--sub); transition:transform .2s; }
.sim-overview { background:linear-gradient(135deg,#0f172a,#1e293b); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 8px rgba(15,23,42,0.2); }
.sim-stat-row { display:flex; gap:0; }
.sim-stat { flex:1; text-align:center; position:relative; }
.sim-stat+.sim-stat { border-left:1px solid rgba(255,255,255,0.1); }
.sim-stat-label { font-size:9px; color:rgba(255,255,255,0.5); letter-spacing:0.3px; }
.sim-stat-val { font-size:18px; font-weight:800; margin-top:2px; font-variant-numeric:tabular-nums; }
.sim-target { margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); }
.sim-target span { color:rgba(255,255,255,0.6); }
.sim-progress { height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; }
.sim-progress-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.sim-compare { background:var(--card); border-radius:var(--radius); padding:12px 14px; margin-bottom:10px; box-shadow:var(--shadow); }
.sim-compare-title { font-size:12px; font-weight:700; margin-bottom:8px; }
.sim-compare-row { display:flex; gap:0; }
.sim-compare-item { flex:1; text-align:center; padding:4px 0; }
.sim-compare-item+.sim-compare-item { border-left:1px solid var(--border); }
.sim-compare-label { font-size:9px; color:var(--sub); display:block; }
.sim-compare-val { font-size:14px; font-weight:700; font-variant-numeric:tabular-nums; }
.sim-pos-card { background:var(--card); border-radius:10px; padding:10px 12px; margin-bottom:6px; box-shadow:var(--shadow); }
.sim-pos-top { display:flex; justify-content:space-between; align-items:flex-start; }
.sim-pos-info { flex:1; min-width:0; }
.sim-pos-name { font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.sim-pos-meta { font-size:9px; color:var(--sub); margin-top:1px; }
.sim-pos-right { text-align:right; min-width:60px; }
.sim-pos-pct { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.sim-pos-detail { display:flex; gap:8px; font-size:10px; color:var(--sub); margin-top:4px; padding-top:4px; border-top:1px solid var(--border); }
.sim-learn-card { background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:8px 10px; margin-bottom:6px; }
.sim-strategy-card { background:var(--card); border-radius:10px; padding:10px 14px; box-shadow:var(--shadow); margin-bottom:8px; }
.sim-param-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.sim-param { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.sp-label { font-size:9px; color:var(--sub); display:block; }
.sp-val { font-size:12px; font-weight:700; }
.sim-trade-item { display:flex; align-items:center; gap:6px; padding:6px 0; border-bottom:1px solid var(--border); font-size:11px; }
.sim-trade-item:last-child { border-bottom:none; }
.sim-chart { background:var(--card); border-radius:10px; padding:10px 12px; box-shadow:var(--shadow); }
.sim-chart-row { display:flex; align-items:center; gap:6px; padding:2px 0; }
.sim-chart-date { font-size:9px; color:var(--sub); min-width:36px; }
.sim-chart-bar { flex:1; height:10px; background:var(--bg); border-radius:3px; overflow:hidden; }
.sim-chart-val { font-size:9px; font-weight:600; min-width:42px; text-align:right; font-variant-numeric:tabular-nums; }

/* Manage Panel */
/* Data Intelligence Dashboard */
.data-intel { padding:10px 16px 4px; }
.data-intel-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.data-intel-header-right { display:flex; align-items:center; gap:8px; }
.data-intel-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.data-intel-brief { font-size:11px; font-weight:600; }
.data-intel-container { margin-top:8px; }
.macro-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.macro-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.macro-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.macro-item { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.macro-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.macro-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.macro-val.positive { color:var(--red); }
.macro-val.negative { color:var(--green); }
.macro-val.neutral { color:var(--sub); }
.news-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.news-item { display:flex; gap:6px; padding:5px 0; border-bottom:1px solid var(--border); align-items:flex-start; }
.news-item:last-child { border-bottom:none; }
.news-sentiment { font-size:12px; min-width:18px; text-align:center; }
.news-text { font-size:11px; color:var(--text); line-height:1.4; flex:1; }
.news-time { font-size:9px; color:var(--sub); min-width:36px; text-align:right; white-space:nowrap; }
.cap-flow-bar { height:8px; border-radius:4px; overflow:hidden; background:var(--bg); margin-top:2px; }
.cap-flow-fill { height:100%; border-radius:4px; }
.sentiment-meter { display:flex; align-items:center; gap:8px; padding:8px 0; }
.sentiment-bar { flex:1; height:10px; border-radius:5px; background:linear-gradient(90deg,var(--green),#fbbf24,var(--red)); position:relative; }
.sentiment-dot { width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #1e293b; position:absolute; top:-2px; transition:left .3s; }
.sentiment-label { font-size:10px; font-weight:700; min-width:40px; }
/* Real-World Action Guide */
.action-guide { padding:12px 16px 6px; }
.action-guide-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.action-guide-header-right { display:flex; align-items:center; gap:8px; }
.action-guide-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.action-guide-brief { font-size:11px; font-weight:600; }
.action-guide-container { margin-top:8px; }
.ag-overview { background:linear-gradient(135deg,#1a1a2e,#16213e); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 12px rgba(22,33,62,0.25); }
.ag-score-row { display:flex; align-items:center; gap:14px; margin-bottom:10px; }
.ag-big-score { font-size:36px; font-weight:900; font-variant-numeric:tabular-nums; line-height:1; }
.ag-score-meta { flex:1; }
.ag-score-label { font-size:13px; font-weight:700; }
.ag-score-desc { font-size:10px; color:rgba(255,255,255,0.55); margin-top:2px; }
.ag-engines { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:10px; }
.ag-engine { background:rgba(255,255,255,0.06); border-radius:8px; padding:8px 6px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
.ag-engine-icon { font-size:16px; }
.ag-engine-name { font-size:8px; color:rgba(255,255,255,0.45); letter-spacing:0.3px; margin:2px 0; }
.ag-engine-vote { font-size:11px; font-weight:700; }
.ag-engine-conf { font-size:8px; color:rgba(255,255,255,0.4); margin-top:1px; }
.ag-advice-bar { background:rgba(255,255,255,0.08); border-radius:8px; padding:8px 12px; font-size:11px; line-height:1.5; }
.ag-advice-bar b { color:#fbbf24; }
.ag-fund-card { background:var(--card); border-radius:10px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); border-left:3px solid var(--border); transition:border-color .2s; }
.ag-fund-card.action-buy { border-left-color:var(--red); }
.ag-fund-card.action-sell { border-left-color:var(--green); }
.ag-fund-card.action-hold { border-left-color:var(--primary); }
.ag-fund-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
.ag-fund-name { font-size:13px; font-weight:700; }
.ag-fund-code { font-size:10px; color:var(--sub); }
.ag-fund-action { font-size:12px; font-weight:700; padding:2px 10px; border-radius:6px; }
.ag-fund-action.buy { background:var(--red-bg); color:var(--red); }
.ag-fund-action.sell { background:var(--green-bg); color:var(--green); }
.ag-fund-action.hold { background:var(--primary-bg); color:var(--primary); }
.ag-vote-strip { display:flex; gap:3px; margin-bottom:6px; }
.ag-vote-chip { font-size:8px; padding:1px 6px; border-radius:4px; font-weight:600; letter-spacing:0.2px; }
.ag-vote-chip.bullish { background:#fef2f2; color:#ef4444; }
.ag-vote-chip.bearish { background:#ecfdf5; color:#16a34a; }
.ag-vote-chip.neutral { background:#f8fafc; color:#94a3b8; }
.ag-reason { font-size:11px; color:#475569; line-height:1.5; margin-bottom:6px; }
.ag-metrics { display:flex; gap:4px; flex-wrap:wrap; }
.ag-metric { font-size:9px; padding:2px 6px; border-radius:4px; background:var(--bg); color:var(--sub); }
.ag-metric b { color:var(--text); font-weight:600; }
.ag-position-bar { margin-top:8px; }
.ag-pos-label { font-size:9px; color:var(--sub); display:flex; justify-content:space-between; margin-bottom:3px; }
.ag-pos-track { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; }
.ag-pos-fill { height:100%; border-radius:3px; transition:width .3s; }
.ag-summary { background:var(--card); border-radius:10px; padding:12px 14px; box-shadow:var(--shadow); border:1px dashed var(--border); }
.ag-summary-title { font-size:11px; font-weight:700; margin-bottom:6px; }
.ag-summary-text { font-size:11px; color:#475569; line-height:1.6; }
.ag-summary-text b { color:var(--text); }
.ag-disclaimer { font-size:9px; color:var(--sub); text-align:center; padding:6px 0; line-height:1.4; }

/* RL Brain Dashboard */
.rl-brain { padding:10px 16px 4px; }
.rl-brain-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.rl-brain-header-right { display:flex; align-items:center; gap:8px; }
.rl-brain-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.rl-brain-brief { font-size:11px; font-weight:600; }
.rl-brain-container { margin-top:8px; }
.rl-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.rl-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.rl-status { display:flex; align-items:center; gap:6px; margin-bottom:8px; }
.rl-status-dot { width:8px; height:8px; border-radius:50%; }
.rl-status-dot.active { background:#22c55e; animation:rlPulse 1.5s infinite; }
.rl-status-dot.idle { background:var(--sub); }
.rl-status-dot.training { background:#eab308; animation:rlPulse 0.5s infinite; }
.rl-status-text { font-size:10px; color:var(--sub); }
.rl-progress { width:100%; height:6px; background:var(--bg); border-radius:3px; overflow:hidden; margin:6px 0; }
.rl-progress-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,#3b82f6,#8b5cf6); transition:width .3s; }
.rl-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.rl-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.rl-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.rl-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.rl-chart { height:60px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.rl-train-btn { width:100%; padding:8px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:6px; }
.rl-train-btn.start { background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; }
.rl-train-btn.stop { background:#ef4444; color:white; }
.rl-train-btn:disabled { opacity:0.5; cursor:not-allowed; }
.rl-signal-row { display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom:1px solid var(--border); }
.rl-signal-row:last-child { border-bottom:none; }
.rl-signal-name { font-size:11px; flex:1; }
.rl-signal-action { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; }
.rl-signal-action.buy { background:rgba(239,68,68,0.1); color:var(--red); }
.rl-signal-action.sell { background:rgba(34,197,94,0.1); color:var(--green); }
.rl-signal-action.hold { background:rgba(148,163,184,0.1); color:var(--sub); }
.rl-signal-conf { font-size:10px; color:var(--sub); min-width:32px; text-align:right; }
.rl-qbar { display:flex; gap:2px; flex:1; }
.rl-qbar-seg { height:6px; border-radius:2px; min-width:2px; }
@keyframes rlPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
/* Backtest Dashboard */
.bt-section { padding:10px 16px 4px; }
.bt-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.bt-header-right { display:flex; align-items:center; gap:8px; }
.bt-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.bt-brief { font-size:11px; font-weight:600; }
.bt-container { margin-top:8px; }
.bt-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.bt-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.bt-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.bt-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.bt-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.bt-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.bt-chart { height:80px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.bt-trade-row { display:flex; align-items:center; gap:6px; padding:4px 0; border-bottom:1px solid var(--border); font-size:10px; }
.bt-trade-row:last-child { border-bottom:none; }
.bt-run-btn { width:100%; padding:8px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:6px; background:linear-gradient(135deg,#f59e0b,#ef4444); color:white; }
.bt-run-btn:disabled { opacity:0.5; cursor:not-allowed; }
.bt-kelly-bar { display:flex; height:16px; border-radius:4px; overflow:hidden; background:var(--bg); margin-top:4px; }
.bt-kelly-seg { height:100%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:white; transition:width .3s; }
.bt-dd-chart { height:50px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.bt-fund-row { display:flex; align-items:center; gap:6px; padding:5px 0; border-bottom:1px solid var(--border); }
.bt-fund-row:last-child { border-bottom:none; }
.bt-fund-name { font-size:11px; flex:1; }
.bt-fund-ret { font-size:11px; font-weight:700; min-width:50px; text-align:right; }
.bt-fund-sharpe { font-size:10px; color:var(--sub); min-width:40px; text-align:right; }
.bt-fund-mdd { font-size:10px; min-width:45px; text-align:right; }
.bt-fund-kelly { font-size:10px; font-weight:600; min-width:35px; text-align:right; }
/* Manage Panel */
.manage-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:300; }
.manage-panel { position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--bg); border-radius:20px 20px 0 0; max-height:88vh; display:flex; flex-direction:column; animation:slideUp .3s ease; }
@keyframes slideUp { from{transform:translateX(-50%) translateY(100%)} to{transform:translateX(-50%) translateY(0)} }
.manage-header { display:flex; align-items:center; padding:16px 16px 0; gap:8px; }
.manage-tabs { flex:1; display:flex; gap:0; background:var(--card); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); }
.manage-tab { flex:1; padding:10px 12px; text-align:center; font-size:13px; font-weight:600; cursor:pointer; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; background:transparent; }
.manage-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.manage-count { font-size:10px; font-weight:400; background:rgba(0,0,0,0.06); padding:1px 6px; border-radius:8px; margin-left:2px; }
.manage-close { background:none; border:none; font-size:20px; cursor:pointer; color:var(--sub); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-close:hover { background:var(--card); color:var(--text); }
.manage-toolbar { display:flex; gap:8px; padding:12px 16px 8px; align-items:center; }
.manage-search { flex:1; padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; outline:none; background:var(--card); transition:border-color .2s; }
.manage-search:focus { border-color:var(--primary); }
.manage-add-btn { padding:9px 16px; border:none; border-radius:10px; background:#1e293b; color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.manage-add-btn:hover { background:#334155; }
.manage-body { flex:1; overflow-y:auto; padding:4px 16px 20px; -webkit-overflow-scrolling:touch; }
.manage-empty { text-align:center; padding:48px 16px; color:var(--sub); }
.manage-empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.manage-empty-text { font-size:13px; margin-bottom:16px; }
.manage-fund { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.manage-fund:active { transform:scale(0.98); }
.manage-fund-top { display:flex; justify-content:space-between; align-items:flex-start; }
.manage-fund-info { flex:1; min-width:0; }
.manage-fund-name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.manage-fund-meta { font-size:10px; color:var(--sub); margin-top:3px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.manage-fund-type { padding:1px 6px; border-radius:4px; background:var(--primary-bg); color:var(--primary); font-size:9px; font-weight:500; }
.manage-fund-right { display:flex; align-items:center; gap:10px; }
.manage-fund-pct { font-size:18px; font-weight:800; font-variant-numeric:tabular-nums; min-width:65px; text-align:right; }
.manage-fund-nav { font-size:10px; color:var(--sub); text-align:right; margin-top:2px; }
.manage-fund-del { background:none; border:1px solid #e2e8f0; color:#94a3b8; cursor:pointer; font-size:12px; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-fund-del:hover { background:#fef2f2; border-color:#fca5a5; color:var(--red); }
.manage-fund-trend { display:flex; gap:8px; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:10px; flex-wrap:wrap; }
.manage-fund-trend span { display:flex; align-items:center; gap:2px; }
.manage-fund-actions { display:flex; gap:6px; margin-top:8px; }
.manage-action-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.manage-action-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.manage-action-btn.danger { color:var(--red); border-color:#fca5a5; }
.manage-action-btn.danger:hover { background:var(--red); color:white; border-color:var(--red); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <span class="header-title">ğŸ“Š åŸºé‡‘å†³ç­–åŠ©æ‰‹</span>
    <div style="display:flex;gap:8px;align-items:center">
      <a href="manager-analysis.html" style="color:white;font-size:11px;opacity:0.8;text-decoration:none">TOP500</a>
      <button class="header-gear" onclick="openSettings()">âš™ï¸</button>
    </div>
  </div>
  <div class="market-status">
    <span class="status-dot" id="status-dot"></span>
    <span id="market-status-text">æ£€æµ‹ä¸­...</span>
    <span class="countdown" id="countdown">--:--:--</span>
  </div>
</div>

<!-- Index Bar -->
<div class="idx-bar" id="idx-bar">
  <div class="idx-item"><div class="idx-name">ä¸Šè¯</div><div class="idx-val" id="iv-sh">--</div><div class="idx-pct flat" id="ip-sh">--</div></div>
  <div class="idx-item"><div class="idx-name">æ·±è¯</div><div class="idx-val" id="iv-sz">--</div><div class="idx-pct flat" id="ip-sz">--</div></div>
  <div class="idx-item"><div class="idx-name">åˆ›ä¸šæ¿</div><div class="idx-val" id="iv-cy">--</div><div class="idx-pct flat" id="ip-cy">--</div></div>
  <div class="idx-item"><div class="idx-name">æ²ªæ·±300</div><div class="idx-val" id="iv-hs">--</div><div class="idx-pct flat" id="ip-hs">--</div></div>
</div>
<div class="idx-bar" id="idx-bar-2" style="padding-top:0;border-top:none">
  <div class="idx-item"><div class="idx-name">ğŸ¥‡ é»„é‡‘ETF</div><div class="idx-val" id="iv-au">--</div><div class="idx-pct flat" id="ip-au">--</div></div>
  <div class="idx-item"><div class="idx-name">ğŸ¥ˆ ç™½é“¶LOF</div><div class="idx-val" id="iv-ag">--</div><div class="idx-pct flat" id="ip-ag">--</div></div>
  <div class="idx-item"><div class="idx-name">ğŸ”© æœ‰è‰²é‡‘å±</div><div class="idx-val" id="iv-ys">--</div><div class="idx-pct flat" id="ip-ys">--</div></div>
</div>

<!-- Stats Bar -->
<div class="stats-bar" id="stats-bar">
  <div class="stat-item">
    <div class="stat-label">ä»Šæ—¥æŒä»“ç›ˆäº</div>
    <div class="stat-value" id="stat-today">--</div>
    <div class="stat-sub" id="stat-bench-today"></div>
  </div>
  <div class="stat-item">
    <div class="stat-label">æ²ªæ·±300ä»Šæ—¥</div>
    <div class="stat-value" id="stat-hs300">--</div>
    <div class="stat-sub" id="stat-bench-label">å¤§ç›˜åŸºå‡†</div>
  </div>
</div>

<!-- Data Intelligence Dashboard -->
<div class="data-intel">
  <div class="section-title data-intel-header" onclick="toggleDataIntel()">
    <span>ğŸ“¡ æ•°æ®æƒ…æŠ¥ä¸­å¿ƒ <span style="font-size:10px;color:var(--sub);font-weight:400">å®è§‚Â·èµ„é‡‘Â·èˆ†æƒ…</span></span>
    <div class="data-intel-header-right">
      <span id="data-intel-brief" class="data-intel-brief" style="color:var(--sub)">åŠ è½½ä¸­...</span>
      <span class="data-intel-toggle" id="data-intel-toggle">â–¶</span>
    </div>
  </div>
  <div id="data-intel-container" class="data-intel-container" style="display:none"></div>
</div>

<!-- RL Brain Dashboard -->
<div class="rl-brain">
  <div class="section-title rl-brain-header" onclick="toggleRLBrain()">
    <span>ğŸ§  RLå¼ºåŒ–å­¦ä¹ å¤§è„‘ <span style="font-size:10px;color:var(--sub);font-weight:400">DQN Â· Double Q Â· Adam</span></span>
    <div class="rl-brain-header-right">
      <span id="rl-brain-brief" class="rl-brain-brief" style="color:var(--sub)">æœªè®­ç»ƒ</span>
      <span class="rl-brain-toggle" id="rl-brain-toggle">â–¶</span>
    </div>
  </div>
  <div id="rl-brain-container" class="rl-brain-container" style="display:none"></div>
</div>

<!-- Backtest Dashboard -->
<div class="bt-section">
  <div class="section-title bt-header" onclick="toggleBacktest()">
    <span>ğŸ“ˆ å›æµ‹å¼•æ“ <span style="font-size:10px;color:var(--sub);font-weight:400">RSIç­–ç•¥ Â· Kellyä»“ä½ Â· Sharpe</span></span>
    <div class="bt-header-right">
      <span id="bt-brief" class="bt-brief" style="color:var(--sub)">æœªå›æµ‹</span>
      <span class="bt-toggle" id="bt-toggle">â–¶</span>
    </div>
  </div>
  <div id="bt-container" class="bt-container" style="display:none"></div>
</div>

<!-- Simulation Portfolio -->
<div class="sim-section">
  <div class="section-title sim-header" onclick="toggleSimDetail()">
    <span>ğŸ¤– AIæ¨¡æ‹Ÿç›˜ <span style="font-size:10px;color:var(--sub);font-weight:400">50ä¸‡å»ºä»“ Â· AIè‡ªåŠ¨äº¤æ˜“</span></span>
    <div class="sim-header-right">
      <span id="sim-brief" style="font-size:12px;font-weight:700">--</span>
      <span class="sim-toggle-icon" id="sim-toggle-icon">â–¼</span>
    </div>
  </div>
  <div id="sim-container"></div>
</div>

<!-- Real-World Action Guide -->
<div class="action-guide">
  <div class="section-title action-guide-header" onclick="toggleActionGuide()">
    <span>ğŸ¯ å®ç›˜è¡ŒåŠ¨æŒ‡å— <span style="font-size:10px;color:var(--sub);font-weight:400">ä¸‰å¼•æ“å…±è¯† Â· å®æ“å»ºè®®</span></span>
    <div class="action-guide-header-right">
      <span id="action-guide-brief" class="action-guide-brief" style="color:var(--sub)">ç­‰å¾…åˆ†æ</span>
      <span class="action-guide-toggle" id="action-guide-toggle">â–¼</span>
    </div>
  </div>
  <div id="action-guide-container" class="action-guide-container"></div>
</div>

<!-- Portfolio Section -->
<div class="pf-section">
  <div class="section-title">ğŸ’¼ æ³¢æ®µç»„åˆ <span style="font-size:10px;color:var(--sub);font-weight:400">å®æ—¶è¶‹åŠ¿ Â· æ³¢æ®µä¿¡å·</span></div>
  <div class="pf-tabs">
    <div class="pf-tab active" onclick="switchPfTab('core')" id="pf-tab-core">ğŸ›¡ï¸ æ ¸å¿ƒä»“<span class="pf-tab-ratio">å»ºè®®60%</span></div>
    <div class="pf-tab" onclick="switchPfTab('satellite')" id="pf-tab-sat">ğŸš€ å«æ˜Ÿä»“<span class="pf-tab-ratio">å»ºè®®40%</span></div>
  </div>
  <div class="pf-group active" id="pf-group-core"></div>
  <div class="pf-group" id="pf-group-satellite"></div>
</div>

<!-- AI Button -->
<div class="ai-btn-wrap">
  <button class="ai-btn" id="ai-btn" onclick="triggerAI()">
    ğŸ§  ä¸€é”®AIåˆ†æ Â· 4å¼•æ“ç ”åˆ¤
  </button>
  <div class="ai-progress" id="ai-progress"></div>
</div>

<!-- Market Summary (AI generated) -->
<div class="section" id="market-summary-section" style="display:none">
  <div id="market-summary"></div>
</div>

<!-- Daily Review -->
<div class="review-section" id="review-section" style="display:none">
  <div class="section-title">ğŸ“ æ¯æ—¥å¤ç›˜ <span style="font-size:10px;color:var(--sub);font-weight:400">æ˜¨æ—¥åˆ¤æ–­ vs ä»Šæ—¥ç»“æœ</span></div>
  <div id="review-container"></div>
  <div class="review-history-toggle" id="review-history-toggle" style="display:none">
    <span class="review-toggle" onclick="toggleReviewHistory()">ğŸ“‹ æŸ¥çœ‹å†å²å¤ç›˜è®°å½•</span>
  </div>
  <div id="review-history" style="display:none"></div>
</div>

<!-- Action Signals -->
<div class="section">
  <div class="section-title">ğŸ“‹ ä»Šæ—¥æ“ä½œä¿¡å· <span class="section-badge" id="signal-badge">ç­‰å¾…åˆ†æ</span></div>
  <div id="signals-container">
    <div class="empty"><div class="empty-icon">ğŸ“¥</div>æ·»åŠ æŒä»“åï¼ŒAIä¼šç»™å‡ºä»Šæ—¥æ“ä½œå»ºè®®</div>
  </div>
</div>

<!-- Watchlist Signals -->
<div class="section" id="watchlist-section" style="display:none">
  <div class="section-title">ğŸ‘ è‡ªé€‰è§‚å¯Ÿ</div>
  <div id="watchlist-container"></div>
</div>

<!-- AI Recommendations -->
<div class="section" id="reco-section" style="display:none">
  <div class="section-title">ğŸ¯ AIæ¨èå…³æ³¨ <span style="font-size:10px;color:var(--sub);font-weight:400">3æœˆç¨³å¥å¢é•¿è§†è§’</span></div>
  <div id="reco-container"></div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <button class="bottom-btn primary" onclick="openManagePanel('holding')">ğŸ’¼ æŒä»“ç®¡ç†</button>
  <button class="bottom-btn secondary" onclick="openManagePanel('watch')">ğŸ‘ è‡ªé€‰ç®¡ç†</button>
</div>

<!-- Manage Panel (Full Screen Slide Up) -->
<div class="manage-overlay" id="manage-overlay" onclick="if(event.target===this)closeManagePanel()">
  <div class="manage-panel">
    <div class="manage-header">
      <div class="manage-tabs">
        <div class="manage-tab active" id="manage-tab-holding" onclick="switchManageTab('holding')">ğŸ’¼ æŒä»“ <span class="manage-count" id="manage-holding-count">0</span></div>
        <div class="manage-tab" id="manage-tab-watch" onclick="switchManageTab('watch')">ğŸ‘ è‡ªé€‰ <span class="manage-count" id="manage-watch-count">0</span></div>
      </div>
      <button class="manage-close" onclick="closeManagePanel()">âœ•</button>
    </div>
    <div class="manage-toolbar">
      <input type="text" class="manage-search" id="manage-search" placeholder="ğŸ” æœç´¢åŸºé‡‘ä»£ç æˆ–åç§°..." oninput="renderManageList()">
      <button class="manage-add-btn" onclick="openAddModal(_manageTab)">+ æ·»åŠ </button>
    </div>
    <div class="manage-body" id="manage-body"></div>
  </div>
</div>

<!-- Add Fund Modal -->
<div class="modal-overlay" id="add-modal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal">
    <h3 id="add-modal-title">æ·»åŠ æŒä»“ <button onclick="closeAddModal()">âœ•</button></h3>
    <!-- æœç´¢åŒº -->
    <div id="add-search-area">
      <div class="fund-search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="add-search-input" placeholder="è¾“å…¥åŸºé‡‘ä»£ç æˆ–åç§°æœç´¢..." oninput="onFundSearchInput()" autocomplete="off">
      </div>
      <div class="fund-search-results" id="add-search-results"></div>
      <div id="add-search-hint" class="fund-search-hint">è¾“å…¥åŸºé‡‘ä»£ç ï¼ˆå¦‚ 000216ï¼‰æˆ–å…³é”®è¯ï¼ˆå¦‚ã€Œé»„é‡‘ã€ï¼‰æœç´¢</div>
    </div>
    <!-- å·²é€‰ä¸­åŒº -->
    <div id="add-selected-area" style="display:none">
      <div class="fund-selected-card">
        <span class="sel-code" id="add-sel-code"></span>
        <span class="sel-name" id="add-sel-name"></span>
        <button class="sel-clear" onclick="clearFundSelection()" title="é‡æ–°é€‰æ‹©">âœ•</button>
      </div>
      <div class="form-row" id="add-type-row"><label>ç±»å‹</label>
        <select id="add-type"><option value="å®½åŸº">å®½åŸº</option><option value="AI/ç§‘æŠ€">AI/ç§‘æŠ€</option><option value="é»„é‡‘">é»„é‡‘</option><option value="çº¢åˆ©">çº¢åˆ©</option><option value="å†›å·¥">å†›å·¥</option><option value="æ–°èƒ½æº">æ–°èƒ½æº</option><option value="æ¶ˆè´¹">æ¶ˆè´¹</option><option value="åŒ»è¯">åŒ»è¯</option><option value="åŠå¯¼ä½“">åŠå¯¼ä½“</option><option value="æœ‰è‰²é‡‘å±">æœ‰è‰²é‡‘å±</option><option value="QDII">QDII</option><option value="å…¶ä»–">å…¶ä»–</option></select>
      </div>
      <button class="form-btn" onclick="confirmAdd()">ç¡®è®¤æ·»åŠ </button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="max-width:360px">
    <h3>âš™ï¸ è®¾ç½® <button onclick="closeSettings()">âœ•</button></h3>
    <div style="padding:6px 0">
      <div style="font-size:11px;font-weight:600;margin-bottom:8px">ğŸŒ AIæœåŠ¡å•†</div>
      <div id="provider-list"></div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 6px">API Key</div>
      <div class="form-row">
        <input type="password" id="input-key" placeholder="è¾“å…¥API Key" style="width:100%;font-size:12px">
      </div>
      <div id="provider-hint" style="font-size:10px;color:var(--sub);margin:-6px 0 10px"></div>
      <div style="font-size:11px;font-weight:600;margin:12px 0 6px">AIå¼•æ“æ¨¡å‹ï¼š</div>
      <div id="engine-list" style="font-size:11px"></div>
      <button class="form-btn" onclick="saveSettings()" style="margin-top:14px">ä¿å­˜è®¾ç½®</button>
      <div style="text-align:center;margin-top:8px">
        <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="toggleKeyVis()">æ˜¾ç¤º/éšè—Key</span>
        <span style="font-size:10px;color:var(--sub);margin-left:12px;cursor:pointer;text-decoration:underline" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</span>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== FUND DATABASE ====================
const FUND_DB = [
  {code:'000216',name:'åå®‰é»„é‡‘ETFè”æ¥A',type:'é»„é‡‘',baseNav:1.38},
  {code:'012414',name:'åå¤ä¸­è¯A500ETFè”æ¥A',type:'å®½åŸº',baseNav:1.25},
  {code:'011852',name:'å¤©å¼˜ä¸­è¯äº‘è®¡ç®—ä¸å¤§æ•°æ®ETFè”æ¥A',type:'AI/ç§‘æŠ€',baseNav:0.91},
  {code:'004814',name:'ä¸­æ¬§çº¢åˆ©ä¼˜äº«æ··åˆA',type:'çº¢åˆ©',baseNav:1.48},
  {code:'257070',name:'å›½æ³°ä¸­è¯å†›å·¥ETFè”æ¥A',type:'å†›å·¥',baseNav:1.12},
  {code:'003834',name:'åå¤èƒ½æºé©æ–°è‚¡ç¥¨A',type:'æ–°èƒ½æº',baseNav:1.65},
  {code:'161725',name:'æ‹›å•†ä¸­è¯ç™½é…’æŒ‡æ•°A',type:'ç™½é…’/æ¶ˆè´¹',baseNav:1.28},
  {code:'110011',name:'æ˜“æ–¹è¾¾ä¸­å°ç›˜æ··åˆ',type:'ä¸­å°ç›˜',baseNav:5.52},
  {code:'005827',name:'æ˜“æ–¹è¾¾è“ç­¹ç²¾é€‰æ··åˆ',type:'è“ç­¹',baseNav:2.05},
  {code:'001156',name:'ç”³ä¸‡è±ä¿¡ä¸­è¯åŠå¯¼ä½“æŒ‡æ•°A',type:'åŠå¯¼ä½“',baseNav:1.18},
  {code:'320007',name:'è¯ºå®‰æˆé•¿æ··åˆ',type:'åŠå¯¼ä½“/ç§‘æŠ€',baseNav:1.42},
  {code:'160119',name:'å—æ–¹ä¸­è¯500ETFè”æ¥A',type:'å®½åŸº',baseNav:1.55},
];

// æ¨èç»„åˆï¼šæ ¸å¿ƒä»“(ç¨³å¥é•¿æŒ) + å«æ˜Ÿä»“(æ³¢æ®µè¿›æ”»)
const MODEL_PORTFOLIO = {
  core: {
    label:'ğŸ›¡ï¸ æ ¸å¿ƒä»“', ratio:'60%',
    desc:'å‹èˆ±çŸ³é…ç½®ï¼Œé•¿æœŸæŒæœ‰ä¸ºä¸»ï¼Œè¿½æ±‚ç¨³å¥æ”¶ç›Šã€‚å®½åŸº+é»„é‡‘+çº¢åˆ©ä¸‰è§’ç»„åˆï¼Œä½ç›¸å…³æ€§åˆ†æ•£é£é™©ã€‚',
    funds: [
      {code:'012414',name:'åå¤ä¸­è¯A500ETFè”æ¥A',type:'å®½åŸº',alloc:'20%',reason:'Aè‚¡æ ¸å¿ƒ500èµ„äº§ï¼Œé•¿æœŸé…ç½®åŸºçŸ³'},
      {code:'007339',name:'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥C',type:'å®½åŸº',alloc:'15%',reason:'æ²ªæ·±300æ ¸å¿ƒè“ç­¹ï¼Œè´¹ç‡ä½ï¼ŒæµåŠ¨æ€§å¥½'},
      {code:'000216',name:'åå®‰é»„é‡‘ETFè”æ¥A',type:'é»„é‡‘',alloc:'15%',reason:'é¿é™©+æŠ—é€šèƒ€ï¼Œä¸è‚¡å¸‚ä½ç›¸å…³ï¼Œå¤®è¡ŒæŒç»­è´­é‡‘'},
      {code:'012643',name:'å¤©å¼˜çº¢åˆ©ä½æ³¢åŠ¨C',type:'çº¢åˆ©',alloc:'10%',reason:'é«˜è‚¡æ¯ä½æ³¢åŠ¨ï¼Œä¸‹è¡Œä¿æŠ¤å¼ºï¼Œç¨³å®šåˆ†çº¢'},
    ]
  },
  satellite: {
    label:'ğŸš€ å«æ˜Ÿä»“', ratio:'40%',
    desc:'å¼¹æ€§è¿›æ”»ä»“ä½ï¼Œç§¯æåšæ³¢æ®µâ€”â€”é€¢è·Œä¹°å…¥ã€é€¢æ¶¨æ­¢ç›ˆã€‚å…³æ³¨è¶‹åŠ¿å‘ä¸Šä¸”çŸ­æœŸå›è°ƒçš„å“ç§ã€‚',
    funds: [
      {code:'014832',name:'å¤©å¼˜ä¸­è¯æœ‰è‰²é‡‘å±ETFè”æ¥C',type:'æœ‰è‰²é‡‘å±',alloc:'10%',reason:'å…¨çƒé“œé“æ¶¨ä»·+æ–°åŸºå»ºéœ€æ±‚ï¼Œæ³¢åŠ¨å¤§æ³¢æ®µç©ºé—´è¶³'},
      {code:'015047',name:'å¹¿å‘äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',alloc:'8%',reason:'AIäº§ä¸šçˆ†å‘ï¼Œç®—åŠ›éœ€æ±‚æ—ºç››ï¼Œæˆé•¿æ€§å¼º'},
      {code:'001156',name:'ç”³ä¸‡è±ä¿¡ä¸­è¯åŠå¯¼ä½“æŒ‡æ•°A',type:'åŠå¯¼ä½“',alloc:'8%',reason:'å›½äº§æ›¿ä»£é€»è¾‘ç¡¬ï¼Œä¼°å€¼å¼¹æ€§å¤§'},
      {code:'257070',name:'å›½æ³°ä¸­è¯å†›å·¥ETFè”æ¥A',type:'å†›å·¥',alloc:'7%',reason:'åœ°ç¼˜å‚¬åŒ–+è£…å¤‡é‡‡è´­å‘¨æœŸï¼Œäº‹ä»¶é©±åŠ¨å‹æ³¢æ®µ'},
      {code:'013308',name:'æ˜“æ–¹è¾¾ä¸­è¯å…¨æŒ‡è¯åˆ¸å…¬å¸C',type:'é‡‘è',alloc:'7%',reason:'ç‰›å¸‚å…ˆé”‹ï¼Œæ”¿ç­–å—ç›Šå¼¹æ€§å“ç§ï¼ŒÎ²å±æ€§å¼º'},
    ]
  }
};

const RECO_FUND_POOL = [
  {code:'002610',name:'åšæ—¶é»„é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['é¿é™©','è´µé‡‘å±']},
  {code:'007929',name:'åå®‰é»„é‡‘ETFè”æ¥C',type:'é»„é‡‘',tags:['é¿é™©','é»„é‡‘']},
  {code:'015047',name:'å¹¿å‘äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',tags:['AI','äº§ä¸šè¶‹åŠ¿']},
  {code:'017992',name:'æ˜“æ–¹è¾¾ä¸­è¯äººå·¥æ™ºèƒ½ETFè”æ¥C',type:'AI/ç§‘æŠ€',tags:['AI','ç®—åŠ›']},
  {code:'014557',name:'ä¸‡å®¶ä¸­è¯èŠ¯ç‰‡äº§ä¸šæŒ‡æ•°C',type:'åŠå¯¼ä½“',tags:['èŠ¯ç‰‡','å›½äº§æ›¿ä»£']},
  {code:'013313',name:'åå®ä¸­è¯ç§‘æŠ€é¾™å¤´ETFè”æ¥C',type:'ç§‘æŠ€',tags:['ç§‘æŠ€é¾™å¤´','ç¡¬ç§‘æŠ€']},
  {code:'012860',name:'é•¿åŸå†›å·¥æˆé•¿ETFè”æ¥C',type:'å†›å·¥',tags:['å›½é˜²å†›å·¥','æˆ˜ç•¥']},
  {code:'013010',name:'å¤©å¼˜ä¸­è¯æ–°èƒ½æºè½¦ETFè”æ¥C',type:'æ–°èƒ½æº',tags:['æ–°èƒ½æºè½¦','ç”µæ± ']},
  {code:'012762',name:'å¤©å¼˜ä¸­è¯é£Ÿå“é¥®æ–™ETFè”æ¥C',type:'æ¶ˆè´¹',tags:['é£Ÿå“é¥®æ–™','å†…éœ€']},
  {code:'001550',name:'å¤©å¼˜ä¸­è¯åŒ»è¯100A',type:'åŒ»è¯',tags:['åŒ»è¯','åˆ›æ–°è¯']},
  {code:'012643',name:'å¤©å¼˜çº¢åˆ©ä½æ³¢åŠ¨C',type:'çº¢åˆ©',tags:['çº¢åˆ©','ä½æ³¢åŠ¨']},
  {code:'012070',name:'ä¸‡å®¶ä¸­è¯çº¢åˆ©ETFè”æ¥C',type:'çº¢åˆ©',tags:['é«˜è‚¡æ¯','ç¨³å¥']},
  {code:'007339',name:'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥C',type:'å®½åŸº',tags:['æ²ªæ·±300','æ ¸å¿ƒèµ„äº§']},
  {code:'006881',name:'å¤©å¼˜åˆ›ä¸šæ¿ETFè”æ¥C',type:'å®½åŸº',tags:['åˆ›ä¸šæ¿','æˆé•¿']},
  {code:'013601',name:'åå®‰ä¸­è¯A500ETFè”æ¥C',type:'å®½åŸº',tags:['A500','æ ¸å¿ƒ']},
  {code:'014832',name:'å¤©å¼˜ä¸­è¯æœ‰è‰²é‡‘å±ETFè”æ¥C',type:'æœ‰è‰²é‡‘å±',tags:['æœ‰è‰²','é“œé“']},
  {code:'013308',name:'æ˜“æ–¹è¾¾ä¸­è¯å…¨æŒ‡è¯åˆ¸å…¬å¸C',type:'é‡‘è',tags:['åˆ¸å•†','æ”¿ç­–å—ç›Š']},
];

const INDICES_CONFIG = [
  {name:'ä¸Šè¯',secid:'1.000001',group:'stock'},
  {name:'æ·±æˆ',secid:'0.399001',group:'stock'},
  {name:'åˆ›ä¸šæ¿',secid:'0.399006',group:'stock'},
  {name:'æ²ªæ·±300',secid:'1.000300',group:'benchmark'},
  {name:'é»„é‡‘ETF',secid:'1.518880',group:'commodity'},
  {name:'ç™½é“¶LOF',secid:'0.161226',group:'commodity'},
  {name:'æœ‰è‰²é‡‘å±',secid:'1.000819',group:'commodity'},
];

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'ç¡…åŸºæµåŠ¨(å…è´¹)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    desc:'å…è´¹å¼€æºæ¨¡å‹ï¼Œæ³¨å†Œå³ç”¨',
    link:'https://cloud.siliconflow.cn',
    models: [
      {id:'engine1', name:'DeepSeek-V3', icon:'ğŸ«˜', role:'æŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'deepseek-ai/DeepSeek-V3'},
      {id:'engine2', name:'Qwen2.5-72B', icon:'ğŸ”®', role:'å®è§‚ç»æµ+æ”¿ç­–é¢', model:'Qwen/Qwen2.5-72B-Instruct'},
      {id:'engine3', name:'DeepSeek-R1-32B', icon:'ğŸ”', role:'æ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-ai/DeepSeek-R1-Distill-Qwen-32B'},
      {id:'engine4', name:'Gemma-2-27B', icon:'â™Š', role:'å…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'google/gemma-2-27b-it'},
    ]
  },
  {
    id:'deepseek', name:'DeepSeekå®˜æ–¹(æä½ä»·)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    desc:'Â¥1/ç™¾ä¸‡tokenï¼Œå‡ ä¹å…è´¹',
    link:'https://platform.deepseek.com',
    models: [
      {id:'engine1', name:'DeepSeek-V3â‘ ', icon:'ğŸ«˜', role:'æŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'deepseek-chat'},
      {id:'engine2', name:'DeepSeek-V3â‘¡', icon:'ğŸ”®', role:'å®è§‚ç»æµ+æ”¿ç­–é¢', model:'deepseek-chat'},
      {id:'engine3', name:'DeepSeek-R1', icon:'ğŸ”', role:'æ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-reasoner'},
      {id:'engine4', name:'DeepSeek-V3â‘¢', icon:'â™Š', role:'å…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'deepseek-chat'},
    ]
  },
  {
    id:'302ai', name:'302.AI(ä»˜è´¹)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    desc:'èšåˆå¹³å°ï¼Œæ”¯æŒå¤šç§æ¨¡å‹',
    link:'https://302.ai',
    models: [
      {id:'engine1', name:'è±†åŒ…', icon:'ğŸ«˜', role:'æŠ€æœ¯åˆ†æ+é‡åŒ–å› å­', model:'doubao-1.5-pro-32k'},
      {id:'engine2', name:'é€šä¹‰åƒé—®', icon:'ğŸ”®', role:'å®è§‚ç»æµ+æ”¿ç­–é¢', model:'qwen3-235b-a22b'},
      {id:'engine3', name:'DeepSeek', icon:'ğŸ”', role:'æ·±åº¦åŸºæœ¬é¢+è¡Œä¸šç ”ç©¶', model:'deepseek-r1'},
      {id:'engine4', name:'Gemini', icon:'â™Š', role:'å…¨çƒè§†è§’+é£é™©è¯„ä¼°', model:'gemini-2.5-flash'},
    ]
  }
];

let _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
let _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
let AI_ENGINES = _aiProvider.models;
let _apiBase = _aiProvider.base;

// ==================== STATE ====================
let holdings = JSON.parse(localStorage.getItem('fa_holdings')||'[]');
let watchlist = JSON.parse(localStorage.getItem('fa_watchlist')||'[]');
let liveIndices = {};
let liveFundData = {};
let liveSectors = [];
let fundHistoryData = {}; // { code: { navs: [{date,nav}], trend:{} } }
let _aiKey = localStorage.getItem('fa_302ai_key') || '';
let _analyzing = false;
let _analysisResult = null;
let _addMode = 'holding';
let _refreshTimer = null;
let _countdownTimer = null;
let dailyLog = JSON.parse(localStorage.getItem('fa_daily_log')||'[]'); // [{date, predictions:{code:{action,confidence,trend,reason}}, pnl:{code:pct}, avgPnl, hs300Pct}]
let simPortfolio = JSON.parse(localStorage.getItem('fa_sim_portfolio')||'null');
const SIM_INITIAL_CAPITAL = 500000;
const SIM_TARGET_MONTHLY = 10000;
const SIM_FEE_RATE = 0.0015;

// ==================== DATA INTELLIGENCE STATE ====================
let macroData = { cpi:null, ppi:null, pmi:null, gdp:null, m2:null }; // å®è§‚ç»æµæ•°æ®
let sectorCapFlow = []; // æ¿å—èµ„é‡‘æµå‘
let newsHeadlines = []; // è´¢ç»æ–°é—»
let newsSentiment = { score:50, label:'ä¸­æ€§', bullCount:0, bearCount:0 }; // èˆ†æƒ…ç»¼åˆå¾—åˆ†0-100
let _dataIntelLoaded = false;

// ==================== RL BRAIN STATE ====================
let rlAgent = null;
let rlTrainer = null;
let _rlModelLoaded = false;
let _rlTraining = false;
let _rlSignals = {}; // { code: { action, actionName, confidence, qValues } }
const RL_STATE_SIZE = 18; // 15â†’18: +backtestSharpe +backtestKelly +backtestRSI
const RL_ACTION_SIZE = 3; // 0=hold, 1=buy, 2=sell
const RL_ACTION_NAMES = ['æŒæœ‰','ä¹°å…¥','å–å‡º'];
const RL_STORAGE_KEY = 'fa_rl_brain';

// ==================== BACKTEST STATE ====================
let btResults = {}; // { code: { totalReturn, sharpe, maxDD, kellyFraction, winRate, trades, equity, drawdown } }
let btSummary = null;
let _btRunning = false;
const BT_STORAGE_KEY = 'fa_backtest';
const BT_FEE = 0.0015; // å•è¾¹æ‰‹ç»­è´¹
const BT_RSI_PERIOD = 14;
const BT_RSI_BUY = 70; // RSI<70æ—¶å…è®¸ä¹°å…¥
const BT_RSI_SELL = 75; // RSI>75è€ƒè™‘å–å‡º
const BT_MOMENTUM_BUY = 0.01; // é¢„æµ‹æ¶¨å¹…>1%ä¹°å…¥
const BT_RISK_FREE = 0.025; // å¹´åŒ–æ— é£é™©åˆ©ç‡

function saveHoldings(){ localStorage.setItem('fa_holdings', JSON.stringify(holdings)); }
function saveWatchlist(){ localStorage.setItem('fa_watchlist', JSON.stringify(watchlist)); }
function saveKey(k){ _aiKey=k; localStorage.setItem('fa_302ai_key', k); }
function saveDailyLog(){ localStorage.setItem('fa_daily_log', JSON.stringify(dailyLog.slice(-30))); } // æœ€å¤šä¿ç•™30å¤©
function saveProvider(id){
  _aiProviderId=id;
  _aiProvider=AI_PROVIDERS.find(p=>p.id===id)||AI_PROVIDERS[0];
  AI_ENGINES=_aiProvider.models;
  _apiBase=_aiProvider.base;
  localStorage.setItem('fa_ai_provider',id);
}

// ==================== UTILITIES ====================
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function sign(n){ return n>=0?'+':''; }
function fmt(n){ return (typeof n==='number')?n.toFixed(2):'--'; }
function seededRand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

// Aè‚¡èŠ‚å‡æ—¥ä¼‘å¸‚æ—¥å†(YYYY-MM-DD)
const CN_HOLIDAYS_2025 = ['2025-01-01','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-03','2025-02-04','2025-04-04','2025-05-01','2025-05-02','2025-05-05','2025-06-02','2025-10-01','2025-10-02','2025-10-03','2025-10-06','2025-10-07','2025-10-08'];
const CN_HOLIDAYS_2026 = ['2026-01-01','2026-01-02','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-23','2026-02-24','2026-04-06','2026-05-01','2026-05-04','2026-05-05','2026-06-01','2026-10-01','2026-10-02','2026-10-05','2026-10-06','2026-10-07','2026-10-08'];
const CN_HOLIDAYS = new Set([...CN_HOLIDAYS_2025, ...CN_HOLIDAYS_2026]);
// éƒ¨åˆ†å‘¨æœ«è°ƒä¼‘è¡¥ç­æ—¥
const CN_WORKDAYS = new Set(['2025-01-26','2025-02-08','2025-04-27','2025-09-28','2025-10-11','2026-02-14','2026-02-28','2026-10-10']);

function isTradingDay(dateStr){
  if(!dateStr) dateStr = todayStr();
  if(CN_HOLIDAYS.has(dateStr)) return false;
  if(CN_WORKDAYS.has(dateStr)) return true;
  const d = new Date(dateStr); const day = d.getDay();
  return day!==0 && day!==6;
}

function getMarketStatus(){
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const t = h*60+m;
  const today = todayStr();
  // èŠ‚å‡æ—¥
  if(CN_HOLIDAYS.has(today)) return {status:'closed', text:'èŠ‚å‡æ—¥ä¼‘å¸‚', countdown:null, isHoliday:true};
  // å‘¨æœ«(éè¡¥ç­)
  if((day===0||day===6) && !CN_WORKDAYS.has(today)) return {status:'closed', text:'å‘¨æœ«ä¼‘å¸‚', countdown:null};
  if(t<570) return {status:'pre', text:'æœªå¼€ç›˜', countdown:null};
  if(t>=570&&t<690) return {status:'open', text:'äº¤æ˜“ä¸­Â·ä¸Šåˆ', countdown:900-t};
  if(t>=690&&t<780) return {status:'break', text:'åˆé—´ä¼‘å¸‚', countdown:900-t};
  if(t>=780&&t<900) return {status:'open', text:'äº¤æ˜“ä¸­Â·ä¸‹åˆ', countdown:900-t};
  return {status:'closed', text:'å·²æ”¶ç›˜', countdown:null};
}

function formatCountdown(mins){
  if(mins===null||mins<=0) return '00:00';
  const h = Math.floor(mins/60);
  const m = mins%60;
  const now = new Date();
  const s = 59 - now.getSeconds();
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ==================== JSONP ENGINE ====================
let _jcnt=0;
function jsonpFetch(url, opts={}){
  return new Promise((resolve, reject)=>{
    const cbName = opts.fixedCb || `_jp${++_jcnt}_${Date.now()}`;
    const timeout = opts.timeout || 8000;
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
    function cleanup(){ clearTimeout(timer); if(!opts.fixedCb) delete window[cbName]; try{script.remove();}catch(e){} }
    window[cbName] = function(data){ cleanup(); resolve(data); };
    let finalUrl = url;
    if(!opts.fixedCb) finalUrl += (url.includes('?')?'&':'?') + `cb=${cbName}`;
    finalUrl += (finalUrl.includes('?')?'&':'?') + `_t=${Date.now()}`;
    script.src = finalUrl;
    script.onerror = ()=>{ cleanup(); reject(new Error('network')); };
    document.head.appendChild(script);
  });
}

// ==================== DATA FETCHING ====================
async function fetchIndices(){
  try{
    const secids = INDICES_CONFIG.map(i=>i.secid).join(',');
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=${secids}&fields=f2,f3,f4,f12,f13,f14`);
    if(data?.data?.diff){
      data.data.diff.forEach(d=>{
        const key=`${d.f13}.${d.f12}`;
        if(d.f2!=='-'&&!isNaN(d.f2)) liveIndices[key]={name:d.f14,price:d.f2,pct:d.f3,change:d.f4};
      });
    }
  }catch(e){ console.error('fetchIndices:', e); }
}

async function fetchSectors(){
  try{
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=20&po=1&np=1&fltt=2&invt=2&fid=f3&fs=m:90+t:2&fields=f3,f14`);
    if(data?.data?.diff){
      liveSectors = data.data.diff.map(d=>({name:d.f14,pct:d.f3})).filter(d=>!isNaN(d.pct)).sort((a,b)=>b.pct-a.pct);
    }
  }catch(e){}
}

// fundgz API å›ºå®šå›è°ƒå jsonpgzï¼Œä½†å“åº”åŒ…å« fundcode å­—æ®µï¼Œç”¨äºåŒ¹é…
const _fundEstimateWaiters = {}; // code -> {resolve, reject, timer, cleanup}
async function fetchFundEstimate(code){
  return new Promise((resolve, reject)=>{
    // å¦‚æœå·²æœ‰è¯¥ä»£ç çš„è¯·æ±‚ï¼Œå…ˆæ¸…ç†
    if(_fundEstimateWaiters[code]){
      clearTimeout(_fundEstimateWaiters[code].timer);
      _fundEstimateWaiters[code].reject(new Error('replaced'));
      delete _fundEstimateWaiters[code];
    }
    const script = document.createElement('script');
    script.referrerPolicy = 'no-referrer';
    const timer = setTimeout(()=>{
      cleanup();
      reject(new Error('timeout'));
    }, 8000);
    function cleanup(){
      clearTimeout(timer);
      delete _fundEstimateWaiters[code];
      try{ script.remove(); }catch(e){}
    }
    _fundEstimateWaiters[code] = { resolve, reject, timer, cleanup };
    script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
    script.onerror = ()=>{ cleanup(); reject(new Error('error')); };
    document.head.appendChild(script);
  });
}
// å…¨å±€å›è°ƒï¼šé€šè¿‡ fundcode åˆ†å‘ç»™å¯¹åº”çš„ waiter
window.jsonpgz = function(d){
  const code = d && d.fundcode;
  if(code && _fundEstimateWaiters[code]){
    const w = _fundEstimateWaiters[code];
    w.cleanup();
    w.resolve(d);
  }
};

function getAllPortfolioCodes(){
  const pCodes = [];
  MODEL_PORTFOLIO.core.funds.forEach(f=>pCodes.push(f.code));
  MODEL_PORTFOLIO.satellite.funds.forEach(f=>pCodes.push(f.code));
  // åŒ…å«æ¨¡æ‹Ÿç›˜æŒä»“ä»£ç ï¼Œç¡®ä¿è·å–çœŸå®å¸‚åœºæ•°æ®
  if(simPortfolio && simPortfolio.positions){
    simPortfolio.positions.forEach(p=>pCodes.push(p.code));
  }
  return [...new Set(pCodes)];
}

async function fetchAllFunds(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  // å¹¶è¡Œè¯·æ±‚ï¼ˆæ¯ä¸ªä»£ç é€šè¿‡ fundcode å­—æ®µåˆ†å‘ï¼Œä¸å†²çªï¼‰
  // åˆ†æ‰¹ï¼šæ¯æ‰¹5ä¸ªï¼Œé¿å…æµè§ˆå™¨å¹¶å‘é™åˆ¶
  for(let i=0; i<codes.length; i+=5){
    const batch = codes.slice(i, i+5);
    await Promise.allSettled(batch.map(async code=>{
      try{
        const d = await fetchFundEstimate(code);
        if(d?.gsz) liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name||'', gztime:d.gztime||'' };
      }catch(e){}
    }));
  }
}

// ==================== DATA INTELLIGENCE: MACRO + NEWS + SENTIMENT ====================
const MACRO_TOKEN = '894050c76af8597a853f5b408b759f5d';
const MACRO_BASE = 'https://datacenter.eastmoney.com/api/data/v1/get';

async function fetchMacroData(){
  const apis = [
    { key:'cpi', report:'RPT_ECONOMY_CPI', cols:'REPORT_DATE,TIME,NATIONAL_SAME,NATIONAL_SEQUENTIAL', sort:'REPORT_DATE', size:3 },
    { key:'ppi', report:'RPT_ECONOMY_PPI', cols:'REPORT_DATE,TIME,BASE_SAME,BASE_ACCUMULATE', sort:'REPORT_DATE', size:3 },
    { key:'pmi', report:'RPT_ECONOMY_PMI', cols:'REPORT_DATE,TIME,MAKE_INDEX,NMAKE_INDEX', sort:'REPORT_DATE', size:3 },
    { key:'gdp', report:'RPT_ECONOMY_GDP', cols:'REPORT_DATE,TIME,SUM_SAME,SECOND_SAME,THIRD_SAME', sort:'REPORT_DATE', size:2 },
    { key:'m2', report:'RPT_ECONOMY_CURRENCY_SUPPLY', cols:'REPORT_DATE,TIME,BASIC_CURRENCY,BASIC_CURRENCY_SAME,FREE_CASH_SAME', sort:'REPORT_DATE', size:3 },
  ];
  await Promise.allSettled(apis.map(async api=>{
    try{
      const url = `${MACRO_BASE}?reportName=${api.report}&columns=${api.cols}&pageSize=${api.size}&sortColumns=${api.sort}&sortTypes=-1&token=${MACRO_TOKEN}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if(json?.success && json?.result?.data){
        macroData[api.key] = json.result.data;
      }
    }catch(e){ console.warn('fetchMacro '+api.key+':', e); }
  }));
}

async function fetchSectorCapFlow(){
  try{
    // æ¿å—ä¸»åŠ›èµ„é‡‘æµå‘ top10
    const data = await jsonpFetch('https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=10&po=1&np=1&fltt=2&invt=2&fid=f62&fs=m:90+t:2&fields=f12,f14,f62,f184,f66,f69,f72,f75');
    if(data?.data?.diff){
      sectorCapFlow = data.data.diff.map(d=>({
        name: d.f14,
        mainNet: d.f62,           // ä¸»åŠ›å‡€æµå…¥(å…ƒ)
        mainNetPct: d.f184,       // ä¸»åŠ›å‡€æµå…¥å æ¯”%
        superBig: d.f66,          // è¶…å¤§å•å‡€æµå…¥
        big: d.f69,               // å¤§å•å‡€æµå…¥
        mid: d.f72,               // ä¸­å•å‡€æµå…¥
        small: d.f75,             // å°å•å‡€æµå…¥
      })).filter(d=>d.mainNet && d.mainNet!=='-');
    }
  }catch(e){ console.warn('fetchSectorCapFlow:', e); }
}

async function fetchNewsHeadlines(){
  try{
    // æ–°æµªè´¢ç»æ»šåŠ¨æ–°é—»
    const data = await jsonpFetch('https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&k=&num=15&page=1');
    if(data?.result?.data){
      newsHeadlines = data.result.data.map(d=>({
        title: d.title || '',
        time: d.ctime ? new Date(d.ctime*1000).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) : '',
        url: d.url || '',
        category: d.category || '',
      })).filter(n=>n.title);
      analyzeNewsSentiment();
    }
  }catch(e){
    console.warn('fetchNews:', e);
    // å¤‡ç”¨: å°è¯•ç›´æ¥fetch
    try{
      const resp = await fetch('https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&num=15&page=1');
      const data = await resp.json();
      if(data?.result?.data){
        newsHeadlines = data.result.data.map(d=>({
          title: d.title || '',
          time: d.ctime ? new Date(d.ctime*1000).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) : '',
          url: d.url || '',
        })).filter(n=>n.title);
        analyzeNewsSentiment();
      }
    }catch(e2){}
  }
}

function analyzeNewsSentiment(){
  // NLPæƒ…ç»ªåˆ†æ: åŸºäºå…³é”®è¯çš„è´¢ç»æ–°é—»æƒ…ç»ªåˆ¤æ–­
  const bullWords = ['ä¸Šæ¶¨','å¤§æ¶¨','æ¶¨åœ','é£™å‡','æ–°é«˜','çªç ´','åˆ©å¥½','å¢é•¿','å›å‡','å›æš–','åå¼¹','å¤è‹','è¶…é¢„æœŸ','ä¹è§‚','åŠ é€Ÿ','æ”¾é‡','å¼ºåŠ¿','ç‰›å¸‚','ææŒ¯','æ‰©å¼ ','ç§¯æ','å¥½è½¬','èµ°é«˜','æ”€å‡','ä¸Šæ‰¬','æš´æ¶¨','æ‹‰å‡','åˆ›æ–°é«˜'];
  const bearWords = ['ä¸‹è·Œ','å¤§è·Œ','è·Œåœ','æš´è·Œ','å´©','åˆ©ç©º','ä¸‹æ»‘','èç¼©','ä½è¿·','æ‚²è§‚','æ”¶ç´§','ç¼©é‡','å¼±åŠ¿','ç†Šå¸‚','æ¶åŒ–','è¡°é€€','ä¸‹è¡Œ','èµ°ä½','åˆ›æ–°ä½','ç ´ä½','æ€è·Œ','é‡æŒ«','æš´é›·','çˆ†ä»“','é£é™©','å±æœº','åˆ¶è£','åŠ æ¯','é€šèƒ€','ç´§ç¼©'];

  let bullCount = 0, bearCount = 0;
  newsHeadlines.forEach(n=>{
    const t = n.title;
    let bull = 0, bear = 0;
    bullWords.forEach(w=>{ if(t.includes(w)) bull++; });
    bearWords.forEach(w=>{ if(t.includes(w)) bear++; });
    if(bull > bear) { bullCount++; n.sentiment = 'bull'; }
    else if(bear > bull) { bearCount++; n.sentiment = 'bear'; }
    else { n.sentiment = 'neutral'; }
  });

  const total = newsHeadlines.length || 1;
  const score = Math.round(50 + (bullCount - bearCount) / total * 50);
  const clampedScore = Math.max(0, Math.min(100, score));
  let label = 'ä¸­æ€§';
  if(clampedScore >= 70) label = 'åä¹è§‚';
  else if(clampedScore >= 80) label = 'å¾ˆä¹è§‚';
  else if(clampedScore <= 30) label = 'åæ‚²è§‚';
  else if(clampedScore <= 20) label = 'å¾ˆæ‚²è§‚';
  else if(clampedScore >= 55) label = 'ç•¥åå¤š';
  else if(clampedScore <= 45) label = 'ç•¥åç©º';

  newsSentiment = { score:clampedScore, label, bullCount, bearCount, total };
}

function getMacroSummary(){
  // ç»¼åˆå®è§‚ä¿¡å·: æ‰©å¼ /æ”¶ç¼©/ä¸­æ€§
  let signals = [];
  if(macroData.pmi?.[0]){
    const pmi = macroData.pmi[0].MAKE_INDEX;
    signals.push({ name:'PMI', value:pmi, signal: pmi>=50?'æ‰©å¼ ':'æ”¶ç¼©', positive:pmi>=50 });
  }
  if(macroData.cpi?.[0]){
    const cpi = macroData.cpi[0].NATIONAL_SAME;
    signals.push({ name:'CPI', value:cpi+'%', signal: cpi>3?'é€šèƒ€å‹åŠ›':cpi<0?'é€šç¼©é£é™©':'æ¸©å’Œ', positive:cpi>=0&&cpi<=3 });
  }
  if(macroData.ppi?.[0]){
    const ppi = macroData.ppi[0].BASE_SAME;
    signals.push({ name:'PPI', value:ppi+'%', signal: ppi>0?'å·¥ä¸šå“æ¶¨ä»·':'å·¥ä¸šå“é™ä»·', positive:ppi>-1 });
  }
  if(macroData.m2?.[0]){
    const m2 = macroData.m2[0].BASIC_CURRENCY_SAME;
    signals.push({ name:'M2å¢é€Ÿ', value:m2+'%', signal: m2>10?'æµåŠ¨æ€§å®½æ¾':m2<8?'æµåŠ¨æ€§åç´§':'é€‚ä¸­', positive:m2>=8 });
  }
  if(macroData.gdp?.[0]){
    const gdp = macroData.gdp[0].SUM_SAME;
    signals.push({ name:'GDP', value:gdp+'%', signal: gdp>=5?'ç¨³å¥å¢é•¿':gdp>=4?'å¢é€Ÿæ”¾ç¼“':'å¢é€Ÿåä½', positive:gdp>=5 });
  }
  const positiveCount = signals.filter(s=>s.positive).length;
  const overallSignal = positiveCount >= 4 ? 'å®è§‚åæš–' : positiveCount >= 2 ? 'å®è§‚ä¸­æ€§' : 'å®è§‚åå†·';
  return { signals, overallSignal, positiveCount };
}

function getCapFlowSummary(){
  if(!sectorCapFlow.length) return { topInflow:[], topOutflow:[], netTotal:0 };
  const sorted = [...sectorCapFlow].sort((a,b)=>(b.mainNet||0)-(a.mainNet||0));
  const topInflow = sorted.filter(s=>s.mainNet>0).slice(0,5);
  const topOutflow = sorted.filter(s=>s.mainNet<0).slice(-5).reverse();
  const netTotal = sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0),0);
  return { topInflow, topOutflow, netTotal };
}

async function fetchAllDataIntel(){
  await Promise.allSettled([
    fetchMacroData(),
    fetchSectorCapFlow(),
    fetchNewsHeadlines(),
  ]);
  _dataIntelLoaded = true;
  renderDataIntelBrief();
}

// ==================== RL BRAIN: DEEP Q-NETWORK ====================
// çº¯JavaScriptå®ç°çš„å¼ºåŒ–å­¦ä¹ äº¤æ˜“å¤§è„‘ï¼Œæ— å¤–éƒ¨ä¾èµ–
// ç®—æ³•: Double DQN + Experience Replay + Target Network + Adam Optimizer
// çŠ¶æ€ç©ºé—´: 15ç»´ (åŠ¨é‡Ã—4 + æ³¢åŠ¨ç‡Ã—2 + RSI + MACD + MA + å›æ’¤ + æŒä»“ + PnL + å®è§‚ + èˆ†æƒ… + èµ„é‡‘)
// åŠ¨ä½œç©ºé—´: 3 (æŒæœ‰/ä¹°å…¥/å–å‡º)
// å¥–åŠ±è®¾è®¡: èµ„äº§å¢å€¼(+) Â· äºæŸ(-) Â· å›æ’¤æƒ©ç½š(-) Â· è¿‡åº¦äº¤æ˜“(-)

// --- Math Utilities ---
function rlRand(scale){
  const u1=Math.random(),u2=Math.random();
  return Math.sqrt(-2*Math.log(u1||1e-10))*Math.cos(2*Math.PI*u2)*scale;
}
function rlClip(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function rlArgmax(arr){let m=0;for(let i=1;i<arr.length;i++)if(arr[i]>arr[m])m=i;return m;}
function rlSoftmax(arr){
  const mx=Math.max(...arr);
  const ex=arr.map(v=>Math.exp(v-mx));
  const s=ex.reduce((a,b)=>a+b,0);
  return ex.map(v=>v/s);
}

// --- Neural Network (Adam Optimizer, He Init, Huber Loss) ---
class RLNetwork{
  constructor(sizes){
    this.sizes=sizes;
    this.nL=sizes.length-1;
    this.W=[];this.b=[];
    this.mW=[];this.vW=[];this.mb=[];this.vb=[];
    this.t=0;
    for(let i=0;i<this.nL;i++){
      const inS=sizes[i],outS=sizes[i+1];
      const scale=Math.sqrt(2.0/inS);
      const w=new Float32Array(outS*inS);
      for(let k=0;k<w.length;k++)w[k]=rlRand(scale);
      this.W.push(w);
      this.b.push(new Float32Array(outS));
      this.mW.push(new Float32Array(outS*inS));
      this.vW.push(new Float32Array(outS*inS));
      this.mb.push(new Float32Array(outS));
      this.vb.push(new Float32Array(outS));
    }
  }
  forward(input){
    let a=Float32Array.from(input);
    this._c=[{a}];
    for(let i=0;i<this.nL;i++){
      const inS=this.sizes[i],outS=this.sizes[i+1];
      const z=new Float32Array(outS);
      for(let r=0;r<outS;r++){
        let s=this.b[i][r];
        const off=r*inS;
        for(let c=0;c<inS;c++)s+=this.W[i][off+c]*a[c];
        z[r]=s;
      }
      if(i<this.nL-1){
        a=new Float32Array(outS);
        for(let r=0;r<outS;r++)a[r]=z[r]>0?z[r]:0; // ReLU
      } else {
        a=z; // linear output
      }
      this._c.push({z,a});
    }
    return a;
  }
  trainStep(input,target,lr){
    const out=this.forward(input);
    const n=out.length;
    let loss=0;
    let dA=new Float32Array(n);
    for(let i=0;i<n;i++){
      const d=out[i]-target[i];
      if(Math.abs(d)<1){loss+=0.5*d*d;dA[i]=d;} // Huber loss
      else{loss+=Math.abs(d)-0.5;dA[i]=d>0?1:-1;}
    }
    this.t++;
    const b1=0.9,b2=0.999,eps=1e-8;
    for(let l=this.nL-1;l>=0;l--){
      const inS=this.sizes[l],outS=this.sizes[l+1];
      const aIn=this._c[l].a;
      // ReLU gradient for hidden layers
      if(l<this.nL-1){
        const z=this._c[l+1].z;
        for(let i=0;i<outS;i++)if(z[i]<=0)dA[i]=0;
      }
      // Weight gradients + Adam update
      for(let i=0;i<outS;i++){
        const off=i*inS;
        for(let j=0;j<inS;j++){
          const g=dA[i]*aIn[j];
          const k=off+j;
          this.mW[l][k]=b1*this.mW[l][k]+(1-b1)*g;
          this.vW[l][k]=b2*this.vW[l][k]+(1-b2)*g*g;
          const mh=this.mW[l][k]/(1-Math.pow(b1,this.t));
          const vh=this.vW[l][k]/(1-Math.pow(b2,this.t));
          this.W[l][k]-=lr*mh/(Math.sqrt(vh)+eps);
        }
        // Bias Adam
        this.mb[l][i]=b1*this.mb[l][i]+(1-b1)*dA[i];
        this.vb[l][i]=b2*this.vb[l][i]+(1-b2)*dA[i]*dA[i];
        const mbh=this.mb[l][i]/(1-Math.pow(b1,this.t));
        const vbh=this.vb[l][i]/(1-Math.pow(b2,this.t));
        this.b[l][i]-=lr*mbh/(Math.sqrt(vbh)+eps);
      }
      // Propagate gradient
      if(l>0){
        const dAPrev=new Float32Array(inS);
        for(let j=0;j<inS;j++){
          let s=0;
          for(let i=0;i<outS;i++)s+=this.W[l][i*inS+j]*dA[i];
          dAPrev[j]=s;
        }
        dA=dAPrev;
      }
    }
    return loss;
  }
  clone(){
    const net=new RLNetwork(this.sizes);
    for(let i=0;i<this.nL;i++){
      net.W[i]=new Float32Array(this.W[i]);
      net.b[i]=new Float32Array(this.b[i]);
    }
    return net;
  }
  toJSON(){
    return{sizes:this.sizes,W:this.W.map(w=>Array.from(w)),b:this.b.map(b=>Array.from(b)),t:this.t};
  }
  static fromJSON(d){
    const net=new RLNetwork(d.sizes);
    for(let i=0;i<net.nL;i++){
      net.W[i]=Float32Array.from(d.W[i]);
      net.b[i]=Float32Array.from(d.b[i]);
    }
    net.t=d.t||0;
    return net;
  }
}

// --- DQN Agent (Double DQN) ---
class DQNAgent{
  constructor(stateSize,actionSize){
    this.stateSize=stateSize;
    this.actionSize=actionSize;
    this.qNet=new RLNetwork([stateSize,64,32,actionSize]);
    this.targetNet=this.qNet.clone();
    this.memory=[];
    this.maxMemory=10000;
    this.batchSize=32;
    this.gamma=0.99;
    this.epsilon=1.0;
    this.epsilonMin=0.02;
    this.epsilonDecay=0.998;
    this.lr=0.001;
    this.targetUpdateFreq=200;
    this.trainSteps=0;
    this.totalReward=0;
  }
  act(state,explore=true){
    if(explore&&Math.random()<this.epsilon)return Math.floor(Math.random()*this.actionSize);
    return rlArgmax(this.qNet.forward(state));
  }
  getQValues(state){return this.qNet.forward(state);}
  remember(s,a,r,s2,done){
    if(this.memory.length>=this.maxMemory)this.memory.shift();
    this.memory.push({s,a,r,s2,done});
  }
  replay(){
    if(this.memory.length<this.batchSize*2)return 0;
    let totalLoss=0;
    for(let i=0;i<this.batchSize;i++){
      const exp=this.memory[Math.floor(Math.random()*this.memory.length)];
      const q=this.qNet.forward(exp.s);
      const target=Float32Array.from(q);
      if(exp.done){
        target[exp.a]=exp.r;
      }else{
        // Double DQN: online selects action, target evaluates
        const bestA=rlArgmax(this.qNet.forward(exp.s2));
        const nextQ=this.targetNet.forward(exp.s2);
        target[exp.a]=exp.r+this.gamma*nextQ[bestA];
      }
      totalLoss+=this.qNet.trainStep(exp.s,target,this.lr);
    }
    this.trainSteps++;
    if(this.trainSteps%this.targetUpdateFreq===0)this.targetNet=this.qNet.clone();
    if(this.epsilon>this.epsilonMin)this.epsilon*=this.epsilonDecay;
    return totalLoss/this.batchSize;
  }
  toJSON(){
    return{qNet:this.qNet.toJSON(),epsilon:this.epsilon,trainSteps:this.trainSteps,totalReward:this.totalReward};
  }
  static fromJSON(d){
    const a=new DQNAgent(d.qNet.sizes[0],d.qNet.sizes[d.qNet.sizes.length-1]);
    a.qNet=RLNetwork.fromJSON(d.qNet);
    a.targetNet=a.qNet.clone();
    a.epsilon=d.epsilon||0.02;
    a.trainSteps=d.trainSteps||0;
    a.totalReward=d.totalReward||0;
    return a;
  }
}

// --- Market Environment (Gym-style) ---
class MarketEnv{
  constructor(navArray, code){
    this.navs=navArray; // [{date,nav},...] sorted by date
    this._code=code||''; // fund code for backtest data lookup
    this.lookback=20;
    this.fee=0.0015;
  }
  reset(){
    this.idx=this.lookback;
    this.pos=0; // 0=cash,1=long
    this.entryPrice=0;
    this.portfolio=1.0;
    this.peakPf=1.0;
    this.trades=0;
    return this._state();
  }
  _state(){
    const p=[];
    for(let i=this.idx-this.lookback;i<=this.idx;i++)p.push(this.navs[i].nav);
    const cur=p[p.length-1];
    const n=p.length;
    const rets=[];
    for(let i=1;i<n;i++)rets.push((p[i]-p[i-1])/p[i-1]);
    const ret1=rets[rets.length-1]||0;
    const sum=(a,k)=>{const sl=a.slice(-k);return sl.reduce((s,v)=>s+v,0);};
    const std=(a)=>{if(a.length<2)return 0;const m=a.reduce((s,v)=>s+v,0)/a.length;return Math.sqrt(a.reduce((s,v)=>s+(v-m)**2,0)/a.length);};
    const rsiCalc=(a)=>{let g=0,l=0;a.forEach(r=>{if(r>0)g+=r;else l+=Math.abs(r);});if(!l)return 100;if(!g)return 0;return 100-100/(1+g/l);};
    const ema=(arr,period)=>{const k=2/(period+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;};
    const ma=(arr,k)=>arr.slice(-k).reduce((s,v)=>s+v,0)/Math.min(arr.length,k);
    const rsi=rsiCalc(rets.slice(-14));
    const ema12=ema(p,12),ema26=ema(p,26);
    const macd=(ema12-ema26)/cur;
    const ma20=ma(p,20);
    const maPos=(cur-ma20)/ma20;
    const maxP=Math.max(...p.slice(-20));
    const dd=(cur-maxP)/maxP;
    const pnl=this.pos===1?(cur-this.entryPrice)/this.entryPrice:0;
    // ä»å›æµ‹ç»“æœæ³¨å…¥å†å²ç­–ç•¥ç‰¹å¾
    const btR = typeof btResults!=='undefined' ? btResults[this._code] : null;
    const btSharpe = btR ? btR.sharpe : 0;
    const btKelly = btR ? btR.finalKelly : 0.05;
    const btRSI = btR?.lastRSI || 50;
    return Float32Array.from([
      rlClip(ret1*100,-5,5),
      rlClip(sum(rets,5)*100,-15,15),
      rlClip(sum(rets,10)*100,-25,25),
      rlClip(sum(rets,20)*100,-40,40),
      rlClip(std(rets.slice(-5))*100,0,10),
      rlClip(std(rets.slice(-20))*100,0,10),
      (rsi-50)/50,
      rlClip(macd*100,-5,5),
      rlClip(maPos*10,-3,3),
      rlClip(dd*10,-5,0),
      this.pos,
      rlClip(pnl*10,-5,5),
      0,0,0, // macro/sentiment/capflow filled at inference
      rlClip(btSharpe,-2,3),       // [15] å›æµ‹Sharpe
      rlClip(btKelly*10,-1,3),     // [16] å›æµ‹Kellyä»“ä½
      (btRSI-50)/50                // [17] å›æµ‹å½“å‰RSI
    ]);
  }
  step(action){
    const prev=this.navs[this.idx].nav;
    this.idx++;
    const done=this.idx>=this.navs.length-1;
    const cur=this.navs[this.idx].nav;
    const dr=(cur-prev)/prev;
    let reward=0;
    if(action===1&&this.pos===0){
      this.pos=1;this.entryPrice=cur;
      this.portfolio*=(1-this.fee);this.trades++;
      reward=-0.001;
    }else if(action===2&&this.pos===1){
      const pnl=(cur-this.entryPrice)/this.entryPrice;
      this.portfolio*=(1+pnl)*(1-this.fee);
      this.pos=0;this.entryPrice=0;this.trades++;
      reward=pnl*10;
    }else if(action===1&&this.pos===1){
      reward=dr*5; // already long, hold
    }else if(action===2&&this.pos===0){
      reward=-dr*2; // no position, can't sell
    }else if(this.pos===1){
      reward=dr*5; // holding
    }else{
      reward=dr<0?Math.abs(dr)*2:-dr*1; // cash
    }
    this.peakPf=Math.max(this.peakPf,this.portfolio);
    const mdd=(this.portfolio-this.peakPf)/this.peakPf;
    if(mdd<-0.05)reward-=0.05;
    if(mdd<-0.10)reward-=0.1;
    const tradeRate=this.trades/(this.idx-this.lookback+1);
    if(tradeRate>0.3)reward-=0.02;
    return{state:this._state(),reward,done};
  }
}

// --- RL Training Pipeline ---
class RLTrainer{
  constructor(){
    this.agent=null;
    this.isTraining=false;
    this.episode=0;
    this.maxEpisodes=50;
    this.metrics={rewards:[],losses:[],portfolios:[],winRate:0,avgReturn:0,sharpe:0,bestReturn:-Infinity,totalTrades:0};
    this._data=[];
  }
  prepare(){
    this._data=[];
    for(const code of Object.keys(fundHistoryData)){
      const hd=fundHistoryData[code];
      if(!hd||!hd.navs||hd.navs.length<60)continue;
      const navArr=hd.navs.map(n=>({date:n[0],nav:parseFloat(n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length>=60)this._data.push({code,navs:navArr});
    }
    this.agent=new DQNAgent(RL_STATE_SIZE,RL_ACTION_SIZE);
    this.metrics={rewards:[],losses:[],portfolios:[],winRate:0,avgReturn:0,sharpe:0,bestReturn:-Infinity,totalTrades:0};
    this.episode=0;
    return this._data.length;
  }
  async train(onProgress){
    if(!this._data.length)return;
    this.isTraining=true;
    for(let ep=0;ep<this.maxEpisodes&&this.isTraining;ep++){
      this.episode=ep;
      let epR=0,epL=0,epSteps=0,epPfs=[],epTrades=0;
      const shuffled=[...this._data].sort(()=>Math.random()-0.5);
      for(const{code,navs}of shuffled){
        const env=new MarketEnv(navs,code);
        let state=env.reset(),done=false;
        while(!done){
          const action=this.agent.act(state,true);
          const r=env.step(action);
          this.agent.remember(state,action,r.reward,r.state,r.done);
          state=r.state;done=r.done;
          epR+=r.reward;epSteps++;
          if(epSteps%4===0&&this.agent.memory.length>=this.agent.batchSize*2){
            epL+=this.agent.replay();
          }
        }
        epPfs.push(env.portfolio);
        epTrades+=env.trades;
      }
      const avgPf=epPfs.reduce((s,v)=>s+v,0)/epPfs.length;
      const avgRet=(avgPf-1)*100;
      const wr=epPfs.filter(p=>p>1).length/epPfs.length*100;
      this.metrics.rewards.push(epR/Math.max(1,epSteps));
      this.metrics.losses.push(epL/Math.max(1,Math.floor(epSteps/4)));
      this.metrics.portfolios.push(avgRet);
      this.metrics.winRate=wr;
      this.metrics.avgReturn=avgRet;
      this.metrics.totalTrades=epTrades;
      if(avgRet>this.metrics.bestReturn)this.metrics.bestReturn=avgRet;
      const rc=this.metrics.portfolios.slice(-10);
      if(rc.length>=3){
        const mu=rc.reduce((s,v)=>s+v,0)/rc.length;
        const sd=Math.sqrt(rc.reduce((s,v)=>s+(v-mu)**2,0)/rc.length);
        this.metrics.sharpe=sd>0?mu/sd:0;
      }
      if(onProgress)onProgress(ep+1,this.maxEpisodes,this.metrics);
      if(ep%2===0)await new Promise(r=>setTimeout(r,0));
    }
    this.isTraining=false;
    this.agent.totalReward=this.metrics.rewards.reduce((s,v)=>s+v,0);
    this.saveModel();
    return this.metrics;
  }
  stop(){this.isTraining=false;}
  generateSignals(){
    if(!this.agent)return{};
    const signals={};
    const codes=[...holdings.map(h=>h.code),...watchlist.map(w=>w.code)];
    for(const code of codes){
      const hd=fundHistoryData[code];
      if(!hd||!hd.navs||hd.navs.length<25)continue;
      const navArr=hd.navs.map(n=>({date:n[0],nav:parseFloat(n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length<25)continue;
      const env=new MarketEnv(navArr,code);
      env.idx=navArr.length-1;
      const simPos=simPortfolio?.positions?.find(p=>p.code===code);
      env.pos=simPos?1:0;
      if(simPos)env.entryPrice=simPos.avgCost;
      const state=env._state();
      // Inject live macro/sentiment/capital signals
      if(_dataIntelLoaded){
        const ds=generateDataSignal();
        state[12]=rlClip((ds.score-50)/25,-2,2);
        state[13]=rlClip((newsSentiment.score-50)/25,-2,2);
        const cn=sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0),0);
        state[14]=rlClip(cn/1e10,-2,2);
      }
      const q=this.agent.getQValues(state);
      const action=rlArgmax(q);
      const probs=rlSoftmax(Array.from(q));
      signals[code]={
        action,
        actionName:RL_ACTION_NAMES[action],
        confidence:Math.round(probs[action]*100),
        qValues:Array.from(q),
        probabilities:probs
      };
    }
    _rlSignals=signals;
    return signals;
  }
  saveModel(){
    if(!this.agent)return;
    try{
      localStorage.setItem(RL_STORAGE_KEY,JSON.stringify({
        agent:this.agent.toJSON(),
        metrics:this.metrics,
        episode:this.episode,
        timestamp:Date.now()
      }));
      _rlModelLoaded=true;
      console.log('RLæ¨¡å‹å·²ä¿å­˜, è®­ç»ƒæ­¥æ•°:',this.agent.trainSteps);
    }catch(e){console.warn('RLæ¨¡å‹ä¿å­˜å¤±è´¥:',e);}
  }
  loadModel(){
    try{
      const raw=localStorage.getItem(RL_STORAGE_KEY);
      if(!raw)return false;
      const d=JSON.parse(raw);
      // æ£€æŸ¥æ¨¡å‹ç»´åº¦æ˜¯å¦åŒ¹é…(15â†’18è¿ç§»å…¼å®¹)
      const savedSize = d.agent?.qNet?.sizes?.[0] || 0;
      if(savedSize !== RL_STATE_SIZE){
        console.warn(`RLæ¨¡å‹ç»´åº¦ä¸åŒ¹é…(ä¿å­˜:${savedSize} å½“å‰:${RL_STATE_SIZE})ï¼Œéœ€é‡æ–°è®­ç»ƒ`);
        localStorage.removeItem(RL_STORAGE_KEY);
        return false;
      }
      this.agent=DQNAgent.fromJSON(d.agent);
      this.metrics=d.metrics||this.metrics;
      this.episode=d.episode||0;
      _rlModelLoaded=true;
      console.log('RLæ¨¡å‹å·²åŠ è½½, è®­ç»ƒæ­¥æ•°:',this.agent.trainSteps);
      return true;
    }catch(e){console.warn('RLæ¨¡å‹åŠ è½½å¤±è´¥:',e);return false;}
  }
}

// ==================== HISTORICAL DATA & TREND ANALYSIS ====================
async function fetchFundHistory(code){
  // è·å–åŸºé‡‘å†å²å‡€å€¼ï¼ˆè¿‘1å¹´ï¼Œçº¦250ä¸ªäº¤æ˜“æ—¥ï¼‰
  try{
    const url = `https://api.fund.eastmoney.com/f10/lsjz?fundCode=${code}&pageIndex=1&pageSize=250`;
    const resp = await fetch(url, {headers:{'Referer':'https://fundf10.eastmoney.com/'}});
    if(!resp.ok) throw new Error('fetch fail');
    const json = await resp.json();
    if(json?.Data?.LSJZList){
      const navs = json.Data.LSJZList
        .map(d=>({date:d.FSRQ, nav:parseFloat(d.DWJZ)}))
        .filter(d=>!isNaN(d.nav))
        .reverse(); // æœ€æ—©åœ¨å‰
      return navs;
    }
  }catch(e){
    // å¤‡ç”¨JSONPæ–¹å¼
    try{
      const data = await jsonpFetch(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${getSecidForFund(code)}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=1&beg=0&end=20500101&lmt=250`);
      if(data?.data?.klines){
        return data.data.klines.map(k=>{
          const parts=k.split(',');
          return {date:parts[0], nav:parseFloat(parts[1])};
        }).filter(d=>!isNaN(d.nav));
      }
    }catch(e2){}
  }
  return null;
}

function getSecidForFund(code){
  // åŸºé‡‘ä»£ç æ˜ å°„åˆ°secidï¼ˆä¸Šäº¤æ‰€1.xxxï¼Œæ·±äº¤æ‰€0.xxxï¼‰
  const first = code.charAt(0);
  if(first==='5'||first==='6') return `1.${code}`;
  return `0.${code}`;
}

function analyzeTrend(navs){
  if(!navs || navs.length < 10) return null;

  const len = navs.length;
  const latest = navs[len-1].nav;
  const prices = navs.map(n=>n.nav);

  // å„å‘¨æœŸæ¶¨è·Œå¹…
  const pct = (cur,prev) => prev>0 ? ((cur-prev)/prev*100) : 0;
  const chg5d = len>5 ? pct(latest, prices[len-6]) : 0;    // è¿‘5æ—¥
  const chg20d = len>20 ? pct(latest, prices[len-21]) : 0;  // è¿‘1æœˆ
  const chg60d = len>60 ? pct(latest, prices[len-61]) : 0;  // è¿‘3æœˆ
  const chg120d = len>120 ? pct(latest, prices[len-121]) : 0; // è¿‘6æœˆ
  const chg250d = len>240 ? pct(latest, prices[0]) : 0;      // è¿‘1å¹´

  // å‡çº¿
  const ma = (n) => {
    if(len<n) return latest;
    let sum=0; for(let i=len-n;i<len;i++) sum+=prices[i];
    return sum/n;
  };
  const ma5 = ma(5), ma20 = ma(20), ma60 = ma(60);

  // è¿‘1å¹´æœ€é«˜/æœ€ä½
  const high1y = Math.max(...prices);
  const low1y = Math.min(...prices);
  const drawdownFromHigh = pct(latest, high1y); // è·é«˜ç‚¹å›æ’¤(è´Ÿæ•°)
  const reboundFromLow = pct(latest, low1y);     // è·ä½ç‚¹åå¼¹

  // è¶‹åŠ¿åˆ¤æ–­
  let trendDir = 'sideways';
  let trendScore = 0; // -100~100

  // å‡çº¿å¤šå¤´æ’åˆ—: ma5>ma20>ma60 â†’ å¼ºä¸Šå‡
  if(ma5>ma20 && ma20>ma60) trendScore += 30;
  else if(ma5<ma20 && ma20<ma60) trendScore -= 30;

  // ä¸­æœŸæ¶¨å¹…
  if(chg60d > 8) trendScore += 25;
  else if(chg60d > 3) trendScore += 15;
  else if(chg60d < -8) trendScore -= 25;
  else if(chg60d < -3) trendScore -= 15;

  // é•¿æœŸè¶‹åŠ¿
  if(chg250d > 15) trendScore += 20;
  else if(chg250d > 5) trendScore += 10;
  else if(chg250d < -15) trendScore -= 20;
  else if(chg250d < -5) trendScore -= 10;

  // ä»·æ ¼ä½ç½®
  if(latest > ma20 && latest > ma60) trendScore += 10;
  else if(latest < ma20 && latest < ma60) trendScore -= 10;

  if(trendScore >= 25) trendDir = 'strong_up';
  else if(trendScore >= 10) trendDir = 'up';
  else if(trendScore <= -25) trendDir = 'strong_down';
  else if(trendScore <= -10) trendDir = 'down';

  // æ³¢æ®µä½ç½®åˆ¤æ–­
  let swingPos = 'mid'; // å½“å‰å¤„äºæ³¢æ®µçš„ä»€ä¹ˆä½ç½®
  if(chg5d <= -3) swingPos = 'deep_dip';      // 5æ—¥æš´è·Œâ€”â€”æ·±åº¦å›è°ƒ
  else if(chg5d <= -1.5) swingPos = 'dip';     // 5æ—¥ä¸‹è·Œâ€”â€”å›è°ƒä¸­
  else if(chg5d >= 3) swingPos = 'surge';       // 5æ—¥æš´æ¶¨â€”â€”å†²é«˜
  else if(chg5d >= 1.5) swingPos = 'rally';     // 5æ—¥ä¸Šæ¶¨â€”â€”åå¼¹ä¸­

  // æ³¢æ®µå»ºè®®
  let swingAdvice = '';
  if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸Š+çŸ­æœŸå›è°ƒï¼Œæ³¢æ®µä¹°å…¥æœºä¼šï¼';
  } else if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸Š+çŸ­æœŸå†²é«˜ï¼Œå¯è€ƒè™‘éƒ¨åˆ†æ­¢ç›ˆ';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸‹+çŸ­æœŸåå¼¹ï¼Œå»ºè®®é€¢é«˜å‡ä»“';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = 'è¶‹åŠ¿å‘ä¸‹+ç»§ç»­ä¸‹è·Œï¼Œä¸å»ºè®®æŠ„åº•';
  } else if(trendDir==='sideways'){
    swingAdvice = 'éœ‡è¡æ ¼å±€ï¼Œç­‰å¾…æ–¹å‘æ˜ç¡®';
  }

  return {
    chg5d: +chg5d.toFixed(2),
    chg20d: +chg20d.toFixed(2),
    chg60d: +chg60d.toFixed(2),
    chg120d: +chg120d.toFixed(2),
    chg250d: +chg250d.toFixed(2),
    ma5: +ma5.toFixed(4), ma20: +ma20.toFixed(4), ma60: +ma60.toFixed(4),
    latest: +latest.toFixed(4),
    high1y: +high1y.toFixed(4), low1y: +low1y.toFixed(4),
    drawdownFromHigh: +drawdownFromHigh.toFixed(2),
    reboundFromLow: +reboundFromLow.toFixed(2),
    trendDir, trendScore, swingPos, swingAdvice,
    dataPoints: len
  };
}

async function fetchAllHistory(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  for(const code of codes){
    const navs = await fetchFundHistory(code);
    if(navs && navs.length>0){
      const trend = analyzeTrend(navs);
      fundHistoryData[code] = { navs, trend };
    }
    await new Promise(r=>setTimeout(r,200));
  }
}

function getFundData(code){
  if(liveFundData[code]) return {...liveFundData[code], _live:true};
  // å°è¯•ä»å†å²æ•°æ®å–æœ€æ–°çœŸå®å‡€å€¼
  const hd = fundHistoryData[code];
  if(hd && hd.navs && hd.navs.length>0){
    const latest = hd.navs[hd.navs.length-1];
    const prev = hd.navs.length>1 ? hd.navs[hd.navs.length-2] : latest;
    const pct = prev.nav>0 ? (latest.nav-prev.nav)/prev.nav*100 : 0;
    const nm = FUND_DB.find(x=>x.code===code)?.name || RECO_FUND_POOL.find(x=>x.code===code)?.name || code;
    return {gsz:latest.nav, dwjz:latest.nav, gszzl:+pct.toFixed(2), name:nm, gztime:latest.date, _live:false, _histFallback:true};
  }
  const f = FUND_DB.find(x=>x.code===code);
  const r = RECO_FUND_POOL.find(x=>x.code===code);
  const seed = parseInt(todayStr().replace(/-/g,''))+parseInt(code);
  const pct = (seededRand(seed)-0.46)*4;
  const dwjz = (f?f.baseNav:1)*(1+(seededRand(seed+100)-0.5)*0.3);
  const nm = f?f.name : r?r.name : code;
  return {gsz:dwjz*(1+pct/100), dwjz, gszzl:pct, name:nm, gztime:todayStr()+' 15:00', _live:false};
}

function getIndexData(cfg){
  if(liveIndices[cfg.secid]) return liveIndices[cfg.secid];
  const base={'1.000001':3340,'0.399001':10420,'0.399006':2110,'1.000300':4000,'1.518880':7.5,'0.161226':1.45,'1.000819':5200}[cfg.secid]||3000;
  const seed = parseInt(todayStr().replace(/-/g,''))+(cfg.secid.charCodeAt(2)||0)*137;
  const pct=(seededRand(seed)-0.46)*3;
  return {name:cfg.name, price:(base*(1+pct/100)).toFixed(2), pct:pct, change:(base*pct/100).toFixed(2)};
}

function fundName(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  const live = liveFundData[code];
  return info?.name || reco?.name || live?.name || h?.name || w?.name || code;
}

function fundType(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  return info?.type || reco?.type || h?.type || w?.type || '';
}

// ==================== AI ENGINE ====================
async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_aiKey) throw new Error('è¯·å…ˆé…ç½®API Key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:4096
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildContext(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const shData = getIndexData(INDICES_CONFIG[0]);
  const szData = getIndexData(INDICES_CONFIG[1]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const auData = getIndexData(INDICES_CONFIG[4]);
  const agData = getIndexData(INDICES_CONFIG[5]);
  const ysData = getIndexData(INDICES_CONFIG[6]);
  const topUp = liveSectors.filter(s=>s.pct>0).slice(0,6);
  const topDown = liveSectors.filter(s=>s.pct<0).slice(-4).reverse();

  let ctx = `å½“å‰æ—¥æœŸ: ${todayStr()}\n`;
  ctx += `ç”¨æˆ·ç›®æ ‡ï¼š3ä¸ªæœˆå†…ç¨³å¥å¢é•¿ï¼Œè·‘èµ¢æ²ªæ·±300æŒ‡æ•°\n\n`;
  ctx += `ã€å¤§ç›˜æŒ‡æ•°ã€‘\n`;
  ctx += `ä¸Šè¯æŒ‡æ•°: ${shData.price} (${sign(shData.pct)}${fmt(shData.pct)}%)\n`;
  ctx += `æ·±è¯æˆæŒ‡: ${szData.price} (${sign(szData.pct)}${fmt(szData.pct)}%)\n`;
  ctx += `åˆ›ä¸šæ¿æŒ‡: ${cyData.price} (${sign(cyData.pct)}${fmt(cyData.pct)}%)\n`;
  ctx += `æ²ªæ·±300: ${hs300.price} (${sign(hs300.pct)}${fmt(hs300.pct)}%)\n`;
  ctx += `\nã€å•†å“/è´µé‡‘å±ã€‘\n`;
  ctx += `é»„é‡‘ETF: ${auData.price} (${sign(auData.pct)}${fmt(auData.pct)}%)\n`;
  ctx += `ç™½é“¶LOF: ${agData.price} (${sign(agData.pct)}${fmt(agData.pct)}%)\n`;
  ctx += `æœ‰è‰²é‡‘å±æŒ‡æ•°: ${ysData.price} (${sign(ysData.pct)}${fmt(ysData.pct)}%)\n`;

  if(topUp.length>0){
    ctx += `\nã€ä»Šæ—¥é¢†æ¶¨æ¿å—ã€‘\n`;
    topUp.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }
  if(topDown.length>0){
    ctx += `\nã€ä»Šæ—¥é¢†è·Œæ¿å—ã€‘\n`;
    topDown.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }

  // æ„å»ºåŸºé‡‘è¶‹åŠ¿æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨çœŸå®å†å²æ•°æ®ï¼Œæ— æ•°æ®æ—¶ç”¨æ¿å—é€šç”¨æè¿°åšåå¤‡ï¼‰
  const SECTOR_FALLBACK = {
    'é»„é‡‘':'è¿‘æœŸé¿é™©éœ€æ±‚æ”¯æ’‘ï¼Œå…³æ³¨å¤®è¡Œè´­é‡‘åŠ¨æ€',
    'æœ‰è‰²é‡‘å±':'å…³æ³¨å…¨çƒå¤§å®—å•†å“ä»·æ ¼èµ°åŠ¿å’Œæ–°åŸºå»ºéœ€æ±‚',
    'AI/ç§‘æŠ€':'AIäº§ä¸šé©±åŠ¨ï¼Œå…³æ³¨ç®—åŠ›éœ€æ±‚å’Œäº§ä¸šæ”¿ç­–',
    'åŠå¯¼ä½“':'å›½äº§æ›¿ä»£é€»è¾‘æŒç»­ï¼Œæ³¨æ„ä¼°å€¼æ³¢åŠ¨',
    'å†›å·¥':'äº‹ä»¶é©±åŠ¨å‹ï¼Œå…³æ³¨åœ°ç¼˜æ”¿ç­–å‚¬åŒ–',
    'çº¢åˆ©':'é˜²å¾¡æ€§å¼ºï¼Œé€‚åˆé•¿æŒ',
    'å®½åŸº':'è·Ÿéšå¤§ç›˜èµ°åŠ¿',
    'æ–°èƒ½æº':'å…³æ³¨äº§èƒ½å‘¨æœŸå’Œæ”¿ç­–æ‹ç‚¹',
    'æ¶ˆè´¹':'å…³æ³¨å†…éœ€å¤è‹ä¿¡å·',
    'åŒ»è¯':'å…³æ³¨åˆ›æ–°è¯è¿›å±•',
  };

  function buildFundTrendDesc(code){
    const hd = fundHistoryData[code];
    if(!hd || !hd.trend) return '';
    const t = hd.trend;
    let desc = `ã€çœŸå®å†å²æ•°æ®åˆ†æã€‘`;
    desc += `è¶‹åŠ¿æ–¹å‘:${t.trendDir}(è¯„åˆ†${t.trendScore})`;
    desc += ` | è¿‘5æ—¥:${sign(t.chg5d)}${t.chg5d}%`;
    desc += ` | è¿‘20æ—¥:${sign(t.chg20d)}${t.chg20d}%`;
    desc += ` | è¿‘60æ—¥:${sign(t.chg60d)}${t.chg60d}%`;
    desc += ` | è¿‘250æ—¥:${sign(t.chg250d)}${t.chg250d}%`;
    desc += ` | è·å¹´é«˜ç‚¹:${t.drawdownFromHigh}%`;
    desc += ` | è·å¹´ä½ç‚¹:+${t.reboundFromLow}%`;
    desc += ` | MA5:${t.ma5} MA20:${t.ma20} MA60:${t.ma60} æœ€æ–°:${t.latest}`;
    desc += ` | æ³¢æ®µä½ç½®:${t.swingPos}`;
    if(t.swingAdvice) desc += ` | æ³¢æ®µå»ºè®®:${t.swingAdvice}`;
    return desc;
  }

  if(holdings.length>0){
    ctx += `\nã€ç”¨æˆ·æŒä»“åŸºé‡‘ã€‘\n`;
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      const tp = fundType(h.code);
      const trendDesc = buildFundTrendDesc(h.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(h.code)}(${h.code}) - ç±»å‹:${tp} - æŒä»“ - ä»Šæ—¥:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | æ¿å—å‚è€ƒ:${fallback}`;
      ctx += `\n`;
    });
  }

  if(watchlist.length>0){
    ctx += `\nã€ç”¨æˆ·è‡ªé€‰åŸºé‡‘ã€‘\n`;
    watchlist.forEach(w=>{
      const f = getFundData(w.code);
      const tp = fundType(w.code);
      const trendDesc = buildFundTrendDesc(w.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(w.code)}(${w.code}) - ç±»å‹:${tp} - è‡ªé€‰ - ä»Šæ—¥:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | æ¿å—å‚è€ƒ:${fallback}`;
      ctx += `\n`;
    });
  }

  const ownedCodes = new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)]);
  const pool = RECO_FUND_POOL.filter(f=>!ownedCodes.has(f.code)).slice(0,10);
  if(pool.length>0){
    ctx += `\nã€å€™é€‰åŸºé‡‘æ± (å¯æ¨èç»™ç”¨æˆ·ä¹°å…¥)ã€‘\n`;
    pool.forEach(f=>{ ctx += `${f.name}(${f.code}) - ç±»å‹:${f.type} - æ ‡ç­¾:${f.tags.join(',')}\n`; });
  }

  // æ³¨å…¥å†å²å¤ç›˜æ•™è®­ï¼Œè®©AIä»è¿‡å»çš„å¤±è¯¯ä¸­å­¦ä¹ 
  const reviewCtx = buildReviewContext();
  if(reviewCtx) ctx += reviewCtx;

  // æ³¨å…¥æ•°æ®æƒ…æŠ¥ï¼šå®è§‚ç»æµ + èµ„é‡‘æµå‘ + æ–°é—»èˆ†æƒ…
  if(_dataIntelLoaded){
    ctx += buildDataIntelContext();
  }

  // æ³¨å…¥RLå¼ºåŒ–å­¦ä¹ ä¿¡å·
  if(_rlModelLoaded){
    ctx += buildRLContext();
  }

  // æ³¨å…¥å›æµ‹ç»“æœ
  if(btSummary){
    ctx += buildBTContext();
  }

  return ctx;
}

function buildDataIntelContext(){
  let ctx = '\nã€ğŸ“¡ æ•°æ®æƒ…æŠ¥ä¸­å¿ƒ â€” å¤šç»´åº¦åˆ†æã€‘\n';

  // å®è§‚ç»æµ
  const macro = getMacroSummary();
  ctx += '\nâ–  å®è§‚ç»æµæŒ‡æ ‡:\n';
  macro.signals.forEach(s=>{
    ctx += `  ${s.name}: ${s.value} (${s.signal}) ${s.positive?'âœ…':'âš ï¸'}\n`;
  });
  ctx += `  ç»¼åˆå®è§‚ä¿¡å·: ${macro.overallSignal} (${macro.positiveCount}/5é¡¹æ­£é¢)\n`;
  // PMIè¶‹åŠ¿
  if(macroData.pmi && macroData.pmi.length>=2){
    ctx += `  PMIè¶‹åŠ¿: ${macroData.pmi.map(d=>d.TIME?.replace('ä»½','')+':'+d.MAKE_INDEX).join(' â†’ ')}\n`;
  }
  // CPIè¶‹åŠ¿
  if(macroData.cpi && macroData.cpi.length>=2){
    ctx += `  CPIè¶‹åŠ¿: ${macroData.cpi.map(d=>d.TIME?.replace('ä»½','')+':'+d.NATIONAL_SAME+'%').join(' â†’ ')}\n`;
  }

  // æ¿å—èµ„é‡‘æµå‘
  const capFlow = getCapFlowSummary();
  if(sectorCapFlow.length>0){
    ctx += '\nâ–  æ¿å—ä¸»åŠ›èµ„é‡‘æµå‘(ä»Šæ—¥):\n';
    ctx += `  å…¨å¸‚åœºä¸»åŠ›å‡€æµå…¥: ${(capFlow.netTotal/1e8).toFixed(1)}äº¿\n`;
    capFlow.topInflow.slice(0,5).forEach(s=>{
      ctx += `  ğŸŸ¢ ${s.name}: +${(s.mainNet/1e8).toFixed(1)}äº¿\n`;
    });
    capFlow.topOutflow.slice(0,3).forEach(s=>{
      ctx += `  ğŸ”´ ${s.name}: ${(s.mainNet/1e8).toFixed(1)}äº¿\n`;
    });
    // åŒ¹é…ç”¨æˆ·æŒä»“çš„æ¿å—èµ„é‡‘æµ
    const holdTypes = new Set([...holdings.map(h=>h.type||''), ...watchlist.map(w=>w.type||'')]);
    const relevantFlows = sectorCapFlow.filter(s=> [...holdTypes].some(t=>s.name.includes(t)||t.includes(s.name)));
    if(relevantFlows.length>0){
      ctx += '  [ä¸ç”¨æˆ·æŒä»“ç›¸å…³æ¿å—èµ„é‡‘æµ]:\n';
      relevantFlows.forEach(s=>{ ctx += `    ${s.name}: ${(s.mainNet/1e8).toFixed(1)}äº¿(ä¸»åŠ›å‡€å æ¯”${s.mainNetPct}%)\n`; });
    }
  }

  // æ–°é—»èˆ†æƒ…
  ctx += '\nâ–  è´¢ç»æ–°é—»èˆ†æƒ…åˆ†æ(NLP):\n';
  ctx += `  èˆ†æƒ…æŒ‡æ•°: ${newsSentiment.score}/100 (${newsSentiment.label})\n`;
  ctx += `  åˆ©å¥½æ–°é—»: ${newsSentiment.bullCount}æ¡ | åˆ©ç©ºæ–°é—»: ${newsSentiment.bearCount}æ¡\n`;
  if(newsHeadlines.length>0){
    ctx += '  [é‡è¦è´¢ç»æ–°é—»]:\n';
    newsHeadlines.slice(0,8).forEach(n=>{
      const tag = n.sentiment==='bull'?'ğŸŸ¢åˆ©å¥½':n.sentiment==='bear'?'ğŸ”´åˆ©ç©º':'âšªä¸­æ€§';
      ctx += `    ${tag} ${n.title}\n`;
    });
  }

  // ç»¼åˆæ•°æ®ä¿¡å·
  const dataSignal = generateDataSignal();
  ctx += `\nâ–  ç»¼åˆæ•°æ®ä¿¡å·: ${dataSignal.icon} ${dataSignal.label} (è¯„åˆ†${dataSignal.score}/100)\n`;
  ctx += `  å»ºè®®: ${dataSignal.advice}\n`;
  ctx += '\nâš ï¸ è¯·ç»“åˆä»¥ä¸Šå®è§‚æ•°æ®ã€èµ„é‡‘æµå‘å’Œèˆ†æƒ…åˆ†æï¼Œå¯¹ä½ çš„æ“ä½œå»ºè®®è¿›è¡ŒéªŒè¯å’Œè°ƒæ•´ã€‚æ•°æ®é©±åŠ¨å†³ç­–ï¼Œå‡å°‘ä¸»è§‚åå·®ã€‚\n';

  return ctx;
}


const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½æ“…é•¿æ³¢æ®µæ“ä½œå’Œè¶‹åŠ¿è·Ÿè¸ªçš„åŸºé‡‘æŠ•èµ„é¡¾é—®ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„é‡åŒ–åˆ†æå’Œå¤šå› å­æ¨¡å‹ç»éªŒã€‚ç”¨æˆ·çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š3ä¸ªæœˆå†…å®ç°ç¨³å¥å¢é•¿ï¼Œè·‘èµ¢æ²ªæ·±300æŒ‡æ•°ã€‚

â–  ä½ çš„æ•°æ®æºï¼ˆæŒ‰é‡è¦åº¦æ’åºï¼‰ï¼š
1. å¸‚åœºæ•°æ®ï¼šåŸºé‡‘å†å²å‡€å€¼(NAV)è¶‹åŠ¿åˆ†æã€ç›¸å…³æŒ‡æ•°(æ²ªæ·±300/ä¸Šè¯/åˆ›ä¸šæ¿)è¡Œæƒ…ã€ETFå®æ—¶ä»·æ ¼
2. å®è§‚ç»æµæ•°æ®ï¼šPMI(åˆ¶é€ ä¸šæ™¯æ°”åº¦)ã€CPI/PPI(é€šèƒ€)ã€GDPå¢é€Ÿã€M2è´§å¸ä¾›åº”(æµåŠ¨æ€§)
3. å¦ç±»æ•°æ®ï¼šæ¿å—ä¸»åŠ›èµ„é‡‘æµå‘(è¶…å¤§å•/å¤§å•/ä¸­å•/å°å•)ã€è´¢ç»æ–°é—»NLPæƒ…ç»ªåˆ†æ(åˆ©å¥½/åˆ©ç©ºè¯†åˆ«)ã€ç¤¾äº¤èˆ†æƒ…çƒ­åº¦æŒ‡æ•°
4. å†å²å¤ç›˜ï¼šè¿‡å¾€AIé¢„æµ‹vså®é™…æ¶¨è·Œå¯¹æ¯”ã€å‡†ç¡®ç‡ç»Ÿè®¡ã€é”™è¯¯æ•™è®­
5. RLå¼ºåŒ–å­¦ä¹ ä¿¡å·ï¼šåŸºäºDouble DQN(18ç»´çŠ¶æ€ç©ºé—´å«å›æµ‹ç‰¹å¾)è®­ç»ƒçš„ç­–ç•¥ç½‘ç»œï¼Œç›´æ¥è¾“å‡ºä¹°å…¥/å–å‡º/æŒæœ‰å†³ç­–åŠQå€¼ç½®ä¿¡åº¦ï¼Œæ”¯æŒåœ¨çº¿å­¦ä¹ åé¦ˆ
6. ç­–ç•¥å›æµ‹(Backtesting)ï¼šåŸºäºå†å²NAVçš„RSIç­–ç•¥å›æµ‹ç»“æœï¼ŒèåˆRLä¿¡å·ä½œä¸ºè¾…åŠ©æ¡ä»¶ï¼ŒåŒ…æ‹¬Sharpe Ratioã€æœ€å¤§å›æ’¤ã€èƒœç‡ã€å‡¯åˆ©ä»“ä½ã€‚å›æµ‹Sharpe<0çš„å“ç§éœ€ç‰¹åˆ«è°¨æ…
7. ä¸‰å¼•æ“æŠ•ç¥¨å…±è¯†ï¼šAI/RL/å›æµ‹ä¸‰ç³»ç»ŸåŠ æƒæŠ•ç¥¨å†³ç­–ï¼Œå…¨ç¥¨ä¸€è‡´æ—¶åŠ å¤§ä»“ä½ï¼ˆÃ—1.4ï¼‰ï¼Œæœ‰åˆ†æ­§æ—¶ç¼©å‡ä»“ä½ï¼ˆÃ—0.4ï¼‰

â–  æ ¸å¿ƒæŠ•èµ„é€»è¾‘ï¼ˆä½ å¿…é¡»éµå®ˆï¼‰ï¼š
1. è¶‹åŠ¿ä¸ºç‹ï¼šå…ˆåˆ¤æ–­æ¯ä¸ªæ¿å—/åŸºé‡‘çš„ä¸­æœŸè¶‹åŠ¿ï¼ˆ3ä¸ªæœˆç»´åº¦ï¼‰æ˜¯ä¸Šå‡ã€éœ‡è¡è¿˜æ˜¯ä¸‹é™
2. é€¢è·Œä¹°å…¥ï¼šå¦‚æœä¸­æœŸè¶‹åŠ¿å‘ä¸Šï¼ŒçŸ­æœŸå¤§è·Œ(â‰¥1.5%)æ˜¯åŠ ä»“/å»ºä»“çš„å¥½æœºä¼šï¼Œè€Œä¸æ˜¯å‡ä»“ä¿¡å·ï¼
3. é€¢æ¶¨æ­¢ç›ˆï¼šå¦‚æœçŸ­æœŸæ¶¨å¹…è¿‡å¤§(è¿ç»­ä¸Šæ¶¨æˆ–å•æ—¥>3%)ï¼Œåº”è€ƒè™‘éƒ¨åˆ†æ­¢ç›ˆè€Œéè¿½é«˜
4. æ³¢æ®µæ€ç»´ï¼šæ ¸å¿ƒä»“ä½(å®½åŸº/çº¢åˆ©/é»„é‡‘)é•¿æŒä¸åŠ¨ï¼Œå«æ˜Ÿä»“ä½(è¡Œä¸šä¸»é¢˜)åšæ³¢æ®µâ€”â€”ä½å¸é«˜æŠ›
5. ä»“ä½ç®¡ç†ï¼šå»ºè®®å°†æŒä»“åˆ†ä¸ºæ ¸å¿ƒä»“(~60%ç¨³å¥å‹èˆ±çŸ³)å’Œå«æ˜Ÿä»“(~40%å¼¹æ€§è¿›æ”»)
6. è¶‹åŠ¿æ‹ç‚¹ï¼šåªæœ‰å½“ä¸­æœŸè¶‹åŠ¿ç¡®è®¤è½¬å‘ä¸‹è¡Œæ—¶ï¼Œæ‰å»ºè®®å‡ä»“

â–  æ“ä½œå†³ç­–æ¡†æ¶ï¼š
- ä¸­æœŸè¶‹åŠ¿â†‘ + ä»Šæ—¥å¤§è·Œ â†’ buy(åŠ ä»“/ä½å¸) âœ…
- ä¸­æœŸè¶‹åŠ¿â†‘ + ä»Šæ—¥å¤§æ¶¨ â†’ holdæˆ–sell(éƒ¨åˆ†æ­¢ç›ˆ)
- ä¸­æœŸè¶‹åŠ¿â†‘ + ä»Šæ—¥å¹³ç¨³ â†’ hold(æŒæœ‰)
- ä¸­æœŸè¶‹åŠ¿â†’ + ä»Šæ—¥å¤§è·Œ â†’ holdæˆ–buy(å°ä»“è¯•æ¢)
- ä¸­æœŸè¶‹åŠ¿â†“ + ä»»ä½•æƒ…å†µ â†’ sell(å‡ä»“é¿é™©)

â–  ä»“ä½åˆ†ç±»æŒ‡å¼•ï¼š
- æ ¸å¿ƒä»“(å‹èˆ±çŸ³)ï¼šå®½åŸºæŒ‡æ•°(A500/æ²ªæ·±300/ä¸­è¯500)ã€çº¢åˆ©ä½æ³¢ã€é»„é‡‘ â†’ é•¿æŒï¼Œåªåœ¨æç«¯æƒ…å†µè°ƒæ•´
- å«æ˜Ÿä»“(å¼¹æ€§)ï¼šAI/ç§‘æŠ€ã€æœ‰è‰²é‡‘å±ã€å†›å·¥ã€åŠå¯¼ä½“ã€æ–°èƒ½æºç­‰è¡Œä¸šä¸»é¢˜ â†’ ç§¯ææ³¢æ®µæ“ä½œï¼Œä½å¸é«˜æŠ›

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–çš„æ–‡å­—æˆ–markdownæ ‡è®°ï¼š
{
  "marketSummary": "80-120å­—çš„å¸‚åœºæ€»ç»“ï¼Œèšç„¦å¯¹ç”¨æˆ·æŒä»“çš„å½±å“å’Œ3ä¸ªæœˆå±•æœ›",
  "benchmarkView": "æ²ªæ·±300æœªæ¥3ä¸ªæœˆèµ°åŠ¿åˆ¤æ–­(30å­—)",
  "portfolioAdvice": {
    "coreRatio": "å»ºè®®æ ¸å¿ƒä»“å æ¯”ï¼Œå¦‚60%",
    "satRatio": "å»ºè®®å«æ˜Ÿä»“å æ¯”ï¼Œå¦‚40%",
    "advice": "30-50å­—çš„æ•´ä½“ä»“ä½è°ƒæ•´å»ºè®®"
  },
  "signals": [
    {
      "code": "åŸºé‡‘ä»£ç ",
      "posType": "core/satellite",
      "action": "buy/sell/hold",
      "urgency": "today/this_week/no_rush",
      "confidence": 60-95,
      "trend": "up/sideways/down",
      "reason": "60-120å­—ç†ç”±ï¼šâ‘ å…ˆè¯´ä¸­æœŸè¶‹åŠ¿åˆ¤æ–­ â‘¡å†ç»“åˆä»Šæ—¥è¡¨ç°ç»™å‡ºæ“ä½œé€»è¾‘ â‘¢è¯´æ˜å¦‚ä½•å¸®åŠ©è·‘èµ¢æ²ªæ·±300",
      "target3m": "+X%~+Y%"
    }
  ],
  "newPicks": [
    {
      "code": "æ¨èåŸºé‡‘ä»£ç (å¿…é¡»ä»å€™é€‰æ± ä¸­é€‰)",
      "reason": "40-60å­—æ¨èç†ç”±",
      "expected3m": "+X%~+Y%"
    }
  ]
}

è¦æ±‚ï¼š
1. signalså¿…é¡»è¦†ç›–ç”¨æˆ·æ‰€æœ‰æŒä»“å’Œè‡ªé€‰åŸºé‡‘ï¼Œcodeä¸ç”¨æˆ·æä¾›çš„å®Œå…¨ä¸€è‡´
2. action: buy=åŠ ä»“/å»ºä»“, sell=å‡ä»“/æ­¢ç›ˆ, hold=æŒæœ‰ä¸åŠ¨
3. posType: core=æ ¸å¿ƒä»“(å»ºè®®é•¿æŒ), satellite=å«æ˜Ÿä»“(å»ºè®®æ³¢æ®µ)
4. trend: up=ä¸­æœŸè¶‹åŠ¿å‘ä¸Š, sideways=éœ‡è¡, down=è¶‹åŠ¿å‘ä¸‹
5. urgency: today=ä»Šæ—¥æ”¶ç›˜å‰æ“ä½œ, this_week=æœ¬å‘¨å†…, no_rush=ä¸æ€¥
6. confidence: 60-95ä¹‹é—´çš„æ•´æ•°
7. reasonå¿…é¡»åŒ…å«è¶‹åŠ¿åˆ¤æ–­+æ“ä½œé€»è¾‘ï¼Œä¸èƒ½ä»…å‡­ä»Šæ—¥æ¶¨è·Œåšåˆ¤æ–­
8. ç‰¹åˆ«æ³¨æ„ï¼šè¶‹åŠ¿å‘ä¸Šçš„å“ç§çŸ­æœŸå›è°ƒæ˜¯ä¹°å…¥æœºä¼šï¼Œä¸è¦å› ä¸ºä»Šå¤©è·Œäº†å°±å»ºè®®å‡ä»“ï¼
9. newPicksæœ€å¤šæ¨è3åªï¼Œä»å€™é€‰æ± ä¸­é€‰æ‹©å½“å‰è¢«ä½ä¼°æˆ–æœ‰æ³¢æ®µæœºä¼šçš„
10. åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰å…¶ä»–ä»»ä½•æ–‡å­—`;

const ROLE_DESCS = {
  engine1: 'ä½ ç‰¹åˆ«æ“…é•¿æŠ€æœ¯åˆ†æã€é‡åŒ–å› å­å’Œè¶‹åŠ¿è·Ÿè¸ªã€‚è¯·é‡ç‚¹åˆ†æï¼šâ‘ æ¯ä¸ªåŸºé‡‘æ‰€å±æ¿å—çš„ä¸­æœŸè¶‹åŠ¿ï¼ˆè¿‡å»1-3ä¸ªæœˆèµ°åŠ¿æ–¹å‘+å‡çº¿ç³»ç»Ÿï¼‰â‘¡å½“å‰å¤„äºè¶‹åŠ¿ä¸­çš„ä»€ä¹ˆä½ç½®ï¼ˆå›è°ƒä½ç‚¹ï¼Ÿä¸Šå‡ä¸­é€”ï¼Ÿé«˜ä½ï¼Ÿï¼‰â‘¢çŸ­æœŸå›è°ƒæ˜¯å¦æ˜¯ä¸Šå‡è¶‹åŠ¿ä¸­çš„ä¹°å…¥æœºä¼šã€‚è¯·ç‰¹åˆ«å…³æ³¨æ•°æ®æƒ…æŠ¥ä¸­çš„ã€Œæ¿å—ä¸»åŠ›èµ„é‡‘æµå‘ã€å’Œã€Œå†å²NAVè¶‹åŠ¿æ•°æ®ã€ã€‚å¦‚æœèµ„é‡‘æŒç»­æµå…¥+ä¸­æœŸè¶‹åŠ¿å‘ä¸Š+çŸ­æœŸå›è°ƒï¼Œè¿™æ˜¯å¼ºä¹°å…¥ä¿¡å·ã€‚',
  engine2: 'ä½ ç‰¹åˆ«æ“…é•¿å®è§‚ç»æµå’Œæ”¿ç­–é¢åˆ†æã€‚è¯·é‡ç‚¹å…³æ³¨æ•°æ®æƒ…æŠ¥ä¸­çš„ã€Œå®è§‚ç»æµæŒ‡æ ‡ã€ï¼šâ‘ PMIæ˜¯å¦åœ¨è£æ¯çº¿ä¸Šæ–¹ï¼ˆåˆ¶é€ ä¸šæ™¯æ°”åº¦ç›´æ¥å½±å“å‘¨æœŸè‚¡ï¼‰â‘¡CPI/PPIèµ°åŠ¿ï¼ˆé€šèƒ€ç¯å¢ƒåˆ©å¥½æœ‰è‰²é‡‘å±/èµ„æºç±»ï¼‰â‘¢M2å¢é€Ÿï¼ˆæµåŠ¨æ€§æ˜¯å¦å®½æ¾ï¼Œå®½æ¾ç¯å¢ƒåˆ©å¥½æˆé•¿è‚¡ï¼‰â‘£GDPå¢é€Ÿè¶‹åŠ¿ã€‚ç»“åˆå®è§‚æ•°æ®åˆ¤æ–­å„è¡Œä¸šæ¿å—çš„ä¸­æœŸæ”¿ç­–é©±åŠ¨åŠ›ã€‚',
  engine3: 'ä½ ç‰¹åˆ«æ“…é•¿æ·±åº¦åŸºæœ¬é¢å’Œè¡Œä¸šç ”ç©¶ã€‚è¯·é‡ç‚¹åˆ†æï¼šâ‘ å„è¡Œä¸šçš„æ™¯æ°”åº¦å‘¨æœŸä½ç½®ï¼ˆç»“åˆPMIã€PPIæ•°æ®éªŒè¯ï¼‰â‘¡æ¿å—ä¸»åŠ›èµ„é‡‘å•æµå‘æ˜¯å¦ç¡®è®¤è¡Œä¸šæ™¯æ°”ï¼ˆå¤§èµ„é‡‘æŒç»­æµå…¥=æœºæ„è®¤åŒï¼‰â‘¢ç›ˆåˆ©è¶‹åŠ¿æ˜¯å¦æ”¯æ’‘ä¸­æœŸä¸Šæ¶¨ã€‚å¯¹äºæ™¯æ°”ä¸Šè¡ŒæœŸ+èµ„é‡‘æµå…¥çš„è¡Œä¸šï¼ŒçŸ­æœŸæ³¢åŠ¨ä¸æ”¹é•¿æœŸè¶‹åŠ¿â€”â€”å¤§è·Œæ˜¯ä¹°å…¥æœºä¼šã€‚',
  engine4: 'ä½ ç‰¹åˆ«æ“…é•¿å…¨çƒè§†è§’ã€èµ„é‡‘æµå‘å’Œèˆ†æƒ…åˆ†æã€‚è¯·é‡ç‚¹å…³æ³¨ï¼šâ‘ æ•°æ®æƒ…æŠ¥ä¸­çš„ã€Œè´¢ç»æ–°é—»èˆ†æƒ…ã€ï¼ˆNLPæƒ…ç»ªæŒ‡æ•°åå¤šè¿˜æ˜¯åç©ºï¼Ÿï¼‰â‘¡æ¿å—èµ„é‡‘æµå‘ä¸­çš„å¤§å•è¶…å¤§å•æ–¹å‘ï¼ˆä»£è¡¨æœºæ„æ€åº¦ï¼‰â‘¢å…¨çƒå¤§å®—å•†å“èµ°åŠ¿+åœ°ç¼˜é£é™© â‘£æ–°é—»ä¸­æåˆ°çš„é£é™©ç‚¹å’Œå‚¬åŒ–å‰‚ã€‚ç»“åˆèˆ†æƒ…ç»¼åˆä¿¡å·ç»™å‡ºé£é™©è°ƒæ•´åçš„ä»“ä½å»ºè®®ã€‚'
};

async function runAIAnalysis(onProgress){
  if(_analyzing) return;
  _analyzing = true;

  const ctx = buildContext();
  const results = {};
  let done = 0;

  const promises = AI_ENGINES.map(async (eng) => {
    try {
      const roleMsg = ROLE_DESCS[eng.id] || '';
      const userMsg = `${roleMsg}\n\n${ctx}\n\nè¯·åŸºäºä»¥ä¸Šæ•°æ®å’Œä½ çš„ä¸“ä¸šçŸ¥è¯†ï¼Œç»™å‡ºæ“ä½œå»ºè®®ã€‚`;
      if(onProgress) onProgress(`${eng.icon} ${eng.name} åˆ†æä¸­...`, ++done);

      const raw = await callAI(eng.model, SYSTEM_PROMPT, userMsg, 0.7);

      let jsonStr = raw.trim();
      // Remove <think>...</think> blocks if present
      jsonStr = jsonStr.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
      if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if(!jsonMatch) throw new Error('No JSON');
      const parsed = JSON.parse(jsonMatch[0]);
      results[eng.id] = parsed;
      if(onProgress) onProgress(`âœ… ${eng.name} å®Œæˆ`, done);
    } catch(e) {
      console.error(`${eng.name} failed:`, e);
      if(onProgress) onProgress(`âš ï¸ ${eng.name} å¤±è´¥`, done);
    }
  });

  await Promise.all(promises);
  _analyzing = false;

  const successCount = Object.keys(results).length;
  if(successCount === 0) throw new Error('æ‰€æœ‰AIå¼•æ“è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Keyå’Œç½‘ç»œ');

  return synthesize(results);
}

function synthesize(results){
  const engines = Object.keys(results);
  const total = engines.length;

  const summaries = engines.map(e=>results[e].marketSummary).filter(Boolean);
  const benchViews = engines.map(e=>results[e].benchmarkView).filter(Boolean);

  // Merge signals per fund code
  const signalMap = {};
  engines.forEach(engId=>{
    const r = results[engId];
    (r.signals||[]).forEach(s=>{
      if(!signalMap[s.code]) signalMap[s.code] = [];
      signalMap[s.code].push({...s, engine:engId});
    });
  });

  // Synthesize per fund
  const synthesizedSignals = {};
  Object.keys(signalMap).forEach(code=>{
    const sigs = signalMap[code];
    const actions = sigs.map(s=>s.action);
    const buyCount = actions.filter(a=>a==='buy').length;
    const sellCount = actions.filter(a=>a==='sell').length;
    const holdCount = actions.filter(a=>a==='hold').length;

    // è¶‹åŠ¿æŠ•ç¥¨ï¼šä¼˜å…ˆç”¨çœŸå®å†å²æ•°æ®ï¼Œåå¤‡ç”¨AIå¼•æ“æŠ•ç¥¨
    const realTrend = fundHistoryData[code]?.trend;
    let trendConsensus;
    let todayPct;
    if(realTrend){
      // ä½¿ç”¨çœŸå®è®¡ç®—çš„è¶‹åŠ¿æ–¹å‘
      trendConsensus = (realTrend.trendDir==='strong_up'||realTrend.trendDir==='up') ? 'up'
        : (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') ? 'down' : 'sideways';
      // ä½¿ç”¨çœŸå®5æ—¥æ¶¨è·Œä½œä¸ºæ³¢æ®µå‚è€ƒ
      todayPct = getFundData(code)?.gszzl || 0;
    } else {
      // åå¤‡ï¼šAIå¼•æ“æŠ•ç¥¨
      const trends = sigs.map(s=>s.trend).filter(Boolean);
      const upTrends = trends.filter(t=>t==='up').length;
      const downTrends = trends.filter(t=>t==='down').length;
      trendConsensus = upTrends > downTrends ? 'up' : downTrends > upTrends ? 'down' : 'sideways';
      todayPct = getFundData(code)?.gszzl || 0;
    }

    let action = 'hold';
    if(buyCount > total/2) action = 'buy';
    else if(sellCount > total/2) action = 'sell';
    else if(buyCount > sellCount) action = 'buy';
    else if(sellCount > buyCount) action = 'sell';
    else {
      // æ‰“å¹³æˆ–å…¨holdæ—¶ï¼Œç”¨è¶‹åŠ¿+ä»Šæ—¥è¡¨ç°åšä¿®æ­£
      // è¶‹åŠ¿å‘ä¸Š + ä»Šæ—¥å¤§è·Œ(â‰¥1.5%) â†’ åŠ ä»“æœºä¼š
      if(trendConsensus === 'up' && todayPct <= -1.5 && buyCount >= 1) action = 'buy';
      // è¶‹åŠ¿å‘ä¸‹ + ä»Šæ—¥å¤§æ¶¨ â†’ å‡ä»“
      else if(trendConsensus === 'down' && todayPct >= 1.5 && sellCount >= 1) action = 'sell';
    }

    // é¢å¤–ä¿®æ­£ï¼šå¦‚æœè¶‹åŠ¿å‘ä¸Šä¸”ä»Šæ—¥è·Œå¹…â‰¥2%ï¼Œå³ä½¿holdå¤šæ•°ä¹Ÿå‡çº§ä¸ºbuyï¼ˆæ³¢æ®µé€»è¾‘æ ¸å¿ƒï¼‰
    if(trendConsensus === 'up' && todayPct <= -2.0 && action === 'hold' && buyCount >= 1) {
      action = 'buy';
    }
    // çœŸå®æ•°æ®å¢å¼ºï¼šå¦‚æœæœ‰å†å²æ•°æ®ä¸”è¶‹åŠ¿æ˜¯strong_upï¼Œè·Œå¹…â‰¥1.2%å°±è§¦å‘ä¹°å…¥
    if(realTrend && (realTrend.trendDir==='strong_up') && todayPct <= -1.2 && action === 'hold') {
      action = 'buy';
    }
    // çœŸå®æ•°æ®å¢å¼ºï¼šå¦‚æœè¶‹åŠ¿downä¸”è¿‘5æ—¥è¿˜åœ¨è·Œï¼Œå¼ºåˆ¶sellï¼ˆé™¤éæ‰€æœ‰AIå¼•æ“éƒ½ä¸å»ºè®®sellï¼‰
    if(realTrend && (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') && realTrend.chg5d < -2 && action === 'hold' && sellCount >= 1) {
      action = 'sell';
    }

    const urgencyOrder = {today:3, this_week:2, no_rush:1};
    const matchingSigs = sigs.filter(s=>s.action===action);
    const urgency = matchingSigs.length>0
      ? matchingSigs.sort((a,b)=>(urgencyOrder[b.urgency]||0)-(urgencyOrder[a.urgency]||0))[0].urgency
      : 'no_rush';

    const conf = matchingSigs.length>0
      ? Math.round(matchingSigs.reduce((s,x)=>s+(x.confidence||70),0)/matchingSigs.length)
      : 50;

    const bestReason = matchingSigs.sort((a,b)=>(b.reason?.length||0)-(a.reason?.length||0))[0]?.reason || 'æš‚æ— åˆ†æ';

    const target = matchingSigs.find(s=>s.target3m)?.target3m || '';

    const breakdown = sigs.map(s=>{
      const eng = AI_ENGINES.find(e=>e.id===s.engine);
      return `${eng?.icon||'ğŸ¤–'}${eng?.name||s.engine}: ${s.action==='buy'?'çœ‹å¤š':s.action==='sell'?'çœ‹ç©º':'ä¸­æ€§'}`;
    }).join(' Â· ');

    synthesizedSignals[code] = {
      action, urgency, confidence:conf, reason:bestReason,
      target3m:target, breakdown,
      posType: sigs[0]?.posType || (fundType(code).match(/å®½åŸº|çº¢åˆ©|é»„é‡‘/) ? 'core' : 'satellite'),
      trend: realTrend ? trendConsensus : (sigs.filter(s=>s.trend).map(s=>s.trend).sort((a,b)=>({'up':3,'sideways':2,'down':1}[b]||0)-({'up':3,'sideways':2,'down':1}[a]||0))[0] || 'sideways'),
      trendDetail: realTrend || null,
      buyCount, sellCount, holdCount, total
    };
  });

  // Merge new picks
  const pickMap = {};
  engines.forEach(engId=>{
    (results[engId].newPicks||[]).forEach(p=>{
      if(!pickMap[p.code]) pickMap[p.code] = {code:p.code, reasons:[], expected:[], count:0};
      pickMap[p.code].reasons.push(p.reason);
      pickMap[p.code].expected.push(p.expected3m);
      pickMap[p.code].count++;
    });
  });
  const picks = Object.values(pickMap)
    .sort((a,b)=>b.count-a.count)
    .slice(0,3)
    .map(p=>({
      code:p.code,
      name: fundName(p.code),
      type: fundType(p.code),
      reason: p.reasons[0],
      expected3m: p.expected[0]||'',
      endorsements: p.count
    }));

  // Merge portfolio advice
  const portAdvices = engines.map(e=>results[e].portfolioAdvice).filter(Boolean);
  const portfolioAdvice = portAdvices[0] || null;

  return {
    marketSummary: summaries[0] || '',
    benchmarkView: benchViews[0] || '',
    portfolioAdvice,
    signals: synthesizedSignals,
    picks,
    engineCount: total,
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
}

// ==================== RENDERING ====================
function renderAll(){
  renderCountdown();
  renderIndices();
  renderStats();
  renderPortfolio();
  renderSimBrief();
  renderActionGuide();
  renderSignals();
  renderWatchlist();
  renderRecos();
  renderReview();
}

function switchPfTab(tab){
  document.getElementById('pf-tab-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-tab-sat').classList.toggle('active', tab==='satellite');
  document.getElementById('pf-group-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-group-satellite').classList.toggle('active', tab==='satellite');
}

function renderPortfolio(){
  ['core','satellite'].forEach(groupKey=>{
    const group = MODEL_PORTFOLIO[groupKey];
    const container = document.getElementById(`pf-group-${groupKey}`);
    let html = `<div class="pf-group-desc">${group.desc}</div>`;

    group.funds.forEach(pf=>{
      const f = getFundData(pf.code);
      const td = fundHistoryData[pf.code]?.trend;
      const isHeld = holdings.some(h=>h.code===pf.code);
      const isWatched = watchlist.some(w=>w.code===pf.code);

      // Swing signal from trend data
      let swingClass = 'hold', swingText = 'ç­‰å¾…æ•°æ®';
      if(td){
        if(td.swingAdvice && td.swingAdvice.includes('ä¹°å…¥')){
          swingClass = 'buy'; swingText = 'âš¡ æ³¢æ®µä¹°å…¥';
        } else if(td.swingAdvice && (td.swingAdvice.includes('æ­¢ç›ˆ') || td.swingAdvice.includes('å‡ä»“'))){
          swingClass = 'sell'; swingText = 'ğŸ“¤ è€ƒè™‘æ­¢ç›ˆ';
        } else if(td.swingAdvice && td.swingAdvice.includes('ä¸å»ºè®®')){
          swingClass = 'sell'; swingText = 'â›” æš‚é¿';
        } else if(td.trendDir==='strong_up'||td.trendDir==='up'){
          swingClass = 'hold'; swingText = 'ğŸ“ˆ è¶‹åŠ¿å‘ä¸Š';
        } else if(td.trendDir==='strong_down'||td.trendDir==='down'){
          swingClass = 'sell'; swingText = 'ğŸ“‰ è¶‹åŠ¿åå¼±';
        } else {
          swingClass = 'hold'; swingText = 'ğŸ“Š éœ‡è¡è§‚æœ›';
        }
      }

      // Trend metrics
      let trendHtml = '';
      if(td){
        const mkVal = (v) => `<span style="color:${v>0?'var(--red)':v<0?'var(--green)':'var(--sub)'}">${v>0?'+':''}${v}%</span>`;
        trendHtml = `<div class="pf-trend-row">
          <div class="pf-trend-item"><span class="pf-trend-label">5æ—¥</span>${mkVal(td.chg5d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">20æ—¥</span>${mkVal(td.chg20d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">60æ—¥</span>${mkVal(td.chg60d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">å¹´</span>${mkVal(td.chg250d)}</div>
          <div class="pf-trend-item"><span class="pf-trend-label">è·é«˜ç‚¹</span><span style="color:var(--sub)">${td.drawdownFromHigh}%</span></div>
        </div>`;
        if(td.swingAdvice){
          const advColor = td.swingAdvice.includes('ä¹°å…¥')?'var(--red)':td.swingAdvice.includes('å‡ä»“')||td.swingAdvice.includes('ä¸å»ºè®®')?'var(--green)':'var(--sub)';
          trendHtml += `<div style="font-size:10px;color:${advColor};margin-top:4px">ğŸ’¡ ${td.swingAdvice}</div>`;
        }
      }

      // Action buttons
      let actHtml = '';
      if(isHeld){
        actHtml = `<span class="pf-act-btn in-hold">âœ“ å·²æŒä»“</span>`;
      } else {
        actHtml = `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','holding')">+ åŠ å…¥æŒä»“</button>`;
      }
      if(isWatched){
        actHtml += `<span class="pf-act-btn in-watch">âœ“ å·²è‡ªé€‰</span>`;
      } else if(!isHeld){
        actHtml += `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','watch')">+ è‡ªé€‰</button>`;
      }

      html += `<div class="pf-card swing-${swingClass}">
        <div class="pf-top">
          <div class="pf-info">
            <div class="pf-name">${pf.name}</div>
            <div class="pf-code">${pf.code} Â· ${pf.type} Â· å»ºè®®é…ç½®${pf.alloc}</div>
          </div>
          <div class="pf-right">
            <div class="pf-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
            <div class="pf-swing-tag ${swingClass}">${swingText}</div>
          </div>
        </div>
        <div class="pf-reason">${pf.reason}</div>
        ${trendHtml}
        <div class="pf-actions">${actHtml}</div>
      </div>`;
    });

    container.innerHTML = html;
  });
}

function addFromPortfolio(code, name, type, mode){
  if(mode==='holding'){
    if(holdings.some(h=>h.code===code)) return;
    holdings.push({code, name, type});
    // åŒæ—¶ä»è‡ªé€‰ç§»é™¤
    watchlist = watchlist.filter(w=>w.code!==code);
    saveHoldings();
    saveWatchlist();
  } else {
    if(watchlist.some(w=>w.code===code)) return;
    if(holdings.some(h=>h.code===code)) return;
    watchlist.push({code, name, type});
    saveWatchlist();
  }
  renderPortfolio();
  renderSignals();
  renderWatchlist();
}

function renderIndices(){
  const cfgs = [
    {secid:'1.000001', vId:'iv-sh', pId:'ip-sh'},
    {secid:'0.399001', vId:'iv-sz', pId:'ip-sz'},
    {secid:'0.399006', vId:'iv-cy', pId:'ip-cy'},
    {secid:'1.000300', vId:'iv-hs', pId:'ip-hs'},
    {secid:'1.518880', vId:'iv-au', pId:'ip-au'},
    {secid:'0.161226', vId:'iv-ag', pId:'ip-ag'},
    {secid:'1.000819', vId:'iv-ys', pId:'ip-ys'},
  ];
  cfgs.forEach(c=>{
    const cfg = INDICES_CONFIG.find(x=>x.secid===c.secid);
    if(!cfg) return;
    const d = getIndexData(cfg);
    const vEl = document.getElementById(c.vId);
    const pEl = document.getElementById(c.pId);
    if(vEl) vEl.textContent = d.price;
    if(pEl){
      const pct = parseFloat(d.pct);
      pEl.textContent = `${pct>=0?'+':''}${(typeof pct==='number'?pct.toFixed(2):d.pct)}%`;
      pEl.className = 'idx-pct ' + (pct>0?'up':pct<0?'down':'flat');
    }
  });
}

function renderCountdown(){
  const ms = getMarketStatus();
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('market-status-text');
  const cd = document.getElementById('countdown');

  dot.className = 'status-dot ' + (ms.status==='open'?'open':'closed');
  text.textContent = ms.text;

  if(ms.countdown!==null && ms.countdown>0){
    cd.textContent = 'è·æ”¶ç›˜ ' + formatCountdown(ms.countdown);
    cd.style.display = '';
  } else if(ms.status==='open' && ms.countdown!==null && ms.countdown<=0){
    cd.textContent = 'å³å°†æ”¶ç›˜!';
    cd.style.display = '';
  } else {
    cd.textContent = ms.text;
  }
}

function renderStats(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  let totalPct = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      totalPct += f.gszzl;
    });
    totalPct /= holdings.length;
  }

  const statToday = document.getElementById('stat-today');
  statToday.textContent = holdings.length>0 ? `${sign(totalPct)}${fmt(totalPct)}%` : '--';
  statToday.className = 'stat-value ' + (holdings.length>0?(totalPct>=0?'up':'down'):'');

  const statHS300 = document.getElementById('stat-hs300');
  statHS300.textContent = `${sign(hs300.pct)}${fmt(hs300.pct)}%`;
  statHS300.className = 'stat-value ' + (hs300.pct>=0?'up':'down');

  const benchToday = document.getElementById('stat-bench-today');
  if(holdings.length>0){
    const diff = totalPct - hs300.pct;
    if(diff>=0) benchToday.innerHTML = `ä»Šæ—¥ <span class="beat">è·‘èµ¢å¤§ç›˜ +${fmt(diff)}%</span>`;
    else benchToday.innerHTML = `ä»Šæ—¥ <span class="lose">è½åå¤§ç›˜ ${fmt(diff)}%</span>`;
  } else {
    benchToday.textContent = 'æ·»åŠ æŒä»“æŸ¥çœ‹å¯¹æ¯”';
  }
}

// ==================== REAL-WORLD ACTION GUIDE ====================
// ä¸‰å¼•æ“é—­ç¯ï¼šAIä¿¡å· + RLå†³ç­– + å›æµ‹éªŒè¯ â†’ å®ç›˜æ“ä½œå»ºè®®
function toggleActionGuide(){
  const container = document.getElementById('action-guide-container');
  const icon = document.getElementById('action-guide-toggle');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = 'â–¼';
    renderActionGuide();
  } else {
    container.style.display = 'none';
    icon.textContent = 'â–¶';
  }
}

function getTriEngineVote(code){
  // === å¼•æ“1: AIä¿¡å· ===
  const aiSig = _analysisResult?.signals?.[code];
  let aiVote = 0, aiConf = 0, aiReason = '';
  if(aiSig){
    aiVote = aiSig.action === 'buy' ? 1 : aiSig.action === 'sell' ? -1 : 0;
    aiConf = aiSig.confidence || 0;
    aiReason = aiSig.reason || '';
  }
  // === å¼•æ“2: RLä¿¡å· ===
  const rlSig = _rlSignals[code];
  let rlVote = 0, rlConf = 0;
  if(rlSig){
    rlVote = rlSig.action === 1 ? 1 : rlSig.action === 2 ? -1 : 0;
    rlConf = rlSig.confidence || 0;
  }
  // === å¼•æ“3: å›æµ‹ä¿¡å· ===
  const btR = btResults[code];
  let btVote = 0, btConf = 0;
  if(btR){
    const rsi = btR.lastRSI || 50;
    const sharpe = btR.sharpe || 0;
    if(rsi < 40 && sharpe > 0){ btVote = 1; btConf = 70; }
    else if(rsi < 50 && sharpe > 0.5){ btVote = 1; btConf = 60; }
    else if(rsi > 75){ btVote = -1; btConf = 75; }
    else if(rsi > 65 && sharpe < 0){ btVote = -1; btConf = 65; }
    else { btVote = 0; btConf = 40; }
  }
  // === åŠ æƒæŠ•ç¥¨ ===
  const aiW = Math.min(aiConf, 95) / 100;
  const rlW = Math.min(rlConf, 95) / 100;
  const btW = Math.min(Math.abs(btR?.sharpe||0)/2, 0.8);
  const totalW = aiW + rlW + btW || 1;
  const score = (aiVote * aiW + rlVote * rlW + btVote * btW) / totalW;

  const votes = [aiVote, rlVote, btVote].filter(v => v !== 0);
  const buyVotes = votes.filter(v => v > 0).length;
  const sellVotes = votes.filter(v => v < 0).length;
  let consensusMult = 1.0;
  if(Math.max(buyVotes, sellVotes) >= 3) consensusMult = 1.4;
  else if(Math.max(buyVotes, sellVotes) >= 2 && votes.length >= 2) consensusMult = 1.15;
  else if(buyVotes > 0 && sellVotes > 0) consensusMult = 0.4;

  // ç»¼åˆå†³ç­–
  let action = 'hold', actionLabel = 'ğŸ”µ æŒæœ‰è§‚æœ›';
  const effConf = aiConf * consensusMult;
  if(score > 0.2 && effConf >= 55){ action = 'buy'; actionLabel = 'ğŸŸ¢ å»ºè®®åŠ ä»“'; }
  else if(score < -0.2 && effConf >= 50){ action = 'sell'; actionLabel = 'ğŸ”´ å»ºè®®å‡ä»“'; }
  else if(score > 0.1){ actionLabel = 'ğŸ”µ åå¤šæŒæœ‰'; }
  else if(score < -0.1){ actionLabel = 'ğŸ”µ åç©ºæŒæœ‰'; }

  // Kellyå»ºè®®ä»“ä½
  const kelly = btR?.finalKelly || 0.05;
  const adjKelly = Math.min(kelly * consensusMult, 0.25);

  return {
    action, actionLabel, score, consensusMult,
    buyVotes, sellVotes,
    ai: { vote: aiVote, conf: aiConf, reason: aiReason, label: aiVote>0?'ä¹°å…¥':aiVote<0?'å–å‡º':'æŒæœ‰' },
    rl: { vote: rlVote, conf: rlConf, label: rlSig?.actionName||'--' },
    bt: { vote: btVote, conf: btConf, sharpe: btR?.sharpe||0, rsi: btR?.lastRSI||50, maxDD: btR?.maxDD||0, winRate: btR?.winRate||0, kelly: adjKelly },
    effConf: Math.round(effConf),
  };
}

function renderActionGuide(){
  const container = document.getElementById('action-guide-container');
  const brief = document.getElementById('action-guide-brief');
  if(!container) return;

  if(holdings.length === 0){
    container.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon">ğŸ¯</div>æ·»åŠ æŒä»“åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä¸‰å¼•æ“é—­ç¯çš„å®ç›˜æ“ä½œå»ºè®®</div>';
    if(brief) brief.textContent = 'æ— æŒä»“';
    return;
  }

  // ä¸ºæ¯ä¸ªæŒä»“è®¡ç®—ä¸‰å¼•æ“æŠ•ç¥¨
  const plans = [];
  let totalBuy = 0, totalSell = 0, totalHold = 0;
  holdings.forEach(h => {
    const vote = getTriEngineVote(h.code);
    const fd = getFundData(h.code);
    const td = fundHistoryData[h.code]?.trend;
    plans.push({ code: h.code, fd, td, vote });
    if(vote.action === 'buy') totalBuy++;
    else if(vote.action === 'sell') totalSell++;
    else totalHold++;
  });

  // æ•´ä½“ç»„åˆè¯„åˆ† (0-100)
  const avgScore = plans.reduce((s,p) => s + p.vote.score, 0) / plans.length;
  const overallScore = Math.round(Math.max(0, Math.min(100, 50 + avgScore * 50)));
  const ds = _dataIntelLoaded ? generateDataSignal() : null;

  // æ•´ä½“å»ºè®®
  let overallAdvice = '', overallColor = '#94a3b8', overallLabel = 'ä¸­æ€§è§‚æœ›';
  if(overallScore >= 70){ overallLabel = 'ç§¯æåŠ ä»“'; overallColor = '#ef4444'; overallAdvice = 'ä¸‰å¼•æ“å¤šæ•°çœ‹å¤šï¼Œå¸‚åœºç¯å¢ƒåç§¯æã€‚å»ºè®®æŒ‰Kellyä»“ä½é€æ­¥åŠ ä»“çœ‹å¤šå“ç§ï¼Œæ§åˆ¶å•ç¬”ä¸è¶…ç»„åˆ5%ã€‚'; }
  else if(overallScore >= 58){ overallLabel = 'åå¤šæŒæœ‰'; overallColor = '#f59e0b'; overallAdvice = 'ä¿¡å·åæ­£é¢ï¼Œç»´æŒç°æœ‰ä»“ä½ä¸ºä¸»ã€‚å¯åœ¨å›è°ƒæ—¶å¯¹é«˜å…±è¯†å“ç§å°å¹…ä½å¸ï¼Œæ§åˆ¶èŠ‚å¥ã€‚'; }
  else if(overallScore >= 42){ overallLabel = 'ä¸­æ€§è§‚æœ›'; overallColor = '#94a3b8'; overallAdvice = 'ä¿¡å·åˆ†æ­§è¾ƒå¤§æˆ–æ•°æ®ä¸è¶³ã€‚å»ºè®®æŒæœ‰ä¸åŠ¨ï¼Œç­‰å¾…å¼•æ“ä¿¡å·è¶‹äºä¸€è‡´åå†è¡ŒåŠ¨ã€‚'; }
  else if(overallScore >= 30){ overallLabel = 'åç©ºè°¨æ…'; overallColor = '#f59e0b'; overallAdvice = 'éƒ¨åˆ†å¼•æ“çœ‹ç©ºã€‚å»ºè®®å…ˆå‡ä»“é«˜é£é™©å«æ˜Ÿä»“å“ç§ï¼Œä¿ç•™æ ¸å¿ƒä»“ã€‚æ–°èµ„é‡‘æš‚ä¸å…¥åœºã€‚'; }
  else { overallLabel = 'é˜²å¾¡å‡ä»“'; overallColor = '#22c55e'; overallAdvice = 'å¤šå¼•æ“çœ‹ç©ºã€‚å»ºè®®ä¸»åŠ¨å‡ä»“å«æ˜Ÿä»“ï¼Œå¢åŠ ç°é‡‘æ¯”ä¾‹ï¼Œç­‰å¾…å¸‚åœºä¼ç¨³ä¿¡å·ã€‚'; }
  if(ds) overallAdvice += ` [å®è§‚ç¯å¢ƒ: ${ds.label}(${ds.score})]`;

  // å¼•æ“æ€»æŠ•ç¥¨æ±‡æ€»
  const engAI = plans.filter(p => p.vote.ai.vote > 0).length;
  const engRL = plans.filter(p => p.vote.rl.vote > 0).length;
  const engBT = plans.filter(p => p.vote.bt.vote > 0).length;
  const engAISell = plans.filter(p => p.vote.ai.vote < 0).length;
  const engRLSell = plans.filter(p => p.vote.rl.vote < 0).length;
  const engBTSell = plans.filter(p => p.vote.bt.vote < 0).length;

  // Brief
  if(brief){
    const hasAnalysis = _analysisResult || _rlModelLoaded || btSummary;
    if(!hasAnalysis){
      brief.innerHTML = '<span style="color:var(--sub)">ç‚¹å‡»AIåˆ†æ</span>';
    } else {
      const briefColor = overallScore >= 58 ? 'var(--red)' : overallScore <= 42 ? 'var(--green)' : 'var(--sub)';
      brief.innerHTML = `<span style="color:${briefColor}">${overallLabel} ${overallScore}</span>`;
    }
  }

  let html = '';

  // 1. æ•´ä½“æ¦‚è§ˆå¡
  html += `<div class="ag-overview">`;
  html += `<div class="ag-score-row">`;
  html += `<div class="ag-big-score" style="color:${overallColor}">${overallScore}</div>`;
  html += `<div class="ag-score-meta"><div class="ag-score-label" style="color:${overallColor}">${overallLabel}</div>`;
  html += `<div class="ag-score-desc">ç»¼åˆè¯„åˆ†ï¼šAIä¿¡å·Ã—å›æµ‹éªŒè¯Ã—RLå†³ç­–Ã—å®è§‚æ•°æ®</div></div></div>`;

  // ä¸‰å¼•æ“æŠ•ç¥¨æ¦‚è§ˆ
  html += `<div class="ag-engines">`;
  html += `<div class="ag-engine"><div class="ag-engine-icon">ğŸ¤–</div><div class="ag-engine-name">AIåˆ†æ</div>`;
  html += `<div class="ag-engine-vote" style="color:${engAI>engAISell?'#f87171':engAISell>engAI?'#4ade80':'rgba(255,255,255,0.5)'}">${engAI}ä¹° ${engAISell}å–</div>`;
  html += `<div class="ag-engine-conf">${_analysisResult ? _analysisResult.engineCount+'å¼•æ“' : 'æœªåˆ†æ'}</div></div>`;

  html += `<div class="ag-engine"><div class="ag-engine-icon">ğŸ§ </div><div class="ag-engine-name">RLå¤§è„‘</div>`;
  html += `<div class="ag-engine-vote" style="color:${engRL>engRLSell?'#f87171':engRLSell>engRL?'#4ade80':'rgba(255,255,255,0.5)'}">${engRL}ä¹° ${engRLSell}å–</div>`;
  html += `<div class="ag-engine-conf">${_rlModelLoaded ? 'E'+(rlTrainer?.episode||0)+1 : 'æœªè®­ç»ƒ'}</div></div>`;

  html += `<div class="ag-engine"><div class="ag-engine-icon">ğŸ“ˆ</div><div class="ag-engine-name">å›æµ‹å¼•æ“</div>`;
  html += `<div class="ag-engine-vote" style="color:${engBT>engBTSell?'#f87171':engBTSell>engBT?'#4ade80':'rgba(255,255,255,0.5)'}">${engBT}ä¹° ${engBTSell}å–</div>`;
  html += `<div class="ag-engine-conf">${btSummary ? 'Sharpe '+btSummary.avgSharpe.toFixed(1) : 'æœªå›æµ‹'}</div></div>`;
  html += `</div>`;

  // æ•´ä½“å»ºè®®
  html += `<div class="ag-advice-bar"><b>ğŸ“Œ ä»Šæ—¥æ“ä½œå»ºè®®ï¼š</b>${overallAdvice}</div>`;
  html += `</div>`;

  // 2. é€åªåŸºé‡‘æ“ä½œå¡ç‰‡
  // æ’åºï¼šå–å‡ºä¼˜å…ˆ(é£æ§ä¼˜å…ˆ)ï¼Œç„¶åä¹°å…¥ï¼Œæœ€åæŒæœ‰
  const order = {sell: 0, buy: 1, hold: 2};
  plans.sort((a,b) => (order[a.vote.action]||2) - (order[b.vote.action]||2));

  plans.forEach(p => {
    const { code, fd, td, vote } = p;
    const todayPct = fd?.gszzl || 0;
    const pctColor = todayPct >= 0 ? 'var(--red)' : 'var(--green)';

    html += `<div class="ag-fund-card action-${vote.action}">`;
    html += `<div class="ag-fund-top">`;
    html += `<div><div class="ag-fund-name">${fundName(code)}</div><div class="ag-fund-code">${code} Â· ${fundType(code)} Â· ä»Šæ—¥ <span style="color:${pctColor}">${todayPct>=0?'+':''}${fmt(todayPct)}%</span></div></div>`;
    html += `<span class="ag-fund-action ${vote.action}">${vote.actionLabel}</span>`;
    html += `</div>`;

    // ä¸‰å¼•æ“æŠ•ç¥¨æ¡
    html += `<div class="ag-vote-strip">`;
    const mkChip = (name, v, conf) => {
      const cls = v > 0 ? 'bullish' : v < 0 ? 'bearish' : 'neutral';
      const txt = v > 0 ? 'ä¹°' : v < 0 ? 'å–' : 'æŒ';
      return `<span class="ag-vote-chip ${cls}">${name}:${txt}${conf>0?' '+conf+'%':''}</span>`;
    };
    html += mkChip('AI', vote.ai.vote, vote.ai.conf);
    html += mkChip('RL', vote.rl.vote, vote.rl.conf);
    html += mkChip('BT', vote.bt.vote, vote.bt.conf);
    // å…±è¯†æ ‡ç­¾
    if(vote.buyVotes >= 2 && vote.sellVotes === 0) html += `<span class="ag-vote-chip bullish">âœ“å…±è¯†çœ‹å¤šÃ—${vote.consensusMult.toFixed(1)}</span>`;
    else if(vote.sellVotes >= 2 && vote.buyVotes === 0) html += `<span class="ag-vote-chip bearish">âœ“å…±è¯†çœ‹ç©ºÃ—${vote.consensusMult.toFixed(1)}</span>`;
    else if(vote.buyVotes > 0 && vote.sellVotes > 0) html += `<span class="ag-vote-chip neutral">âš åˆ†æ­§Ã—${vote.consensusMult.toFixed(1)}</span>`;
    html += `</div>`;

    // æ“ä½œç†ç”±
    let reason = '';
    if(vote.action === 'buy'){
      reason = `å…±è¯†çœ‹å¤š(${vote.buyVotes}/3ç¥¨)`;
      if(vote.ai.conf > 0) reason += `ï¼ŒAIç½®ä¿¡${vote.ai.conf}%`;
      if(vote.bt.sharpe > 0) reason += `ï¼Œå›æµ‹Sharpe ${vote.bt.sharpe.toFixed(1)}è¡¨ç°ä¼˜`;
      if(td?.swingAdvice?.includes('ä¹°å…¥')) reason += `ï¼Œæ³¢æ®µä¿¡å·æ”¯æ’‘`;
      reason += `ã€‚å»ºè®®ç”¨æ€»ä»“ä½çš„${(vote.bt.kelly*100).toFixed(0)}%(Kelly)åˆ†æ‰¹åŠ ä»“`;
    } else if(vote.action === 'sell'){
      reason = `å…±è¯†åç©º(${vote.sellVotes}/3ç¥¨)`;
      if(vote.bt.rsi > 70) reason += `ï¼ŒRSI=${vote.bt.rsi.toFixed(0)}è¶…ä¹°åŒº`;
      if(vote.bt.sharpe < 0) reason += `ï¼Œå›æµ‹Sharpe ${vote.bt.sharpe.toFixed(1)}ä¸ä½³`;
      if(vote.bt.maxDD < -0.15) reason += `ï¼Œæœ€å¤§å›æ’¤${(vote.bt.maxDD*100).toFixed(0)}%è¾ƒé«˜`;
      reason += `ã€‚å»ºè®®å…ˆå‡30-50%ä»“ä½è½è¢‹`;
    } else {
      reason = 'ä¿¡å·æœªè¾¾å…±è¯†é˜ˆå€¼ï¼Œç»´æŒç°æœ‰ä»“ä½è§‚æœ›';
      if(vote.ai.conf > 0 && vote.ai.reason) reason += `ã€‚AIå‚è€ƒï¼š${vote.ai.reason.slice(0,50)}`;
    }
    html += `<div class="ag-reason">${reason}</div>`;

    // æ ¸å¿ƒæŒ‡æ ‡
    html += `<div class="ag-metrics">`;
    html += `<span class="ag-metric">å…±è¯† <b>${vote.effConf}%</b></span>`;
    html += `<span class="ag-metric">Sharpe <b style="color:${vote.bt.sharpe>0?'var(--red)':'var(--green)'}">${vote.bt.sharpe.toFixed(2)}</b></span>`;
    html += `<span class="ag-metric">RSI <b>${vote.bt.rsi.toFixed(0)}</b></span>`;
    html += `<span class="ag-metric">Kelly <b>${(vote.bt.kelly*100).toFixed(0)}%</b></span>`;
    html += `<span class="ag-metric">èƒœç‡ <b>${(vote.bt.winRate*100).toFixed(0)}%</b></span>`;
    if(td) html += `<span class="ag-metric">60æ—¥ <b style="color:${td.chg60d>=0?'var(--red)':'var(--green)'}">${td.chg60d>0?'+':''}${td.chg60d}%</b></span>`;
    html += `</div>`;

    // Kellyä»“ä½æ¡
    const kellyPct = Math.round(vote.bt.kelly * 100);
    html += `<div class="ag-position-bar">`;
    html += `<div class="ag-pos-label"><span>å»ºè®®ä»“ä½ (åŠKelly)</span><span>${Math.round(kellyPct/2)}%~${kellyPct}%</span></div>`;
    const barColor = vote.action === 'buy' ? 'var(--red)' : vote.action === 'sell' ? 'var(--green)' : 'var(--primary)';
    html += `<div class="ag-pos-track"><div class="ag-pos-fill" style="width:${Math.min(kellyPct, 100)}%;background:${barColor}"></div></div>`;
    html += `</div>`;

    html += `</div>`; // end ag-fund-card
  });

  // 3. æ‰§è¡Œæ‘˜è¦ & å¯¹æ¯”æ¨¡æ‹Ÿç›˜
  html += `<div class="ag-summary">`;
  html += `<div class="ag-summary-title">ğŸ“Š æ‰§è¡Œæ‘˜è¦</div>`;
  html += `<div class="ag-summary-text">`;
  html += `ä»Šæ—¥å»ºè®®ï¼š<b style="color:var(--red)">${totalBuy}åªåŠ ä»“</b> Â· <b style="color:var(--green)">${totalSell}åªå‡ä»“</b> Â· <b>${totalHold}åªæŒæœ‰</b><br>`;

  // ä¸æ¨¡æ‹Ÿç›˜ä»Šæ—¥æ“ä½œå¯¹æ¯”
  if(simPortfolio?.history){
    const today = todayStr();
    const todayTrades = simPortfolio.history.filter(h => h.date === today);
    if(todayTrades.length > 0){
      html += `<b>æ¨¡æ‹Ÿç›˜ä»Šæ—¥æ“ä½œï¼š</b>${todayTrades.length}ç¬” â€” `;
      todayTrades.slice(0,3).forEach(t => {
        html += `${t.action==='buy'?'ğŸŸ¢ä¹°':'ğŸ”´å–'}${fundName(t.code).slice(0,4)} `;
      });
      if(todayTrades.length > 3) html += `â€¦ç­‰${todayTrades.length}ç¬”`;
      html += '<br>';
    }
    const totalVal = getSimTotalValue();
    const cumR = (totalVal - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
    html += `æ¨¡æ‹Ÿç›˜ç´¯è®¡æ”¶ç›Š: <b style="color:${cumR>=0?'var(--red)':'var(--green)'}">${cumR>=0?'+':''}${cumR.toFixed(2)}%</b> â€” å¯å‚è€ƒæ¨¡æ‹Ÿç›˜éªŒè¯ä¸‰å¼•æ“ä¿¡å·å¯é æ€§<br>`;
  }

  html += `<br><b>âš ï¸ æ“ä½œåŸåˆ™ï¼š</b><br>`;
  html += `â‘  åˆ†æ‰¹æ‰§è¡Œï¼šå•æ¬¡æ“ä½œä¸è¶…æ€»ä»“ä½5%ï¼Œåˆ†2-3æ¬¡å®Œæˆ<br>`;
  html += `â‘¡ æ ¸å¿ƒä»“ä¼˜å…ˆï¼šæ ¸å¿ƒä»“(å®½åŸº/å€ºåŸº)ä¿æŒ60%åº•ä»“ï¼Œå«æ˜Ÿä»“çµæ´»è°ƒæ•´<br>`;
  html += `â‘¢ ä¿¡å·åˆ†æ­§æ—¶ä¸åŠ¨ï¼šå¼•æ“æŠ•ç¥¨<2ç¥¨ä¸€è‡´æ—¶ï¼Œè§‚æœ›ä¸ºä¸»<br>`;
  html += `â‘£ æ­¢æŸä¼˜å…ˆï¼šä»»ä½•å“ç§äºæŸè¶…5%ç«‹å³å‡ä»“ï¼Œä¸ç­‰ä¿¡å·`;
  html += `</div></div>`;

  html += `<div class="ag-disclaimer">âš ï¸ ä»¥ä¸Šå»ºè®®åŸºäºAI/RL/å›æµ‹ä¸‰å¼•æ“é‡åŒ–åˆ†æï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚</div>`;

  container.innerHTML = html;
}

function renderSignals(){
  const container = document.getElementById('signals-container');
  const badge = document.getElementById('signal-badge');

  if(holdings.length===0){
    container.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“¥</div>æ·»åŠ æŒä»“åï¼ŒAIä¼šç»™å‡ºä»Šæ—¥æ“ä½œå»ºè®®</div>';
    badge.textContent = 'æ— æŒä»“';
    return;
  }

  if(!_analysisResult){
    let html = '';
    holdings.forEach((h,i)=>{
      const f = getFundData(h.code);
      html += `<div class="signal-card hold">
        <div class="signal-top">
          <div class="signal-fund">
            <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="åˆ é™¤">âœ•</button></div>
            <div class="signal-code">${h.code} Â· ${fundType(h.code)}</div>
          </div>
          <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
        </div>
        <div style="font-size:11px;color:var(--sub)">ç‚¹å‡»ã€Œä¸€é”®AIåˆ†æã€è·å–æ“ä½œå»ºè®®</div>
      </div>`;
    });
    container.innerHTML = html;
    badge.textContent = 'ç­‰å¾…åˆ†æ';
    return;
  }

  const r = _analysisResult;
  badge.textContent = `${r.engineCount}å¼•æ“ Â· ${r.timestamp}`;

  let html = '';
  holdings.forEach((h,i)=>{
    const f = getFundData(h.code);
    const sig = r.signals[h.code];
    if(!sig){
      html += `<div class="signal-card hold">
        <div class="signal-top">
          <div class="signal-fund">
            <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="åˆ é™¤">âœ•</button></div>
            <div class="signal-code">${h.code}</div>
          </div>
          <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
        </div>
        <div style="font-size:11px;color:var(--sub)">AIæœªè¿”å›è¯¥åŸºé‡‘åˆ†æ</div>
      </div>`;
      return;
    }

    const actionText = sig.action==='buy'?'ğŸŸ¢ åŠ ä»“':sig.action==='sell'?'ğŸ”´ å‡ä»“':'âšª æŒæœ‰';
    const urgencyText = sig.urgency==='today'?'ä»Šæ—¥æ“ä½œ':sig.urgency==='this_week'?'æœ¬å‘¨å†…':'ä¸æ€¥';
    const confClass = sig.confidence>=75?'high':sig.confidence>=55?'mid':'low';
    const posLabel = sig.posType==='core'?'ğŸ›¡ï¸æ ¸å¿ƒä»“':'ğŸš€å«æ˜Ÿä»“';
    const posColor = sig.posType==='core'?'background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5':'background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4';
    const trendIcon = sig.trend==='up'?'ğŸ“ˆè¶‹åŠ¿â†‘':sig.trend==='down'?'ğŸ“‰è¶‹åŠ¿â†“':'ğŸ“Šéœ‡è¡';
    const trendColor = sig.trend==='up'?'color:var(--green)':sig.trend==='down'?'color:var(--red)':'color:var(--sub)';

    // æ„å»ºè¶‹åŠ¿è¯¦æƒ…è¡Œï¼ˆå¦‚æœæœ‰çœŸå®å†å²æ•°æ®ï¼‰
    let trendDetailHtml = '';
    const td = sig.trendDetail;
    if(td){
      const mkSpan = (label, val, suffix='%') => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span style="color:${c}">${label}${val>0?'+':''}${val}${suffix}</span>`;
      };
      trendDetailHtml = `<div style="display:flex;gap:8px;flex-wrap:wrap;font-size:10px;padding:4px 0;border-top:1px solid var(--border);margin-top:4px">
        ${mkSpan('5æ—¥:', td.chg5d)} ${mkSpan('20æ—¥:', td.chg20d)} ${mkSpan('60æ—¥:', td.chg60d)} ${mkSpan('å¹´:', td.chg250d)}
        <span style="color:var(--sub)">è·é«˜ç‚¹:${td.drawdownFromHigh}%</span>
      </div>`;
      if(td.swingAdvice){
        const advColor = td.swingAdvice.includes('ä¹°å…¥') ? 'var(--red)' : td.swingAdvice.includes('å‡ä»“') ? 'var(--green)' : 'var(--sub)';
        trendDetailHtml += `<div style="font-size:10px;color:${advColor};padding:2px 0">âš¡ ${td.swingAdvice}</div>`;
      }
    }

    html += `<div class="signal-card ${sig.action}">
      <div class="signal-top">
        <div class="signal-fund">
          <div class="signal-name">${fundName(h.code)} <button class="hold-del" onclick="removeHolding(${i})" title="åˆ é™¤">âœ•</button></div>
          <div class="signal-code">${h.code} Â· ${fundType(h.code)}${sig.target3m?' Â· 3æœˆé¢„æœŸ:'+sig.target3m:''}</div>
        </div>
        <div class="signal-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px">
        <span class="signal-action ${sig.action}">${actionText}</span>
        <span class="signal-urgency ${sig.urgency==='today'?'high':sig.urgency==='this_week'?'medium':'low'}">${urgencyText}</span>
        <span style="font-size:10px;padding:1px 6px;border-radius:4px;${posColor}">${posLabel}</span>
        <span style="font-size:10px;${trendColor}">${trendIcon}</span>
      </div>
      <div class="conf-bar">
        <span class="conf-text">ç½®ä¿¡åº¦</span>
        <div class="conf-track"><div class="conf-fill ${confClass}" style="width:${sig.confidence}%"></div></div>
        <span class="conf-text" style="text-align:right;font-weight:600">${sig.confidence}%</span>
      </div>
      <div class="signal-reason">${sig.reason}</div>
      ${trendDetailHtml}
      <div class="signal-engines">${sig.breakdown}</div>
    </div>`;
  });

  container.innerHTML = html;
}

function renderWatchlist(){
  const section = document.getElementById('watchlist-section');
  const container = document.getElementById('watchlist-container');
  if(watchlist.length===0){ section.style.display='none'; return; }
  section.style.display='';

  let html = '';
  watchlist.forEach((w,i)=>{
    const f = getFundData(w.code);
    const sig = _analysisResult?.signals[w.code];
    const sigText = sig ? (sig.action==='buy'?'å»ºè®®ä¹°å…¥':sig.action==='sell'?'æš‚ä¸å»ºè®®':'å¯å…³æ³¨') : '';
    const sigColor = sig ? (sig.action==='buy'?'background:var(--green-bg);color:var(--green)':sig.action==='sell'?'background:var(--red-bg);color:var(--red)':'background:var(--gray-bg);color:var(--sub)') : '';
    const wTrend = fundHistoryData[w.code]?.trend;
    const trendBrief = wTrend ? ` Â· ${wTrend.trendDir==='strong_up'||wTrend.trendDir==='up'?'ğŸ“ˆ':'ğŸ“‰'}60æ—¥${wTrend.chg60d>0?'+':''}${wTrend.chg60d}%` : '';

    html += `<div class="watch-item">
      <div class="watch-left">
        <div class="watch-name">${fundName(w.code)} <span style="font-size:10px;color:var(--sub)">${w.code}</span></div>
        <div class="watch-type">${fundType(w.code)}${trendBrief}${sig?.target3m?' Â· 3æœˆ:'+sig.target3m:''}</div>
      </div>
      <span class="watch-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</span>
      ${sigText?`<span class="watch-signal" style="${sigColor}">${sigText}</span>`:''}
      <button class="watch-del" onclick="removeWatch(${i})">âœ•</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderRecos(){
  const section = document.getElementById('reco-section');
  const container = document.getElementById('reco-container');
  if(!_analysisResult || !_analysisResult.picks || _analysisResult.picks.length===0){
    section.style.display='none';
    return;
  }
  section.style.display='';

  let html = '';
  _analysisResult.picks.forEach(p=>{
    const reco = RECO_FUND_POOL.find(f=>f.code===p.code);
    html += `<div class="reco-card">
      <div class="reco-info">
        <div class="reco-name">${p.name||reco?.name||p.code}</div>
        <div class="reco-meta">${p.type||reco?.type||''} Â· ${p.endorsements}/${_analysisResult.engineCount}å¼•æ“æ¨è</div>
        <div class="reco-meta">${p.reason||''}</div>
      </div>
      ${p.expected3m?`<div class="reco-expect">${p.expected3m}</div>`:''}
      <button class="reco-add" onclick="addToWatchFromReco('${p.code}','${(p.name||reco?.name||'').replace(/'/g,"\\'")}','${p.type||reco?.type||''}')">+ è‡ªé€‰</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderMarketSummary(){
  const section = document.getElementById('market-summary-section');
  const container = document.getElementById('market-summary');
  if(!_analysisResult?.marketSummary){ section.style.display='none'; return; }
  section.style.display='';

  const pa = _analysisResult.portfolioAdvice;
  const portHtml = pa ? `<div style="margin-top:10px;padding:10px 14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0">
    <b style="font-size:12px;color:#1e293b">ğŸ’¼ ä»“ä½å»ºè®®</b><br>
    <span style="display:inline-flex;align-items:center;gap:6px;margin:6px 0"><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5">ğŸ›¡ï¸æ ¸å¿ƒä»“ ${pa.coreRatio||'60%'}</span>
    <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4">ğŸš€å«æ˜Ÿä»“ ${pa.satRatio||'40%'}</span></span><br>
    <span style="font-size:11px;color:#475569;line-height:1.5">${pa.advice||''}</span>
  </div>` : '';

  container.innerHTML = `<div class="market-summary">
    <b>ğŸ“ˆ å¸‚åœºç ”åˆ¤</b><span class="provider-tag">${_aiProvider.name}</span><br>
    ${_analysisResult.marketSummary}
    ${_analysisResult.benchmarkView?`<br><b>æ²ªæ·±300å±•æœ›ï¼š</b>${_analysisResult.benchmarkView}`:''}
    ${portHtml}
  </div>`;
}

// ==================== UI ACTIONS ====================
async function triggerAI(){
  if(_analyzing) return;
  if(!_aiKey){ alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key'); return; }
  if(holdings.length===0 && watchlist.length===0){ alert('è¯·å…ˆæ·»åŠ æŒä»“æˆ–è‡ªé€‰åŸºé‡‘'); return; }

  const btn = document.getElementById('ai-btn');
  const progress = document.getElementById('ai-progress');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-sm"></span> AIåˆ†æä¸­...';

  try {
    _analysisResult = await runAIAnalysis((msg, count)=>{
      progress.textContent = msg;
    });
    progress.textContent = `âœ… ${_analysisResult.engineCount}ä¸ªå¼•æ“åˆ†æå®Œæˆ`;
    saveTodayPredictions();
    // æ¨¡æ‹Ÿç›˜è‡ªåŠ¨äº¤æ˜“
    const simTrades = simAutoTrade();
    updateSimDaily();
    renderMarketSummary();
    renderActionGuide();
    renderSignals();
    renderWatchlist();
    renderRecos();
    renderReview();
    renderSimPortfolio();
    if(simTrades > 0) progress.textContent += ` Â· æ¨¡æ‹Ÿç›˜æ‰§è¡Œ${simTrades}ç¬”äº¤æ˜“`;
  } catch(e) {
    progress.textContent = `âŒ ${e.message}`;
  } finally {
    _analyzing = false;
    btn.disabled = false;
    btn.innerHTML = 'ğŸ§  ä¸€é”®AIåˆ†æ Â· 4å¼•æ“ç ”åˆ¤';
  }
}

let _selectedFund = null; // {code, name}
let _searchTimer = null;

function openAddModal(mode){
  _addMode = mode;
  _selectedFund = null;
  document.getElementById('add-modal').style.display = 'flex';
  document.getElementById('add-modal-title').innerHTML = (mode==='holding'?'â• æ·»åŠ æŒä»“':'â• æ·»åŠ è‡ªé€‰') + ' <button onclick="closeAddModal()">âœ•</button>';
  document.getElementById('add-search-area').style.display = '';
  document.getElementById('add-selected-area').style.display = 'none';
  document.getElementById('add-search-input').value = '';
  document.getElementById('add-search-results').innerHTML = '';
  document.getElementById('add-search-hint').style.display = '';
  setTimeout(()=>document.getElementById('add-search-input').focus(), 100);
}

function closeAddModal(){ document.getElementById('add-modal').style.display='none'; _selectedFund=null; }

function onFundSearchInput(){
  const q = (document.getElementById('add-search-input').value||'').trim();
  const resultsEl = document.getElementById('add-search-results');
  const hintEl = document.getElementById('add-search-hint');

  if(q.length === 0){
    resultsEl.innerHTML = '';
    hintEl.style.display = '';
    hintEl.textContent = 'è¾“å…¥åŸºé‡‘ä»£ç ï¼ˆå¦‚ 000216ï¼‰æˆ–å…³é”®è¯ï¼ˆå¦‚ã€Œé»„é‡‘ã€ï¼‰æœç´¢';
    return;
  }
  hintEl.style.display = 'none';

  // å…ˆæœæœ¬åœ°
  const localResults = searchLocalFunds(q);
  if(localResults.length > 0){
    renderSearchResults(localResults);
  }

  // å¦‚æœæ˜¯çº¯æ•°å­—ä¸”é•¿åº¦>=3ï¼Œåœ¨çº¿æœç´¢
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(async ()=>{
    if(/^\d{3,6}$/.test(q)){
      // æ•°å­—ä»£ç ï¼šä¼˜å…ˆç”¨æœç´¢æ¥å£ï¼ˆç‹¬ç«‹å›è°ƒï¼Œä¸é˜»å¡ï¼‰
      if(localResults.length===0) resultsEl.innerHTML = '<div class="fund-search-hint">ğŸ” æ­£åœ¨æŸ¥è¯¢...</div>';
      try {
        const results = [];
        // æœç´¢æ¥å£ï¼ˆç‹¬ç«‹å›è°ƒåï¼Œæ— å†²çªï¼‰ä½œä¸ºä¸»è¦æ¥æº
        const sugResults = await searchFundsOnline(q);
        if(sugResults.length > 0) results.push(...sugResults);
        // å¦‚æœæœç´¢æ¥å£æ²¡è¿”å›ç»“æœä¸”æ˜¯å®Œæ•´6ä½ï¼Œå†å°è¯•ä¼°å€¼æ¥å£
        if(results.length === 0 && q.length === 6){
          try {
            const d = await fetchFundEstimate(q);
            if(d && d.name) results.push({code:q, name:d.name, source:'online'});
          } catch(e){}
        }
        if(results.length > 0){
          renderSearchResults(dedupeResults(results, localResults));
        } else if(localResults.length===0){
          resultsEl.innerHTML = '<div class="fund-search-hint">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„åŸºé‡‘ï¼Œè¯·æ£€æŸ¥ä»£ç </div>';
        }
      } catch(e){
        if(localResults.length===0) resultsEl.innerHTML = '<div class="fund-search-hint">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„åŸºé‡‘</div>';
      }
    } else if(q.length >= 2){
      // å…³é”®å­—æœç´¢ â€” å°è¯•åœ¨çº¿æ¨¡ç³Šæœç´¢
      try {
        const onlineResults = await searchFundsOnline(q);
        if(onlineResults.length > 0){
          const merged = dedupeResults(onlineResults, localResults);
          renderSearchResults(merged);
        } else if(localResults.length===0){
          resultsEl.innerHTML = '<div class="fund-search-hint">æœªæ‰¾åˆ°åŒ¹é…çš„åŸºé‡‘ï¼Œè¯•è¯•è¾“å…¥å®Œæ•´6ä½ä»£ç </div>';
        }
      } catch(e) { /* keep local results */ }
    }
  }, 400);
}

function searchLocalFunds(q){
  const ql = q.toLowerCase();
  const all = [...FUND_DB, ...RECO_FUND_POOL];
  const seen = new Set();
  return all.filter(f=>{
    if(seen.has(f.code)) return false;
    seen.add(f.code);
    return f.code.includes(ql) || (f.name||'').toLowerCase().includes(ql) || (f.type||'').toLowerCase().includes(ql);
  }).slice(0, 20).map(f=>({code:f.code, name:f.name, type:f.type, source:'local'}));
}

function searchFundsOnline(keyword){
  return new Promise((resolve)=>{
    const cbName = '_fundSearchCb_' + Date.now();
    const script = document.createElement('script');
    const timer = setTimeout(()=>{ cleanup(); resolve([]); }, 5000);
    window[cbName] = function(data){
      clearTimeout(timer);
      cleanup();
      try {
        const items = (data && data.Datas) ? data.Datas : [];
        resolve(items.slice(0, 20).map(d=>({
          code: d.CODE || d.code || '',
          name: d.NAME || d.name || '',
          source: 'online'
        })).filter(d=>d.code && d.code.length===6));
      } catch(e){ resolve([]); }
    };
    script.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?callback=${cbName}&m=1&key=${encodeURIComponent(keyword)}`;
    script.onerror = ()=>{ clearTimeout(timer); cleanup(); resolve([]); };
    document.head.appendChild(script);
    function cleanup(){ try{delete window[cbName]; script.remove();}catch(e){} }
  });
}

function dedupeResults(primary, secondary){
  const codes = new Set(primary.map(f=>f.code));
  return [...primary, ...secondary.filter(f=>!codes.has(f.code))].slice(0,20);
}

function renderSearchResults(results){
  const el = document.getElementById('add-search-results');
  if(!results || results.length===0){ el.innerHTML=''; return; }
  el.innerHTML = results.map(f=>{
    const typeTag = f.type ? `<span class="fund-result-type">${f.type}</span>` : '';
    return `<div class="fund-result-item" onclick="selectFundResult('${f.code}','${(f.name||'').replace(/'/g,"\\'")}')"><span class="fund-result-code">${f.code}</span><span class="fund-result-name">${f.name||''}</span>${typeTag}</div>`;
  }).join('');
}

function selectFundResult(code, name){
  _selectedFund = {code, name};
  // åˆ‡åˆ°å·²é€‰ä¸­çŠ¶æ€
  document.getElementById('add-search-area').style.display = 'none';
  document.getElementById('add-selected-area').style.display = '';
  document.getElementById('add-sel-code').textContent = code;
  document.getElementById('add-sel-name').textContent = name;
  // è‡ªåŠ¨é€‰ç±»å‹
  const localMatch = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
  const type = localMatch?.type || guessFundType(name);
  autoSelectType(type);
}

function clearFundSelection(){
  _selectedFund = null;
  document.getElementById('add-search-area').style.display = '';
  document.getElementById('add-selected-area').style.display = 'none';
  document.getElementById('add-search-input').focus();
}

function guessFundType(name){
  if(!name) return 'å…¶ä»–';
  const n = name.toLowerCase();
  if(n.includes('é»„é‡‘') || n.includes('è´µé‡‘å±')) return 'é»„é‡‘';
  if(n.includes('åŠå¯¼ä½“') || n.includes('èŠ¯ç‰‡')) return 'åŠå¯¼ä½“';
  if(n.includes('å†›å·¥') || n.includes('å›½é˜²')) return 'å†›å·¥';
  if(n.includes('çº¢åˆ©') || n.includes('é«˜è‚¡æ¯')) return 'çº¢åˆ©';
  if(n.includes('æ–°èƒ½æº') || n.includes('å…‰ä¼') || n.includes('ç”µæ± ')) return 'æ–°èƒ½æº';
  if(n.includes('æ¶ˆè´¹') || n.includes('ç™½é…’') || n.includes('é£Ÿå“')) return 'æ¶ˆè´¹';
  if(n.includes('åŒ»è¯') || n.includes('åŒ»ç–—') || n.includes('åˆ›æ–°è¯')) return 'åŒ»è¯';
  if(n.includes('æœ‰è‰²') || n.includes('é“œ') || n.includes('é“')) return 'æœ‰è‰²é‡‘å±';
  if(n.includes('äººå·¥æ™ºèƒ½') || n.includes('ai') || n.includes('äº‘è®¡ç®—') || n.includes('ç§‘æŠ€') || n.includes('ä¿¡æ¯')) return 'AI/ç§‘æŠ€';
  if(n.includes('çº³æ–¯è¾¾å…‹') || n.includes('æ ‡æ™®') || n.includes('ç¾å›½') || n.includes('qdii') || n.includes('æµ·å¤–')) return 'QDII';
  if(n.includes('300') || n.includes('500') || n.includes('æ²ªæ·±') || n.includes('ä¸­è¯') || n.includes('åˆ›ä¸šæ¿') || n.includes('ä¸Šè¯')) return 'å®½åŸº';
  return 'å…¶ä»–';
}

function autoSelectType(type){
  const sel = document.getElementById('add-type');
  for(let i=0;i<sel.options.length;i++){
    if(sel.options[i].value===type){ sel.selectedIndex=i; break; }
  }
}

function confirmAdd(){
  if(!_selectedFund || !_selectedFund.code){ alert('è¯·å…ˆæœç´¢å¹¶é€‰æ‹©ä¸€ä¸ªåŸºé‡‘'); return; }
  const code = _selectedFund.code;
  const name = _selectedFund.name || code;
  const type = document.getElementById('add-type').value || 'å…¶ä»–';

  if(_addMode==='holding'){
    if(holdings.find(h=>h.code===code)){ alert('å·²å­˜åœ¨è¯¥æŒä»“'); return; }
    // å¦‚æœå·²åœ¨è‡ªé€‰ä¸­ï¼Œè‡ªåŠ¨ç§»é™¤ï¼ˆæŒä»“ä¼˜å…ˆçº§æ›´é«˜ï¼‰
    const wIdx = watchlist.findIndex(w=>w.code===code);
    if(wIdx>=0){ watchlist.splice(wIdx,1); saveWatchlist(); }
    holdings.push({code, name, type});
    saveHoldings();
  } else {
    if(holdings.find(h=>h.code===code)){ alert('è¯¥åŸºé‡‘å·²åœ¨æŒä»“ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ åˆ°è‡ªé€‰'); return; }
    if(watchlist.find(w=>w.code===code)){ alert('å·²å­˜åœ¨è¯¥è‡ªé€‰'); return; }
    watchlist.push({code, name, type});
    saveWatchlist();
  }

  closeAddModal();
  _analysisResult = null; // Clear old analysis
  loadData();
  // å¦‚æœç®¡ç†é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°åˆ—è¡¨
  if(document.getElementById('manage-overlay').style.display==='block'){
    renderManageList();
  }
}

function removeHolding(idx){
  if(!confirm(`ç¡®è®¤åˆ é™¤æŒä»“ã€Œ${holdings[idx]?.name||holdings[idx]?.code}ã€ï¼Ÿ`)) return;
  holdings.splice(idx,1);
  saveHoldings();
  _analysisResult = null;
  renderAll();
}

function removeWatch(idx){
  watchlist.splice(idx,1);
  saveWatchlist();
  renderWatchlist();
}

function addToWatchFromReco(code, name, type){
  if(watchlist.find(w=>w.code===code)){ alert('å·²åœ¨è‡ªé€‰ä¸­'); return; }
  watchlist.push({code, name, type});
  saveWatchlist();
  renderWatchlist();
}

// ==================== MANAGE PANEL ====================
let _manageTab = 'holding';

function openManagePanel(tab){
  _manageTab = tab || 'holding';
  document.getElementById('manage-overlay').style.display = 'block';
  document.getElementById('manage-search').value = '';
  switchManageTab(_manageTab);
}

function closeManagePanel(){
  document.getElementById('manage-overlay').style.display = 'none';
}

function switchManageTab(tab){
  _manageTab = tab;
  document.getElementById('manage-tab-holding').classList.toggle('active', tab==='holding');
  document.getElementById('manage-tab-watch').classList.toggle('active', tab==='watch');
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;
  document.getElementById('manage-search').placeholder = tab==='holding' ? 'ğŸ” æœç´¢æŒä»“åŸºé‡‘...' : 'ğŸ” æœç´¢è‡ªé€‰åŸºé‡‘...';
  renderManageList();
}

function renderManageList(){
  const body = document.getElementById('manage-body');
  const query = (document.getElementById('manage-search').value||'').trim().toLowerCase();
  const list = _manageTab==='holding' ? holdings : watchlist;
  const emptyIcon = _manageTab==='holding' ? 'ğŸ’¼' : 'ğŸ‘';
  const emptyLabel = _manageTab==='holding' ? 'æŒä»“' : 'è‡ªé€‰';

  // æ›´æ–°è®¡æ•°
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;

  if(list.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">${emptyIcon}</div>
      <div class="manage-empty-text">æš‚æ— ${emptyLabel}åŸºé‡‘</div>
      <button class="manage-add-btn" onclick="openAddModal('${_manageTab}')" style="margin:0 auto;display:block">+ æ·»åŠ ${emptyLabel}</button>
    </div>`;
    return;
  }

  // è¿‡æ»¤
  const filtered = list.filter((item,i)=>{
    if(!query) return true;
    const name = (fundName(item.code)||'').toLowerCase();
    return item.code.includes(query) || name.includes(query) || (item.name||'').toLowerCase().includes(query) || (item.type||'').toLowerCase().includes(query);
  });

  if(filtered.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">ğŸ”</div>
      <div class="manage-empty-text">æœªæ‰¾åˆ°åŒ¹é… "${query}" çš„åŸºé‡‘</div>
    </div>`;
    return;
  }

  let html = `<div style="font-size:10px;color:var(--sub);padding:4px 2px 8px">å…± ${filtered.length} åª${emptyLabel}åŸºé‡‘${query?' (æœç´¢ç»“æœ)':''}</div>`;

  filtered.forEach((item) => {
    const idx = list.indexOf(item);
    const fd = getFundData(item.code);
    const pctVal = parseFloat(fd?.gszzl) || 0;
    const pctColor = pctVal >= 0 ? 'var(--red)' : 'var(--green)';
    const pctSign = pctVal >= 0 ? '+' : '';
    const navVal = fd?.gsz || fd?.dwjz || '--';
    const navLabel = fd?._live ? 'å®æ—¶ä¼°å€¼' : 'å‡€å€¼';
    const name = fundName(item.code);
    const type = fundType(item.code);

    // è¶‹åŠ¿æ•°æ®
    const trend = fundHistoryData[item.code]?.trend;
    let trendHtml = '';
    if(trend){
      const mk = (label, val) => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span><span style="color:var(--sub)">${label}</span><span style="color:${c};font-weight:600">${val>0?'+':''}${val}%</span></span>`;
      };
      trendHtml = `<div class="manage-fund-trend">
        ${mk('5æ—¥', trend.chg5d)} ${mk('20æ—¥', trend.chg20d)} ${mk('60æ—¥', trend.chg60d)}
        <span><span style="color:var(--sub)">è·é«˜ç‚¹</span><span style="color:var(--green);font-weight:600">${trend.drawdownFromHigh}%</span></span>
      </div>`;
    }

    // æ“ä½œæŒ‰é’®
    let actionsHtml = '';
    if(_manageTab === 'holding'){
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToWatch(${idx})">â†’ ç§»è‡³è‡ªé€‰</button>
        <button class="manage-action-btn danger" onclick="removeFromManage('holding',${idx})">ğŸ—‘ åˆ é™¤</button>
      </div>`;
    } else {
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToHolding(${idx})">â†’ ç§»è‡³æŒä»“</button>
        <button class="manage-action-btn danger" onclick="removeFromManage('watch',${idx})">ğŸ—‘ åˆ é™¤</button>
      </div>`;
    }

    html += `<div class="manage-fund">
      <div class="manage-fund-top">
        <div class="manage-fund-info">
          <div class="manage-fund-name">${name}</div>
          <div class="manage-fund-meta">
            <span>${item.code}</span>
            <span class="manage-fund-type">${type}</span>
            <span>${navLabel}: ${typeof navVal==='number'?navVal.toFixed(4):navVal}</span>
          </div>
        </div>
        <div class="manage-fund-right">
          <div>
            <div class="manage-fund-pct" style="color:${pctColor}">${pctSign}${pctVal.toFixed(2)}%</div>
            <div class="manage-fund-nav">${fd?.gztime||''}</div>
          </div>
          <button class="manage-fund-del" onclick="removeFromManage('${_manageTab}',${idx})" title="åˆ é™¤">ğŸ—‘</button>
        </div>
      </div>
      ${trendHtml}
      ${actionsHtml}
    </div>`;
  });

  body.innerHTML = html;
}

function removeFromManage(type, idx){
  const list = type==='holding' ? holdings : watchlist;
  const item = list[idx];
  const label = type==='holding' ? 'æŒä»“' : 'è‡ªé€‰';
  if(!item) return;
  if(!confirm(`ç¡®è®¤åˆ é™¤${label}ã€Œ${item.name||fundName(item.code)||item.code}ã€ï¼Ÿ`)) return;

  list.splice(idx, 1);
  if(type==='holding'){
    saveHoldings();
    _analysisResult = null;
    renderAll();
  } else {
    saveWatchlist();
    renderWatchlist();
  }
  renderManageList();
}

function moveToWatch(holdingIdx){
  const item = holdings[holdingIdx];
  if(!item) return;
  if(watchlist.find(w=>w.code===item.code)){
    alert('è¯¥åŸºé‡‘å·²åœ¨è‡ªé€‰ä¸­');
    return;
  }
  holdings.splice(holdingIdx, 1);
  watchlist.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

function moveToHolding(watchIdx){
  const item = watchlist[watchIdx];
  if(!item) return;
  if(holdings.find(h=>h.code===item.code)){
    alert('è¯¥åŸºé‡‘å·²åœ¨æŒä»“ä¸­');
    return;
  }
  watchlist.splice(watchIdx, 1);
  holdings.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

// Settings
function openSettings(){
  document.getElementById('settings-modal').style.display = 'flex';
  document.getElementById('input-key').value = _aiKey || '';
  let phtml = '';
  AI_PROVIDERS.forEach(p=>{
    const sel = p.id===_aiProviderId;
    phtml += `<div onclick="selectProvider('${p.id}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:2px solid ${sel?'var(--primary)':'var(--border)'};border-radius:10px;margin-bottom:6px;cursor:pointer;background:${sel?'var(--primary-bg)':'white'};transition:all .2s">
      <div style="flex:1">
        <div style="font-weight:600;font-size:12px">${p.name} ${p.free?'<span style="font-size:9px;background:#22c55e;color:white;padding:1px 5px;border-radius:3px">å…è´¹</span>':''}</div>
        <div style="font-size:9px;color:var(--sub);margin-top:2px">${p.desc}</div>
      </div>
      <div style="width:18px;height:18px;border-radius:50%;border:2px solid ${sel?'var(--primary)':'#ccc'};display:flex;align-items:center;justify-content:center">
        ${sel?'<div style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>':''}
      </div>
    </div>`;
  });
  document.getElementById('provider-list').innerHTML = phtml;
  document.getElementById('provider-hint').innerHTML = `åœ¨ <a href='${_aiProvider.link}' target='_blank' style='color:var(--primary)'>${_aiProvider.name}</a> è·å–Key${_aiProvider.free?' (å…è´¹)':''}`;
  let ehtml = '';
  AI_ENGINES.forEach(eng=>{
    ehtml += `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${eng.icon}</span>
      <span style="flex:1;font-weight:500">${eng.name}</span>
      <span style="font-size:10px;color:var(--primary);background:var(--primary-bg);padding:1px 6px;border-radius:4px">${eng.model}</span>
    </div>`;
  });
  document.getElementById('engine-list').innerHTML = ehtml;
}
function selectProvider(id){ saveProvider(id); openSettings(); }
function closeSettings(){ document.getElementById('settings-modal').style.display='none'; }
function saveSettings(){
  const key = document.getElementById('input-key').value.trim();
  if(!key){ alert('è¯·è¾“å…¥API Key'); return; }
  saveKey(key);
  closeSettings();
  alert(`å·²ä¿å­˜ï¼å½“å‰: ${_aiProvider.name}`);
}
function toggleKeyVis(){
  const inp = document.getElementById('input-key');
  inp.type = inp.type==='password'?'text':'password';
}
function clearAllData(){
  if(!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ(æŒä»“ã€è‡ªé€‰ã€åˆ†æç»“æœç­‰)')) return;
  localStorage.removeItem('fa_holdings');
  localStorage.removeItem('fa_watchlist');
  localStorage.removeItem('fa_lastAnalysis');
  localStorage.removeItem('fa_lastReco');
  localStorage.removeItem('fa_daily_log');
  localStorage.removeItem('fa_sim_portfolio');
  location.reload();
}

// ==================== DAILY REVIEW SYSTEM ====================
// ä¿å­˜ä»Šæ—¥AIé¢„æµ‹å¿«ç…§
function saveTodayPredictions(){
  if(!_analysisResult || !_analysisResult.signals) return;
  const today = todayStr();

  // è®°å½•ä»Šæ—¥æ¯åªåŸºé‡‘çš„é¢„ä¼°æ¶¨è·Œ + é¢„æµ‹ä¿¡å·
  const pnl = {};
  const predictions = {};
  const allCodes = [...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)];
  allCodes.forEach(code=>{
    const f = getFundData(code);
    pnl[code] = +(f.gszzl||0).toFixed(2);
    const sig = _analysisResult.signals[code];
    if(sig){
      predictions[code] = {
        action: sig.action,
        confidence: sig.confidence,
        trend: sig.trend,
        reason: (sig.reason||'').slice(0,80),
        posType: sig.posType||''
      };
    }
  });

  // æŒä»“å¹³å‡ç›ˆäº
  let avgPnl = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{ avgPnl += (pnl[h.code]||0); });
    avgPnl = +(avgPnl/holdings.length).toFixed(2);
  }

  // æ²ªæ·±300
  const hs300 = getIndexData(INDICES_CONFIG[3]);

  // æ›´æ–°æˆ–æ–°å¢ä»Šæ—¥è®°å½•
  const idx = dailyLog.findIndex(d=>d.date===today);
  const entry = {
    date: today,
    predictions,
    pnl,
    avgPnl,
    hs300Pct: +(hs300.pct||0).toFixed(2),
    holdingCodes: holdings.map(h=>h.code),
    watchCodes: watchlist.map(w=>w.code),
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
  if(idx>=0) dailyLog[idx] = entry;
  else dailyLog.push(entry);

  saveDailyLog();
}

// ç”Ÿæˆæ¯æ—¥å¤ç›˜ï¼ˆå°†æ˜¨å¤©çš„é¢„æµ‹ä¸ä»Šæ—¥å®é™…è¡¨ç°å¯¹æ¯”ï¼‰
function generateDailyReview(){
  const today = todayStr();
  // æ‰¾æ˜¨å¤©ï¼ˆæˆ–æœ€è¿‘ä¸€ä¸ªæœ‰è®°å½•çš„äº¤æ˜“æ—¥ï¼‰çš„è®°å½•
  const pastEntries = dailyLog.filter(d=>d.date < today && d.predictions && Object.keys(d.predictions).length>0);
  if(pastEntries.length===0) return null;

  const yesterday = pastEntries[pastEntries.length-1];
  // ä»Šæ—¥å®é™…ç›ˆäºï¼ˆç”¨liveæ•°æ®ï¼‰
  const reviews = [];
  Object.keys(yesterday.predictions).forEach(code=>{
    const pred = yesterday.predictions[code];
    const todayData = getFundData(code);
    const actualPct = +(todayData?.gszzl||0).toFixed(2);

    // é¢„æµ‹æ˜¯å¦æ­£ç¡®
    let verdict = 'neutral'; // correct / wrong / neutral
    let lesson = '';
    if(pred.action==='buy'){
      if(actualPct > 0){ verdict='correct'; }
      else if(actualPct < -0.5){ verdict='wrong'; lesson=`å»ºè®®ä¹°å…¥ä½†ä»Šæ—¥è·Œ${actualPct}%ï¼Œå¯èƒ½ä½å¸æ—¶æœºæœªåˆ°æˆ–è¶‹åŠ¿åˆ¤æ–­éœ€ä¿®æ­£`; }
      else { verdict='neutral'; }
    } else if(pred.action==='sell'){
      if(actualPct < 0){ verdict='correct'; }
      else if(actualPct > 0.5){ verdict='wrong'; lesson=`å»ºè®®å‡ä»“ä½†ä»Šæ—¥æ¶¨${actualPct}%ï¼Œå¯èƒ½è¿‡æ—©ç¦»åœºé”™å¤±æ”¶ç›Š`; }
      else { verdict='neutral'; }
    } else { // hold
      if(Math.abs(actualPct) < 1){ verdict='correct'; }
      else if(actualPct < -1.5){ verdict='wrong'; lesson=`å»ºè®®æŒæœ‰ä½†ä»Šæ—¥è·Œ${actualPct}%ï¼ŒæœªåŠæ—¶æ­¢æŸæˆ–æœªè¯†åˆ«é£é™©ä¿¡å·`; }
      else if(actualPct > 2){ verdict='neutral'; lesson=`å»ºè®®æŒæœ‰ï¼Œä»Šæ—¥æ¶¨${actualPct}%ï¼Œä½†æœªå»ºè®®åŠ ä»“å¯èƒ½é”™å¤±æ³¢æ®µæœºä¼š`; }
    }

    reviews.push({
      code,
      name: fundName(code),
      predAction: pred.action,
      predConfidence: pred.confidence,
      predReason: pred.reason,
      actualPct,
      verdict,
      lesson
    });
  });

  // æ±‡æ€»
  const correct = reviews.filter(r=>r.verdict==='correct').length;
  const wrong = reviews.filter(r=>r.verdict==='wrong').length;
  const total = reviews.length;
  const accuracy = total>0 ? Math.round(correct/total*100) : 0;

  // æ˜¨æ—¥æŒä»“å¹³å‡
  const yesterdayAvg = yesterday.avgPnl||0;

  return {
    reviewDate: yesterday.date,
    todayDate: today,
    reviews,
    accuracy,
    correct,wrong,total,
    yesterdayAvg,
    yesterdayHs300: yesterday.hs300Pct||0
  };
}

// æ„å»ºå¤ç›˜ä¸Šä¸‹æ–‡ï¼ˆæ³¨å…¥AI promptï¼‰
function buildReviewContext(){
  const review = generateDailyReview();
  if(!review || review.reviews.length===0) return '';

  let ctx = `\nã€å†å²å¤ç›˜æ•™è®­ - è¯·ä»è¿‡å»çš„åˆ¤æ–­å¤±è¯¯ä¸­å­¦ä¹ ã€‘\n`;
  ctx += `ä¸Šæ¬¡åˆ†ææ—¥æœŸ:${review.reviewDate} â†’ ä»Šæ—¥éªŒè¯:${review.todayDate}\n`;
  ctx += `é¢„æµ‹å‡†ç¡®ç‡: ${review.accuracy}% (${review.correct}å¯¹/${review.wrong}é”™/${review.total}æ€»)\n`;

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  if(wrongOnes.length>0){
    ctx += `\nâš ï¸ åˆ¤æ–­å¤±è¯¯éœ€åæ€ï¼š\n`;
    wrongOnes.forEach(r=>{
      ctx += `- ${r.name}(${r.code}): é¢„æµ‹${r.predAction==='buy'?'ä¹°å…¥':r.predAction==='sell'?'å‡ä»“':'æŒæœ‰'} â†’ å®é™…${r.actualPct>0?'+':''}${r.actualPct}%`;
      if(r.lesson) ctx += ` | æ•™è®­:${r.lesson}`;
      ctx += `\n`;
    });
    ctx += `è¯·åœ¨ä»Šæ—¥åˆ†æä¸­ç‰¹åˆ«æ³¨æ„è¿™äº›å¤±è¯¯çš„åŒç±»å‹åŸºé‡‘ï¼Œé¿å…é‡å¤çŠ¯é”™ã€‚\n`;
  }

  const correctOnes = review.reviews.filter(r=>r.verdict==='correct');
  if(correctOnes.length>0){
    ctx += `\nâœ… åˆ¤æ–­æ­£ç¡®çš„ç»éªŒï¼š\n`;
    correctOnes.slice(0,3).forEach(r=>{
      ctx += `- ${r.name}: é¢„æµ‹${r.predAction==='buy'?'ä¹°å…¥':r.predAction==='sell'?'å‡ä»“':'æŒæœ‰'} â†’ å®é™…${r.actualPct>0?'+':''}${r.actualPct}% âœ“\n`;
    });
  }

  // åŠ å…¥æœ€è¿‘å‡ å¤©çš„ç›ˆäºè¶‹åŠ¿
  const recent = dailyLog.slice(-5).filter(d=>d.avgPnl!==undefined);
  if(recent.length>=2){
    ctx += `\nã€è¿‘æœŸæŒä»“ç›ˆäºèµ°åŠ¿ã€‘\n`;
    recent.forEach(d=>{
      ctx += `${d.date}: æŒä»“å¹³å‡${d.avgPnl>0?'+':''}${d.avgPnl}% | æ²ªæ·±300 ${d.hs300Pct>0?'+':''}${d.hs300Pct}%\n`;
    });
  }

  return ctx;
}

// æ¸²æŸ“å¤ç›˜UI
function renderReview(){
  const section = document.getElementById('review-section');
  const container = document.getElementById('review-container');
  const histToggle = document.getElementById('review-history-toggle');

  const review = generateDailyReview();

  if(!review || review.reviews.length===0){
    section.style.display = 'none';
    return;
  }
  section.style.display = '';

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  const accColor = review.accuracy>=70?'var(--green)':review.accuracy>=40?'var(--yellow)':'var(--red)';

  let html = `<div class="review-card">
    <div class="review-header">
      <div class="review-date">ğŸ“… ${review.reviewDate} â†’ ä»Šæ—¥éªŒè¯</div>
      <div class="review-pnl" style="color:${review.yesterdayAvg>=0?'var(--red)':'var(--green)'}">${review.yesterdayAvg>=0?'+':''}${review.yesterdayAvg}%</div>
    </div>
    <div class="review-stats">
      <div class="review-stat"><span class="review-stat-label">å‡†ç¡®ç‡</span><span class="review-stat-val" style="color:${accColor}">${review.accuracy}%</span></div>
      <div class="review-stat"><span class="review-stat-label">âœ…æ­£ç¡®</span><span class="review-stat-val" style="color:var(--green)">${review.correct}</span></div>
      <div class="review-stat"><span class="review-stat-label">âŒå¤±è¯¯</span><span class="review-stat-val" style="color:var(--red)">${review.wrong}</span></div>
      <div class="review-stat"><span class="review-stat-label">æ€»æ•°</span><span class="review-stat-val">${review.total}</span></div>
    </div>`;

  // å±•ç¤ºæ¯åªåŸºé‡‘çš„éªŒè¯ç»“æœ
  html += `<div class="review-items">`;
  // å…ˆæ˜¾ç¤ºé”™è¯¯çš„ï¼ˆé‡ç‚¹å…³æ³¨ï¼‰
  [...wrongOnes, ...review.reviews.filter(r=>r.verdict!=='wrong')].forEach(r=>{
    const predText = r.predAction==='buy'?'åŠ ä»“':r.predAction==='sell'?'å‡ä»“':'æŒæœ‰';
    const verdictText = r.verdict==='correct'?'âœ“å¯¹':r.verdict==='wrong'?'âœ—é”™':'â€”';
    const verdictClass = r.verdict;
    html += `<div class="review-item">
      <span class="review-fund-name">${r.name}</span>
      <span class="review-pred ${r.predAction}">${predText}</span>
      <span class="review-actual" style="color:${r.actualPct>=0?'var(--red)':'var(--green)'}">${r.actualPct>=0?'+':''}${r.actualPct}%</span>
      <span class="review-verdict ${verdictClass}">${verdictText}</span>
    </div>`;
  });
  html += `</div>`;

  // å¤±è¯¯æ•™è®­
  if(wrongOnes.length>0){
    const lessons = wrongOnes.filter(r=>r.lesson).map(r=>`â€¢ ${r.name}: ${r.lesson}`).join('<br>');
    if(lessons){
      html += `<div class="review-lesson">ğŸ“Œ <b>æ•™è®­æ€»ç»“</b><br>${lessons}</div>`;
    }
  }

  html += `</div>`;
  container.innerHTML = html;

  // å†å²è®°å½•
  if(dailyLog.length>1){
    histToggle.style.display = '';
  }
}

function toggleReviewHistory(){
  const histEl = document.getElementById('review-history');
  if(histEl.style.display==='none'){
    histEl.style.display = '';
    renderReviewHistory();
  } else {
    histEl.style.display = 'none';
  }
}

function renderReviewHistory(){
  const histEl = document.getElementById('review-history');
  const entries = dailyLog.slice().reverse().slice(0,10);
  if(entries.length===0){ histEl.innerHTML='<div style="text-align:center;font-size:11px;color:var(--sub);padding:12px">æš‚æ— å†å²è®°å½•</div>'; return; }

  let html = '';
  entries.forEach(entry=>{
    const holdPnlColor = entry.avgPnl>=0?'var(--red)':'var(--green)';
    const beatHs300 = entry.avgPnl > entry.hs300Pct;
    const predCount = Object.keys(entry.predictions||{}).length;
    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid var(--border);font-size:12px">
      <span style="color:var(--sub);min-width:80px">${entry.date}</span>
      <span style="font-weight:700;color:${holdPnlColor}">${entry.avgPnl>=0?'+':''}${entry.avgPnl}%</span>
      <span style="font-size:10px;color:var(--sub)">æ²ªæ·±300 ${entry.hs300Pct>=0?'+':''}${entry.hs300Pct}%</span>
      <span style="font-size:10px;padding:1px 6px;border-radius:4px;${beatHs300?'background:#ecfdf5;color:#16a34a':'background:#fef2f2;color:#dc2626'}">${beatHs300?'è·‘èµ¢':'è·‘è¾“'}</span>
      <span style="font-size:10px;color:var(--sub)">${predCount}åª</span>
      <span style="font-size:10px;color:var(--sub)">${entry.timestamp||''}</span>
    </div>`;
  });
  histEl.innerHTML = `<div style="background:var(--card);border-radius:var(--radius);padding:10px 14px;margin-top:4px;box-shadow:var(--shadow)">
    <div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--text)">ğŸ“Š æœ€è¿‘ç›ˆäºè®°å½•</div>
    ${html}
  </div>`;
}

// ==================== SIMULATION PORTFOLIO ====================
function saveSimPortfolio(){ localStorage.setItem('fa_sim_portfolio', JSON.stringify(simPortfolio)); }

function initSimPortfolio(){
  if(simPortfolio && simPortfolio.positions && simPortfolio.positions.length > 0) return;
  // éœ€è¦æœ‰çœŸå®æŒä»“æ‰èƒ½åˆå§‹åŒ–
  if(holdings.length === 0){
    simPortfolio = null;
    return;
  }
  buildSimFromHoldings();
}

function buildSimFromHoldings(){
  const today = todayStr();
  simPortfolio = {
    cash: 0, totalCapital: SIM_INITIAL_CAPITAL,
    positions: [], history: [], dailySnapshots: [],
    strategy: {
      coreRatio: 0.6, satRatio: 0.4,
      maxSinglePos: 0.25,
      stopLoss: -8, takeProfit: 20,
      dipBuyThreshold: -1.5, surgeSellThreshold: 3,
      rebalanceDays: 15,
    },
    created: today, targetMonthlyReturn: SIM_TARGET_MONTHLY,
    syncSource: 'holdings', // æ ‡è®°æ¥æº
    learningLog: [],
  };

  // æ ¹æ®ç”¨æˆ·æŒä»“ç­‰æƒåˆ†é…èµ„é‡‘
  const n = holdings.length;
  const perFundPct = Math.floor(90 / n); // 90%åˆ†é…ï¼Œ10%ç•™ç°é‡‘
  let usedCash = 0;
  let hasRealData = false;
  const CORE_TYPES = new Set(['å®½åŸº','é»„é‡‘','çº¢åˆ©','å€ºåˆ¸']);

  holdings.forEach((h, i) => {
    // æœ€åä¸€åªåŸºé‡‘æŠŠå‰©ä½™90%å…¨ç»™
    const pct = (i === n-1) ? (90 - perFundPct * (n-1)) : perFundPct;
    const amount = Math.round(SIM_INITIAL_CAPITAL * pct / 100);
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const fd = getFundData(h.code);
    let nav;
    if(fd?._live){
      nav = fd.dwjz || fd.gsz;
      hasRealData = true;
    } else if(fd?._histFallback){
      nav = fd.dwjz;
      hasRealData = true;
    } else {
      nav = fd?.dwjz || 1.0;
    }
    const shares = Math.floor(netAmount / nav * 100) / 100;
    const group = CORE_TYPES.has(h.type) ? 'core' : 'satellite';
    simPortfolio.positions.push({
      code:h.code, name:h.name||fundName(h.code)||h.code, type:h.type||'å…¶ä»–', group,
      shares, avgCost:nav, buyDate:today, targetPct:pct, investedAmount:amount,
      initNavSource: fd?._live ? 'live' : fd?._histFallback ? 'history' : 'fallback',
    });
    simPortfolio.history.push({
      date:today, action:'buy', code:h.code, name:h.name||h.code,
      amount, shares, nav, fee,
      reason:`ä»æŒä»“åŒæ­¥Â·${group==='core'?'æ ¸å¿ƒ':'å«æ˜Ÿ'} ${pct}%é…æ¯”${fd?._live?' (å®æ—¶)':fd?._histFallback?' (å†å²)':' (å¾…æ ¡å‡†)'}`
    });
    usedCash += amount;
  });
  simPortfolio.cash = SIM_INITIAL_CAPITAL - usedCash;
  simPortfolio.dataQuality = hasRealData ? 'real' : 'pending';
  saveSimPortfolio();
}

function getSimNav(code){
  // æ”¶ç›˜åä¼˜å…ˆç”¨dwjz(ç¡®è®¤å‡€å€¼)ï¼Œç›˜ä¸­ç”¨gsz(ä¼°ç®—å‡€å€¼)
  const fd = getFundData(code);
  if(!fd) return null;
  const ms = getMarketStatus();
  if(ms.status==='open' || ms.status==='break'){
    return fd.gsz || fd.dwjz; // ç›˜ä¸­ç”¨ä¼°ç®—
  }
  return fd.dwjz || fd.gsz; // æ”¶ç›˜ç”¨ç¡®è®¤å‡€å€¼
}

function getSimTotalValue(){
  if(!simPortfolio) return SIM_INITIAL_CAPITAL;
  let total = simPortfolio.cash;
  simPortfolio.positions.forEach(pos => {
    const nav = getSimNav(pos.code) || pos.avgCost;
    total += pos.shares * nav;
  });
  return total;
}

function updateSimDaily(){
  if(!simPortfolio || !simPortfolio.positions) return;
  const today = todayStr();
  // åªåœ¨äº¤æ˜“æ—¥æ›´æ–°å¿«ç…§
  if(!isTradingDay(today)) return;

  // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®æ•°æ®å¯ç”¨ï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªpositionæœ‰liveæ•°æ®ï¼‰
  let liveCount = 0;
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    if(fd?._live) liveCount++;
  });

  // å¦‚æœå·²å­˜åœ¨ä»Šæ—¥å¿«ç…§ï¼Œåªæœ‰å½“æ–°æ•°æ®è´¨é‡æ›´å¥½æ—¶æ‰æ›´æ–°
  const existingIdx = simPortfolio.dailySnapshots.findIndex(s => s.date === today);
  if(existingIdx >= 0 && liveCount <= (simPortfolio.dailySnapshots[existingIdx].liveDataCount||0)){
    return; // ç°æœ‰æ•°æ®è´¨é‡å·²ç»æ›´å¥½æˆ–ç›¸åŒï¼Œè·³è¿‡
  }

  let positionValue = 0;
  const posDetails = [];
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    const nav = getSimNav(pos.code) || pos.avgCost;
    const currentValue = pos.shares * nav;
    const pnl = currentValue - pos.investedAmount;
    const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
    positionValue += currentValue;
    posDetails.push({
      code:pos.code, nav:+nav.toFixed(4), value:Math.round(currentValue),
      pnl:Math.round(pnl), pnlPct:+pnlPct.toFixed(2),
      todayPct:+(fd?.gszzl||0).toFixed(2),
      isLive: !!(fd?._live),
    });
  });

  const totalValue = positionValue + simPortfolio.cash;
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  // å–å‰ä¸€å¤©ï¼ˆéä»Šå¤©ï¼‰çš„å¿«ç…§è®¡ç®—æ—¥å›æŠ¥
  const prevSnapshots = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const prevSnapshot = prevSnapshots.length > 0 ? prevSnapshots[prevSnapshots.length - 1] : null;
  const prevTotal = prevSnapshot ? prevSnapshot.totalValue : SIM_INITIAL_CAPITAL;
  const dailyReturn = (totalValue - prevTotal) / prevTotal * 100;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300Price = parseFloat(hs300.price) || 0;
  // åŸºå‡†ï¼šå–ç¬¬ä¸€å¤©æœ‰æ•ˆè®°å½•çš„hs300ä»·æ ¼
  const allSnaps = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const hs300Base = allSnaps.length > 0 ? allSnaps[0].hs300Base : hs300Price;
  const hs300CumPct = hs300Base > 0 ? (hs300Price / hs300Base - 1) * 100 : 0;

  const snapshot = {
    date:today, totalValue:Math.round(totalValue), cash:Math.round(simPortfolio.cash),
    positionValue:Math.round(positionValue), dailyReturn:+dailyReturn.toFixed(2),
    cumReturn:+cumReturn.toFixed(2), hs300Pct:+(hs300.pct||0).toFixed(2),
    hs300CumReturn:+hs300CumPct.toFixed(2), hs300Base, hs300Price,
    positions:posDetails, liveDataCount:liveCount,
    updatedAt: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
  };

  if(existingIdx >= 0){
    simPortfolio.dailySnapshots[existingIdx] = snapshot; // æ›´æ–°ä¸ºæ›´å¥½çš„æ•°æ®
  } else {
    simPortfolio.dailySnapshots.push(snapshot);
  }
  if(simPortfolio.dailySnapshots.length > 60) simPortfolio.dailySnapshots = simPortfolio.dailySnapshots.slice(-60);
  saveSimPortfolio();
}

function simTrade(code, action, amountOrPct, reason){
  if(!simPortfolio) return;
  const today = todayStr();
  const fd = getFundData(code);
  // åªç”¨æœ‰çœŸå®æ•°æ®çš„å‡€å€¼è¿›è¡Œäº¤æ˜“
  if(!fd?._live && !fd?._histFallback){
    console.warn(`simTrade: ${code} æ— çœŸå®æ•°æ®ï¼Œè·³è¿‡äº¤æ˜“`);
    return;
  }
  const nav = getSimNav(code) || fd?.gsz || fd?.dwjz || 1.0;
  const pos = simPortfolio.positions.find(p => p.code === code);

  if(action === 'buy'){
    const amount = (typeof amountOrPct==='number' && amountOrPct < 1) ? Math.round(getSimTotalValue() * amountOrPct) : amountOrPct;
    if(amount > simPortfolio.cash || amount < 100) return;
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const newShares = Math.floor(netAmount / nav * 100) / 100;
    if(pos){
      const totalInvested = pos.investedAmount + amount;
      pos.shares += newShares;
      pos.avgCost = totalInvested / pos.shares;
      pos.investedAmount = totalInvested;
    } else {
      const known = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
      simPortfolio.positions.push({
        code, name:known?.name||fd?.name||code, type:known?.type||'å…¶ä»–', group:'satellite',
        shares:newShares, avgCost:nav, buyDate:today, targetPct:0, investedAmount:amount,
      });
    }
    simPortfolio.cash -= amount;
    simPortfolio.history.push({date:today, action:'buy', code, name:pos?.name||code, amount, shares:newShares, nav, fee, reason});

  } else if(action === 'sell' && pos){
    const sellPct = (typeof amountOrPct==='number' && amountOrPct <= 1) ? amountOrPct : 0.5;
    const sellShares = Math.floor(pos.shares * sellPct * 100) / 100;
    if(sellShares < 0.01) return;
    const sellValue = Math.round(sellShares * nav);
    const fee = Math.round(sellValue * SIM_FEE_RATE * 0.5);
    pos.shares -= sellShares;
    pos.investedAmount = Math.round(pos.investedAmount * (1 - sellPct));
    simPortfolio.cash += (sellValue - fee);
    if(pos.shares < 0.01) simPortfolio.positions = simPortfolio.positions.filter(p => p.code !== code);
    simPortfolio.history.push({date:today, action:'sell', code, name:pos.name, amount:sellValue, shares:sellShares, nav, fee, reason});
  }
  saveSimPortfolio();
}

function simAutoTrade(){
  if(!simPortfolio || !_analysisResult) return 0;
  // åªåœ¨äº¤æ˜“æ—¥äº¤æ˜“æ—¶æ®µæ‰§è¡Œ
  const ms = getMarketStatus();
  if(ms.status!=='open' && ms.status!=='break' && ms.status!=='closed') return 0;
  if(!isTradingDay()) return 0;
  const strategy = simPortfolio.strategy;
  let tradesExecuted = 0;

  // æ•°æ®æƒ…æŠ¥ä¿¡å·ç³»æ•°: æ ¹æ®å®è§‚+èµ„é‡‘+èˆ†æƒ…è°ƒèŠ‚äº¤æ˜“æ¿€è¿›åº¦
  const dataSignal = _dataIntelLoaded ? generateDataSignal() : { score:50 };
  const dsScore = dataSignal.score; // 0-100, 50=ä¸­æ€§
  // buyMult: 1.0(ä¸­æ€§), 0.5(ç†Šå¸‚)~1.5(ç‰›å¸‚)
  const buyMult = 0.5 + dsScore / 100;
  // sellMult: åå‘, ç†Šå¸‚å–æ›´å¤š
  const sellMult = 1.5 - dsScore / 100;
  // ä¿¡å¿ƒé—¨æ§›è°ƒèŠ‚: ç‰›å¸‚é™ä½ä¹°å…¥é—¨æ§›ï¼Œç†Šå¸‚æé«˜
  const confAdj = Math.round((50 - dsScore) * 0.15); // Â±7.5

  // 1. æ­¢ç›ˆæ­¢æŸæ£€æŸ¥ï¼ˆæ•°æ®ä¿¡å·å½±å“æ­¢æŸå¹…åº¦ï¼‰
  const dynStopLoss = strategy.stopLoss + (dsScore < 40 ? 1 : dsScore > 60 ? -1 : 0);
  const dynTakeProfit = strategy.takeProfit + (dsScore > 65 ? 3 : dsScore < 35 ? -2 : 0);

  [...simPortfolio.positions].forEach(pos => {
    const fd = getFundData(pos.code);
    if(!fd?._live && !fd?._histFallback) return;
    const nav = getSimNav(pos.code) || pos.avgCost;
    const pnlPct = (nav - pos.avgCost) / pos.avgCost * 100;
    if(pnlPct <= dynStopLoss && pos.group === 'satellite'){
      const sellPct = Math.min(0.9, 0.7 * sellMult);
      simTrade(pos.code, 'sell', sellPct, `â›”æ­¢æŸ: äº${pnlPct.toFixed(1)}%è¶…çº¿${dynStopLoss}% [æ•°æ®ä¿¡å·${dsScore}]`);
      tradesExecuted++;
    }
    if(pnlPct >= dynTakeProfit && pos.group === 'satellite'){
      const sellPct = Math.min(0.6, 0.4 * sellMult);
      simTrade(pos.code, 'sell', sellPct, `âœ…æ­¢ç›ˆ: èµš${pnlPct.toFixed(1)}%è¾¾${dynTakeProfit}% [æ•°æ®ä¿¡å·${dsScore}]`);
      tradesExecuted++;
    }
  });

  // 2. ä¸‰å¼•æ“æŠ•ç¥¨å…±è¯†äº¤æ˜“ç³»ç»Ÿï¼ˆAI + RL + Backtestï¼‰
  const buyConfThreshold = Math.max(50, 65 + confAdj);
  const sellConfThreshold = Math.max(45, 60 + confAdj);

  simPortfolio.positions.forEach(pos => {
    const sig = _analysisResult.signals[pos.code];
    if(!sig) return;
    const fd = getFundData(pos.code);
    if(!fd?._live) return;
    const todayPct = fd?.gszzl || 0;

    // æ£€æŸ¥è¯¥æ¿å—çš„èµ„é‡‘æµå‘
    const posType = pos.type || '';
    const sectorFlow = sectorCapFlow.find(s => posType && (s.name.includes(posType) || posType.includes(s.name)));
    const sectorBullish = sectorFlow && sectorFlow.mainNet > 0;
    const sectorBearish = sectorFlow && sectorFlow.mainNet < -1e8;

    // === ä¸‰å¼•æ“æŠ•ç¥¨å…±è¯† ===
    const rlSig = _rlSignals[pos.code];
    const btR = btResults[pos.code];

    // å¼•æ“1: AIä¿¡å·æŠ•ç¥¨
    const aiVote = sig.action === 'buy' ? 1 : sig.action === 'sell' ? -1 : 0;
    const aiWeight = Math.min(sig.confidence, 95) / 100; // 0~0.95

    // å¼•æ“2: RLä¿¡å·æŠ•ç¥¨
    let rlVote = 0, rlWeight = 0;
    if(rlSig){
      rlVote = rlSig.action === 1 ? 1 : rlSig.action === 2 ? -1 : 0;
      rlWeight = Math.min(rlSig.confidence, 95) / 100;
    }

    // å¼•æ“3: å›æµ‹ä¿¡å·æŠ•ç¥¨(åŸºäºå½“å‰RSI+Sharpe+è¶‹åŠ¿)
    let btVote = 0, btWeight = 0;
    if(btR){
      const rsiVal = btR.lastRSI || 50;
      const sharpeVal = btR.sharpe || 0;
      // RSI<40+Sharpe>0 â†’ ä¹°å…¥ä¿¡å·; RSI>70+ä»»ä½• â†’ å–å‡ºä¿¡å·
      if(rsiVal < 40 && sharpeVal > 0) btVote = 1;
      else if(rsiVal < 50 && sharpeVal > 0.5) btVote = 1;
      else if(rsiVal > 75) btVote = -1;
      else if(rsiVal > 65 && sharpeVal < 0) btVote = -1;
      btWeight = Math.min(Math.abs(sharpeVal) / 2, 0.8); // Sharpeè¶Šé«˜æƒé‡è¶Šå¤§
      if(btR.winRate > 0.5) btWeight = Math.min(btWeight + 0.1, 0.9);
    }

    // åŠ æƒæŠ•ç¥¨: å¾—åˆ† âˆˆ [-1, 1]
    const totalWeight = aiWeight + rlWeight + btWeight || 1;
    const consensusScore = (aiVote * aiWeight + rlVote * rlWeight + btVote * btWeight) / totalWeight;

    // ç»Ÿè®¡ä¸€è‡´æ€§: å¤šå°‘å¼•æ“åŒæ–¹å‘
    const votes = [aiVote, rlVote, btVote].filter(v => v !== 0);
    const buyVotes = votes.filter(v => v > 0).length;
    const sellVotes = votes.filter(v => v < 0).length;
    const consensus = Math.max(buyVotes, sellVotes); // æœ€å¤§åŒå‘ç¥¨æ•°
    const unanimousBuy = buyVotes >= 2 && sellVotes === 0; // è‡³å°‘2ç¥¨çœ‹å¤šæ— åå¯¹
    const unanimousSell = sellVotes >= 2 && buyVotes === 0; // è‡³å°‘2ç¥¨çœ‹ç©ºæ— åå¯¹

    // å…±è¯†ä¹˜æ•°: å…¨ç¥¨ä¸€è‡´â†’1.3å€ï¼Œ2ç¥¨â†’1.0å€ï¼Œåˆ†æ­§â†’0.5å€
    let consensusMult = 1.0;
    if(consensus >= 3) consensusMult = 1.4; // ä¸‰å¼•æ“å…¨ç¥¨
    else if(consensus >= 2 && votes.length >= 2) consensusMult = 1.15; // å¤šæ•°ç¥¨
    else if(buyVotes > 0 && sellVotes > 0) consensusMult = 0.4; // æœ‰åˆ†æ­§,å¤§å¹…ç¼©é‡

    // æœ‰æ•ˆç½®ä¿¡åº¦ = AIç½®ä¿¡åº¦ Ã— å…±è¯†ä¹˜æ•°
    const effConf = sig.confidence * consensusMult;
    const rlTag = rlSig ? ` RL:${rlSig.actionName}${rlSig.confidence}%` : '';
    const btTag = btR ? ` BT:${btR.sharpe>0?'â–²':'â–¼'}${btR.sharpe.toFixed(1)}` : '';
    const voteTag = ` æŠ•ç¥¨[${buyVotes}ä¹°/${sellVotes}å–]Ã—${consensusMult.toFixed(1)}`;

    if(sig.action==='buy' && effConf>=buyConfThreshold && todayPct<=strategy.dipBuyThreshold){
      const posValue = pos.shares * (getSimNav(pos.code) || pos.avgCost);
      const totalValue = getSimTotalValue();
      if(posValue / totalValue < strategy.maxSinglePos){
        // Kellyä»“ä½æ§åˆ¶: ç”¨å›æµ‹Kellyåˆ†æ•°é™åˆ¶åŠ ä»“æ¯”ä¾‹ Ã— å…±è¯†ç³»æ•°
        const kellyLimit = btR?.finalKelly || 0.05;
        let addPct = Math.min(0.03 * buyMult * consensusMult, kellyLimit);
        if(sectorBullish) addPct *= 1.3;
        if(unanimousBuy) addPct *= 1.2; // å…¨ç¥¨çœ‹å¤šåŠ ç 
        // å›æµ‹Sharpeè¿‡æ»¤: Sharpe<0ä¸åŠ ä»“
        if(btR && btR.sharpe < 0) addPct = 0;
        const addAmt = Math.min(Math.round(totalValue * addPct), Math.round(simPortfolio.cash * 0.3));
        if(addAmt >= 1000){
          const kellyTag = btR ? ` K:${(kellyLimit*100).toFixed(0)}%` : '';
          const reason = `AIåŠ ä»“(${sig.confidence}%)+è·Œ${todayPct.toFixed(1)}%ä½å¸ [${voteTag} æ•°æ®${dsScore}${sectorBullish?' æ¿å—æµå…¥':''}${rlTag}${btTag}${kellyTag}]`;
          simTrade(pos.code, 'buy', addAmt, reason);
          tradesExecuted++;
        }
      }
    }

    if(sig.action==='sell' && effConf>=sellConfThreshold && todayPct>=strategy.surgeSellThreshold && pos.group==='satellite'){
      let sellPct = 0.3 * sellMult * consensusMult;
      if(sectorBearish) sellPct = Math.min(0.5, sellPct * 1.3);
      if(unanimousSell) sellPct = Math.min(0.7, sellPct * 1.3); // å…¨ç¥¨çœ‹ç©ºåŠ å¤§å–å‡º
      sellPct = Math.max(0.1, Math.min(0.8, sellPct));
      simTrade(pos.code, 'sell', sellPct, `AIå‡ä»“(${sig.confidence}%)+æ¶¨${todayPct.toFixed(1)}% [${voteTag} æ•°æ®${dsScore}${sectorBearish?' æ¿å—æµå‡º':''}${rlTag}${btTag}]`);
      tradesExecuted++;
    }
  });

  // 3. AIæ–°æ¨èå“ç§ï¼ˆä¸‰å¼•æ“å…±è¯†è¿‡æ»¤ï¼‰
  if(_analysisResult.picks && simPortfolio.cash > 20000 && dsScore >= 40){
    const minEndorsements = dsScore >= 60 ? 1 : 2;
    _analysisResult.picks.forEach(pick => {
      if(simPortfolio.positions.find(p => p.code === pick.code)) return;
      // å›æµ‹è¿‡æ»¤: å¦‚æœå›æµ‹Sharpe<0ä¸”æ”¶ç›Šä¸ºè´Ÿï¼Œè·³è¿‡
      const pickBT = btResults[pick.code];
      if(pickBT && pickBT.sharpe < 0 && pickBT.totalReturn < 0) return;
      // RLè¿‡æ»¤: å¦‚æœRLå¼ºçƒˆçœ‹ç©º(å–å‡ºä¸”>60%ç½®ä¿¡)ï¼Œè·³è¿‡
      const pickRL = _rlSignals[pick.code];
      if(pickRL && pickRL.action === 2 && pickRL.confidence > 60) return;
      // ä¸‰å¼•æ“æ–°å“ç§æŠ•ç¥¨
      const pickAiVote = 1; // AIæ¨è=çœ‹å¤š
      const pickRlVote = pickRL ? (pickRL.action===1 ? 1 : pickRL.action===2 ? -1 : 0) : 0;
      const pickBtVote = (pickBT && pickBT.sharpe > 0 && pickBT.lastRSI < 60) ? 1 :
                         (pickBT && pickBT.sharpe < 0) ? -1 : 0;
      const pickBuyVotes = [pickAiVote, pickRlVote, pickBtVote].filter(v=>v>0).length;
      const pickSellVotes = [pickAiVote, pickRlVote, pickBtVote].filter(v=>v<0).length;
      const pickConsensusMult = pickBuyVotes >= 3 ? 1.4 : pickBuyVotes >= 2 ? 1.1 :
                                pickSellVotes > 0 ? 0.5 : 0.8;

      if(pick.endorsements >= minEndorsements){
        // Kellyä»“ä½: ç”¨å›æµ‹Kelly Ã— å…±è¯†ç³»æ•°
        const pickKelly = pickBT?.finalKelly || 0.1;
        const basePct = Math.min(dsScore >= 60 ? 0.18 : 0.12, pickKelly * 1.5) * pickConsensusMult;
        const amount = Math.min(Math.round(simPortfolio.cash * basePct), 25000);
        if(amount >= 5000){
          const kTag = pickBT ? ` Sharpe:${pickBT.sharpe.toFixed(1)} Kelly:${(pickKelly*100).toFixed(0)}%` : '';
          const rlTag2 = pickRL ? ` RL:${pickRL.action===1?'ä¹°':pickRL.action===2?'å–':'æŒ'}${pickRL.confidence}%` : '';
          simTrade(pick.code, 'buy', amount, `AIæ¨è(${pick.endorsements}å¼•æ“) [æŠ•ç¥¨${pickBuyVotes}ä¹°Ã—${pickConsensusMult.toFixed(1)} æ•°æ®${dsScore}${kTag}${rlTag2}]: ${(pick.reason||'').slice(0,30)}`);
          tradesExecuted++;
        }
      }
    });
  }

  // 4. ç­–ç•¥å­¦ä¹ 
  learnFromPerformance();
  // 5. RLåœ¨çº¿å­¦ä¹ åé¦ˆï¼šç”¨æ¨¡æ‹Ÿç›˜äº¤æ˜“ç»“æœè¿›è¡Œå¢é‡è®­ç»ƒ
  if(tradesExecuted > 0) rlOnlineLearning();
  saveSimPortfolio();
  return tradesExecuted;
}

// ==================== RLåœ¨çº¿å­¦ä¹  (Online Learning from Sim Trades) ====================
function rlOnlineLearning(){
  if(!_rlModelLoaded || !rlTrainer?.agent || !simPortfolio?.history) return;
  const today = todayStr();
  const todayTrades = simPortfolio.history.filter(h => h.date === today);
  if(!todayTrades.length) return;

  let onlineReplayCount = 0;
  for(const trade of todayTrades){
    const code = trade.code;
    const hd = fundHistoryData[code];
    if(!hd?.navs || hd.navs.length < 25) continue;
    const navArr = hd.navs.map(n=>({date:n[0],nav:parseFloat(n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
    if(navArr.length < 25) continue;

    // æ„å»ºå½“å‰çŠ¶æ€
    const env = new MarketEnv(navArr, code);
    env.idx = navArr.length - 1;
    const simPos = simPortfolio.positions.find(p => p.code === code);
    env.pos = simPos ? 1 : 0;
    if(simPos) env.entryPrice = simPos.avgCost;
    const state = env._state();
    // æ³¨å…¥å®è§‚/èˆ†æƒ…/èµ„é‡‘æµ
    if(_dataIntelLoaded){
      const ds = generateDataSignal();
      state[12] = rlClip((ds.score-50)/25, -2, 2);
      state[13] = rlClip((newsSentiment.score-50)/25, -2, 2);
      const cn = sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0), 0);
      state[14] = rlClip(cn/1e10, -2, 2);
    }

    // æ˜ å°„äº¤æ˜“åŠ¨ä½œåˆ°RL action
    const action = trade.action === 'buy' ? 1 : trade.action === 'sell' ? 2 : 0;

    // è®¡ç®—å³æ—¶å¥–åŠ±: åŸºäºå½“æ—¥äº¤æ˜“åæŒä»“è¡¨ç°
    let reward = 0;
    const fd = getFundData(code);
    const todayPct = (fd?.gszzl || 0) / 100;
    if(action === 1){ // ä¹°å…¥
      reward = todayPct > 0 ? todayPct * 5 : todayPct * 8; // ä¹°å¯¹å¥–åŠ±ï¼Œä¹°é”™æ‰ç½š
    } else if(action === 2){ // å–å‡º
      reward = todayPct < 0 ? Math.abs(todayPct) * 5 : -todayPct * 3; // å–å¯¹å¥–åŠ±ï¼Œå–é”™è½»ç½š
    }
    // ç»„åˆçº§å¥–åŠ±åŠ æˆ
    const totalValue = getSimTotalValue();
    const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL;
    reward += rlClip(cumReturn * 2, -0.5, 0.5);

    // æ„å»ºä¸‹ä¸€çŠ¶æ€(ç”¨å½“å‰çŠ¶æ€ç•¥å¾®åç§»)
    const nextState = Float32Array.from(state);
    nextState[10] = simPos ? 1 : 0; // æ›´æ–°æŒä»“çŠ¶æ€

    // å–µå…¥ç»éªŒå¹¶åšå°æ‰¹é‡è®­ç»ƒ
    rlTrainer.agent.remember(state, action, reward, nextState, false);
    onlineReplayCount++;
  }

  // å¢é‡è®­ç»ƒ: æ¯æ¬¡åœ¨çº¿å­¦ä¹ åšå°‘é‡Replay
  if(onlineReplayCount > 0 && rlTrainer.agent.memory.length >= rlTrainer.agent.batchSize * 2){
    const onlineBatches = Math.min(onlineReplayCount * 2, 8);
    for(let i = 0; i < onlineBatches; i++){
      rlTrainer.agent.replay();
    }
    // ä¿å­˜æ›´æ–°åçš„æ¨¡å‹
    rlTrainer.saveModel();
    // é‡æ–°ç”Ÿæˆä¿¡å·
    rlTrainer.generateSignals();
    renderRLBrief();
    console.log(`RLåœ¨çº¿å­¦ä¹ : ${onlineReplayCount}æ¡ç»éªŒÂ·${onlineBatches}æ¬¡ReplayÂ·Îµ=${rlTrainer.agent.epsilon.toFixed(4)}`);
  }
}

function learnFromPerformance(){
  if(!simPortfolio || simPortfolio.dailySnapshots.length < 2) return;
  const today = todayStr();
  const snapshots = simPortfolio.dailySnapshots;
  const recent = snapshots.slice(-5);
  const avgDailyReturn = recent.reduce((s,d) => s + d.dailyReturn, 0) / recent.length;
  const strategy = simPortfolio.strategy;
  let lesson = '';
  let strategyChange = '';

  if(recent.length >= 3){
    const negDays = recent.filter(d => d.dailyReturn < 0).length;
    const posDays = recent.filter(d => d.dailyReturn > 0).length;
    if(negDays >= 4 && strategy.stopLoss > -6){
      strategy.stopLoss = Math.max(strategy.stopLoss - 1, -10);
      strategyChange = `è¿ç»­äºæŸ${negDays}å¤©â†’æ­¢æŸæ”¶ç´§è‡³${strategy.stopLoss}%`;
      lesson = 'å¸‚åœºæŒç»­èµ°å¼±ï¼Œå‡å°‘å«æ˜Ÿä»“æ•å£ï¼ŒåŠ å¼ºé£æ§';
    }
    if(posDays >= 4 && strategy.takeProfit < 25){
      strategy.takeProfit = Math.min(strategy.takeProfit + 2, 30);
      strategyChange = `è¿ç»­ç›ˆåˆ©${posDays}å¤©â†’æ­¢ç›ˆä¸Šè°ƒè‡³${strategy.takeProfit}%`;
      lesson = 'å¸‚åœºè¶‹åŠ¿è‰¯å¥½ï¼Œä¿æŒä»“ä½è®©åˆ©æ¶¦å¥”è·‘';
    }
  }

  // æ¿å—èƒœç‡åˆ†æ
  const latestSnap = snapshots[snapshots.length - 1];
  if(latestSnap?.positions){
    const winCount = latestSnap.positions.filter(p => p.todayPct > 0).length;
    const loseCount = latestSnap.positions.filter(p => p.todayPct < 0).length;
    if(loseCount > winCount && !lesson) lesson = `ä»Šæ—¥${loseCount}è·Œ/${winCount}æ¶¨ï¼Œæ³¨æ„å›è°ƒé£é™©`;
  }

  // é¢„æµ‹å‡†ç¡®ç‡åé¦ˆ
  const review = generateDailyReview();
  if(review && review.accuracy < 40 && !lesson){
    lesson = `AIé¢„æµ‹å‡†ç¡®ç‡ä»…${review.accuracy}%ï¼Œå‡å°‘é¢‘ç¹æ“ä½œ`;
    if(strategy.dipBuyThreshold > -2.5){
      strategy.dipBuyThreshold -= 0.5;
      strategyChange += (strategyChange?'ï¼›':'') + `åŠ ä»“é˜ˆå€¼â†’${strategy.dipBuyThreshold}%`;
    }
  }

  // æœˆåº¦å›æŠ¥æ£€æŸ¥
  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const daysRunning = snapshots.length;
  if(daysRunning >= 10){
    const monthlyPace = cumReturn / daysRunning * 22;
    if(monthlyPace < 1 && !lesson){
      lesson = `æœˆåŒ–æ”¶ç›Šç‡çº¦${monthlyPace.toFixed(1)}%ï¼Œä½äº2%ç›®æ ‡ï¼Œéœ€æé«˜è¿›æ”»æ€§`;
      if(strategy.dipBuyThreshold > -2.0){
        strategy.dipBuyThreshold = Math.max(strategy.dipBuyThreshold + 0.3, -1.0);
        strategyChange += (strategyChange?'ï¼›':'') + `é™ä½åŠ ä»“é—¨æ§›â†’${strategy.dipBuyThreshold.toFixed(1)}%`;
      }
    }
    if(monthlyPace > 5 && !lesson){
      lesson = `æœˆåŒ–çº¦${monthlyPace.toFixed(1)}%ï¼Œå¤§å¹…è¶…é¢ï¼Œé€‚å½“é”å®šåˆ©æ¶¦é˜²å›æ’¤`;
    }
  }

  if(lesson || strategyChange){
    simPortfolio.learningLog.push({
      date:today, lesson, strategyChange,
      cumReturn:+cumReturn.toFixed(2),
      avgDailyReturn:+avgDailyReturn.toFixed(3),
    });
    if(simPortfolio.learningLog.length > 30) simPortfolio.learningLog = simPortfolio.learningLog.slice(-30);
  }
  saveSimPortfolio();
}

// ==================== DATA INTELLIGENCE RENDERING ====================
function toggleDataIntel(){
  const container = document.getElementById('data-intel-container');
  const icon = document.getElementById('data-intel-toggle');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = 'â–¼';
    renderDataIntel();
  } else {
    container.style.display = 'none';
    icon.textContent = 'â–¶';
  }
}

function renderDataIntelBrief(){
  const el = document.getElementById('data-intel-brief');
  if(!el) return;
  if(!_dataIntelLoaded){ el.innerHTML = '<span style="color:var(--sub)">åŠ è½½ä¸­...</span>'; return; }
  const macro = getMacroSummary();
  const sentColor = newsSentiment.score>=55 ? 'var(--red)' : newsSentiment.score<=45 ? 'var(--green)' : 'var(--sub)';
  el.innerHTML = `<span style="color:${macro.positiveCount>=3?'var(--red)':'var(--green)'}">${macro.overallSignal}</span> Â· <span style="color:${sentColor}">èˆ†æƒ…${newsSentiment.label}</span>`;
}

function renderDataIntel(){
  const container = document.getElementById('data-intel-container');
  if(!container) return;
  if(!_dataIntelLoaded){
    container.innerHTML = '<div style="text-align:center;padding:20px;font-size:11px;color:var(--sub)"><div class="spinner"></div><div style="margin-top:8px">æ•°æ®åŠ è½½ä¸­...</div></div>';
    return;
  }
  let html = '';

  // 1. å®è§‚ç»æµé¢æ¿
  const macro = getMacroSummary();
  html += '<div class="macro-card"><div class="macro-card-title">ğŸ“Š å®è§‚ç»æµæŒ‡æ ‡ <span style="font-size:9px;font-weight:400;color:var(--sub)">ä¸œæ–¹è´¢å¯Œæ•°æ®ä¸­å¿ƒ</span></div>';
  html += '<div class="macro-grid">';
  macro.signals.forEach(s=>{
    const cls = s.positive ? 'positive' : 'negative';
    html += `<div class="macro-item"><span class="macro-label">${s.name}</span><span class="macro-val ${cls}">${s.value}</span><span class="macro-label">${s.signal}</span></div>`;
  });
  html += '</div>';
  // è¶‹åŠ¿å¯¹æ¯”ï¼ˆå¦‚æœæœ‰å¤šæœŸæ•°æ®ï¼‰
  if(macroData.pmi && macroData.pmi.length>=2){
    const curr = macroData.pmi[0].MAKE_INDEX;
    const prev = macroData.pmi[1].MAKE_INDEX;
    const trend = curr>prev ? 'ğŸ“ˆç¯æ¯”æ”¹å–„' : curr<prev ? 'ğŸ“‰ç¯æ¯”èµ°å¼±' : 'â¡ï¸æŒå¹³';
    html += `<div style="font-size:9px;color:var(--sub);margin-top:6px;text-align:center">åˆ¶é€ ä¸šPMIè¶‹åŠ¿: ${macroData.pmi[1].TIME?.replace('ä»½','')}: ${prev} â†’ ${macroData.pmi[0].TIME?.replace('ä»½','')}: ${curr} ${trend}</div>`;
  }
  html += '</div>';

  // 2. æ¿å—èµ„é‡‘æµå‘
  const capFlow = getCapFlowSummary();
  if(sectorCapFlow.length > 0){
    html += '<div class="macro-card"><div class="macro-card-title">ğŸ’° æ¿å—ä¸»åŠ›èµ„é‡‘æµå‘ <span style="font-size:9px;font-weight:400;color:var(--sub)">ä»Šæ—¥å®æ—¶</span></div>';
    const maxAbs = Math.max(...sectorCapFlow.map(s=>Math.abs(s.mainNet||0)), 1);
    // Net total
    const netBillion = capFlow.netTotal / 1e8;
    const netColor = netBillion >= 0 ? 'var(--red)' : 'var(--green)';
    html += `<div style="text-align:center;margin-bottom:8px;font-size:11px">å…¨å¸‚åœºä¸»åŠ›å‡€æµå…¥: <span style="color:${netColor};font-weight:700">${netBillion>=0?'+':''}${netBillion.toFixed(1)}äº¿</span></div>`;
    // Top inflow
    capFlow.topInflow.slice(0,4).forEach(s=>{
      const val = (s.mainNet/1e8).toFixed(1);
      const w = Math.min(100, Math.abs(s.mainNet)/maxAbs*100);
      html += `<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px"><span style="min-width:56px;font-weight:600">${s.name}</span><div class="cap-flow-bar" style="flex:1"><div class="cap-flow-fill" style="width:${w}%;background:var(--red)"></div></div><span style="min-width:46px;text-align:right;color:var(--red);font-weight:600">+${val}äº¿</span></div>`;
    });
    // Top outflow
    capFlow.topOutflow.slice(0,3).forEach(s=>{
      const val = (s.mainNet/1e8).toFixed(1);
      const w = Math.min(100, Math.abs(s.mainNet)/maxAbs*100);
      html += `<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px"><span style="min-width:56px;font-weight:600">${s.name}</span><div class="cap-flow-bar" style="flex:1"><div class="cap-flow-fill" style="width:${w}%;background:var(--green)"></div></div><span style="min-width:46px;text-align:right;color:var(--green);font-weight:600">${val}äº¿</span></div>`;
    });
    html += '</div>';
  }

  // 3. èˆ†æƒ…/æ–°é—»æƒ…ç»ª
  html += '<div class="macro-card"><div class="macro-card-title">ğŸ“° è´¢ç»èˆ†æƒ…åˆ†æ <span style="font-size:9px;font-weight:400;color:var(--sub)">NLPæƒ…ç»ªè¯†åˆ« Â· æ–°æµªè´¢ç»</span></div>';
  // Sentiment meter
  const sentColor = newsSentiment.score>=60 ? 'var(--red)' : newsSentiment.score<=40 ? 'var(--green)' : '#f59e0b';
  html += `<div class="sentiment-meter"><span style="font-size:9px;color:var(--green)">æ‚²è§‚</span><div class="sentiment-bar"><div class="sentiment-dot" style="left:calc(${newsSentiment.score}% - 7px);border-color:${sentColor}"></div></div><span style="font-size:9px;color:var(--red)">ä¹è§‚</span></div>`;
  html += `<div style="text-align:center;font-size:11px;margin-bottom:8px">æƒ…ç»ªæŒ‡æ•°: <span style="color:${sentColor};font-weight:700">${newsSentiment.score}</span>/100 Â· <span style="font-weight:600">${newsSentiment.label}</span> <span style="font-size:9px;color:var(--sub)">(åˆ©å¥½${newsSentiment.bullCount}æ¡ / åˆ©ç©º${newsSentiment.bearCount}æ¡ / å…±${newsSentiment.total}æ¡)</span></div>`;
  // News headlines
  if(newsHeadlines.length > 0){
    const displayNews = newsHeadlines.slice(0, 8);
    displayNews.forEach(n=>{
      const icon = n.sentiment==='bull' ? 'ğŸŸ¢' : n.sentiment==='bear' ? 'ğŸ”´' : 'âšª';
      html += `<div class="news-item"><span class="news-sentiment">${icon}</span><span class="news-text">${n.title}</span><span class="news-time">${n.time}</span></div>`;
    });
  } else {
    html += '<div style="text-align:center;padding:10px;font-size:11px;color:var(--sub)">æš‚æ— æ–°é—»æ•°æ®</div>';
  }
  html += '</div>';

  // 4. ç»¼åˆæ•°æ®ä¿¡å·
  html += '<div class="macro-card" style="background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff">';
  html += '<div class="macro-card-title" style="color:rgba(255,255,255,0.9)">ğŸ¤– AIæ•°æ®ä¿¡å·ç»¼åˆ <span style="font-size:9px;font-weight:400;color:rgba(255,255,255,0.5)">å¤šç»´åº¦èåˆ</span></div>';
  const dataSignal = generateDataSignal();
  html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:6px">`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">å®è§‚é¢</div><div style="font-size:13px;font-weight:700;color:${macro.positiveCount>=3?'#ef4444':'#22c55e'}">${macro.overallSignal}</div></div>`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">èµ„é‡‘é¢</div><div style="font-size:13px;font-weight:700;color:${capFlow.netTotal>=0?'#ef4444':'#22c55e'}">${capFlow.netTotal>=0?'èµ„é‡‘æµå…¥':'èµ„é‡‘æµå‡º'}</div></div>`;
  html += `<div style="text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.5)">èˆ†æƒ…é¢</div><div style="font-size:13px;font-weight:700;color:${sentColor}">${newsSentiment.label}</div></div>`;
  html += '</div>';
  html += `<div style="text-align:center;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)"><div style="font-size:10px;color:rgba(255,255,255,0.5)">ç»¼åˆä¿¡å·</div><div style="font-size:16px;font-weight:800;margin-top:2px;color:${dataSignal.color}">${dataSignal.icon} ${dataSignal.label}</div><div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">${dataSignal.advice}</div></div>`;
  html += '</div>';

  container.innerHTML = html;
}

function generateDataSignal(){
  let score = 50; // 50=ä¸­æ€§
  // å®è§‚é¢ Â±15
  const macro = getMacroSummary();
  score += (macro.positiveCount - 2.5) * 6;
  // èµ„é‡‘é¢ Â±15
  const capFlow = getCapFlowSummary();
  if(capFlow.netTotal > 5e9) score += 15;
  else if(capFlow.netTotal > 0) score += 8;
  else if(capFlow.netTotal < -5e9) score -= 15;
  else if(capFlow.netTotal < 0) score -= 8;
  // èˆ†æƒ…é¢ Â±10
  score += (newsSentiment.score - 50) * 0.2;
  // PMIç‰¹æ®Šæƒé‡
  if(macroData.pmi?.[0]){
    const pmi = macroData.pmi[0].MAKE_INDEX;
    if(pmi >= 51) score += 5;
    else if(pmi < 49) score -= 5;
  }

  score = Math.max(0, Math.min(100, Math.round(score)));
  if(score >= 70) return { score, label:'ç§¯æçœ‹å¤š', icon:'ğŸŸ¢', color:'#ef4444', advice:'å®è§‚+èµ„é‡‘+èˆ†æƒ…ä¸‰ç»´å…±æŒ¯åå¤šï¼Œå¯é€‚å½“å¢é…' };
  if(score >= 58) return { score, label:'è°¨æ…åå¤š', icon:'ğŸŸ¡', color:'#f59e0b', advice:'å¤šæ•°æŒ‡æ ‡åæ­£é¢ï¼Œç»´æŒä»“ä½ã€å¯ä½å¸' };
  if(score >= 42) return { score, label:'ä¸­æ€§è§‚æœ›', icon:'âšª', color:'rgba(255,255,255,0.7)', advice:'ä¿¡å·åˆ†æ­§è¾ƒå¤§ï¼Œç»´æŒç°æœ‰é…ç½®ä¸å®œæ¿€è¿›' };
  if(score >= 30) return { score, label:'è°¨æ…åç©º', icon:'ğŸŸ ', color:'#f59e0b', advice:'éƒ¨åˆ†æŒ‡æ ‡èµ°å¼±ï¼Œæ§åˆ¶ä»“ä½ã€é™ä½é£é™©æ•å£' };
  return { score, label:'é˜²å¾¡ä¸ºä¸»', icon:'ğŸ”´', color:'#22c55e', advice:'å¤šç»´åº¦ä¿¡å·åè´Ÿé¢ï¼Œå»ºè®®é™ä½ä»“ä½ã€å¢åŠ ç°é‡‘' };
}

// ==================== RL BRAIN RENDERING ====================
function toggleRLBrain(){
  const c=document.getElementById('rl-brain-container');
  const i=document.getElementById('rl-brain-toggle');
  if(c.style.display==='none'){c.style.display='block';i.textContent='â–¼';renderRLBrain();}
  else{c.style.display='none';i.textContent='â–¶';}
}

function renderRLBrief(){
  const el=document.getElementById('rl-brain-brief');
  if(!el)return;
  if(_rlTraining){
    el.style.color='#eab308';
    el.textContent=`è®­ç»ƒä¸­ E${(rlTrainer?.episode||0)+1}/${rlTrainer?.maxEpisodes||50}`;
    return;
  }
  if(!_rlModelLoaded||!rlTrainer?.agent){
    el.style.color='var(--sub)';el.textContent='æœªè®­ç»ƒ';return;
  }
  const sigs=Object.values(_rlSignals);
  if(!sigs.length){el.style.color='var(--sub)';el.textContent=`å·²è®­ç»ƒÂ·E${rlTrainer.episode+1}`;return;}
  const buys=sigs.filter(s=>s.action===1).length;
  const sells=sigs.filter(s=>s.action===2).length;
  const holds=sigs.filter(s=>s.action===0).length;
  let txt='ğŸ§  ';
  if(buys>0)txt+=`ä¹°${buys} `;
  if(sells>0)txt+=`å–${sells} `;
  if(holds>0)txt+=`æŒ${holds}`;
  const avgConf=Math.round(sigs.reduce((s,v)=>s+v.confidence,0)/sigs.length);
  el.style.color=buys>sells?'var(--red)':sells>buys?'var(--green)':'var(--sub)';
  el.textContent=txt.trim()+` (${avgConf}%)`;
}

function renderRLBrain(){
  const container=document.getElementById('rl-brain-container');
  if(!container||container.style.display==='none')return;
  const hasModel=_rlModelLoaded&&rlTrainer?.agent;
  const m=rlTrainer?.metrics||{};
  const sClass=_rlTraining?'training':hasModel?'active':'idle';
  const sTxt=_rlTraining?
    `è®­ç»ƒä¸­ Episode ${(rlTrainer.episode||0)+1}/${rlTrainer.maxEpisodes}`:
    hasModel?`å·²å°±ç»ª Â· ${rlTrainer.agent.trainSteps}æ­¥è®­ç»ƒ Â· Îµ=${rlTrainer.agent.epsilon.toFixed(3)}`:'æ¨¡å‹æœªè®­ç»ƒ';

  let html='';
  // Status + Metrics card
  html+=`<div class="rl-card"><div class="rl-card-title">ğŸ§  DQNå¼ºåŒ–å­¦ä¹ å¼•æ“</div>`;
  html+=`<div class="rl-status"><span class="rl-status-dot ${sClass}"></span><span class="rl-status-text">${sTxt}</span></div>`;
  if(_rlTraining&&rlTrainer){
    const pct=Math.round((rlTrainer.episode+1)/rlTrainer.maxEpisodes*100);
    html+=`<div class="rl-progress"><div class="rl-progress-fill" style="width:${pct}%"></div></div>`;
  }
  if(hasModel){
    html+=`<div class="rl-metrics">`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">å¹³å‡æ”¶ç›Š</span><span class="rl-metric-val" style="color:${(m.avgReturn||0)>=0?'var(--red)':'var(--green)'}">${(m.avgReturn||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">èƒœç‡</span><span class="rl-metric-val">${(m.winRate||0).toFixed(0)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Sharpe</span><span class="rl-metric-val">${(m.sharpe||0).toFixed(2)}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">æœ€ä½³å›æŠ¥</span><span class="rl-metric-val" style="color:var(--red)">${(m.bestReturn||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">è®­ç»ƒè½®æ¬¡</span><span class="rl-metric-val">${(rlTrainer.episode||0)+1}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">æ¢ç´¢ç‡Îµ</span><span class="rl-metric-val">${rlTrainer.agent.epsilon.toFixed(3)}</span></div>`;
    html+=`</div>`;
    if(m.portfolios&&m.portfolios.length>1)html+=renderRLChart(m.portfolios,'æ”¶ç›Šç‡%');
  }
  // Train button
  if(_rlTraining){
    html+=`<button class="rl-train-btn stop" onclick="stopRLTraining()">â¹ åœæ­¢è®­ç»ƒ</button>`;
  }else{
    const dc=Object.keys(fundHistoryData).length;
    html+=`<button class="rl-train-btn start" onclick="startRLTraining()" ${dc<1?'disabled title="éœ€è¦å…ˆåŠ è½½å†å²æ•°æ®"':''}>`;
    html+=hasModel?'ğŸ”„ é‡æ–°è®­ç»ƒ (Double DQN)':'ğŸš€ å¼€å§‹è®­ç»ƒ (Double DQN)';
    html+=`</button>`;
  }
  html+=`</div>`;

  // RL Signals card
  if(hasModel&&Object.keys(_rlSignals).length>0){
    html+=`<div class="rl-card"><div class="rl-card-title">ğŸ“Š RLå†³ç­–ä¿¡å· <span style="font-size:9px;color:var(--sub);font-weight:400">Qå€¼é©±åŠ¨</span></div>`;
    for(const code of Object.keys(_rlSignals)){
      const sig=_rlSignals[code];
      const name=fundName(code);
      const ac=sig.action===1?'buy':sig.action===2?'sell':'hold';
      // Q-value bar visualization
      const qAbs=sig.qValues.map(v=>Math.abs(v));
      const qMax=Math.max(...qAbs,0.01);
      html+=`<div class="rl-signal-row">`;
      html+=`<span class="rl-signal-name">${name}</span>`;
      html+=`<div class="rl-qbar">`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[0]/qMax*30}px;background:var(--sub);opacity:0.5" title="Q(æŒæœ‰)=${sig.qValues[0].toFixed(2)}"></div>`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[1]/qMax*30}px;background:var(--red);opacity:0.6" title="Q(ä¹°å…¥)=${sig.qValues[1].toFixed(2)}"></div>`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[2]/qMax*30}px;background:var(--green);opacity:0.6" title="Q(å–å‡º)=${sig.qValues[2].toFixed(2)}"></div>`;
      html+=`</div>`;
      html+=`<span class="rl-signal-action ${ac}">${sig.actionName}</span>`;
      html+=`<span class="rl-signal-conf">${sig.confidence}%</span>`;
      html+=`</div>`;
    }
    html+=`</div>`;
  }

  // Architecture info
  html+=`<div class="rl-card"><div class="rl-card-title">âš™ï¸ æ¨¡å‹æ¶æ„</div>`;
  html+=`<div style="font-size:10px;color:var(--sub);line-height:1.6">`;
  html+=`<b>ç®—æ³•:</b> Double DQN + Experience Replay + Adam Optimizer + åœ¨çº¿å­¦ä¹ <br>`;
  html+=`<b>ç½‘ç»œ:</b> [${RL_STATE_SIZE}] â†’ 64(ReLU) â†’ 32(ReLU) â†’ [${RL_ACTION_SIZE}]<br>`;
  html+=`<b>çŠ¶æ€:</b> åŠ¨é‡(1/5/10/20æ—¥) Â· æ³¢åŠ¨ç‡(5/20æ—¥) Â· RSI Â· MACD Â· MAåç¦» Â· å›æ’¤ Â· æŒä»“ Â· PnL Â· å®è§‚ Â· èˆ†æƒ… Â· èµ„é‡‘ Â· <b style="color:#8b5cf6">å›æµ‹Sharpe Â· Kellyä»“ä½ Â· å›æµ‹RSI</b><br>`;
  html+=`<b>åŠ¨ä½œ:</b> æŒæœ‰(0) / ä¹°å…¥(1) / å–å‡º(2)<br>`;
  html+=`<b>å¥–åŠ±:</b> èµ„äº§å¢å€¼(+) Â· äºæŸ(-) Â· è¿‡åº¦äº¤æ˜“æƒ©ç½š(-) Â· å›æ’¤æƒ©ç½š(-) Â· <b style="color:#f59e0b">åœ¨çº¿å­¦ä¹ åé¦ˆ</b><br>`;
  html+=`<b>è¶…å‚:</b> Î³=0.99 Â· Îµè¡°å‡=0.998 Â· batch=32 Â· è®°å¿†åº“=10K Â· ç›®æ ‡ç½‘ç»œæ›´æ–°=200æ­¥<br>`;
  html+=`<b>è®­ç»ƒ:</b> åŸºäºå…¨éƒ¨æŒä»“/è‡ªé€‰åŸºé‡‘å†å²NAV(è¿‘1å¹´)è®­ç»ƒ Â· æ¯è½®éå†æ‰€æœ‰åŸºé‡‘<br>`;
  html+=`<b>é—­ç¯:</b> <span style="color:#22d3ee">å›æµ‹ç‰¹å¾æ³¨å…¥ â†’ ä¸‰å¼•æ“æŠ•ç¥¨ â†’ æ¨¡æ‹Ÿç›˜åœ¨çº¿å­¦ä¹  â†’ RLä¿¡å·æ›´æ–°</span>`;
  html+=`</div></div>`;

  container.innerHTML=html;
}

function renderRLChart(data,label){
  if(!data||data.length<2)return'';
  const max=Math.max(...data),min=Math.min(...data);
  const range=max-min||1;
  const h=50,w=100;
  const pts=data.map((v,i)=>{
    const x=(i/(data.length-1))*w;
    const y=h-((v-min)/range)*h;
    return`${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  let s=`<div class="rl-chart"><svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s+=`<defs><linearGradient id="rlGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#8b5cf6" stop-opacity="0.3"/><stop offset="100%" stop-color="#8b5cf6" stop-opacity="0.02"/></linearGradient></defs>`;
  s+=`<polygon points="0,${h+2} ${pts} ${w},${h+2}" fill="url(#rlGrad)"/>`;
  s+=`<polyline points="${pts}" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>`;
  // Zero line
  const zeroY=h-((-min)/range)*h;
  if(zeroY>0&&zeroY<h)s+=`<line x1="0" y1="${zeroY.toFixed(1)}" x2="${w}" y2="${zeroY.toFixed(1)}" stroke="rgba(255,255,255,0.15)" stroke-dasharray="2,2"/>`;
  s+=`</svg>`;
  s+=`<div style="position:absolute;bottom:2px;left:4px;font-size:8px;color:var(--sub)">${label}: ${data[data.length-1].toFixed(1)}</div>`;
  s+=`<div style="position:absolute;bottom:2px;right:4px;font-size:8px;color:var(--sub)">E${data.length}</div>`;
  s+=`</div>`;
  return s;
}

async function startRLTraining(){
  if(_rlTraining)return;
  if(!rlTrainer)rlTrainer=new RLTrainer();
  const count=rlTrainer.prepare();
  if(count===0){
    alert('æ²¡æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®è¿›è¡Œè®­ç»ƒã€‚è¯·å…ˆæ·»åŠ æŒä»“åŸºé‡‘å¹¶ç­‰å¾…å†å²æ•°æ®åŠ è½½ã€‚\n\nå½“å‰å·²åŠ è½½å†å²æ•°æ®: '+Object.keys(fundHistoryData).length+' åªåŸºé‡‘');
    return;
  }
  _rlTraining=true;
  renderRLBrain();renderRLBrief();
  console.log(`RLè®­ç»ƒå¼€å§‹: ${count}åªåŸºé‡‘å†å²æ•°æ®, ${rlTrainer.maxEpisodes}è½®è®­ç»ƒ`);

  await rlTrainer.train((ep,total,metrics)=>{
    renderRLBrain();renderRLBrief();
  });

  _rlTraining=false;_rlModelLoaded=true;
  rlTrainer.generateSignals();
  renderRLBrain();renderRLBrief();
  console.log('RLè®­ç»ƒå®Œæˆ:',rlTrainer.metrics);
}

function stopRLTraining(){
  if(rlTrainer)rlTrainer.stop();
  _rlTraining=false;
  renderRLBrain();renderRLBrief();
}

// Build RL context for AI prompt
function buildRLContext(){
  if(!_rlModelLoaded||!rlTrainer?.agent||!Object.keys(_rlSignals).length)return'';
  let ctx='\nã€ğŸ§  RLå¼ºåŒ–å­¦ä¹ ä¿¡å· (DQN)ã€‘\n';
  ctx+=`æ¨¡å‹: Double DQN(18ç»´) Â· å·²è®­ç»ƒ${rlTrainer.episode+1}è½® Â· ${rlTrainer.agent.trainSteps}æ­¥ Â· å«å›æµ‹ç‰¹å¾+åœ¨çº¿å­¦ä¹ \n`;
  ctx+=`æŒ‡æ ‡: èƒœç‡${(rlTrainer.metrics.winRate||0).toFixed(0)}% Â· å¹³å‡æ”¶ç›Š${(rlTrainer.metrics.avgReturn||0).toFixed(1)}% Â· Sharpe${(rlTrainer.metrics.sharpe||0).toFixed(2)}\n`;
  ctx+='ä¸ªè‚¡RLå†³ç­–:\n';
  for(const[code,sig]of Object.entries(_rlSignals)){
    const name=fundName(code);
    const qStr=sig.qValues.map(v=>v.toFixed(2)).join('/');
    ctx+=`  ${name}(${code}): ${sig.actionName}(ç½®ä¿¡${sig.confidence}%) Q[æŒ/ä¹°/å–]=[${qStr}]\n`;
  }
  ctx+='âš ï¸ RLä¿¡å·å·²èåˆå›æµ‹ç‰¹å¾(Sharpe/Kelly/RSI)å¹¶é€šè¿‡æ¨¡æ‹Ÿç›˜äº¤æ˜“åœ¨çº¿å­¦ä¹ ã€‚ä¸‰å¼•æ“æŠ•ç¥¨å…±è¯†: AI/RL/å›æµ‹å¤šæ•°ç¥¨å†³ç­–ï¼Œåˆ†æ­§æ—¶ç¼©å‡ä»“ä½ã€‚\n';
  return ctx;
}

function toggleSimDetail(){
  const container = document.getElementById('sim-container');
  const icon = document.getElementById('sim-toggle-icon');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = 'â–¼';
    renderSimPortfolio();
  } else {
    container.style.display = 'none';
    icon.textContent = 'â–¶';
  }
}

function renderSimBrief(){
  const brief = document.getElementById('sim-brief');
  if(!brief) return;
  if(!simPortfolio || !simPortfolio.positions || simPortfolio.positions.length===0){
    brief.innerHTML = holdings.length>0 ? '<span style="color:var(--sub)">å¾…å»ºä»“</span>' : '<span style="color:var(--sub)">éœ€æŒä»“</span>';
    return;
  }
  const totalValue = getSimTotalValue();
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  let liveCount = 0;
  simPortfolio.positions.forEach(p => { if(getFundData(p.code)?._live) liveCount++; });
  const total = simPortfolio.positions.length;
  const liveTag = liveCount===total ? 'ğŸŸ¢' : liveCount>0 ? 'ğŸŸ¡' : 'ğŸ”´';
  const color = cumProfit >= 0 ? 'var(--red)' : 'var(--green)';
  brief.innerHTML = `<span style="color:${color}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}å…ƒ</span> <span style="font-size:9px">${liveTag}${liveCount}/${total}</span>`;
}

function renderSimPortfolio(){
  const container = document.getElementById('sim-container');
  if(!simPortfolio || !simPortfolio.positions || simPortfolio.positions.length===0){
    const msg = holdings.length===0
      ? 'è¯·å…ˆæ·»åŠ æŒä»“åŸºé‡‘<br><span style="font-size:11px;color:var(--sub)">æ¨¡æ‹Ÿç›˜å°†åŸºäºæ‚¨çš„æŒä»“è‡ªåŠ¨å»ºä»“</span>'
      : '<span>æŒä»“å·²å°±ç»ªï¼Œç‚¹å‡»å»ºä»“å¼€å§‹æ¨¡æ‹Ÿ</span><br><button class="form-btn" style="width:auto;padding:8px 20px;margin-top:10px;font-size:12px" onclick="syncSimFromHoldings()">ğŸš€ ä»æŒä»“å¼€å§‹å»ºä»“</button>';
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“Š</div>${msg}</div>`;
    return;
  }

  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  const targetPct = SIM_TARGET_MONTHLY / SIM_INITIAL_CAPITAL * 100;
  const progressPct = Math.min(100, Math.max(0, cumReturn / targetPct * 100));

  let realPnlPct = 0;
  if(holdings.length > 0){
    holdings.forEach(h => { realPnlPct += (getFundData(h.code).gszzl||0); });
    realPnlPct /= holdings.length;
  }

  const snapshots = simPortfolio.dailySnapshots;
  const latestSnap = snapshots[snapshots.length - 1];
  const todayReturn = latestSnap?.dailyReturn || 0;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300CumPct = latestSnap?.hs300CumReturn || 0;
  const beatMarket = cumReturn > hs300CumPct;

  let html = '';

  // æ¦‚è§ˆå¡ç‰‡
  html += `<div class="sim-overview">
    <div class="sim-stat-row">
      <div class="sim-stat"><div class="sim-stat-label">æ€»èµ„äº§</div><div class="sim-stat-val">${(totalValue/10000).toFixed(2)}<span style="font-size:11px">ä¸‡</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">ç´¯è®¡æ”¶ç›Š</div><div class="sim-stat-val" style="color:${cumProfit>=0?'#ef4444':'#22c55e'}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}<span style="font-size:11px">å…ƒ</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">ç°é‡‘</div><div class="sim-stat-val" style="font-size:14px">${(simPortfolio.cash/10000).toFixed(2)}<span style="font-size:10px">ä¸‡</span></div></div>
    </div>
    <div class="sim-target">
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
        <span>æœˆç›®æ ‡: +Â¥${SIM_TARGET_MONTHLY.toLocaleString()} (${targetPct.toFixed(1)}%)</span>
        <span style="font-weight:600;color:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'rgba(255,255,255,0.5)'}">
          ${cumProfit>=SIM_TARGET_MONTHLY?'âœ… å·²è¾¾æˆ':'è¿›åº¦ '+progressPct.toFixed(0)+'%'}
        </span>
      </div>
      <div class="sim-progress"><div class="sim-progress-fill" style="width:${progressPct}%;background:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'linear-gradient(90deg,#f59e0b,#ef4444)'}"></div></div>
    </div>
  </div>`;

  // å¯¹æ¯”å¡ç‰‡
  html += `<div class="sim-compare">
    <div class="sim-compare-title">ğŸ“Š ä»Šæ—¥å¯¹æ¯”</div>
    <div class="sim-compare-row">
      <div class="sim-compare-item">
        <span class="sim-compare-label">ğŸ¤– æ¨¡æ‹Ÿç›˜</span>
        <span class="sim-compare-val" style="color:${todayReturn>=0?'var(--red)':'var(--green)'}">${todayReturn>=0?'+':''}${todayReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">ğŸ’¼ çœŸå®æŒä»“</span>
        <span class="sim-compare-val" style="color:${realPnlPct>=0?'var(--red)':'var(--green)'}">${holdings.length>0?(realPnlPct>=0?'+':'')+realPnlPct.toFixed(2)+'%':'--'}</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">ğŸ“ˆ æ²ªæ·±300</span>
        <span class="sim-compare-val" style="color:${hs300.pct>=0?'var(--red)':'var(--green)'}">${hs300.pct>=0?'+':''}${fmt(hs300.pct)}%</span>
      </div>
    </div>
    <div class="sim-compare-row" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
      <div class="sim-compare-item">
        <span class="sim-compare-label">ç´¯è®¡æ”¶ç›Šç‡</span>
        <span class="sim-compare-val" style="color:${cumReturn>=0?'var(--red)':'var(--green)'}; font-weight:800">${cumReturn>=0?'+':''}${cumReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">vs æ²ªæ·±300</span>
        <span class="sim-compare-val" style="color:${beatMarket?'var(--red)':'var(--green)'}; font-weight:600">${beatMarket?'è·‘èµ¢':'è·‘è¾“'} ${Math.abs(cumReturn-hs300CumPct).toFixed(2)}%</span>
      </div>
    </div>
  </div>`;

  // æŒä»“æ˜ç»†
  const syncLabel = simPortfolio.syncSource==='holdings' ? ' Â· æ¥è‡ªæŒä»“' : '';
  html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px;display:flex;justify-content:space-between">
    <span>ğŸ“‹ æ¨¡æ‹ŸæŒä»“ (${simPortfolio.positions.length}åª)</span>
    <span style="font-weight:400;color:var(--sub);font-size:10px">å»ºä»“: ${simPortfolio.created}${syncLabel}</span>
  </div>`;

  // æ•°æ®è´¨é‡ç»Ÿè®¡
  {
    let lc=0,hc=0,fc=0;
    simPortfolio.positions.forEach(p=>{const fd=getFundData(p.code);if(fd?._live)lc++;else if(fd?._histFallback)hc++;else fc++;});
    const tp=simPortfolio.positions.length;
    const ls=snapshots.length>0?snapshots[snapshots.length-1]:null;
    html += `<div style="font-size:9px;color:var(--sub);text-align:center;margin:6px 0;padding:4px 8px;background:rgba(255,255,255,0.03);border-radius:6px">
      æ•°æ®æº: ğŸŸ¢å®æ—¶${lc} ${hc>0?'ğŸŸ¡å†å²'+hc+' ':''}${fc>0?'ğŸ”´å¾…æ ¡å‡†'+fc+' ':''}Â· å…±${tp}åª ${ls?.updatedAt?'Â· æ›´æ–° '+ls.updatedAt:''}
    </div>`;
  }

  [...simPortfolio.positions]
    .sort((a,b) => a.group==='core'&&b.group!=='core' ? -1 : a.group!=='core'&&b.group==='core' ? 1 : 0)
    .forEach(pos => {
      const fd = getFundData(pos.code);
      const nav = getSimNav(pos.code) || pos.avgCost;
      const currentValue = pos.shares * nav;
      const pnl = currentValue - pos.investedAmount;
      const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
      const todayPct = fd?.gszzl || 0;
      const weight = currentValue / totalValue * 100;
      const g = pos.group === 'core' ? 'ğŸ›¡ï¸' : 'ğŸš€';
      const dataBadge = fd?._live ? 'ğŸŸ¢' : fd?._histFallback ? 'ğŸŸ¡' : 'ğŸ”´';
      html += `<div class="sim-pos-card">
        <div class="sim-pos-top">
          <div class="sim-pos-info">
            <div class="sim-pos-name">${g} ${pos.name} <span style="font-size:8px">${dataBadge}</span></div>
            <div class="sim-pos-meta">${pos.code} Â· ${pos.type} Â· ${weight.toFixed(1)}%</div>
          </div>
          <div class="sim-pos-right">
            <div class="sim-pos-pct" style="color:${todayPct>=0?'var(--red)':'var(--green)'}">${todayPct>=0?'+':''}${todayPct.toFixed(2)}%</div>
            <div style="font-size:10px;color:${pnlPct>=0?'var(--red)':'var(--green)'}">ç´¯è®¡${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%</div>
          </div>
        </div>
        <div class="sim-pos-detail">
          <span>Â¥${currentValue.toFixed(0)}</span>
          <span>æˆæœ¬Â¥${pos.investedAmount}</span>
          <span style="color:${pnl>=0?'var(--red)':'var(--green)'}">ç›ˆäº${pnl>=0?'+':''}Â¥${pnl.toFixed(0)}</span>
        </div>
      </div>`;
    });

  // ç­–ç•¥å‚æ•°
  html += `<div class="sim-strategy-card">
    <div style="font-size:11px;font-weight:600;margin-bottom:6px">âš™ï¸ å½“å‰ç­–ç•¥å‚æ•° <span style="font-weight:400;color:var(--sub);font-size:9px">AIè‡ªåŠ¨å­¦ä¹ è°ƒä¼˜</span></div>
    <div class="sim-param-grid">
      <div class="sim-param"><span class="sp-label">æ ¸å¿ƒ/å«æ˜Ÿ</span><span class="sp-val">${(simPortfolio.strategy.coreRatio*100).toFixed(0)}/${(simPortfolio.strategy.satRatio*100).toFixed(0)}</span></div>
      <div class="sim-param"><span class="sp-label">æ­¢æŸçº¿</span><span class="sp-val" style="color:var(--green)">${simPortfolio.strategy.stopLoss}%</span></div>
      <div class="sim-param"><span class="sp-label">æ­¢ç›ˆçº¿</span><span class="sp-val" style="color:var(--red)">+${simPortfolio.strategy.takeProfit}%</span></div>
      <div class="sim-param"><span class="sp-label">ä½å¸é˜ˆå€¼</span><span class="sp-val">${simPortfolio.strategy.dipBuyThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">å†²é«˜å‡ä»“</span><span class="sp-val">+${simPortfolio.strategy.surgeSellThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">å•åªä¸Šé™</span><span class="sp-val">${(simPortfolio.strategy.maxSinglePos*100).toFixed(0)}%</span></div>
    </div>
  </div>`;

  // å­¦ä¹ æ—¥å¿—
  if(simPortfolio.learningLog && simPortfolio.learningLog.length > 0){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">ğŸ§  ç­–ç•¥å­¦ä¹ æ—¥å¿—</div>`;
    simPortfolio.learningLog.slice(-5).reverse().forEach(log => {
      html += `<div class="sim-learn-card">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--sub)">
          <span>${log.date}</span><span>ç´¯è®¡${log.cumReturn>=0?'+':''}${log.cumReturn}%</span>
        </div>
        ${log.lesson ? `<div style="font-size:11px;margin-top:4px;line-height:1.5">ğŸ“Œ ${log.lesson}</div>` : ''}
        ${log.strategyChange ? `<div style="font-size:10px;color:var(--primary);margin-top:2px">âš™ï¸ ${log.strategyChange}</div>` : ''}
      </div>`;
    });
  }

  // äº¤æ˜“è®°å½•
  const recentTrades = (simPortfolio.history || []).slice(-8).reverse();
  if(recentTrades.length > 0){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">ğŸ“œ æœ€è¿‘äº¤æ˜“ <span style="font-weight:400;color:var(--sub)">(å…±${simPortfolio.history.length}ç¬”)</span></div>`;
    recentTrades.forEach(t => {
      const actionColor = t.action==='buy'?'var(--red)':'var(--green)';
      const actionIcon = t.action==='buy'?'ğŸŸ¢ä¹°':'ğŸ”´å–';
      html += `<div class="sim-trade-item">
        <span style="color:${actionColor};font-weight:600;min-width:36px">${actionIcon}</span>
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.name||t.code}</span>
        <span style="min-width:56px;text-align:right;font-weight:600">Â¥${t.amount.toLocaleString()}</span>
        <span style="min-width:70px;text-align:right;color:var(--sub)">${t.date}</span>
      </div>`;
    });
  }

  // æ”¶ç›Šèµ°åŠ¿
  if(snapshots.length >= 2){
    html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px">ğŸ“ˆ æ”¶ç›Šèµ°åŠ¿ (${snapshots.length}å¤©)</div><div class="sim-chart">`;
    const displaySnaps = snapshots.slice(-15);
    const maxRet = Math.max(...displaySnaps.map(s => Math.abs(s.cumReturn)), 0.1);
    displaySnaps.forEach(s => {
      const w = Math.abs(s.cumReturn) / maxRet * 100;
      const color = s.cumReturn >= 0 ? 'var(--red)' : 'var(--green)';
      html += `<div class="sim-chart-row">
        <span class="sim-chart-date">${s.date.slice(5)}</span>
        <div class="sim-chart-bar"><div style="width:${Math.max(w,2)}%;height:100%;background:${color};border-radius:3px"></div></div>
        <span class="sim-chart-val" style="color:${color}">${s.cumReturn>=0?'+':''}${s.cumReturn.toFixed(2)}%</span>
      </div>`;
    });
    html += `</div>`;
  }

  // äº¤æ˜“æ—¥/ä¼‘å¸‚çŠ¶æ€
  const msSim = getMarketStatus();
  const tradingTag = isTradingDay() ? (msSim.status==='open'?'ğŸŸ¢ äº¤æ˜“ä¸­':'â¸ '+msSim.text) : 'ğŸ”´ ä»Šæ—¥ä¼‘å¸‚';
  html += `<div style="text-align:center;margin:10px 0 4px;font-size:10px;color:var(--sub)">${tradingTag}${msSim.isHoliday?' (èŠ‚å‡æ—¥)':''}</div>`;

  html += `<div style="text-align:center;margin-top:8px;display:flex;gap:10px;justify-content:center">
    <span style="font-size:10px;color:var(--primary);cursor:pointer;text-decoration:underline" onclick="syncSimFromHoldings()">ğŸ”„ åŒæ­¥æŒä»“é‡å»º</span>
    <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="resetSimPortfolio()">â†© é‡ç½®æ¨¡æ‹Ÿç›˜</span>
  </div>`;

  container.innerHTML = html;
  renderSimBrief();
}

function resetSimPortfolio(){
  if(holdings.length === 0){ alert('è¯·å…ˆæ·»åŠ æŒä»“åŸºé‡‘ï¼Œæ¨¡æ‹Ÿç›˜å°†åŸºäºæ‚¨çš„æŒä»“å»ºä»“'); return; }
  if(!confirm(`ç¡®è®¤é‡ç½®æ¨¡æ‹Ÿç›˜ï¼Ÿ\n\nå°†ä»¥50ä¸‡èµ„é‡‘ï¼ŒæŒ‰æ‚¨å½“å‰${holdings.length}åªæŒä»“ç­‰æƒå»ºä»“ã€‚`)) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  buildSimFromHoldings();
  updateSimDaily();
  renderSimPortfolio();
  renderSimBrief();
}

function syncSimFromHoldings(){
  if(holdings.length === 0){ alert('è¯·å…ˆæ·»åŠ æŒä»“åŸºé‡‘'); return; }
  if(!confirm(`åŒæ­¥æŒä»“åˆ°æ¨¡æ‹Ÿç›˜ï¼Ÿ\n\nå°†é‡ç½®æ¨¡æ‹Ÿç›˜ï¼Œä»¥50ä¸‡èµ„é‡‘æŒ‰æ‚¨å½“å‰${holdings.length}åªæŒä»“é‡æ–°å»ºä»“ã€‚\nâš ï¸ æ‰€æœ‰æ¨¡æ‹Ÿäº¤æ˜“è®°å½•å°†è¢«æ¸…é™¤ã€‚`)) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  buildSimFromHoldings();
  updateSimDaily();
  renderSimPortfolio();
  renderSimBrief();
}

// ==================== INITIALIZATION ====================
async function loadData(){
  await Promise.all([fetchIndices(), fetchSectors(), fetchAllFunds()]);
  renderAll();
  // å¼‚æ­¥åŠ è½½å†å²æ•°æ®å’Œæ•°æ®æƒ…æŠ¥ï¼ˆä¸é˜»å¡ä¸»æ¸²æŸ“ï¼‰
  fetchAllHistory().then(()=>{
    console.log('å†å²è¶‹åŠ¿æ•°æ®åŠ è½½å®Œæˆ:', Object.keys(fundHistoryData).length, 'åªåŸºé‡‘');
    // å†å²æ•°æ®åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–RLå¤§è„‘
    initRLBrain();
    // è‡ªåŠ¨è¿è¡Œå›æµ‹ï¼ˆå¦‚æœæ²¡æœ‰ç¼“å­˜ç»“æœï¼‰
    if(!btSummary && Object.keys(fundHistoryData).length > 0){
      console.log('è‡ªåŠ¨å¯åŠ¨å›æµ‹...');
      setTimeout(()=>runBacktest(), 500);
    }
  }).catch(e=>console.warn('å†å²æ•°æ®åŠ è½½å¤±è´¥:', e));
  // æ•°æ®æƒ…æŠ¥ä¸­å¿ƒï¼šå®è§‚+èµ„é‡‘+èˆ†æƒ…
  fetchAllDataIntel().then(()=>{
    console.log('æ•°æ®æƒ…æŠ¥åŠ è½½å®Œæˆ: å®è§‚/èµ„é‡‘/èˆ†æƒ…');
    renderDataIntelBrief();
  }).catch(e=>console.warn('æ•°æ®æƒ…æŠ¥åŠ è½½å¤±è´¥:', e));
}

function startTimers(){
  _countdownTimer = setInterval(()=>{ renderCountdown(); }, 1000);

  _refreshTimer = setInterval(async ()=>{
    const ms = getMarketStatus();
    if(ms.status==='open' || ms.status==='break'){
      await Promise.all([fetchIndices(), fetchAllFunds()]);
      renderIndices();
      renderStats();
      if(_analysisResult) renderSignals();
      // åˆ·æ–°æ¨¡æ‹Ÿç›˜æ•°æ®ï¼ˆç”¨æœ€æ–°å¸‚åœºæ•°æ®æ›´æ–°ï¼‰
      updateSimDaily();
      renderSimBrief();
      if(document.getElementById('sim-container')?.style.display !== 'none'){
        renderSimPortfolio();
      }
      // åˆ·æ–°æ•°æ®æƒ…æŠ¥ï¼ˆèµ„é‡‘æµå’Œæ–°é—»æ¯30sæ›´æ–°ï¼‰
      fetchSectorCapFlow().catch(()=>{});
      fetchNewsHeadlines().then(()=>{
        renderDataIntelBrief();
        if(document.getElementById('data-intel-container')?.style.display !== 'none'){
          renderDataIntel();
        }
      }).catch(()=>{});
    }
  }, 30000);
}

(async function init(){
  renderCountdown();
  renderAll();
  startTimers();
  await loadData();

  // åˆå§‹åŒ–æ¨¡æ‹Ÿç›˜
  initSimPortfolio();
  updateSimDaily();
  renderSimBrief();

  generateDailyReview();
  renderReview();

  // åˆå§‹åŒ–RLè®­ç»ƒå™¨ï¼ˆå°è¯•åŠ è½½å·²ä¿å­˜æ¨¡å‹ï¼‰
  rlTrainer = new RLTrainer();
  if(rlTrainer.loadModel()){
    renderRLBrief();
  }

  // åŠ è½½å›æµ‹ç¼“å­˜
  loadBTResults();

  // Auto-trigger AI if we have holdings/watchlist and API key
  if(_aiKey && (holdings.length>0 || watchlist.length>0)){
    triggerAI();
  }
})();

// RL Brain initialization (called after history data loads)
function initRLBrain(){
  if(!rlTrainer)rlTrainer=new RLTrainer();
  if(_rlModelLoaded && rlTrainer.agent){
    rlTrainer.generateSignals();
    renderRLBrief();
    if(document.getElementById('rl-brain-container')?.style.display!=='none')renderRLBrain();
    console.log('RLä¿¡å·å·²æ›´æ–°:', Object.keys(_rlSignals).length, 'åªåŸºé‡‘');
  }
}

// ==================== BACKTEST ENGINE ====================
// çº¯JSå®ç°: RSIç­–ç•¥è¿‡æ»¤ + Kellyä»“ä½ç®¡ç† + å®Œæ•´å›æµ‹æŒ‡æ ‡
// ç­–ç•¥: é¢„æµ‹æ¶¨å¹…>1% + RSI<70 â†’ ä¹°å…¥; RSI>75 â†’ å–å‡º
// ä»“ä½: Kelly f* = (bp-q)/b

function btCalcRSI(prices, period){
  const rsi = new Array(prices.length).fill(50);
  if(prices.length < period + 1) return rsi;
  let avgGain = 0, avgLoss = 0;
  for(let i = 1; i <= period; i++){
    const d = prices[i] - prices[i-1];
    if(d > 0) avgGain += d; else avgLoss += Math.abs(d);
  }
  avgGain /= period; avgLoss /= period;
  rsi[period] = avgLoss === 0 ? 100 : 100 - 100/(1 + avgGain/avgLoss);
  for(let i = period + 1; i < prices.length; i++){
    const d = prices[i] - prices[i-1];
    avgGain = (avgGain * (period-1) + (d > 0 ? d : 0)) / period;
    avgLoss = (avgLoss * (period-1) + (d < 0 ? Math.abs(d) : 0)) / period;
    rsi[i] = avgLoss === 0 ? 100 : 100 - 100/(1 + avgGain/avgLoss);
  }
  return rsi;
}

function btCalcMA(prices, period){
  const ma = [];
  for(let i = 0; i < prices.length; i++){
    if(i < period - 1){ ma.push(prices[i]); continue; }
    let s = 0; for(let j = i - period + 1; j <= i; j++) s += prices[j];
    ma.push(s / period);
  }
  return ma;
}

function btCalcMACD(prices){
  // EMA12, EMA26, MACD signal
  const ema = (arr, k) => {
    const mult = 2/(k+1); const r = [arr[0]];
    for(let i=1;i<arr.length;i++) r.push(arr[i]*mult+r[i-1]*(1-mult));
    return r;
  };
  const e12 = ema(prices, 12), e26 = ema(prices, 26);
  const dif = e12.map((v,i) => v - e26[i]);
  const dea = ema(dif, 9);
  return { dif, dea, hist: dif.map((v,i) => 2*(v-dea[i])) };
}

function btCalcVolatility(prices, period){
  const vol = [];
  for(let i = 0; i < prices.length; i++){
    if(i < period){ vol.push(0); continue; }
    const rets = [];
    for(let j = i-period+1; j <= i; j++) rets.push((prices[j]-prices[j-1])/prices[j-1]);
    const mu = rets.reduce((s,v)=>s+v,0)/rets.length;
    const variance = rets.reduce((s,v)=>s+(v-mu)**2,0)/rets.length;
    vol.push(Math.sqrt(variance));
  }
  return vol;
}

// å‡¯åˆ©å…¬å¼: f* = (b*p - q) / b
function kellyFraction(winRate, avgWin, avgLoss){
  if(avgLoss === 0 || winRate <= 0) return 0;
  const b = Math.abs(avgWin / avgLoss); // èµ”ç‡ = å¹³å‡ç›ˆåˆ©/å¹³å‡äºæŸ
  const p = winRate;
  const q = 1 - p;
  let f = (b * p - q) / b;
  f = Math.max(0, Math.min(0.25, f)); // é™åˆ¶æœ€å¤§ä»“ä½25% (åŠKelly)
  return f;
}

// å•åªåŸºé‡‘å›æµ‹
function backtestFund(navArray, code){
  if(!navArray || navArray.length < 60) return null;
  const prices = navArray.map(n => typeof n.nav === 'number' ? n.nav : parseFloat(n.nav || n[1]));
  const dates = navArray.map(n => n.date || n[0]);
  const n = prices.length;

  // æŠ€æœ¯æŒ‡æ ‡
  const rsi = btCalcRSI(prices, BT_RSI_PERIOD);
  const ma5 = btCalcMA(prices, 5);
  const ma20 = btCalcMA(prices, 20);
  const macd = btCalcMACD(prices);
  const vol20 = btCalcVolatility(prices, 20);

  // å›æµ‹çŠ¶æ€
  let cash = 100000;
  const initialCash = cash;
  let shares = 0;
  let entryPrice = 0;
  let position = 0; // 0~1 ä»“ä½æ¯”ä¾‹
  const trades = [];
  const equity = []; // å‡€å€¼æ›²çº¿
  const drawdown = []; // å›æ’¤æ›²çº¿
  let peak = initialCash;
  let wins = 0, losses = 0;
  let totalWinAmt = 0, totalLossAmt = 0;
  let _currentKelly = 0;

  // æ»šåŠ¨ç»Ÿè®¡(ç”¨äºKelly)
  const recentTrades = []; // æœ€è¿‘Næ¬¡äº¤æ˜“çš„ç›ˆäºç‡

  const startIdx = Math.max(26, BT_RSI_PERIOD + 1); // ç¡®ä¿æŒ‡æ ‡å·²è®¡ç®—

  for(let i = startIdx; i < n; i++){
    const price = prices[i];
    const totalValue = cash + shares * price;
    equity.push({ date: dates[i], value: totalValue / initialCash });
    peak = Math.max(peak, totalValue);
    drawdown.push({ date: dates[i], dd: (totalValue - peak) / peak });

    // é¢„æµ‹æ˜æ—¥æ¶¨å¹…(ç®€åŒ–: ç”¨åŠ¨é‡+MACD+MAè¶‹åŠ¿ä¼°ç®—)
    const ret5d = i >= 5 ? (prices[i] - prices[i-5])/prices[i-5] : 0;
    const macdHist = macd.hist[i];
    const maTrend = (ma5[i] - ma20[i]) / ma20[i];
    const predictedReturn = ret5d * 0.3 + macdHist / price * 50 + maTrend * 2;

    // è®¡ç®—æ»šåŠ¨Kelly
    if(recentTrades.length >= 5){
      const wt = recentTrades.filter(r => r > 0);
      const lt = recentTrades.filter(r => r <= 0);
      const wr = wt.length / recentTrades.length;
      const aw = wt.length > 0 ? wt.reduce((s,v)=>s+v,0)/wt.length : 0.01;
      const al = lt.length > 0 ? Math.abs(lt.reduce((s,v)=>s+v,0)/lt.length) : 0.01;
      _currentKelly = kellyFraction(wr, aw, al);
    } else {
      _currentKelly = 0.05; // é»˜è®¤5%ä»“ä½
    }

    // === RLèåˆå›æµ‹ç­–ç•¥ä¿¡å· ===
    // åœ¨å›æµ‹ä¸­å¼•å…¥RLä¿¡å·ä½œä¸ºè¾…åŠ©ç¡®è®¤æ¡ä»¶
    let rlBuyBoost = 0, rlSellBoost = 0;
    if(_rlModelLoaded && rlTrainer?.agent && typeof _rlSignals !== 'undefined'){
      const rlSig = _rlSignals[code];
      if(rlSig){
        if(rlSig.action === 1 && rlSig.confidence > 40) rlBuyBoost = 0.3; // RLçœ‹å¤šåŠ å¼ºä¹°å…¥
        if(rlSig.action === 2 && rlSig.confidence > 40) rlSellBoost = 0.3; // RLçœ‹ç©ºåŠ å¼ºå–å‡º
        if(rlSig.action === 2 && rlSig.confidence > 60) rlBuyBoost = -0.5; // RLå¼ºçƒˆçœ‹ç©ºæŠ‘åˆ¶ä¹°å…¥
        if(rlSig.action === 1 && rlSig.confidence > 60) rlSellBoost = -0.5; // RLå¼ºçƒˆçœ‹å¤šæŠ‘åˆ¶å–å‡º
      }
    }

    // ä¹°å…¥: é¢„æµ‹æ¶¨å¹…>1% + RSI<70 + MA5>MA20(è¶‹åŠ¿å‘ä¸Š) + RLä¿¡å·èåˆ
    const adjMomentumBuy = BT_MOMENTUM_BUY * (1 - rlBuyBoost); // RLçœ‹å¤šæ—¶é™ä½é—¨æ§›
    if(predictedReturn > adjMomentumBuy && rsi[i] < BT_RSI_BUY && ma5[i] > ma20[i] && position < 0.9){
      const kellyAdj = _currentKelly * (1 + rlBuyBoost); // RLçœ‹å¤šæ—¶æ”¾å¤§Kelly
      const targetPos = Math.min(position + kellyAdj, 0.95);
      const addPos = targetPos - position;
      if(addPos > 0.02){
        const buyAmt = Math.round(totalValue * addPos);
        const fee = Math.round(buyAmt * BT_FEE);
        const buyShares = (buyAmt - fee) / price;
        if(cash >= buyAmt){
          cash -= buyAmt;
          shares += buyShares;
          if(position === 0) entryPrice = price;
          else entryPrice = (entryPrice * position + price * addPos) / (position + addPos);
          position = targetPos;
          trades.push({
            date: dates[i], action: 'buy', price, shares: buyShares, amount: buyAmt,
            rsi: rsi[i], kelly: kellyAdj, predicted: predictedReturn, rlBoost: rlBuyBoost, fee
          });
        }
      }
    }

    // å–å‡º: RSI>75 æˆ– è¶‹åŠ¿åè½¬(MA5<MA20ä¸”æŒä»“) æˆ– æ­¢æŸ(-5%) + RLèåˆ
    const pnlPct = position > 0 ? (price - entryPrice) / entryPrice : 0;
    const adjRsiSell = BT_RSI_SELL - Math.round(rlSellBoost * 10); // RLçœ‹ç©ºæ—¶é™ä½å–å‡ºRSIé—¨æ§›
    const shouldSell = (rsi[i] > adjRsiSell && position > 0.2)
      || (ma5[i] < ma20[i] && position > 0.3 && macdHist < 0)
      || (pnlPct < -0.05 && position > 0); // æ­¢æŸ

    if(shouldSell && position > 0){
      let sellRatio = 0.5 * (1 + rlSellBoost); // RLçœ‹ç©ºæ—¶æ”¾å¤§å–å‡ºæ¯”ä¾‹
      if(rsi[i] > 80) sellRatio = 0.8;
      if(pnlPct < -0.05) sellRatio = 1.0; // æ­¢æŸå…¨å–
      if(ma5[i] < ma20[i] && macdHist < -0.001) sellRatio = Math.max(sellRatio, 0.7);
      sellRatio = Math.min(sellRatio, 1.0);

      const sellShares = Math.floor(shares * sellRatio * 100) / 100;
      const sellAmt = Math.round(sellShares * price);
      const fee = Math.round(sellAmt * BT_FEE);
      cash += sellAmt - fee;
      shares -= sellShares;
      position = shares * price / (cash + shares * price);

      const tradeReturn = (price - entryPrice) / entryPrice;
      recentTrades.push(tradeReturn);
      if(recentTrades.length > 20) recentTrades.shift();
      if(tradeReturn > 0){ wins++; totalWinAmt += tradeReturn; }
      else{ losses++; totalLossAmt += Math.abs(tradeReturn); }

      trades.push({
        date: dates[i], action: 'sell', price, shares: sellShares, amount: sellAmt,
        rsi: rsi[i], pnl: (tradeReturn*100).toFixed(2)+'%', reason:
          pnlPct<-0.05?'æ­¢æŸ':rsi[i]>80?'RSIè¶…ä¹°':ma5[i]<ma20[i]?'è¶‹åŠ¿åè½¬':'è·åˆ©äº†ç»“', fee
      });

      if(shares < 0.01){ shares = 0; position = 0; entryPrice = 0; }
    }
  }

  // æœ€ç»ˆè¯„ä¼°
  const finalValue = cash + shares * prices[n-1];
  const totalReturn = (finalValue - initialCash) / initialCash;
  const tradingDays = equity.length;
  const annualFactor = 250;

  // å¹´åŒ–æ”¶ç›Š
  const years = tradingDays / annualFactor;
  const annualReturn = years > 0 ? Math.pow(1 + totalReturn, 1/years) - 1 : totalReturn;

  // æ—¥æ”¶ç›Šç‡åºåˆ—
  const dailyReturns = [];
  for(let i = 1; i < equity.length; i++){
    dailyReturns.push(equity[i].value / equity[i-1].value - 1);
  }
  const avgDaily = dailyReturns.length > 0 ? dailyReturns.reduce((s,v)=>s+v,0)/dailyReturns.length : 0;
  const stdDaily = dailyReturns.length > 1 ? Math.sqrt(dailyReturns.reduce((s,v)=>s+(v-avgDaily)**2,0)/(dailyReturns.length-1)) : 1;

  // Sharpe Ratio (å¹´åŒ–)
  const dailyRF = BT_RISK_FREE / annualFactor;
  const sharpe = stdDaily > 0 ? (avgDaily - dailyRF) / stdDaily * Math.sqrt(annualFactor) : 0;

  // Max Drawdown
  const maxDD = drawdown.length > 0 ? Math.min(...drawdown.map(d=>d.dd)) : 0;

  // Calmar Ratio
  const calmar = maxDD !== 0 ? annualReturn / Math.abs(maxDD) : 0;

  // Sortino Ratio (ä¸‹è¡Œæ ‡å‡†å·®)
  const downReturns = dailyReturns.filter(r => r < 0);
  const downDev = downReturns.length > 0 ? Math.sqrt(downReturns.reduce((s,v)=>s+v*v,0)/downReturns.length) : stdDaily;
  const sortino = downDev > 0 ? (avgDaily - dailyRF) / downDev * Math.sqrt(annualFactor) : 0;

  // Win Rate & Kelly (æ•´ä½“)
  const totalTrades = wins + losses;
  const winRate = totalTrades > 0 ? wins / totalTrades : 0;
  const avgWin = wins > 0 ? totalWinAmt / wins : 0;
  const avgLoss = losses > 0 ? totalLossAmt / losses : 0.01;
  const finalKelly = kellyFraction(winRate, avgWin, avgLoss);

  // Buy & Holdå¯¹æ¯”
  const bhReturn = (prices[n-1] - prices[startIdx]) / prices[startIdx];

  return {
    code, totalReturn, annualReturn, sharpe, sortino, calmar,
    maxDD, winRate, wins, losses, totalTrades,
    avgWin, avgLoss, finalKelly,
    bhReturn, // Buy & Hold
    equity, drawdown, trades,
    tradingDays, years,
    finalValue, initialCash,
    lastRSI: rsi[n-1],
    currentKelly: _currentKelly
  };
}

// å…¨éƒ¨åŸºé‡‘å›æµ‹
async function runBacktest(){
  if(_btRunning) return;
  _btRunning = true;
  btResults = {};

  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  if(codes.length === 0){
    alert('è¯·å…ˆæ·»åŠ æŒä»“æˆ–è‡ªé€‰åŸºé‡‘');
    _btRunning = false;
    return;
  }

  renderBTBrief();
  renderBacktest();

  let completed = 0;
  const allEquity = [];

  for(const code of codes){
    const hd = fundHistoryData[code];
    if(!hd || !hd.navs || hd.navs.length < 60) continue;

    const navArr = hd.navs.map(n => typeof n === 'object' && n.nav !== undefined ?
      n : { date: n[0], nav: parseFloat(n[1]) }
    ).filter(n => !isNaN(n.nav) && n.nav > 0);

    const result = backtestFund(navArr, code);
    if(result){
      btResults[code] = result;
      allEquity.push(result);
      completed++;
    }

    // ä¸é˜»å¡UI
    if(completed % 2 === 0) await new Promise(r => setTimeout(r, 0));
  }

  // ç»„åˆå›æµ‹æ±‡æ€»
  if(Object.keys(btResults).length > 0){
    const results = Object.values(btResults);
    const avgReturn = results.reduce((s,r)=>s+r.totalReturn,0)/results.length;
    const avgSharpe = results.reduce((s,r)=>s+r.sharpe,0)/results.length;
    const worstDD = Math.min(...results.map(r=>r.maxDD));
    const avgWinRate = results.reduce((s,r)=>s+r.winRate,0)/results.length;
    const avgKelly = results.reduce((s,r)=>s+r.finalKelly,0)/results.length;
    const avgBH = results.reduce((s,r)=>s+r.bhReturn,0)/results.length;
    const totalTrades = results.reduce((s,r)=>s+r.totalTrades,0);
    const bestFund = results.reduce((a,b)=>a.sharpe>b.sharpe?a:b);
    const worstFund = results.reduce((a,b)=>a.sharpe<b.sharpe?a:b);

    btSummary = {
      avgReturn, avgSharpe, worstDD, avgWinRate, avgKelly, avgBH,
      totalTrades, fundCount: results.length,
      bestFund: bestFund.code, worstFund: worstFund.code,
      excessReturn: avgReturn - avgBH, // è¶…é¢æ”¶ç›Š
      timestamp: Date.now()
    };

    // ä¿å­˜åˆ°localStorage
    try{
      localStorage.setItem(BT_STORAGE_KEY, JSON.stringify({
        results: Object.fromEntries(Object.entries(btResults).map(([k,v])=>
          [k, { code:v.code, totalReturn:v.totalReturn, annualReturn:v.annualReturn, sharpe:v.sharpe, sortino:v.sortino, calmar:v.calmar, maxDD:v.maxDD, winRate:v.winRate, wins:v.wins, losses:v.losses, totalTrades:v.totalTrades, avgWin:v.avgWin, avgLoss:v.avgLoss, finalKelly:v.finalKelly, bhReturn:v.bhReturn, lastRSI:v.lastRSI, currentKelly:v.currentKelly, tradingDays:v.tradingDays }]
        )),
        summary: btSummary
      }));
    }catch(e){ console.warn('å›æµ‹ç»“æœä¿å­˜å¤±è´¥:', e); }
  }

  _btRunning = false;
  renderBTBrief();
  renderBacktest();
  console.log('å›æµ‹å®Œæˆ:', Object.keys(btResults).length, 'åªåŸºé‡‘', btSummary);
}

// ==================== BACKTEST RENDERING ====================

function toggleBacktest(){
  const c = document.getElementById('bt-container');
  const icon = document.getElementById('bt-toggle');
  if(c.style.display === 'none'){
    c.style.display = 'block'; icon.textContent = 'â–¼';
    renderBacktest();
  } else {
    c.style.display = 'none'; icon.textContent = 'â–¶';
  }
}

function renderBTBrief(){
  const el = document.getElementById('bt-brief');
  if(!el) return;
  if(_btRunning){
    el.style.color = '#eab308';
    el.textContent = `å›æµ‹ä¸­...${Object.keys(btResults).length}åª`;
    return;
  }
  if(!btSummary){
    el.style.color = 'var(--sub)'; el.textContent = 'æœªå›æµ‹'; return;
  }
  const ret = (btSummary.avgReturn*100).toFixed(1);
  const sh = btSummary.avgSharpe.toFixed(2);
  el.style.color = btSummary.avgReturn >= 0 ? 'var(--red)' : 'var(--green)';
  el.textContent = `æ”¶ç›Š${ret}% Â· Sharpe ${sh}`;
}

function renderBacktest(){
  const container = document.getElementById('bt-container');
  if(!container || container.style.display === 'none') return;

  const hasResults = btSummary && Object.keys(btResults).length > 0;
  let html = '';

  // Run Button + Status
  html += `<div class="bt-card"><div class="bt-card-title">ğŸ“Š ç­–ç•¥å›æµ‹å¼•æ“</div>`;
  html += `<div style="font-size:10px;color:var(--sub);margin-bottom:6px">`;
  html += `ç­–ç•¥: é¢„æµ‹æ¶¨å¹…>1% + RSI<${BT_RSI_BUY} â†’ ä¹°å…¥ | RSI>${BT_RSI_SELL}æˆ–è¶‹åŠ¿åè½¬ â†’ å–å‡º<br>`;
  html += `ä»“ä½: Kelly f*=(bp-q)/b Â· å•æ¬¡æœ€å¤§25%(åŠKelly) Â· æ€»ä»“ä½â‰¤95%`;
  html += `</div>`;
  if(_btRunning){
    html += `<button class="bt-run-btn" disabled>â³ å›æµ‹ä¸­... (${Object.keys(btResults).length}åª)</button>`;
  } else {
    const dc = Object.keys(fundHistoryData).length;
    html += `<button class="bt-run-btn" onclick="runBacktest()" ${dc<1?'disabled title="éœ€è¦å…ˆåŠ è½½å†å²æ•°æ®"':''}>`;
    html += hasResults ? 'ğŸ”„ é‡æ–°å›æµ‹ (RSI+Kelly)' : 'ğŸš€ å¼€å§‹å›æµ‹ (RSI+Kelly)';
    html += `</button>`;
  }
  html += `</div>`;

  if(!hasResults){
    container.innerHTML = html;
    return;
  }

  const s = btSummary;
  const results = Object.values(btResults);

  // Summary Metrics
  html += `<div class="bt-card"><div class="bt-card-title">ğŸ“ˆ ç»„åˆå›æµ‹æ¦‚è§ˆ <span style="font-size:9px;color:var(--sub);font-weight:400">${s.fundCount}åªåŸºé‡‘</span></div>`;
  html += `<div class="bt-metrics">`;
  html += btMetricHTML('å¹³å‡æ”¶ç›Š', (s.avgReturn*100).toFixed(1)+'%', s.avgReturn>=0?'var(--red)':'var(--green)');
  html += btMetricHTML('Sharpe', s.avgSharpe.toFixed(2), s.avgSharpe>=1?'var(--red)':s.avgSharpe>=0?'#f59e0b':'var(--green)');
  html += btMetricHTML('æœ€å¤§å›æ’¤', (s.worstDD*100).toFixed(1)+'%', 'var(--green)');
  html += btMetricHTML('èƒœç‡', (s.avgWinRate*100).toFixed(0)+'%', s.avgWinRate>=0.5?'var(--red)':'var(--sub)');
  html += btMetricHTML('Kellyä»“ä½', (s.avgKelly*100).toFixed(1)+'%', '#8b5cf6');
  html += btMetricHTML('è¶…é¢æ”¶ç›Š', (s.excessReturn>0?'+':'')+(s.excessReturn*100).toFixed(1)+'%', s.excessReturn>=0?'var(--red)':'var(--green)');
  html += `</div>`;

  // Kellyä»“ä½å¯è§†åŒ–
  const kellyPct = Math.round(s.avgKelly * 100);
  const cashPct = 100 - kellyPct;
  html += `<div style="font-size:9px;color:var(--sub);margin-top:8px">å‡¯åˆ©å»ºè®®ä»“ä½</div>`;
  html += `<div class="bt-kelly-bar">`;
  html += `<div class="bt-kelly-seg" style="width:${kellyPct}%;background:linear-gradient(90deg,#3b82f6,#8b5cf6)">${kellyPct}%ä»“</div>`;
  html += `<div class="bt-kelly-seg" style="width:${cashPct}%;background:rgba(148,163,184,0.2);color:var(--sub)">${cashPct}%ç°é‡‘</div>`;
  html += `</div>`;
  html += `</div>`;

  // Equity Chart (ç»„åˆå¹³å‡å‡€å€¼æ›²çº¿)
  const bestResult = btResults[s.bestFund];
  if(bestResult && bestResult.equity.length > 2){
    html += `<div class="bt-card"><div class="bt-card-title">ğŸ“‰ å‡€å€¼ & å›æ’¤æ›²çº¿ <span style="font-size:9px;color:var(--sub);font-weight:400">${fundName(s.bestFund)}(æœ€ä¼˜Sharpe)</span></div>`;
    html += renderBTChart(bestResult.equity, bestResult.bhReturn);
    html += `<div style="margin-top:4px">`;
    html += renderBTDDChart(bestResult.drawdown);
    html += `</div></div>`;
  }

  // Per-fund results
  html += `<div class="bt-card"><div class="bt-card-title">ğŸ“‹ å„åŸºé‡‘å›æµ‹è¯¦æƒ…</div>`;
  html += `<div style="display:flex;gap:4px;padding:3px 0;border-bottom:1px solid var(--border);margin-bottom:4px">`;
  html += `<span style="font-size:9px;color:var(--sub);flex:1">åŸºé‡‘</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:50px;text-align:right">æ”¶ç›Šç‡</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:40px;text-align:right">Sharpe</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:45px;text-align:right">æœ€å¤§å›æ’¤</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:35px;text-align:right">Kelly</span>`;
  html += `</div>`;
  const sorted = results.sort((a,b) => b.sharpe - a.sharpe);
  sorted.forEach(r => {
    const retColor = r.totalReturn >= 0 ? 'var(--red)' : 'var(--green)';
    const shColor = r.sharpe >= 1 ? 'var(--red)' : r.sharpe >= 0 ? '#f59e0b' : 'var(--green)';
    html += `<div class="bt-fund-row">`;
    html += `<span class="bt-fund-name">${fundName(r.code)}</span>`;
    html += `<span class="bt-fund-ret" style="color:${retColor}">${(r.totalReturn*100).toFixed(1)}%</span>`;
    html += `<span class="bt-fund-sharpe" style="color:${shColor}">${r.sharpe.toFixed(2)}</span>`;
    html += `<span class="bt-fund-mdd" style="color:var(--green)">${(r.maxDD*100).toFixed(1)}%</span>`;
    html += `<span class="bt-fund-kelly" style="color:#8b5cf6">${(r.finalKelly*100).toFixed(0)}%</span>`;
    html += `</div>`;
  });
  html += `</div>`;

  // Trading history (æœ€è¿‘10ç¬”)
  const allTrades = [];
  results.forEach(r => {
    r.trades.slice(-5).forEach(t => allTrades.push({...t, code: r.code}));
  });
  allTrades.sort((a,b) => b.date.localeCompare(a.date));

  if(allTrades.length > 0){
    html += `<div class="bt-card"><div class="bt-card-title">ğŸ“ æœ€è¿‘äº¤æ˜“è®°å½• <span style="font-size:9px;color:var(--sub);font-weight:400">${s.totalTrades}ç¬”æ€»äº¤æ˜“</span></div>`;
    allTrades.slice(0, 10).forEach(t => {
      const ac = t.action === 'buy' ? 'ğŸŸ¢ä¹°' : 'ğŸ”´å–';
      const extra = t.action === 'sell' ? ` ${t.pnl} ${t.reason||''}` : ` RSI:${t.rsi?.toFixed(0)} Kelly:${(t.kelly*100)?.toFixed(0)}%`;
      html += `<div class="bt-trade-row">`;
      html += `<span style="min-width:60px">${t.date?.slice(5)}</span>`;
      html += `<span style="min-width:24px">${ac}</span>`;
      html += `<span style="flex:1">${fundName(t.code)}</span>`;
      html += `<span style="color:var(--sub);text-align:right">${extra}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Architecture
  html += `<div class="bt-card"><div class="bt-card-title">âš™ï¸ å›æµ‹å‚æ•°</div>`;
  html += `<div style="font-size:10px;color:var(--sub);line-height:1.6">`;
  html += `<b>æ•°æ®:</b> åŸºé‡‘å†å²NAV(è¿‘1å¹´~250äº¤æ˜“æ—¥)<br>`;
  html += `<b>ä¹°å…¥æ¡ä»¶:</b> é¢„æµ‹æ¶¨å¹…>1% + RSI(14)<${BT_RSI_BUY} + MA5>MA20<br>`;
  html += `<b>å–å‡ºæ¡ä»¶:</b> RSI>${BT_RSI_SELL} / è¶‹åŠ¿åè½¬(MA5<MA20+MACD<0) / æ­¢æŸ(-5%)<br>`;
  html += `<b>ä»“ä½ç®¡ç†:</b> Kelly f*=(bÂ·p-q)/b Â· åŠKelly(max 25%) Â· æ»šåŠ¨20æ¬¡äº¤æ˜“ç»Ÿè®¡<br>`;
  html += `<b>æ‰‹ç»­è´¹:</b> ${(BT_FEE*100).toFixed(2)}% å•è¾¹<br>`;
  html += `<b>é£æ§:</b> æ€»ä»“ä½â‰¤95% Â· æ­¢æŸ-5% Â· RSIè¶…ä¹°å‡ä»“<br>`;
  html += `<b>æŒ‡æ ‡:</b> Sharpe=(R-Rf)/ÏƒÂ·âˆš250 Â· Sortino(ä¸‹è¡Œæ³¢åŠ¨) Â· Calmar(å¹´åŒ–/æœ€å¤§å›æ’¤) Â· Kelly<br>`;
  html += `<b>é—­ç¯:</b> <span style="color:#22d3ee">RLä¿¡å·èåˆä¹°å– Â· ä¸‰å¼•æ“æŠ•ç¥¨å…±è¯† Â· å›æµ‹ç‰¹å¾æ³¨å…¥RLçŠ¶æ€</span>`;
  html += `</div></div>`;

  container.innerHTML = html;
}

function btMetricHTML(label, val, color){
  return `<div class="bt-metric"><span class="bt-metric-label">${label}</span><span class="bt-metric-val" style="color:${color||'var(--text)'}">${val}</span></div>`;
}

function renderBTChart(equity, bhReturn){
  if(!equity || equity.length < 2) return '';
  const vals = equity.map(e => e.value);
  const max = Math.max(...vals), min = Math.min(...vals);
  const range = max - min || 0.01;
  const h = 70, w = 100;

  let strategyPts = '', bhPts = '';
  const step = Math.max(1, Math.floor(vals.length / 200));
  for(let i = 0; i < vals.length; i += step){
    const x = (i / (vals.length-1)) * w;
    const y = h - ((vals[i] - min) / range) * h;
    strategyPts += `${x.toFixed(1)},${y.toFixed(1)} `;
    // Buy & Hold line
    const bhVal = 1 + (vals[i] - 1) * 0; // ç®€åŒ–: çº¿æ€§
    const bhV = 1 + (bhReturn * i / (vals.length-1));
    const bhY = h - ((bhV - min) / range) * h;
    bhPts += `${x.toFixed(1)},${bhY.toFixed(1)} `;
  }

  let s = `<div class="bt-chart"><svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  // BH line
  s += `<polyline points="${bhPts.trim()}" fill="none" stroke="rgba(148,163,184,0.4)" stroke-width="1" stroke-dasharray="2,2"/>`;
  // Strategy line
  s += `<defs><linearGradient id="btGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f59e0b" stop-opacity="0.25"/><stop offset="100%" stop-color="#f59e0b" stop-opacity="0.02"/></linearGradient></defs>`;
  s += `<polygon points="0,${h+2} ${strategyPts.trim()} ${w},${h+2}" fill="url(#btGrad)"/>`;
  s += `<polyline points="${strategyPts.trim()}" fill="none" stroke="#f59e0b" stroke-width="1.5"/>`;
  // 1.0 line
  const oneY = h - ((1 - min) / range) * h;
  if(oneY > 0 && oneY < h) s += `<line x1="0" y1="${oneY.toFixed(1)}" x2="${w}" y2="${oneY.toFixed(1)}" stroke="rgba(255,255,255,0.15)" stroke-dasharray="2,2"/>`;
  s += `</svg>`;
  s += `<div style="position:absolute;top:2px;left:4px;font-size:8px;color:#f59e0b">â—ç­–ç•¥ ${(vals[vals.length-1]*100-100).toFixed(1)}%</div>`;
  s += `<div style="position:absolute;top:2px;right:4px;font-size:8px;color:var(--sub)">â—B&H ${(bhReturn*100).toFixed(1)}%</div>`;
  s += `</div>`;
  return s;
}

function renderBTDDChart(drawdown){
  if(!drawdown || drawdown.length < 2) return '';
  const vals = drawdown.map(d => d.dd);
  const minDD = Math.min(...vals);
  const range = Math.abs(minDD) || 0.01;
  const h = 40, w = 100;

  let pts = '';
  const step = Math.max(1, Math.floor(vals.length / 200));
  for(let i = 0; i < vals.length; i += step){
    const x = (i / (vals.length-1)) * w;
    const y = (Math.abs(vals[i]) / range) * h;
    pts += `${x.toFixed(1)},${y.toFixed(1)} `;
  }

  let s = `<div class="bt-dd-chart"><svg viewBox="0 0 ${w} ${h+2}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s += `<defs><linearGradient id="ddGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ef4444" stop-opacity="0.02"/><stop offset="100%" stop-color="#ef4444" stop-opacity="0.3"/></linearGradient></defs>`;
  s += `<polygon points="0,0 ${pts.trim()} ${w},0" fill="url(#ddGrad)"/>`;
  s += `<polyline points="${pts.trim()}" fill="none" stroke="#ef4444" stroke-width="1"/>`;
  s += `</svg>`;
  s += `<div style="position:absolute;bottom:2px;left:4px;font-size:8px;color:#ef4444">å›æ’¤ ${(minDD*100).toFixed(1)}%</div>`;
  s += `</div>`;
  return s;
}

// Build backtest context for AI prompt
function buildBTContext(){
  if(!btSummary || Object.keys(btResults).length === 0) return '';
  let ctx = '\nã€ğŸ“ˆ ç­–ç•¥å›æµ‹ç»“æœ (RSI+Kelly+RLèåˆ)ã€‘\n';
  ctx += `ç­–ç•¥: é¢„æµ‹æ¶¨å¹…>1%ä¸”RSI<${BT_RSI_BUY}ä¹°å…¥ | RSI>${BT_RSI_SELL}æˆ–è¶‹åŠ¿åè½¬å–å‡º | Kellyä»“ä½ç®¡ç† | RLä¿¡å·è¾…åŠ©\n`;
  ctx += `å…±è¯†: ä¸‰å¼•æ“(AI+RL+å›æµ‹)åŠ æƒæŠ•ç¥¨ Â· å…¨ç¥¨ä¸€è‡´Ã—1.4 Â· å¤šæ•°ç¥¨Ã—1.15 Â· åˆ†æ­§Ã—0.4\n`;
  ctx += `ç»„åˆ: å¹³å‡æ”¶ç›Š${(btSummary.avgReturn*100).toFixed(1)}% Â· Sharpe ${btSummary.avgSharpe.toFixed(2)} Â· æœ€å¤§å›æ’¤${(btSummary.worstDD*100).toFixed(1)}% Â· èƒœç‡${(btSummary.avgWinRate*100).toFixed(0)}%\n`;
  ctx += `è¶…é¢æ”¶ç›Š(vs Buy&Hold): ${(btSummary.excessReturn*100).toFixed(1)}%\n`;
  ctx += `Kellyå»ºè®®å¹³å‡ä»“ä½: ${(btSummary.avgKelly*100).toFixed(1)}%\n`;
  ctx += 'å„åŸºé‡‘å›æµ‹:\n';
  Object.values(btResults).sort((a,b)=>b.sharpe-a.sharpe).forEach(r => {
    ctx += `  ${fundName(r.code)}(${r.code}): æ”¶ç›Š${(r.totalReturn*100).toFixed(1)}% Â· Sharpe ${r.sharpe.toFixed(2)} Â· å›æ’¤${(r.maxDD*100).toFixed(1)}% Â· èƒœç‡${(r.winRate*100).toFixed(0)}% Â· Kellyä»“ä½${(r.finalKelly*100).toFixed(0)}% Â· å½“å‰RSI ${r.lastRSI?.toFixed(0)}\n`;
  });
  ctx += 'âš ï¸ å›æµ‹å·²èåˆRLä¿¡å·ã€‚ä¸‰å¼•æ“æŠ•ç¥¨å…±è¯†ç³»ç»Ÿ: AI/RL/å›æµ‹å¤šæ•°ç¥¨â†’åŠ å¤§ä»“ä½, åˆ†æ­§â†’ç¼©å‡ä»“ä½ã€‚é«˜SharpeåŸºé‡‘å¯åŠ é…ï¼ŒSharpe<0éœ€è°¨æ…ã€‚\n';
  return ctx;
}

// Load saved backtest results
function loadBTResults(){
  try{
    const raw = localStorage.getItem(BT_STORAGE_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    if(d.summary) btSummary = d.summary;
    if(d.results){
      for(const[k,v]of Object.entries(d.results)){
        btResults[k] = v; // partial results (no equity/trades/drawdown arrays)
      }
    }
    renderBTBrief();
    console.log('å›æµ‹ç»“æœå·²åŠ è½½:', Object.keys(btResults).length, 'åªåŸºé‡‘');
  }catch(e){ console.warn('å›æµ‹ç»“æœåŠ è½½å¤±è´¥:', e); }
}
</script>
</body>
</html>
