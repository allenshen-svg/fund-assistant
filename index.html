<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>基金决策助手</title>
<style>
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a2e; --sub: #4b5563;
  --border: #e8ecf1; --primary: #4F6EF7; --primary-bg: #eef2ff;
  --green: #22a065; --green-bg: #ecfdf5; --red: #e74040; --red-bg: #fef2f2;
  --yellow: #f59e0b; --yellow-bg: #fef3c7; --gray-bg: #f8fafc;
  --radius: 14px; --shadow: 0 1px 4px rgba(0,0,0,0.04);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro','PingFang SC','Helvetica Neue',sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; max-width:500px; margin:0 auto; min-height:100vh; padding-bottom:80px; }

/* Header — 深色大气风格 */
.header { background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; padding:16px 16px 14px; position:sticky; top:0; z-index:100; }
.header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.header-title { font-size:17px; font-weight:700; letter-spacing:0.5px; }
.header-gear { background:none; border:none; color:rgba(255,255,255,0.7); font-size:18px; cursor:pointer; padding:4px; transition:color .2s; }
.header-gear:hover { color:#fff; }
.market-status { display:flex; align-items:center; gap:8px; font-size:12px; opacity:0.9; }
.status-dot { width:7px; height:7px; border-radius:50%; display:inline-block; }
.status-dot.open { background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,0.6); animation:pulse 2s infinite; }
.status-dot.closed { background:#64748b; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.countdown { font-family:'SF Mono','Menlo',monospace; font-weight:600; font-size:13px; background:rgba(255,255,255,0.08); padding:3px 10px; border-radius:6px; letter-spacing:0.5px; }

/* Stats Bar */
.stats-bar { display:grid; grid-template-columns:1fr 1fr; gap:0; padding:0; background:var(--card); border-bottom:1px solid var(--border); box-shadow:var(--shadow); }
.stat-item { text-align:center; padding:14px 12px; }
.stat-item:first-child { border-right:1px solid var(--border); }
.stat-label { font-size:10px; color:var(--sub); margin-bottom:4px; letter-spacing:0.5px; text-transform:uppercase; }
.stat-value { font-size:22px; font-weight:800; font-variant-numeric:tabular-nums; }
.stat-value.up { color:var(--red); }
.stat-value.down { color:var(--green); }
.stat-sub { font-size:10px; color:var(--sub); margin-top:3px; }
.stat-sub .beat { color:var(--red); font-weight:600; }
.stat-sub .lose { color:var(--green); font-weight:600; }

/* AI Button */
.ai-btn-wrap { padding:14px 16px 8px; }
.ai-btn { width:100%; padding:13px 16px; border:none; border-radius:var(--radius); background:linear-gradient(135deg,#1e293b 0%,#334155 100%); color:white; font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .25s; box-shadow:0 2px 8px rgba(30,41,59,0.3); letter-spacing:0.3px; }
.ai-btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(30,41,59,0.35); }
.ai-btn:active { transform:translateY(0); }
.ai-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
.ai-btn .spinner-sm { width:16px; height:16px; border:2px solid rgba(255,255,255,0.2); border-top-color:white; border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.ai-progress { font-size:11px; color:var(--sub); text-align:center; padding:6px 16px 2px; min-height:20px; }

/* Section */
.section { padding:10px 16px 4px; }
.section-title { font-size:14px; font-weight:700; color:var(--text); margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.section-badge { font-size:9px; background:#1e293b; color:white; padding:2px 8px; border-radius:10px; font-weight:500; letter-spacing:0.3px; }

/* Signal Cards */
.signal-card { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:10px; box-shadow:var(--shadow); transition:all .25s; border:1px solid transparent; }
.signal-card.buy { border-left:4px solid var(--red); background:linear-gradient(135deg,#fff 92%,#fef2f2); }
.signal-card.sell { border-left:4px solid var(--green); background:linear-gradient(135deg,#fff 92%,#ecfdf5); }
.signal-card.hold { border-left:4px solid #cbd5e1; }
.signal-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.signal-fund { flex:1; }
.signal-name { font-size:14px; font-weight:600; }
.signal-code { font-size:10px; color:var(--sub); margin-top:2px; }
.signal-pct { font-size:17px; font-weight:800; min-width:70px; text-align:right; font-variant-numeric:tabular-nums; }
.signal-nav-row { display:flex; align-items:baseline; gap:6px; justify-content:flex-end; margin-top:2px; font-variant-numeric:tabular-nums; }
.signal-nav-val { font-size:13px; font-weight:700; color:var(--text); }
.signal-nav-prev { font-size:10px; color:var(--sub); }
.signal-nav-time { font-size:9px; color:var(--sub); opacity:0.7; }
.nav-live-dot { display:inline-block; width:6px; height:6px; border-radius:50%; background:#22c55e; margin-right:3px; animation:navPulse 1.5s ease-in-out infinite; }
@keyframes navPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
.signal-action { display:inline-flex; align-items:center; gap:4px; padding:4px 12px; border-radius:8px; font-size:12px; font-weight:600; }
.signal-action.buy { background:var(--red-bg); color:var(--red); }
.signal-action.sell { background:var(--green-bg); color:var(--green); }
.signal-action.hold { background:var(--gray-bg); color:var(--sub); }
.signal-urgency { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:500; }
.signal-urgency.high { background:#fee2e2; color:#dc2626; }
.signal-urgency.medium { background:var(--yellow-bg); color:var(--yellow); }
.signal-urgency.low { background:#f1f5f9; color:#64748b; }

/* Confidence Bar */
.conf-bar { display:flex; align-items:center; gap:6px; margin:8px 0; }
.conf-track { flex:1; height:5px; background:#e2e8f0; border-radius:3px; overflow:hidden; }
.conf-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.conf-fill.high { background:linear-gradient(90deg,#22a065,#16a34a); }
.conf-fill.mid { background:linear-gradient(90deg,#f59e0b,#eab308); }
.conf-fill.low { background:#94a3b8; }
.conf-text { font-size:10px; color:var(--sub); min-width:30px; }
.signal-reason { font-size:12px; color:#1e293b; line-height:1.65; }
.signal-engines { font-size:10px; color:var(--sub); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }

/* Reco Cards */
.reco-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); display:flex; align-items:center; gap:12px; transition:transform .2s; }
.reco-card:active { transform:scale(0.98); }
.reco-info { flex:1; }
.reco-name { font-size:13px; font-weight:600; }
.reco-meta { font-size:10px; color:var(--sub); margin-top:3px; line-height:1.4; }
.reco-expect { font-size:13px; font-weight:700; color:var(--red); }
.reco-add { background:#1e293b; color:white; border:none; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.reco-add:hover { background:#334155; }

/* Watch item */
.watch-item { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:6px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; transition:transform .2s; }
.watch-item:active { transform:scale(0.98); }
.watch-left { flex:1; min-width:0; }
.watch-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.watch-type { font-size:10px; color:var(--sub); margin-top:2px; }
.watch-pct { font-size:15px; font-weight:800; min-width:60px; text-align:right; font-variant-numeric:tabular-nums; }
.watch-signal { font-size:10px; padding:3px 8px; border-radius:6px; white-space:nowrap; font-weight:500; }
.watch-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:14px; padding:4px; transition:color .2s; }
.watch-del:hover { color:var(--red); }

/* Holding delete */
.hold-del { background:none; border:none; color:#cbd5e1; cursor:pointer; font-size:11px; padding:2px 4px; margin-left:4px; transition:color .2s; }
.hold-del:hover { color:var(--red); }

/* Empty state */
.empty { text-align:center; padding:32px 16px; color:var(--sub); font-size:12px; }
.empty-icon { font-size:36px; margin-bottom:10px; opacity:0.6; }

/* Bottom Bar */
.bottom-bar { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:var(--card); border-top:1px solid var(--border); padding:10px 16px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); display:flex; gap:10px; z-index:100; box-shadow:0 -2px 10px rgba(0,0,0,0.04); }
.bottom-btn { flex:1; padding:11px; border:none; border-radius:12px; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; letter-spacing:0.3px; }
.bottom-btn.primary { background:#1e293b; color:white; }
.bottom-btn.primary:hover { background:#334155; }
.bottom-btn.secondary { background:#94a3b8; color:var(--text); border:1px solid #64748b; }
.bottom-btn.secondary:hover { background:#7f8fa3; }

/* Modal */
.modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:400; align-items:center; justify-content:center; }
.fund-search-box { position:relative; margin-bottom:12px; }
.fund-search-box input { width:100%; padding:12px 14px 12px 36px; border:1.5px solid var(--border); border-radius:12px; font-size:14px; outline:none; background:var(--gray-bg); transition:border-color .2s,box-shadow .2s; }
.fund-search-box input:focus { border-color:var(--primary); background:#fff; box-shadow:0 0 0 3px rgba(99,102,241,0.1); }
.fund-search-box .search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:var(--sub); pointer-events:none; }
.fund-search-results { max-height:260px; overflow-y:auto; border:1px solid var(--border); border-radius:12px; background:var(--card); }
.fund-search-results:empty { display:none; }
.fund-result-item { display:flex; align-items:center; padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--border); transition:background .15s; gap:10px; }
.fund-result-item:last-child { border-bottom:none; }
.fund-result-item:hover,.fund-result-item:active { background:var(--primary-bg); }
.fund-result-code { font-size:13px; font-weight:700; color:var(--primary); min-width:60px; font-variant-numeric:tabular-nums; }
.fund-result-name { font-size:12px; color:var(--text); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fund-result-type { font-size:9px; background:var(--gray-bg); color:var(--sub); padding:2px 6px; border-radius:6px; white-space:nowrap; }
.fund-search-hint { text-align:center; padding:20px 10px; font-size:11px; color:var(--sub); }
.fund-selected-card { display:flex; align-items:center; gap:10px; padding:12px 14px; background:linear-gradient(135deg,var(--primary-bg),#eef2ff); border:1.5px solid var(--primary); border-radius:12px; margin-bottom:14px; }
.fund-selected-card .sel-code { font-size:15px; font-weight:700; color:var(--primary); }
.fund-selected-card .sel-name { font-size:13px; color:var(--text); flex:1; }
.fund-selected-card .sel-clear { background:none; border:none; font-size:16px; color:var(--sub); cursor:pointer; padding:4px; }
.modal { background:var(--card); border-radius:20px; margin:16px; padding:24px; max-width:380px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.15); }
.modal h3 { font-size:17px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; }
.modal h3 button { background:none; border:none; font-size:18px; cursor:pointer; color:var(--sub); width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background .2s; }
.modal h3 button:hover { background:var(--gray-bg); }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; font-weight:600; color:var(--sub); margin-bottom:5px; letter-spacing:0.3px; text-transform:uppercase; }
.form-row input, .form-row select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; transition:border-color .2s; outline:none; background:var(--gray-bg); }
.form-row input:focus, .form-row select:focus { border-color:var(--primary); background:#fff; }
.form-btn { width:100%; padding:12px; border:none; border-radius:12px; background:#1e293b; color:white; font-size:14px; font-weight:600; cursor:pointer; transition:background .2s; letter-spacing:0.3px; }
.form-btn:hover { background:#334155; }

.spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto; }

/* Market summary */
.market-summary { font-size:12px; color:#1e293b; line-height:1.7; padding:14px 16px; background:var(--card); border-radius:var(--radius); margin-bottom:10px; box-shadow:var(--shadow); border-left:3px solid var(--primary); }
.provider-tag { font-size:9px; background:var(--primary-bg); color:var(--primary); padding:2px 8px; border-radius:10px; margin-left:6px; font-weight:500; }

/* Index Bar — single scrollable row */
.idx-bar { background:linear-gradient(135deg,#0f172a,#1e293b); padding:8px 12px; display:flex; flex-wrap:wrap; gap:0; border-bottom:1px solid rgba(255,255,255,0.06); }
.idx-bar::-webkit-scrollbar { display:none; }
.idx-item { min-width:0; flex:1 1 calc(25% - 1px); text-align:center; position:relative; padding:4px 2px; box-sizing:border-box; }
.idx-item+.idx-item { border-left:1px solid rgba(255,255,255,0.08); }
.idx-name { font-size:9px; color:rgba(251,191,36,0.7); letter-spacing:0.2px; white-space:nowrap; }
.idx-val { font-size:12px; font-weight:700; color:#fff; margin-top:1px; font-variant-numeric:tabular-nums; }
.idx-pct { font-size:10px; font-weight:600; margin-top:1px; font-variant-numeric:tabular-nums; }
.idx-pct.up { color:#ef4444; }
.idx-pct.down { color:#22c55e; }
.idx-pct.flat { color:rgba(255,255,255,0.5); }
/* 第二行3个指数居中 (nth-child 5,6,7) */
@media (max-width:480px) {
  .idx-item { flex:1 1 calc(25% - 1px); }
  .idx-item:nth-child(n+5) { flex:1 1 calc(33.33% - 1px); border-left:none; }
  .idx-item:nth-child(n+5) + .idx-item { border-left:1px solid rgba(255,255,255,0.08); }
  .idx-item:nth-child(5) { border-top:1px solid rgba(255,255,255,0.06); }
  .idx-item:nth-child(6) { border-top:1px solid rgba(255,255,255,0.06); }
  .idx-item:nth-child(7) { border-top:1px solid rgba(255,255,255,0.06); }
}

/* Portfolio Section */
.pf-section { padding:10px 16px 4px; }
.pf-tabs { display:flex; gap:0; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); margin-bottom:12px; }
.pf-tab { flex:1; padding:10px 8px; text-align:center; cursor:pointer; border:none; background:transparent; font-size:12px; font-weight:600; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; }
.pf-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.pf-tab .pf-tab-ratio { font-size:10px; font-weight:400; color:var(--sub); display:block; margin-top:2px; }
.pf-group { display:none; }
.pf-group.active { display:block; }
.pf-group-desc { font-size:11px; color:#334155; margin-bottom:10px; padding:0 2px; line-height:1.5; }
.pf-card { background:var(--card); border-radius:12px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.pf-card:active { transform:scale(0.98); }
.pf-card.swing-buy { border-left:3px solid var(--red); }
.pf-card.swing-sell { border-left:3px solid var(--green); }
.pf-card.swing-hold { border-left:3px solid #cbd5e1; }
.pf-top { display:flex; justify-content:space-between; align-items:flex-start; }
.pf-info { flex:1; min-width:0; }
.pf-name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pf-code { font-size:10px; color:var(--sub); margin-top:1px; }
.pf-right { text-align:right; min-width:70px; }
.pf-pct { font-size:16px; font-weight:800; font-variant-numeric:tabular-nums; }
.pf-swing-tag { display:inline-block; font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; margin-top:3px; }
.pf-swing-tag.buy { background:var(--red-bg); color:var(--red); }
.pf-swing-tag.sell { background:var(--green-bg); color:var(--green); }
.pf-swing-tag.hold { background:var(--gray-bg); color:var(--sub); }
.pf-trend-row { display:flex; gap:6px; flex-wrap:wrap; font-size:10px; margin-top:8px; padding-top:7px; border-top:1px solid var(--border); }
.pf-trend-item { display:flex; align-items:center; gap:2px; }
.pf-trend-label { color:var(--sub); }
.pf-reason { font-size:11px; color:#334155; margin-top:6px; line-height:1.4; }
.pf-actions { display:flex; gap:6px; margin-top:8px; }
.pf-act-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.pf-act-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.pf-act-btn.in-hold { background:rgba(34,160,101,0.08); color:var(--green); border-color:var(--green); cursor:default; font-weight:600; }
.pf-act-btn.in-watch { background:rgba(79,110,247,0.08); color:var(--primary); border-color:var(--primary); cursor:default; font-weight:600; }

/* Review Section */
.review-section { padding:10px 16px 4px; }
.review-card { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:var(--shadow); }
.review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.review-date { font-size:13px; font-weight:700; color:var(--text); }
.review-pnl { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.review-stats { display:flex; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
.review-stat { font-size:11px; display:flex; align-items:center; gap:4px; }
.review-stat-label { color:var(--sub); }
.review-stat-val { font-weight:600; }
.review-items { border-top:1px solid var(--border); padding-top:8px; }
.review-item { display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.03); font-size:12px; }
.review-item:last-child { border-bottom:none; }
.review-fund-name { flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; }
.review-pred { font-size:10px; padding:2px 8px; border-radius:6px; font-weight:600; }
.review-pred.buy { background:var(--red-bg); color:var(--red); }
.review-pred.sell { background:var(--green-bg); color:var(--green); }
.review-pred.hold { background:var(--gray-bg); color:var(--sub); }
.review-actual { font-weight:700; min-width:55px; text-align:right; font-variant-numeric:tabular-nums; }
.review-verdict { font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; white-space:nowrap; }
.review-verdict.correct { background:#ecfdf5; color:#16a34a; }
.review-verdict.wrong { background:#fef2f2; color:#dc2626; }
.review-verdict.neutral { background:#f8fafc; color:#64748b; }
.review-lesson { margin-top:8px; padding:8px 12px; background:#fffbeb; border-radius:8px; border:1px solid #fde68a; font-size:11px; color:#92400e; line-height:1.5; }
.review-toggle { font-size:11px; color:var(--primary); cursor:pointer; font-weight:500; }
.review-history-toggle { text-align:center; padding:8px; }

/* Simulation Portfolio */
.sim-section { padding:10px 16px 4px; }
.sim-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.sim-header-right { display:flex; align-items:center; gap:8px; }
.sim-toggle-icon { font-size:12px; color:var(--sub); transition:transform .2s; }
.sim-overview { background:linear-gradient(135deg,#0f172a,#1e293b); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 8px rgba(15,23,42,0.2); }
.sim-stat-row { display:flex; gap:0; }
.sim-stat { flex:1; text-align:center; position:relative; }
.sim-stat+.sim-stat { border-left:1px solid rgba(255,255,255,0.1); }
.sim-stat-label { font-size:9px; color:rgba(255,255,255,0.5); letter-spacing:0.3px; }
.sim-stat-val { font-size:18px; font-weight:800; margin-top:2px; font-variant-numeric:tabular-nums; }
.sim-target { margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); }
.sim-target span { color:rgba(255,255,255,0.6); }
.sim-progress { height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; }
.sim-progress-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.sim-compare { background:var(--card); border-radius:var(--radius); padding:12px 14px; margin-bottom:10px; box-shadow:var(--shadow); }
.sim-compare-title { font-size:12px; font-weight:700; margin-bottom:8px; }
.sim-compare-row { display:flex; gap:0; }
.sim-compare-item { flex:1; text-align:center; padding:4px 0; }
.sim-compare-item+.sim-compare-item { border-left:1px solid var(--border); }
.sim-compare-label { font-size:9px; color:var(--sub); display:block; }
.sim-compare-val { font-size:14px; font-weight:700; font-variant-numeric:tabular-nums; }
.sim-pos-card { background:var(--card); border-radius:10px; padding:10px 12px; margin-bottom:6px; box-shadow:var(--shadow); }
.sim-pos-top { display:flex; justify-content:space-between; align-items:flex-start; }
.sim-pos-info { flex:1; min-width:0; }
.sim-pos-name { font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.sim-pos-meta { font-size:9px; color:var(--sub); margin-top:1px; }
.sim-pos-right { text-align:right; min-width:60px; }
.sim-pos-pct { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; }
.sim-pos-detail { display:flex; gap:8px; font-size:10px; color:var(--sub); margin-top:4px; padding-top:4px; border-top:1px solid var(--border); }
.sim-learn-card { background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:8px 10px; margin-bottom:6px; }
.sim-strategy-card { background:var(--card); border-radius:10px; padding:10px 14px; box-shadow:var(--shadow); margin-bottom:8px; }
.sim-param-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.sim-param { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.sp-label { font-size:9px; color:var(--sub); display:block; }
.sp-val { font-size:12px; font-weight:700; }
.sim-trade-item { display:flex; align-items:center; gap:6px; padding:6px 0; border-bottom:1px solid var(--border); font-size:11px; }
.sim-trade-item:last-child { border-bottom:none; }
.sim-chart { background:var(--card); border-radius:10px; padding:10px 12px; box-shadow:var(--shadow); }
.sim-chart-row { display:flex; align-items:center; gap:6px; padding:2px 0; }
.sim-chart-date { font-size:9px; color:var(--sub); min-width:36px; }
.sim-chart-bar { flex:1; height:10px; background:var(--bg); border-radius:3px; overflow:hidden; }
.sim-chart-val { font-size:9px; font-weight:600; min-width:42px; text-align:right; font-variant-numeric:tabular-nums; }

/* Manage Panel */
/* Data Intelligence Dashboard */

.macro-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.macro-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.macro-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.macro-item { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.macro-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.macro-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.macro-val.positive { color:var(--red); }
.macro-val.negative { color:var(--green); }
.macro-val.neutral { color:var(--sub); }
.news-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.news-item { display:flex; gap:6px; padding:5px 0; border-bottom:1px solid var(--border); align-items:flex-start; }
.news-item:last-child { border-bottom:none; }
.news-sentiment { font-size:12px; min-width:18px; text-align:center; }
.news-text { font-size:11px; color:var(--text); line-height:1.4; flex:1; }
.news-time { font-size:9px; color:var(--sub); min-width:36px; text-align:right; white-space:nowrap; }
.cap-flow-bar { height:8px; border-radius:4px; overflow:hidden; background:var(--bg); margin-top:2px; }
.cap-flow-fill { height:100%; border-radius:4px; }
.sentiment-meter { display:flex; align-items:center; gap:8px; padding:8px 0; }
.sentiment-bar { flex:1; height:10px; border-radius:5px; background:linear-gradient(90deg,var(--green),#fbbf24,var(--red)); position:relative; }
.sentiment-dot { width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #1e293b; position:absolute; top:-2px; transition:left .3s; }
.sentiment-label { font-size:10px; font-weight:700; min-width:40px; }
/* Global News Aggregation */
.global-news-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.global-news-sources { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px; }
.global-news-tag { font-size:8px; padding:2px 6px; border-radius:8px; background:var(--bg); color:var(--sub); font-weight:600; }
.global-news-tag.active { background:#3b82f6; color:#fff; }
.global-news-item { display:flex; gap:8px; padding:6px 0; border-bottom:1px solid var(--border); align-items:flex-start; }
.global-news-item:last-child { border-bottom:none; }
.global-news-src { font-size:8px; color:#3b82f6; font-weight:700; min-width:32px; text-transform:uppercase; }
.global-news-title { font-size:11px; color:var(--text); line-height:1.4; flex:1; }
.global-news-title a { color:var(--text); text-decoration:none; }
.global-news-title a:hover { text-decoration:underline; }
.global-news-cat { font-size:8px; color:var(--sub); background:var(--bg); padding:1px 5px; border-radius:4px; white-space:nowrap; }
.global-news-time { font-size:9px; color:var(--sub); min-width:36px; text-align:right; white-space:nowrap; }
.global-news-summary { background:linear-gradient(135deg,#1e3a5f,#0f172a); color:#e2e8f0; border-radius:10px; padding:12px 14px; margin-bottom:8px; font-size:11px; line-height:1.6; }
.global-news-summary-title { font-size:11px; font-weight:700; margin-bottom:6px; color:#93c5fd; }
.global-news-impact { margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1); }
.global-news-impact-title { font-size:10px; font-weight:700; color:#fbbf24; margin-bottom:4px; }
.global-news-impact-item { font-size:10px; line-height:1.5; padding:2px 0; }
.global-news-sentiment { display:flex; justify-content:center; gap:16px; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1); }
.global-news-sentiment-item { text-align:center; }
.global-news-sentiment-label { font-size:8px; color:rgba(255,255,255,0.5); }
.global-news-sentiment-val { font-size:14px; font-weight:700; }
.global-news-btn { display:block; width:100%; padding:8px; border:1px dashed rgba(59,130,246,0.4); background:transparent; color:#3b82f6; font-size:10px; border-radius:8px; cursor:pointer; text-align:center; margin-top:6px; transition:all .2s; }
.global-news-btn:hover { background:rgba(59,130,246,0.1); border-color:#3b82f6; }
.global-news-btn:disabled { opacity:0.5; cursor:not-allowed; }
/* ===== 宏观异动雷达 (Macro & Anomaly Radar) ===== */
.radar-section { background:linear-gradient(135deg,#0f172a 0%,#1a1a2e 50%,#1e1b4b 100%); border-radius:var(--radius); padding:14px 16px; margin-top:10px; color:#fff; box-shadow:0 2px 12px rgba(22,33,62,0.25); }
.radar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.radar-title { font-size:13px; font-weight:700; }
.radar-meta { font-size:9px; color:rgba(255,255,255,0.45); display:flex; align-items:center; gap:6px; }
.radar-score { font-size:11px; font-weight:700; padding:2px 8px; border-radius:6px; }
/* 热点温度计 */
.radar-module { margin-bottom:12px; }
.radar-mod-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.heatmap-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px 8px; }
.heat-item { display:flex; align-items:center; gap:4px; padding:3px 6px; border-radius:6px; background:rgba(255,255,255,0.04); font-size:10px; }
.heat-tag { min-width:50px; font-weight:600; color:#e2e8f0; }
.heat-bar { flex:1; height:5px; border-radius:3px; background:rgba(255,255,255,0.08); overflow:hidden; min-width:30px; }
.heat-fill { height:100%; border-radius:3px; transition:width .5s; }
.heat-temp { font-weight:700; min-width:22px; text-align:right; font-size:10px; }
.heat-trend { font-size:9px; min-width:10px; }
/* 持仓异动归因 */
.impact-list { display:flex; flex-direction:column; gap:6px; }
.impact-item { padding:8px 10px; border-radius:8px; border-left:3px solid transparent; background:rgba(255,255,255,0.04); }
.impact-item.positive { border-left-color:#4ade80; }
.impact-item.negative { border-left-color:#f87171; }
.impact-item.neutral { border-left-color:#fbbf24; }
.impact-fund { font-size:12px; font-weight:700; color:#e2e8f0; margin-bottom:2px; }
.impact-pct { font-size:11px; font-weight:700; }
.impact-reason { font-size:10px; color:#cbd5e1; line-height:1.4; margin-top:2px; }
.impact-events { display:flex; gap:3px; flex-wrap:wrap; margin-top:4px; }
.impact-evt-chip { font-size:8px; padding:1px 6px; border-radius:4px; font-weight:600; }
.impact-evt-chip.pos { background:rgba(248,113,113,0.15); color:#f87171; }
.impact-evt-chip.neg { background:rgba(74,222,128,0.15); color:#4ade80; }
/* AI策略建议 */
.strategy-list { display:flex; flex-direction:column; gap:6px; }
.strategy-item { padding:6px 10px; border-radius:8px; background:rgba(255,255,255,0.04); display:flex; gap:8px; align-items:flex-start; }
.strategy-icon { font-size:16px; min-width:20px; text-align:center; }
.strategy-body { flex:1; }
.strategy-label { font-size:10px; font-weight:700; margin-bottom:2px; }
.strategy-text { font-size:10px; color:#cbd5e1; line-height:1.4; }
.strategy-fund { font-size:9px; color:#22d3ee; font-weight:600; cursor:pointer; margin-top:2px; }
/* Real-World Action Guide */
.action-guide { padding:12px 16px 6px; }
.action-guide-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.action-guide-header-right { display:flex; align-items:center; gap:8px; }
.action-guide-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.action-guide-brief { font-size:11px; font-weight:600; }
.action-guide-container { margin-top:8px; }
.ag-overview { background:linear-gradient(135deg,#1a1a2e,#16213e); color:#fff; border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; box-shadow:0 2px 12px rgba(22,33,62,0.25); }
.ag-score-row { display:flex; align-items:center; gap:14px; margin-bottom:10px; }
.ag-big-score { font-size:36px; font-weight:900; font-variant-numeric:tabular-nums; line-height:1; }
.ag-score-meta { flex:1; }
.ag-score-label { font-size:13px; font-weight:700; }
.ag-score-desc { font-size:10px; color:rgba(255,255,255,0.55); margin-top:2px; }
.ag-engines { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
.ag-engine { background:rgba(255,255,255,0.06); border-radius:8px; padding:8px 6px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
.ag-engine-icon { font-size:16px; }
.ag-engine-name { font-size:8px; color:rgba(255,255,255,0.45); letter-spacing:0.3px; margin:2px 0; }
.ag-engine-vote { font-size:11px; font-weight:700; }
.ag-engine-conf { font-size:8px; color:rgba(255,255,255,0.4); margin-top:1px; }
.ag-advice-bar { background:rgba(255,255,255,0.08); border-radius:8px; padding:8px 12px; font-size:11px; line-height:1.5; }
.ag-advice-bar b { color:#fbbf24; }
.ag-fund-card { background:var(--card); border-radius:10px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); border-left:3px solid var(--border); transition:border-color .2s; }
.ag-fund-card.action-buy { border-left-color:var(--red); }
.ag-fund-card.action-sell { border-left-color:var(--green); }
.ag-fund-card.action-hold { border-left-color:var(--primary); }
.ag-fund-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
.ag-fund-name { font-size:13px; font-weight:700; }
.ag-fund-code { font-size:10px; color:var(--sub); }
.ag-fund-action { font-size:12px; font-weight:700; padding:2px 10px; border-radius:6px; }
.ag-fund-action.buy { background:var(--red-bg); color:var(--red); }
.ag-fund-action.sell { background:var(--green-bg); color:var(--green); }
.ag-fund-action.hold { background:var(--primary-bg); color:var(--primary); }
.ag-vote-strip { display:flex; gap:3px; margin-bottom:6px; }
.ag-vote-chip { font-size:8px; padding:1px 6px; border-radius:4px; font-weight:600; letter-spacing:0.2px; }
.ag-vote-chip.bullish { background:#fef2f2; color:#ef4444; }
.ag-vote-chip.bearish { background:#ecfdf5; color:#16a34a; }
.ag-vote-chip.neutral { background:#f8fafc; color:#94a3b8; }
.ag-reason { font-size:11px; color:#1e293b; line-height:1.5; margin-bottom:6px; }
.ag-intraday-chart { position:relative; height:56px; background:var(--bg); border-radius:6px; margin:6px 0; overflow:hidden; cursor:pointer; }
.ag-intraday-chart svg { width:100%; height:100%; }
.ag-intraday-chart .intra-label { position:absolute; top:3px; left:6px; font-size:8px; color:var(--sub); pointer-events:none; }
.ag-intraday-chart .intra-val { position:absolute; top:3px; right:6px; font-size:9px; font-weight:600; pointer-events:none; font-variant-numeric:tabular-nums; }
.ag-intraday-chart .intra-time { position:absolute; bottom:2px; left:6px; font-size:7px; color:var(--sub); opacity:0.7; pointer-events:none; }
.ag-intraday-chart .intra-time-end { position:absolute; bottom:2px; right:6px; font-size:7px; color:var(--sub); opacity:0.7; pointer-events:none; }
.ag-intraday-chart .intra-tooltip { display:none; position:absolute; top:-20px; padding:2px 6px; border-radius:4px; background:rgba(0,0,0,0.75); color:#fff; font-size:9px; white-space:nowrap; pointer-events:none; z-index:10; transform:translateX(-50%); }
.ag-metrics { display:flex; gap:4px; flex-wrap:wrap; }
.ag-metric { font-size:9px; padding:2px 6px; border-radius:4px; background:var(--bg); color:var(--sub); }
.ag-metric b { color:var(--text); font-weight:600; }
.ag-position-bar { margin-top:8px; }
.ag-pos-label { font-size:9px; color:var(--sub); display:flex; justify-content:space-between; margin-bottom:3px; }
.ag-pos-track { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; }
.ag-pos-fill { height:100%; border-radius:3px; transition:width .3s; }
.ag-summary { background:var(--card); border-radius:10px; padding:12px 14px; box-shadow:var(--shadow); border:1px dashed var(--border); }
.ag-summary-title { font-size:11px; font-weight:700; margin-bottom:6px; }
.ag-summary-text { font-size:11px; color:#1e293b; line-height:1.6; }
.ag-summary-text b { color:var(--text); }
.ag-disclaimer { font-size:9px; color:var(--sub); text-align:center; padding:6px 0; line-height:1.4; }

/* RL Brain Dashboard */
.rl-brain { padding:10px 16px 4px; }
.rl-brain-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.rl-brain-header-right { display:flex; align-items:center; gap:8px; }
.rl-brain-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.rl-brain-brief { font-size:11px; font-weight:600; }
.rl-brain-container { margin-top:8px; }
.rl-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.rl-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.rl-status { display:flex; align-items:center; gap:6px; margin-bottom:8px; }
.rl-status-dot { width:8px; height:8px; border-radius:50%; }
.rl-status-dot.active { background:#22c55e; animation:rlPulse 1.5s infinite; }
.rl-status-dot.idle { background:var(--sub); }
.rl-status-dot.training { background:#eab308; animation:rlPulse 0.5s infinite; }
.rl-status-text { font-size:10px; color:var(--sub); }
.rl-progress { width:100%; height:6px; background:var(--bg); border-radius:3px; overflow:hidden; margin:6px 0; }
.rl-progress-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,#3b82f6,#8b5cf6); transition:width .3s; }
.rl-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.rl-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.rl-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.rl-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.rl-chart { height:60px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.rl-train-btn { width:100%; padding:8px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:6px; }
.rl-train-btn.start { background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; }
.rl-train-btn.stop { background:#ef4444; color:white; }
.rl-train-btn:disabled { opacity:0.5; cursor:not-allowed; }
.rl-signal-row { display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom:1px solid var(--border); }
.rl-signal-row:last-child { border-bottom:none; }
.rl-signal-name { font-size:11px; flex:1; }
.rl-signal-action { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; }
.rl-signal-action.buy { background:rgba(239,68,68,0.1); color:var(--red); }
.rl-signal-action.sell { background:rgba(34,197,94,0.1); color:var(--green); }
.rl-signal-action.hold { background:rgba(148,163,184,0.1); color:var(--sub); }
.rl-signal-conf { font-size:10px; color:var(--sub); min-width:32px; text-align:right; }
.rl-qbar { display:flex; gap:2px; flex:1; }
.rl-qbar-seg { height:6px; border-radius:2px; min-width:2px; }
@keyframes rlPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
/* Backtest Dashboard */
.bt-section { padding:10px 16px 4px; }
.bt-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.bt-header-right { display:flex; align-items:center; gap:8px; }
.bt-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.bt-brief { font-size:11px; font-weight:600; }
.bt-container { margin-top:8px; }
.bt-card { background:var(--card); border-radius:10px; padding:10px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.bt-card-title { font-size:11px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.bt-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
.bt-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.bt-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.bt-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.bt-chart { height:80px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.bt-trade-row { display:flex; align-items:center; gap:6px; padding:4px 0; border-bottom:1px solid var(--border); font-size:10px; }
.bt-trade-row:last-child { border-bottom:none; }
.bt-run-btn { width:100%; padding:8px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:6px; background:linear-gradient(135deg,#f59e0b,#ef4444); color:white; }
.bt-run-btn:disabled { opacity:0.5; cursor:not-allowed; }
.bt-kelly-bar { display:flex; height:16px; border-radius:4px; overflow:hidden; background:var(--bg); margin-top:4px; }
.bt-kelly-seg { height:100%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:white; transition:width .3s; }
.bt-dd-chart { height:50px; background:var(--bg); border-radius:6px; margin-top:6px; position:relative; overflow:hidden; }
.bt-fund-row { display:flex; align-items:center; gap:6px; padding:5px 0; border-bottom:1px solid var(--border); }
.bt-fund-row:last-child { border-bottom:none; }
.bt-fund-name { font-size:11px; flex:1; }
.bt-fund-ret { font-size:11px; font-weight:700; min-width:50px; text-align:right; }
.bt-fund-sharpe { font-size:10px; color:var(--sub); min-width:40px; text-align:right; }
.bt-fund-mdd { font-size:10px; min-width:45px; text-align:right; }
.bt-fund-kelly { font-size:10px; font-weight:600; min-width:35px; text-align:right; }
/* Manage Panel */
.manage-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.5); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:300; }
.manage-panel { position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:500px; background:#d5d9e0; border-radius:20px 20px 0 0; max-height:88vh; display:flex; flex-direction:column; animation:slideUp .3s ease; }
@keyframes slideUp { from{transform:translateX(-50%) translateY(100%)} to{transform:translateX(-50%) translateY(0)} }
.manage-header { display:flex; align-items:center; padding:16px 16px 0; gap:8px; }
.manage-tabs { flex:1; display:flex; gap:0; background:var(--card); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); }
.manage-tab { flex:1; padding:10px 12px; text-align:center; font-size:13px; font-weight:600; cursor:pointer; color:var(--sub); transition:all .2s; border-bottom:2px solid transparent; background:transparent; }
.manage-tab.active { color:var(--text); background:var(--gray-bg); border-bottom-color:#1e293b; }
.manage-count { font-size:10px; font-weight:400; background:rgba(0,0,0,0.06); padding:1px 6px; border-radius:8px; margin-left:2px; }
.manage-close { background:none; border:none; font-size:20px; cursor:pointer; color:var(--sub); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-close:hover { background:var(--card); color:var(--text); }
.manage-toolbar { display:flex; gap:8px; padding:12px 16px 8px; align-items:center; }
.manage-search { flex:1; padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:13px; outline:none; background:var(--card); transition:border-color .2s; }
.manage-search:focus { border-color:var(--primary); }
.manage-add-btn { padding:9px 16px; border:none; border-radius:10px; background:#1e293b; color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:background .2s; }
.manage-add-btn:hover { background:#334155; }
.manage-body { flex:1; overflow-y:auto; padding:4px 16px 20px; -webkit-overflow-scrolling:touch; }
.manage-empty { text-align:center; padding:48px 16px; color:var(--sub); }
.manage-empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.manage-empty-text { font-size:13px; margin-bottom:16px; }
.manage-fund { background:var(--card); border-radius:var(--radius); padding:14px 16px; margin-bottom:8px; box-shadow:var(--shadow); transition:all .2s; }
.manage-fund:active { transform:scale(0.98); }
.manage-fund-top { display:flex; justify-content:space-between; align-items:flex-start; }
.manage-fund-info { flex:1; min-width:0; }
.manage-fund-name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.manage-fund-meta { font-size:10px; color:var(--sub); margin-top:3px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
.manage-fund-type { padding:1px 6px; border-radius:4px; background:var(--primary-bg); color:var(--primary); font-size:9px; font-weight:500; }
.manage-fund-right { display:flex; align-items:center; gap:10px; }
.manage-fund-pct { font-size:18px; font-weight:800; font-variant-numeric:tabular-nums; min-width:65px; text-align:right; }
.manage-fund-nav { font-size:10px; color:var(--sub); text-align:right; margin-top:2px; }
.manage-fund-del { background:none; border:1px solid #e2e8f0; color:#94a3b8; cursor:pointer; font-size:12px; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.manage-fund-del:hover { background:#fef2f2; border-color:#fca5a5; color:var(--red); }
.manage-fund-trend { display:flex; gap:8px; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:10px; flex-wrap:wrap; }
.manage-fund-trend span { display:flex; align-items:center; gap:2px; }
.manage-fund-actions { display:flex; gap:6px; margin-top:8px; }
.manage-action-btn { padding:5px 12px; border:1px solid var(--border); border-radius:8px; background:var(--gray-bg); font-size:10px; font-weight:500; cursor:pointer; transition:all .2s; }
.manage-action-btn:hover { background:#1e293b; color:white; border-color:#1e293b; }
.manage-action-btn.danger { color:var(--red); border-color:#fca5a5; }
.manage-action-btn.danger:hover { background:var(--red); color:white; border-color:var(--red); }

/* ==================== 第二层思维 & 逆向投资模块 ==================== */
.sot-section { padding:10px 16px 4px; }
.sot-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.sot-header-right { display:flex; align-items:center; gap:8px; }
.sot-toggle { font-size:12px; color:var(--sub); transition:transform .2s; }
.sot-brief { font-size:11px; font-weight:600; }
.sot-container { margin-top:8px; }
.sot-card { background:var(--card); border-radius:10px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); }
.sot-card.warning { border-left:3px solid #ef4444; }
.sot-card.opportunity { border-left:3px solid #22c55e; }
.sot-card.neutral { border-left:3px solid #64748b; }
.sot-card-title { font-size:12px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
.sot-tag { font-size:9px; padding:2px 8px; border-radius:10px; font-weight:600; }
.sot-tag.hot { background:#fef2f2; color:#ef4444; }
.sot-tag.cold { background:#ecfdf5; color:#22a065; }
.sot-tag.crowd { background:#fef3c7; color:#d97706; }
.sot-event { font-size:11px; color:#1e293b; line-height:1.6; margin-bottom:6px; }
.sot-metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:6px; }
.sot-metric { text-align:center; background:var(--bg); border-radius:6px; padding:6px 4px; }
.sot-metric-label { font-size:8px; color:var(--sub); display:block; letter-spacing:0.3px; }
.sot-metric-val { font-size:12px; font-weight:700; margin-top:1px; font-variant-numeric:tabular-nums; }
.sot-insight { font-size:11px; color:#1e293b; line-height:1.5; padding:8px 10px; background:var(--bg); border-radius:8px; margin-top:6px; }
.sot-insight b { color:var(--primary); }
.sot-second-targets { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }
.sot-target-chip { font-size:9px; padding:2px 8px; border-radius:6px; font-weight:600; background:#eef2ff; color:#4F6EF7; }
/* 拥挤度仪表盘 */
.crowd-gauge { display:flex; align-items:center; gap:6px; margin:4px 0; }
.crowd-bar { flex:1; height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden; position:relative; }
.crowd-fill { height:100%; border-radius:4px; transition:width .4s; }
.crowd-fill.extreme { background:linear-gradient(90deg,#ef4444,#dc2626); }
.crowd-fill.high { background:linear-gradient(90deg,#f59e0b,#ef4444); }
.crowd-fill.mid { background:linear-gradient(90deg,#3b82f6,#f59e0b); }
.crowd-fill.low { background:linear-gradient(90deg,#22c55e,#3b82f6); }
.crowd-fill.desert { background:linear-gradient(90deg,#06b6d4,#22c55e); }
.crowd-label { font-size:10px; font-weight:700; min-width:40px; text-align:right; }
/* Kelly调整仪表 */
.kelly-adj-card { background:linear-gradient(135deg,#0f172a,#1e293b); border-radius:10px; padding:12px 14px; margin-bottom:8px; color:#e2e8f0; }
.kelly-adj-title { font-size:11px; font-weight:700; color:#22d3ee; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.kelly-adj-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.kelly-adj-item { background:rgba(255,255,255,0.05); border-radius:8px; padding:8px 10px; }
.kelly-adj-item-label { font-size:9px; color:rgba(255,255,255,0.5); margin-bottom:3px; }
.kelly-adj-item-val { font-size:16px; font-weight:800; font-variant-numeric:tabular-nums; }
.kelly-adj-item-warn { font-size:9px; color:#f87171; margin-top:2px; }
.kelly-adj-item-ok { font-size:9px; color:#4ade80; margin-top:2px; }
.kelly-formula { font-size:10px; color:rgba(255,255,255,0.4); padding:6px 0; text-align:center; font-family:'SF Mono','Menlo',monospace; }
/* 逆向投资压力测试 */
.contrarian-card { background:var(--card); border-radius:10px; padding:12px 14px; margin-bottom:8px; box-shadow:var(--shadow); border:1px solid var(--border); }
.contrarian-title { font-size:12px; font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.contrarian-section { margin-bottom:10px; }
.contrarian-section-title { font-size:11px; font-weight:700; color:var(--primary); margin-bottom:4px; }
.contrarian-item { padding:6px 0; border-bottom:1px solid var(--border); }
.contrarian-item:last-child { border-bottom:none; }
.contrarian-item-name { font-size:11px; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
.contrarian-item-desc { font-size:10px; color:var(--sub); line-height:1.5; margin-top:2px; }
.contrarian-badge { font-size:9px; padding:1px 6px; border-radius:4px; font-weight:600; }
.contrarian-badge.danger { background:#fef2f2; color:#ef4444; }
.contrarian-badge.safe { background:#ecfdf5; color:#22a065; }
.contrarian-badge.watch { background:#fef3c7; color:#d97706; }
.expectation-bar { display:flex; align-items:center; gap:4px; margin:4px 0; }
.exp-label { font-size:9px; color:var(--sub); min-width:30px; }
.exp-track { flex:1; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden; position:relative; }
.exp-marker { position:absolute; width:3px; height:12px; top:-3px; border-radius:2px; background:#1e293b; }
.exp-fill-reality { position:absolute; height:100%; border-radius:3px; background:linear-gradient(90deg,#22c55e,#16a34a); top:0; left:0; }
.exp-fill-expect { position:absolute; height:100%; border-radius:3px; background:linear-gradient(90deg,#ef4444,#dc2626); opacity:0.3; top:0; left:0; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
 <span class="header-title">基金决策助手</span>
    <div style="display:flex;gap:6px;align-items:center">
 <a href="sentiment-analysis.html" style="display:inline-block;padding:4px 10px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);border-radius:6px;color:white;font-size:11px;font-weight:600;text-decoration:none;white-space:nowrap">舆情</a>
 <a href="manager-analysis.html" style="display:inline-block;padding:4px 10px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);border-radius:6px;color:white;font-size:11px;font-weight:600;text-decoration:none;white-space:nowrap">TOP500</a>
 <button class="header-gear" onclick="openSettings()">设置</button>
    </div>
  </div>
  <div class="market-status">
    <span class="status-dot" id="status-dot"></span>
    <span id="market-status-text">检测中...</span>
    <span class="countdown" id="countdown">--:--:--</span>
    <span id="nav-refresh-time" style="font-size:9px;color:rgba(255,255,255,0.5);margin-left:4px;display:none"></span>
  </div>
</div>

<!-- Index Bar (single compact row) -->
<div class="idx-bar" id="idx-bar">
  <div class="idx-item"><div class="idx-name">上证</div><div class="idx-val" id="iv-sh">--</div><div class="idx-pct flat" id="ip-sh">--</div></div>
  <div class="idx-item"><div class="idx-name">深证</div><div class="idx-val" id="iv-sz">--</div><div class="idx-pct flat" id="ip-sz">--</div></div>
  <div class="idx-item"><div class="idx-name">创业板</div><div class="idx-val" id="iv-cy">--</div><div class="idx-pct flat" id="ip-cy">--</div></div>
  <div class="idx-item"><div class="idx-name">沪深300</div><div class="idx-val" id="iv-hs">--</div><div class="idx-pct flat" id="ip-hs">--</div></div>
  <div class="idx-item"><div class="idx-name">黄金</div><div class="idx-val" id="iv-au">--</div><div class="idx-pct flat" id="ip-au">--</div></div>
  <div class="idx-item"><div class="idx-name">白银</div><div class="idx-val" id="iv-ag">--</div><div class="idx-pct flat" id="ip-ag">--</div></div>
  <div class="idx-item"><div class="idx-name">有色</div><div class="idx-val" id="iv-ys">--</div><div class="idx-pct flat" id="ip-ys">--</div></div>
</div>

<!-- Stats Bar -->
<div class="stats-bar" id="stats-bar">
  <div class="stat-item">
    <div class="stat-label">今日持仓盈亏</div>
    <div class="stat-value" id="stat-today">--</div>
    <div class="stat-sub" id="stat-bench-today"></div>
  </div>
  <div class="stat-item">
    <div class="stat-label">沪深300今日</div>
    <div class="stat-value" id="stat-hs300">--</div>
    <div class="stat-sub" id="stat-bench-label">大盘基准</div>
  </div>
</div>



<!-- Real-World Action Guide -->
<div class="action-guide">
  <div class="section-title action-guide-header" onclick="toggleActionGuide()">
 <span> 实盘行动指南 <span style="font-size:10px;color:var(--sub);font-weight:400">双引擎共识 · 实操建议</span></span>
    <div class="action-guide-header-right">
      <span id="action-guide-brief" class="action-guide-brief" style="color:var(--sub)">等待分析</span>
      <span class="action-guide-toggle" id="action-guide-toggle">▼</span>
    </div>
  </div>
  <div id="action-guide-container" class="action-guide-container"></div>
  <div class="ai-btn-wrap" style="padding:10px 0 2px">
    <button class="ai-btn" id="ai-btn" onclick="triggerAI()">
 一键AI分析 · 4引擎研判
    </button>
    <div class="ai-progress" id="ai-progress"></div>
  </div>
</div>

<!-- Plain-Language Institutional Analysis -->
<div class="section" id="plain-advisor-section">
  <div class="section-title" style="cursor:pointer" onclick="togglePlainAdvisor()">
 白话研判 <span style="font-size:10px;color:var(--sub);font-weight:400">机构逻辑 · 小白可懂</span>
    <span id="plain-advisor-toggle" style="margin-left:auto;font-size:12px;color:var(--sub)">▼</span>
  </div>
  <div id="plain-advisor-container"></div>
</div>

<!-- Engine Details (RL + Backtest + Second-Order merged) -->
<div class="engine-detail-section" style="padding:10px 16px 4px">
  <div class="section-title" style="cursor:pointer" onclick="toggleEngineDetail()">
 <span> 引擎详情 <span style="font-size:10px;color:var(--sub);font-weight:400">
      <span id="rl-brain-brief" style="margin-right:4px">RL:未训练</span>
      <span id="bt-brief" style="margin-right:4px">BT:未回测</span>
      <span id="sot-brief">SOT:加载中</span>
    </span></span>
    <span id="engine-detail-toggle" style="font-size:12px;color:var(--sub);margin-left:auto">▶</span>
  </div>
  <div id="engine-detail-body" style="display:none">
    <div style="display:flex;gap:0;background:var(--card);border-radius:10px;overflow:hidden;margin-bottom:8px;box-shadow:var(--shadow)">
 <div class="eng-tab active" id="eng-tab-rl" onclick="switchEngTab('rl')" style="flex:1;text-align:center;padding:8px 4px;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid #1e293b;color:var(--text);transition:all .2s"> RL大脑</div>
 <div class="eng-tab" id="eng-tab-bt" onclick="switchEngTab('bt')" style="flex:1;text-align:center;padding:8px 4px;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--sub);transition:all .2s"> 回测</div>
 <div class="eng-tab" id="eng-tab-sot" onclick="switchEngTab('sot')" style="flex:1;text-align:center;padding:8px 4px;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--sub);transition:all .2s"> 二层思维</div>
    </div>
    <div id="rl-brain-container" class="rl-brain-container"></div>
    <div id="bt-container" class="bt-container" style="display:none"></div>
    <div id="sot-container" class="sot-container" style="display:none"></div>
  </div>
</div>

<!-- Simulation Portfolio (collapsed by default) -->
<div class="sim-section">
  <div class="section-title sim-header" onclick="toggleSimDetail()">
 <span> AI模拟盘 <span style="font-size:10px;color:var(--sub);font-weight:400">50万建仓 · AI自动交易</span></span>
    <div class="sim-header-right">
      <span id="sim-brief" style="font-size:12px;font-weight:700">--</span>
      <span class="sim-toggle-icon" id="sim-toggle-icon">▶</span>
    </div>
  </div>
  <div id="sim-container" style="display:none"></div>
</div>

<!-- Portfolio Section (collapsed by default) -->
<div class="pf-section">
  <div class="section-title" style="cursor:pointer" onclick="togglePortfolioSection()">
 <span> 波段组合 <span style="font-size:10px;color:var(--sub);font-weight:400">实时趋势 · 波段信号</span></span>
    <span id="pf-section-toggle" style="font-size:12px;color:var(--sub);margin-left:auto">▶</span>
  </div>
  <div id="pf-section-body" style="display:none">
    <div class="pf-tabs">
 <div class="pf-tab active" onclick="switchPfTab('core')" id="pf-tab-core"> 核心仓<span class="pf-tab-ratio">建议60%</span></div>
 <div class="pf-tab" onclick="switchPfTab('satellite')" id="pf-tab-sat"> 卫星仓<span class="pf-tab-ratio">建议40%</span></div>
    </div>
    <div class="pf-group active" id="pf-group-core"></div>
    <div class="pf-group" id="pf-group-satellite"></div>
  </div>
</div>

<!-- Market Summary (AI generated) -->
<div class="section" id="market-summary-section" style="display:none">
  <div id="market-summary"></div>
</div>

<!-- Daily Review -->
<div class="review-section" id="review-section" style="display:none">
 <div class="section-title"> 每日复盘 <span style="font-size:10px;color:var(--sub);font-weight:400">昨日判断 vs 今日结果</span></div>
  <div id="review-container"></div>
  <div class="review-history-toggle" id="review-history-toggle" style="display:none">
 <span class="review-toggle" onclick="toggleReviewHistory()"> 查看历史复盘记录</span>
  </div>
  <div id="review-history" style="display:none"></div>
</div>

<!-- Prediction Tracker -->
<div class="section" id="pred-tracker-section">
  <div class="section-title" style="cursor:pointer" onclick="document.getElementById('pred-tracker-container').style.display=document.getElementById('pred-tracker-container').style.display==='none'?'':'none';this.querySelector('.toggle-arrow').textContent=document.getElementById('pred-tracker-container').style.display==='none'?'▶':'▼'">
 预测追踪 <span style="font-size:10px;color:var(--sub);font-weight:400">14:50快照 → 次日验证</span>
    <span class="toggle-arrow" style="float:right;font-size:10px;color:var(--sub)">▼</span>
  </div>
  <div id="pred-tracker-container" style="padding:0 14px 10px"></div>
</div>



<!-- Watchlist Signals -->
<div class="section" id="watchlist-section" style="display:none">
 <div class="section-title"> 自选观察</div>
  <div id="watchlist-container"></div>
</div>

<!-- AI Recommendations -->
<div class="section" id="reco-section" style="display:none">
 <div class="section-title"> AI推荐关注 <span style="font-size:10px;color:var(--sub);font-weight:400">3月稳健增长视角</span></div>
  <div id="reco-container"></div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
 <button class="bottom-btn primary" onclick="openManagePanel('holding')"> 持仓管理</button>
 <button class="bottom-btn secondary" onclick="openManagePanel('watch')"> 自选管理</button>
</div>

<!-- Manage Panel (Full Screen Slide Up) -->
<div class="manage-overlay" id="manage-overlay" onclick="if(event.target===this)closeManagePanel()">
  <div class="manage-panel">
    <div class="manage-header">
      <div class="manage-tabs">
 <div class="manage-tab active" id="manage-tab-holding" onclick="switchManageTab('holding')"> 持仓 <span class="manage-count" id="manage-holding-count">0</span></div>
 <div class="manage-tab" id="manage-tab-watch" onclick="switchManageTab('watch')"> 自选 <span class="manage-count" id="manage-watch-count">0</span></div>
      </div>
 <button class="manage-close" onclick="closeManagePanel()"></button>
    </div>
    <div class="manage-toolbar">
 <input type="text" class="manage-search" id="manage-search" placeholder=" 搜索基金代码或名称..." oninput="renderManageList()">
      <button class="manage-add-btn" onclick="openAddModal(_manageTab)">+ 添加</button>
    </div>
    <div class="manage-body" id="manage-body"></div>
  </div>
</div>

<!-- Add Fund Modal -->
<div class="modal-overlay" id="add-modal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal">
 <h3 id="add-modal-title">添加持仓 <button onclick="closeAddModal()"></button></h3>
    <!-- 搜索区 -->
    <div id="add-search-area">
      <div class="fund-search-box">
 <span class="search-icon"></span>
        <input type="text" id="add-search-input" placeholder="输入基金代码或名称搜索..." oninput="onFundSearchInput()" autocomplete="off">
      </div>
      <div class="fund-search-results" id="add-search-results"></div>
      <div id="add-search-hint" class="fund-search-hint">输入基金代码（如 000216）或关键词（如「黄金」）搜索</div>
    </div>
    <!-- 已选中区 -->
    <div id="add-selected-area" style="display:none">
      <div class="fund-selected-card">
        <span class="sel-code" id="add-sel-code"></span>
        <span class="sel-name" id="add-sel-name"></span>
 <button class="sel-clear" onclick="clearFundSelection()" title="重新选择"></button>
      </div>
      <div class="form-row" id="add-type-row"><label>类型</label>
        <select id="add-type"><option value="宽基">宽基</option><option value="AI/科技">AI/科技</option><option value="黄金">黄金</option><option value="红利">红利</option><option value="军工">军工</option><option value="新能源">新能源</option><option value="消费">消费</option><option value="医药">医药</option><option value="半导体">半导体</option><option value="有色金属">有色金属</option><option value="QDII">QDII</option><option value="其他">其他</option></select>
      </div>
      <button class="form-btn" onclick="confirmAdd()">确认添加</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="max-width:360px">
 <h3> 设置 <button onclick="closeSettings()"></button></h3>
    <div style="padding:6px 0">
 <div style="font-size:11px;font-weight:600;margin-bottom:8px"> AI服务商</div>
      <div id="provider-list"></div>
      <div style="font-size:11px;font-weight:600;margin:14px 0 6px">API Key</div>
      <div class="form-row">
        <input type="password" id="input-key" placeholder="输入API Key" style="width:100%;font-size:12px">
      </div>
      <div id="provider-hint" style="font-size:10px;color:var(--sub);margin:-6px 0 10px"></div>
      <div style="font-size:11px;font-weight:600;margin:12px 0 6px">AI引擎模型：</div>
      <div id="engine-list" style="font-size:11px"></div>
      <button class="form-btn" onclick="saveSettings()" style="margin-top:14px">保存设置</button>
      <div style="text-align:center;margin-top:8px">
        <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="toggleKeyVis()">显示/隐藏Key</span>
        <span style="font-size:10px;color:var(--sub);margin-left:12px;cursor:pointer;text-decoration:underline" onclick="clearAllData()">清除所有数据</span>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== FUND DATABASE ====================
const FUND_DB = [
  {code:'000216',name:'华安黄金ETF联接A',type:'黄金',baseNav:3.85},
  {code:'022430',name:'华夏中证A500ETF联接A',type:'宽基',baseNav:1.24},
  {code:'019868',name:'华夏云计算与大数据ETF联接A',type:'AI/科技',baseNav:1.82},
  {code:'004814',name:'中欧红利优享混合A',type:'红利',baseNav:2.38},
  {code:'003017',name:'广发中证军工ETF联接A',type:'军工',baseNav:1.43},
  {code:'003834',name:'华夏能源革新股票A',type:'新能源',baseNav:3.45},
  {code:'161725',name:'招商中证白酒指数(LOF)A',type:'白酒/消费',baseNav:0.70},
  {code:'110011',name:'易方达优质精选混合(QDII)',type:'蓝筹/QDII',baseNav:5.33},
  {code:'005827',name:'易方达蓝筹精选混合',type:'蓝筹',baseNav:1.91},
  {code:'008887',name:'华夏国证半导体芯片ETF联接A',type:'半导体',baseNav:1.69},
  {code:'320007',name:'诺安成长混合A',type:'半导体/科技',baseNav:2.05},
  {code:'160119',name:'南方中证500ETF联接(LOF)A',type:'宽基',baseNav:2.32},
];

// 推荐组合：核心仓(稳健长持) + 卫星仓(波段进攻)
const MODEL_PORTFOLIO = {
  core: {
 label:' 核心仓', ratio:'60%',
    desc:'压舱石配置，长期持有为主，追求稳健收益。宽基+黄金+红利三角组合，低相关性分散风险。',
    funds: [
      {code:'022430',name:'华夏中证A500ETF联接A',type:'宽基',alloc:'20%',reason:'A股核心500资产，长期配置基石'},
      {code:'007339',name:'易方达沪深300ETF联接C',type:'宽基',alloc:'15%',reason:'沪深300核心蓝筹，费率低，流动性好'},
      {code:'000216',name:'华安黄金ETF联接A',type:'黄金',alloc:'15%',reason:'避险+抗通胀，与股市低相关，央行持续购金'},
      {code:'021418',name:'泰康红利低波ETF联接C',type:'红利',alloc:'10%',reason:'高股息低波动，下行保护强，稳定分红'},
    ]
  },
  satellite: {
 label:' 卫星仓', ratio:'40%',
    desc:'弹性进攻仓位，积极做波段——逢跌买入、逢涨止盈。关注趋势向上且短期回调的品种。',
    funds: [
      {code:'016708',name:'华夏有色金属ETF联接C',type:'有色金属',alloc:'10%',reason:'全球铜铝涨价+新基建需求，波动大波段空间足'},
      {code:'008586',name:'华夏人工智能ETF联接C',type:'AI/科技',alloc:'8%',reason:'AI产业爆发，算力需求旺盛，成长性强'},
      {code:'008887',name:'华夏国证半导体芯片ETF联接A',type:'半导体',alloc:'8%',reason:'国产替代逻辑硬，估值弹性大'},
      {code:'005693',name:'广发中证军工ETF联接C',type:'军工',alloc:'7%',reason:'地缘催化+装备采购周期，事件驱动型波段'},
      {code:'007993',name:'华夏中证全指证券公司ETF联接C',type:'金融',alloc:'7%',reason:'牛市先锋，政策受益弹性品种，β属性强'},
    ]
  }
};

const RECO_FUND_POOL = [
  {code:'002611',name:'博时黄金ETF联接C',type:'黄金',tags:['避险','贵金属']},
  {code:'000217',name:'华安黄金ETF联接C',type:'黄金',tags:['避险','黄金']},
  {code:'008586',name:'华夏人工智能ETF联接C',type:'AI/科技',tags:['AI','产业趋势']},
  {code:'023565',name:'易方达科创人工智能ETF联接C',type:'AI/科技',tags:['AI','算力']},
  {code:'012553',name:'天弘芯片产业ETF联接C',type:'半导体',tags:['芯片','国产替代']},
  {code:'007874',name:'华宝科技ETF联接C',type:'科技',tags:['科技龙头','硬科技']},
  {code:'005693',name:'广发中证军工ETF联接C',type:'军工',tags:['国防军工','战略']},
  {code:'009068',name:'国泰中证新能源汽车ETF联接C',type:'新能源',tags:['新能源车','电池']},
  {code:'001632',name:'天弘中证食品饮料ETF联接C',type:'消费',tags:['食品饮料','内需']},
  {code:'001550',name:'天弘中证医药100A',type:'医药',tags:['医药','创新药']},
  {code:'021418',name:'泰康红利低波ETF联接C',type:'红利',tags:['红利','低波动']},
  {code:'015558',name:'万家中证红利ETF联接C',type:'红利',tags:['高股息','稳健']},
  {code:'007339',name:'易方达沪深300ETF联接C',type:'宽基',tags:['沪深300','核心资产']},
  {code:'001593',name:'天弘创业板ETF联接C',type:'宽基',tags:['创业板','成长']},
  {code:'022431',name:'华夏中证A500ETF联接C',type:'宽基',tags:['A500','核心']},
  {code:'016708',name:'华夏有色金属ETF联接C',type:'有色金属',tags:['有色','铜铝']},
  {code:'007993',name:'华夏中证全指证券公司ETF联接C',type:'金融',tags:['券商','政策受益']},
  {code:'012810',name:'鹏华国证钢铁行业指数(LOF)C',type:'钢铁',tags:['钢铁','周期','资源']},
  {code:'013403',name:'华夏恒生科技ETF发起式联接(QDII)C',type:'港股科技/QDII',tags:['港股','恒生科技','互联网','QDII']},
];

const INDICES_CONFIG = [
  {name:'上证',secid:'1.000001',group:'stock'},
  {name:'深成',secid:'0.399001',group:'stock'},
  {name:'创业板',secid:'0.399006',group:'stock'},
  {name:'沪深300',secid:'1.000300',group:'benchmark'},
  {name:'黄金ETF',secid:'1.518880',group:'commodity'},
  {name:'白银LOF',secid:'0.161226',group:'commodity'},
  {name:'有色金属',secid:'1.000819',group:'commodity'},
];

// ==================== AI PROVIDER CONFIG ====================
const AI_PROVIDERS = [
  {
    id:'siliconflow', name:'硅基流动(免费)', free:true,
    base:'https://api.siliconflow.cn/v1/chat/completions',
    desc:'免费开源模型，注册即用',
    link:'https://cloud.siliconflow.cn',
    models: [
      {id:'engine1', name:'DeepSeek-V3', icon:'🫘', role:'技术分析+量化因子', model:'deepseek-ai/DeepSeek-V3'},
      {id:'engine2', name:'Qwen2.5-72B', icon:'🔮', role:'宏观经济+政策面', model:'Qwen/Qwen2.5-72B-Instruct'},
      {id:'engine3', name:'DeepSeek-R1-32B', icon:'🔍', role:'深度基本面+行业研究', model:'deepseek-ai/DeepSeek-R1-Distill-Qwen-32B'},
      {id:'engine4', name:'Gemma-2-27B', icon:'♊', role:'全球视角+风险评估', model:'google/gemma-2-27b-it'},
    ]
  },
  {
    id:'deepseek', name:'DeepSeek官方(极低价)', free:false,
    base:'https://api.deepseek.com/chat/completions',
    desc:'¥1/百万token，几乎免费',
    link:'https://platform.deepseek.com',
    models: [
      {id:'engine1', name:'DeepSeek-V3①', icon:'🫘', role:'技术分析+量化因子', model:'deepseek-chat'},
      {id:'engine2', name:'DeepSeek-V3②', icon:'🔮', role:'宏观经济+政策面', model:'deepseek-chat'},
      {id:'engine3', name:'DeepSeek-R1', icon:'🔍', role:'深度基本面+行业研究', model:'deepseek-reasoner'},
      {id:'engine4', name:'DeepSeek-V3③', icon:'♊', role:'全球视角+风险评估', model:'deepseek-chat'},
    ]
  },
  {
    id:'302ai', name:'302.AI(付费)', free:false,
    base:'https://api.302.ai/v1/chat/completions',
    desc:'聚合平台，支持多种模型',
    link:'https://302.ai',
    models: [
      {id:'engine1', name:'豆包', icon:'🫘', role:'技术分析+量化因子', model:'doubao-1.5-pro-32k'},
      {id:'engine2', name:'通义千问', icon:'🔮', role:'宏观经济+政策面', model:'qwen3-235b-a22b'},
      {id:'engine3', name:'DeepSeek', icon:'🔍', role:'深度基本面+行业研究', model:'deepseek-r1'},
      {id:'engine4', name:'Gemini', icon:'♊', role:'全球视角+风险评估', model:'gemini-2.5-flash'},
    ]
  }
];

let _aiProviderId = localStorage.getItem('fa_ai_provider') || 'siliconflow';
let _aiProvider = AI_PROVIDERS.find(p=>p.id===_aiProviderId) || AI_PROVIDERS[0];
let AI_ENGINES = _aiProvider.models;
let _apiBase = _aiProvider.base;

const AI_KEY_PRIMARY_STORAGE = 'fa_302ai_key';
const AI_KEY_LEGACY_STORAGES = ['fa_ai_key', 'fa_api_key', 'fund_ai_key'];
function getStoredApiKey(){
  const primary = (localStorage.getItem(AI_KEY_PRIMARY_STORAGE)||'').trim();
  if(primary) return primary;
  for(const k of AI_KEY_LEGACY_STORAGES){
    const legacy = (localStorage.getItem(k)||'').trim();
    if(legacy){
      localStorage.setItem(AI_KEY_PRIMARY_STORAGE, legacy);
      console.log('[Init] API Key migrated from', k);
      return legacy;
    }
  }
  // Default API Key
  const defaultKey = 'sk-njqerftsrrnojbsdagigsrzbwwxgtuhrsyihphcxvsdpbaxl';
  localStorage.setItem(AI_KEY_PRIMARY_STORAGE, defaultKey);
  return defaultKey;
}

// ==================== STATE ====================
let holdings = JSON.parse(localStorage.getItem('fa_holdings')||'[]');
let watchlist = JSON.parse(localStorage.getItem('fa_watchlist')||'[]');
let liveIndices = {};
let liveFundData = {};
let liveSectors = [];
let fundHistoryData = {}; // { code: { navs: [{date,nav}], trend:{} } }
let intradayData = {};    // { code: [{time:'HH:MM', gsz:1.23, pct:0.45}] }
let _aiKey = getStoredApiKey();
let _analyzing = false;
let _analysisResult = null;
let _addMode = 'holding';
let _refreshTimer = null;
let _countdownTimer = null;
let dailyLog = JSON.parse(localStorage.getItem('fa_daily_log')||'[]'); // [{date, predictions:{code:{action,confidence,trend,reason}}, pnl:{code:pct}, avgPnl, hs300Pct}]
let simPortfolio = JSON.parse(localStorage.getItem('fa_sim_portfolio')||'null');

// ==================== 预测追踪系统 (Prediction Tracker) ====================
const PRED_TRACKER_KEY = 'fa_prediction_tracker';
let predictionTracker = JSON.parse(localStorage.getItem(PRED_TRACKER_KEY)||'[]');
// [{date, timestamp, holdings:{code:{name,type,action,actionLabel,score,confidence,
//   aiVote,rlVote,btVote,buyVotes,sellVotes,gszzl,dwjz,gsz,rsi,geoBias,briefReason}},
//   overallScore, overallLabel, verified, verification}]
let _predSnapshotDoneToday = !!predictionTracker.find(p => p.date === new Date().toISOString().slice(0,10)); // 防止重复快照
const SIM_INITIAL_CAPITAL = 500000;
const SIM_TARGET_MONTHLY = 10000;
const SIM_FEE_RATE = 0.0015;

// ==================== DATA INTELLIGENCE STATE ====================
let macroData = { cpi:null, ppi:null, pmi:null, gdp:null, m2:null }; // 宏观经济数据
let sectorCapFlow = []; // 板块资金流向
let newsHeadlines = []; // 财经新闻
let newsSentiment = { score:50, label:'中性', bullCount:0, bearCount:0 }; // 舆情综合得分0-100
let globalNews = []; // 国际新闻聚合
let globalNewsSummary = null; // AI国际新闻摘要 { summary, impact, sentiment }
let _globalNewsLoading = false;
let _dataIntelLoaded = false;
let _geoNewsLastUpdate = null; // 地缘事件最后更新时间
let _geoNewsLiveItems = []; // 来自全球媒体的最新地缘新闻
let _geoNewsRefreshTimer = null; // 1小时刷新定时器
let _geoNewsRefreshing = false;

// ==================== 宏观事件引擎 v2 (Hot Events Pipeline) ====================
// 事件数据由 GitHub Actions 每30分钟自动更新到 data/hot_events.json
// 前端动态加载, 不再硬编码事件列表

// 热点数据全局状态
let _hotEventsData = null;        // 原始JSON数据
let _hotEventsLoaded = false;     // 是否已加载
let _hotEventsLastUpdate = null;  // 上次加载时间

// 类别图标映射
const CATEGORY_ICONS = {
 technology: '', geopolitics: '', monetary: '',
 policy: '', commodity: '', market: '',
};

// 动态事件数组 (从JSON加载后填充, 兼容原getMacroGeoAnalysis接口)
// === 大宗商品/资源常驻基础事件 (永远保留, 确保油气/有色/黄金等持仓可被归因) ===
const _COMMODITY_BASE_EVENTS = [
  {
    id: 'fallback_gold', name: '避险资产受青睐', category: 'commodity', icon: '🥇',
    description: '地缘不确定性+央行购金→黄金走强',
    impact: 8, confidence: 0.8,
    sectors: { positive: ['黄金','贵金属','有色金属'], negative: [] },
    fundKeywords: ['黄金','贵金属','避险','白银','有色金属'], duration: 'medium', advice: '黄金ETF作底仓配置',
    _baseSectors: ['黄金','贵金属'],  // 判断动态事件是否已覆盖的关键词
  },
  {
    id: 'fallback_metals', name: '全球有色金属需求旺盛', category: 'commodity', icon: '🔩',
    description: '新基建+新能源车带动铜铝需求，有色金属价格高位运行',
    impact: 10, confidence: 0.75,
    sectors: { positive: ['有色金属','铜铝','大宗商品','资源'], negative: [] },
    fundKeywords: ['有色金属','铜','铝','资源','矿业'], duration: 'medium', advice: '有色金属ETF波段操作',
    _baseSectors: ['有色金属','铜铝'],
  },
  {
    id: 'fallback_oil', name: '国际油价波动加剧', category: 'commodity', icon: '🛢️',
    description: 'OPEC减产+地缘冲突→油气价格波动信号',
    impact: 6, confidence: 0.7,
    sectors: { positive: ['能源','原油','油气','大宗商品'], negative: [] },
    fundKeywords: ['原油','油气','石油','天然气','能源'], duration: 'medium', advice: '油气ETF关注供给端变化',
    _baseSectors: ['能源','原油','油气'],
  },
];

// === 隔夜美股 → A股板块映射 (用于自动生成归因事件) ===
const _US_MARKET_SECTOR_MAP = {
  'NVDA':  { cn:'英伟达',    threshold:1.5, isIndex:false, sectors:['半导体','AI/科技','芯片','算力'],              keywords:['半导体','芯片','科技','AI','算力','英伟达'] },
  'AMD':   { cn:'AMD',       threshold:2,   isIndex:false, sectors:['半导体','AI/科技','芯片'],                     keywords:['半导体','芯片','AMD','科技'] },
  'AVGO':  { cn:'博通',      threshold:2,   isIndex:false, sectors:['半导体','芯片'],                               keywords:['半导体','芯片','博通'] },
  'SOXX':  { cn:'费半指数',  threshold:1,   isIndex:true,  sectors:['半导体','芯片','AI/科技','科技'],              keywords:['半导体','芯片','科技','费半'] },
  'TSLA':  { cn:'特斯拉',    threshold:2,   isIndex:false, sectors:['新能源','新能源车'],                           keywords:['新能源','新能源车','特斯拉','汽车','锂电'] },
  'AAPL':  { cn:'苹果',      threshold:2,   isIndex:false, sectors:['科技','消费电子'],                             keywords:['苹果','科技','消费电子','果链'] },
  '.IXIC': { cn:'纳指',      threshold:0.8, isIndex:true,  sectors:['科技','AI/科技','QDII科技','港股科技'],        keywords:['纳斯达克','纳指','科技','QDII','美股'] },
  '.INX':  { cn:'标普500',   threshold:1,   isIndex:true,  sectors:['QDII'],                                       keywords:['标普','美股','QDII'] },
  '.DJI':  { cn:'道指',      threshold:1.5, isIndex:true,  sectors:['QDII'],                                       keywords:['道琼斯','道指','美股','QDII'] },
};

let MACRO_GEO_EVENTS = [
  // === 最小回退集 (JSON加载失败时使用) ===
  {
    id: 'fallback_ai', name: 'AI产业持续爆发', category: 'technology', icon: '🤖',
    description: 'AI全面渗透各行业，算力需求持续爆发',
    impact: 15, confidence: 0.85,
    sectors: { positive: ['AI/科技','半导体','算力','AIGC'], negative: ['传统劳动密集型','港股互联网'] },
    fundKeywords: ['人工智能','AI','算力','科技'], duration: 'long', advice: 'AI/算力逢回调加仓',
  },
  ..._COMMODITY_BASE_EVENTS,
  {
    id: 'fallback_hktech', name: '港股科技承压', category: 'market', icon: '📉',
    description: '外资流出+AI创企虹吸→恒生科技回调',
    impact: -10, confidence: 0.85,
    sectors: { positive: [], negative: ['港股科技','港股互联网','恒生科技','QDII科技'] },
    fundKeywords: ['恒生科技','港股','互联网','QDII'], duration: 'medium', advice: '恒生科技ETF建议减仓',
  },
];

// 动态三月展望
let MACRO_3M_OUTLOOK = {
  period: '加载中...', overall: '等待数据更新', score: 50,
  themes: [], risks: [], allocation: { offensive:'', core:'', hedge:'', cash:'' },
};

// 从JSON加载并标准化事件到内部格式
async function fetchHotEvents(){
  try {
    // GitHub Pages部署时从同域加载; 开发时从相对路径
    const urls = ['./data/hot_events.json', 'data/hot_events.json'];
    let data = null;
    for(const url of urls){
      try {
        const resp = await fetch(url + '?_=' + Date.now(), { signal: AbortSignal.timeout(8000) });
        if(resp.ok){ data = await resp.json(); break; }
      } catch(e){ continue; }
    }
    if(!data || !data.events){ console.warn('[HotEvents] JSON加载失败, 使用回退数据'); return; }

    _hotEventsData = data;
    _hotEventsLoaded = true;
    _hotEventsLastUpdate = new Date();

    // 标准化事件到内部格式 (兼容getMacroGeoAnalysis)
    MACRO_GEO_EVENTS = data.events.map(e => ({
      id: e.id,
      name: e.title,
      category: e.category || 'market',
      icon: CATEGORY_ICONS[e.category] || '📌',
      description: e.reason || e.title,
      impact: e.impact || 0,
      confidence: e.confidence || 0.7,
      sectors: {
        positive: e.sectors_positive || [],
        negative: e.sectors_negative || [],
      },
      fundKeywords: e.fund_keywords || [],
      duration: 'medium',
      advice: e.advice || '',
      concepts: e.concepts || [],    // 新增: 关联标签
      sentiment: e.sentiment || 0,   // 新增: 情绪分数
    }));

    // === 合并大宗商品常驻事件 (确保油气/有色/黄金持仓始终可被归因) ===
    const allDynSectors = new Set();
    MACRO_GEO_EVENTS.forEach(ev => {
      (ev.sectors.positive || []).forEach(s => allDynSectors.add(s));
      (ev.sectors.negative || []).forEach(s => allDynSectors.add(s));
    });
    _COMMODITY_BASE_EVENTS.forEach(fb => {
 // 改为ALL: 所有baseSectors都被覆盖才跳过(防止'新能源'误盖'能源')
      const covered = fb._baseSectors.every(s => allDynSectors.has(s));
      if(!covered){
        MACRO_GEO_EVENTS.push({...fb});
        console.log(`[HotEvents] 补充常驻事件: ${fb.name} (动态事件未完全覆盖 ${fb._baseSectors.join('/')})`);
      }
    });

    // 更新展望
    if(data.outlook){
      MACRO_3M_OUTLOOK = {
        period: data.outlook.period || '',
        overall: data.outlook.summary || '',
        score: data.outlook.score || 50,
        themes: [], risks: [],
        allocation: { offensive:'', core:'', hedge:'', cash:'' },
      };
    }

    console.log(`[HotEvents] ✅ 加载 ${MACRO_GEO_EVENTS.length} 个事件, 更新时间: ${data.updated_at}`);
  } catch(e){
    console.warn('[HotEvents] 加载失败, 使用回退数据:', e);
  }
}

// === 隔夜美股行情 → 持仓异动归因事件注入 ===
let _usMarketData = null; // 缓存美股数据供UI使用
async function fetchUSMarketForAttribution(){
  try {
    const resp = await fetch('/api/us_market?_=' + Date.now(), { signal: AbortSignal.timeout(6000) });
    if(!resp.ok) return;
    const data = await resp.json();
    const stocks = data.stocks || [];
    if(stocks.length === 0) return;

    _usMarketData = data;  // 缓存原始数据
    let injected = 0;

    stocks.forEach(s => {
      const mapping = _US_MARKET_SECTOR_MAP[s.symbol];
      if(!mapping) return;
      const pct = s.percent || 0;
      const absPct = Math.abs(pct);
      // 低于阈值 → 无显著影响, 跳过
      if(absPct < mapping.threshold) return;

      // 动态评估影响度和置信度
      let impact, confidence;
      if(absPct >= 5){
        impact = pct > 0 ? 18 : -18;  confidence = 0.95;
      } else if(absPct >= 3){
        impact = pct > 0 ? 14 : -14;  confidence = 0.9;
      } else if(absPct >= 2){
        impact = pct > 0 ? 10 : -10;  confidence = 0.8;
      } else {
        impact = pct > 0 ? 6 : -6;    confidence = 0.7;
      }

      // 指数影响力略低(指数波动幅度小但意义不同)
      if(mapping.isIndex && absPct < 2) confidence *= 0.85;

      const direction = pct > 0 ? 'positive' : 'negative';
      const pctStr = (pct > 0 ? '+' : '') + pct.toFixed(2) + '%';
      const verb = pct > 0 ? '涨' : '跌';

      MACRO_GEO_EVENTS.push({
        id: 'us_' + s.symbol.replace('.',''),
        name: mapping.cn + verb + pctStr,
        category: 'market',
        icon: '🇺🇸',
        description: '隔夜美股' + mapping.cn + verb + pctStr + '，' +
          (pct > 0 ? '利好' : '利空') + 'A股' + mapping.sectors.slice(0,2).join('/') + '板块',
        impact: impact,
        confidence: confidence,
        sectors: direction === 'positive'
          ? { positive: [...mapping.sectors], negative: [] }
          : { positive: [], negative: [...mapping.sectors] },
        fundKeywords: [...mapping.keywords],
        duration: 'short',
        advice: mapping.cn + verb + pctStr + '，关注A股' + mapping.sectors[0] + '板块联动',
        concepts: mapping.sectors.slice(0,3),
        sentiment: pct > 0 ? Math.min(40, absPct * 8) : -Math.min(40, absPct * 8),
        _usMarket: true,  // 标记为美股来源事件
      });
      injected++;
    });

    if(injected > 0){
      console.log(`[USMarket] 🇺🇸 注入 ${injected} 个美股归因事件到 MACRO_GEO_EVENTS (总计 ${MACRO_GEO_EVENTS.length})`);
    }
  } catch(e){
    console.warn('[USMarket] 美股行情加载失败, 归因不受影响:', e);
  }
}

// 原有事件格式占位 (已被上面的动态数组替代, 此处标记废弃)
// LEGACY: 原 MACRO_GEO_EVENTS 硬编码已迁移到 data/hot_events.json
// ==================== 原硬编码事件数据 (以下全部替换为动态加载) ====================
const _LEGACY_EVENTS_REMOVED = true; // 标记: 16个硬编码事件已移除

// ==================== 第二层思维引擎 (Second-Order Thinking Engine) ====================

/**
 * 计算反拥挤度调整后的Kelly仓位
 * @param {number} winRate 基础胜率 (0~1)
 * @param {number} odds 赔率 (平均盈利/平均亏损)
 * @param {number} crowdingScore 拥挤度评分 (0~100, 越高越拥挤)
 * @param {number} rsiValue RSI指标值 (0~100)
 * @returns {object} { kellyBase, kellyAdjusted, penalty, bonus, status, warning }
 */
function calculateAdjustedKelly(winRate, odds, crowdingScore, rsiValue) {
  // 1. 标准Kelly公式: f* = (b*p - q) / b
  const b = odds;
  const p = Math.max(0, Math.min(1, winRate));
  const q = 1 - p;
  const kellyBase = Math.max(0, (b * p - q) / b);

  let kellyAdjusted = kellyBase;
  let penalty = 1.0;
  let bonus = 1.0;
  let status = 'normal'; // normal | crowded_warning | contrarian_opportunity
  let warning = '';

  // 2. 拥挤度惩罚机制 (Anti-Crowding Penalty)
  // 极度拥挤: crowding > 80 且 RSI > 70 → 共识陷阱，大幅惩罚
  if (crowdingScore > 80 && rsiValue > 70) {
    penalty = 0.15; // 仅保留15%仓位
    status = 'crowded_warning';
 warning = ' 极度拥挤+超买: 拥挤度' + crowdingScore + ', RSI=' + rsiValue.toFixed(0) + '。共识陷阱风险极高，Kelly仓位惩罚至15%';
  } else if (crowdingScore > 80) {
    penalty = 0.35; // 高拥挤度但RSI未极端
    status = 'crowded_warning';
 warning = ' 高度拥挤: 拥挤度' + crowdingScore + '。"买预期卖事实"风险大，Kelly仓位惩罚至35%';
  } else if (crowdingScore > 60 && rsiValue > 65) {
    penalty = 0.6;
    status = 'crowded_warning';
 warning = ' 偏拥挤: 拥挤度' + crowdingScore + ', RSI=' + rsiValue.toFixed(0) + '。适度降低仓位';
  } else if (crowdingScore > 60) {
    penalty = 0.75;
  }

  // 3. 左侧逆向奖励机制 (Contrarian Bonus)
  // 极度悲观: crowding < 20 且 RSI < 30 → 预期差极大，给予流动性补偿
  if (crowdingScore < 20 && rsiValue < 30) {
    bonus = 1.3; // 130% 流动性补偿
    status = 'contrarian_opportunity';
    warning = '� 逆向机会: 拥挤度' + crowdingScore + '(极冷), RSI=' + rsiValue.toFixed(0) + '(超卖)。预期差=Reality-Expectation极大，左侧布局窗口';
  } else if (crowdingScore < 25 && rsiValue < 35) {
    bonus = 1.15;
    status = 'contrarian_opportunity';
    warning = '� 逆向信号: 情绪冰点+技术超卖，可逆向布局。流动性补偿+15%';
  } else if (crowdingScore < 30) {
    bonus = 1.05;
  }

  // 4. 综合调整
  kellyAdjusted = kellyBase * penalty * bonus;
  // 半Kelly上限25%
  kellyAdjusted = Math.min(kellyAdjusted, 0.25);
  kellyAdjusted = Math.max(kellyAdjusted, 0);

  // 5. 预期差评分 ΔP = Reality - Expectation
  // crowdingScore高 → Expectation高 → ΔP可能为负(利空定价不足)
  // crowdingScore低 → Expectation低 → ΔP可能为正(利好未定价)
  const expectationGap = 100 - crowdingScore; // 简化：越不拥挤，预期差越大

  return {
    kellyBase: Math.round(kellyBase * 10000) / 10000,
    kellyAdjusted: Math.round(kellyAdjusted * 10000) / 10000,
    penalty,
    bonus,
    status,
    warning,
    expectationGap,
    crowdingScore,
    rsiValue
  };
}

/**
 * 分析热点的第二层思维：从表面狂热挖掘"卖铲子"行业和被忽视的替代品
 * @returns {Array} 第二层分析结果
 */
function analyzeSecondOrderThinking() {
  const heatmap = _hotEventsData?.heatmap || [];
  const events = MACRO_GEO_EVENTS || [];
  const results = [];

  // 第二层思维映射表：表面热点 → 实际受益的"卖铲子"产业
  const SECOND_ORDER_MAP = {
    '人工智能': { shovels: ['算力基础设施', '数据中心电力', '光模块/PCB', '液冷散热'], contrarian: ['传统IT服务', '软件外包'] },
    'AI算力':   { shovels: ['铜缆/光纤', '电力设备', '变压器', '服务器代工'], contrarian: ['传统云计算'] },
    '大模型':   { shovels: ['数据标注', '算力芯片', '数据中心基建', '光通信'], contrarian: ['传统软件'] },
    '机器人':   { shovels: ['减速器/伺服', '传感器', '精密制造', 'CNC数控'], contrarian: ['传统自动化'] },
    '黄金':     { shovels: ['矿业/冶炼', '贵金属设备', '央行储备'], contrarian: ['美元资产', '实际利率标的'] },
    '有色金属': { shovels: ['矿山机械', '冶炼电力', '资源循环'], contrarian: ['替代材料'] },
    '半导体':   { shovels: ['半导体设备', 'EDA/IP', '光刻胶/特气', '封测'], contrarian: ['成熟制程替代'] },
    '军工':     { shovels: ['特种材料', '军工电子', '卫星通信'], contrarian: ['民用航空'] },
    '新能源':   { shovels: ['储能/逆变器', '电网改造', '充电桩设备'], contrarian: ['火电/煤炭'] },
    '港股科技': { shovels: ['A股AI纯正标的', '国产替代链'], contrarian: ['港股科技ETF'] },
  };

  // 拥挤的交易方向 (Howard Marks "最拥挤的交易")
  const CROWDED_TRADES = [];
  const CONTRARIAN_PICKS = [];

  heatmap.forEach(h => {
    const mapping = SECOND_ORDER_MAP[h.tag];
    const crowdingScore = h.temperature;
    const sentiment = h.sentiment || 0;

    // 找到关联的RSI数据
    let avgRSI = 50;
    const matchingFunds = [...(holdings || []), ...(watchlist || [])].filter(f => {
      const fName = fundName(f.code).toLowerCase();
      const fType = (fundType(f.code) || '').toLowerCase();
      return fName.includes(h.tag.slice(0, 2).toLowerCase()) || fType.includes(h.tag.slice(0, 2).toLowerCase());
    });
    if (matchingFunds.length > 0) {
      const rsis = matchingFunds.map(f => btResults[f.code]?.lastRSI || 50);
      avgRSI = rsis.reduce((a, b) => a + b, 0) / rsis.length;
    }

    // Kelly调整
    const kellyResult = calculateAdjustedKelly(0.55, 1.5, crowdingScore, avgRSI);

    if (crowdingScore >= 70) {
      // 高拥挤度 → 表面热点 + 挖掘卖铲子机会
      CROWDED_TRADES.push({
        tag: h.tag,
        temperature: crowdingScore,
        trend: h.trend,
        sentiment,
        avgRSI,
        kelly: kellyResult,
        secondOrderTargets: mapping?.shovels || [],
        expectationGap: 'Low', // 预期已高，实际存疑
        type: 'surface_hype',
        insight: '大众追捧' + h.tag + '(温度' + crowdingScore + ')，Expectation极高。真正的Alpha在上下游"卖铲子"行业：' + (mapping?.shovels?.join('、') || '待分析')
      });
    }

    if (crowdingScore <= 30 && (h.trend === 'down' || h.trend === 'stable')) {
      // 低温+下行趋势 → 逆向布局候选
      CONTRARIAN_PICKS.push({
        tag: h.tag,
        temperature: crowdingScore,
        trend: h.trend,
        sentiment,
        avgRSI,
        kelly: kellyResult,
        secondOrderTargets: mapping?.contrarian || [],
        expectationGap: 'High', // 预期极低，Reality可能改善
        type: 'contrarian',
        insight: h.tag + '处于情绪冰点(温度' + crowdingScore + ')，大众极度悲观。ΔP=Reality-Expectation可能为正——如果基本面未恶化，均值回归空间大'
      });
    }
  });

  // 构建最终结果
  return {
    crowdedTrades: CROWDED_TRADES.sort((a, b) => b.temperature - a.temperature),
    contrarianPicks: CONTRARIAN_PICKS.sort((a, b) => a.temperature - b.temperature),
    timestamp: new Date().toISOString()
  };
}

/**
 * Howard Marks风格的逆向投资压力测试
 * @returns {object} 压力测试结果
 */
function howardMarksStressTest() {
  const heatmap = _hotEventsData?.heatmap || [];
  const events = MACRO_GEO_EVENTS || [];

  // 1. 预期差体检：最拥挤的3个交易方向
  const mostCrowded = heatmap
    .filter(h => h.temperature >= 60)
    .sort((a, b) => b.temperature - a.temperature)
    .slice(0, 3)
    .map(h => ({
      name: h.tag,
      crowding: h.temperature,
      reason: getCrowdingReason(h),
      risk: h.temperature >= 80 ? '极高' : h.temperature >= 70 ? '高' : '较高'
    }));

  // 2. 第二层思维推演：被冷落的"卖铲子"行业
  const secondLayer = [];
  const hotTags = heatmap.filter(h => h.temperature >= 75);
  hotTags.forEach(h => {
    const shovels = getSecondOrderShovels(h.tag);
    if (shovels.length > 0) {
      secondLayer.push({
        hotTopic: h.tag,
        shovels,
        logic: getSecondOrderLogic(h.tag)
      });
    }
  });

  // 3. 深水区的明珠：情绪冰点但基本面修复
  const deepValuePicks = heatmap
    .filter(h => h.temperature <= 35 && (h.trend === 'down' || h.trend === 'stable'))
    .sort((a, b) => a.temperature - b.temperature)
    .slice(0, 3)
    .map(h => ({
      name: h.tag,
      temperature: h.temperature,
      sentiment: h.sentiment,
      reversionLogic: getMeanReversionLogic(h.tag),
      fundamentals: getFundamentalStatus(h.tag)
    }));

  return {
    mostCrowded,
    secondLayer,
    deepValuePicks,
    masterAdvice: generateMasterAdvice(mostCrowded, deepValuePicks)
  };
}

function getCrowdingReason(h) {
  const reasons = {
    '人工智能': 'AI概念全民追捧,ETF规模暴增,基金经理超配严重。当所有人都在谈论AI，Alpha已经消失——你买的是共识,不是预期差',
    'AI算力': '算力需求故事被充分定价,HBM/GPU概念股PE已透支2年业绩。市场在买"确定性"的最高点',
    '大模型': '大模型应用落地不及预期,但估值已Price-in最乐观情景。一旦增速不达预期,将面临Davis双杀',
    '机器人': '人形机器人尚在概念验证阶段,量产时间表不确定。温度82但实际商业化路径模糊,典型的"故事定价"',
    '黄金': '央行购金+避险需求支撑,但已连涨多月,短期交易拥挤。止盈资金随时可能涌出',
    '半导体': '国产替代逻辑持续但估值不低,需要业绩验证。板块内部分化加剧',
    '有色金属': '全球新基建故事好听,但价格已反映乐观预期。供给端扰动消退后可能回调',
    '军工': '事件驱动型板块,催化不可预测。军工赚钱效应差,大部分投资者"套在概念期"',
  };
  return reasons[h.tag] || '市场热度' + h.temperature + '，关注度高,预期充分,边际买入者减少';
}

function getSecondOrderShovels(tag) {
  const map = {
    '人工智能': ['电力设备(算力耗电)', '液冷/散热(数据中心降温)', '光模块(数据传输)', '铜缆线材(连接基建)'],
    'AI算力': ['变压器(电力配套)', '储能(削峰填谷)', 'PCB/覆铜板(芯片载板)', '工业气体(芯片制造)'],
    '大模型': ['数据标注(训练刚需)', 'IDC基建(算力承载)', '光通信(低延迟传输)', '电源设备(供电保障)'],
    '机器人': ['精密减速器(核心零件)', '伺服电机(驱动系统)', '力矩传感器(触觉反馈)', 'CNC加工(精密制造)'],
    '黄金': ['矿山开采设备', '贵金属冶炼', '金融科技(交易平台)'],
    '半导体': ['半导体设备(光刻/刻蚀)', 'EDA软件(设计必备)', '光刻胶/特种气体(耗材)', '先进封装(Chiplet)'],
  };
  return map[tag] || [];
}

function getSecondOrderLogic(tag) {
  const logics = {
    '人工智能': '所有人在买"AI应用"和"大模型"，但AI运转需要电力和散热。数据中心用电量2025-2028年将翻倍，电力设备和液冷是确定性更高的"卖铲子"机会',
    'AI算力': '算力芯片受关注，但芯片需要PCB承载、光模块传输、变压器供电。这些"配套基建"的预期差远大于芯片本身',
    '大模型': '大模型的训练需要海量标注数据和IDC基建, 这些苦活累活反而是确定性最高的收入',
    '机器人': '人形机器人量产的瓶颈不在AI，在精密减速器和伺服电机。日本谐波减速器供不应求，国产替代空间巨大',
    '黄金': '金价上涨最大受益者不是黄金ETF持有者，而是矿山企业——成本不变但售价上涨，利润弹性极大',
    '半导体': '半导体设备和材料是真正的"卖铲子"——无论哪家芯片公司胜出，都需要用设备和材料',
  };
  return logics[tag] || '';
}

function getMeanReversionLogic(tag) {
  const logics = {
    '光伏': '产能出清进入后半程，龙头企业市占率提升;全球光伏装机量仍在增长,估值处于历史分位<10%。出清结束=景气拐点',
    '锂电': '碳酸锂价格企稳,产业链库存周期接近底部;固态电池技术迭代催化。龙头估值已反映最悲观预期',
    '白酒': '库存去化6-8个季度后接近尾声;人口结构变化是长期问题,但短期估值已极度反映悲观;龙头品牌力不减',
    '新能源车': '渗透率增长斜率放缓但仍在提升;智能化(NOA)带来新增量;估值处于历史底部区间',
    '新能源': '政策扶持力度加大,碳达峰路径明确;板块估值触及3年低点,产能过剩问题逐步出清',
    '港股科技': '估值处于全球对比极低位;南向资金持续流入;AI应用落地将率先利好互联网巨头变现能力',
    '医药': '集采边际影响减弱,创新药出海进入兑现期;CXO订单恢复,医疗器械国产替代加速',
    '消费': '消费降级预期充分定价,以旧换新政策加力;收入预期改善(减税+降息)可能触发估值修复',
    '债券': '利率下行周期债券受益确定;但收益率已接近历史低位,需关注边际变化',
  };
  return logics[tag] || '该板块处于低关注度区域，如基本面出现积极信号，均值回归空间可观';
}

function getFundamentalStatus(tag) {
  const status = {
    '光伏': { reality: '产能出清50%+, 龙头利润率触底', trend: '修复中', score: 55 },
    '锂电': { reality: '碳酸锂价格企稳, 库存去化中', trend: '即将修复', score: 50 },
    '白酒': { reality: '库存高企但龙头品牌力在, 估值极低', trend: '磨底中', score: 45 },
    '新能源车': { reality: '渗透率35%+, 智能化升级', trend: '稳定', score: 55 },
    '新能源': { reality: '政策支持+出清推进', trend: '修复中', score: 50 },
    '港股科技': { reality: '业绩稳健但资金流出', trend: '底部震荡', score: 48 },
    '医药': { reality: '创新药出海+器械国产替代', trend: '结构性修复', score: 52 },
    '消费': { reality: '以旧换新+结构调整', trend: '弱修复', score: 48 },
  };
  return status[tag] || { reality: '需进一步分析', trend: '不确定', score: 50 };
}

function generateMasterAdvice(crowded, deepValue) {
 let advice = ' Howard Marks第二层思维忠告：\n';
  advice += '① 你赚的每一分钱都来自于"别人的错误"。当所有人都看好某个方向时，错误在你——因为你买的是共识，不是预期差。';
  if (crowded.length > 0) {
    advice += '\n② 当前最拥挤的交易：' + crowded.map(c => c.name).join('、') + '。这些方向的Expectation已极高，边际买入者越来越少，潜在卖出者越来越多。';
  }
  if (deepValue.length > 0) {
    advice += '\n③ 恐惧中的机会：' + deepValue.map(d => d.name).join('、') + '处于情绪冰点。如果Reality(基本面)并未恶化，ΔP=Reality-Expectation为正——这才是真正的Alpha来源。';
  }
  advice += '\n④ 记住：风险不是波动率，风险是永久性资本损失的概率。低波动不等于安全——在高位买入"好资产"同样危险。';
  return advice;
}

// 切换SOT面板
function toggleSOT() {
  // Now handled by engine detail tabs
  switchEngTab('sot');
  const body = document.getElementById('engine-detail-body');
  if(body.style.display === 'none') toggleEngineDetail();
}

// 渲染SOT面板
function renderSOTDashboard() {
  const container = document.getElementById('sot-container');
  const brief = document.getElementById('sot-brief');
  if (!container) return;

  const analysis = analyzeSecondOrderThinking();
  const stressTest = howardMarksStressTest();
  let html = '';

  // ===== 0. 行动摘要 =====
  const summaryAnalysis = analyzeSecondOrderThinking();
  const crowdCount = summaryAnalysis.crowdedTrades.length;
  const oppCount = summaryAnalysis.contrarianPicks.length;
  html += '<div style="background:var(--card);border-radius:10px;padding:12px 14px;margin-bottom:8px;box-shadow:var(--shadow)">';
 html += '<div style="font-size:13px;font-weight:800;margin-bottom:8px"> 一句话总结</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  html += '<div style="background:#fef2f2;border-radius:8px;padding:10px;text-align:center">';
  html += '<div style="font-size:24px;font-weight:800;color:#ef4444">' + crowdCount + '</div>';
 html += '<div style="font-size:11px;font-weight:600;color:#ef4444"> 过热方向</div>';
  html += '<div style="font-size:9px;color:#9ca3af;margin-top:2px">不要追高</div>';
  html += '</div>';
  html += '<div style="background:#ecfdf5;border-radius:8px;padding:10px;text-align:center">';
  html += '<div style="font-size:24px;font-weight:800;color:#22c55e">' + oppCount + '</div>';
 html += '<div style="font-size:11px;font-weight:600;color:#22c55e"> 逆向机会</div>';
  html += '<div style="font-size:9px;color:#9ca3af;margin-top:2px">可以布局</div>';
  html += '</div></div></div>';

  // ===== 1. 反拥挤Kelly仪表盘 =====
  html += '<div class="kelly-adj-card">';
 html += '<div class="kelly-adj-title"> 持仓Kelly仓位建议 <span style="font-size:9px;color:rgba(255,255,255,0.4)">根据拥挤度+RSI自动调整</span></div>';
 html += '<div class="kelly-formula" style="font-size:11px;color:rgba(255,255,255,0.5)">红=减仓 绿=可加 蓝=正常持有</div>';

  // 对用户持仓的基金计算调整后Kelly
  const kellyItems = [];
  (holdings || []).forEach(h => {
    const fType = fundType(h.code) || '';
    const heatEntry = (_hotEventsData?.heatmap || []).find(ht => {
      return fType.includes(ht.tag.slice(0, 2)) || ht.tag.includes(fType.slice(0, 2));
    });
    const crowdingScore = heatEntry ? heatEntry.temperature : 50;
    const rsiValue = btResults[h.code]?.lastRSI || 50;
    const baseKelly = btResults[h.code]?.finalKelly || 0.05;
    const kResult = calculateAdjustedKelly(
      btResults[h.code]?.winRate || 0.55,
      1.5, // 默认赔率
      crowdingScore,
      rsiValue
    );
    kellyItems.push({
      code: h.code,
      name: fundName(h.code),
      type: fType,
      crowdingScore,
      rsiValue,
      kellyBase: baseKelly,
      kellyAdjusted: kResult.kellyAdjusted,
      status: kResult.status,
      warning: kResult.warning,
      penalty: kResult.penalty,
      bonus: kResult.bonus
    });
  });

  if (kellyItems.length > 0) {
    html += '<div style="margin-top:8px">';
    kellyItems.forEach(k => {
      // 修正颜色：拥挤=红色警告，逆向=绿色机会
      const statusColor = k.status === 'crowded_warning' ? '#f87171' : k.status === 'contrarian_opportunity' ? '#4ade80' : 'rgba(255,255,255,0.7)';
 const statusIcon = k.status === 'crowded_warning' ? '' : k.status === 'contrarian_opportunity' ? '' : '';
 const actionLabel = k.status === 'crowded_warning' ? ' 减仓/不追' : k.status === 'contrarian_opportunity' ? ' 可布局' : ' 正常持有';
      const actionBg = k.status === 'crowded_warning' ? 'rgba(239,68,68,0.2)' : k.status === 'contrarian_opportunity' ? 'rgba(34,197,94,0.2)' : 'rgba(255,255,255,0.08)';
      const crowdCls = k.crowdingScore >= 80 ? 'extreme' : k.crowdingScore >= 60 ? 'high' : k.crowdingScore >= 40 ? 'mid' : k.crowdingScore >= 20 ? 'low' : 'desert';

      html += '<div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 12px;margin-bottom:8px;border-left:3px solid ' + statusColor + '">';
      // 第一行：基金名 + 操作建议
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
      html += '<span style="font-size:12px;font-weight:700;color:#e2e8f0">' + statusIcon + ' ' + k.name.slice(0, 10) + '</span>';
      html += '<span style="font-size:10px;font-weight:700;color:' + statusColor + ';background:' + actionBg + ';padding:2px 8px;border-radius:6px">' + actionLabel + '</span>';
      html += '</div>';
      // 第二行：Kelly仓位大字
      html += '<div style="display:flex;align-items:baseline;gap:6px;margin-bottom:6px">';
      html += '<span style="font-size:22px;font-weight:800;color:' + statusColor + ';font-variant-numeric:tabular-nums">' + (k.kellyAdjusted * 100).toFixed(1) + '%</span>';
      html += '<span style="font-size:10px;color:rgba(255,255,255,0.5)">建议仓位</span>';
      html += '<span style="font-size:10px;color:rgba(255,255,255,0.35);margin-left:auto">原始 ' + (k.kellyBase * 100).toFixed(1) + '%</span>';
      html += '</div>';
      // 拥挤度条
      html += '<div class="crowd-gauge">';
      html += '<span style="font-size:9px;color:rgba(255,255,255,0.5);min-width:36px">拥挤度</span>';
      html += '<div class="crowd-bar" style="background:rgba(255,255,255,0.08)"><div class="crowd-fill ' + crowdCls + '" style="width:' + k.crowdingScore + '%"></div></div>';
      html += '<span class="crowd-label" style="color:' + statusColor + ';font-size:12px">' + k.crowdingScore + '</span>';
      html += '</div>';
      // 指标行
      html += '<div style="display:flex;gap:10px;font-size:10px;color:rgba(255,255,255,0.55);margin-top:4px">';
      html += '<span>惩罚 ×' + k.penalty.toFixed(2) + '</span>';
      html += '<span>逆向奖励 ×' + k.bonus.toFixed(2) + '</span>';
      html += '<span>RSI ' + k.rsiValue.toFixed(0) + '</span>';
      html += '</div>';
      if (k.warning) {
        html += '<div style="font-size:10px;margin-top:5px;padding:4px 8px;border-radius:6px;background:' + actionBg + ';color:' + statusColor + ';line-height:1.5">' + k.warning + '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  } else {
    html += '<div style="text-align:center;font-size:10px;color:rgba(255,255,255,0.4);padding:12px 0">添加持仓后显示反拥挤Kelly分析</div>';
  }
  html += '</div>'; // end kelly-adj-card

  // ===== 2. 拥挤交易警告 (What NOT to buy) =====
  if (analysis.crowdedTrades.length > 0) {
    html += '<div class="sot-card warning">';
 html += '<div class="sot-card-title"> 拥挤交易预警 — 不要追高 <span class="sot-tag hot"> 共识过热</span></div>';
    html += '<div style="font-size:10px;color:var(--sub);margin-bottom:8px;padding:6px 8px;background:#fef2f2;border-radius:6px;line-height:1.5">以下方向市场共识度极高，"买预期卖事实"风险大。即使看好，也应等回调再介入，不宜追高。</div>';
    analysis.crowdedTrades.forEach(ct => {
      const tempColor = ct.temperature >= 85 ? '#dc2626' : '#ef4444';
      const tempBg = ct.temperature >= 85 ? '#fef2f2' : '#fff7ed';
      html += '<div style="padding:8px 0;border-bottom:1px solid var(--border)">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
      html += '<span style="font-size:13px;font-weight:700">' + ct.tag + '</span>';
      html += '<div style="display:flex;align-items:center;gap:6px">';
 html += '<span style="font-size:12px;font-weight:800;color:' + tempColor + '"> ' + ct.temperature + '°</span>';
      html += '<span style="font-size:9px;font-weight:700;color:white;background:' + tempColor + ';padding:2px 6px;border-radius:4px">' + (ct.temperature >= 85 ? '极度拥挤' : '偏拥挤') + '</span>';
      html += '</div></div>';
      html += '<div class="sot-event" style="font-size:11px;line-height:1.6">' + ct.insight + '</div>';
      // 第二层受益标的
      if (ct.secondOrderTargets.length > 0) {
        html += '<div style="margin-top:4px;padding:6px 8px;background:#eef2ff;border-radius:6px">';
 html += '<div style="font-size:10px;color:var(--primary);font-weight:700;margin-bottom:4px"> 不追热点，买"卖铲子"的：</div>';
        html += '<div class="sot-second-targets">';
        ct.secondOrderTargets.forEach(t => {
          html += '<span class="sot-target-chip">' + t + '</span>';
        });
        html += '</div></div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }

  // ===== 3. 逆向机会发掘 (Where to look) =====
  if (analysis.contrarianPicks.length > 0) {
    html += '<div class="sot-card opportunity">';
 html += '<div class="sot-card-title"> 逆向机会 — 可以布局 <span class="sot-tag cold"> 情绪冰点</span></div>';
    html += '<div style="font-size:10px;color:var(--sub);margin-bottom:8px;padding:6px 8px;background:#ecfdf5;border-radius:6px;line-height:1.5">以下方向市场极度悲观，预期已充分下调。如果基本面未恶化，预期差ΔP为正，适合逐步左侧布局。</div>';
    analysis.contrarianPicks.forEach(cp => {
      const fund = getFundamentalStatus(cp.tag);
      const gapValue = fund.score - cp.temperature;
      const gapLabel = gapValue > 30 ? '预期差极大' : gapValue > 15 ? '有预期差' : '预期差一般';
      const gapColor = gapValue > 30 ? '#16a34a' : gapValue > 15 ? '#22c55e' : '#64748b';
      html += '<div style="padding:8px 0;border-bottom:1px solid var(--border)">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
      html += '<span style="font-size:13px;font-weight:700">' + cp.tag + '</span>';
      html += '<div style="display:flex;align-items:center;gap:6px">';
 html += '<span style="font-size:12px;font-weight:800;color:#22c55e"> ' + cp.temperature + '°</span>';
      html += '<span style="font-size:9px;font-weight:700;color:white;background:' + gapColor + ';padding:2px 6px;border-radius:4px">' + gapLabel + '</span>';
      html += '</div></div>';
      html += '<div class="sot-event" style="font-size:11px;line-height:1.6">' + cp.insight + '</div>';
      // 预期差可视化 - 更清晰的对比
      html += '<div style="margin-top:6px;padding:6px 8px;background:var(--bg);border-radius:6px">';
      html += '<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">';
      html += '<span style="color:#ef4444;font-weight:600">市场预期(Expect): ' + cp.temperature + '</span>';
      html += '<span style="color:#22c55e;font-weight:600">基本面(Reality): ' + fund.score + '</span>';
      html += '</div>';
      html += '<div class="expectation-bar" style="margin:0">';
      html += '<div class="exp-track" style="height:10px;border-radius:5px">';
      html += '<div class="exp-fill-expect" style="width:' + cp.temperature + '%"></div>';
      html += '<div class="exp-fill-reality" style="width:' + fund.score + '%"></div>';
      html += '<div class="exp-marker" style="left:' + cp.temperature + '%"></div>';
      html += '</div>';
      html += '</div>';
      html += '<div style="text-align:center;font-size:10px;color:' + gapColor + ';font-weight:700;margin-top:3px">ΔP = +' + gapValue + ' (' + gapLabel + ')</div>';
      html += '</div>';
      html += '<div style="font-size:10px;color:var(--sub);margin-top:3px">Reality: ' + fund.reality + ' | 趋势: ' + fund.trend + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // ===== 4. Howard Marks 压力测试 =====
  html += '<div class="contrarian-card">';
 html += '<div class="contrarian-title"> Howard Marks 压力测试 <span style="font-size:9px;color:var(--sub);font-weight:400">"The most important thing is not to buy at the right price, but to not buy at the wrong price."</span></div>';

  // 4.1 最拥挤交易
  if (stressTest.mostCrowded.length > 0) {
    html += '<div class="contrarian-section">';
    html += '<div class="contrarian-section-title">� 预期差体检 — 最拥挤的交易方向</div>';
    stressTest.mostCrowded.forEach(mc => {
      html += '<div class="contrarian-item">';
      html += '<div class="contrarian-item-name">' + mc.name + ' <span class="contrarian-badge danger">拥挤度 ' + mc.crowding + ' · 风险' + mc.risk + '</span></div>';
      html += '<div class="contrarian-item-desc">' + mc.reason + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // 4.2 第二层思维推演
  if (stressTest.secondLayer.length > 0) {
    html += '<div class="contrarian-section">';
 html += '<div class="contrarian-section-title"> 第二层思维 — 被冷落的"卖铲子"行业</div>';
    stressTest.secondLayer.forEach(sl => {
      html += '<div class="contrarian-item">';
      html += '<div class="contrarian-item-name">表面: ' + sl.hotTopic + ' → 实际: <span style="color:var(--primary)">' + sl.shovels.join('、') + '</span></div>';
      html += '<div class="contrarian-item-desc">' + sl.logic + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // 4.3 深水区明珠
  if (stressTest.deepValuePicks.length > 0) {
    html += '<div class="contrarian-section">';
    html += '<div class="contrarian-section-title">� 深水区的明珠 — 情绪冰点 × 基本面修复</div>';
    stressTest.deepValuePicks.forEach(dv => {
      const fund = dv.fundamentals;
      html += '<div class="contrarian-item">';
      html += '<div class="contrarian-item-name">' + dv.name + ' <span class="contrarian-badge safe">温度' + dv.temperature + ' · ' + fund.trend + '</span></div>';
      html += '<div class="contrarian-item-desc">' + dv.reversionLogic + '</div>';
      // Reality vs Expectation bar
      html += '<div class="expectation-bar" style="margin-top:4px">';
      html += '<span class="exp-label" style="font-size:8px">预期</span>';
      html += '<div class="exp-track">';
      html += '<div class="exp-fill-expect" style="width:' + dv.temperature + '%"></div>';
      html += '<div class="exp-fill-reality" style="width:' + fund.score + '%"></div>';
      html += '</div>';
      html += '<span class="exp-label" style="font-size:8px;color:var(--green)">现实</span>';
      html += '</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // 4.4 大师忠告
  html += '<div class="sot-insight">' + stressTest.masterAdvice.replace(/\n/g, '<br>') + '</div>';
  html += '</div>'; // end contrarian-card

  container.innerHTML = html;

  // 更新Brief
  if (brief) {
    const totalWarnings = analysis.crowdedTrades.length;
    const totalOpps = analysis.contrarianPicks.length;
    if (totalWarnings > 0 || totalOpps > 0) {
      brief.innerHTML = '<span style="color:#f87171">' + totalWarnings + '拥挤</span> <span style="color:#4ade80">' + totalOpps + '逆向</span>';
    } else {
      brief.textContent = '均衡';
    }
  }
}

// 渲染SOT Brief (不展开面板时的简要状态)
function renderSOTBrief() {
  const brief = document.getElementById('sot-brief');
  if (!brief) return;
  if (!_hotEventsLoaded) { brief.textContent = 'SOT:加载中'; return; }
  const heatmap = _hotEventsData?.heatmap || [];
  const crowded = heatmap.filter(h => h.temperature >= 70).length;
  const cold = heatmap.filter(h => h.temperature <= 30 && (h.trend === 'down' || h.trend === 'stable')).length;
  if (crowded > 0 || cold > 0) {
    brief.innerHTML = 'SOT:<span style="color:#f87171">' + crowded + '拥挤</span> <span style="color:#4ade80">' + cold + '逆向</span>';
  } else {
    brief.textContent = 'SOT:均衡';
  }
}

// ==================== 基金持仓分析引擎 (Fund Holdings Analysis Engine) ====================
// 股票代码 → 行业板块映射 (覆盖A股/港股常见重仓股)
const STOCK_SECTOR_DB = {
  // === 白酒/消费 ===
  '600519': '白酒', '000858': '白酒', '600809': '白酒', '000568': '白酒',
  '002304': '白酒', '603369': '白酒', '000799': '白酒', '600779': '白酒',
  '000596': '白酒', '600559': '白酒', '600132': '白酒',
  // === 食品饮料/消费 ===
  '600887': '消费', '000895': '消费', '002714': '消费', '603288': '消费',
  '600690': '消费', '000568': '消费', '002557': '消费', '300146': '消费',
  '601888': '消费', '000651': '消费', '000333': '消费', '002032': '消费',
  // === 医药/医疗 ===
  '300760': '医药', '600276': '医药', '300122': '医药', '300347': '医药',
  '000538': '医药', '600196': '医药', '300015': '医药', '002007': '医药',
  '300003': '医药', '600085': '医药', '300529': '医药', '688180': '医药',
  '002001': '医药', '300759': '医药', '600436': '医药', '300142': '医药',
  // === 银行/金融 ===
  '601398': '金融', '601939': '金融', '601288': '金融', '600036': '金融',
  '601166': '金融', '000001': '金融', '601328': '金融', '601818': '金融',
  '600000': '金融', '601988': '金融', '600016': '金融', '601229': '金融',
  // === 保险/金融 ===
  '601318': '金融', '601628': '金融', '601601': '金融', '600030': '金融',
  '601688': '金融', '601211': '金融', '600837': '金融', '601881': '金融',
  // === 券商/金融 ===
  '600030': '金融', '601688': '金融', '600999': '金融', '601066': '金融',
  '601377': '金融', '601236': '金融', '600958': '金融', '300059': '金融',
  // === 半导体/芯片 ===
  '688981': '半导体', '603501': '半导体', '002371': '半导体', '300661': '半导体',
  '688012': '半导体', '603986': '半导体', '002049': '半导体', '688008': '半导体',
  '300782': '半导体', '688396': '半导体', '002185': '半导体', '300223': '半导体',
  '688062': '半导体', '688036': '半导体', '603160': '半导体', '300327': '半导体',
  // === AI/科技/软件 ===
  '002230': '科技', '300496': '科技', '688111': '科技', '300474': '科技',
  '688561': '科技', '300033': '科技', '300253': '科技', '300124': '科技',
  '002415': '科技', '000977': '科技', '300999': '科技', '688256': '科技',
  '002236': '科技', '688169': '科技', '300418': '科技', '002405': '科技',
  '600570': '科技', '002241': '科技', '600588': '科技', '002410': '科技',
  // === 新能源/光伏/电池 ===
  '300750': '新能源', '600438': '新能源', '002459': '新能源', '601012': '新能源',
  '002594': '新能源', '300274': '新能源', '601877': '新能源', '688599': '新能源',
  '300763': '新能源', '601615': '新能源', '002129': '新能源', '600905': '新能源',
  '688303': '新能源', '688390': '新能源', '601615': '新能源', '300037': '新能源',
  // === 军工/国防 ===
  '600893': '军工', '000768': '军工', '600760': '军工', '601989': '军工',
  '600118': '军工', '002179': '军工', '600150': '军工', '000738': '军工',
  '601698': '军工', '002013': '军工', '600372': '军工', '002414': '军工',
  '600862': '军工', '002025': '军工', '600316': '军工', '000687': '军工',
  // === 石油/能源/化工 ===
  '601857': '能源', '600028': '能源', '601808': '能源', '600346': '能源',
  '600339': '能源', '002221': '能源', '000703': '能源', '600688': '能源',
  '000983': '能源', '600803': '能源', '601011': '能源', '000059': '能源',
  '002493': '化工', '600309': '化工', '600426': '化工', '000792': '化工',
  '002601': '化工', '600989': '化工', '002064': '化工', '600352': '化工',
  // === 有色金属/资源 ===
  '601899': '有色金属', '603993': '有色金属', '000630': '有色金属', '601600': '有色金属',
  '002460': '有色金属', '601212': '有色金属', '000878': '有色金属', '601168': '有色金属',
  '002466': '有色金属', '600362': '有色金属', '600547': '有色金属', '600489': '有色金属',
  '002756': '有色金属', '603799': '有色金属', '002203': '有色金属', '600459': '有色金属',
  // === 黄金/贵金属 ===
  '600489': '黄金', '600547': '黄金', '002155': '黄金', '600988': '黄金',
  '000975': '黄金', '002237': '黄金', '601899': '黄金', '600311': '黄金',
  // === 钢铁/基建 ===
  '600019': '基建', '000898': '基建', '600010': '基建', '000709': '基建',
  '601390': '基建', '601668': '基建', '601186': '基建', '601800': '基建',
  '600068': '基建', '601618': '基建', '600585': '基建', '600170': '基建',
  // === 房地产 ===
  '001979': '地产', '000002': '地产', '600048': '地产', '600383': '地产',
  '000069': '地产', '600340': '地产', '000656': '地产', '601155': '地产',
  // === 电力/公用事业 ===
  '600900': '电力', '600886': '电力', '003816': '电力', '601985': '电力',
  '600023': '电力', '000027': '电力', '601991': '电力', '600795': '电力',
  // === 交通/航空/物流 ===
  '601111': '航空', '600115': '航空', '600029': '航空', '002928': '航空',
  '601006': '交通', '600009': '交通', '600897': '交通', '000089': '交通',
  // === 汽车 ===
  '600104': '汽车', '000625': '汽车', '601238': '汽车', '002594': '汽车',
  '601127': '汽车', '600741': '汽车', '000800': '汽车', '002920': '汽车',
  // === 传媒/娱乐 ===
  '002027': '传媒', '300413': '传媒', '603444': '传媒', '002607': '传媒',
  '300251': '传媒', '300002': '传媒', '002555': '传媒', '603019': '传媒',
  // === 通信/5G ===
  '600941': '通信', '000063': '通信', '002281': '通信', '600050': '通信',
  '300502': '通信', '603236': '通信', '002396': '通信', '600522': '通信',
  // === 港股常见重仓 ===
  '00700': '港股互联网', '09988': '港股互联网', '09987': '消费', '09999': '港股互联网',
  '09618': '港股互联网', '03690': '港股互联网', '01024': '港股互联网', '02015': '新能源',
  '01810': '消费电子', '06618': '医药', '02269': '医药', '01177': '医药',
  '00883': '能源', '00386': '能源', '02688': '新能源', '01211': '新能源',
  '00388': '金融', '03988': '金融', '01398': '金融', '02318': '金融',
  '00941': '通信', '00728': '通信', '01088': '能源', '02899': '有色金属',
  '00175': '汽车', '09626': '港股互联网', '02382': '科技', '00020': '消费',
  '00027': '消费', '01928': '消费', '06862': '医药', '02196': '医药',
  '06160': '消费', '09868': '新能源', '09888': '消费',
  '00002': '电力', '02007': '地产', '01109': '地产', '00960': '有色金属',
};

// 基金名称/类型 → 行业板块暴露 (用于ETF联接/指数基金的板块推断)
// 当无法获取持仓明细时，通过基金名称关键词推断行业分布
const FUND_SECTOR_KEYWORD_MAP = [
  // 精确匹配优先（越长的关键词越先匹配）
  { keywords: ['中证油气产业','油气产业'], sectors: {'能源':0.85,'化工':0.15} },
  { keywords: ['原油','石油'], sectors: {'能源':0.85,'化工':0.15} },
  { keywords: ['油气','天然气'], sectors: {'能源':0.80,'化工':0.20} },
  { keywords: ['黄金','Gold'], sectors: {'黄金':0.95,'有色金属':0.05} },
  { keywords: ['白银'], sectors: {'有色金属':0.80,'黄金':0.20} },
  { keywords: ['有色金属','铜铝','资源'], sectors: {'有色金属':0.85,'能源':0.10,'基建':0.05} },
  { keywords: ['军工','国防','军事'], sectors: {'军工':0.90,'科技':0.10} },
  { keywords: ['半导体','芯片','集成电路'], sectors: {'半导体':0.85,'科技':0.15} },
  { keywords: ['人工智能','AI','机器人','算力','大数据','云计算'], sectors: {'科技':0.85,'半导体':0.15} },
  { keywords: ['科技龙头','科技100','科技创新','硬科技','信创'], sectors: {'科技':0.60,'半导体':0.25,'通信':0.15} },
  { keywords: ['新能源车','新能源汽车','电动车','智能汽车'], sectors: {'新能源':0.60,'汽车':0.30,'半导体':0.10} },
  { keywords: ['新能源','光伏','风电','碳中和','能源革新'], sectors: {'新能源':0.80,'电力':0.15,'科技':0.05} },
  { keywords: ['白酒','酒'], sectors: {'白酒':0.90,'消费':0.10} },
  { keywords: ['食品饮料','消费'], sectors: {'消费':0.85,'白酒':0.15} },
  { keywords: ['医药','医疗','生物','创新药','医药100','中药'], sectors: {'医药':0.90,'科技':0.10} },
  { keywords: ['红利','高股息','低波动','价值'], sectors: {'金融':0.30,'能源':0.20,'电力':0.20,'消费':0.15,'基建':0.15} },
  { keywords: ['证券','券商'], sectors: {'金融':0.95,'科技':0.05} },
  { keywords: ['银行','金融'], sectors: {'金融':0.90,'地产':0.10} },
  { keywords: ['沪深300','中证500','A500','上证50'], sectors: {'金融':0.25,'消费':0.20,'科技':0.15,'新能源':0.10,'医药':0.10,'能源':0.08,'基建':0.07,'通信':0.05} },
  { keywords: ['创业板','科创'], sectors: {'科技':0.30,'新能源':0.25,'医药':0.20,'半导体':0.15,'消费':0.10} },
  { keywords: ['中小盘','中证1000'], sectors: {'科技':0.25,'消费':0.20,'医药':0.15,'新能源':0.15,'半导体':0.10,'化工':0.08,'有色金属':0.07} },
  { keywords: ['蓝筹','大盘'], sectors: {'金融':0.25,'消费':0.20,'能源':0.15,'科技':0.15,'医药':0.10,'基建':0.08,'通信':0.07} },
  { keywords: ['通信','5G'], sectors: {'通信':0.80,'科技':0.20} },
  { keywords: ['地产','房地产','REITs'], sectors: {'地产':0.85,'基建':0.15} },
  { keywords: ['基建','钢铁','建筑','一带一路'], sectors: {'基建':0.80,'有色金属':0.10,'能源':0.10} },
  { keywords: ['电力','公用事业'], sectors: {'电力':0.85,'新能源':0.15} },
  { keywords: ['传媒','影视','游戏','文化'], sectors: {'传媒':0.80,'科技':0.20} },
  { keywords: ['汽车','车'], sectors: {'汽车':0.75,'新能源':0.15,'科技':0.10} },
  { keywords: ['航空','航运','交通','物流'], sectors: {'航空':0.60,'交通':0.40} },
  { keywords: ['恒生科技','港股科技','港股互联网'], sectors: {'港股互联网':0.90,'科技':0.10} },
  { keywords: ['港股','恒生','H股'], sectors: {'港股互联网':0.30,'金融':0.25,'消费':0.15,'能源':0.10,'医药':0.08,'通信':0.07,'科技':0.05} },
  { keywords: ['纯债','债券','利率','信用'], sectors: {'债券':0.95,'金融':0.05} },
  { keywords: ['货币','现金管理'], sectors: {'现金':1.0} },
];

// 持仓数据缓存
let _fundHoldingsCache = {}; // { code: { stockCodes:[], assetAlloc:{}, sectorExposure:{}, fetchTime:number, raw:{} } }
let _holdingsFetchQueue = [];
let _holdingsFetching = false;

// 通过 eastmoney pingzhongdata 获取基金持仓数据
function fetchFundHoldings(code){
  return new Promise((resolve) => {
    if(_fundHoldingsCache[code] && (Date.now() - _fundHoldingsCache[code].fetchTime < 3600000)){
      return resolve(_fundHoldingsCache[code]); // 1小时缓存
    }
    // 备份当前全局变量(防止污染)
    const backupVars = {
      fS_name: window.fS_name, fS_code: window.fS_code,
      stockCodesNew: window.stockCodesNew, zqCodesNew: window.zqCodesNew,
      Data_assetAllocation: window.Data_assetAllocation,
      Data_currentFundManager: window.Data_currentFundManager,
      Data_performanceEvaluation: window.Data_performanceEvaluation,
      Data_holderStructure: window.Data_holderStructure,
      syl_1n: window.syl_1n, syl_6y: window.syl_6y, syl_3y: window.syl_3y, syl_1y: window.syl_1y,
    };
    const script = document.createElement('script');
    script.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${Date.now()}`;
    script.onload = () => {
      try {
        // 提取持仓股票代码 (stockCodesNew格式: "market.code")
        const rawStockCodes = window.stockCodesNew || [];
        const stockCodes = rawStockCodes.map(sc => {
          const parts = sc.split('.');
          return parts.length === 2 ? parts[1] : sc;
        });
        // 提取资产配置
        const assetAlloc = window.Data_assetAllocation || null;
        // 提取业绩评价
        const perfEval = window.Data_performanceEvaluation || null;
        // 提取基金经理
        const fundManager = window.Data_currentFundManager || null;
        // 提取收益率
        const returns = {
          y1: parseFloat(window.syl_1n) || 0,
          m6: parseFloat(window.syl_6y) || 0,
          m3: parseFloat(window.syl_3y) || 0,
          m1: parseFloat(window.syl_1y) || 0,
        };
        // 计算行业板块暴露
        const sectorExposure = _computeSectorFromHoldings(code, stockCodes);
        
        const result = {
          code,
          name: window.fS_name || fundName(code),
          stockCodes,
          stockCount: stockCodes.length,
          assetAlloc,
          perfEval,
          fundManager,
          returns,
          sectorExposure,
          fetchTime: Date.now(),
          source: stockCodes.length > 0 ? 'holdings' : 'inferred',
        };
        _fundHoldingsCache[code] = result;
        resolve(result);
      } catch(err) {
        console.warn(`持仓解析失败[${code}]:`, err);
        // 退回基于名称的推断
        const sectorExposure = _inferSectorFromName(code);
        const result = { code, stockCodes: [], sectorExposure, fetchTime: Date.now(), source: 'name-fallback' };
        _fundHoldingsCache[code] = result;
        resolve(result);
      } finally {
        // 还原全局变量
        Object.keys(backupVars).forEach(k => { window[k] = backupVars[k]; });
        script.remove();
      }
    };
    script.onerror = () => {
      console.warn(`持仓数据加载失败[${code}]`);
      const sectorExposure = _inferSectorFromName(code);
      const result = { code, stockCodes: [], sectorExposure, fetchTime: Date.now(), source: 'name-fallback' };
      _fundHoldingsCache[code] = result;
      script.remove();
      resolve(result);
    };
    document.head.appendChild(script);
  });
}

// 从持仓股票代码计算行业板块暴露
function _computeSectorFromHoldings(code, stockCodes){
  if(!stockCodes || stockCodes.length === 0){
    return _inferSectorFromName(code);
  }
  const sectorWeights = {};
  let matched = 0;
  stockCodes.forEach((sc, idx) => {
    // 去掉前导零匹配港股 (如 00700 → 00700)
    const sector = STOCK_SECTOR_DB[sc] || STOCK_SECTOR_DB[sc.replace(/^0+/, '')] || null;
    if(sector){
      // 前10持仓权重递减: 第1位约15%, 第10位约5%
      const weight = Math.max(0.05, 0.15 - idx * 0.01);
      sectorWeights[sector] = (sectorWeights[sector] || 0) + weight;
      matched++;
    }
  });
  if(matched === 0) return _inferSectorFromName(code);
  // 归一化
  const total = Object.values(sectorWeights).reduce((a,b) => a+b, 0);
  const normalized = {};
  Object.keys(sectorWeights).forEach(s => { normalized[s] = parseFloat((sectorWeights[s] / total).toFixed(3)); });
  // 合并名称推断以补充覆盖率
  const nameInferred = _inferSectorFromName(code);
  if(nameInferred && Object.keys(nameInferred).length > 0){
    Object.keys(nameInferred).forEach(s => {
      if(!normalized[s]) normalized[s] = nameInferred[s] * 0.3; // 名称推断的权重降为30%
    });
    // 重新归一化
    const t2 = Object.values(normalized).reduce((a,b) => a+b, 0);
    Object.keys(normalized).forEach(s => { normalized[s] = parseFloat((normalized[s] / t2).toFixed(3)); });
  }
  return normalized;
}

// 从基金名称/类型推断行业板块暴露
function _inferSectorFromName(code){
  const name = (fundName(code) || '').toLowerCase();
  const fType = (fundType(code) || '').toLowerCase();
  const text = name + ' ' + fType;
  for(const rule of FUND_SECTOR_KEYWORD_MAP){
    if(rule.keywords.some(kw => text.includes(kw.toLowerCase()))){
      return { ...rule.sectors };
    }
  }
  return {}; // 无法推断
}

// 获取基金的行业板块暴露（优先从缓存读取，否则基于名称推断）
function getFundSectorExposure(code){
  const cached = _fundHoldingsCache[code];
  if(cached && cached.sectorExposure && Object.keys(cached.sectorExposure).length > 0){
    return cached.sectorExposure;
  }
  return _inferSectorFromName(code);
}

// 批量加载所有持仓和关注基金的持仓数据(顺序加载防止全局变量冲突)
async function loadAllFundHoldings(){
  const allCodes = [...new Set([
    ...holdings.map(h=>h.code),
    ...watchlist.map(w=>w.code),
    ...MODEL_PORTFOLIO.core.funds.map(f=>f.code),
    ...MODEL_PORTFOLIO.satellite.funds.map(f=>f.code),
  ])];
  console.log(`[持仓分析] 开始加载 ${allCodes.length} 只基金的持仓数据...`);
  for(const code of allCodes){
    await fetchFundHoldings(code);
  }
  console.log('[持仓分析] 全部持仓数据加载完成', Object.keys(_fundHoldingsCache).length, '只');
}

// 格式化板块暴露为可读字符串
function formatSectorExposure(sectorExposure){
  if(!sectorExposure || Object.keys(sectorExposure).length === 0) return '暂无数据';
  return Object.entries(sectorExposure)
    .sort((a,b) => b[1] - a[1])
    .filter(([,w]) => w >= 0.05) // 只显示>=5%的板块
    .map(([s, w]) => `${s}${(w*100).toFixed(0)}%`)
    .join(' | ');
}

// 分析宏观地缘事件对特定基金的影响 (基于持仓行业分布)
function getMacroGeoAnalysis(){
  const events = MACRO_GEO_EVENTS;
  const outlook = MACRO_3M_OUTLOOK;
  // 计算综合影响分
  let totalImpact = 0;
  let totalWeight = 0;
  const activeEvents = events.filter(e => e.confidence >= 0.5);
  activeEvents.forEach(e => {
    totalImpact += e.impact * e.confidence;
    totalWeight += e.confidence;
  });
  const avgImpact = totalWeight > 0 ? totalImpact / totalWeight : 0;
  const normalizedScore = Math.round(Math.max(0, Math.min(100, 50 + avgImpact)));
  
  // 按类别分组+影响力排序，确保各类别均有展示
  // 分类: geopolitics(地缘) / technology(科技) / monetary(货币) / policy(政策) / commodity(商品) / market(市场)
  const catGroups = {};
  activeEvents.forEach(e => {
    if(!catGroups[e.category]) catGroups[e.category] = [];
    catGroups[e.category].push(e);
  });
  // 每个类别内按影响力排序
  Object.values(catGroups).forEach(arr => arr.sort((a,b) => Math.abs(b.impact)*b.confidence - Math.abs(a.impact)*a.confidence));
  // 轮询各类别取事件，保证多样性 (优先级: commodity > geopolitics > technology > monetary > policy > market)
  const catPriority = ['commodity','geopolitics','technology','monetary','policy','market'];
  const sorted = [];
  const catIdx = {};
  catPriority.forEach(c => catIdx[c] = 0);
  for(let round = 0; sorted.length < activeEvents.length; round++){
    let added = false;
    for(const cat of catPriority){
      const arr = catGroups[cat];
      if(arr && catIdx[cat] < arr.length){
        sorted.push(arr[catIdx[cat]++]);
        added = true;
      }
    }
    if(!added) break;
  }
  
  // 板块同义词映射: 事件板块名 → 可能匹配的基金板块名(双向扩展)
  const SECTOR_SYNONYMS = {
    '能源':['原油','油气','石油','天然气','煤炭','中证油气'],
    '原油':['能源','油气','石油','天然气','大宗商品'],
    '油气':['能源','原油','石油','天然气'],
    '有色金属':['铜铝','铜','铝','资源','大宗商品','矿业','金属','锌','镍','稀土'],
    '铜铝':['有色金属','资源','金属'],
    '大宗商品':['有色金属','能源','原油','油气','黄金','白银','铜铝'],
    '黄金':['贵金属','避险','gold'],
    '贵金属':['黄金','白银'],
    '白银':['贵金属','有色金属'],
    '科技':['AI/科技','人工智能','信息技术','计算机'],
    'AI/科技':['科技','人工智能','算力','AIGC'],
    'AI':['AI/科技','科技','人工智能','算力'],
    '半导体':['芯片','集成电路','科技'],
    '芯片':['半导体','集成电路'],
    '新能源':['光伏','风电','锂电','储能','碳中和'],
    '光伏':['新能源','太阳能'],
    '锂电':['新能源','电池','储能'],
    '消费':['食品饮料','白酒','家电','内需'],
    '食品饮料':['消费','白酒'],
    '白酒':['消费','食品饮料'],
    '医药':['创新药','生物医药','医疗器械','CXO'],
    '金融':['银行','券商','保险','非银金融'],
    '银行':['金融'],
    '券商':['金融','非银金融'],
    '军工':['国防','航天','航空'],
    '国防':['军工','航天','航空'],
    '债券':['固收','纯债','利率'],
    '港股科技':['港股互联网','恒生科技','QDII科技'],
    '港股互联网':['港股科技','恒生科技'],
    '红利':['高股息','低波动'],
    // 美股归因相关
    '新能源车':['新能源','汽车','锂电','电池','智能驾驶'],
    '消费电子':['科技','苹果链','果链','电子'],
    'QDII':['美股','海外','港股','QDII科技'],
    'QDII科技':['科技','港股科技','QDII','美股'],
    '算力':['AI/科技','AI','半导体','服务器','数据中心'],
  };
  // 排除列表: 虽然有子串关系但语义不同的板块对 (防止 '新能源'↔'能源' 误匹配)
  const SECTOR_EXCLUSIONS = [
    ['新能源','能源'], ['新能源车','能源'], ['新能源','原油'], ['新能源车','原油'],
    ['新能源','油气'], ['新能源车','油气'], ['新能源','石油'], ['新能源车','石油'],
    ['新能源','天然气'], ['新能源车','天然气'], ['新能源','煤炭'], ['新能源车','煤炭'],
  ];
  function _isExcluded(a, b){
    const al = a.toLowerCase(), bl = b.toLowerCase();
    return SECTOR_EXCLUSIONS.some(([x,y]) => (al===x.toLowerCase()&&bl===y.toLowerCase()) || (al===y.toLowerCase()&&bl===x.toLowerCase()));
  }
  // 判断两个板块名是否语义相关
  function _sectorsRelated(secA, secB){
    if(_isExcluded(secA, secB)) return false;
    const a = secA.toLowerCase(), b = secB.toLowerCase();
    if(a.includes(b) || b.includes(a)) return true;
    // 同义词扩展
    const synsA = SECTOR_SYNONYMS[secA] || SECTOR_SYNONYMS[a] || [];
    const synsB = SECTOR_SYNONYMS[secB] || SECTOR_SYNONYMS[b] || [];
    if(synsA.some(s => !_isExcluded(s,secB) && (s.toLowerCase() === b || b.includes(s.toLowerCase())))) return true;
    if(synsB.some(s => !_isExcluded(s,secA) && (s.toLowerCase() === a || a.includes(s.toLowerCase())))) return true;
    return false;
  }

  // 对每只持仓基金计算事件影响（基于持仓行业分布，而非仅名称匹配）
  const fundImpacts = {};
  const allCodes = [...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)];
  console.log(`[GeoAnalysis] 分析 ${events.length} 个事件 × ${new Set(allCodes).size} 只基金`);
  [...new Set(allCodes)].forEach(code => {
    // 获取该基金的行业板块暴露
    const sectorExposure = getFundSectorExposure(code);
    const hasSectorData = sectorExposure && Object.keys(sectorExposure).length > 0;
    
    // 同时保留名称匹配作为补充
    const name = fundName(code).toLowerCase();
    const fType = (fundType(code)||'').toLowerCase();
    
    let fundScore = 0;
    const matchedEvents = [];
    
    events.forEach(e => {
      let posScore = 0, negScore = 0, kwScore = 0;
      
      if(hasSectorData){
        // === 基于持仓行业分布的精确匹配 + 同义词扩展 ===
        // 计算与利好板块的重叠度
        (e.sectors.positive||[]).forEach(sec => {
          Object.entries(sectorExposure).forEach(([fundSec, weight]) => {
            if(_sectorsRelated(sec, fundSec)){
              posScore += weight; // 按实际持仓权重计算影响
            }
          });
        });
        // 计算与利空板块的重叠度
        (e.sectors.negative||[]).forEach(sec => {
          Object.entries(sectorExposure).forEach(([fundSec, weight]) => {
            if(_sectorsRelated(sec, fundSec)){
              negScore += weight;
            }
          });
        });
      }
      
      // 名称关键词匹配作为补充（仅在基金名称/类型直接包含关键词时才匹配，防止泛化）
      const kwMatchList = (e.fundKeywords||[]).filter(kw => {
        const kwLow = kw.toLowerCase();
        // 关键词必须≥2字符，且精确出现在基金名称或类型中
        return kwLow.length >= 2 && (name.includes(kwLow) || fType.includes(kwLow));
      });
      // 基金名称直接包含事件利好/利空板块名（精确匹配，不用_sectorsRelated泛化）
      const posDirectName = (e.sectors.positive||[]).some(sec => name.includes(sec.toLowerCase()) || fType === sec.toLowerCase());
      const negDirectName = (e.sectors.negative||[]).some(sec => name.includes(sec.toLowerCase()) || fType === sec.toLowerCase());
      if(kwMatchList.length >= 2) kwScore = 0.4;
      else if(kwMatchList.length === 1) kwScore = 0.25;
      if(posDirectName && posScore === 0) posScore = 0.3;
      if(negDirectName && negScore === 0) negScore = 0.3;
      
 // 基于持仓数据匹配时：要求板块重叠度≥0.15(即至少15%持仓权重在相关板块)
      // 避免宽基基金因少量科技持仓就被匹配到所有科技事件
      const sectorMatchStrong = (posScore >= 0.15 || negScore >= 0.15);
      const nameMatchStrong = (posDirectName || negDirectName || kwMatchList.length > 0);
      const totalMatch = posScore + negScore + kwScore;
      if(sectorMatchStrong || nameMatchStrong){
        let direction;
        if(posScore > negScore){
          direction = 'positive';
          // 使用持仓权重而非固定系数，板块暴露越大影响越强
          const effectiveWeight = hasSectorData ? Math.min(0.35, posScore * 0.5) : 0.15;
          fundScore += Math.abs(e.impact) * e.confidence * effectiveWeight;
        } else if(negScore > posScore){
          direction = 'negative';
          const effectiveWeight = hasSectorData ? Math.min(0.35, negScore * 0.5) : 0.15;
          fundScore -= Math.abs(e.impact) * e.confidence * effectiveWeight;
        } else if(kwScore > 0 || posDirectName || negDirectName){
          direction = e.impact > 0 ? 'positive' : 'negative';
          fundScore += e.impact * e.confidence * 0.15;
        } else {
          direction = 'neutral';
        }
        
        const matchSource = hasSectorData ? 
          (posScore > 0 || negScore > 0 ? '持仓分析' : '名称匹配') : '名称匹配';
        
        matchedEvents.push({
          id: e.id, name: e.name, icon: e.icon,
          impact: direction, eventImpact: e.impact, confidence: e.confidence, advice: e.advice,
          matchSource, // 标记匹配来源
          sectorOverlap: hasSectorData ? Math.max(posScore, negScore) : 0, // 板块重叠度
        });
      }
    });
    
    if(matchedEvents.length > 0){
 // 按板块重叠度降序排列，确保最相关的事件排在前面
      matchedEvents.sort((a,b) => (b.sectorOverlap||0) - (a.sectorOverlap||0));
      fundImpacts[code] = {
        score: fundScore,
        events: matchedEvents,
        sectorExposure: hasSectorData ? sectorExposure : null,
        analysisSource: hasSectorData ? (_fundHoldingsCache[code]?.source || 'inferred') : 'name-only',
      };
    } else {
 // 所有持仓基金都纳入归因，无匹配事件的用板块/市场行情兜底
      const fd = getFundData(code);
      const todayPct = parseFloat(fd?.gszzl || 0);
      const absPct = Math.abs(todayPct);
      fundImpacts[code] = {
        score: absPct >= 2 ? 0.2 : absPct >= 1 ? 0.16 : 0.05,
        events: [{
          id: '_market_driven',
          name: fType ? fType + '板块行情' : '市场联动',
          icon: todayPct >= 0 ? '📈' : '📉',
          impact: todayPct >= 0 ? 'positive' : 'negative',
          eventImpact: todayPct >= 0 ? 5 : -5,
          confidence: 0.5, advice: '',
          matchSource: '行情归因', sectorOverlap: 0,
        }],
        sectorExposure: hasSectorData ? sectorExposure : null,
        analysisSource: 'price-driven',
      };
    }
  });
  
  // Debug: 输出归因结果
  const impactCount = Object.keys(fundImpacts).length;
  if(impactCount > 0){
    console.log(`[GeoAnalysis] 归因命中 ${impactCount} 只基金:`);
    Object.entries(fundImpacts).forEach(([code, fi]) => {
      console.log(`  ${fundName(code).slice(0,12)} [${fundType(code)}] score=${fi.score.toFixed(3)} events=${fi.events.map(e=>e.name.slice(0,8)).join(',')}`);
    });
  } else {
    console.warn('[GeoAnalysis] ⚠️ 无基金被归因匹配！检查事件和基金板块数据');
  }
  
  return {
    score: normalizedScore,
    avgImpact,
    topEvents: sorted.slice(0, 7),
    allEvents: activeEvents,
    outlook,
    fundImpacts,
    label: normalizedScore >= 60 ? '地缘偏多' : normalizedScore <= 40 ? '地缘偏空' : '地缘中性',
  };
}

// ==================== TOP50基金经理投资方向 × 社交媒体热词 耦合分析引擎 ====================
// 数据源1: 中国TOP500基金经理中前50名的最新投资方向(模拟来自天天基金/晨星/Wind)
// 数据源2: 社交媒体热词(模拟来自微博/雪球/东方财富股吧/同花顺圈子)
// 耦合逻辑: 当顶级基金经理的重仓方向与社交热词高度重合时，视为趋势强共振信号

let _fmSocialTrendData = null; // 缓存分析结果
let _fmSocialLastUpdate = null;

// TOP50基金经理最新重仓方向(季报持仓+调研动向+公开访谈提炼)
const TOP50_FM_DIRECTIONS = [
  { name:'张坤', firm:'易方达', aum:'800亿', style:'价值成长', sectors:['白酒','医药','互联网'], recent:'加仓港股互联网，减持白酒', conviction:'高' },
  { name:'葛兰', firm:'中欧', aum:'600亿', style:'医药深耕', sectors:['创新药','医疗器械','CXO'], recent:'关注AI+医药交叉领域', conviction:'高' },
  { name:'刘彦春', firm:'景顺长城', aum:'550亿', style:'消费龙头', sectors:['消费','食品饮料','家电'], recent:'看好消费复苏主线', conviction:'中' },
  { name:'朱少醒', firm:'富国', aum:'450亿', style:'均衡成长', sectors:['科技','消费','制造'], recent:'均衡配置偏科技', conviction:'中' },
  { name:'谢治宇', firm:'兴全', aum:'400亿', style:'逆向价值', sectors:['金融','周期','科技'], recent:'逆向布局低估值周期股', conviction:'高' },
  { name:'刘格菘', firm:'广发', aum:'380亿', style:'科技成长', sectors:['光伏','新能源','半导体'], recent:'重仓光伏产业链反转', conviction:'高' },
  { name:'冯明远', firm:'信达澳亚', aum:'350亿', style:'硬科技', sectors:['半导体','军工','新材料'], recent:'半导体国产替代加速', conviction:'高' },
  { name:'蔡嵩松', firm:'诺安', aum:'300亿', style:'赛道集中', sectors:['半导体','AI芯片'], recent:'全力押注AI算力芯片', conviction:'极高' },
  { name:'丘栋荣', firm:'中庚', aum:'280亿', style:'深度价值', sectors:['港股','资源','地产'], recent:'港股低估值+资源品', conviction:'高' },
  { name:'周蔚文', firm:'中欧', aum:'260亿', style:'行业轮动', sectors:['有色金属','化工','新能源'], recent:'看好有色金属超级周期', conviction:'高' },
  { name:'萧楠', firm:'易方达', aum:'240亿', style:'消费价值', sectors:['白酒','乳业','调味品'], recent:'消费板块底部配置', conviction:'中' },
  { name:'傅友兴', firm:'广发', aum:'220亿', style:'稳健平衡', sectors:['红利','公用事业','银行'], recent:'高股息防御策略', conviction:'高' },
  { name:'何帅', firm:'交银施罗德', aum:'200亿', style:'GARP', sectors:['医药','科技','消费'], recent:'精选成长确定性标的', conviction:'中' },
  { name:'赵诣', firm:'泉果', aum:'190亿', style:'新能源链', sectors:['锂电','光伏','储能'], recent:'储能赛道长期看好', conviction:'高' },
  { name:'陆彬', firm:'汇丰晋信', aum:'180亿', style:'全能选手', sectors:['AI','机器人','军工'], recent:'重仓AI应用端', conviction:'极高' },
  { name:'杨锐文', firm:'景顺长城', aum:'170亿', style:'科技成长', sectors:['AI','软件','云计算'], recent:'看好AI软件SaaS化', conviction:'高' },
  { name:'崔宸龙', firm:'前海开源', aum:'160亿', style:'新能源', sectors:['新能源车','充电桩','智能驾驶'], recent:'智能驾驶渗透率拐点', conviction:'高' },
  { name:'刘畅畅', firm:'华安', aum:'150亿', style:'轮动择时', sectors:['周期','金融','消费'], recent:'看好顺周期修复', conviction:'中' },
  { name:'归凯', firm:'嘉实', aum:'145亿', style:'科技成长', sectors:['半导体','AI','新能源'], recent:'AI+半导体双主线', conviction:'高' },
  { name:'王崇', firm:'交银施罗德', aum:'140亿', style:'价值抄底', sectors:['地产','银行','基建'], recent:'低估值价值修复', conviction:'中' },
  { name:'李晓星', firm:'银华', aum:'350亿', style:'均衡配置', sectors:['消费','科技','新能源车'], recent:'消费+科技双主线均衡', conviction:'中' },
  { name:'曲扬', firm:'前海开源', aum:'200亿', style:'资源周期', sectors:['石油石化','煤炭','有色金属'], recent:'看好全球能源转型中的传统能源价值重估', conviction:'高' },
  { name:'姜诚', firm:'中泰资管', aum:'180亿', style:'深度价值', sectors:['石油石化','能源','公用事业'], recent:'能源股长期价值被低估，加仓石油石化', conviction:'高' },
  { name:'韩创', firm:'大成', aum:'160亿', style:'周期成长', sectors:['煤炭','石油石化','化工'], recent:'周期品供给侧逻辑仍在，能源链盈利韧性强', conviction:'高' },
];

// 社交媒体热词数据(优先使用雪球实时API数据, 回退静态数据)
const _STATIC_HOTWORDS = [
    { word:'AI', heat:9800, trend:'up', sources:['微博','雪球','东财'], relatedSectors:['AI','半导体','云计算','软件'] },
    { word:'DeepSeek', heat:9200, trend:'up', sources:['微博','雪球'], relatedSectors:['AI','算力','半导体'] },
    { word:'机器人', heat:8500, trend:'up', sources:['微博','雪球','同花顺'], relatedSectors:['AI','机器人','制造'] },
    { word:'铜价创新高', heat:7800, trend:'up', sources:['东财','雪球'], relatedSectors:['有色金属','铜','资源'] },
    { word:'黄金避险', heat:7200, trend:'up', sources:['微博','东财'], relatedSectors:['黄金','贵金属','避险'] },
    { word:'光伏反转', heat:6800, trend:'up', sources:['雪球','同花顺'], relatedSectors:['光伏','新能源','储能'] },
    { word:'消费复苏', heat:6500, trend:'stable', sources:['微博','东财'], relatedSectors:['消费','食品饮料','白酒','家电'] },
    { word:'半导体国产化', heat:6200, trend:'up', sources:['雪球','同花顺'], relatedSectors:['半导体','芯片','AI芯片'] },
    { word:'MiniMax海螺AI', heat:8800, trend:'up', sources:['微博','雪球','36氪'], relatedSectors:['AI','AI应用','大模型','算力'] },
    { word:'智谱清言GLM', heat:8200, trend:'up', sources:['微博','雪球','东财'], relatedSectors:['AI','大模型','算力','国产替代'] },
    { word:'港股科技暴跌', heat:7500, trend:'up', sources:['雪球','东财','同花顺'], relatedSectors:['港股','互联网'] },
    { word:'医药创新', heat:5500, trend:'stable', sources:['雪球'], relatedSectors:['创新药','医药','医疗器械','CXO'] },
    { word:'红利策略', heat:5200, trend:'stable', sources:['东财','同花顺'], relatedSectors:['红利','银行','公用事业','高股息'] },
    { word:'新能源车', heat:5000, trend:'stable', sources:['微博','雪球'], relatedSectors:['新能源车','锂电','智能驾驶','充电桩'] },
    { word:'军工订单', heat:4800, trend:'up', sources:['雪球'], relatedSectors:['军工','国防','航空航天'] },
    { word:'储能爆发', heat:4500, trend:'up', sources:['东财','雪球'], relatedSectors:['储能','新能源','电池'] },
    { word:'地产松绑', heat:4200, trend:'down', sources:['微博','东财'], relatedSectors:['地产','基建','建材'] },
    { word:'算力基建', heat:8000, trend:'up', sources:['微博','雪球','东财'], relatedSectors:['AI','算力','数据中心','光模块'] },
    { word:'白酒去库存', heat:6800, trend:'up', sources:['东财','雪球','同花顺'], relatedSectors:['白酒','食品饮料','消费'] },
    { word:'光伏产能过剩', heat:5800, trend:'stable', sources:['雪球','东财'], relatedSectors:['光伏','新能源','锂电'] },
    { word:'张坤重仓股承压', heat:5500, trend:'up', sources:['东财','雪球'], relatedSectors:['港股互联网','白酒','蓝筹'] },
];
function getSocialMediaHotwords(){
  // 优先使用后端雪球实时数据
  const xqData = _hotEventsData?.xueqiu_hotwords;
  if(xqData?.hotwords?.length > 0){
    return xqData.hotwords.map(hw => ({
      word: hw.word,
      heat: hw.heat || 5000,
      trend: hw.trend || 'stable',
      sources: hw.sources || ['雪球'],
      relatedSectors: hw.relatedSectors || [],
    })).sort((a,b) => b.heat - a.heat);
  }
  // 回退: 静态数据
  return [..._STATIC_HOTWORDS].sort((a,b) => b.heat - a.heat);
}

// 获取雪球热股原始数据 (供UI直接展示)
function getXueqiuHotStocks(){
  return _hotEventsData?.xueqiu_hotwords?.hot_stocks || [];
}

// 获取雪球热帖摘要 (供UI直接展示)
function getXueqiuHotTopics(){
  return _hotEventsData?.xueqiu_hotwords?.hot_topics || [];
}

// 核心耦合分析: 基金经理投资方向 × 社交热词 → 趋势共振信号
function analyzeFMSocialCoupling(){
  const managers = TOP50_FM_DIRECTIONS;
  const hotwords = getSocialMediaHotwords();

  // 1. 统计基金经理对各板块的共识度
  const sectorManagerCount = {}; // 板块 → 多少位经理重仓
  const sectorManagerNames = {}; // 板块 → 经理姓名列表
  const sectorConviction = {}; // 板块 → 平均conviction
  managers.forEach(m => {
    m.sectors.forEach(s => {
      if(!sectorManagerCount[s]) { sectorManagerCount[s] = 0; sectorManagerNames[s] = []; sectorConviction[s] = []; }
      sectorManagerCount[s]++;
      sectorManagerNames[s].push(m.name);
      sectorConviction[s].push(m.conviction === '极高' ? 5 : m.conviction === '高' ? 4 : m.conviction === '中' ? 3 : 2);
    });
  });

  // 2. 统计社交热词对各板块的热度
  const sectorSocialHeat = {}; // 板块 → 总热度
  const sectorHotwords = {}; // 板块 → 热词列表
  hotwords.forEach(hw => {
    hw.relatedSectors.forEach(s => {
      if(!sectorSocialHeat[s]) { sectorSocialHeat[s] = 0; sectorHotwords[s] = []; }
      sectorSocialHeat[s] += hw.heat;
      sectorHotwords[s].push({ word:hw.word, heat:hw.heat, trend:hw.trend });
    });
  });

  // 3. 计算耦合强度(基金经理共识 × 社交热度归一化)
  const allSectors = new Set([...Object.keys(sectorManagerCount), ...Object.keys(sectorSocialHeat)]);
  const coupledTrends = [];
  const maxHeat = Math.max(...Object.values(sectorSocialHeat), 1);
  const maxMgr = Math.max(...Object.values(sectorManagerCount), 1);

  allSectors.forEach(sector => {
    const mgrCount = sectorManagerCount[sector] || 0;
    const socialHeat = sectorSocialHeat[sector] || 0;
    const mgrNames = sectorManagerNames[sector] || [];
    const avgConv = sectorConviction[sector]?.length > 0 ? sectorConviction[sector].reduce((a,b)=>a+b,0)/sectorConviction[sector].length : 0;
    const hwList = sectorHotwords[sector] || [];

    // 只关注至少有1位经理或有社交热度的板块
    if(mgrCount === 0 && socialHeat === 0) return;

    // 归一化得分
    const mgrScore = (mgrCount / maxMgr) * 50;
    const socialScore = (socialHeat / maxHeat) * 50;
    const couplingScore = Math.round(mgrScore + socialScore);

    // 共振强度: 两侧都有信号时额外加分
    const resonance = (mgrCount > 0 && socialHeat > 0) ? '强共振' : (mgrCount > 0 ? '经理主导' : '舆情主导');
    const resonanceBonus = resonance === '强共振' ? Math.round(avgConv * 3) : 0;

    coupledTrends.push({
      sector,
      mgrCount,
      mgrNames: mgrNames.slice(0, 4),
      avgConviction: avgConv,
      socialHeat,
      hotwords: hwList.slice(0, 3),
      couplingScore: Math.min(100, couplingScore + resonanceBonus),
      resonance,
      socialTrend: hwList.length > 0 ? (hwList.filter(h=>h.trend==='up').length > hwList.length/2 ? 'up' : 'stable') : 'unknown',
    });
  });

  // 按耦合得分排序
  coupledTrends.sort((a,b) => b.couplingScore - a.couplingScore);

  // 4. 生成趋势洞察
  const topTrends = coupledTrends.slice(0, 8);
  const strongResonance = topTrends.filter(t => t.resonance === '强共振');

  // 5. 基金经理近期动向摘要
  const recentMoves = managers.filter(m => m.conviction === '极高' || m.conviction === '高').slice(0, 8).map(m => ({
    name: m.name,
    firm: m.firm,
    aum: m.aum,
    recent: m.recent,
    conviction: m.conviction,
  }));

  const result = {
    topTrends,
    strongResonance,
    recentMoves,
    hotwords: hotwords.slice(0, 10),
    totalManagers: managers.length,
    timestamp: new Date().toLocaleString('zh-CN',{hour:'2-digit',minute:'2-digit'}),
  };

  _fmSocialTrendData = result;
  _fmSocialLastUpdate = new Date();
  return result;
}

// 生成AI上下文注入文本
function getFMSocialContextForAI(){
  const data = _fmSocialTrendData || analyzeFMSocialCoupling();
 let ctx = '\n■ TOP50基金经理投资方向 × 社交媒体热词 耦合分析:\n';
  ctx += `  数据源: TOP500基金经理前50名(季报持仓+调研动向) × 社交媒体(微博/雪球/东财/同花顺)\n`;

  ctx += '  [趋势共振排行(经理共识×社交热度)]:\n';
  data.topTrends.forEach((t, i) => {
    const trendArrow = t.socialTrend === 'up' ? '↑' : t.socialTrend === 'down' ? '↓' : '→';
    const hwStr = t.hotwords.map(h => h.word).join('/');
    ctx += `    ${i+1}. ${t.sector}(耦合${t.couplingScore}分·${t.resonance}) 经理${t.mgrCount}人[${t.mgrNames.join(',')}] 热词${trendArrow}[${hwStr}]\n`;
  });

  ctx += '  [顶级基金经理最新动向]:\n';
  data.recentMoves.forEach(m => {
    ctx += `    ${m.name}(${m.firm}·${m.aum}): ${m.recent} [确信度:${m.conviction}]\n`;
  });

  ctx += '  [社交媒体TOP热词]:\n';
  data.hotwords.slice(0,8).forEach(h => {
    ctx += `    ${h.word}(热度${h.heat}·${h.trend==='up'?'↑升温':h.trend==='down'?'↓降温':'→持平'}) 来源:${h.sources.join('/')}\n`;
  });

 ctx += ' 请特别关注「强共振」板块(基金经理集中配置+社交热度飙升)，这些方向往往代表中期趋势拐点。同时警惕纯舆情主导但经理未参与的方向(可能是散户追涨)。\n';

  return ctx;
}

function normalizeFundCategoryName(raw){
  if(!raw) return '';
  const s = String(raw).trim();
  const map = {
    'AI芯片':'半导体', '芯片':'半导体', '算力':'AI', '大模型':'AI', '人工智能':'AI', '云计算':'AI', '软件':'AI',
    '港股':'港股科技', '港股互联网':'港股科技', '互联网':'港股科技',
    '食品饮料':'消费', '家电':'消费', '商贸零售':'消费',
    '创新药':'医药', '医疗器械':'医药', 'CXO':'医药',
    '国防':'军工', '航空航天':'军工',
    '储能':'新能源', '电池':'新能源', '充电桩':'新能源', '新能源车':'新能源',
    '贵金属':'黄金', '避险':'黄金',
    '铜':'有色金属', '铝':'有色金属', '资源':'有色金属', '矿业':'有色金属',
    '石油石化':'能源', '油气':'能源', '原油':'能源', '煤炭':'能源',
    '高股息':'红利', '公用事业':'红利', '银行':'红利',
  };
  return map[s] || s;
}

function _extractFundHoldingCategories(code, fType, fName){
  const profile = {};
  const holdInfo = _fundHoldingsCache[code];
  if(holdInfo?.sectorExposure){
    Object.entries(holdInfo.sectorExposure).forEach(([sec, w]) => {
      if(w < 0.08) return;
      const k = normalizeFundCategoryName(sec);
      profile[k] = Math.max(profile[k] || 0, w);
    });
  }

  if(Object.keys(profile).length === 0 && fType){
    fType.split(/[/／·、,，]/).map(s=>s.trim()).filter(Boolean).forEach(tag => {
      const k = normalizeFundCategoryName(tag);
      profile[k] = Math.max(profile[k] || 0, 0.2);
    });
  }

  const lowerName = (fName || '').toLowerCase();
  const pushByName = (kw, sector, w=0.2) => {
    if(lowerName.includes(kw)) profile[sector] = Math.max(profile[sector] || 0, w);
  };
  pushByName('半导体', '半导体');
  pushByName('芯片', '半导体');
  pushByName('军工', '军工');
  pushByName('医药', '医药');
  pushByName('白酒', '白酒');
  pushByName('消费', '消费');
  pushByName('新能源', '新能源');
  pushByName('光伏', '新能源');
  pushByName('锂电', '新能源');
  pushByName('港股', '港股科技');
  pushByName('科技', '港股科技');
  pushByName('黄金', '黄金');
  pushByName('有色', '有色金属');
  pushByName('油气', '能源');
  pushByName('原油', '能源');
  pushByName('石油', '能源');

  return profile;
}

function analyzeXueqiuHoldingCategories(code, fType, fName){
  const profile = _extractFundHoldingCategories(code, fType, fName);
  const categories = Object.keys(profile);
  if(categories.length === 0) return null;

  // 使用实时雪球热词(优先) 或 静态数据
  const allWords = getSocialMediaHotwords();
  const xqWords = allWords.filter(hw => (hw.sources || []).includes('雪球'));
  if(xqWords.length === 0) return null;

  // 是否使用了实时数据
  const isLive = !!(_hotEventsData?.xueqiu_hotwords?.hotwords?.length > 0);

  const stats = {};
  categories.forEach(c => {
    stats[c] = { category:c, weight: profile[c], heat:0, up:0, down:0, stable:0, words:[], stocks:[] };
  });

  xqWords.forEach(hw => {
    const rel = (hw.relatedSectors || []).map(normalizeFundCategoryName);
    categories.forEach(c => {
      if(!rel.includes(c)) return;
      const s = stats[c];
      s.heat += hw.heat;
      if(hw.trend === 'up') s.up++;
      else if(hw.trend === 'down') s.down++;
      else s.stable++;
      s.words.push(hw.word);
      // 如果是热股类型, 记录涨跌幅
      if(hw.type === 'stock' && hw.percent !== undefined){
        s.stocks.push({ name: hw.word, pct: hw.percent });
      }
    });
  });

  const matched = Object.values(stats)
    .filter(s => s.heat > 0)
    .map(s => ({
      ...s,
      weightedHeat: s.heat * (0.5 + Math.min(0.5, s.weight || 0)),
      trend: s.up > s.down ? 'up' : s.down > s.up ? 'down' : 'stable',
    }))
    .sort((a,b) => b.weightedHeat - a.weightedHeat);

  if(matched.length === 0) return null;

  const totalHeat = matched.reduce((acc, it) => acc + it.heat, 0);
  const topWords = [...new Set(matched.flatMap(it => it.words))].slice(0, 6);
  const trendScore = matched.reduce((acc, it) => acc + (it.trend === 'up' ? 1 : it.trend === 'down' ? -1 : 0), 0);
  const sentiment = trendScore > 0 ? '升温' : trendScore < 0 ? '降温' : '分化';
  const matchScore = Math.min(100, Math.round((matched.length / Math.max(1, categories.length)) * 60 + Math.min(40, totalHeat / 1500)));

  // 汇总相关热股涨跌
  const relatedStocks = matched.flatMap(it => it.stocks).filter(Boolean);
  const topStocks = relatedStocks.sort((a,b) => Math.abs(b.pct) - Math.abs(a.pct)).slice(0, 5);

  // 雪球热帖相关摘要
  const hotTopics = getXueqiuHotTopics();
  const relatedTopics = hotTopics.filter(t => {
    const txt = t.text || '';
    return categories.some(c => txt.includes(c)) || topWords.some(w => txt.includes(w));
  }).slice(0, 2);

  return {
    matchScore,
    sentiment,
    categories: matched.slice(0, 3),
    topWords,
    isLive,
    topStocks,
    relatedTopics,
    fetchedAt: _hotEventsData?.xueqiu_hotwords?.fetched_at || null,
  };
}

// ==================== 地缘事件加载 (v2: 从 data/hot_events.json 加载) ====================
// RSS实时抓取已迁移到 GitHub Actions 后端管道 (scripts/fetch_events.py)
// 前端只需加载预处理好的JSON数据

function startGeoNewsAutoRefresh(){
  // v2: 不再前端抓取RSS, 改为定时重新加载 hot_events.json
  // 页面加载时已通过 fetchHotEvents() 加载
  // 每5分钟重新加载一次
  setInterval(async () => {
    console.log('[HotEvents] 定时刷新事件...');
    await fetchHotEvents();
    await fetchUSMarketForAttribution();
    renderAll();
  }, 300000); // 5min
  console.log('[HotEvents] 已启动定时加载 (5min)');
}

// 手动刷新关键事件
async function refreshHotEventsManual(){
  const btn = document.getElementById('refreshEventsBtn');
  if(btn){ btn.disabled = true; btn.textContent = '⏳'; }
  try {
    await fetchHotEvents();
    await fetchUSMarketForAttribution();
    renderAll();
    console.log('[HotEvents] 手动刷新完成');
  } catch(e){
    console.warn('[HotEvents] 手动刷新失败:', e);
  } finally {
 if(btn){ btn.disabled = false; btn.textContent = ''; }
  }
}

// ==================== RL BRAIN STATE ====================
let rlAgent = null;
let rlTrainer = null;
let _rlModelLoaded = false;
let _rlTraining = false;
let _rlSignals = {}; // { code: { action, actionName, confidence, qValues, conviction, uncertainty, headVotes } }
const RL_STATE_SIZE = 40; // 40维Rainbow状态: 动量×5 + 波动率×3 + RSI×2 + MACD×2 + MA偏离×2 + 布林×1 + 回撤×2 + ATR×1 + 趋势×2 + 持仓×3 + 外部×4 + 回测×3 + 高阶×6 + 组合×4
const RL_ACTION_SIZE = 3; // 0=hold, 1=buy, 2=sell
const RL_ACTION_NAMES = ['持有','买入','卖出'];
const RL_STORAGE_KEY = 'fa_rl_brain_v4';
const RL_ENSEMBLE_K = 3; // Bootstrapped ensemble heads
const RL_ONLINE_PRIORITY_BOOST = 2.0; // 在线经验优先级倍数
let _rlPendingRewards = {}; // 延迟奖励: { code: { action, state, date, entryValue } }

// ==================== 三引擎联动元状态 ====================
const ENGINE_ACCURACY_KEY = 'fa_engine_accuracy';
const ENGINE_ACCURACY_LAST_UPDATE_KEY = 'fa_engine_accuracy_last_update';
const ENGINE_ACCURACY_EMA = 0.15; // EMA系数(越大越重视近期)
let _engineAccuracy = { ai: 0.5, rl: 0.5, bt: 0.5 }; // 各引擎滚动准确率
let _lastTriSignals = {}; // 上一次三引擎信号 { code: { action, score, date, confidence } }
let _marketRegime = 'unknown'; // bull/bear/sideways/volatile
let _regimeWeights = { ai: 1.0, rl: 1.0, bt: 1.0 }; // Regime-driven engine multipliers

// ==================== BACKTEST STATE ==
let btResults = {}; // { code: { totalReturn, sharpe, maxDD, kellyFraction, winRate, trades, equity, drawdown } }
let btSummary = null;
let _btRunning = false;
const BT_STORAGE_KEY = 'fa_backtest';
const BT_FEE = 0.0015; // 单边手续费
const BT_RSI_PERIOD = 14;
let BT_RSI_BUY = 70; // RSI<70时允许买入(可被Sim绩效自适应调整)
let BT_RSI_SELL = 75; // RSI>75考虑卖出(可被Sim绩效自适应调整)
let BT_MOMENTUM_BUY = 0.01; // 预测涨幅>1%买入(可被Sim绩效自适应调整)
const BT_RISK_FREE = 0.025; // 年化无风险利率

function saveHoldings(){ localStorage.setItem('fa_holdings', JSON.stringify(holdings)); }
function saveWatchlist(){ localStorage.setItem('fa_watchlist', JSON.stringify(watchlist)); }
function saveKey(k){ _aiKey=k; localStorage.setItem(AI_KEY_PRIMARY_STORAGE, k); }
function saveDailyLog(){ localStorage.setItem('fa_daily_log', JSON.stringify(dailyLog.slice(-30))); } // 最多保留30天
function saveProvider(id){
  _aiProviderId=id;
  _aiProvider=AI_PROVIDERS.find(p=>p.id===id)||AI_PROVIDERS[0];
  AI_ENGINES=_aiProvider.models;
  _apiBase=_aiProvider.base;
  localStorage.setItem('fa_ai_provider',id);
}

// ==================== UTILITIES ====================
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function sign(n){ return n>=0?'+':''; }
function fmt(n){ return (typeof n==='number')?n.toFixed(2):'--'; }
function seededRand(seed){ let x=Math.sin(seed)*10000; return x-Math.floor(x); }

// A股节假日休市日历(YYYY-MM-DD)
const CN_HOLIDAYS_2025 = ['2025-01-01','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-03','2025-02-04','2025-04-04','2025-05-01','2025-05-02','2025-05-05','2025-06-02','2025-10-01','2025-10-02','2025-10-03','2025-10-06','2025-10-07','2025-10-08'];
const CN_HOLIDAYS_2026 = ['2026-01-01','2026-01-02','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-04-06','2026-05-01','2026-05-04','2026-05-05','2026-06-01','2026-10-01','2026-10-02','2026-10-05','2026-10-06','2026-10-07','2026-10-08'];
const CN_HOLIDAYS = new Set([...CN_HOLIDAYS_2025, ...CN_HOLIDAYS_2026]);
// 部分周末调休补班日
const CN_WORKDAYS = new Set(['2025-01-26','2025-02-08','2025-04-27','2025-09-28','2025-10-11','2026-02-14','2026-02-28','2026-10-10']);

function isTradingDay(dateStr){
  if(!dateStr) dateStr = todayStr();
  if(CN_HOLIDAYS.has(dateStr)) return false;
  if(CN_WORKDAYS.has(dateStr)) return true;
  const d = new Date(dateStr); const day = d.getDay();
  return day!==0 && day!==6;
}

function getMarketStatus(){
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const t = h*60+m;
  const today = todayStr();
  // 节假日
  if(CN_HOLIDAYS.has(today)) return {status:'closed', text:'节假日休市', countdown:null, isHoliday:true};
  // 周末(非补班)
  if((day===0||day===6) && !CN_WORKDAYS.has(today)) return {status:'closed', text:'周末休市', countdown:null};
  if(t<570) return {status:'pre', text:'未开盘', countdown:null};
  if(t>=570&&t<690) return {status:'open', text:'交易中·上午', countdown:900-t};
  if(t>=690&&t<780) return {status:'break', text:'午间休市', countdown:900-t};
  if(t>=780&&t<900) return {status:'open', text:'交易中·下午', countdown:900-t};
  return {status:'closed', text:'已收盘', countdown:null};
}

/** 是否在交易时段内（含午休） */
function isMarketLive(){
  const ms = getMarketStatus();
  return ms.status === 'open' || ms.status === 'break';
}

/** 根据数据来源和市场状态返回涨跌幅前缀标签 */
function pctLabel(fd){
  if(!fd) return '待开盘';
  if(fd._live) return isMarketLive() ? '盘中估值' : '今日';
  if(fd._histFallback) return '昨日';
  // 随机兜底数据
  return '待开盘';
}

function formatCountdown(mins){
  if(mins===null||mins<=0) return '00:00';
  const h = Math.floor(mins/60);
  const m = mins%60;
  const now = new Date();
  const s = 59 - now.getSeconds();
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ==================== JSONP ENGINE ====================
let _jcnt=0;
function jsonpFetch(url, opts={}){
  return new Promise((resolve, reject)=>{
    const cbName = opts.fixedCb || `_jp${++_jcnt}_${Date.now()}`;
    const timeout = opts.timeout || 8000;
    const script = document.createElement('script');
    // 不设no-referrer: eastmoney API要求有Referer才返回数据
    const timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
    function cleanup(){ clearTimeout(timer); if(!opts.fixedCb) delete window[cbName]; try{script.remove();}catch(e){} }
    window[cbName] = function(data){ cleanup(); resolve(data); };
    let finalUrl = url;
    const cbParam = opts.callbackParam || 'cb';
    if(!opts.fixedCb) finalUrl += (url.includes('?')?'&':'?') + `${cbParam}=${cbName}`;
    finalUrl += (finalUrl.includes('?')?'&':'?') + `_t=${Date.now()}`;
    script.src = finalUrl;
    script.onerror = ()=>{ cleanup(); reject(new Error('network')); };
    document.head.appendChild(script);
  });
}

// ==================== DATA FETCHING ====================
async function fetchIndices(){
  try{
    const secids = INDICES_CONFIG.map(i=>i.secid).join(',');
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=${secids}&fields=f2,f3,f4,f12,f13,f14`);
    if(data?.data?.diff){
      data.data.diff.forEach(d=>{
        const key=`${d.f13}.${d.f12}`;
        if(d.f2!=='-'&&!isNaN(d.f2)) liveIndices[key]={name:d.f14,price:d.f2,pct:d.f3,change:d.f4};
      });
    }
  }catch(e){ console.error('fetchIndices:', e); }
}

async function fetchSectors(){
  try{
    const data = await jsonpFetch(`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=20&po=1&np=1&fltt=2&invt=2&fid=f3&fs=m:90+t:2&fields=f3,f14`);
    if(data?.data?.diff){
      liveSectors = data.data.diff.map(d=>({name:d.f14,pct:d.f3})).filter(d=>!isNaN(d.pct)).sort((a,b)=>b.pct-a.pct);
    }
  }catch(e){}
}

// fundgz API 固定回调名 jsonpgz，但响应包含 fundcode 字段，用于匹配
const _fundEstimateWaiters = {}; // code -> {resolve, reject, timer, cleanup}
async function fetchFundEstimate(code){
  return new Promise((resolve, reject)=>{
    // 如果已有该代码的请求，先清理
    if(_fundEstimateWaiters[code]){
      clearTimeout(_fundEstimateWaiters[code].timer);
      _fundEstimateWaiters[code].reject(new Error('replaced'));
      delete _fundEstimateWaiters[code];
    }
    const script = document.createElement('script');
    const timer = setTimeout(()=>{
      cleanup();
      reject(new Error('timeout'));
    }, 8000);
    function cleanup(){
      clearTimeout(timer);
      delete _fundEstimateWaiters[code];
      try{ script.remove(); }catch(e){}
    }
    _fundEstimateWaiters[code] = { resolve, reject, timer, cleanup };
    script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
    script.onerror = ()=>{ cleanup(); reject(new Error('error')); };
    document.head.appendChild(script);
  });
}
// 全局回调：通过 fundcode 分发给对应的 waiter
window.jsonpgz = function(d){
  const code = d && d.fundcode;
  if(code && _fundEstimateWaiters[code]){
    const w = _fundEstimateWaiters[code];
    w.cleanup();
    w.resolve(d);
  }
};

function getAllPortfolioCodes(){
  const pCodes = [];
  MODEL_PORTFOLIO.core.funds.forEach(f=>pCodes.push(f.code));
  MODEL_PORTFOLIO.satellite.funds.forEach(f=>pCodes.push(f.code));
  FUND_DB.forEach(f=>pCodes.push(f.code));
  RECO_FUND_POOL.forEach(f=>pCodes.push(f.code));
  // 包含模拟盘持仓代码，确保获取真实市场数据
  if(simPortfolio && simPortfolio.positions){
    simPortfolio.positions.forEach(p=>pCodes.push(p.code));
  }
  return [...new Set(pCodes)];
}

async function fetchAllFunds(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  // 并行请求（每个代码通过 fundcode 字段分发，不冲突）
  // 分批：每批5个，避免浏览器并发限制
  for(let i=0; i<codes.length; i+=5){
    const batch = codes.slice(i, i+5);
    await Promise.allSettled(batch.map(async code=>{
      try{
        const d = await fetchFundEstimate(code);
        if(d?.gsz){
          liveFundData[code] = { gsz:parseFloat(d.gsz), dwjz:parseFloat(d.dwjz), gszzl:parseFloat(d.gszzl), name:d.name||'', gztime:d.gztime||'' };
          // 收集盘中快照用于日内曲线
          _collectIntradaySnapshot(code, d);
        }
      }catch(e){}
    }));
  }
  // 回填缺失名称到 holdings/watchlist 并持久化，避免API不可用时无名称
  backfillFundNames();
}

/** 收集一个盘中快照点 */
function _collectIntradaySnapshot(code, d){
  const gztime = d.gztime || '';
  // 只在有时间数据时收集
  const timePart = gztime.split(' ')[1] || '';
  if(!timePart) return;
  const hhmm = timePart.slice(0,5); // 'HH:MM'
  if(!intradayData[code]) intradayData[code] = [];
  const arr = intradayData[code];
  // 新的一天清空旧数据
  const dateStr = gztime.split(' ')[0] || '';
  if(arr.length > 0 && arr[0]._date && arr[0]._date !== dateStr){
    intradayData[code] = [];
  }
  // 去重（同一分钟只保留最新）
  if(arr.length > 0 && arr[arr.length-1].time === hhmm){
    arr[arr.length-1] = { time:hhmm, gsz:parseFloat(d.gsz), pct:parseFloat(d.gszzl), _date:dateStr };
  } else {
    arr.push({ time:hhmm, gsz:parseFloat(d.gsz), pct:parseFloat(d.gszzl), _date:dateStr });
  }
}

/** 获取基金当日盘中估值详情（东方财富分时API）*/
async function fetchIntradayDetail(code){
  try{
    const secid = getSecidForFund(code);
    const data = await jsonpFetch(`https://push2his.eastmoney.com/api/qt/stock/trends2/get?secid=${secid}&fields1=f1,f2,f3&fields2=f51,f53&iscr=0&ndays=1`);
    if(data?.data?.trends){
      const preClose = parseFloat(data.data.preClose) || 0;
      const points = data.data.trends.map(t => {
        const parts = t.split(',');
        const timeStr = (parts[0]||'').split(' ')[1] || parts[0];
        const price = parseFloat(parts[1]) || 0;
        const pct = preClose > 0 ? ((price - preClose) / preClose * 100) : 0;
        return { time: timeStr.slice(0,5), gsz: price, pct: +pct.toFixed(3) };
      }).filter(p => p.gsz > 0);
      if(points.length > 0) intradayData[code] = points;
      return points;
    }
  }catch(e){ console.warn('[Intraday]', code, e); }
  return null;
}

/** 批量拉取所有持仓+自选的盘中分时数据 */
async function fetchAllIntradayDetail(){
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  for(let i=0; i<codes.length; i+=5){
    const batch = codes.slice(i, i+5);
    await Promise.allSettled(batch.map(code => fetchIntradayDetail(code)));
  }
}

/** 渲染基金日内估值曲线 SVG */
function renderIntradaySVG(code){
  const points = intradayData[code];
 if(!points || points.length < 2) return `<div class="ag-intraday-chart"><div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:10px;color:var(--sub)"> 盘中估值加载中...</div></div>`;

  const W = 300, H = 48, padT = 2, padB = 2;
  const chartH = H - padT - padB;
  const prices = points.map(p => p.gsz);
  const maxP = Math.max(...prices), minP = Math.min(...prices);
  const range = maxP - minP || 0.001;
  const lastPct = points[points.length-1].pct;
  const isUp = lastPct >= 0;
  const lineColor = isUp ? '#ef4444' : '#16a34a';
  const fillColor = isUp ? 'rgba(239,68,68,0.12)' : 'rgba(22,163,74,0.12)';

  // 生成坐标点 
  const pts = points.map((p, i) => {
    const x = (i / (points.length - 1)) * W;
    const y = padT + chartH - ((p.gsz - minP) / range) * chartH;
    return { x, y, time: p.time, gsz: p.gsz, pct: p.pct };
  });
  const polyline = pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
  const polygon = `0,${H} ${polyline} ${W},${H}`;

  // 零轴线（昨收 = pct 0%）
  const firstPct = points[0].pct;
  const zeroGsz = points[0].gsz / (1 + firstPct/100); // 近似昨收价
  const zeroY = padT + chartH - ((zeroGsz - minP) / range) * chartH;
  const showZero = zeroY > padT && zeroY < H - padB;

  // 最高/最低标注
  const maxIdx = prices.indexOf(maxP);
  const minIdx = prices.indexOf(minP);

  const pctColor = isUp ? '#ef4444' : '#16a34a';
  const pctSign = lastPct >= 0 ? '+' : '';

  let svg = `<div class="ag-intraday-chart" data-code="${code}">`;
  svg += `<svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">`;
  // 填充区域
  svg += `<polygon points="${polygon}" fill="${fillColor}"/>`;
  // 零轴
  if(showZero) svg += `<line x1="0" y1="${zeroY.toFixed(1)}" x2="${W}" y2="${zeroY.toFixed(1)}" stroke="rgba(148,163,184,0.3)" stroke-dasharray="3,3" stroke-width="0.5"/>`;
  // 曲线
  svg += `<polyline points="${polyline}" fill="none" stroke="${lineColor}" stroke-width="1.5" stroke-linejoin="round"/>`;
  // 最高点
  if(pts[maxIdx]) svg += `<circle cx="${pts[maxIdx].x.toFixed(1)}" cy="${pts[maxIdx].y.toFixed(1)}" r="2" fill="${lineColor}" opacity="0.7"/>`;
  // 最低点
  if(pts[minIdx]) svg += `<circle cx="${pts[minIdx].x.toFixed(1)}" cy="${pts[minIdx].y.toFixed(1)}" r="2" fill="${lineColor}" opacity="0.7"/>`;
  // 最新点高亮
  const last = pts[pts.length-1];
  svg += `<circle cx="${last.x.toFixed(1)}" cy="${last.y.toFixed(1)}" r="2.5" fill="${lineColor}"/>`;
  svg += `</svg>`;
  // 标签
 svg += `<span class="intra-label"> 盘中估值 · ${points.length}个采样</span>`;
  svg += `<span class="intra-val" style="color:${pctColor}">${points[points.length-1].gsz.toFixed(4)} (${pctSign}${lastPct.toFixed(2)}%)</span>`;
  svg += `<span class="intra-time">${points[0].time}</span>`;
  svg += `<span class="intra-time-end">${points[points.length-1].time}</span>`;
  svg += `</div>`;
  return svg;
}

function backfillFundNames(){
  let dirty = false;
  const nameSource = (code) => {
    return liveFundData[code]?.name || FUND_DB.find(x=>x.code===code)?.name
      || RECO_FUND_POOL.find(x=>x.code===code)?.name
      || MODEL_PORTFOLIO.core.funds.find(x=>x.code===code)?.name
      || MODEL_PORTFOLIO.satellite.funds.find(x=>x.code===code)?.name
      || _fundHoldingsCache[code]?.name || '';
  };
  holdings.forEach(h=>{
    if(!h.name || h.name===h.code){
      const n = nameSource(h.code);
      if(n){ h.name = n; dirty = true; }
    }
  });
  watchlist.forEach(w=>{
    if(!w.name || w.name===w.code){
      const n = nameSource(w.code);
      if(n){ w.name = n; dirty = true; }
    }
  });
  if(dirty){ saveHoldings(); saveWatchlist(); console.log('[backfill] 已回填缺失的基金名称'); }
}

// ==================== DATA INTELLIGENCE: MACRO + NEWS + SENTIMENT ====================
const MACRO_TOKEN = '894050c76af8597a853f5b408b759f5d';
const MACRO_BASE = 'https://datacenter.eastmoney.com/api/data/v1/get';

async function fetchMacroData(){
  const apis = [
    { key:'cpi', report:'RPT_ECONOMY_CPI', cols:'REPORT_DATE,TIME,NATIONAL_SAME,NATIONAL_SEQUENTIAL', sort:'REPORT_DATE', size:3 },
    { key:'ppi', report:'RPT_ECONOMY_PPI', cols:'REPORT_DATE,TIME,BASE_SAME,BASE_ACCUMULATE', sort:'REPORT_DATE', size:3 },
    { key:'pmi', report:'RPT_ECONOMY_PMI', cols:'REPORT_DATE,TIME,MAKE_INDEX,NMAKE_INDEX', sort:'REPORT_DATE', size:3 },
    { key:'gdp', report:'RPT_ECONOMY_GDP', cols:'REPORT_DATE,TIME,SUM_SAME,SECOND_SAME,THIRD_SAME', sort:'REPORT_DATE', size:2 },
    { key:'m2', report:'RPT_ECONOMY_CURRENCY_SUPPLY', cols:'REPORT_DATE,TIME,BASIC_CURRENCY,BASIC_CURRENCY_SAME,FREE_CASH_SAME', sort:'REPORT_DATE', size:3 },
  ];
  await Promise.allSettled(apis.map(async api=>{
    try{
      const url = `${MACRO_BASE}?reportName=${api.report}&columns=${api.cols}&pageSize=${api.size}&sortColumns=${api.sort}&sortTypes=-1&token=${MACRO_TOKEN}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if(json?.success && json?.result?.data){
        macroData[api.key] = json.result.data;
      }
    }catch(e){ console.warn('fetchMacro '+api.key+':', e); }
  }));
}

async function fetchSectorCapFlow(){
  try{
    // 板块主力资金流向 top10
    const data = await jsonpFetch('https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=10&po=1&np=1&fltt=2&invt=2&fid=f62&fs=m:90+t:2&fields=f12,f14,f62,f184,f66,f69,f72,f75');
    if(data?.data?.diff){
      sectorCapFlow = data.data.diff.map(d=>({
        name: d.f14,
        mainNet: d.f62,           // 主力净流入(元)
        mainNetPct: d.f184,       // 主力净流入占比%
        superBig: d.f66,          // 超大单净流入
        big: d.f69,               // 大单净流入
        mid: d.f72,               // 中单净流入
        small: d.f75,             // 小单净流入
      })).filter(d=>d.mainNet && d.mainNet!=='-');
    }
  }catch(e){ console.warn('fetchSectorCapFlow:', e); }
}

async function fetchNewsHeadlines(){
  try{
    // 新浪财经滚动新闻
    const data = await jsonpFetch('https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&k=&num=15&page=1');
    if(data?.result?.data){
      newsHeadlines = data.result.data.map(d=>({
        title: d.title || '',
        time: d.ctime ? new Date(d.ctime*1000).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) : '',
        url: d.url || '',
        category: d.category || '',
      })).filter(n=>n.title);
      analyzeNewsSentiment();
    }
  }catch(e){
    console.warn('fetchNews:', e);
    // 备用: 尝试直接fetch
    try{
      const resp = await fetch('https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&num=15&page=1');
      const data = await resp.json();
      if(data?.result?.data){
        newsHeadlines = data.result.data.map(d=>({
          title: d.title || '',
          time: d.ctime ? new Date(d.ctime*1000).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) : '',
          url: d.url || '',
        })).filter(n=>n.title);
        analyzeNewsSentiment();
      }
    }catch(e2){}
  }
}

function analyzeNewsSentiment(){
  // NLP情绪分析: 基于关键词的财经新闻情绪判断
  const bullWords = ['上涨','大涨','涨停','飙升','新高','突破','利好','增长','回升','回暖','反弹','复苏','超预期','乐观','加速','放量','强势','牛市','提振','扩张','积极','好转','走高','攀升','上扬','暴涨','拉升','创新高'];
  const bearWords = ['下跌','大跌','跌停','暴跌','崩','利空','下滑','萎缩','低迷','悲观','收紧','缩量','弱势','熊市','恶化','衰退','下行','走低','创新低','破位','杀跌','重挫','暴雷','爆仓','风险','危机','制裁','加息','通胀','紧缩'];

  let bullCount = 0, bearCount = 0;
  newsHeadlines.forEach(n=>{
    const t = n.title;
    let bull = 0, bear = 0;
    bullWords.forEach(w=>{ if(t.includes(w)) bull++; });
    bearWords.forEach(w=>{ if(t.includes(w)) bear++; });
    if(bull > bear) { bullCount++; n.sentiment = 'bull'; }
    else if(bear > bull) { bearCount++; n.sentiment = 'bear'; }
    else { n.sentiment = 'neutral'; }
  });

  const total = newsHeadlines.length || 1;
  const score = Math.round(50 + (bullCount - bearCount) / total * 50);
  const clampedScore = Math.max(0, Math.min(100, score));
  let label = '中性';
  if(clampedScore >= 70) label = '偏乐观';
  else if(clampedScore >= 80) label = '很乐观';
  else if(clampedScore <= 30) label = '偏悲观';
  else if(clampedScore <= 20) label = '很悲观';
  else if(clampedScore >= 55) label = '略偏多';
  else if(clampedScore <= 45) label = '略偏空';

  newsSentiment = { score:clampedScore, label, bullCount, bearCount, total };
}

// ==================== GLOBAL NEWS AGGREGATION ====================
// 聚合国际十大新闻源的政治/经济新闻，AI摘要+投资影响分析
const GLOBAL_NEWS_SOURCES = [
  { id:'nyt-world', name:'NYT', label:'纽约时报', url:'https://rss.nytimes.com/services/xml/rss/nyt/World.xml' },
  { id:'nyt-biz', name:'NYT-Biz', label:'纽约时报·商业', url:'https://rss.nytimes.com/services/xml/rss/nyt/Business.xml' },
  { id:'nyt-pol', name:'NYT-Pol', label:'纽约时报·政治', url:'https://rss.nytimes.com/services/xml/rss/nyt/Politics.xml' },
  { id:'wsj', name:'WSJ', label:'华尔街日报', url:'https://feeds.a.dj.com/rss/RSSWorldNews.xml' },
  { id:'bbc-world', name:'BBC', label:'BBC World', url:'https://feeds.bbci.co.uk/news/world/rss.xml' },
  { id:'bbc-biz', name:'BBC-Biz', label:'BBC Business', url:'https://feeds.bbci.co.uk/news/business/rss.xml' },
  { id:'guardian', name:'Guardian', label:'卫报', url:'https://www.theguardian.com/world/rss' },
  { id:'cnbc', name:'CNBC', label:'CNBC', url:'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114' },
  { id:'cnn', name:'CNN', label:'CNN', url:'http://rss.cnn.com/rss/edition_world.rss' },
  { id:'ft', name:'FT', label:'金融时报', url:'https://www.ft.com/rss/home' },
];

const GLOBAL_NEWS_KEYWORDS = /politic|econom|trade|tariff|sanctions?|central.bank|interest.rate|inflation|gdp|recession|federal.reserve|treasury|fiscal|monetary|geopolitic|war|conflict|election|government|tax|debt|deficit|market|stock|bond|currency|oil|energy|china|ukraine|russia|nato|eu\b|trump|biden|congress|parliament|summit|g7|g20|imf|world.bank|fed\b|ecb|boj|pboc|opec/i;

async function fetchGlobalNews(){
  _globalNewsLoading = true;
  const allItems = [];
  const rss2jsonBase = 'https://api.rss2json.com/v1/api.json?rss_url=';

  // 并行拉取所有RSS源
  const fetches = GLOBAL_NEWS_SOURCES.map(async src => {
    try {
      const resp = await fetch(rss2jsonBase + encodeURIComponent(src.url), { signal: AbortSignal.timeout(10000) });
      const data = await resp.json();
      if(data.status === 'ok' && data.items){
        return data.items.map(item => ({
          title: (item.title||'').replace(/<[^>]+>/g,'').trim(),
          description: (item.description||'').replace(/<[^>]+>/g,'').trim().slice(0,200),
          url: item.link || '',
          time: item.pubDate || '',
          source: src.name,
          sourceLabel: src.label,
          categories: (item.categories||[]).join(', '),
        }));
      }
    } catch(e) { console.warn(`fetchGlobalNews[${src.id}]:`, e); }
    return [];
  });

  const results = await Promise.allSettled(fetches);
  results.forEach(r => {
    if(r.status==='fulfilled' && r.value) allItems.push(...r.value);
  });

  // 过滤: 只保留政治/经济相关新闻
  const filtered = allItems.filter(item => {
    const text = `${item.title} ${item.description} ${item.categories}`;
    return GLOBAL_NEWS_KEYWORDS.test(text);
  });

  // 按时间排序(最新优先)，去重(标题相似度)
  filtered.sort((a,b) => new Date(b.time) - new Date(a.time));
  const seen = new Set();
  globalNews = [];
  for(const item of filtered){
    const key = item.title.toLowerCase().replace(/[^a-z0-9]/g,'').slice(0,40);
    if(!seen.has(key) && globalNews.length < 30){
      seen.add(key);
      // 英文情绪分析
      const t = `${item.title} ${item.description}`.toLowerCase();
      const bullEn = ['growth','surge','rally','gain','optimis','boost','strong','recover','rise','soar','boom','expand','record high','upturn','bullish'];
      const bearEn = ['crash','fall','drop','decline','recession','crisis','war','conflict','sanctions','tariff','inflation','fear','risk','slump','plunge','downturn','bearish','threat','turmoil','collapse','uncertainty'];
      let bs=0, brs=0;
      bullEn.forEach(w=>{ if(t.includes(w)) bs++; });
      bearEn.forEach(w=>{ if(t.includes(w)) brs++; });
      item.sentiment = bs>brs ? 'bull' : brs>bs ? 'bear' : 'neutral';
      item.timeFormatted = item.time ? new Date(item.time).toLocaleString('zh-CN',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
      globalNews.push(item);
    }
  }

  _globalNewsLoading = false;
  console.log(`[GlobalNews] Fetched ${allItems.length} → filtered ${globalNews.length} political/economic items`);
}

let _gnTranslating = false;
async function translateGlobalNews(){
  if(!globalNews.length || _gnTranslating) return;
  if(globalNews[0].titleCN) return;
  // 实时读取key，因为页面初始化时可能还没设置
  const key = _aiKey || getStoredApiKey() || '';
  if(!key){ console.warn('[GlobalNews] 无API Key，跳过翻译'); return; }
  _gnTranslating = true;
  const titles = globalNews.slice(0,30).map((n,i)=>`${i+1}. ${n.title}`).join('\n');
  const model = AI_ENGINES[0]?.model || 'deepseek-ai/DeepSeek-V3';
  try {
    console.log('[GlobalNews] 开始翻译', globalNews.length, '条新闻, model=', model, 'apiBase=', _apiBase);
    // 确保_aiKey有值
    if(!_aiKey) _aiKey = getStoredApiKey() || '';
    const resp = await callAI(model, '你是专业的新闻翻译员，请将英文新闻标题逐条翻译为简洁准确的中文，每条一行，保持编号。', `请将以下英文新闻标题逐条翻译为中文，保持编号格式(如 1. xxx)，每条一行，只输出翻译，不加解释：\n\n${titles}`, 0.3);
    console.log('[GlobalNews] 翻译API返回:', resp?.slice(0,200));
    if(resp){
      const lines = resp.trim().split('\n').filter(l=>l.trim());
      let matched = 0;
      lines.forEach(line=>{
        const m = line.match(/^(\d+)[\.\.\uff0e、]\s*(.+)/);
        if(m){
          const idx = parseInt(m[1]) - 1;
          if(idx>=0 && idx<globalNews.length){ globalNews[idx].titleCN = m[2].trim(); matched++; }
        }
      });
      console.log(`[GlobalNews] 翻译完成: ${matched}/${globalNews.length} 条`);
    }
  } catch(e){ console.warn('[GlobalNews] 翻译失败:', e.message||e); }
  _gnTranslating = false;
}

function getGlobalNewsSentiment(){
  if(!globalNews.length) return { score:50, label:'无数据', bullCount:0, bearCount:0, total:0 };
  const bullCount = globalNews.filter(n=>n.sentiment==='bull').length;
  const bearCount = globalNews.filter(n=>n.sentiment==='bear').length;
  const total = globalNews.length;
  const raw = 50 + (bullCount - bearCount) / total * 50;
  const score = Math.max(0, Math.min(100, Math.round(raw)));
  let label = '中性';
  if(score >= 70) label = '国际偏乐观';
  else if(score >= 58) label = '略偏正面';
  else if(score <= 30) label = '国际偏悲观';
  else if(score <= 42) label = '略偏负面';
  return { score, label, bullCount, bearCount, total };
}

async function summarizeGlobalNewsAI(){
  if(!globalNews.length) return;
  if(globalNewsSummary) return;
  // 实时读取key
  if(!_aiKey) _aiKey = getStoredApiKey() || '';
  if(!_aiKey){ console.warn('[GlobalNews] 无API Key，跳过AI摘要'); return; }
  const headlines = globalNews.slice(0,20).map((n,i)=>`${i+1}. [${n.source}] ${n.title}${n.description?' — '+n.description.slice(0,80):''}`).join('\n');
  const prompt = `你是一位资深国际政治经济分析师，专注于全球宏观形势对中国资本市场的影响分析。

以下是今日全球主要新闻媒体(华尔街日报、纽约时报、BBC、CNN、CNBC、卫报等)的最新政治经济类新闻标题摘要:

${headlines}

请完成以下任务(用中文回答):
1. 【国际形势概览】用3-4句话概括当前全球政治经济主要动态
2. 【关键事件】列出3-5个最重要的国际事件，每个事件一句话描述
3. 【对A股/中国市场影响】分析这些国际新闻对中国股市、基金市场可能的影响:
   - 利好因素(如有)
   - 利空因素(如有)
   - 受影响的行业/板块
4. 【投资建议】基于国际形势，给出2-3条具体的基金投资操作建议
5. 【情绪评分】给出整体国际环境对中国市场的影响评分(0-100，50为中性，>50偏正面)

请严格按以下JSON格式返回(不要包含markdown代码块标记):
{"overview":"...","keyEvents":["事件1","事件2","事件3"],"impact":{"positive":["..."],"negative":["..."],"sectors":["行业1","行业2"]},"advice":["建议1","建议2"],"score":60}`;

  const model = AI_ENGINES[0]?.model || 'deepseek-ai/DeepSeek-V3';
  try {
    console.log('[GlobalNews] 开始AI摘要, model=', model);
    const resp = await callAI(model, '你是一位资深国际政治经济分析师。请严格按JSON格式返回分析结果，不要包含markdown代码块。', prompt, 0.5);
    console.log('[GlobalNews] AI摘要返回:', resp?.slice(0,300));
    if(resp){
      let parsed;
      // 清理markdown代码块标记
      let cleaned = resp.replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();
      try { parsed = JSON.parse(cleaned); } catch(e) {
        // 尝试提取JSON
        const m = cleaned.match(/\{[\s\S]*\}/);
        if(m) try{ parsed = JSON.parse(m[0]); }catch(e2){}
      }
      if(parsed){
        globalNewsSummary = parsed;
        console.log('[GlobalNews] AI summary generated');
      }
    }
  } catch(e) { console.warn('summarizeGlobalNewsAI:', e); }
}

function getMacroSummary(){
  // 综合宏观信号: 扩张/收缩/中性
  let signals = [];
  if(macroData.pmi?.[0]){
    const pmi = macroData.pmi[0].MAKE_INDEX;
    signals.push({ name:'PMI', value:pmi, signal: pmi>=50?'扩张':'收缩', positive:pmi>=50 });
  }
  if(macroData.cpi?.[0]){
    const cpi = macroData.cpi[0].NATIONAL_SAME;
    signals.push({ name:'CPI', value:cpi+'%', signal: cpi>3?'通胀压力':cpi<0?'通缩风险':'温和', positive:cpi>=0&&cpi<=3 });
  }
  if(macroData.ppi?.[0]){
    const ppi = macroData.ppi[0].BASE_SAME;
    signals.push({ name:'PPI', value:ppi+'%', signal: ppi>0?'工业品涨价':'工业品降价', positive:ppi>-1 });
  }
  if(macroData.m2?.[0]){
    const m2 = macroData.m2[0].BASIC_CURRENCY_SAME;
    signals.push({ name:'M2增速', value:m2+'%', signal: m2>10?'流动性宽松':m2<8?'流动性偏紧':'适中', positive:m2>=8 });
  }
  if(macroData.gdp?.[0]){
    const gdp = macroData.gdp[0].SUM_SAME;
    signals.push({ name:'GDP', value:gdp+'%', signal: gdp>=5?'稳健增长':gdp>=4?'增速放缓':'增速偏低', positive:gdp>=5 });
  }
  const positiveCount = signals.filter(s=>s.positive).length;
  const overallSignal = positiveCount >= 4 ? '宏观偏暖' : positiveCount >= 2 ? '宏观中性' : '宏观偏冷';
  return { signals, overallSignal, positiveCount };
}

function getCapFlowSummary(){
  if(!sectorCapFlow.length) return { topInflow:[], topOutflow:[], netTotal:0 };
  const sorted = [...sectorCapFlow].sort((a,b)=>(b.mainNet||0)-(a.mainNet||0));
  const topInflow = sorted.filter(s=>s.mainNet>0).slice(0,5);
  const topOutflow = sorted.filter(s=>s.mainNet<0).slice(-5).reverse();
  const netTotal = sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0),0);
  return { topInflow, topOutflow, netTotal };
}

async function fetchAllDataIntel(){
  await Promise.allSettled([
    fetchMacroData(),
    fetchSectorCapFlow(),
    fetchNewsHeadlines(),
    fetchGlobalNews(),
  ]);
  _dataIntelLoaded = true;
  // 异步触发国际新闻AI摘要(不阻塞主流程)
  if(globalNews.length > 0){
    translateGlobalNews().then(()=>{
      summarizeGlobalNewsAI();
    });
  }
}

// ==================== RL BRAIN: DEEP Q-NETWORK ====================
// 纯JavaScript实现的强化学习交易大脑，无外部依赖
// 算法: Double DQN + Experience Replay + Target Network + Adam Optimizer
// 状态空间: 15维 (动量×4 + 波动率×2 + RSI + MACD + MA + 回撤 + 持仓 + PnL + 宏观 + 舆情 + 资金)
// 动作空间: 3 (持有/买入/卖出)
// 奖励设计: 资产增值(+) · 亏损(-) · 回撤惩罚(-) · 过度交易(-)

// --- Math Utilities ---
function rlRand(scale){
  const u1=Math.random(),u2=Math.random();
  return Math.sqrt(-2*Math.log(u1||1e-10))*Math.cos(2*Math.PI*u2)*scale;
}
function rlClip(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function rlArgmax(arr){let m=0;for(let i=1;i<arr.length;i++)if(arr[i]>arr[m])m=i;return m;}
function rlSoftmax(arr){
  const mx=Math.max(...arr);
  const ex=arr.map(v=>Math.exp(v-mx));
  const s=ex.reduce((a,b)=>a+b,0);
  return ex.map(v=>v/s);
}

// --- SumTree for Prioritized Experience Replay (PER) ---
class SumTree{
  constructor(cap){
    this.cap=cap;
    this.tree=new Float64Array(2*cap-1);
    this.data=new Array(cap).fill(null);
    this.size=0;this.wp=0;
  }
  _propagate(i,d){while(i>0){i=Math.floor((i-1)/2);this.tree[i]+=d;}}
  update(i,p){const d=p-this.tree[i];this.tree[i]=p;this._propagate(i,d);}
  add(p,data){
    const i=this.wp+this.cap-1;
    this.data[this.wp]=data;
    this.update(i,p);
    this.wp=(this.wp+1)%this.cap;
    if(this.size<this.cap)this.size++;
  }
  get(s){
    let i=0;
    while(i<this.cap-1){
      const l=2*i+1,r=l+1;
      if(s<=this.tree[l])i=l;
      else{s-=this.tree[l];i=r;}
    }
    return{idx:i,p:this.tree[i],data:this.data[i-this.cap+1]};
  }
  total(){return this.tree[0];}
}

// --- Neural Network (Adam Optimizer, He Init, Huber Loss, Gradient Clipping) ---
class RLNetwork{
  constructor(sizes){
    this.sizes=sizes;
    this.nL=sizes.length-1;
    this.W=[];this.b=[];
    this.mW=[];this.vW=[];this.mb=[];this.vb=[];
    this.t=0;
    for(let i=0;i<this.nL;i++){
      const inS=sizes[i],outS=sizes[i+1];
      const scale=Math.sqrt(2.0/inS);
      const w=new Float32Array(outS*inS);
      for(let k=0;k<w.length;k++)w[k]=rlRand(scale);
      this.W.push(w);
      this.b.push(new Float32Array(outS));
      this.mW.push(new Float32Array(outS*inS));
      this.vW.push(new Float32Array(outS*inS));
      this.mb.push(new Float32Array(outS));
      this.vb.push(new Float32Array(outS));
    }
  }
  forward(input){
    let a=Float32Array.from(input);
    this._c=[{a}];
    for(let i=0;i<this.nL;i++){
      const inS=this.sizes[i],outS=this.sizes[i+1];
      const z=new Float32Array(outS);
      for(let r=0;r<outS;r++){
        let s=this.b[i][r];
        const off=r*inS;
        for(let c=0;c<inS;c++)s+=this.W[i][off+c]*a[c];
        z[r]=s;
      }
      if(i<this.nL-1){
        a=new Float32Array(outS);
        for(let r=0;r<outS;r++)a[r]=z[r]>0?z[r]:0; // ReLU
      } else {
        a=z; // linear output
      }
      this._c.push({z,a});
    }
    return a;
  }
  trainStep(input,target,lr){
    const out=this.forward(input);
    const n=out.length;
    let loss=0;
    let dA=new Float32Array(n);
    for(let i=0;i<n;i++){
      const d=out[i]-target[i];
      if(Math.abs(d)<1){loss+=0.5*d*d;dA[i]=d;} // Huber loss
      else{loss+=Math.abs(d)-0.5;dA[i]=d>0?1:-1;}
    }
    this.t++;
    const b1=0.9,b2=0.999,eps=1e-8;
    const maxGrad=1.0; // gradient clipping threshold
    for(let l=this.nL-1;l>=0;l--){
      const inS=this.sizes[l],outS=this.sizes[l+1];
      const aIn=this._c[l].a;
      // ReLU gradient for hidden layers
      if(l<this.nL-1){
        const z=this._c[l+1].z;
        for(let i=0;i<outS;i++)if(z[i]<=0)dA[i]=0;
      }
      // Gradient clipping for stability
      for(let i=0;i<outS;i++)dA[i]=Math.max(-maxGrad,Math.min(maxGrad,dA[i]));
      // Weight gradients + Adam update
      for(let i=0;i<outS;i++){
        const off=i*inS;
        for(let j=0;j<inS;j++){
          const g=dA[i]*aIn[j];
          const k=off+j;
          this.mW[l][k]=b1*this.mW[l][k]+(1-b1)*g;
          this.vW[l][k]=b2*this.vW[l][k]+(1-b2)*g*g;
          const mh=this.mW[l][k]/(1-Math.pow(b1,this.t));
          const vh=this.vW[l][k]/(1-Math.pow(b2,this.t));
          this.W[l][k]-=lr*mh/(Math.sqrt(vh)+eps);
        }
        // Bias Adam
        this.mb[l][i]=b1*this.mb[l][i]+(1-b1)*dA[i];
        this.vb[l][i]=b2*this.vb[l][i]+(1-b2)*dA[i]*dA[i];
        const mbh=this.mb[l][i]/(1-Math.pow(b1,this.t));
        const vbh=this.vb[l][i]/(1-Math.pow(b2,this.t));
        this.b[l][i]-=lr*mbh/(Math.sqrt(vbh)+eps);
      }
      // Propagate gradient
      if(l>0){
        const dAPrev=new Float32Array(inS);
        for(let j=0;j<inS;j++){
          let s=0;
          for(let i=0;i<outS;i++)s+=this.W[l][i*inS+j]*dA[i];
          dAPrev[j]=s;
        }
        dA=dAPrev;
      }
    }
    return loss;
  }
  clone(){
    const net=new RLNetwork(this.sizes);
    for(let i=0;i<this.nL;i++){
      net.W[i]=new Float32Array(this.W[i]);
      net.b[i]=new Float32Array(this.b[i]);
    }
    return net;
  }
  toJSON(){
    return{sizes:this.sizes,W:this.W.map(w=>Array.from(w)),b:this.b.map(b=>Array.from(b)),t:this.t};
  }
  static fromJSON(d){
    const net=new RLNetwork(d.sizes);
    for(let i=0;i<net.nL;i++){
      net.W[i]=Float32Array.from(d.W[i]);
      net.b[i]=Float32Array.from(d.b[i]);
    }
    net.t=d.t||0;
    return net;
  }
}

// --- Dueling Network (V + A streams) ---
class DuelingNetwork{
  constructor(stateSize,actionSize,hiddenSizes){
    this.stateSize=stateSize;
    this.actionSize=actionSize;
    // Raw output: V(1) + A(actionSize) = 1 + actionSize
    this.net=new RLNetwork([stateSize,...(hiddenSizes||[128,64]),1+actionSize]);
  }
  forward(input){
    const raw=this.net.forward(input);
    this._lastRaw=raw;
    return this._dueling(raw);
  }
  _dueling(raw){
    const n=this.actionSize;
    const V=raw[0];
    let meanA=0;
    for(let i=0;i<n;i++)meanA+=raw[1+i];
    meanA/=n;
    const Q=new Float32Array(n);
    for(let i=0;i<n;i++)Q[i]=V+raw[1+i]-meanA;
    return Q;
  }
  trainDueling(input,qTarget,lr){
    // Forward to get current Q and raw outputs
    const Q=this.forward(input);
    const raw=this._lastRaw;
    const n=this.actionSize;
    // Convert Q-space targets to raw targets via Dueling gradient routing
    const rawTarget=Float32Array.from(raw);
    for(let a=0;a<n;a++){
      const delta=Q[a]-qTarget[a];
      if(Math.abs(delta)<1e-10)continue;
      rawTarget[0]-=delta;
      rawTarget[1+a]-=delta*(1-1/n);
      for(let j=0;j<n;j++){
        if(j!==a)rawTarget[1+j]+=delta/n;
      }
    }
    return this.net.trainStep(input,rawTarget,lr);
  }
  clone(){
    const dn=new DuelingNetwork(this.stateSize,this.actionSize,[]);
    dn.net=this.net.clone();
    return dn;
  }
  toJSON(){
    return{stateSize:this.stateSize,actionSize:this.actionSize,net:this.net.toJSON()};
  }
  static fromJSON(d){
    const dn=new DuelingNetwork(d.stateSize,d.actionSize,[]);
    dn.net=RLNetwork.fromJSON(d.net);
    return dn;
  }
}

// --- Rainbow DQN Agent (Dueling + Double + PER + N-Step + Bootstrapped Ensemble) ---
class DQNAgent{
  constructor(stateSize,actionSize){
    this.stateSize=stateSize;
    this.actionSize=actionSize;
    this.nHeads=RL_ENSEMBLE_K;
    // Dueling Networks: K ensemble heads
    this.qNets=[];this.targetNets=[];
    for(let h=0;h<this.nHeads;h++){
      const net=new DuelingNetwork(stateSize,actionSize,[128,64]);
      this.qNets.push(net);
      this.targetNets.push(net.clone());
    }
    // Shared Prioritized Experience Replay
    this.maxMemory=20000;
    this.perTree=new SumTree(this.maxMemory);
    this.perAlpha=0.6;
    this.perBeta=0.4;
    this.perBetaInc=0.001;
    this.perEps=0.01;
    this.maxPriority=1.0;
    // N-step returns
    this.nStep=3;
    this.nStepBuf=[];
    // Training hyperparams
    this.batchSize=32;
    this.gamma=0.99;
    this.epsilon=1.0;
    this.epsilonMin=0.01;
    this.epsilonDecay=0.995;
    this.lr=0.0005;
    this.lrMin=0.00005;
    this.lrDecay=0.9999;
    this.targetUpdateFreq=500;
    this.trainSteps=0;
    this.totalReward=0;
    this.bootstrapP=0.8; // Bernoulli mask probability
  }
  act(state,explore=true){
    if(explore&&Math.random()<this.epsilon)return Math.floor(Math.random()*this.actionSize);
    // Thompson sampling: use random head for exploration diversity
    const h=Math.floor(Math.random()*this.nHeads);
    return rlArgmax(this.qNets[h].forward(state));
  }
  getEnsembleQ(state){
    // Compute Q-values from all heads + uncertainty
    const qAll=[];
    const qSum=new Float32Array(this.actionSize);
    for(let h=0;h<this.nHeads;h++){
      const q=Array.from(this.qNets[h].forward(state));
      qAll.push(q);
      for(let i=0;i<this.actionSize;i++)qSum[i]+=q[i];
    }
    const qMean=Array.from(qSum).map(v=>v/this.nHeads);
    // Epistemic uncertainty = std across heads
    const qStd=new Array(this.actionSize).fill(0);
    for(let i=0;i<this.actionSize;i++){
      const vals=qAll.map(q=>q[i]);
      const mu=qMean[i];
      qStd[i]=Math.sqrt(vals.reduce((s,v)=>s+(v-mu)**2,0)/this.nHeads);
    }
    // Head votes (action each head picks)
    const votes=qAll.map(q=>rlArgmax(q));
    return{qMean,qStd,qAll,votes};
  }
  getQValues(state){return this.getEnsembleQ(state).qMean;}
  remember(s,a,r,s2,done,immediate=false){
    if(immediate){
      this.perTree.add(this.maxPriority,{s,a,r,s2,done,gamma:this.gamma});
      return;
    }
    this.nStepBuf.push({s,a,r,s2,done});
    if(this.nStepBuf.length>=this.nStep||done){
      let R=0;
      for(let i=this.nStepBuf.length-1;i>=0;i--)R=this.nStepBuf[i].r+this.gamma*R;
      const first=this.nStepBuf[0],last=this.nStepBuf[this.nStepBuf.length-1];
      this.perTree.add(this.maxPriority,{
        s:first.s,a:first.a,r:R,s2:last.s2,done:last.done,
        gamma:Math.pow(this.gamma,this.nStepBuf.length)
      });
      this.nStepBuf.shift();
      if(done)this.nStepBuf=[];
    }
  }
  replay(){
    if(this.perTree.size<this.batchSize*2)return 0;
    let totalLoss=0,trainedCount=0;
    this.perBeta=Math.min(1.0,this.perBeta+this.perBetaInc);
    const total=this.perTree.total();
    if(total<=0)return 0;
    const seg=total/this.batchSize;
    const samples=[];
    for(let i=0;i<this.batchSize;i++){
      const s=Math.random()*seg+i*seg;
      const{idx,p,data}=this.perTree.get(s);
      if(!data)continue;
      const prob=Math.max(p,1e-10)/total;
      const w=Math.pow(this.perTree.size*prob,-this.perBeta);
      samples.push({...data,treeIdx:idx,w});
    }
    if(!samples.length)return 0;
    const maxW=Math.max(...samples.map(s=>s.w));
    for(const exp of samples){
      const wn=exp.w/maxW;
      let maxTdErr=0;
      for(let h=0;h<this.nHeads;h++){
        // Bootstrapped training: each head sees ~80% of experiences
        if(Math.random()>this.bootstrapP)continue;
        const q=this.qNets[h].forward(exp.s);
        const target=new Float32Array(this.actionSize);
        for(let i=0;i<this.actionSize;i++)target[i]=q[i];
        if(exp.done){
          target[exp.a]=exp.r;
        }else{
          // Double DQN per head
          const bestA=rlArgmax(this.qNets[h].forward(exp.s2));
          const nextQ=this.targetNets[h].forward(exp.s2);
          target[exp.a]=exp.r+(exp.gamma||this.gamma)*nextQ[bestA];
        }
        const tdErr=Math.abs(target[exp.a]-q[exp.a]);
        maxTdErr=Math.max(maxTdErr,tdErr);
        totalLoss+=this.qNets[h].trainDueling(exp.s,target,this.lr*wn);
        trainedCount++;
      }
      const newP=Math.pow(maxTdErr+this.perEps,this.perAlpha);
      this.perTree.update(exp.treeIdx,newP);
      this.maxPriority=Math.max(this.maxPriority,newP);
    }
    this.trainSteps++;
    if(this.trainSteps%this.targetUpdateFreq===0){
      for(let h=0;h<this.nHeads;h++)this.targetNets[h]=this.qNets[h].clone();
    }
    if(this.epsilon>this.epsilonMin)this.epsilon*=this.epsilonDecay;
    if(this.lr>this.lrMin)this.lr*=this.lrDecay;
    return totalLoss/Math.max(1,trainedCount);
  }
  toJSON(){
    return{
      nHeads:this.nHeads,
      qNets:this.qNets.map(n=>n.toJSON()),
      epsilon:this.epsilon,trainSteps:this.trainSteps,
      totalReward:this.totalReward,lr:this.lr
    };
  }
  static fromJSON(d){
    const nH=d.nHeads||d.qNets?.length||1;
    const s0=d.qNets?d.qNets[0].stateSize:(d.qNet?.sizes?.[0]||36);
    const a0=d.qNets?d.qNets[0].actionSize:(d.qNet?.sizes?.[d.qNet.sizes.length-1]||3);
    const a=new DQNAgent(s0,a0);
    if(d.qNets){
      a.nHeads=nH;
      a.qNets=d.qNets.map(n=>DuelingNetwork.fromJSON(n));
      a.targetNets=a.qNets.map(n=>n.clone());
    }else if(d.qNet){
      // Backward compatibility: single RLNetwork → wrap as single head
      const net=new DuelingNetwork(s0,a0,[]);
      net.net=RLNetwork.fromJSON(d.qNet);
      a.nHeads=1;
      a.qNets=[net];a.targetNets=[net.clone()];
    }
    a.epsilon=d.epsilon||0.01;
    a.trainSteps=d.trainSteps||0;
    a.totalReward=d.totalReward||0;
    a.lr=d.lr||0.0005;
    return a;
  }
}

// --- Market Environment (Gym-style, 36-dim Rainbow state, Sortino reward) ---
class MarketEnv{
  constructor(navArray, code){
    this.navs=navArray;
    this._code=code||'';
    this.lookback=60;
    this.fee=0.0015;
    this.holdingDays=0;
    this._returns=[];
    this._downReturns=[];
  }
  reset(){
    this.idx=this.lookback;
    this.pos=0;
    this.entryPrice=0;
    this.portfolio=1.0;
    this.peakPf=1.0;
    this.trades=0;
    this.holdingDays=0;
    this._returns=[];
    this._downReturns=[];
    return this._state();
  }
  _state(){
    const p=[];
    for(let i=this.idx-this.lookback;i<=this.idx;i++)p.push(this.navs[i].nav);
    const cur=p[p.length-1];
    const n=p.length;
    const rets=[];
    for(let i=1;i<n;i++)rets.push((p[i]-p[i-1])/p[i-1]);
    // --- Helpers ---
    const sum=(a,k)=>{const sl=a.slice(-k);return sl.reduce((s,v)=>s+v,0);};
    const std=(a)=>{if(a.length<2)return 0;const m=a.reduce((s,v)=>s+v,0)/a.length;return Math.sqrt(a.reduce((s,v)=>s+(v-m)**2,0)/a.length);};
    const rsiCalc=(a,period)=>{const r=a.slice(-period);let g=0,l=0;r.forEach(v=>{if(v>0)g+=v;else l+=Math.abs(v);});if(!l)return 100;if(!g)return 0;return 100-100/(1+g/l);};
    const ema=(arr,period)=>{const k=2/(period+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;};
    const ma=(arr,k)=>arr.slice(-k).reduce((s,v)=>s+v,0)/Math.min(arr.length,k);
    const ret1=rets[rets.length-1]||0;
    // --- MACD ---
    const ema12=ema(p,12),ema26=ema(p,26);
    const macdVal=(ema12-ema26)/cur;
    const ret5=sum(rets,5),ret10=sum(rets,10);
    const macdHist=ret5*2-ret10;
    // --- MA deviations ---
    const ma20=ma(p,20);
    const ma60=ma(p,Math.min(60,p.length));
    // --- Bollinger Bands %B ---
    const prices20=p.slice(-20);
    const bbMa=prices20.reduce((s,v)=>s+v,0)/prices20.length;
    const bbStd=Math.sqrt(prices20.reduce((s,v)=>s+(v-bbMa)**2,0)/prices20.length);
    const bbUpper=bbMa+2*bbStd,bbLower=bbMa-2*bbStd;
    const bbPctB=bbUpper!==bbLower?(cur-bbLower)/(bbUpper-bbLower):0.5;
    // --- Drawdowns ---
    const maxP20=Math.max(...p.slice(-20));
    const maxP60=Math.max(...p);
    // --- ATR proxy & trend ---
    const atr14=rets.slice(-14).reduce((s,v)=>s+Math.abs(v),0)/14;
    const recent20=rets.slice(-20);
    const upDays=recent20.filter(r=>r>0).length;
    const trendStr=(upDays/20-0.5)*2;
    const mu20=recent20.reduce((s,v)=>s+v,0)/20;
    const sd20=std(recent20);
    const momQ=sd20>0?mu20/sd20:0;
    // --- Position info ---
    const pnl=this.pos===1?(cur-this.entryPrice)/this.entryPrice:0;
    // --- Backtest features ---
    const btR=typeof btResults!=='undefined'?btResults[this._code]:null;
    const btSharpe=btR?btR.sharpe:0;
    const btKelly=btR?btR.finalKelly:0.05;
    const btRSI=btR?.lastRSI||50;
    // === NEW: 6 advanced features [30-35] ===
    // [30] Autocorrelation lag-1 (Hurst proxy): >0=trending, <0=mean-reverting
    const r20=rets.slice(-20);
    const muR=r20.reduce((s,v)=>s+v,0)/r20.length;
    let acNum=0,acDen=0;
    for(let i=1;i<r20.length;i++){acNum+=(r20[i]-muR)*(r20[i-1]-muR);acDen+=(r20[i]-muR)**2;}
    const autoCorr=acDen>0?acNum/acDen:0;
    // [31] Volatility regime: short-term vol / long-term vol (>1=expanding)
    const vol5=std(rets.slice(-5));
    const vol60=std(rets)||0.0001;
    const volRegime=vol5/vol60;
    // [32] Return skewness (20d) - asymmetry of return distribution
    const sdR=std(r20)||0.0001;
    const skew=r20.reduce((s,v)=>s+Math.pow((v-muR)/sdR,3),0)/r20.length;
    // [33] Excess kurtosis (20d) - heavy tails = regime change risk
    const kurt=r20.reduce((s,v)=>s+Math.pow((v-muR)/sdR,4),0)/r20.length-3;
    // [34] Range position: where in 60d range (0=bottom, 1=top)
    const minP=Math.min(...p);
    const rangePos=(maxP60-minP)>0?(cur-minP)/(maxP60-minP):0.5;
    // [35] Consecutive direction streak (+1/day up, -1/day down)
    let streak=0;
    for(let i=rets.length-1;i>=Math.max(0,rets.length-10);i--){
      if(streak===0)streak=rets[i]>0?1:-1;
      else if((rets[i]>0&&streak>0)||(rets[i]<0&&streak<0))streak+=streak>0?1:-1;
      else break;
    }
    return Float32Array.from([
      rlClip(ret1*100,-5,5),                                    // [0] 1d momentum
      rlClip(sum(rets,5)*100,-15,15),                           // [1] 5d momentum
      rlClip(sum(rets,10)*100,-25,25),                          // [2] 10d momentum
      rlClip(sum(rets,20)*100,-40,40),                          // [3] 20d momentum
      rlClip(sum(rets,Math.min(60,rets.length))*100,-80,80),    // [4] 60d momentum
      rlClip(std(rets.slice(-5))*100,0,10),                     // [5] 5d volatility
      rlClip(std(rets.slice(-20))*100,0,10),                    // [6] 20d volatility
      rlClip(std(rets)*100,0,15),                               // [7] 60d volatility
      (rsiCalc(rets,14)-50)/50,                                 // [8] RSI(14)
      (rsiCalc(rets,7)-50)/50,                                  // [9] RSI(7)
      rlClip(macdVal*100,-5,5),                                 // [10] MACD
      rlClip(macdHist*100,-3,3),                                // [11] MACD histogram
      rlClip((cur-ma20)/ma20*10,-3,3),                          // [12] MA20 deviation
      rlClip((cur-ma60)/ma60*10,-5,5),                          // [13] MA60 deviation
      rlClip(bbPctB,-0.5,1.5),                                  // [14] Bollinger %B
      rlClip((cur-maxP20)/maxP20*10,-5,0),                      // [15] 20d drawdown
      rlClip((cur-maxP60)/maxP60*10,-8,0),                      // [16] 60d drawdown
      rlClip(atr14*100,0,5),                                    // [17] ATR proxy
      rlClip(trendStr,-1,1),                                    // [18] trend strength
      rlClip(momQ,-2,2),                                        // [19] momentum quality
      this.pos,                                                  // [20] position
      rlClip(pnl*10,-5,5),                                      // [21] unrealized PnL
      rlClip((this.holdingDays||0)/20,0,3),                     // [22] holding duration
      0,0,0,0,                                                   // [23-26] macro/sentiment/capital/intl
      rlClip(btSharpe,-2,3),                                    // [27] backtest Sharpe
      rlClip(btKelly*10,-1,3),                                  // [28] backtest Kelly
      (btRSI-50)/50,                                             // [29] backtest RSI
      rlClip(autoCorr,-1,1),                                    // [30] Hurst proxy (autocorrelation)
      rlClip(volRegime,0,4),                                    // [31] volatility regime
      rlClip(skew,-3,3),                                        // [32] return skewness
      rlClip(kurt,-2,10),                                       // [33] excess kurtosis
      rlClip(rangePos,0,1),                                     // [34] range position
      rlClip(streak/5,-1,1),                                    // [35] direction streak
      0,0,0,0                                                    // [36-39] portfolio: DD/cash/HHI/weight (live注入)
    ]);
  }
  step(action){
    const prev=this.navs[this.idx].nav;
    this.idx++;
    const done=this.idx>=this.navs.length-1;
    const cur=this.navs[this.idx].nav;
    const dr=(cur-prev)/prev;
    let reward=0;
    const oldPf=this.portfolio;
    if(action===1&&this.pos===0){ // BUY
      this.pos=1;this.entryPrice=cur;
      this.portfolio*=(1-this.fee);this.trades++;
      this.holdingDays=0;
      reward=-this.fee*5;
    }else if(action===2&&this.pos===1){ // SELL
      const pnl=(cur-this.entryPrice)/this.entryPrice;
      this.portfolio*=(1+pnl)*(1-this.fee);
      this.pos=0;this.entryPrice=0;this.trades++;
      const holdFactor=Math.max(1,Math.sqrt(this.holdingDays/5));
      reward=pnl*10/holdFactor;
      if(pnl>0.03)reward+=0.15;
      if(pnl>0.08)reward+=0.25;
      if(pnl<-0.03)reward-=0.1;
      if(pnl<-0.08)reward-=0.3;
      this.holdingDays=0;
    }else if(action===1&&this.pos===1){
      reward=dr*3;
      this.holdingDays++;
    }else if(action===2&&this.pos===0){
      reward=-Math.abs(dr)*1.5;
    }else if(this.pos===1){
      reward=dr*5;
      this.holdingDays++;
    }else{
      reward=dr<0?Math.abs(dr)*3:-dr*0.5;
    }
    // --- Track returns for Sortino ---
    const stepReturn=oldPf>0?(this.portfolio-oldPf)/oldPf:0;
    this._returns.push(stepReturn);
    if(stepReturn<0)this._downReturns.push(stepReturn);
    // --- Rolling Sortino (only penalize downside vol) ---
    if(this._returns.length>=20&&this._returns.length%10===0){
      const rc=this._returns.slice(-20);
      const mu=rc.reduce((s,v)=>s+v,0)/rc.length;
      const downRc=rc.filter(r=>r<0);
      const downDev=downRc.length>1?Math.sqrt(downRc.reduce((s,v)=>s+v*v,0)/downRc.length):0.0001;
      const sortino=downDev>0?mu/downDev:0;
      reward+=rlClip(sortino*0.2,-0.15,0.3);
    }
    // --- Graduated drawdown penalty ---
    this.peakPf=Math.max(this.peakPf,this.portfolio);
    const mdd=(this.portfolio-this.peakPf)/this.peakPf;
    if(mdd<-0.03)reward-=0.02;
    if(mdd<-0.05)reward-=0.05;
    if(mdd<-0.10)reward-=0.15;
    if(mdd<-0.20)reward-=0.3;
    // --- Overtrade penalty ---
    const tradeRate=this.trades/(this.idx-this.lookback+1);
    if(tradeRate>0.25)reward-=0.03;
    if(tradeRate>0.4)reward-=0.05;
    return{state:this._state(),reward,done};
  }
}

// --- RL Training Pipeline (Rainbow: Dueling+Double+PER+N-Step+Ensemble+Curriculum) ---
class RLTrainer{
  constructor(){
    this.agent=null;
    this.isTraining=false;
    this.episode=0;
    this.maxEpisodes=80;
    this.metrics={rewards:[],losses:[],portfolios:[],winRate:0,avgReturn:0,sharpe:0,sortino:0,bestReturn:-Infinity,totalTrades:0,mdd:0};
    this._data=[];
  }
  prepare(){
    this._data=[];
    for(const code of Object.keys(fundHistoryData)){
      const hd=fundHistoryData[code];
      if(!hd||!hd.navs||hd.navs.length<80)continue;
      const navArr=hd.navs.map(n=>({date:n.date||n[0],nav:parseFloat(n.nav!==undefined?n.nav:n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length<80)continue;
      // Pre-compute volatility for curriculum sorting
      const rets=[];
      for(let i=1;i<navArr.length;i++)rets.push((navArr[i].nav-navArr[i-1].nav)/navArr[i-1].nav);
      const vol=rets.length>1?Math.sqrt(rets.reduce((s,v)=>s+v*v,0)/rets.length):0;
      this._data.push({code,navs:navArr,vol});
    }
    // Sort by volatility ascending (curriculum: easy → hard)
    this._data.sort((a,b)=>a.vol-b.vol);
    this.agent=new DQNAgent(RL_STATE_SIZE,RL_ACTION_SIZE);
    this.metrics={rewards:[],losses:[],portfolios:[],winRate:0,avgReturn:0,sharpe:0,sortino:0,bestReturn:-Infinity,totalTrades:0,mdd:0};
    this.episode=0;
    return this._data.length;
  }
  async train(onProgress){
    if(!this._data.length)return;
    this.isTraining=true;
    for(let ep=0;ep<this.maxEpisodes&&this.isTraining;ep++){
      this.episode=ep;
      let epR=0,epL=0,epSteps=0,epPfs=[],epTrades=0,epMDD=0;
      // Curriculum: first 30% episodes use easy data (low vol), then all data
      const curProgress=ep/this.maxEpisodes;
      let trainData;
      if(curProgress<0.3){
        // Use bottom 60% by volatility
        const cutoff=Math.max(1,Math.ceil(this._data.length*0.6));
        trainData=[...this._data.slice(0,cutoff)].sort(()=>Math.random()-0.5);
      }else{
        trainData=[...this._data].sort(()=>Math.random()-0.5);
      }
      for(const{code,navs}of trainData){
        const env=new MarketEnv(navs,code);
        let state=env.reset(),done=false;
        while(!done){
          const action=this.agent.act(state,true);
          const r=env.step(action);
          this.agent.remember(state,action,r.reward,r.state,r.done);
          state=r.state;done=r.done;
          epR+=r.reward;epSteps++;
          if(epSteps%4===0&&this.agent.perTree.size>=this.agent.batchSize*2){
            epL+=this.agent.replay();
          }
        }
        epPfs.push(env.portfolio);
        epTrades+=env.trades;
        const envMDD=(env.portfolio-env.peakPf)/env.peakPf;
        epMDD=Math.min(epMDD,envMDD);
      }
      const avgPf=epPfs.reduce((s,v)=>s+v,0)/epPfs.length;
      const avgRet=(avgPf-1)*100;
      const wr=epPfs.filter(p=>p>1).length/epPfs.length*100;
      this.metrics.rewards.push(epR/Math.max(1,epSteps));
      this.metrics.losses.push(epL/Math.max(1,Math.floor(epSteps/4)));
      this.metrics.portfolios.push(avgRet);
      this.metrics.winRate=wr;
      this.metrics.avgReturn=avgRet;
      this.metrics.totalTrades=epTrades;
      this.metrics.mdd=Math.round(epMDD*10000)/100;
      if(avgRet>this.metrics.bestReturn)this.metrics.bestReturn=avgRet;
      const rc=this.metrics.portfolios.slice(-10);
      if(rc.length>=3){
        const mu=rc.reduce((s,v)=>s+v,0)/rc.length;
        const sd=Math.sqrt(rc.reduce((s,v)=>s+(v-mu)**2,0)/rc.length);
        this.metrics.sharpe=sd>0?mu/sd:0;
        // Sortino: only downside deviation
        const downRc=rc.filter(r=>r<0);
        const downDev=downRc.length>1?Math.sqrt(downRc.reduce((s,v)=>s+v*v,0)/downRc.length):0.01;
        this.metrics.sortino=downDev>0?mu/downDev:0;
      }
      if(onProgress)onProgress(ep+1,this.maxEpisodes,this.metrics);
      if(ep%2===0)await new Promise(r=>setTimeout(r,0));
    }
    this.isTraining=false;
    this.agent.totalReward=this.metrics.rewards.reduce((s,v)=>s+v,0);
    this.saveModel();
    return this.metrics;
  }
  stop(){this.isTraining=false;}
  generateSignals(){
    if(!this.agent)return{};
    const signals={};
    const pCodes = getAllPortfolioCodes();
    const codes=[...new Set([...holdings.map(h=>h.code),...watchlist.map(w=>w.code),...pCodes])];
    for(const code of codes){
      const hd=fundHistoryData[code];
      if(!hd||!hd.navs||hd.navs.length<65)continue;
      const navArr=hd.navs.map(n=>({date:n.date||n[0],nav:parseFloat(n.nav!==undefined?n.nav:n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length<65)continue;
      const env=new MarketEnv(navArr,code);
      env.idx=navArr.length-1;
      const simPos=simPortfolio?.positions?.find(p=>p.code===code);
      env.pos=simPos?1:0;
      if(simPos)env.entryPrice=simPos.avgCost;
      const state=env._state();
      // Inject live signals (indices 23-26)
      if(_dataIntelLoaded){
        const ds=generateDataSignal();
        state[23]=rlClip((ds.score-50)/25,-2,2);
        state[24]=rlClip((newsSentiment.score-50)/25,-2,2);
        const cn=sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0),0);
        state[25]=rlClip(cn/1e10,-2,2);
        if(typeof globalNews!=='undefined'&&globalNews.length>0){
          const gSent=typeof getGlobalNewsSentiment==='function'?getGlobalNewsSentiment():{score:50};
          state[26]=rlClip((gSent.score-50)/25,-2,2);
        }
      }
      // Inject portfolio-level features [36-39]
      const _pRisk=getPortfolioRiskMetrics();
      state[36]=rlClip(_pRisk.dd*10,-5,0);           // portfolio drawdown
      state[37]=rlClip(_pRisk.cashRatio,0,1);         // cash ratio
      state[38]=rlClip(_pRisk.hhi*4,0,2);             // concentration HHI
      state[39]=rlClip((_pRisk.fundWeight[code]||0)*4,0,2); // this fund's weight
      // Ensemble Q-values with uncertainty
      const ens=this.agent.getEnsembleQ(state);
      const action=rlArgmax(ens.qMean);
      const probs=rlSoftmax(ens.qMean);
      // Conviction from ensemble agreement
      const voteCounts=[0,0,0];
      ens.votes.forEach(v=>voteCounts[v]++);
      const maxVotes=Math.max(...voteCounts);
      const majorityAction=voteCounts.indexOf(maxVotes);
      const agreement=maxVotes/ens.votes.length; // 1.0=unanimous, 0.33=split
      // Uncertainty = mean std across actions
      const avgUncertainty=ens.qStd.reduce((s,v)=>s+v,0)/ens.qStd.length;
      // Conviction level for position sizing
      let conviction,positionPct;
      if(agreement>=0.99){conviction='强';positionPct=100;}
      else if(agreement>=0.66){conviction='中';positionPct=60;}
      else{conviction='弱';positionPct=30;}
      signals[code]={
        action:majorityAction,
        actionName:RL_ACTION_NAMES[majorityAction],
        confidence:Math.round(probs[majorityAction]*100),
        conviction,
        positionPct,
        uncertainty:avgUncertainty,
        qValues:ens.qMean,
        qStd:ens.qStd,
        headVotes:ens.votes,
        probabilities:probs
      };
    }
    _rlSignals=signals;
    return signals;
  }
  saveModel(){
    if(!this.agent)return;
    try{
      localStorage.setItem(RL_STORAGE_KEY,JSON.stringify({
        agent:this.agent.toJSON(),
        metrics:this.metrics,
        episode:this.episode,
        timestamp:Date.now()
      }));
      _rlModelLoaded=true;
      console.log('RL模型已保存, 训练步数:',this.agent.trainSteps);
    }catch(e){console.warn('RL模型保存失败:',e);}
  }
  loadModel(){
    try{
      const raw=localStorage.getItem(RL_STORAGE_KEY);
      if(!raw)return false;
      const d=JSON.parse(raw);
      // 检查模型维度是否匹配(v3: Dueling+Ensemble 36维)
      const savedSize = d.agent?.qNets?.[0]?.stateSize || d.agent?.qNet?.sizes?.[0] || 0;
      if(savedSize !== RL_STATE_SIZE){
        console.warn(`RL模型维度不匹配(保存:${savedSize} 当前:${RL_STATE_SIZE})，需重新训练`);
        localStorage.removeItem(RL_STORAGE_KEY);
        return false;
      }
      this.agent=DQNAgent.fromJSON(d.agent);
      this.metrics=d.metrics||this.metrics;
      this.episode=d.episode||0;
      _rlModelLoaded=true;
      console.log('RL模型已加载, 训练步数:',this.agent.trainSteps);
      return true;
    }catch(e){console.warn('RL模型加载失败:',e);return false;}
  }
}

// ==================== HISTORICAL DATA & TREND ANALYSIS ====================
async function fetchFundHistory(code){
  // 获取基金历史净值（近1年，约250个交易日）
  // 优先使用JSONP（浏览器CORS会阻止fetch请求到eastmoney API）
  try{
    const data = await jsonpFetch(
      `https://api.fund.eastmoney.com/f10/lsjz?fundCode=${code}&pageIndex=1&pageSize=250`,
      { callbackParam: 'callback', timeout: 12000 }
    );
    if(data?.Data?.LSJZList){
      const navs = data.Data.LSJZList
        .map(d=>({date:d.FSRQ, nav:parseFloat(d.DWJZ)}))
        .filter(d=>!isNaN(d.nav))
        .reverse(); // 最早在前
      if(navs.length > 0) return navs;
    }
  }catch(e){
    console.warn(`[History] JSONP主请求失败(${code}):`, e.message);
  }
  // 备用: 交易所基金走kline接口
  try{
    const data = await jsonpFetch(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${getSecidForFund(code)}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=1&beg=0&end=20500101&lmt=250`);
    if(data?.data?.klines){
      return data.data.klines.map(k=>{
        const parts=k.split(',');
        return {date:parts[0], nav:parseFloat(parts[1])};
      }).filter(d=>!isNaN(d.nav));
    }
  }catch(e2){ console.warn(`[History] JSONP备用请求失败(${code}):`, e2.message); }
  return null;
}

function getSecidForFund(code){
  // 基金代码映射到secid（上交所1.xxx，深交所0.xxx）
  const first = code.charAt(0);
  if(first==='5'||first==='6') return `1.${code}`;
  return `0.${code}`;
}

function analyzeTrend(navs){
  if(!navs || navs.length < 10) return null;

  const len = navs.length;
  const latest = navs[len-1].nav;
  const prices = navs.map(n=>n.nav);

  // 各周期涨跌幅
  const pct = (cur,prev) => prev>0 ? ((cur-prev)/prev*100) : 0;
  const chg5d = len>5 ? pct(latest, prices[len-6]) : 0;    // 近5日
  const chg20d = len>20 ? pct(latest, prices[len-21]) : 0;  // 近1月
  const chg60d = len>60 ? pct(latest, prices[len-61]) : 0;  // 近3月
  const chg120d = len>120 ? pct(latest, prices[len-121]) : 0; // 近6月
  const chg250d = len>240 ? pct(latest, prices[0]) : 0;      // 近1年

  // 均线
  const ma = (n) => {
    if(len<n) return latest;
    let sum=0; for(let i=len-n;i<len;i++) sum+=prices[i];
    return sum/n;
  };
  const ma5 = ma(5), ma20 = ma(20), ma60 = ma(60);

  // 近1年最高/最低
  const high1y = Math.max(...prices);
  const low1y = Math.min(...prices);
  const drawdownFromHigh = pct(latest, high1y); // 距高点回撤(负数)
  const reboundFromLow = pct(latest, low1y);     // 距低点反弹

  // 趋势判断
  let trendDir = 'sideways';
  let trendScore = 0; // -100~100

  // 均线多头排列: ma5>ma20>ma60 → 强上升
  if(ma5>ma20 && ma20>ma60) trendScore += 30;
  else if(ma5<ma20 && ma20<ma60) trendScore -= 30;

  // 中期涨幅
  if(chg60d > 8) trendScore += 25;
  else if(chg60d > 3) trendScore += 15;
  else if(chg60d < -8) trendScore -= 25;
  else if(chg60d < -3) trendScore -= 15;

  // 长期趋势
  if(chg250d > 15) trendScore += 20;
  else if(chg250d > 5) trendScore += 10;
  else if(chg250d < -15) trendScore -= 20;
  else if(chg250d < -5) trendScore -= 10;

  // 价格位置
  if(latest > ma20 && latest > ma60) trendScore += 10;
  else if(latest < ma20 && latest < ma60) trendScore -= 10;

  if(trendScore >= 25) trendDir = 'strong_up';
  else if(trendScore >= 10) trendDir = 'up';
  else if(trendScore <= -25) trendDir = 'strong_down';
  else if(trendScore <= -10) trendDir = 'down';

  // 波段位置判断
  let swingPos = 'mid'; // 当前处于波段的什么位置
  if(chg5d <= -3) swingPos = 'deep_dip';      // 5日暴跌——深度回调
  else if(chg5d <= -1.5) swingPos = 'dip';     // 5日下跌——回调中
  else if(chg5d >= 3) swingPos = 'surge';       // 5日暴涨——冲高
  else if(chg5d >= 1.5) swingPos = 'rally';     // 5日上涨——反弹中

  // 波段建议
  let swingAdvice = '';
  if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = '趋势向上+短期回调，波段买入机会！';
  } else if((trendDir==='strong_up'||trendDir==='up') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = '趋势向上+短期冲高，可考虑部分止盈';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='surge'||swingPos==='rally')){
    swingAdvice = '趋势向下+短期反弹，建议逢高减仓';
  } else if((trendDir==='strong_down'||trendDir==='down') && (swingPos==='deep_dip'||swingPos==='dip')){
    swingAdvice = '趋势向下+继续下跌，不建议抄底';
  } else if(trendDir==='sideways'){
    swingAdvice = '震荡格局，等待方向明确';
  }

  return {
    chg5d: +chg5d.toFixed(2),
    chg20d: +chg20d.toFixed(2),
    chg60d: +chg60d.toFixed(2),
    chg120d: +chg120d.toFixed(2),
    chg250d: +chg250d.toFixed(2),
    ma5: +ma5.toFixed(4), ma20: +ma20.toFixed(4), ma60: +ma60.toFixed(4),
    latest: +latest.toFixed(4),
    high1y: +high1y.toFixed(4), low1y: +low1y.toFixed(4),
    drawdownFromHigh: +drawdownFromHigh.toFixed(2),
    reboundFromLow: +reboundFromLow.toFixed(2),
    trendDir, trendScore, swingPos, swingAdvice,
    dataPoints: len
  };
}

async function fetchAllHistory(){
  const pCodes = getAllPortfolioCodes();
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code), ...pCodes])];
  for(const code of codes){
    const navs = await fetchFundHistory(code);
    if(navs && navs.length>0){
      const trend = analyzeTrend(navs);
      fundHistoryData[code] = { navs, trend };
    }
    await new Promise(r=>setTimeout(r,200));
  }
}

function getFundData(code){
  if(liveFundData[code]) return {...liveFundData[code], _live:true};
  // 尝试从历史数据取最新真实净值
  const hd = fundHistoryData[code];
  if(hd && hd.navs && hd.navs.length>0){
    const latest = hd.navs[hd.navs.length-1];
    const prev = hd.navs.length>1 ? hd.navs[hd.navs.length-2] : latest;
    const pct = prev.nav>0 ? (latest.nav-prev.nav)/prev.nav*100 : 0;
    const nm = FUND_DB.find(x=>x.code===code)?.name || RECO_FUND_POOL.find(x=>x.code===code)?.name || code;
    return {gsz:latest.nav, dwjz:latest.nav, gszzl:+pct.toFixed(2), name:nm, gztime:latest.date, _live:false, _histFallback:true};
  }
  // 无实时数据也无历史数据 → 返回待开盘状态，不生成随机数据
  const f = FUND_DB.find(x=>x.code===code);
  const r = RECO_FUND_POOL.find(x=>x.code===code);
  const nm = f?f.name : r?r.name : code;
  const baseNav = f?f.baseNav : 1;
  return {gsz:baseNav, dwjz:baseNav, gszzl:0, name:nm, gztime:'', _live:false, _noData:true};
}

function getIndexData(cfg){
  if(liveIndices[cfg.secid]) return liveIndices[cfg.secid];
  const base={'1.000001':3340,'0.399001':10420,'0.399006':2110,'1.000300':4000,'1.518880':7.5,'0.161226':1.45,'1.000819':5200}[cfg.secid]||3000;
  const seed = parseInt(todayStr().replace(/-/g,''))+(cfg.secid.charCodeAt(2)||0)*137;
  const pct=(seededRand(seed)-0.46)*3;
  return {name:cfg.name, price:(base*(1+pct/100)).toFixed(2), pct:pct, change:(base*pct/100).toFixed(2)};
}

function fundName(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  const live = liveFundData[code];
  const cached = _fundHoldingsCache[code];
  return info?.name || reco?.name || live?.name || cached?.name || h?.name || w?.name || code;
}

function fundType(code){
  const info = FUND_DB.find(x=>x.code===code);
  const reco = RECO_FUND_POOL.find(x=>x.code===code);
  const h = holdings.find(x=>x.code===code);
  const w = watchlist.find(x=>x.code===code);
  return info?.type || reco?.type || h?.type || w?.type || '';
}

// ==================== AI ENGINE ====================
async function callAI(model, systemPrompt, userPrompt, temperature=0.7){
  if(!_aiKey) throw new Error('请先配置API Key');
  const resp = await fetch(_apiBase, {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+_aiKey},
    body:JSON.stringify({
      model,
      messages:[
        {role:'system', content:systemPrompt},
        {role:'user', content:userPrompt}
      ],
      temperature,
      max_tokens:4096
    })
  });
  if(!resp.ok){
    const err = await resp.text().catch(()=>'');
    throw new Error(`API ${resp.status}: ${err.slice(0,200)}`);
  }
  const json = await resp.json();
  return json.choices?.[0]?.message?.content || '';
}

function buildContext(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const shData = getIndexData(INDICES_CONFIG[0]);
  const szData = getIndexData(INDICES_CONFIG[1]);
  const cyData = getIndexData(INDICES_CONFIG[2]);
  const auData = getIndexData(INDICES_CONFIG[4]);
  const agData = getIndexData(INDICES_CONFIG[5]);
  const ysData = getIndexData(INDICES_CONFIG[6]);
  const topUp = liveSectors.filter(s=>s.pct>0).slice(0,6);
  const topDown = liveSectors.filter(s=>s.pct<0).slice(-4).reverse();

  let ctx = `当前日期: ${todayStr()}\n`;
  ctx += `用户目标：3个月内稳健增长，跑赢沪深300指数\n\n`;
  ctx += `【大盘指数】\n`;
  ctx += `上证指数: ${shData.price} (${sign(shData.pct)}${fmt(shData.pct)}%)\n`;
  ctx += `深证成指: ${szData.price} (${sign(szData.pct)}${fmt(szData.pct)}%)\n`;
  ctx += `创业板指: ${cyData.price} (${sign(cyData.pct)}${fmt(cyData.pct)}%)\n`;
  ctx += `沪深300: ${hs300.price} (${sign(hs300.pct)}${fmt(hs300.pct)}%)\n`;
  ctx += `\n【商品/贵金属】\n`;
  ctx += `黄金ETF: ${auData.price} (${sign(auData.pct)}${fmt(auData.pct)}%)\n`;
  ctx += `白银LOF: ${agData.price} (${sign(agData.pct)}${fmt(agData.pct)}%)\n`;
  ctx += `有色金属指数: ${ysData.price} (${sign(ysData.pct)}${fmt(ysData.pct)}%)\n`;

  if(topUp.length>0){
    ctx += `\n【今日领涨板块】\n`;
    topUp.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }
  if(topDown.length>0){
    ctx += `\n【今日领跌板块】\n`;
    topDown.forEach(s=>{ ctx += `${s.name}: ${sign(s.pct)}${fmt(s.pct)}%\n`; });
  }

  // 构建基金趋势数据（优先使用真实历史数据，无数据时用板块通用描述做后备）
  const SECTOR_FALLBACK = {
    '黄金':'近期避险需求支撑，关注央行购金动态',
    '有色金属':'关注全球大宗商品价格走势和新基建需求',
    'AI/科技':'AI产业驱动，关注算力需求和产业政策',
    '半导体':'国产替代逻辑持续，注意估值波动',
    '军工':'事件驱动型，关注地缘政策催化',
    '红利':'防御性强，适合长持',
    '宽基':'跟随大盘走势',
    '新能源':'关注产能周期和政策拐点',
    '消费':'关注内需复苏信号',
    '医药':'关注创新药进展',
  };

  function buildFundTrendDesc(code){
    const hd = fundHistoryData[code];
    if(!hd || !hd.trend) return '';
    const t = hd.trend;
    let desc = `【真实历史数据分析】`;
    desc += `趋势方向:${t.trendDir}(评分${t.trendScore})`;
    desc += ` | 近5日:${sign(t.chg5d)}${t.chg5d}%`;
    desc += ` | 近20日:${sign(t.chg20d)}${t.chg20d}%`;
    desc += ` | 近60日:${sign(t.chg60d)}${t.chg60d}%`;
    desc += ` | 近250日:${sign(t.chg250d)}${t.chg250d}%`;
    desc += ` | 距年高点:${t.drawdownFromHigh}%`;
    desc += ` | 距年低点:+${t.reboundFromLow}%`;
    desc += ` | MA5:${t.ma5} MA20:${t.ma20} MA60:${t.ma60} 最新:${t.latest}`;
    desc += ` | 波段位置:${t.swingPos}`;
    if(t.swingAdvice) desc += ` | 波段建议:${t.swingAdvice}`;
    return desc;
  }

  if(holdings.length>0){
    ctx += `\n【用户持仓基金】\n`;
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      const tp = fundType(h.code);
      const trendDesc = buildFundTrendDesc(h.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(h.code)}(${h.code}) - 类型:${tp} - 持仓 - 今日:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | 板块参考:${fallback}`;
      ctx += `\n`;
    });
  }

  if(watchlist.length>0){
    ctx += `\n【用户自选基金】\n`;
    watchlist.forEach(w=>{
      const f = getFundData(w.code);
      const tp = fundType(w.code);
      const trendDesc = buildFundTrendDesc(w.code);
      const fallback = !trendDesc ? (SECTOR_FALLBACK[tp] || '') : '';
      ctx += `${fundName(w.code)}(${w.code}) - 类型:${tp} - 自选 - 今日:${sign(f.gszzl)}${fmt(f.gszzl)}%`;
      if(trendDesc) ctx += `\n  ${trendDesc}`;
      else if(fallback) ctx += ` | 板块参考:${fallback}`;
      ctx += `\n`;
    });
  }

  const ownedCodes = new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)]);
  const pool = RECO_FUND_POOL.filter(f=>!ownedCodes.has(f.code)).slice(0,10);
  if(pool.length>0){
    ctx += `\n【候选基金池(可推荐给用户买入)】\n`;
    pool.forEach(f=>{ ctx += `${f.name}(${f.code}) - 类型:${f.type} - 标签:${f.tags.join(',')}\n`; });
  }

  // 注入历史复盘教训，让AI从过去的失误中学习
  const reviewCtx = buildReviewContext();
  if(reviewCtx) ctx += reviewCtx;

  // 注入数据情报：宏观经济 + 资金流向 + 新闻舆情
  if(_dataIntelLoaded){
    ctx += buildDataIntelContext();
  }

  // 注入RL强化学习信号
  if(_rlModelLoaded){
    ctx += buildRLContext();
  }

  // 注入回测结果
  if(btSummary){
    ctx += buildBTContext();
  }

  return ctx;
}

function buildDataIntelContext(){
 let ctx = '\n【 宏观地缘事件与投资研判 — 多维度分析】\n';

  // 宏观经济
  const macro = getMacroSummary();
  ctx += '\n■ 宏观经济指标:\n';
  macro.signals.forEach(s=>{
 ctx += ` ${s.name}: ${s.value} (${s.signal}) ${s.positive?'':''}\n`;
  });
  ctx += `  综合宏观信号: ${macro.overallSignal} (${macro.positiveCount}/5项正面)\n`;
  // PMI趋势
  if(macroData.pmi && macroData.pmi.length>=2){
    ctx += `  PMI趋势: ${macroData.pmi.map(d=>d.TIME?.replace('份','')+':'+d.MAKE_INDEX).join(' → ')}\n`;
  }
  // CPI趋势
  if(macroData.cpi && macroData.cpi.length>=2){
    ctx += `  CPI趋势: ${macroData.cpi.map(d=>d.TIME?.replace('份','')+':'+d.NATIONAL_SAME+'%').join(' → ')}\n`;
  }

  // 板块资金流向
  const capFlow = getCapFlowSummary();
  if(sectorCapFlow.length>0){
    ctx += '\n■ 板块主力资金流向(今日):\n';
    ctx += `  全市场主力净流入: ${(capFlow.netTotal/1e8).toFixed(1)}亿\n`;
    capFlow.topInflow.slice(0,5).forEach(s=>{
      ctx += `  � ${s.name}: +${(s.mainNet/1e8).toFixed(1)}亿\n`;
    });
    capFlow.topOutflow.slice(0,3).forEach(s=>{
 ctx += ` ${s.name}: ${(s.mainNet/1e8).toFixed(1)}亿\n`;
    });
    // 匹配用户持仓的板块资金流
    const holdTypes = new Set([...holdings.map(h=>h.type||''), ...watchlist.map(w=>w.type||'')]);
    const relevantFlows = sectorCapFlow.filter(s=> [...holdTypes].some(t=>s.name.includes(t)||t.includes(s.name)));
    if(relevantFlows.length>0){
      ctx += '  [与用户持仓相关板块资金流]:\n';
      relevantFlows.forEach(s=>{ ctx += `    ${s.name}: ${(s.mainNet/1e8).toFixed(1)}亿(主力净占比${s.mainNetPct}%)\n`; });
    }
  }

  // 新闻舆情
  ctx += '\n■ 财经新闻舆情分析(NLP):\n';
  ctx += `  舆情指数: ${newsSentiment.score}/100 (${newsSentiment.label})\n`;
  ctx += `  利好新闻: ${newsSentiment.bullCount}条 | 利空新闻: ${newsSentiment.bearCount}条\n`;
  if(newsHeadlines.length>0){
    ctx += '  [重要财经新闻]:\n';
    newsHeadlines.slice(0,8).forEach(n=>{
 const tag = n.sentiment==='bull'?'�利好':n.sentiment==='bear'?'利空':'中性';
      ctx += `    ${tag} ${n.title}\n`;
    });
  }

  // 国际新闻聚合
  if(globalNews.length > 0){
    const gSent = getGlobalNewsSentiment();
 ctx += '\n■ 国际新闻聚合(全球十大媒体 · 政治经济):\n';
    ctx += `  国际舆情指数: ${gSent.score}/100 (${gSent.label}) 正面${gSent.bullCount}条/负面${gSent.bearCount}条/共${gSent.total}条\n`;
    ctx += '  [重要国际新闻]:\n';
    globalNews.slice(0,12).forEach(n=>{
 const tag = n.sentiment==='bull'?'�正面':n.sentiment==='bear'?'负面':'中性';
      ctx += `    [${n.source}] ${tag} ${n.titleCN||n.title}\n`;
    });
    if(globalNewsSummary){
      ctx += '  [AI国际形势分析摘要]:\n';
      if(globalNewsSummary.overview) ctx += `    概览: ${globalNewsSummary.overview}\n`;
      if(globalNewsSummary.impact?.positive) ctx += `    利好: ${globalNewsSummary.impact.positive.join('; ')}\n`;
      if(globalNewsSummary.impact?.negative) ctx += `    利空: ${globalNewsSummary.impact.negative.join('; ')}\n`;
      if(globalNewsSummary.impact?.sectors) ctx += `    受影响板块: ${globalNewsSummary.impact.sectors.join('、')}\n`;
      if(globalNewsSummary.advice) ctx += `    投资建议: ${globalNewsSummary.advice.join('; ')}\n`;
      ctx += `    AI评分: ${globalNewsSummary.score||50}/100\n`;
    }
  }

  // 综合数据信号
  const dataSignal = generateDataSignal();
  ctx += `\n■ 综合数据信号: ${dataSignal.icon} ${dataSignal.label} (评分${dataSignal.score}/100)\n`;
  ctx += `  建议: ${dataSignal.advice}\n`;

  // 宏观地缘事件引擎
  const geoA = getMacroGeoAnalysis();
 ctx += `\n■ 宏观地缘事件引擎 (综合评分${geoA.score}/100 · ${geoA.label}):\n`;
  geoA.topEvents.forEach(e => {
    ctx += `  ${e.icon} ${e.name}: 影响=${e.impact>0?'+':''}${e.impact} 置信度=${(e.confidence*100).toFixed(0)}%\n`;
    ctx += `    ${e.description}\n`;
    ctx += `    利好板块: ${e.sectors.positive.join('、')} | 利空板块: ${e.sectors.negative.join('、')||'无'}\n`;
    if(e.scenarios && e.scenarios.length > 0){
      ctx += `    情景推演:\n`;
      e.scenarios.forEach(sc => {
        ctx += `      ${sc.name}(概率${(sc.probability*100).toFixed(0)}% 影响${sc.impact>0?'+':''}${sc.impact}): ${sc.note}\n`;
        if(sc.benefitSectors?.length) ctx += `        利好: ${sc.benefitSectors.join('、')}\n`;
        if(sc.hurtSectors?.length) ctx += `        利空: ${sc.hurtSectors.join('、')}\n`;
      });
    }
    ctx += `    操作建议: ${e.advice}\n`;
  });
 ctx += `\n 三个月展望(${geoA.outlook.period}): ${geoA.outlook.overall}\n`;
  ctx += `  投资主线:\n`;
  geoA.outlook.themes.forEach(t => {
    const arrow = t.direction==='up'?'↑':t.direction==='down'?'↓':'→';
    ctx += `    ${arrow} ${t.name}(置信:${t.conviction}): ${t.reason}\n`;
  });
  ctx += `  建议配置:\n`;
 ctx += ` 进攻仓: ${geoA.outlook.allocation.offensive}\n`;
 ctx += ` 核心仓: ${geoA.outlook.allocation.core}\n`;
 ctx += ` 防御仓: ${geoA.outlook.allocation.hedge}\n`;
 ctx += ` 现金: ${geoA.outlook.allocation.cash}\n`;
 ctx += ` 重点风险: ${geoA.outlook.risks.join('; ')}\n`;

  // 持仓基金地缘事件关联 (增强：包含行业板块暴露)
  if(Object.keys(geoA.fundImpacts).length > 0){
    ctx += `\n  [持仓基金行业暴露与地缘事件关联]:\n`;
    Object.entries(geoA.fundImpacts).forEach(([code, fi]) => {
      const sectorStr = fi.sectorExposure ? formatSectorExposure(fi.sectorExposure) : '暂无';
      ctx += `    ${fundName(code)}(${code}): 行业板块=[${sectorStr}] 数据来源=${fi.analysisSource||'名称'} 地缘影响=${fi.score>0?'+':''}${fi.score.toFixed(1)} 相关事件=${fi.events.map(e=>e.icon+e.name+'('+e.matchSource+')').join(',')}\n`;
    });
  }
  // 无地缘关联的基金也输出行业暴露
  const geoLinked = new Set(Object.keys(geoA.fundImpacts));
  const allTracked = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  const unlinked = allTracked.filter(c => !geoLinked.has(c));
  if(unlinked.length > 0){
    ctx += `\n  [其他持仓基金行业分布]:\n`;
    unlinked.forEach(code => {
      const sectorStr = formatSectorExposure(getFundSectorExposure(code));
      ctx += `    ${fundName(code)}(${code}): 行业板块=[${sectorStr}]\n`;
    });
  }

 ctx += '\n 请结合以上宏观数据、资金流向、国内舆情、国际新闻以及重大地缘事件分析，对你的操作建议进行验证和调整。特别注意：①地缘事件对持仓基金的板块影响 ②三个月投资主线是否与持仓吻合 ③风险事件是否需要调仓对冲 ④TOP50基金经理共识方向与社交热词的趋势共振信号。数据驱动决策，减少主观偏差。\n';

  // 注入TOP50基金经理×社交热词耦合分析
  ctx += getFMSocialContextForAI();

  // 注入第二层思维 & 反拥挤度分析
  ctx += buildSecondOrderContext();

  return ctx;
}

function buildSecondOrderContext(){
  if(!_hotEventsLoaded) return '';
  const analysis = analyzeSecondOrderThinking();
 let ctx = '\n【 第二层思维 & 反拥挤度分析 (Anti-Crowding · ΔP=Reality-Expectation)】\n';

  // 拥挤交易预警
  if(analysis.crowdedTrades.length > 0){
    ctx += '\n■ 拥挤交易预警(Crowded Trades) — Expectation极高,买入风险大:\n';
    analysis.crowdedTrades.forEach(ct => {
      ctx += `  � ${ct.tag}(温度${ct.temperature}): ${ct.insight}\n`;
      if(ct.secondOrderTargets.length > 0){
        ctx += `    → 第二层受益(卖铲子): ${ct.secondOrderTargets.join('、')}\n`;
      }
    });
  }

  // 逆向机会
  if(analysis.contrarianPicks.length > 0){
    ctx += '\n■ 逆向机会发掘(Contrarian Picks) — Expectation极低,ΔP可能为正:\n';
    analysis.contrarianPicks.forEach(cp => {
      const fund = getFundamentalStatus(cp.tag);
      ctx += `  � ${cp.tag}(温度${cp.temperature}): ${cp.insight}\n`;
      ctx += `    Reality: ${fund.reality} | 趋势: ${fund.trend}\n`;
    });
  }

 ctx += '\n 第二层思维要求: 避开拥挤度>80且RSI>70的方向(Kelly仓位已惩罚至15-35%); 关注拥挤度<25且RSI<35的逆向机会(Kelly给予1.12-1.25倍流动性补偿)。不要追逐表面热点,寻找预期差。\n';
  return ctx;
}


const SYSTEM_PROMPT = `你是一位擅长波段操作和趋势跟踪的基金投资顾问，拥有丰富的量化分析和多因子模型经验。用户的核心目标是：3个月内实现稳健增长，跑赢沪深300指数。

■ 你的数据源（按重要度排序）：
1. 市场数据：基金历史净值(NAV)趋势分析、相关指数(沪深300/上证/创业板)行情、ETF实时价格
2. 宏观经济数据：PMI(制造业景气度)、CPI/PPI(通胀)、GDP增速、M2货币供应(流动性)
3. 另类数据：板块主力资金流向(超大单/大单/中单/小单)、财经新闻NLP情绪分析(利好/利空识别)、社交舆情热度指数
4. 历史复盘：过往AI预测vs实际涨跌对比、准确率统计、错误教训
5. RL强化学习信号：基于Double DQN(18维状态空间含回测特征)训练的策略网络，直接输出买入/卖出/持有决策及Q值置信度，支持在线学习反馈
6. 策略回测(Backtesting)：基于历史NAV的RSI策略回测结果，融合RL信号作为辅助条件，包括Sharpe Ratio、最大回撤、胜率、凯利仓位。回测Sharpe<0的品种需特别谨慎
7. 三引擎投票共识：AI/RL/回测三系统加权投票决策，全票一致时加大仓位（×1.4），有分歧时缩减仓位（×0.4）
8. 第二层思维(Second-Order Thinking)：反拥挤度惩罚机制 → 拥挤度>80且RSI>70的方向，Kelly仓位惩罚至15-35%，避免"买预期卖事实"陷阱；逆向奖励机制 → 拥挤度<25且RSI<35的方向，Kelly给予1.12-1.25倍流动性补偿，利用预期差ΔP=Reality-Expectation寻找Alpha

■ 核心投资逻辑（你必须遵守）：
1. 趋势为王：先判断每个板块/基金的中期趋势（3个月维度）是上升、震荡还是下降
2. 逢跌买入：如果中期趋势向上，短期大跌(≥1.5%)是加仓/建仓的好机会，而不是减仓信号！
3. 逢涨止盈：如果短期涨幅过大(连续上涨或单日>3%)，应考虑部分止盈而非追高
4. 波段思维：核心仓位(宽基/红利/黄金)长持不动，卫星仓位(行业主题)做波段——低吸高抛
5. 仓位管理：建议将持仓分为核心仓(~60%稳健压舱石)和卫星仓(~40%弹性进攻)
6. 趋势拐点：只有当中期趋势确认转向下行时，才建议减仓
7. 反拥挤度：避免追逐拥挤度极高(>80)的表面热点，关注其上下游"卖铲子"产业。对情绪冰点但基本面修复中的板块，积极左侧布局。记住Howard Marks的忠告："风险不在波动率，在于你为之付出了过高的价格"

■ 操作决策框架：
- 中期趋势↑ + 今日大跌 → buy(加仓/低吸) 
- 中期趋势↑ + 今日大涨 → hold或sell(部分止盈)
- 中期趋势↑ + 今日平稳 → hold(持有)
- 中期趋势→ + 今日大跌 → hold或buy(小仓试探)
- 中期趋势↓ + 任何情况 → sell(减仓避险)

■ 波段止盈铁律（绝不追高）：
- 连涨冲高(5日涨≥3%且接近年内新高) → sell(部分止盈20-30%)，绝不追高加仓！
- 短期暴涨(5日涨≥4%且RSI>70) → sell(超买区获利了结)
- 中期涨幅过大(20日涨>10%且仍在涨) → hold(不追，等回调再考虑)
- 中期涨幅极大(20日涨>12%) → hold或sell(获利盘压力大，不是加仓时机)
- 距年内高点<2%且持续上涨 → sell(落袋为安，等回调低吸)
- 核心原则：赚到的钱落袋一部分，永远比追高多赚一点安全。"会买的是徒弟，会卖的是师傅"

■ 仓位分类指引：
- 核心仓(压舱石)：宽基指数(A500/沪深300/中证500)、红利低波、黄金 → 长持，只在极端情况调整
- 卫星仓(弹性)：AI/科技、有色金属、军工、半导体、新能源等行业主题 → 积极波段操作，低吸高抛，创新高时必须部分止盈

你必须严格按照以下JSON格式回复，不要有任何额外的文字或markdown标记：
{
  "marketSummary": "80-120字的市场总结，聚焦对用户持仓的影响和3个月展望",
  "benchmarkView": "沪深300未来3个月走势判断(30字)",
  "portfolioAdvice": {
    "coreRatio": "建议核心仓占比，如60%",
    "satRatio": "建议卫星仓占比，如40%",
    "advice": "30-50字的整体仓位调整建议"
  },
  "signals": [
    {
      "code": "基金代码",
      "posType": "core/satellite",
      "action": "buy/sell/hold",
      "urgency": "today/this_week/no_rush",
      "confidence": 60-95,
      "trend": "up/sideways/down",
      "reason": "60-120字理由：①先说中期趋势判断 ②再结合今日表现给出操作逻辑 ③说明如何帮助跑赢沪深300",
      "target3m": "+X%~+Y%"
    }
  ],
  "newPicks": [
    {
      "code": "推荐基金代码(必须从候选池中选)",
      "reason": "40-60字推荐理由",
      "expected3m": "+X%~+Y%"
    }
  ]
}

要求：
1. signals必须覆盖用户所有持仓和自选基金，code与用户提供的完全一致
2. action: buy=加仓/建仓, sell=减仓/止盈, hold=持有不动
3. posType: core=核心仓(建议长持), satellite=卫星仓(建议波段)
4. trend: up=中期趋势向上, sideways=震荡, down=趋势向下
5. urgency: today=今日收盘前操作, this_week=本周内, no_rush=不急
6. confidence: 60-95之间的整数
7. reason必须包含趋势判断+操作逻辑，不能仅凭今日涨跌做判断
8. 特别注意：趋势向上的品种短期回调是买入机会，不要因为今天跌了就建议减仓！
9. newPicks最多推荐3只，从候选池中选择当前被低估或有波段机会的
10. 只输出JSON，不要有其他任何文字`;

const ROLE_DESCS = {
  engine1: '你特别擅长技术分析、量化因子和趋势跟踪。请重点分析：①每个基金所属板块的中期趋势（过去1-3个月走势方向+均线系统）②当前处于趋势中的什么位置（回调低点？上升中途？高位？）③短期回调是否是上升趋势中的买入机会。请特别关注数据情报中的「板块主力资金流向」和「历史NAV趋势数据」。如果资金持续流入+中期趋势向上+短期回调，这是强买入信号。',
  engine2: '你特别擅长宏观经济和政策面分析。请重点关注数据情报中的「宏观经济指标」：①PMI是否在荣枯线上方（制造业景气度直接影响周期股）②CPI/PPI走势（通胀环境利好有色金属/资源类）③M2增速（流动性是否宽松，宽松环境利好成长股）④GDP增速趋势。结合宏观数据判断各行业板块的中期政策驱动力。',
  engine3: '你特别擅长深度基本面和行业研究。请重点分析：①各行业的景气度周期位置（结合PMI、PPI数据验证）②板块主力资金单流向是否确认行业景气（大资金持续流入=机构认同）③盈利趋势是否支撑中期上涨。对于景气上行期+资金流入的行业，短期波动不改长期趋势——大跌是买入机会。',
  engine4: '你特别擅长全球视角、资金流向和舆情分析。请重点关注：①数据情报中的「财经新闻舆情」（NLP情绪指数偏多还是偏空？）②板块资金流向中的大单超大单方向（代表机构态度）③全球大宗商品走势+地缘风险 ④新闻中提到的风险点和催化剂。结合舆情综合信号给出风险调整后的仓位建议。'
};

async function runAIAnalysis(onProgress){
  if(_analyzing) return;
  _analyzing = true;

  const ctx = buildContext();
  const results = {};
  let done = 0;

  const promises = AI_ENGINES.map(async (eng) => {
    try {
      const roleMsg = ROLE_DESCS[eng.id] || '';
      const userMsg = `${roleMsg}\n\n${ctx}\n\n请基于以上数据和你的专业知识，给出操作建议。`;
      if(onProgress) onProgress(`${eng.icon} ${eng.name} 分析中...`, ++done);

      const raw = await callAI(eng.model, SYSTEM_PROMPT, userMsg, 0.7);

      let jsonStr = raw.trim();
      // Remove <think>...</think> blocks if present
      jsonStr = jsonStr.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
      if(jsonStr.startsWith('```')) jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if(!jsonMatch) throw new Error('No JSON');
      const parsed = JSON.parse(jsonMatch[0]);
      results[eng.id] = parsed;
 if(onProgress) onProgress(` ${eng.name} 完成`, done);
    } catch(e) {
      console.error(`${eng.name} failed:`, e);
 if(onProgress) onProgress(` ${eng.name} 失败`, done);
    }
  });

  await Promise.all(promises);
  _analyzing = false;

  const successCount = Object.keys(results).length;
  if(successCount === 0) throw new Error('所有AI引擎调用失败，请检查API Key和网络');

  return synthesize(results);
}

function synthesize(results){
  const engines = Object.keys(results);
  const total = engines.length;

  const summaries = engines.map(e=>results[e].marketSummary).filter(Boolean);
  const benchViews = engines.map(e=>results[e].benchmarkView).filter(Boolean);

  // Merge signals per fund code
  const signalMap = {};
  engines.forEach(engId=>{
    const r = results[engId];
    (r.signals||[]).forEach(s=>{
      if(!signalMap[s.code]) signalMap[s.code] = [];
      signalMap[s.code].push({...s, engine:engId});
    });
  });

  // 确保所有持仓和自选基金都有信号（AI引擎可能遗漏部分基金）
  const allTrackedCodes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  allTrackedCodes.forEach(code => {
    if(!signalMap[code]){
      // AI未覆盖该基金，为每个引擎生成默认hold信号
      signalMap[code] = engines.map(engId => ({
        code,
        action: 'hold',
        confidence: 50,
        reason: 'AI引擎未返回该基金的分析信号，默认持有观望',
        urgency: 'no_rush',
        trend: 'sideways',
        posType: (fundType(code)||'').match(/宽基|红利|黄金/) ? 'core' : 'satellite',
        engine: engId
      }));
    }
  });

  // Synthesize per fund
  const synthesizedSignals = {};
  Object.keys(signalMap).forEach(code=>{
    const sigs = signalMap[code];
    const actions = sigs.map(s=>s.action);
    const buyCount = actions.filter(a=>a==='buy').length;
    const sellCount = actions.filter(a=>a==='sell').length;
    const holdCount = actions.filter(a=>a==='hold').length;

    // 趋势投票：优先用真实历史数据，后备用AI引擎投票
    const realTrend = fundHistoryData[code]?.trend;
    let trendConsensus;
    let todayPct;
    if(realTrend){
      // 使用真实计算的趋势方向
      trendConsensus = (realTrend.trendDir==='strong_up'||realTrend.trendDir==='up') ? 'up'
        : (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') ? 'down' : 'sideways';
      // 使用真实5日涨跌作为波段参考
      todayPct = getFundData(code)?.gszzl || 0;
    } else {
      // 后备：AI引擎投票
      const trends = sigs.map(s=>s.trend).filter(Boolean);
      const upTrends = trends.filter(t=>t==='up').length;
      const downTrends = trends.filter(t=>t==='down').length;
      trendConsensus = upTrends > downTrends ? 'up' : downTrends > upTrends ? 'down' : 'sideways';
      todayPct = getFundData(code)?.gszzl || 0;
    }

    let action = 'hold';
    if(buyCount > total/2) action = 'buy';
    else if(sellCount > total/2) action = 'sell';
    else if(buyCount > sellCount) action = 'buy';
    else if(sellCount > buyCount) action = 'sell';
    else {
      // 打平或全hold时，用趋势+今日表现做修正
      // 趋势向上 + 今日大跌(≥1.5%) → 加仓机会
      if(trendConsensus === 'up' && todayPct <= -1.5 && buyCount >= 1) action = 'buy';
      // 趋势向下 + 今日大涨 → 减仓
      else if(trendConsensus === 'down' && todayPct >= 1.5 && sellCount >= 1) action = 'sell';
    }

    // 额外修正：如果趋势向上且今日跌幅≥2%，即使hold多数也升级为buy（波段逻辑核心）
    if(trendConsensus === 'up' && todayPct <= -2.0 && action === 'hold' && buyCount >= 1) {
      action = 'buy';
    }
    // 真实数据增强：如果有历史数据且趋势是strong_up，跌幅≥1.2%就触发买入
    if(realTrend && (realTrend.trendDir==='strong_up') && todayPct <= -1.2 && action === 'hold') {
      action = 'buy';
    }
    // 真实数据增强：如果趋势down且近5日还在跌，强制sell（除非所有AI引擎都不建议sell）
    if(realTrend && (realTrend.trendDir==='strong_down'||realTrend.trendDir==='down') && realTrend.chg5d < -2 && action === 'hold' && sellCount >= 1) {
      action = 'sell';
    }

 // 波段止盈修正：趋势向上但连续冲高+近高点 → hold升级为sell(部分止盈)
    if(realTrend && action !== 'sell'){
      const { swingPos, chg5d, chg20d, drawdownFromHigh } = realTrend;
      const rsi = btResults[code]?.lastRSI || 50;
      // 场景1: 连续冲高(surge/rally) + 接近年内高点(回撤<2%) → 强止盈
      if((swingPos==='surge' || chg5d >= 3) && drawdownFromHigh > -2){
        action = 'sell'; // 创新高+连涨 → 部分止盈
      }
      // 场景2: 中期涨幅过大(20日>10%) + 5日继续涨 + RSI偏高 → 止盈
      else if(chg20d > 10 && chg5d >= 1.5 && rsi > 65 && action === 'buy'){
        action = 'hold'; // 至少不应追高，降级为hold
      }
      // 场景3: 任何品涨幅过大(20日>12%) + action为buy → 不追高
      else if(chg20d > 12 && action === 'buy'){
        action = 'hold'; // 短期获利盘过大，不追
      }
      // 场景4: 5日暴涨(≥4%) + RSI>70 → 超买止盈
      else if(chg5d >= 4 && rsi > 70){
        action = 'sell';
      }
    }

    const urgencyOrder = {today:3, this_week:2, no_rush:1};
    const matchingSigs = sigs.filter(s=>s.action===action);
    const urgency = matchingSigs.length>0
      ? matchingSigs.sort((a,b)=>(urgencyOrder[b.urgency]||0)-(urgencyOrder[a.urgency]||0))[0].urgency
      : 'no_rush';

    const conf = matchingSigs.length>0
      ? Math.round(matchingSigs.reduce((s,x)=>s+(x.confidence||70),0)/matchingSigs.length)
      : 50;

    const bestReason = matchingSigs.sort((a,b)=>(b.reason?.length||0)-(a.reason?.length||0))[0]?.reason || '暂无分析';

    const target = matchingSigs.find(s=>s.target3m)?.target3m || '';

    const breakdown = sigs.map(s=>{
      const eng = AI_ENGINES.find(e=>e.id===s.engine);
      return `${eng?.icon||'🤖'}${eng?.name||s.engine}: ${s.action==='buy'?'看多':s.action==='sell'?'看空':'中性'}`;
    }).join(' · ');

    synthesizedSignals[code] = {
      action, urgency, confidence:conf, reason:bestReason,
      target3m:target, breakdown,
      posType: sigs[0]?.posType || (fundType(code).match(/宽基|红利|黄金/) ? 'core' : 'satellite'),
      trend: realTrend ? trendConsensus : (sigs.filter(s=>s.trend).map(s=>s.trend).sort((a,b)=>({'up':3,'sideways':2,'down':1}[b]||0)-({'up':3,'sideways':2,'down':1}[a]||0))[0] || 'sideways'),
      trendDetail: realTrend || null,
      buyCount, sellCount, holdCount, total
    };
  });

  // Merge new picks
  const pickMap = {};
  engines.forEach(engId=>{
    (results[engId].newPicks||[]).forEach(p=>{
      if(!pickMap[p.code]) pickMap[p.code] = {code:p.code, reasons:[], expected:[], count:0};
      pickMap[p.code].reasons.push(p.reason);
      pickMap[p.code].expected.push(p.expected3m);
      pickMap[p.code].count++;
    });
  });
  const picks = Object.values(pickMap)
    .sort((a,b)=>b.count-a.count)
    .slice(0,3)
    .map(p=>({
      code:p.code,
      name: fundName(p.code),
      type: fundType(p.code),
      reason: p.reasons[0],
      expected3m: p.expected[0]||'',
      endorsements: p.count
    }));

  // Merge portfolio advice
  const portAdvices = engines.map(e=>results[e].portfolioAdvice).filter(Boolean);
  const portfolioAdvice = portAdvices[0] || null;

  return {
    marketSummary: summaries[0] || '',
    benchmarkView: benchViews[0] || '',
    portfolioAdvice,
    signals: synthesizedSignals,
    picks,
    engineCount: total,
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
}

// ==================== RENDERING ====================
function renderAll(){
  renderCountdown();
  renderIndices();
  renderStats();
  renderPortfolio();
  renderSimBrief();
  renderSOTBrief();
  renderActionGuide();
  renderPlainAdvisor();
  renderWatchlist();
  renderRecos();
  renderReview();
}

function switchPfTab(tab){
  document.getElementById('pf-tab-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-tab-sat').classList.toggle('active', tab==='satellite');
  document.getElementById('pf-group-core').classList.toggle('active', tab==='core');
  document.getElementById('pf-group-satellite').classList.toggle('active', tab==='satellite');
}

function renderPortfolio(){
  ['core','satellite'].forEach(groupKey=>{
    const group = MODEL_PORTFOLIO[groupKey];
    const container = document.getElementById(`pf-group-${groupKey}`);
    let html = `<div class="pf-group-desc">${group.desc}</div>`;

    group.funds.forEach(pf=>{
      const f = getFundData(pf.code);
      const td = fundHistoryData[pf.code]?.trend;
      const isHeld = holdings.some(h=>h.code===pf.code);
      const isWatched = watchlist.some(w=>w.code===pf.code);

      // Swing signal from trend data
      let swingClass = 'hold', swingText = '等待数据';
      if(td){
        if(td.swingAdvice && td.swingAdvice.includes('买入')){
 swingClass = 'buy'; swingText = ' 波段买入';
        } else if(td.swingAdvice && (td.swingAdvice.includes('止盈') || td.swingAdvice.includes('减仓'))){
 swingClass = 'sell'; swingText = ' 考虑止盈';
        } else if(td.swingAdvice && td.swingAdvice.includes('不建议')){
 swingClass = 'sell'; swingText = ' 暂避';
        } else if(td.trendDir==='strong_up'||td.trendDir==='up'){
 swingClass = 'hold'; swingText = ' 趋势向上';
        } else if(td.trendDir==='strong_down'||td.trendDir==='down'){
 swingClass = 'sell'; swingText = ' 趋势偏弱';
        } else {
 swingClass = 'hold'; swingText = ' 震荡观望';
        }
      }

      // Trend brief (compact)
      let trendBrief = '';
      if(td){
        const mkVal = (v) => `<span style="color:${v>0?'var(--red)':v<0?'var(--green)':'var(--sub)'}">${v>0?'+':''}${v}%</span>`;
        trendBrief = `<span style="font-size:10px;color:var(--sub)">20日${mkVal(td.chg20d)} · 距高点${td.drawdownFromHigh}%</span>`;
      }

      // Action buttons
      let actHtml = '';
      if(isHeld){
 actHtml = `<span class="pf-act-btn in-hold"> 已持仓</span>`;
      } else {
        actHtml = `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','holding')">+ 持仓</button>`;
      }
      if(isWatched){
 actHtml += `<span class="pf-act-btn in-watch"> 自选</span>`;
      } else if(!isHeld){
        actHtml += `<button class="pf-act-btn" onclick="addFromPortfolio('${pf.code}','${pf.name}','${pf.type}','watch')">+ 自选</button>`;
      }

      html += `<div class="pf-card swing-${swingClass}">
        <div class="pf-top">
          <div class="pf-info">
            <div class="pf-name">${pf.name} <span style="font-size:10px;color:var(--sub);font-weight:400">${pf.code}</span></div>
            <div class="pf-code">${pf.type} · ${pf.alloc} ${trendBrief}</div>
          </div>
          <div class="pf-right">
            <div class="pf-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</div>
            <div class="pf-swing-tag ${swingClass}">${swingText}</div>
          </div>
        </div>
        <div class="pf-actions">${actHtml}</div>
      </div>`;
    });

    container.innerHTML = html;
  });
}

function addFromPortfolio(code, name, type, mode){
  if(mode==='holding'){
    if(holdings.some(h=>h.code===code)) return;
    holdings.push({code, name, type});
    // 同时从自选移除
    watchlist = watchlist.filter(w=>w.code!==code);
    saveHoldings();
    saveWatchlist();
  } else {
    if(watchlist.some(w=>w.code===code)) return;
    if(holdings.some(h=>h.code===code)) return;
    watchlist.push({code, name, type});
    saveWatchlist();
  }
  renderPortfolio();
  renderActionGuide();
  renderWatchlist();
}

function renderIndices(){
  const cfgs = [
    {secid:'1.000001', vId:'iv-sh', pId:'ip-sh'},
    {secid:'0.399001', vId:'iv-sz', pId:'ip-sz'},
    {secid:'0.399006', vId:'iv-cy', pId:'ip-cy'},
    {secid:'1.000300', vId:'iv-hs', pId:'ip-hs'},
    {secid:'1.518880', vId:'iv-au', pId:'ip-au'},
    {secid:'0.161226', vId:'iv-ag', pId:'ip-ag'},
    {secid:'1.000819', vId:'iv-ys', pId:'ip-ys'},
  ];
  cfgs.forEach(c=>{
    const cfg = INDICES_CONFIG.find(x=>x.secid===c.secid);
    if(!cfg) return;
    const d = getIndexData(cfg);
    const vEl = document.getElementById(c.vId);
    const pEl = document.getElementById(c.pId);
    if(vEl) vEl.textContent = d.price;
    if(pEl){
      const pct = parseFloat(d.pct);
      pEl.textContent = `${pct>=0?'+':''}${(typeof pct==='number'?pct.toFixed(2):d.pct)}%`;
      pEl.className = 'idx-pct ' + (pct>0?'up':pct<0?'down':'flat');
    }
  });
}

function renderCountdown(){
  const ms = getMarketStatus();
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('market-status-text');
  const cd = document.getElementById('countdown');

  dot.className = 'status-dot ' + (ms.status==='open'?'open':'closed');
  text.textContent = ms.text;

  if(ms.countdown!==null && ms.countdown>0){
    cd.textContent = '距收盘 ' + formatCountdown(ms.countdown);
    cd.style.display = '';
  } else if(ms.status==='open' && ms.countdown!==null && ms.countdown<=0){
    cd.textContent = '即将收盘!';
    cd.style.display = '';
  } else {
    cd.textContent = '';
    cd.style.display = 'none';
  }
}

function renderStats(){
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  let totalPct = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{
      const f = getFundData(h.code);
      totalPct += f.gszzl;
    });
    totalPct /= holdings.length;
  }

  const statToday = document.getElementById('stat-today');
  statToday.textContent = holdings.length>0 ? `${sign(totalPct)}${fmt(totalPct)}%` : '--';
  statToday.className = 'stat-value ' + (holdings.length>0?(totalPct>=0?'up':'down'):'');

  const statHS300 = document.getElementById('stat-hs300');
  statHS300.textContent = `${sign(hs300.pct)}${fmt(hs300.pct)}%`;
  statHS300.className = 'stat-value ' + (hs300.pct>=0?'up':'down');

  const benchToday = document.getElementById('stat-bench-today');
  if(holdings.length>0){
    const diff = totalPct - hs300.pct;
    if(diff>=0) benchToday.innerHTML = `今日 <span class="beat">跑赢大盘 +${fmt(diff)}%</span>`;
    else benchToday.innerHTML = `今日 <span class="lose">落后大盘 ${fmt(diff)}%</span>`;
  } else {
    benchToday.textContent = '添加持仓查看对比';
  }
}

// ==================== REAL-WORLD ACTION GUIDE ====================
// 双引擎闭环：AI信号 + 回测验证 → 实盘操作建议
function toggleActionGuide(){
  const container = document.getElementById('action-guide-container');
  const icon = document.getElementById('action-guide-toggle');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = '▼';
    renderActionGuide();
  } else {
    container.style.display = 'none';
    icon.textContent = '▶';
  }
}

// ==================== 市场Regime检测 ====================
function detectMarketRegime(){
  // 用所有持仓基金的平均指标推断市场regime
  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  if(codes.length === 0) return { regime: 'unknown', weights: { ai:1, rl:1, bt:1 } };
  let totalMom=0,totalVol=0,totalAutoCorr=0,count=0;
  for(const code of codes){
    const hd = fundHistoryData[code];
    if(!hd?.navs || hd.navs.length < 60) continue;
    const navs = hd.navs.map(n => parseFloat(n.nav!==undefined?n.nav:n[1])).filter(v=>v>0);
    if(navs.length < 60) continue;
    const n = navs.length;
    const rets = [];
    for(let i=Math.max(1,n-60);i<n;i++) rets.push((navs[i]-navs[i-1])/navs[i-1]);
    const mom20 = rets.slice(-20).reduce((s,v)=>s+v,0);
    const vol = Math.sqrt(rets.reduce((s,v)=>s+v*v,0)/rets.length)*100;
    const r20 = rets.slice(-20);
    const mu = r20.reduce((s,v)=>s+v,0)/r20.length;
    let acN=0,acD=0;
    for(let i=1;i<r20.length;i++){acN+=(r20[i]-mu)*(r20[i-1]-mu);acD+=(r20[i]-mu)**2;}
    totalMom += mom20*100;
    totalVol += vol;
    totalAutoCorr += acD>0?acN/acD:0;
    count++;
  }
  if(count === 0) return { regime: 'unknown', weights: { ai:1, rl:1, bt:1 } };
  const avgMom = totalMom/count;
  const avgVol = totalVol/count;
  const avgAC = totalAutoCorr/count;
  let regime = 'sideways';
  let weights = { ai: 1.0, rl: 1.0, bt: 1.0 };
  if(avgMom > 3 && avgAC > 0.1){
    regime = 'bull';
    weights = { ai: 1.1, rl: 1.3, bt: 0.8 }; // 趋势市→RL/AI主导
  } else if(avgMom < -3 && avgAC > 0.1){
    regime = 'bear';
    weights = { ai: 0.9, rl: 1.0, bt: 1.3 }; // 熊市→BT防御主导
  } else if(avgVol > 1.5){
    regime = 'volatile';
    weights = { ai: 0.8, rl: 0.7, bt: 1.2 }; // 高波→保守，BT均值回归
  } else {
    regime = 'sideways';
    weights = { ai: 1.0, rl: 0.8, bt: 1.1 }; // 震荡→BT均值回归略优
  }
  _marketRegime = regime;
  _regimeWeights = weights;
  return { regime, weights, avgMom, avgVol, avgAC };
}

// ==================== 组合风险度量 ====================
function getPortfolioRiskMetrics(){
  if(!simPortfolio?.positions?.length) return { dd:0, cashRatio:1, hhi:0, fundWeight:{}, totalExposure:0, riskScore:0 };
  const totalValue = getSimTotalValue();
  if(totalValue <= 0) return { dd:0, cashRatio:1, hhi:0, fundWeight:{}, totalExposure:0, riskScore:0 };
  const cashRatio = simPortfolio.cash / totalValue;
  // 各基金权重 + HHI集中度
  const fundWeight = {};
  let hhi = 0;
  simPortfolio.positions.forEach(pos => {
    const nav = getSimNav(pos.code) || pos.avgCost;
    const w = (pos.shares * nav) / totalValue;
    fundWeight[pos.code] = w;
    hhi += w * w;
  });
  // 组合回撤
  const snapshots = simPortfolio.dailySnapshots || [];
  let peakValue = SIM_INITIAL_CAPITAL;
  snapshots.forEach(s => { peakValue = Math.max(peakValue, s.totalValue || 0); });
  peakValue = Math.max(peakValue, totalValue);
  const dd = (totalValue - peakValue) / peakValue;
  // 总暴露(1-cash)
  const totalExposure = 1 - cashRatio;
  // 综合风险评分: 0(安全)→1(高风险)
  const riskScore = Math.min(1, Math.max(0,
    (totalExposure * 0.3) + // 高仓位风险
    (hhi * 0.3) + // 集中度风险
    (Math.abs(dd) * 3) + // 回撤风险
    (cashRatio < 0.1 ? 0.2 : 0) // 现金不足风险
  ));
  return { dd, cashRatio, hhi, fundWeight, totalExposure, riskScore };
}

// ==================== 引擎准确率追踪 ====================
function loadEngineAccuracy(){
  try{
    const d = JSON.parse(localStorage.getItem(ENGINE_ACCURACY_KEY)||'null');
    if(d && d.ai !== undefined){
      _engineAccuracy = d;
      console.log('引擎准确率已加载:', _engineAccuracy);
    }
  }catch(e){}
}
function saveEngineAccuracy(){
  try{ localStorage.setItem(ENGINE_ACCURACY_KEY, JSON.stringify(_engineAccuracy)); }catch(e){}
}
function updateEngineAccuracy(){
  // 在每日复盘时调用: 基于“已验证”的预测快照更新引擎准确率
  const latestVerified = [...predictionTracker].reverse().find(p => p.verified && p.verification);
  if(!latestVerified) return;
  const verifyDate = latestVerified.verification?.verifyDate;
  if(!verifyDate) return;
  const lastUpdated = localStorage.getItem(ENGINE_ACCURACY_LAST_UPDATE_KEY) || '';
  if(lastUpdated === verifyDate) return;

  let aiCorrect=0,aiTotal=0,rlCorrect=0,rlTotal=0,btCorrect=0,btTotal=0;
  Object.entries(latestVerified.verification.results || {}).forEach(([code, r]) => {
    const snap = latestVerified.holdings?.[code];
    if(!snap) return;
    const actualPct = r.nextDayPct;
    const direction = actualPct > 0.3 ? 1 : actualPct < -0.3 ? -1 : 0;

    // AI引擎
    const aiDir = snap.aiVote > 0 ? 1 : snap.aiVote < 0 ? -1 : 0;
    aiTotal++;
    if(aiDir === direction || (aiDir === 0 && Math.abs(actualPct) < 1)) aiCorrect++;

    // RL引擎
    const rlDir = snap.rlVote > 0 ? 1 : snap.rlVote < 0 ? -1 : 0;
    rlTotal++;
    if(rlDir === direction || (rlDir === 0 && Math.abs(actualPct) < 1)) rlCorrect++;

    // BT引擎
    const btDir = snap.btVote > 0 ? 1 : snap.btVote < 0 ? -1 : 0;
    btTotal++;
    if(btDir === direction || (btDir === 0 && Math.abs(actualPct) < 1)) btCorrect++;
  });
  // EMA更新
  if(aiTotal > 0) _engineAccuracy.ai = _engineAccuracy.ai * (1-ENGINE_ACCURACY_EMA) + (aiCorrect/aiTotal) * ENGINE_ACCURACY_EMA;
  if(rlTotal > 0) _engineAccuracy.rl = _engineAccuracy.rl * (1-ENGINE_ACCURACY_EMA) + (rlCorrect/rlTotal) * ENGINE_ACCURACY_EMA;
  if(btTotal > 0) _engineAccuracy.bt = _engineAccuracy.bt * (1-ENGINE_ACCURACY_EMA) + (btCorrect/btTotal) * ENGINE_ACCURACY_EMA;
  saveEngineAccuracy();
  localStorage.setItem(ENGINE_ACCURACY_LAST_UPDATE_KEY, verifyDate);
  console.log(`引擎准确率更新: AI=${(_engineAccuracy.ai*100).toFixed(0)}% RL=${(_engineAccuracy.rl*100).toFixed(0)}% BT=${(_engineAccuracy.bt*100).toFixed(0)}%`);
}

// ==================== 共享三引擎投票核心 (含Regime+动态权重+反羊群+时序一致性) ====================
function computeTriEngineVote(code, aiSig, rlSig, btR){
  // === 引擎1: AI信号投票 ===
  let aiVote = 0, aiConf = 0, aiReason = '';
  if(aiSig){
    aiVote = aiSig.action === 'buy' ? 1 : aiSig.action === 'sell' ? -1 : 0;
    aiConf = aiSig.confidence || 0;
    aiReason = aiSig.reason || '';
  }
  // === 引擎2: RL信号投票 ===
  let rlVote = 0, rlConf = 0;
  if(rlSig){
    rlVote = rlSig.action === 1 ? 1 : rlSig.action === 2 ? -1 : 0;
    rlConf = rlSig.confidence || 0;
    if(rlSig.conviction === '强') rlConf = Math.min(rlConf * 1.3, 98);
    else if(rlSig.conviction === '弱') rlConf *= 0.6;
  }
  // === 引擎3: 回测多因子投票 ===
  let btVote = 0, btConf = 0;
  if(btR){
    const rsi = btR.lastRSI || 50;
    const sharpe = btR.sharpe || 0;
    const sortino = btR.sortino || 0;
    const kelly = btR.finalKelly || 0;
    const winRate = btR.winRate || 0;
    const btScore = sharpe * 0.3 + sortino * 0.2 + kelly * 5 + (50 - rsi) / 100;
    // 强信号区
    if(rsi < 30 && sharpe > 0){ btVote = 1; btConf = 85; }
    else if(rsi < 35 && sharpe > 0){ btVote = 1; btConf = 80; }
    else if(rsi < 40 && btScore > 0.3){ btVote = 1; btConf = 72; }
    else if(rsi < 45 && btScore > 0.5){ btVote = 1; btConf = 68; }
    // 中等信号区：RSI偏低+正向因子 → 温和买入
    else if(rsi < 50 && sharpe > 0.3){ btVote = 1; btConf = 58; }
    else if(rsi < 50 && winRate > 0.55 && kelly > 0.03){ btVote = 1; btConf = 55; }
    // 卖出信号区
    else if(rsi > 80){ btVote = -1; btConf = 85; }
    else if(rsi > 75){ btVote = -1; btConf = 78; }
    else if(rsi > 70 && sharpe < 0.3){ btVote = -1; btConf = 68; }
    else if(rsi > 65 && sharpe < 0){ btVote = -1; btConf = 62; }
    // 温和卖出：RSI偏高+负因子
    else if(rsi > 60 && sharpe < -0.3){ btVote = -1; btConf = 55; }
    // 中性区但有方向性偏置 → 给出弱信号而非0
    else if(sharpe > 0.8 && winRate > 0.55){ btVote = 1; btConf = 50; }
    else if(sharpe < -0.5 && winRate < 0.4){ btVote = -1; btConf = 50; }
 // RSI 50-65中性区: 根据RSI相对位置+Sharpe给出弱方向性信号
    else if(rsi <= 55 && sharpe > 0){ btVote = 1; btConf = 45; }
    else if(rsi >= 58 && sharpe < 0){ btVote = -1; btConf = 45; }
    else if(sharpe > 0.3){ btVote = 1; btConf = 42; }
    else if(sharpe < -0.2){ btVote = -1; btConf = 42; }
    else { btVote = 0; btConf = 40; }
  }

  // === 引擎3b: 趋势动量补充投票 (当BT中性时用趋势数据补信号) ===
  const _trendData = fundHistoryData[code]?.trend;
  let trendVote = 0, trendConf = 0;
  if(_trendData){
    const { trendDir, chg5d, chg20d, swingPos, reboundFromLow, drawdownFromHigh } = _trendData;
    // 基于5日/20日动量+趋势方向给出投票
    if(trendDir === 'strong_up' || chg5d >= 2){ trendVote = 1; trendConf = 60; }
    else if(trendDir === 'up' || chg5d >= 0.5){ trendVote = 1; trendConf = 48; }
    else if(trendDir === 'strong_down' || chg5d <= -2){ trendVote = -1; trendConf = 60; }
    else if(trendDir === 'down' || chg5d <= -0.5){ trendVote = -1; trendConf = 48; }
    // 深度回调+反弹信号
    else if(swingPos === 'deep_dip' || drawdownFromHigh < -15){ trendVote = 1; trendConf = 55; }
    // 冲高见顶信号
    else if(swingPos === 'surge' && drawdownFromHigh > -2){ trendVote = -1; trendConf = 55; }
    // 弱方向
    else if(chg5d > 0){ trendVote = 1; trendConf = 38; }
    else if(chg5d < 0){ trendVote = -1; trendConf = 38; }
  }
  // 今日涨跌幅作为最后兜底
  if(trendVote === 0){
    const fd = getFundData(code);
    const todayPct = parseFloat(fd?.gszzl || 0);
    if(Math.abs(todayPct) >= 0.5){
      trendVote = todayPct > 0 ? 1 : -1;
      trendConf = Math.min(50, 30 + Math.abs(todayPct) * 5);
    }
  }
  // 如果BT投票为0且趋势有信号，用趋势信号替补BT
  if(btVote === 0 && trendVote !== 0){
    btVote = trendVote;
    btConf = Math.min(trendConf, 50); // 趋势信号置信度上限50%
  }

  // === 1. 基础权重 ===
  let aiW = Math.min(aiConf, 95) / 100;
  let rlW = Math.min(rlConf, 95) / 100;
  let btW = btR ? Math.min((Math.abs(btR.sharpe||0)*0.3 + (btR.winRate||0)*0.5), 0.85) : 0;
  // RL不确定性动态调权
  if(rlSig?.uncertainty !== undefined){
    if(rlSig.uncertainty > 0.5) rlW *= 0.5;
    else if(rlSig.uncertainty < 0.1) rlW *= 1.3;
  }

  // === 2. 历史准确率加权(自学习) ===
  aiW *= (_engineAccuracy.ai * 2); // 0~1 → 0~2倍
  rlW *= (_engineAccuracy.rl * 2);
  btW *= (_engineAccuracy.bt * 2);

  // === 3. 市场Regime加权 ===
  aiW *= _regimeWeights.ai;
  rlW *= _regimeWeights.rl;
  btW *= _regimeWeights.bt;

  // === 4. 加权投票 ===
  const totalW = aiW + rlW + btW || 1;
  let score = (aiVote * aiW + rlVote * rlW + btVote * btW) / totalW;

  const votes = [aiVote, rlVote, btVote].filter(v => v !== 0);
  const buyVotes = votes.filter(v => v > 0).length;
  const sellVotes = votes.filter(v => v < 0).length;

  // === 4.2 波段止盈/连涨衰减(Swing Trading Profit-Taking) ===
  // 连续上涨冲高 + 接近高点 → 抑制买入信号，增强止盈信号
  const trendData = fundHistoryData[code]?.trend;
  let swingDampen = 0; // 负=抑制买入/鼓励卖出
  if(trendData){
    const { swingPos, chg5d, chg20d, drawdownFromHigh, reboundFromLow } = trendData;
    const rsi = btR?.lastRSI || 50;
    // 1. 连续冲高(5日涨≥3%或连续rally/surge)：卖出方向偏置
    if(swingPos === 'surge' || chg5d >= 3){
      swingDampen -= 0.25; // 强冲高
      if(rsi > 70) swingDampen -= 0.15; // RSI超买加码
    } else if(swingPos === 'rally' || chg5d >= 1.5){
      swingDampen -= 0.12; // 温和上涨
      if(rsi > 65) swingDampen -= 0.08;
    }
    // 2. 接近年内高点(回撤<2%)：高位风险溢价
    if(drawdownFromHigh > -2 && drawdownFromHigh <= 0){
      swingDampen -= 0.15; // 接近新高
      if(chg5d >= 1.5) swingDampen -= 0.1; // 冲高+近高点=双重风险
    }
    // 3. 中期涨幅过大(20日>10%)：获利盘压力
    if(chg20d > 10) swingDampen -= 0.15;
    else if(chg20d > 6) swingDampen -= 0.08;
    // 4. 底部反弹过快(距低点反弹>25%且5日继续涨)：反弹尾声警告
    if(reboundFromLow > 25 && chg5d >= 1) swingDampen -= 0.1;
  }
  // 应用波段衰减：影响score方向
  if(swingDampen < 0){
    score += swingDampen; // 负值会将score拉向卖出方向
  }

  // === 4.3 宏观面量化偏置(Macro Quantitative Bias) ===
  // 将宏观数据（PMI/CPI/PPI/M2/GDP）量化注入决策
  let macroBias = 0;
  if(_dataIntelLoaded){
    const macro = getMacroSummary();
    // 宏观偏暖(4-5项正面)→轻微看多; 偏冷(0-1项)→看空
    if(macro.positiveCount >= 4) macroBias = 0.08;
    else if(macro.positiveCount >= 3) macroBias = 0.03;
    else if(macro.positiveCount <= 1) macroBias = -0.1;
    else if(macro.positiveCount <= 2) macroBias = -0.04;
    // 特殊：PMI连续收缩 → 对周期品(有色/油气/化工)额外利空
    const fType = (fundType(code)||'').toLowerCase();
    const isCyclical = fType.includes('有色') || fType.includes('油') || fType.includes('能源') || fType.includes('化工') || fType.includes('钢铁');
    if(isCyclical && macro.signals.find(s => s.name==='PMI' && !s.positive)){
      macroBias -= 0.08; // PMI收缩+周期品=额外利空
    }
    // PPI上涨利好资源品，PPI下跌利空资源品
    const ppiSig = macro.signals.find(s => s.name==='PPI');
    if(isCyclical && ppiSig){
      const ppiVal = parseFloat(ppiSig.value);
      if(ppiVal > 2) macroBias += 0.06;
      else if(ppiVal < -2) macroBias -= 0.06;
    }
    // 资金流向：对应板块大幅流出 → 利空
    const capFlow = getRelevantCapFlow(code);
    if(capFlow){
      if(capFlow.mainNet < -5e8) macroBias -= 0.06; // 板块主力净流出>5亿
      else if(capFlow.mainNet > 5e8) macroBias += 0.04; // 净流入>5亿
    }
    score += macroBias;
  }

  // === 4.5 地缘事件偏置(Geopolitical Event Bias) ===
  // 当基金与重大地缘事件强关联时，注入方向性偏置
  const geoAnalysis = getMacroGeoAnalysis();
  const geoFundImpact = geoAnalysis.fundImpacts[code];
  let geoBias = 0;
  if(geoFundImpact && geoFundImpact.events.length > 0){
    geoBias = geoFundImpact.score; // 正=利好, 负=利空
    // 加权注入: 地缘偏置最大贡献±0.5
    const clampedBias = Math.max(-0.5, Math.min(0.5, geoBias));
    // 混合: 引擎信号弱时地缘权重更大
    const engineActivity = Math.min(1, (Math.abs(aiVote) + Math.abs(rlVote) + Math.abs(btVote)) / 2);
    const geoWeight = engineActivity < 0.5 ? 0.45 : 0.25; // 引擎无信号→地缘45%, 有信号→25%
    score = score * (1 - geoWeight) + clampedBias * geoWeight;
  }

  // === 5. 共识乘数 + 反羊群效应 ===
  let consensusMult = 1.0;
  const maxSameDir = Math.max(buyVotes, sellVotes);
  if(maxSameDir >= 3) consensusMult = 1.4;
  else if(maxSameDir >= 2 && votes.length >= 2) consensusMult = 1.15;
  else if(buyVotes > 0 && sellVotes > 0) consensusMult = 0.4;
  // 反羊群: 全票一致 + 极端市场位置 → 逆向缓冲
  if(maxSameDir >= 3 && btR){
    const rsi = btR.lastRSI || 50;
    const rangePos = btR.equity?.length > 0 ? 0.5 : 0.5; // approximate
    if(buyVotes === 3 && rsi > 70){
      // 三引擎全票买入但RSI超买 → 可能是共识陷阱
      consensusMult = Math.min(consensusMult, 1.0);
    }
    if(sellVotes === 3 && rsi < 30){
      // 三引擎全票卖出但RSI超卖 → 可能是恐慌底部
      consensusMult = Math.min(consensusMult, 1.0);
    }
  }

  // === 6. 时序一致性(防翻转) ===
  const lastSig = _lastTriSignals[code];
  let temporalScore = score;
  const geoOverride = Math.abs(geoBias) > 0.2; // 强地缘事件可突破惯性
  if(lastSig && lastSig.date === todayStr()){
    // 同日内不翻转
    temporalScore = score;
  } else if(lastSig && !geoOverride){
    // 无地缘覆盖时: 应用惯性 30%前信号 + 70%当前信号
    temporalScore = score * 0.7 + lastSig.score * 0.3;
    // 方向翻转需要更大阈值(滞回)
    if(lastSig.action === 'buy' && score < 0 && score > -0.3){
      temporalScore = Math.max(temporalScore, 0); // 买→卖需 score < -0.3
    }
    if(lastSig.action === 'sell' && score > 0 && score < 0.3){
      temporalScore = Math.min(temporalScore, 0); // 卖→买需 score > 0.3
    }
  } else if(lastSig && geoOverride){
    // 有强地缘事件时: 减少惯性(仅15%), 让地缘信号快速生效
    temporalScore = score * 0.85 + lastSig.score * 0.15;
  }

  // === 7. 组合风险约束 ===
  const portRisk = getPortfolioRiskMetrics();
  let riskMult = 1.0;
  const hasGeoSupport = geoBias > 0.15; // 地缘利好保护
  if(portRisk.riskScore > 0.7){
    // 组合高风险: 抑制买入，鼓励卖出
    if(temporalScore > 0) riskMult = hasGeoSupport ? 0.75 : 0.5; // 有地缘支撑时少抑制
    else if(temporalScore < 0) riskMult = 1.3;
  }
  if(portRisk.cashRatio < 0.05 && temporalScore > 0){
    riskMult *= hasGeoSupport ? 0.6 : 0.3; // 地缘利好时给更多余地
  }
  // 集中度过高→限制已有重仓基金的买入
  const fundW = portRisk.fundWeight[code] || 0;
  if(fundW > 0.25 && temporalScore > 0) riskMult *= 0.5;
  // 地缘事件保底: riskMult 不低于0.5(确保地缘信号不被完全扼杀)
  if(hasGeoSupport && riskMult < 0.5) riskMult = 0.5;

  // === 8. 最终决策 ===
  const finalScore = temporalScore * riskMult;
 let action = 'hold', actionLabel = ' 持有观望';
  // effConf: 当AI未分析时(aiConf=0)，用地缘事件置信度作为备用
  const geoConfFallback = geoBias > 0 ? Math.min(80, geoBias * 60) : 0;
  const baseConf = aiConf > 0 ? aiConf : geoConfFallback;
  const effConf = baseConf * consensusMult * riskMult;
  // 当有强地缘事件支撑时，降低买入阈值(更容易触发)
  const hasStrongGeo = geoBias > 0.15;
  const buyScoreThreshold = hasStrongGeo ? 0.1 : 0.2;
  const buyConfThreshold = hasStrongGeo ? 30 : 55;
  const sellScoreThreshold = geoBias < -0.15 ? -0.1 : -0.2;
  const totalVotes = Math.abs(aiVote) + Math.abs(rlVote) + Math.abs(btVote);
  // 统一决策逻辑 —— 无论引擎是否有信号都走相同路径
 if(finalScore > buyScoreThreshold && (effConf >= buyConfThreshold || hasStrongGeo)){ action = 'buy'; actionLabel = ' 建议加仓'; }
 else if(finalScore < sellScoreThreshold && effConf >= 50){ action = 'sell'; actionLabel = ' 建议减仓'; }
 else if(finalScore > 0.08){ actionLabel = ' 偏多持有'; }
 else if(finalScore < -0.08){ actionLabel = ' 偏空持有'; }

  // Kelly建议仓位(受组合风险调整 + 反拥挤度惩罚)
  const kelly = btR?.finalKelly || 0.05;
  let adjKelly = Math.min(kelly * consensusMult * Math.max(0.3, 1 - portRisk.riskScore), 0.25);

  // === 9. 反拥挤度Kelly调整 (Second-Order Thinking) ===
  let crowdingPenalty = 1.0, contrarianBonus = 1.0, sotStatus = 'normal';
  if(typeof _hotEventsData !== 'undefined' && _hotEventsData?.heatmap){
    const fType = (fundType(code) || '').toLowerCase();
    const heatEntry = _hotEventsData.heatmap.find(h =>
      fType.includes(h.tag.slice(0,2).toLowerCase()) || h.tag.toLowerCase().includes(fType.slice(0,2))
    );
    if(heatEntry){
      const crowdScore = heatEntry.temperature;
      const rsi = btR?.lastRSI || 50;
      // 拥挤度惩罚: 极热+超买 → 大幅压缩仓位
      if(crowdScore > 80 && rsi > 70){ crowdingPenalty = 0.2; sotStatus = 'crowded'; }
      else if(crowdScore > 80){ crowdingPenalty = 0.4; sotStatus = 'crowded'; }
      else if(crowdScore > 60 && rsi > 65){ crowdingPenalty = 0.65; }
      // 逆向奖励: 极冷+超卖 → 给予流动性补偿
      if(crowdScore < 20 && rsi < 30){ contrarianBonus = 1.25; sotStatus = 'contrarian'; }
      else if(crowdScore < 25 && rsi < 35){ contrarianBonus = 1.12; sotStatus = 'contrarian'; }
    }
  }
  adjKelly = Math.min(adjKelly * crowdingPenalty * contrarianBonus, 0.25);

  // 记录信号(用于时序一致性)
  _lastTriSignals[code] = { action, score: finalScore, date: todayStr(), confidence: effConf };

  return {
    action, actionLabel, score: finalScore, rawScore: score, consensusMult, riskMult,
    regime: _marketRegime, portRisk: portRisk.riskScore,
    geoBias, geoEvents: geoFundImpact?.events || [],
    swingDampen, macroBias,
    buyVotes, sellVotes,
    crowdingPenalty, contrarianBonus, sotStatus,
    ai: { vote: aiVote, conf: aiConf, reason: aiReason, accuracy: _engineAccuracy.ai, label: aiVote>0?'买入':aiVote<0?'卖出':'持有' },
    rl: { vote: rlVote, conf: rlConf, conviction: rlSig?.conviction||'--', uncertainty: rlSig?.uncertainty||0, accuracy: _engineAccuracy.rl, label: rlSig?.actionName||'--' },
    bt: { vote: btVote, conf: btConf, sharpe: btR?.sharpe||0, sortino: btR?.sortino||0, rsi: btR?.lastRSI||50, maxDD: btR?.maxDD||0, winRate: btR?.winRate||0, kelly: adjKelly, accuracy: _engineAccuracy.bt },
    effConf: Math.round(effConf),
    engineWeights: { ai: aiW.toFixed(2), rl: rlW.toFixed(2), bt: btW.toFixed(2) }
  };
}

function getTriEngineVote(code){
  return computeTriEngineVote(code, _analysisResult?.signals?.[code], _rlSignals[code], btResults[code]);
}

// === 板块资金流匹配基金类型 ===
function getRelevantCapFlow(code){
  if(!sectorCapFlow.length) return null;
  const fType = (fundType(code)||'').toLowerCase();
  const fName = (fundName(code)||'').toLowerCase();
  const typeMap = {
    '黄金':['贵金属','黄金'],
    '有色金属':['有色金属','矿业','有色'],
    'ai/科技':['计算机','电子','科技','通信','信息技术'],
    '半导体':['半导体','电子','芯片'],
    '军工':['军工','国防'],
    '新能源':['新能源','电力设备','汽车'],
    '消费':['食品饮料','家电','商贸零售','消费'],
    '医药':['医药','生物'],
    '红利':['银行','煤炭','公用事业'],
    '金融':['券商','银行','保险','金融','非银金融'],
    '宽基':[], // 宽基不匹配单一板块
    '油气':['石油石化','能源','煤炭','化工'],
    '原油':['石油石化','能源'],
    '能源':['石油石化','能源','煤炭'],
    '化工':['化工','基础化工'],
    '白酒/消费':['食品饮料','消费','白酒'],
    '蓝筹':['银行','食品饮料','金融'],
    '蓝筹/QDII':[], // QDII不匹配A股板块
    '钢铁':['钢铁','金属'],
    '港股科技/QDII':[], // 港股不匹配A股板块
  };
  const matchSectors = typeMap[fType] || [];
  // 额外从基金名称提取关键词
  const extraKw = [];
  if(fName.includes('银行')) extraKw.push('银行');
  if(fName.includes('券商')||fName.includes('证券')) extraKw.push('券商','非银金融');
  if(fName.includes('医药')||fName.includes('医疗')) extraKw.push('医药','生物');
  if(fName.includes('消费')||fName.includes('食品')) extraKw.push('食品饮料','消费');
  if(fName.includes('科技')||fName.includes('ai')||fName.includes('人工智能')) extraKw.push('计算机','电子');
  if(fName.includes('油气')||fName.includes('原油')||fName.includes('石油')) extraKw.push('石油石化','能源','化工');
  if(fName.includes('能源')&&!fName.includes('新能源')) extraKw.push('石油石化','能源','煤炭');
  if(fName.includes('煤炭')) extraKw.push('煤炭','能源');
  if(fName.includes('化工')) extraKw.push('化工','基础化工');
  const allKw = [...new Set([...matchSectors, ...extraKw])];
  for(const sec of allKw){
    const found = sectorCapFlow.find(s => s.name.includes(sec) || sec.includes(s.name));
    if(found) return found;
  }
  return null;
}

// === 组合板块集中度分析 ===
function getPortfolioSectorAnalysis(plans){
  const typeGroups = {};
  // 增强: 基于实际持仓行业分布的集中度分析
  const sectorWeights = {}; // 各行业在组合中的综合权重
  plans.forEach(p => {
    const t = fundType(p.code) || '其他';
    if(!typeGroups[t]) typeGroups[t] = { count:0, codes:[], totalAction:0 };
    typeGroups[t].count++;
    typeGroups[t].codes.push(p.code);
    if(p.vote.action === 'buy') typeGroups[t].totalAction++;
    else if(p.vote.action === 'sell') typeGroups[t].totalAction--;
    // 统计行业暴露
    const sectorExp = getFundSectorExposure(p.code);
    if(sectorExp && Object.keys(sectorExp).length > 0){
      Object.entries(sectorExp).forEach(([sec, weight]) => {
        sectorWeights[sec] = (sectorWeights[sec] || 0) + weight / plans.length;
      });
    }
  });
  const warnings = [];
  Object.entries(typeGroups).forEach(([type, info]) => {
    if(info.count >= 2){
      warnings.push({ type, count: info.count, sameBias: info.totalAction === info.count || info.totalAction === -info.count });
    }
  });
  // 基于持仓行业的集中度警告
  Object.entries(sectorWeights).forEach(([sec, weight]) => {
    if(weight > 0.35 && !warnings.some(w => w.type.includes(sec))){
      warnings.push({ type: `${sec}(持仓)`, count: Math.ceil(weight * plans.length), sameBias: false });
    }
  });
  // 板块分布 (增强: 合并基金类型和持仓行业)
  const distribution = Object.entries(typeGroups)
    .map(([type, info]) => ({ type, count: info.count, pct: Math.round(info.count / plans.length * 100) }))
    .sort((a,b) => b.count - a.count);
  return { warnings, distribution, sectorWeights };
}

// === 综合趋势标签生成 ===
function getTrendLabel(td){
  if(!td) return { icon:'', text:'', color:'var(--sub)' };
  const dirMap = {
    'strong_up': { icon:'🔥', text:'强势上攻', color:'#ef4444' },
    'up': { icon:'📈', text:'趋势向上', color:'#f87171' },
    'sideways': { icon:'↔️', text:'横盘震荡', color:'#fbbf24' },
    'down': { icon:'📉', text:'趋势走弱', color:'#4ade80' },
    'strong_down': { icon:'⚠️', text:'强势下跌', color:'#22c55e' },
  };
  const swingMap = {
    'deep_dip': { icon:'💎', text:'深度回调', color:'#ef4444' },
    'dip': { icon:'🔻', text:'短期回调', color:'#f87171' },
    'mid': { icon:'●', text:'中位运行', color:'var(--sub)' },
    'rally': { icon:'🔺', text:'短期反弹', color:'#fbbf24' },
    'surge': { icon:'🚀', text:'短期冲高', color:'#4ade80' },
  };
  return {
    dir: dirMap[td.trendDir] || dirMap['sideways'],
    swing: swingMap[td.swingPos] || swingMap['mid'],
    maStatus: td.latest > td.ma5 && td.ma5 > td.ma20 && td.ma20 > td.ma60 ? '多头排列' :
              td.latest < td.ma5 && td.ma5 < td.ma20 && td.ma20 < td.ma60 ? '空头排列' : '交织',
    drawdown: td.drawdownFromHigh,
    rebound: td.reboundFromLow,
  };
}

// === 生成波段操作分析(每只基金独立) ===
function generateSwingAnalysis(code, td, vote, capFlow){
  if(!td) return { html: '', phase: 'unknown', plan: '' };
  
  const { chg5d, chg20d, chg60d, drawdownFromHigh, reboundFromLow, swingPos, trendDir, trendScore, ma5, ma20, ma60, latest } = td;
  const rsi = vote.bt?.rsi || 50;
  const todayPct = vote.ai?.conf > 0 ? (getFundData(code)?.gszzl || 0) : 0;
  const fType = fundType(code) || '';
  const isSatellite = !(fType.match(/宽基|红利|黄金|债券/));

  // === 1. 判断当前所处波段阶段 ===
  let phase = '', phaseIcon = '', phaseColor = '', phaseDesc = '';
  
  // 基于多维度综合判断波段阶段(非简单5日涨跌)
  if(trendDir === 'strong_up' || trendDir === 'up'){
    if(swingPos === 'surge' || (chg5d >= 3 && drawdownFromHigh > -2)){
 phase = 'peak_zone'; phaseIcon = ''; phaseColor = '#ef4444';
      phaseDesc = '冲顶区间 — 连续上涨接近高点，获利盘压力最大的区域';
    } else if(swingPos === 'rally' || (chg5d >= 1 && chg20d > 5)){
 phase = 'accel_up'; phaseIcon = ''; phaseColor = '#f59e0b';
      phaseDesc = '加速上涨 — 趋势维持但涨速加快，需关注冲高回落';
    } else if(swingPos === 'dip' || swingPos === 'deep_dip'){
 phase = 'trend_pullback'; phaseIcon = ''; phaseColor = '#3b82f6';
      phaseDesc = '趋势内回调 — 上升趋势中的正常回调，经典波段低吸位';
    } else {
 phase = 'steady_up'; phaseIcon = ''; phaseColor = '#22c55e';
      phaseDesc = '稳步上行 — 趋势健康运行中，价格在均线附近';
    }
  } else if(trendDir === 'strong_down' || trendDir === 'down'){
    if(swingPos === 'rally' || swingPos === 'surge'){
 phase = 'bear_bounce'; phaseIcon = ''; phaseColor = '#f59e0b';
      phaseDesc = '下跌反弹 — 大趋势向下的短暂反弹，不宜追涨，可逢高减仓';
    } else if(swingPos === 'deep_dip'){
 phase = 'free_fall'; phaseIcon = ''; phaseColor = '#ef4444';
      phaseDesc = '加速下跌 — 空头主导，不建议接刀，等待企稳信号';
    } else {
 phase = 'decline'; phaseIcon = ''; phaseColor = '#f87171';
      phaseDesc = '下行通道 — 趋势偏弱，反弹高度有限，控制仓位';
    }
  } else { // sideways
    if(swingPos === 'dip' || swingPos === 'deep_dip'){
 phase = 'range_low'; phaseIcon = ''; phaseColor = '#3b82f6';
      phaseDesc = '震荡区间低位 — 接近箱体底部，可小仓位试探';
    } else if(swingPos === 'surge' || swingPos === 'rally'){
 phase = 'range_high'; phaseIcon = ''; phaseColor = '#94a3b8';
      phaseDesc = '震荡区间高位 — 接近箱体顶部，宜减仓或等回调';
    } else {
 phase = 'range_mid'; phaseIcon = '↔'; phaseColor = '#94a3b8';
      phaseDesc = '震荡中位 — 方向不明，等待突破或跌至箱底';
    }
  }

  // === 2. 生成波段操作计划 ===
  let plan = '', planIcon = '';
  const priceFmt = (v) => v.toFixed(4);
  
  // 计算关键波段价格参考点（基于均线和高低点）
  const supportLevel = Math.min(ma20, ma60).toFixed(4);   // 支撑位
  const resistLevel = td.high1y?.toFixed(4) || latest.toFixed(4); // 阻力位
  const ma20Str = ma20.toFixed(4);
  const ma60Str = ma60.toFixed(4);
  
  // 成交量/资金辅助判断
  const hasCapInflow = capFlow && capFlow.mainNet > 1e8;
  const hasCapOutflow = capFlow && capFlow.mainNet < -1e8;
  const capFlowHint = hasCapInflow ? '(主力资金净流入，支撑上涨)' 
    : hasCapOutflow ? '(注意：主力资金净流出)' : '';

  if(phase === 'peak_zone'){
 planIcon = '';
    plan = `<b>波段计划：分批止盈</b>\n`;
    plan += `连续冲高${chg5d>=0?'+':''}${chg5d.toFixed(1)}%(5日)且距年内高点仅${Math.abs(drawdownFromHigh).toFixed(1)}%，`;
    plan += `RSI=${rsi.toFixed(0)}${rsi>70?'(超买区)':''}，获利盘压力大。`;
    plan += `<br>→ <b>建议分2-3批止盈</b>，先卖出20-30%锁定利润`;
    plan += `<br>→ 若回落至MA20(${ma20Str})附近企稳，可重新考虑买回`;
    plan += `<br>→ 止盈后保留底仓，等波段低点再接回${capFlowHint}`;
    if(isSatellite) plan += `<br>→ 卫星仓品种，波段高位止盈是纪律，"会卖的是师傅"`;
  } else if(phase === 'accel_up'){
 planIcon = '';
    plan = `<b>波段计划：跟踪持有+止盈准备</b>\n`;
    plan += `趋势向上且近期加速(5日${chg5d>=0?'+':''}${chg5d.toFixed(1)}%，20日${chg20d>=0?'+':''}${chg20d.toFixed(1)}%)${capFlowHint}。`;
    plan += `<br>→ <b>维持持有</b>，但设置移动止盈线在MA5(${priceFmt(ma5)})`;
    plan += `<br>→ 若价格跌破MA5且缩量，先减仓30%`;
    plan += `<br>→ 跌破MA20(${ma20Str})则果断止盈剩余仓位`;
    plan += `<br>→ 不宜此时追高加仓，等回调至MA20附近再考虑`;
  } else if(phase === 'trend_pullback'){
 planIcon = '';
    plan = `<b>波段计划：低吸加仓</b>\n`;
    plan += `上升趋势中出现回调(5日${chg5d.toFixed(1)}%)，价格回到均线附近，这是经典的波段买点。`;
    plan += `<br>→ <b>建议分批低吸</b>，MA20(${ma20Str})附近建仓`;
    plan += `<br>→ 第一批(40%计划仓位)在当前价位；第二批在MA60(${ma60Str})附近`;
    plan += `<br>→ 止损线设在MA60下方3-5%，跌破清仓`;
    plan += `<br>→ 目标：反弹至前高附近分批止盈${capFlowHint}`;
  } else if(phase === 'steady_up'){
 planIcon = '';
    plan = `<b>波段计划：沿趋势持有</b>\n`;
    plan += `趋势健康，价格沿均线稳步上行${capFlowHint}。`;
    plan += `<br>→ <b>已持有则继续持有</b>，用MA20(${ma20Str})作为动态止盈线`;
    plan += `<br>→ 未持有可在回调至MA20时小仓位参与`;
    plan += `<br>→ 不追涨，等价格脱离均线过远(涨>5%)再考虑止盈`;
  } else if(phase === 'bear_bounce'){
 planIcon = '';
    plan = `<b>波段计划：逢反弹减仓</b>\n`;
    plan += `大趋势下行中的反弹(5日${chg5d>=0?'+':''}${chg5d.toFixed(1)}%)，反弹高度通常有限。`;
    plan += `<br>→ <b>趁反弹减仓30-50%</b>，不追涨`;
    plan += `<br>→ 反弹到MA20(${ma20Str})或MA60(${ma60Str})是典型压力位`;
    plan += `<br>→ 若价格受阻于均线压力回落，确认减仓`;
    plan += `<br>→ 等趋势确认反转(MA5上穿MA20)后再重新建仓${capFlowHint}`;
  } else if(phase === 'free_fall'){
 planIcon = '';
    plan = `<b>波段计划：回避观望</b>\n`;
    plan += `处于加速下跌中(5日${chg5d.toFixed(1)}%，距高点${drawdownFromHigh.toFixed(1)}%)，下跌趋势未见止跌信号。`;
    plan += `<br>→ <b>不接飞刀</b>，空仓等待`;
    plan += `<br>→ 等待日线级别止跌信号：放量长下影线 / 连续3日不创新低`;
    plan += `<br>→ 企稳后第一次反弹不急进，等二次回踩确认底部再入场`;
    plan += `<br>→ 已有仓位应趁反弹果断止损${capFlowHint}`;
  } else if(phase === 'decline'){
 planIcon = '';
    plan = `<b>波段计划：控制仓位</b>\n`;
    plan += `趋势走弱，均线空头排列中${capFlowHint}。`;
    plan += `<br>→ <b>已有仓位减至半仓以下</b>`;
    plan += `<br>→ 反弹至MA20(${ma20Str})是减仓窗口`;
    plan += `<br>→ 只有当价格站稳MA20且MA5拐头向上时，才小仓位试探`;
    plan += `<br>→ 严格止损：再创新低则清仓`;
  } else if(phase === 'range_low'){
 planIcon = '';
    plan = `<b>波段计划：箱底试探</b>\n`;
    plan += `横盘震荡中回调至低位(5日${chg5d.toFixed(1)}%)，接近箱体下沿。`;
    plan += `<br>→ <b>可小仓位(20-30%)试探</b>，在支撑位(MA60 ${ma60Str})附近`;
    plan += `<br>→ 止损设在箱体下沿下方2%`;
    plan += `<br>→ 目标：反弹至箱体上沿(MA5 ${priceFmt(ma5)}附近)时止盈${capFlowHint}`;
  } else if(phase === 'range_high'){
 planIcon = '';
    plan = `<b>波段计划：箱顶止盈</b>\n`;
    plan += `横盘震荡中冲高至高位(5日${chg5d>=0?'+':''}${chg5d.toFixed(1)}%)，接近箱体上沿。`;
    plan += `<br>→ <b>建议减仓20-30%</b>，锁定利润`;
    plan += `<br>→ 若有效突破箱顶并站稳，可追回(但需设止损)`;
    plan += `<br>→ 回落则等箱底再接回${capFlowHint}`;
  } else {
 planIcon = '↔';
    plan = `<b>波段计划：观望等待</b>\n`;
    plan += `横盘震荡中位，方向不明${capFlowHint}。`;
    plan += `<br>→ 不宜加仓，等待回调至MA20(${ma20Str})以下或突破前高后参与`;
    plan += `<br>→ 已有仓位持有不动，设好止损线`;
  }

  // === 3. 补充AI全局分析与波段的综合判断 ===
  let aiSwingNote = '';
  if(vote.ai.vote !== 0 && vote.ai.conf > 50){
    const aiDir = vote.ai.vote > 0 ? '看多' : '看空';
    // AI方向与波段阶段矛盾时给出警示
    if(vote.ai.vote > 0 && (phase === 'peak_zone' || phase === 'range_high')){
 aiSwingNote = `AI引擎${aiDir}(置信${vote.ai.conf}%)，但波段处于高位区。建议：<b>尊重波段纪律先止盈一部分</b>，待回调后按AI方向重新买入，可降低持仓成本`;
    } else if(vote.ai.vote < 0 && (phase === 'trend_pullback' || phase === 'range_low')){
 aiSwingNote = `AI引擎${aiDir}(置信${vote.ai.conf}%)，但波段处于低位区。建议：<b>以AI方向为主减仓</b>，但可保留少量底仓作为万一反转的"保险"`;
    } else if(vote.ai.vote > 0 && (phase === 'trend_pullback' || phase === 'range_low')){
 aiSwingNote = `AI引擎${aiDir}(置信${vote.ai.conf}%)与波段低位一致：<b>形成共振买点</b>，可更积极地执行低吸计划`;
    } else if(vote.ai.vote < 0 && (phase === 'peak_zone' || phase === 'bear_bounce')){
 aiSwingNote = `AI引擎${aiDir}(置信${vote.ai.conf}%)与波段高位一致：<b>形成共振卖点</b>，止盈/减仓信心更足`;
    }
  }
  // 宏观面与波段的交叉
  let macroSwingNote = '';
  if(vote.macroBias !== undefined){
    if(vote.macroBias < -0.06 && phase === 'peak_zone'){
 macroSwingNote = '宏观面偏冷+波段高位：双杀风险，止盈优先级极高';
    } else if(vote.macroBias > 0.06 && phase === 'trend_pullback'){
 macroSwingNote = '宏观面偏暖+波段低位：双重支撑，低吸安全边际更高';
    } else if(vote.macroBias < -0.04 && (phase === 'accel_up' || phase === 'steady_up')){
 macroSwingNote = '注意：宏观面偏弱，上涨趋势可能面临宏观逆风，适当缩减仓位';
    }
  }

  // === 4. 渲染HTML ===
  let html = '';
  html += `<div style="margin:6px 0 4px;padding:8px 10px;background:linear-gradient(135deg,rgba(79,110,247,0.06),rgba(139,92,246,0.04));border-radius:8px;border-left:3px solid ${phaseColor};font-size:10px;line-height:1.6">`;
  html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">`;
  html += `<span style="font-weight:700;font-size:11px;color:${phaseColor}">${phaseIcon} 波段操作分析</span>`;
  html += `<span style="padding:2px 8px;border-radius:10px;background:${phaseColor}18;color:${phaseColor};font-weight:600;font-size:10px">${phaseDesc.split('—')[0].trim()}</span>`;
  html += `</div>`;
  // 阶段描述
  html += `<div style="color:#475569;margin-bottom:4px">${phaseDesc}</div>`;
  // 波段计划
  html += `<div style="color:#1e293b;margin:4px 0">${planIcon} ${plan}</div>`;
  // 关键价格参考
  html += `<div style="display:flex;gap:6px;flex-wrap:wrap;margin:4px 0;padding:4px 6px;background:rgba(0,0,0,0.03);border-radius:4px;font-size:9px;color:#64748b">`;
  html += `<span>当前:<b>${priceFmt(latest)}</b></span>`;
  html += `<span>MA5:<b>${priceFmt(ma5)}</b></span>`;
  html += `<span>MA20:<b>${ma20Str}</b></span>`;
  html += `<span>MA60:<b>${ma60Str}</b></span>`;
  html += `<span>RSI:<b style="color:${rsi>70?'#ef4444':rsi<30?'#22c55e':'#64748b'}">${rsi.toFixed(0)}</b></span>`;
  html += `<span>5日:<b style="color:${chg5d>=0?'#ef4444':'#22c55e'}">${chg5d>=0?'+':''}${chg5d.toFixed(1)}%</b></span>`;
  html += `<span>20日:<b style="color:${chg20d>=0?'#ef4444':'#22c55e'}">${chg20d>=0?'+':''}${chg20d.toFixed(1)}%</b></span>`;
  html += `<span>距高点:<b>${drawdownFromHigh.toFixed(1)}%</b></span>`;
  html += `</div>`;
  // AI全局分析与波段的互动
  if(aiSwingNote){
    html += `<div style="margin-top:4px;padding:4px 6px;background:rgba(245,158,11,0.08);border-radius:4px;color:#92400e;font-weight:500">${aiSwingNote}</div>`;
  }
  if(macroSwingNote){
    html += `<div style="margin-top:3px;padding:3px 6px;background:rgba(59,130,246,0.06);border-radius:4px;color:#1e40af;font-weight:500">${macroSwingNote}</div>`;
  }
  html += `</div>`;

  return { html, phase, plan: plan.replace(/<[^>]+>/g, '') };
}

// === 生成智能操作理由(整合所有数据源) ===
function generateSmartReason(p, capFlow, ds){
  const { code, td, vote } = p;
  const useRL = !p.disableRLInReason;
  const fType = fundType(code) || '';
  const fName = fundName(code) || '';
  const fd = p.fd;
  const todayPct = fd?.gszzl || 0;

  // ========== Section 1: 引擎共识详述 ==========
  let engineSection = '';
  // AI引擎详述
  if(vote.ai.vote !== 0 || vote.ai.conf > 0){
    const aiDir = vote.ai.vote > 0 ? '看多' : vote.ai.vote < 0 ? '看空' : '中性';
    const aiConfDesc = vote.ai.conf >= 80 ? '高置信' : vote.ai.conf >= 60 ? '中等置信' : vote.ai.conf >= 40 ? '低置信' : '弱信号';
 engineSection += `<b>AI引擎</b>: ${aiDir}(${aiConfDesc}${vote.ai.conf}%)`;
    if(vote.ai.reason) engineSection += `，AI判断: "${vote.ai.reason.slice(0, 100)}"`;
    engineSection += `，历史准确率${(vote.ai.accuracy * 100).toFixed(0)}%，权重${vote.engineWeights.ai}`;
    engineSection += '<br>';
  }
  // RL引擎详述
  if(useRL && (vote.rl.vote !== 0 || vote.rl.conf > 0)){
    const rlDir = vote.rl.vote > 0 ? '看多' : vote.rl.vote < 0 ? '看空' : '观望';
 const rlConvDesc = vote.rl.conviction === '强' ? '(信心强)' : vote.rl.conviction === '弱' ? '(信心弱)' : '';
    const rlUncDesc = vote.rl.uncertainty > 0.5 ? '决策不确定性高' : vote.rl.uncertainty > 0.2 ? '决策不确定性中' : '决策确定性高';
 engineSection += `<b>RL大脑</b>: ${rlDir}${rlConvDesc}，置信${vote.rl.conf.toFixed(0)}%，${rlUncDesc}`;
    engineSection += `，历史准确率${(vote.rl.accuracy * 100).toFixed(0)}%，权重${vote.engineWeights.rl}`;
    engineSection += '<br>';
  }
  // 回测引擎详述 — 有回测数据时展示（含中性信号）
  {
    const bt = vote.bt;
    const rsi = bt.rsi;
    if(btSummary){
      const btDir = bt.vote > 0 ? '看多' : bt.vote < 0 ? '看空' : '中性';
 const rsiZone = rsi > 80 ? '极度超买' : rsi > 70 ? '超买区' : rsi > 55 ? '偏强' : rsi > 45 ? '中性' : rsi > 30 ? '偏弱' : rsi > 20 ? '超卖区' : '极度超卖';
      const sharpeDesc = bt.sharpe > 1.5 ? '优秀' : bt.sharpe > 0.8 ? '良好' : bt.sharpe > 0.3 ? '尚可' : bt.sharpe > 0 ? '偏弱' : '为负';
 engineSection += `<b>回测引擎</b>: ${btDir}，RSI=${rsi.toFixed(0)}(${rsiZone})，Sharpe=${bt.sharpe.toFixed(2)}(${sharpeDesc})，Sortino=${bt.sortino.toFixed(2)}`;
      if(bt.winRate > 0) engineSection += `，历史胜率${(bt.winRate * 100).toFixed(0)}%`;
      if(bt.maxDD < 0) engineSection += `，最大回撤${(bt.maxDD * 100).toFixed(1)}%`;
      engineSection += `，Kelly建议仓位${(bt.kelly * 100).toFixed(1)}%`;
      engineSection += `，权重${vote.engineWeights.bt}`;
      engineSection += '<br>';
    }
  }
  // 共识判定
  const totalVotes = vote.buyVotes + vote.sellVotes;
  let consensusDesc = '';
  const maxEngines = useRL ? 3 : 2;
  if(vote.buyVotes >= maxEngines){
 consensusDesc = `${maxEngines===3?'三引擎':'双引擎'}一致看多，共识较强(×${vote.consensusMult.toFixed(2)})`;
  }
 else if(vote.buyVotes === 2 && vote.sellVotes === 0) consensusDesc = '双引擎看多(×' + vote.consensusMult.toFixed(2) + ')，信号较强';
  else if(vote.sellVotes >= maxEngines){
 consensusDesc = `${maxEngines===3?'三引擎':'双引擎'}一致看空，共识较强(×${vote.consensusMult.toFixed(2)})`;
  }
 else if(vote.sellVotes === 2 && vote.buyVotes === 0) consensusDesc = '双引擎看空(×' + vote.consensusMult.toFixed(2) + ')，空头信号明确';
 else if(vote.buyVotes > 0 && vote.sellVotes > 0) consensusDesc = '引擎分歧(买' + vote.buyVotes + '卖' + vote.sellVotes + ')，共识惩罚(×' + vote.consensusMult.toFixed(2) + ')，方向不明';
  else if(totalVotes === 0){
    // 具体说明哪些引擎未激活
    const missing = [];
    if(!_analysisResult) missing.push('AI未分析');
    else if(vote.ai.vote === 0) missing.push('AI中性');
    if(useRL){
      if(!_rlModelLoaded) missing.push('RL未训练');
      else if(vote.rl.vote === 0) missing.push('RL中性');
    }
    if(!btSummary) missing.push('回测未运行');
    else if(vote.bt.vote === 0) missing.push('回测中性(RSI=' + vote.bt.rsi.toFixed(0) + ')');
    consensusDesc = '⏳ 引擎无明确信号 (' + missing.join('、') + ')';
    if(!_analysisResult) consensusDesc += '。建议点击「AI分析」激活AI引擎';
  }
  else consensusDesc = '仅单引擎有信号，信号较弱';
 engineSection += `<b>共识</b>: ${consensusDesc}`;

  // ========== Section 2: 技术面分析 ==========
  let techSection = '';
  if(td){
    const tl = getTrendLabel(td);
    // 趋势方向
    const trendDesc = {
 'strong_up': '当前处于强势上攻趋势，多头占据主导，短期动能充沛',
 'up': '整体趋势向上，中期方向偏多，但上涨力度尚未达到强势',
 'sideways': '↔当前横盘震荡，方向不明确，多空力量胶着，等待突破方向',
 'down': '趋势走弱，空头逐步占优，注意控制风险',
 'strong_down': '强势下跌趋势，空头主导，短期内反转概率较低',
    };
    techSection += `<b>趋势方向</b>: ${trendDesc[td.trendDir] || '数据不足'}<br>`;
    // 波段位置
    const swingDesc = {
 'deep_dip': '处于深度回调区间，偏离均值较远，若趋势未破，是较好的低吸位置',
 'dip': '短期回调中，价格小幅回落，可能是波段买点',
      'mid': '处于中位运行区间，波段方向不明确，无明显加减仓信号',
 'rally': '短期出现反弹，但需关注反弹力度和持续性',
 'surge': '短期快速冲高，获利盘积累较多，需防范回调风险',
    };
    techSection += `<b>波段位置</b>: ${swingDesc[td.swingPos] || '中位运行'}<br>`;
    // 均线排列
    const maDesc = tl.maStatus === '多头排列' ? 'MA5>MA20>MA60多头排列，中长期趋势健康' :
                   tl.maStatus === '空头排列' ? 'MA5<MA20<MA60空头排列，中长期趋势走弱' :
                   '均线交织缠绕，短中长期方向不一致，震荡格局';
    techSection += `<b>均线状态</b>: ${maDesc}`;
    // 距高点/低点
    if(td.drawdownFromHigh < -5 || td.reboundFromLow > 5){
      techSection += '<br><b>位置参考</b>: ';
      if(td.drawdownFromHigh < -20) techSection += `距近期高点回撤${td.drawdownFromHigh.toFixed(1)}%，跌幅较深，若趋势仍在可考虑分批接盘；`;
      else if(td.drawdownFromHigh < -10) techSection += `距近期高点回撤${td.drawdownFromHigh.toFixed(1)}%，存在一定回调空间；`;
      else if(td.drawdownFromHigh < -5) techSection += `距近期高点回撤${td.drawdownFromHigh.toFixed(1)}%，回调幅度不大；`;
      if(td.reboundFromLow > 20) techSection += `从近期低点已反弹${td.reboundFromLow.toFixed(1)}%，上涨动能强但需注意追高风险`;
      else if(td.reboundFromLow > 10) techSection += `从近期低点反弹${td.reboundFromLow.toFixed(1)}%，具有一定上涨动能`;
      else if(td.reboundFromLow > 5) techSection += `从近期低点反弹${td.reboundFromLow.toFixed(1)}%，企稳迹象初现`;
    }
    // 组合趋势+波段的特殊场景
    if(td.trendDir === 'strong_up' && td.swingPos === 'dip') techSection += '<br>⭐<b>关键判断</b>: 强势趋势中回调，这是经典的波段低吸机会，成功率较高';
    else if(td.trendDir === 'strong_up' && td.swingPos === 'deep_dip') techSection += '<br>⭐<b>关键判断</b>: 强势趋势中出现深度回调，可能是"超级买点"，但需确认趋势未反转';
    else if((td.trendDir === 'strong_up' || td.trendDir === 'up') && td.swingPos === 'surge') techSection += '<br>⭐<b>关键判断</b>: 上涨趋势中短期冲高，获利盘压力增大，谨防冲高回落，建议止盈或减仓';
    else if(td.trendDir === 'strong_down' && td.swingPos === 'rally') techSection += '<br>⭐<b>关键判断</b>: 下跌趋势中的反弹，极可能是"逃命波"，建议趁反弹减仓，不宜追涨';
    else if(td.trendDir === 'strong_down' && td.swingPos === 'deep_dip') techSection += '<br>⭐<b>关键判断</b>: 持续下跌且处于深度低位，但趋势未见止跌信号，不建议抄底，避免"接飞刀"';
    else if(td.trendDir === 'down' && td.swingPos === 'rally') techSection += '<br>⭐<b>关键判断</b>: 弱势中的反弹，力度和持续性存疑，宜谨慎观望或逢高减仓';
    else if(td.trendDir === 'up' && (td.swingPos === 'dip' || td.swingPos === 'deep_dip')) techSection += '<br>⭐<b>关键判断</b>: 上升趋势中出现回调，是相对安全的低吸机会';
  }

  // ========== Section 3: 资金面 & 板块 ==========
  let fundFlowSection = '';
  if(capFlow){
    const netB = capFlow.mainNet;
    const absB = Math.abs(netB);
    if(netB > 5e8) fundFlowSection += `${fType}相关板块主力资金大幅净流入${(netB/1e8).toFixed(1)}亿，市场资金积极追捧该方向，主力做多意愿强烈`;
    else if(netB > 1e8) fundFlowSection += `${fType}相关板块主力资金净流入${(netB/1e8).toFixed(1)}亿，有一定的资金关注`;
    else if(netB > 0) fundFlowSection += `${fType}相关板块资金面中性偏正，主力小幅净流入${(netB/1e8).toFixed(1)}亿`;
    else if(netB > -1e8) fundFlowSection += `${fType}相关板块资金面中性偏负，主力小幅净流出${(absB/1e8).toFixed(1)}亿`;
    else if(netB > -5e8) fundFlowSection += `${fType}相关板块主力资金净流出${(absB/1e8).toFixed(1)}亿，短期资金偏谨慎`;
 else fundFlowSection += `${fType}相关板块主力资金大幅净流出${(absB/1e8).toFixed(1)}亿，资金加速离场，需警惕持续下行压力`;
  }

  // ========== Section 4: 宏观 & 地缘 ==========
  let macroSection = '';
  if(ds){
    if(ds.score >= 70) macroSection += `宏观环境积极(评分${ds.score})，经济数据向好，政策面偏暖，有利于权益类资产`;
    else if(ds.score >= 55) macroSection += `宏观环境偏正面(评分${ds.score})，整体环境对市场有一定支撑`;
    else if(ds.score >= 45) macroSection += `宏观环境中性(评分${ds.score})，经济数据暂无明显方向，政策面平稳`;
    else if(ds.score >= 30) macroSection += `宏观环境偏弱(评分${ds.score})，部分经济数据走弱，需注意系统性风险`;
 else macroSection += `宏观环境较差(评分${ds.score})，多项数据走弱，风险偏好收缩，建议保守操作`;
  }
 if(vote.geoBias > 0.25) macroSection += (macroSection?'。':'') + `地缘事件形成强正向催化(偏置+${vote.geoBias.toFixed(2)})，可能带来超预期上涨`;
  else if(vote.geoBias > 0.1) macroSection += (macroSection?'。':'') + `地缘事件偏利好(偏置+${vote.geoBias.toFixed(2)})，有一定正面催化`;
 else if(vote.geoBias < -0.25) macroSection += (macroSection?'。':'') + `地缘事件形成强利空(偏置${vote.geoBias.toFixed(2)})，可能引发超预期下跌`;
  else if(vote.geoBias < -0.1) macroSection += (macroSection?'。':'') + `地缘事件偏利空(偏置${vote.geoBias.toFixed(2)})，需关注风险传导`;

  // ========== Section 5: 拥挤度 & 逆向 (仅在触发时展示) ==========
  let crowdSection = '';
 if(vote.sotStatus === 'crowded') crowdSection = `该品种当前交易拥挤度较高，市场关注度过热，短期追涨风险大。Kelly仓位已按拥挤度因子(×${vote.crowdingPenalty.toFixed(2)})下调，减少过热板块暴露`;
 else if(vote.sotStatus === 'contrarian') crowdSection = `该品种当前处于市场冷门区域，关注度低迷，具备逆向投资价值。Kelly仓位获得逆向奖励(×${vote.contrarianBonus.toFixed(2)})`;

  // ========== Section 6: 风控约束 (仅在约束生效时展示) ==========
  let riskSection = '';
 if(vote.riskMult < 0.8) riskSection += `组合风险约束生效: 当前组合整体风险偏高(风险评分${(vote.portRisk*100).toFixed(0)})，买入信号已被风控系统压缩(×${vote.riskMult.toFixed(2)})`;

  // ========== Section 7: 顶级基金经理同赛道动向 ==========
  let mgrSection = '';
  {
    // 精确赛道匹配映射: fundType/sectorExposure → 经理sectors的等价集
    // 只用精确匹配，杜绝子串误匹配(如"有色金属"不应匹配到油气ETF)
    const SECTOR_EQUIV = {
      // 基金type → 允许匹配的经理sector集合
      'AI':['AI','人工智能','计算机','AI芯片','软件','云计算','算力'],
      '科技':['科技','计算机','电子','AI','软件','云计算','通信'],
      '半导体':['半导体','AI芯片','电子'],
      '宽基':['科技','消费','制造','金融'],
      '蓝筹':['消费','白酒','互联网','金融','港股'],
      'QDII':['港股','互联网'],
      '港股科技':['港股','互联网','AI'],
      '金融':['金融','银行'],
      '消费':['消费','食品饮料','家电','商贸零售'],
      '白酒':['白酒','食品饮料','消费'],
      '医药':['创新药','医疗器械','CXO','医药'],
      '军工':['军工','国防','航空航天'],
      '新能源':['新能源','光伏','储能','锂电','充电桩'],
      '光伏':['光伏','新能源','储能'],
      '锂电':['锂电','新能源车','储能'],
      '新能源车':['新能源车','锂电','智能驾驶','充电桩'],
      '有色金属':['有色金属','资源','周期','矿业'],
      '黄金':['贵金属','有色金属'],
      '红利':['红利','公用事业','银行','高股息'],
      '钢铁':['周期','资源','钢铁'],
      '油气':['石油石化','能源'],
      '原油':['石油石化','能源'],
      '能源':['石油石化','能源','煤炭'],
      '化工':['化工','基础化工','周期'],
      '地产':['地产','基建','建材'],
      '机器人':['AI','机器人','制造','电子'],
    };

    // 1. 从fundType提取主赛道标签
    const fTypeTags = fType ? fType.split(/[/\/·、,，]/).map(s => s.trim()).filter(Boolean) : [];
    // 2. 从基金名称补充赛道关键词
    const fnLower = fName.toLowerCase();
    if(fnLower.includes('油气') || fnLower.includes('石油') || fnLower.includes('原油')){
      if(!fTypeTags.includes('油气')) fTypeTags.push('油气');
    }
    if(fnLower.includes('能源') && !fnLower.includes('新能源')){
      if(!fTypeTags.includes('能源')) fTypeTags.push('能源');
    }

    // 3. 构建允许匹配的经理sector精确集合
    const allowedMgrSectors = new Set();
    fTypeTags.forEach(function(tag){
      const equivs = SECTOR_EQUIV[tag];
      if(equivs) equivs.forEach(function(s){ allowedMgrSectors.add(s); });
      // 如果tag本身就是经理sector常用词，也加入
      allowedMgrSectors.add(tag);
    });

    // 4. 从持仓推断的行业(仅高权重≥20%的才纳入，避免10%的噪声)
    const holdInfo = _fundHoldingsCache[code];
    if(holdInfo?.sectorExposure){
      Object.entries(holdInfo.sectorExposure).filter(([,w]) => w >= 0.20).forEach(([sec]) => {
        const equivs = SECTOR_EQUIV[sec];
        if(equivs) equivs.forEach(function(s){ allowedMgrSectors.add(s); });
        allowedMgrSectors.add(sec);
      });
    }

    if(allowedMgrSectors.size > 0){
      const relatedMgrs = [];
      TOP50_FM_DIRECTIONS.forEach(function(m){
        // 精确匹配: 经理的每个sector必须在允许集合中
        const overlap = m.sectors.filter(function(ms){
          return allowedMgrSectors.has(ms);
        });
        if(overlap.length === 0) return;
        // 相关性检查: 经理的最新动向不应与基金赛道明显矛盾
        // 例: 油气ETF不应匹配"看好有色金属"的经理
        const recentText = m.recent || '';
        const CONFLICT_PAIRS = [
          {sectors:['石油石化','能源','煤炭'], conflicts:['有色金属','贵金属','黄金','银']},
          {sectors:['有色金属','贵金属'], conflicts:['石油','油气','原油','天然气']},
          {sectors:['医药','创新药','CXO'], conflicts:['半导体','芯片','光伏','军工']},
          {sectors:['白酒','食品饮料'], conflicts:['半导体','芯片','军工','光伏']},
        ];
        const fundSectorSet = allowedMgrSectors;
        let isConflict = false;
        CONFLICT_PAIRS.forEach(function(pair){
          // 基金属于 pair.sectors 方向
          const fundInGroup = pair.sectors.some(function(s){ return fundSectorSet.has(s); });
          if(fundInGroup){
            // 经理的最新动向提到了冲突方向
            const recentConflict = pair.conflicts.some(function(c){ return recentText.includes(c); });
            if(recentConflict) isConflict = true;
          }
        });
        if(isConflict) return;
        {
          relatedMgrs.push({
            name: m.name,
            firm: m.firm,
            aum: m.aum,
            style: m.style,
            recent: m.recent,
            conviction: m.conviction,
            overlapSectors: overlap
          });
        }
      });
      // 按conviction排序: 极高>高>中>低
      const convOrder = {'极高':4,'高':3,'中':2,'低':1};
      relatedMgrs.sort((a,b) => (convOrder[b.conviction]||0) - (convOrder[a.conviction]||0));
      if(relatedMgrs.length > 0){
        const top = relatedMgrs.slice(0, 4);
        mgrSection = top.map(function(m){
 const convIcon = m.conviction === '极高' ? '' : m.conviction === '高' ? '' : '';
          const overlapStr = m.overlapSectors.slice(0,2).join('/');
          return `${convIcon}<b>${m.name}</b>(${m.firm}·${m.aum}·${m.style})<span style="color:#94a3b8;font-size:8px;margin:0 2px">${overlapStr}</span>${m.recent} <span style="color:#94a3b8;font-size:8px">[${m.conviction}]</span>`;
        }).join('<br>');
      }
    }
  }

  // ========== Section 8: 雪球持仓类目分析 ==========
  let xqSection = '';
  {
    const xq = analyzeXueqiuHoldingCategories(code, fType, fName);
    if(xq){
      const liveTag = xq.isLive ? '<span style="color:#22c55e;font-size:9px">● 实时</span>' : '<span style="color:#94a3b8;font-size:9px">○ 静态</span>';
      const catStr = xq.categories.map(c => {
 const t = c.trend === 'up' ? '升温' : c.trend === 'down' ? '降温' : '持平';
        return `${c.category}(持仓${(c.weight*100).toFixed(0)}%·热度${Math.round(c.heat/1000)}k·${t})`;
      }).join('、');
      const wordStr = xq.topWords.slice(0, 4).join(' / ');
      xqSection = `${liveTag} 匹配度${xq.matchScore}分，整体<b>${xq.sentiment}</b>。重点类目: ${catStr}`;
      if(wordStr) xqSection += `。雪球热词: ${wordStr}`;
      // 添加相关热股涨跌
      if(xq.topStocks && xq.topStocks.length > 0){
        const stockStr = xq.topStocks.slice(0, 3).map(s => {
          const pctStr = s.pct >= 0 ? `<span style="color:var(--red)">+${s.pct.toFixed(1)}%</span>` : `<span style="color:var(--green)">${s.pct.toFixed(1)}%</span>`;
          return `${s.name}${pctStr}`;
        }).join(' ');
        xqSection += `。<b>相关热股</b>: ${stockStr}`;
      }
      // 添加相关热帖
      if(xq.relatedTopics && xq.relatedTopics.length > 0){
        const topicStr = xq.relatedTopics.map(t => `"${t.text.slice(0, 25)}…"`).join(' ');
        xqSection += `。<b>热议</b>: ${topicStr}`;
      }
      // 时间标注
      if(xq.fetchedAt){
        const t = new Date(xq.fetchedAt);
        xqSection += ` <span style="font-size:8px;color:var(--sub)">(${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')})</span>`;
      }
    }
  }

  // ========== 汇总输出 ==========
  let reason = '';
  // 操作结论(放最前面，醒目)
  if(vote.action === 'buy'){
 reason += `<b style="color:#ef4444"> 结论: 建议加仓</b>，Kelly建议仓位${(vote.bt.kelly * 100).toFixed(1)}%，综合评分${vote.score.toFixed(3)}，有效置信${vote.effConf}%。`;
    if(td?.swingPos === 'deep_dip') reason += '当前正处于深度回调区间，是较佳的加仓时机，可适当加大力度。';
    else if(td?.swingPos === 'dip') reason += '正处于波段回调低点，适合分批建仓。';
    else reason += '建议分2-3批逐步建仓，避免一次性重仓。';
  } else if(vote.action === 'sell'){
 reason += `<b style="color:#22c55e"> 结论: 建议减仓</b>，建议先减30-50%仓位，综合评分${vote.score.toFixed(3)}，有效置信${vote.effConf}%。`;
    if(td?.swingPos === 'surge' || td?.swingPos === 'rally') reason += '当前处于反弹/冲高阶段，是相对好的卖出窗口，趁反弹出货。';
    else if(td?.trendDir === 'strong_down') reason += '趋势处于强势下跌中，建议果断止损，避免深套。';
    else reason += '分批减仓锁定利润，控制下行风险。';
  } else {
 let holdReason = `<b style="color:#64748b"> 结论: 维持持有</b>，综合评分${vote.score.toFixed(3)}`;
    if(vote.buyVotes > 0 && vote.sellVotes > 0) holdReason += '。引擎间存在分歧，方向不明确，不宜轻易操作';
    else if(totalVotes === 0) holdReason += '。信号未达共识阈值，数据不足以支撑决策';
    else holdReason += '。信号虽有一定方向性但未达行动阈值';
    if(vote.geoBias > 0.1 && vote.buyVotes < 2) holdReason += '。地缘事件偏利好但引擎信号不足，可用极小仓位(1-2%)先行试探性布局';
    reason += holdReason + '。';
  }
  reason += '<br>';

  // 各分析维度(带clear标签)
  // 组装分析维度 — 只展示有实质内容的模块
  const sections = [];
  if(engineSection.trim()) sections.push(engineSection);
 if(techSection) sections.push(`<b>技术面</b>: ${techSection}`);
  // 波段止盈信号(仅在触发时展示)
  if(vote.swingDampen < -0.1){
 const swingDesc = vote.swingDampen < -0.3 ? '<b>强止盈信号</b>: 连续冲高+接近高点，追涨风险极大，建议落袋为安'
 : vote.swingDampen < -0.2 ? '<b>止盈信号</b>: 近期涨幅较大且接近高位区间，获利盘压力增大，建议部分止盈'
 : '<b>冲高提醒</b>: 短期涨幅偏大，注意分批获利了结';
 sections.push(`<b>波段</b>: ${swingDesc} (波段衰减=${vote.swingDampen.toFixed(2)})`);
  }
  // 宏观量化偏置(仅在显著时展示)
  if(Math.abs(vote.macroBias) >= 0.04){
    const macBiasDesc = vote.macroBias > 0.06 ? '宏观面偏暖(PMI/流动性等支撑)，对该品种形成正面助力'
      : vote.macroBias > 0 ? '宏观数据中性偏正，有一定基本面支撑'
      : vote.macroBias > -0.06 ? '宏观数据偏弱(流动性或景气度不足)，增加下行压力'
 : '宏观面偏冷(PMI收缩/资金流出等)，周期品基本面承压';
 sections.push(`<b>宏观量化</b>: ${macBiasDesc} (宏观偏置=${vote.macroBias>0?'+':''}${vote.macroBias.toFixed(2)})`);
  }
 if(fundFlowSection) sections.push(`<b>资金面</b>: ${fundFlowSection}`);
 if(macroSection) sections.push(`<b>宏观&地缘</b>: ${macroSection}`);
 if(mgrSection) sections.push(`<b>同赛道顶级经理</b>: ${mgrSection}`);
 if(xqSection) sections.push(`<b>雪球持仓类目</b>: ${xqSection}`);
 if(crowdSection) sections.push(`<b>拥挤度</b>: ${crowdSection}`);
 if(riskSection) sections.push(`<b>风控</b>: ${riskSection}`);
 if(vote.ai.reason && vote.ai.conf > 0) sections.push(`<b>AI原文</b>: "${vote.ai.reason.slice(0, 200)}"`);

  if(sections.length > 0){
    reason += `<div style="margin-top:4px;padding:4px 8px;background:rgba(79,110,247,0.06);border-radius:6px;border-left:3px solid var(--primary);font-size:10px;line-height:1.6">`;
    reason += sections.join('<br>');
    reason += '</div>';
  }

  return reason;
}

// ==================== 宏观异动雷达 渲染 (三模块) ====================
function renderRadarSection(geoData){
  let html = '';
  const heatmap = _hotEventsData?.heatmap || [];
  const outlook = geoData.outlook || MACRO_3M_OUTLOOK;
  const geoColor = geoData.score >= 60 ? '#4ade80' : geoData.score <= 40 ? '#f87171' : '#fbbf24';
  const updateStr = _hotEventsLastUpdate
    ? _hotEventsLastUpdate.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}) + ' 更新'
    : (_hotEventsData?.updated_at ? new Date(_hotEventsData.updated_at).toLocaleString('zh-CN',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) + ' 更新' : '⏳ 加载中');
  const srcStr = _hotEventsData?.meta?.sources?.join(' · ') || 'GitHub Actions 自动更新';

  html += '<div class="radar-section">';
  // 标题栏
  html += '<div class="radar-header">';
 html += '<div class="radar-title"> 宏观与异动雷达</div>';
  html += '<div class="radar-meta">';
  html += '<span>' + srcStr + '</span>';
  html += '<span>' + updateStr + '</span>';
  html += '<span class="radar-score" style="background:' + geoColor + '22;color:' + geoColor + '">' + geoData.label + ' ' + geoData.score + '</span>';
  html += '</div></div>';

  // ===== 综合信号仪表板 (整合数据情报) =====
  if(typeof _dataIntelLoaded !== 'undefined' && _dataIntelLoaded){
    const _macro = getMacroSummary();
    const _capFlow = getCapFlowSummary();
    const _gSent = (typeof globalNews !== 'undefined' && globalNews.length > 0) ? getGlobalNewsSentiment() : null;
    const _ds = generateDataSignal();
    html += '<div style="background:rgba(15,23,42,0.6);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:8px 10px;margin-bottom:10px">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
 html += '<span style="font-size:10px;font-weight:700;color:#22d3ee"> AI多维信号综合</span>';
    html += '<span style="font-size:14px;font-weight:800;color:' + _ds.color + '">' + _ds.icon + ' ' + _ds.label + ' ' + _ds.score + '</span>';
    html += '</div>';
    // 四维度网格
    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;margin-bottom:6px">';
    var _macroC = _macro.positiveCount >= 4 ? '#4ade80' : _macro.positiveCount >= 2 ? '#fbbf24' : '#f87171';
    html += '<div style="text-align:center;padding:4px 2px;background:rgba(255,255,255,0.04);border-radius:6px"><div style="font-size:8px;color:rgba(255,255,255,0.4)">宏观面</div><div style="font-size:11px;font-weight:700;color:' + _macroC + '">' + _macro.overallSignal + '</div></div>';
    var _netB = _capFlow.netTotal;
    var _capC = _netB > 5e9 ? '#4ade80' : _netB > 0 ? '#fbbf24' : _netB > -5e9 ? '#fb923c' : '#f87171';
    html += '<div style="text-align:center;padding:4px 2px;background:rgba(255,255,255,0.04);border-radius:6px"><div style="font-size:8px;color:rgba(255,255,255,0.4)">资金面</div><div style="font-size:11px;font-weight:700;color:' + _capC + '">' + (_netB>=0?'+':'') + (_netB/1e8).toFixed(0) + '亿</div></div>';
    var _sentC = newsSentiment.score >= 55 ? '#4ade80' : newsSentiment.score <= 45 ? '#f87171' : '#fbbf24';
    html += '<div style="text-align:center;padding:4px 2px;background:rgba(255,255,255,0.04);border-radius:6px"><div style="font-size:8px;color:rgba(255,255,255,0.4)">A股舆情</div><div style="font-size:11px;font-weight:700;color:' + _sentC + '">' + newsSentiment.label + ' ' + newsSentiment.score + '</div></div>';
    if(_gSent){
      var _gC = _gSent.score >= 55 ? '#4ade80' : _gSent.score <= 45 ? '#f87171' : '#fbbf24';
      html += '<div style="text-align:center;padding:4px 2px;background:rgba(255,255,255,0.04);border-radius:6px"><div style="font-size:8px;color:rgba(255,255,255,0.4)">国际舆情</div><div style="font-size:11px;font-weight:700;color:' + _gC + '">' + _gSent.label + ' ' + _gSent.score + '</div></div>';
    } else {
      html += '<div style="text-align:center;padding:4px 2px;background:rgba(255,255,255,0.04);border-radius:6px"><div style="font-size:8px;color:rgba(255,255,255,0.4)">国际舆情</div><div style="font-size:11px;color:var(--sub)">加载中</div></div>';
    }
    html += '</div>';
    // 资金流向 Top3
    if(sectorCapFlow.length > 0){
      var _maxAbs = Math.max.apply(null, sectorCapFlow.map(function(s){return Math.abs(s.mainNet||0)})) || 1;
      html += '<div style="display:flex;gap:6px;font-size:9px">';
      html += '<div style="flex:1"><div style="color:#4ade80;font-weight:600;margin-bottom:2px">▲ 主力流入</div>';
      _capFlow.topInflow.slice(0,3).forEach(function(s){
        var v = (s.mainNet/1e8).toFixed(1);
        var w = Math.min(100, Math.abs(s.mainNet)/_maxAbs*100);
        html += '<div style="display:flex;align-items:center;gap:3px;padding:1px 0"><span style="min-width:38px;font-weight:600;color:#e2e8f0">' + s.name.slice(0,4) + '</span><div style="flex:1;height:5px;border-radius:3px;background:rgba(255,255,255,0.06)"><div style="height:100%;width:' + w + '%;border-radius:3px;background:#4ade80"></div></div><span style="color:#4ade80;min-width:32px;text-align:right">+' + v + '</span></div>';
      });
      html += '</div><div style="flex:1"><div style="color:#f87171;font-weight:600;margin-bottom:2px">▼ 主力流出</div>';
      _capFlow.topOutflow.slice(0,3).forEach(function(s){
        var v = (Math.abs(s.mainNet)/1e8).toFixed(1);
        var w = Math.min(100, Math.abs(s.mainNet)/_maxAbs*100);
        html += '<div style="display:flex;align-items:center;gap:3px;padding:1px 0"><span style="min-width:38px;font-weight:600;color:#e2e8f0">' + s.name.slice(0,4) + '</span><div style="flex:1;height:5px;border-radius:3px;background:rgba(255,255,255,0.06)"><div style="height:100%;width:' + w + '%;border-radius:3px;background:#f87171"></div></div><span style="color:#f87171;min-width:32px;text-align:right">-' + v + '</span></div>';
      });
      html += '</div></div>';
    }
    // 舆情快报
    if(typeof newsHeadlines !== 'undefined' && newsHeadlines.length > 0){
      html += '<div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.06)">';
 html += '<div style="font-size:9px;color:rgba(255,255,255,0.4);margin-bottom:3px"> 舆情焦点</div>';
      newsHeadlines.slice(0,3).forEach(function(n){
 var ic = n.sentiment==='bull'?'�':n.sentiment==='bear'?'':'';
        html += '<div style="display:flex;gap:4px;padding:2px 0;font-size:9px;color:#e2e8f0;line-height:1.3"><span style="min-width:12px">' + ic + '</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + n.title + '</span></div>';
      });
      html += '</div>';
    }
    // AI建议
    html += '<div style="margin-top:6px;padding:4px 8px;background:rgba(34,211,238,0.06);border-radius:6px;font-size:9px;color:rgba(255,255,255,0.6);text-align:center">' + _ds.advice + '</div>';
    html += '</div>';
  }

  // ===== 模块A: 热点温度计 (实时行情修正) =====
  html += '<div class="radar-module">';
 html += '<div class="radar-mod-title"> 热点温度计 <span style="font-size:9px;font-weight:400;color:rgba(255,255,255,0.3)">新闻热度 × 实时行情修正</span></div>';
  html += '<div class="heatmap-grid">';
  var displayHeatmap = heatmap.length > 0 ? heatmap.map(function(h){ return Object.assign({}, h); }) : _buildFallbackHeatmap(geoData);
  // === 实时行情修正: 用今日板块涨跌幅 + 指数涨跌幅动态调整温度 ===
  displayHeatmap = _adjustHeatmapWithLiveData(displayHeatmap);
  // 按调整后温度重排序
  displayHeatmap.sort(function(a,b){ return b.temperature - a.temperature; });
  displayHeatmap.slice(0, 14).forEach(function(h){
    var temp = h.temperature;
    var barColor = temp >= 70 ? '#ef4444' : temp >= 50 ? '#f59e0b' : temp >= 30 ? '#3b82f6' : '#64748b';
    var tempIcon = temp >= 80 ? '🔥' : temp >= 60 ? '🌡️' : temp >= 40 ? '📊' : '❄️';
    var trendIcon = h.trend === 'up' ? '↑' : h.trend === 'down' ? '↓' : '';
    var trendColor = h.trend === 'up' ? '#f87171' : h.trend === 'down' ? '#4ade80' : 'transparent';
    // 实时行情修正标记
    var liveTag = '';
    if(h._liveAdj && Math.abs(h._liveAdj) >= 3){
      var adjSign = h._liveAdj > 0 ? '+' : '';
      var adjColor = h._liveAdj > 0 ? '#f87171' : '#4ade80';
      liveTag = '<span style="font-size:8px;color:' + adjColor + ';margin-left:2px" title="实时行情修正">' + adjSign + h._liveAdj + '</span>';
    }
    var livePctTag = '';
    if(h._livePct !== undefined && h._livePct !== null){
      var livePctColor = h._livePct >= 0 ? '#f87171' : '#4ade80';
      livePctTag = '<span style="font-size:8px;color:' + livePctColor + ';margin-left:3px">' + (h._livePct>=0?'+':'') + h._livePct.toFixed(2) + '%</span>';
    }
    html += '<div class="heat-item">';
    html += '<span class="heat-tag">' + h.tag + livePctTag + '</span>';
    html += '<div class="heat-bar"><div class="heat-fill" style="width:' + temp + '%;background:' + barColor + '"></div></div>';
    html += '<span class="heat-temp" style="color:' + barColor + '">' + tempIcon + temp + liveTag + '</span>';
    html += '<span class="heat-trend" style="color:' + trendColor + '">' + trendIcon + '</span>';
    html += '</div>';
  });
  html += '</div></div>';

  // ===== 模块B: 持仓异动归因 =====
  html += '<div class="radar-module">';
 html += '<div class="radar-mod-title"> 持仓异动归因</div>';
  html += '<div class="impact-list">';
 // 只保留持仓基金（不含自选），按今日涨跌幅绝对值排序
  var holdingCodeSet = new Set(holdings.map(function(h){ return h.code; }));
  var impactEntries = Object.entries(geoData.fundImpacts || {})
    .filter(function(pair){ return holdingCodeSet.has(pair[0]); })
    .sort(function(a,b){
      var fdA = getFundData(a[0]), fdB = getFundData(b[0]);
      var pctA = Math.abs(parseFloat(fdA?.gszzl || 0)), pctB = Math.abs(parseFloat(fdB?.gszzl || 0));
      if(Math.abs(pctA - pctB) > 0.3) return pctB - pctA;
      return Math.abs(b[1].score) - Math.abs(a[1].score);
    });

  if(impactEntries.length > 0){
    impactEntries.forEach(function(pair){
      var code = pair[0], fi = pair[1];
      var fName = fundName(code);
      var fd = getFundData(code);
      var todayPct = fd?.gszzl || 0;
      var cls = fi.score > 0 ? 'positive' : fi.score < 0 ? 'negative' : 'neutral';
      var pctColor = todayPct >= 0 ? '#f87171' : '#4ade80';
      var topEvts = fi.events.slice(0, 2);
      var sectorStr = fi.sectorExposure ? Object.entries(fi.sectorExposure)
        .sort(function(a,b){ return b[1] - a[1]; }).slice(0,2)
        .map(function(pair){ return pair[0] + (pair[1]*100).toFixed(0) + '%'; }).join('、') : '';
      var reasonText = sectorStr
        ? '基金配置' + sectorStr + '，受下方事件影响'
        : '受下方事件影响';
      html += '<div class="impact-item ' + cls + '">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center">';
      html += '<div class="impact-fund">' + fName + '</div>';
      var _ipLabel = pctLabel(fd);
      html += '<span class="impact-pct" style="color:' + (fd&&fd._noData?'var(--sub)':pctColor) + '">' + _ipLabel + ' ' + (fd&&fd._noData?'--':((todayPct>=0?'+':'') + fmt(todayPct) + '%')) + '</span>';
      html += '</div>';
      html += '<div class="impact-reason">' + reasonText + '</div>';
      html += '<div class="impact-events">';
      topEvts.forEach(function(ev){
        var chipCls = ev.impact === 'positive' ? 'pos' : 'neg';
        html += '<span class="impact-evt-chip ' + chipCls + '">' + (ev.icon || '📌') + ev.name.slice(0,8) + '</span>';
      });
      html += '</div></div>';
    });
  } else {
    html += '<div style="text-align:center;font-size:10px;color:rgba(255,255,255,0.4);padding:8px 0">暂无显著异动归因</div>';
  }
  html += '</div></div>';

  // ===== 模块C: AI顺势策略建议 =====
  html += '<div class="radar-module">';
 html += '<div class="radar-mod-title"> AI 顺势策略</div>';
  html += '<div class="strategy-list">';

  // 机会: 高温概念 — 先检查用户持仓是否已有暴露，再推荐未持有的
  var hotTags = displayHeatmap.filter(function(h){ return h.temperature >= 70 && h.sentiment > 0.3; });
  var holdingCodes = new Set(holdings.map(function(h){ return h.code; }));
  var strategyCount = 0;
  hotTags.slice(0, 3).forEach(function(ht){
    var tagLow = ht.tag.toLowerCase();
    var tagShort = ht.tag.slice(0,2).toLowerCase();

    // 1. 检查用户持仓中是否有与该热点相关的基金
    var ownedRelated = holdings.filter(function(h){
      var nm = (fundName(h.code) + ' ' + (fundType(h.code)||'') + ' ' + (h.type||'')).toLowerCase();
      return nm.indexOf(tagLow) >= 0 || nm.indexOf(tagShort) >= 0;
    });

    // 2. 从推荐池中找用户未持有的
    var recoFunds = (typeof RECO_FUND_POOL !== 'undefined' ? RECO_FUND_POOL : []).filter(function(f){
      var fNameLow = (f.name + ' ' + (f.type||'') + ' ' + (f.tags||[]).join(' ')).toLowerCase();
      return fNameLow.indexOf(tagLow) >= 0 || fNameLow.indexOf(tagShort) >= 0;
    }).filter(function(f){ return !holdingCodes.has(f.code); });

    if(ownedRelated.length > 0){
      // 用户已持有相关资产 → 显示持仓 + 建议加仓/持有
      html += '<div class="strategy-item">';
 html += '<div class="strategy-icon"></div>';
      html += '<div class="strategy-body">';
 html += '<div class="strategy-label" style="color:#f87171">机会 · ' + ht.tag + ' ' + ht.temperature + '</div>';
      var ownedNames = ownedRelated.map(function(h){ return fundName(h.code).slice(0,8); }).join('、');
 html += '<div class="strategy-text">热度' + ht.temperature + '，情绪偏多。 你已持有: ' + ownedNames + '，顺势持有或逢回调加仓。</div>';
      html += '</div></div>';
      strategyCount++;
    } else if(recoFunds.length > 0){
      // 用户未持有 → 推荐关注
      var rf = recoFunds[0];
      html += '<div class="strategy-item">';
 html += '<div class="strategy-icon"></div>';
      html += '<div class="strategy-body">';
 html += '<div class="strategy-label" style="color:#f87171">机会 · ' + ht.tag + ' ' + ht.temperature + '</div>';
      html += '<div class="strategy-text">热度' + ht.temperature + '，情绪偏多。你未持有相关资产，可关注布局。</div>';
 html += '<div class="strategy-fund" onclick="addFromPortfolio(\'' + rf.code + '\',\'' + rf.name.replace(/'/g,"\\'") + '\',\'' + rf.type + '\',\'watch\')"> 推荐关注: ' + rf.name + ' (' + rf.code + ')</div>';
      html += '</div></div>';
      strategyCount++;
    }
  });

  // 风险: 低温概念 + 用户持仓有暴露
  var coldTags = displayHeatmap.filter(function(h){ return h.temperature <= 30 && h.sentiment < -0.3; });
  coldTags.slice(0, 3).forEach(function(ct){
    var exposedHoldings = holdings.filter(function(holding){
      var fNameLow = (fundName(holding.code) + ' ' + (holding.type||'')).toLowerCase();
      return fNameLow.indexOf(ct.tag.toLowerCase()) >= 0 || fNameLow.indexOf(ct.tag.slice(0,2).toLowerCase()) >= 0;
    });
    if(exposedHoldings.length > 0){
      html += '<div class="strategy-item">';
 html += '<div class="strategy-icon"></div>';
      html += '<div class="strategy-body">';
 html += '<div class="strategy-label" style="color:#4ade80">风险 · ' + ct.tag + ' ' + ct.temperature + '</div>';
      html += '<div class="strategy-text">热度仅' + ct.temperature + '，情绪偏空。你持有: ' + exposedHoldings.map(function(x){return fundName(x.code).slice(0,6);}).join('、') + '</div>';
 html += '<div class="strategy-fund" style="color:#4ade80"> 建议关注减仓时机</div>';
      html += '</div></div>';
      strategyCount++;
    }
  });

  // 如果没有明确策略, 显示市场总览
  if(strategyCount === 0){
    html += '<div class="strategy-item">';
 html += '<div class="strategy-icon"></div>';
    html += '<div class="strategy-body">';
    html += '<div class="strategy-label" style="color:#22d3ee">市场总览</div>';
    html += '<div class="strategy-text">' + (outlook.overall || outlook.summary || '市场结构性行情延续') + '</div>';
    html += '</div></div>';
  }

  html += '</div></div>';

  // ===== 关键事件清单 (紧凑) =====
  html += '<div class="radar-module">';
 html += '<div class="radar-mod-title" style="display:flex;align-items:center;gap:6px"> 关键事件 (' + geoData.topEvents.length + ')';
  // 数据来源时间
  const dataTime = _hotEventsData?.updated_at ? new Date(_hotEventsData.updated_at).toLocaleString('zh-CN',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
  if(dataTime) html += '<span style="font-size:8px;color:#94a3b8;font-weight:400;margin-left:auto">' + dataTime + '</span>';
 html += '<button id="refreshEventsBtn" onclick="refreshHotEventsManual()" style="background:none;border:1px solid rgba(148,163,184,0.3);border-radius:4px;cursor:pointer;font-size:11px;padding:1px 5px;color:#94a3b8" title="刷新事件"></button>';
  html += '</div>';
  html += '<div style="display:flex;flex-direction:column;gap:2px">';
  geoData.topEvents.forEach(function(e){
    var ic = e.impact > 0 ? '#f87171' : e.impact < 0 ? '#4ade80' : '#fbbf24';
    var arrow = e.impact > 0 ? '↑' : e.impact < 0 ? '↓' : '→';
    html += '<div style="padding:5px 8px;border-radius:6px;background:rgba(255,255,255,0.03)">';
    html += '<div style="display:flex;align-items:center;gap:6px;font-size:10px">';
    html += '<span style="flex:1;color:#e2e8f0;font-weight:600">' + e.name + '</span>';
    html += '<span style="color:' + ic + ';font-weight:700;min-width:30px;text-align:right">' + arrow + Math.abs(e.impact) + '</span>';
    html += '<span style="color:#94a3b8;font-size:8px;min-width:30px;text-align:right">' + (e.confidence*100).toFixed(0) + '%</span>';
    html += '</div>';
    if(e.description){
      html += '<div style="font-size:9px;color:#94a3b8;margin-top:2px;line-height:1.4">' + e.description + '</div>';
    }
    html += '</div>';
  });
  html += '</div></div>';

  html += '</div>'; // end radar-section
  return html;
}

// 回退热度图 (当hot_events.json未加载时, 从事件推导)
// ==================== 实时行情修正热点温度 ====================
// 核心思路: 新闻热度(LLM from hot_events.json)是"预期"，实时涨跌幅是"现实"
// 当现实大幅偏离预期时(如有色金属暴涨但温度偏低)，用实时数据修正温度
function _adjustHeatmapWithLiveData(heatmap){
  if(!heatmap || heatmap.length === 0) return heatmap;

  // === 1. 从实时板块涨跌幅(liveSectors)获取板块表现 ===
  // liveSectors 格式: [{name:'有色金属', pct:4.71}, ...]
  const sectorPctMap = {};
  (liveSectors || []).forEach(function(s){
    sectorPctMap[s.name] = s.pct;
  });

  // === 2. 从实时指数(liveIndices)获取商品指数表现 ===
  // 黄金ETF(518880), 白银LOF(161226), 有色金属指数(000819)
  const idxPctMap = {};
  INDICES_CONFIG.forEach(function(cfg){
    var d = liveIndices[cfg.secid];
    if(d && !isNaN(d.pct)){
      idxPctMap[cfg.name] = parseFloat(d.pct);
    }
  });

  // === 3. 从实时板块资金流向获取主力资金信号 ===
  const capFlowMap = {};
  (sectorCapFlow || []).forEach(function(s){
    capFlowMap[s.name] = s;
  });

  // === 4. 标签 → 实时信号来源映射 ===
  // 每个heatmap标签对应哪些实时数据源
  const TAG_LIVE_MAP = {
    '人工智能': { sectors:['计算机','电子','通信'], idx:[], capKeys:['计算机','电子'] },
    'AI算力':   { sectors:['计算机','电子','通信'], idx:[], capKeys:['计算机','电子'] },
    '半导体':   { sectors:['电子','半导体'], idx:[], capKeys:['电子'] },
    '大模型':   { sectors:['计算机','传媒'], idx:[], capKeys:['计算机'] },
    '机器人':   { sectors:['电子','机械设备','计算机'], idx:[], capKeys:['机械设备','电子'] },
    '新能源':   { sectors:['电力设备','电气设备'], idx:[], capKeys:['电力设备'] },
    '光伏':     { sectors:['电力设备','电气设备'], idx:[], capKeys:['电力设备'] },
    '锂电':     { sectors:['电力设备','汽车','电气设备'], idx:[], capKeys:['电力设备'] },
    '新能源车': { sectors:['汽车','电力设备'], idx:[], capKeys:['汽车'] },
    '消费':     { sectors:['食品饮料','家用电器','商贸零售','社会服务'], idx:[], capKeys:['食品饮料','家用电器'] },
    '白酒':     { sectors:['食品饮料'], idx:[], capKeys:['食品饮料'] },
    '医药':     { sectors:['医药生物','生物医药'], idx:[], capKeys:['医药生物'] },
    '军工':     { sectors:['国防军工'], idx:[], capKeys:['国防军工'] },
    '红利':     { sectors:['银行','煤炭','公用事业','石油石化'], idx:[], capKeys:['银行','煤炭'] },
    '债券':     { sectors:[], idx:[], capKeys:[] },
    '宽基':     { sectors:[], idx:['上证','沪深300','创业板'], capKeys:[] },
    '港股科技': { sectors:[], idx:[], capKeys:[] },
    '黄金':     { sectors:['有色金属','贵金属'], idx:['黄金ETF'], capKeys:['有色金属'] },
    '有色金属': { sectors:['有色金属','有色','矿业','基础化工'], idx:['有色金属','白银LOF'], capKeys:['有色金属'] },
    '原油':     { sectors:['石油石化','煤炭','采掘'], idx:[], capKeys:['石油石化','煤炭'] },
  };

  // === 5. 逐标签计算实时修正值 ===
  heatmap.forEach(function(h){
    var mapping = TAG_LIVE_MAP[h.tag];
    if(!mapping) return;

    var livePcts = []; // 收集所有相关的实时涨跌幅
    var mainNetTotal = 0; // 主力资金净流入
    var hasCapData = false;

    // 5a: 板块涨跌幅
    mapping.sectors.forEach(function(sec){
      // 模糊匹配(liveSectors的name可能是"有色金属"也可能是"SW有色金属")
      Object.keys(sectorPctMap).forEach(function(key){
        if(key.includes(sec) || sec.includes(key)){
          livePcts.push(sectorPctMap[key]);
        }
      });
    });

    // 5b: 指数涨跌幅(商品类)
    mapping.idx.forEach(function(idxName){
      if(idxPctMap[idxName] !== undefined){
        livePcts.push(idxPctMap[idxName]);
      }
    });

    // 5c: 板块资金流向
    mapping.capKeys.forEach(function(ck){
      Object.keys(capFlowMap).forEach(function(key){
        if(key.includes(ck) || ck.includes(key)){
          mainNetTotal += (capFlowMap[key].mainNet || 0);
          hasCapData = true;
        }
      });
    });

    if(livePcts.length === 0) return; // 无实时数据，保持原值

    // 5d: 计算平均涨幅
    var avgPct = livePcts.reduce(function(a,b){return a+b;}, 0) / livePcts.length;
    var maxPct = Math.max.apply(null, livePcts);

    // === 6. 修正算法 ===
    // 核心: 涨跌幅越大，修正力度越强
    // 基线: ±1% → ±5度, ±3% → ±15度, ±5% → ±25度, ±10% → ±35度
    var pctAdj = 0;
    if(Math.abs(avgPct) > 0.5){
      pctAdj = avgPct * 5; // 每1%涨幅 = 5度
      // 极端行情放大(>3%涨幅额外加权)
      if(Math.abs(avgPct) > 3) pctAdj += (avgPct - Math.sign(avgPct) * 3) * 3;
      // 单标的暴涨额外加权(如白银+9%)
      if(Math.abs(maxPct) > 5) pctAdj += (maxPct - Math.sign(maxPct) * 5) * 2;
    }

    // 资金流修正: 主力大幅流入/流出 ±5度
    var capAdj = 0;
    if(hasCapData){
      if(mainNetTotal > 5e8) capAdj = 5;        // >5亿净流入
      else if(mainNetTotal > 2e8) capAdj = 3;   // >2亿
      else if(mainNetTotal < -5e8) capAdj = -5;  // <-5亿净流出
      else if(mainNetTotal < -2e8) capAdj = -3;
    }

    var totalAdj = Math.round(pctAdj + capAdj);
    // 限制单次修正幅度 [-30, +35]
    totalAdj = Math.max(-30, Math.min(35, totalAdj));

    if(totalAdj !== 0){
      h.temperature = Math.max(0, Math.min(100, h.temperature + totalAdj));
      h._liveAdj = totalAdj; // 记录修正值(用于UI展示)

      // 修正趋势方向
      if(avgPct > 2 && h.trend !== 'up') h.trend = 'up';
      else if(avgPct < -2 && h.trend !== 'down') h.trend = 'down';

      // 修正情绪
      if(avgPct > 1) h.sentiment = Math.min(1, (h.sentiment || 0) + avgPct * 0.1);
      else if(avgPct < -1) h.sentiment = Math.max(-1, (h.sentiment || 0) + avgPct * 0.1);
    }

    // 记录实时涨幅(用于UI展示)
    h._livePct = avgPct;
  });

  return heatmap;
}

function _buildFallbackHeatmap(geoData){
  var tagScores = {};
  (geoData.allEvents || []).forEach(function(e){
    (e.concepts || e.fundKeywords || []).forEach(function(tag){
      if(!tagScores[tag]) tagScores[tag] = { tag: tag, temperature: 50, sentiment: 0, trend: 'stable', count: 0 };
      tagScores[tag].temperature += Math.abs(e.impact) * 1.5;
      tagScores[tag].sentiment += (e.impact > 0 ? 0.3 : -0.3);
      tagScores[tag].count++;
    });
  });
  return Object.values(tagScores)
    .map(function(t){ return Object.assign({}, t, { temperature: Math.min(100, Math.max(0, t.temperature)), sentiment: Math.max(-1, Math.min(1, t.sentiment)) }); })
    .sort(function(a,b){ return b.temperature - a.temperature; })
    .slice(0, 14);
}

function renderActionGuide(){
  const container = document.getElementById('action-guide-container');
  const brief = document.getElementById('action-guide-brief');
  if(!container) return;

  if(holdings.length === 0){
 container.innerHTML = '<div class="empty" style="padding:20px"><div class="empty-icon"></div>添加持仓后，这里会显示双引擎闭环的实盘操作建议</div>';
    if(brief) brief.textContent = '无持仓';
    return;
  }

  // 为每个持仓计算双引擎投票（AI + 回测）
  const plans = [];
  let totalBuy = 0, totalSell = 0, totalHold = 0;
  holdings.forEach((h, hIdx) => {
    const vote = computeTriEngineVote(h.code, _analysisResult?.signals?.[h.code], null, btResults[h.code]);
    const fd = getFundData(h.code);
    const td = fundHistoryData[h.code]?.trend;
    plans.push({ code: h.code, fd, td, vote, hIdx, disableRLInReason: true });
  });

 // 板块一致性修正: 同板块基金信号应趋于一致，避免"A加仓B持有"的矛盾建议
  (function sectorConsistencyCorrection(){
    // 1. 按板块分组
    const sectorGroups = {};
    plans.forEach(p => {
      const type = fundType(p.code) || '未分类';
      if(!sectorGroups[type]) sectorGroups[type] = [];
      sectorGroups[type].push(p);
    });
    // 2. 对每个板块组检查一致性
    Object.entries(sectorGroups).forEach(([type, group]) => {
      if(group.length < 2) return; // 单只基金无需校正
      const actions = group.map(p => p.vote.action);
      const hasBuy = actions.includes('buy');
      const hasSell = actions.includes('sell');
      const hasHold = actions.includes('hold');
      // 如果同板块信号完全一致，无需处理
      if(new Set(actions).size === 1) return;
      // 3. 计算板块共识方向: 用各基金finalScore的加权平均
      const avgScore = group.reduce((s,p) => s + p.vote.score, 0) / group.length;
      const maxScore = Math.max(...group.map(p => p.vote.score));
      const minScore = Math.min(...group.map(p => p.vote.score));
      // 4. 修正逻辑: 将弱信号基金向板块共识靠拢
      group.forEach(p => {
        const v = p.vote;
        const gap = Math.abs(v.score - avgScore);
        // 只修正方向不一致的情况(如一个buy一个hold，或一个sell一个hold)
        // 保守策略: 向"保守侧"靠拢(买→持有，持有不升级为买)
        if(hasBuy && v.action === 'hold' && avgScore > 0.15 && v.score > 0){
          // 同板块有买入信号，本基金也偏正但未触发买入
          // → 如果score差距不大(与板块均值相差<0.15)，升级提示但不改action
          if(gap < 0.2){
 v.actionLabel = ' 偏多持有（同板块有加仓信号）';
            v._sectorNote = `同板块${group.length}只基金中有加仓信号，本基金指标略弱，建议同步关注`;
          }
        } else if(hasBuy && v.action === 'buy' && v.score < avgScore * 0.5){
          // 本基金触发了buy但score远低于板块均值 → 降级为持有
          v.action = 'buy';
 v.actionLabel = ' 建议加仓（轻仓跟随）';
          v._sectorNote = `本基金指标弱于同板块其他品种，建议降低仓位比例`;
        } else if(hasSell && v.action === 'hold' && avgScore < -0.15 && v.score < 0){
          // 同板块有卖出信号，本基金也偏负
          if(gap < 0.2){
 v.actionLabel = ' 偏空持有（同板块有减仓信号）';
            v._sectorNote = `同板块${group.length}只基金中有减仓信号，本基金也偏弱，注意风险`;
          }
        }
      });
    });
  })();

  // 统计修正后的买/卖/持有数量
  plans.forEach(p => {
    if(p.vote.action === 'buy') totalBuy++;
    else if(p.vote.action === 'sell') totalSell++;
    else totalHold++;
  });

  // 整体组合评分 (0-100)
  const avgScore = plans.reduce((s,p) => s + p.vote.score, 0) / plans.length;
  const overallScore = Math.round(Math.max(0, Math.min(100, 50 + avgScore * 50)));
  const ds = _dataIntelLoaded ? generateDataSignal() : null;

  // 整体建议 (结合组合结构+数据信号)
  let overallAdvice = '', overallColor = '#94a3b8', overallLabel = '中性观望';
  const sectorAnalysis = getPortfolioSectorAnalysis(plans);
  if(overallScore >= 70){ overallLabel = '积极加仓'; overallColor = '#ef4444'; overallAdvice = '双引擎多数看多，市场环境偏积极。建议按Kelly仓位逐步加仓看多品种，控制单笔不超组合5%。'; }
  else if(overallScore >= 58){ overallLabel = '偏多持有'; overallColor = '#f59e0b'; overallAdvice = '信号偏正面，维持现有仓位为主。可在回调时对高共识品种小幅低吸，控制节奏。'; }
  else if(overallScore >= 42){ overallLabel = '中性观望'; overallColor = '#94a3b8'; overallAdvice = '信号分歧较大或数据不足。建议持有不动，等待引擎信号趋于一致后再行动。'; }
  else if(overallScore >= 30){ overallLabel = '偏空谨慎'; overallColor = '#f59e0b'; overallAdvice = '部分引擎看空。建议先减仓高风险卫星仓品种，保留核心仓。新资金暂不入场。'; }
  else { overallLabel = '防御减仓'; overallColor = '#22c55e'; overallAdvice = '多引擎看空。建议主动减仓卫星仓，增加现金比例，等待市场企稳信号。'; }
  // 组合结构风险提示
  if(sectorAnalysis.warnings.length > 0){
    const concTypes = sectorAnalysis.warnings.map(w => `${w.type}×${w.count}`).join('、');
 overallAdvice += ` 板块集中: ${concTypes}，注意相关性风险。`;
  }
  if(ds) overallAdvice += ` [宏观: ${ds.label}(${ds.score})]`;

  // 引擎总投票汇总
  const engAI = plans.filter(p => p.vote.ai.vote > 0).length;
  const engBT = plans.filter(p => p.vote.bt.vote > 0).length;
  const engAISell = plans.filter(p => p.vote.ai.vote < 0).length;
  const engBTSell = plans.filter(p => p.vote.bt.vote < 0).length;

  // Brief
  if(brief){
    const hasAnalysis = _analysisResult || btSummary;
    if(!hasAnalysis){
      brief.innerHTML = '<span style="color:var(--sub)">点击AI分析</span>';
    } else {
      const briefColor = overallScore >= 58 ? 'var(--red)' : overallScore <= 42 ? 'var(--green)' : 'var(--sub)';
      brief.innerHTML = `<span style="color:${briefColor}">${overallLabel} ${overallScore}</span>`;
    }
  }

  let html = '';

  // 1. 整体概览卡
  html += `<div class="ag-overview">`;
  html += `<div class="ag-score-row">`;
  html += `<div class="ag-big-score" style="color:${overallColor}">${overallScore}</div>`;
  html += `<div class="ag-score-meta"><div class="ag-score-label" style="color:${overallColor}">${overallLabel}</div>`;
  html += `<div class="ag-score-desc">综合评分：AI信号×回测验证×宏观数据</div></div></div>`;

  // 整体建议
 html += `<div class="ag-advice-bar"><b> 今日操作建议：</b>${overallAdvice}</div>`;

  // 1.2 数据信号分解 (宏观/资金/舆情/国际/地缘)
  if(_dataIntelLoaded){
    const macro = getMacroSummary();
    const capFlow = getCapFlowSummary();
    const gSent = globalNews.length > 0 ? getGlobalNewsSentiment() : null;
    const geoScore = getMacroGeoAnalysis().score;
    html += `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;padding:5px 8px;background:rgba(34,211,238,0.06);border-radius:8px;font-size:9px">`;
 html += `<span style="font-weight:700;color:#22d3ee;font-size:10px"> 多维信号</span>`;
    // 宏观
    const macroColor = macro.positiveCount >= 4 ? '#4ade80' : macro.positiveCount >= 2 ? '#fbbf24' : '#f87171';
    html += `<span style="padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.05)">宏观<b style="color:${macroColor}"> ${macro.overallSignal}</b></span>`;
    // 资金流
    const netB = capFlow.netTotal;
    const capColor = netB > 5e9 ? '#4ade80' : netB > 0 ? '#fbbf24' : netB > -5e9 ? '#fb923c' : '#f87171';
    const capLabel = netB > 0 ? `+${(netB/1e8).toFixed(0)}亿` : `${(netB/1e8).toFixed(0)}亿`;
    html += `<span style="padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.05)">主力资金<b style="color:${capColor}"> ${capLabel}</b></span>`;
    // 舆情
    const sentColor = newsSentiment.score >= 55 ? '#4ade80' : newsSentiment.score <= 45 ? '#f87171' : '#fbbf24';
    html += `<span style="padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.05)">A股舆情<b style="color:${sentColor}"> ${newsSentiment.score}</b></span>`;
    // 国际
    if(gSent){
      const gColor = gSent.score >= 55 ? '#4ade80' : gSent.score <= 45 ? '#f87171' : '#fbbf24';
      html += `<span style="padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.05)">国际<b style="color:${gColor}"> ${gSent.score}</b></span>`;
    }
    // 地缘
    const geoC = geoScore >= 60 ? '#4ade80' : geoScore <= 40 ? '#f87171' : '#fbbf24';
    html += `<span style="padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.05)">地缘<b style="color:${geoC}"> ${geoScore}</b></span>`;
    // PMI特写
    if(macroData.pmi?.[0]){
      const pmi = macroData.pmi[0].MAKE_INDEX;
      const pmiC = pmi >= 51 ? '#4ade80' : pmi >= 50 ? '#fbbf24' : '#f87171';
      html += `<span style="padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.05)">PMI<b style="color:${pmiC}"> ${pmi}</b></span>`;
    }
    html += `</div>`;
  }

  // 1.3 组合持仓结构
  if(sectorAnalysis.distribution.length > 1){
    html += `<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:4px;padding:4px 8px;background:rgba(139,92,246,0.05);border-radius:8px;font-size:9px">`;
 html += `<span style="font-weight:700;color:#e2e8f0;font-size:10px"> 持仓结构</span>`;
    sectorAnalysis.distribution.forEach(d => {
      html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.06)">${d.type} <b>${d.pct}%</b></span>`;
    });
    if(sectorAnalysis.warnings.length > 0){
 html += `<span style="color:#f87171;font-weight:600">集中度风险</span>`;
    }
    html += `</div>`;
  }

  html += `</div>`;

  // 1.5 宏观与异动雷达 (Macro & Anomaly Radar) — 三模块设计
  const geoData = getMacroGeoAnalysis();
  html += renderRadarSection(geoData);

  // 2. 逐只基金操作卡片
  // 排序：卖出优先(风控优先)，然后买入(geoBias高优先)，最后持有
  const order = {sell: 0, buy: 1, hold: 2};
  plans.sort((a,b) => {
    const oa = order[a.vote.action]||2, ob = order[b.vote.action]||2;
    if(oa !== ob) return oa - ob;
    // 同action内: 按|score|+geoBias降序排
    return (Math.abs(b.vote.score) + Math.abs(b.vote.geoBias)) - (Math.abs(a.vote.score) + Math.abs(a.vote.geoBias));
  });

  plans.forEach((p, pidx) => {
    const { code, fd, td, vote } = p;
    const todayPct = fd?.gszzl || 0;
    const pctColor = todayPct >= 0 ? 'var(--red)' : 'var(--green)';
    const capFlow = getRelevantCapFlow(code);
    const trendInfo = getTrendLabel(td);

    const holdIdx = p.hIdx;
    html += `<div class="ag-fund-card action-${vote.action}">`;
    // 顶部: 基金名+动作+优先级+删除
    html += `<div class="ag-fund-top">`;
    const _pLabel = pctLabel(fd);
    html += `<div><div class="ag-fund-name">${fundName(code)} <button class="hold-del" onclick="removeHolding(${holdIdx})" title="删除持仓">✕</button></div><div class="ag-fund-code">${code} · ${fundType(code)} · ${_pLabel} <span style="color:${fd?._noData?'var(--sub)':pctColor}">${fd?._noData?'--':((todayPct>=0?'+':'')+fmt(todayPct)+'%')}</span></div></div>`;
    html += `<div style="display:flex;align-items:center;gap:6px">`;
    // 优先级标记
    if(vote.action !== 'hold'){
 const urgency = Math.abs(vote.score) > 0.3 ? '高' : Math.abs(vote.score) > 0.15 ? '●中' : '○低';
      html += `<span style="font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(255,255,255,0.06);color:var(--sub)">#${pidx+1} ${urgency}</span>`;
    }
    html += `<span class="ag-fund-action ${vote.action}">${vote.actionLabel}</span>`;
    html += `</div></div>`;

    // 双引擎投票条
    html += `<div class="ag-vote-strip">`;
    const mkChip = (name, v, conf, extra) => {
      const cls = v > 0 ? 'bullish' : v < 0 ? 'bearish' : 'neutral';
      const txt = v > 0 ? '买' : v < 0 ? '卖' : '持';
      let label = `${name}:${txt}${conf>0?' '+conf+'%':''}`;
      if(extra) label += ' '+extra;
      return `<span class="ag-vote-chip ${cls}">${label}</span>`;
    };
 html += mkChip('AI', vote.ai.vote, vote.ai.conf, vote.ai.conf >= 70 ? '' : '');
    html += mkChip('BT', vote.bt.vote, vote.bt.conf, '');
    // 共识标签
 if(vote.buyVotes >= 2 && vote.sellVotes === 0) html += `<span class="ag-vote-chip bullish">共识看多×${vote.consensusMult.toFixed(1)}</span>`;
 else if(vote.sellVotes >= 2 && vote.buyVotes === 0) html += `<span class="ag-vote-chip bearish">共识看空×${vote.consensusMult.toFixed(1)}</span>`;
 else if(vote.buyVotes > 0 && vote.sellVotes > 0) html += `<span class="ag-vote-chip neutral">分歧×${vote.consensusMult.toFixed(1)}</span>`;
    // 宏观地缘事件标签
    const fImpact = geoData.fundImpacts[code];
    if(fImpact && fImpact.events.length > 0){
      fImpact.events.slice(0,2).forEach(ev => {
        const cls = ev.impact === 'positive' ? 'bullish' : 'bearish';
        html += `<span class="ag-vote-chip ${cls}">${ev.icon}${ev.name.slice(0,6)}</span>`;
      });
    }
    // 波段操作分析（提前计算，复用于标签和详情）
    const swingAnalysis = generateSwingAnalysis(code, td, vote, capFlow);
    if(swingAnalysis.phase !== 'unknown'){
      const _swgPhaseLabels = {
 'peak_zone':'冲顶止盈','accel_up':'加速持有','trend_pullback':'低吸机会','steady_up':'稳步持有',
 'bear_bounce':'反弹减仓','free_fall':'回避','decline':'控仓','range_low':'箱底试探',
 'range_high':'箱顶止盈','range_mid':'↔等待'
      };
      const _swgCls = swingAnalysis.phase.includes('peak') || swingAnalysis.phase.includes('bear') || swingAnalysis.phase.includes('range_high') ? 'bearish'
        : swingAnalysis.phase.includes('pullback') || swingAnalysis.phase.includes('range_low') || swingAnalysis.phase.includes('steady') ? 'bullish' : 'neutral';
 html += `<span class="ag-vote-chip ${_swgCls}">${_swgPhaseLabels[swingAnalysis.phase]||'↔'}</span>`;
    }
    html += `</div>`;

    // 趋势+波段+资金流条 (新增)
    if(td || capFlow){
      html += `<div style="display:flex;gap:4px;flex-wrap:wrap;padding:4px 0;font-size:9px">`;
      if(td){
        // 趋势方向
        html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.05);color:${trendInfo.dir.color}">${trendInfo.dir.icon} ${trendInfo.dir.text}</span>`;
        // 波段位置
        html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.05);color:${trendInfo.swing.color}">${trendInfo.swing.icon} ${trendInfo.swing.text}</span>`;
        // MA排列
        const maColor = trendInfo.maStatus === '多头排列' ? '#f87171' : trendInfo.maStatus === '空头排列' ? '#4ade80' : 'var(--sub)';
        html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.05);color:${maColor}">MA ${trendInfo.maStatus}</span>`;
        // 距高点回撤
        if(td.drawdownFromHigh < -5){
          html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.05);color:#4ade80">距高点${td.drawdownFromHigh.toFixed(0)}%</span>`;
        }
        // 从低点反弹
        if(td.reboundFromLow > 5){
          html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.05);color:#f87171">从低点+${td.reboundFromLow.toFixed(0)}%</span>`;
        }
      }
      // 板块资金流
      if(capFlow){
        const cfColor = capFlow.mainNet > 0 ? '#4ade80' : '#f87171';
        const cfVal = capFlow.mainNet > 0 ? `+${(capFlow.mainNet/1e8).toFixed(1)}亿` : `${(capFlow.mainNet/1e8).toFixed(1)}亿`;
 html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(255,255,255,0.05);color:${cfColor}">主力${cfVal}</span>`;
      }
      html += `</div>`;
    }

    // 持仓行业分布 (基于持仓分析引擎)
    const sectorExp = getFundSectorExposure(code);
    const holdingsInfo = _fundHoldingsCache[code];
    if(sectorExp && Object.keys(sectorExp).length > 0){
      html += `<div style="display:flex;gap:4px;flex-wrap:wrap;padding:4px 0;font-size:9px;align-items:center">`;
 html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(30,41,59,0.08);color:#1e293b;font-weight:600">行业</span>`;
      const topSectors = Object.entries(sectorExp).sort((a,b) => b[1] - a[1]).filter(([,w]) => w >= 0.05);
      topSectors.forEach(([sec, weight]) => {
        const pct = (weight * 100).toFixed(0);
        const barW = Math.max(8, weight * 60);
        html += `<span style="padding:2px 5px;border-radius:4px;background:rgba(30,41,59,0.06);color:#1e293b;position:relative;overflow:hidden">`;
        html += `<span style="position:absolute;left:0;top:0;bottom:0;width:${barW}px;background:rgba(59,130,246,0.15);border-radius:4px"></span>`;
        html += `<span style="position:relative">${sec} ${pct}%</span></span>`;
      });
      // 数据来源标注
      const srcLabel = holdingsInfo?.source === 'holdings' ? '持仓' : holdingsInfo?.source === 'inferred' ? '推断' : '名称';
      html += `<span style="color:var(--sub);font-size:8px;margin-left:auto">[${srcLabel}]</span>`;
      html += `</div>`;
    }

    // 操作理由 (使用智能生成)
    const reason = generateSmartReason(p, capFlow, ds);
    // swingAnalysis 已在前面计算，直接复用
    // 地缘事件理由补充
    let geoReason = '';
    if(vote.geoEvents && vote.geoEvents.length > 0){
      const posGeo = vote.geoEvents.filter(e => e.impact === 'positive');
      const negGeo = vote.geoEvents.filter(e => e.impact === 'negative');
      if(posGeo.length > 0) geoReason += `🌍地缘利好: ${posGeo.map(e=>e.icon+e.name).join('、')}`;
      if(negGeo.length > 0) geoReason += `${geoReason?'; ':''}⚠️地缘利空: ${negGeo.map(e=>e.icon+e.name).join('、')}`;
    }
    html += `<div class="ag-reason">${reason}`;
    if(geoReason) html += `<br><span style="font-size:9px;color:#1e40af">${geoReason}</span>`;
 if(vote._sectorNote) html += `<br><span style="font-size:9px;color:#f59e0b"> 板块一致性: ${vote._sectorNote}</span>`;
    html += `</div>`;

    // 波段操作分析模块
    if(swingAnalysis.html){
      html += swingAnalysis.html;
    }

    html += `</div>`; // end ag-fund-card
  });

  // 3. 执行摘要 & 对比模拟盘
  html += `<div class="ag-summary">`;
 html += `<div class="ag-summary-title"> 执行摘要</div>`;
  html += `<div class="ag-summary-text">`;
  html += `今日建议：<b style="color:var(--red)">${totalBuy}只加仓</b> · <b style="color:var(--green)">${totalSell}只减仓</b> · <b>${totalHold}只持有</b><br>`;

  // 优先行动清单
  const actionFunds = plans.filter(p => p.vote.action !== 'hold');
  if(actionFunds.length > 0){
 html += `<b> 执行优先序：</b><br>`;
    actionFunds.forEach((p, i) => {
 const emoji = p.vote.action === 'sell' ? '�' : '';
      const act = p.vote.action === 'sell' ? '减仓' : '加仓';
      const kellyStr = p.vote.action === 'buy' ? ` Kelly${(p.vote.bt.kelly*100).toFixed(0)}%` : ' 减30-50%';
      html += `${emoji} #${i+1} ${fundName(p.code).slice(0,8)} → ${act}${kellyStr}<br>`;
    });
  }

  // 与模拟盘今日操作对比
  if(simPortfolio?.history){
    const today = todayStr();
    const todayTrades = simPortfolio.history.filter(h => h.date === today);
    if(todayTrades.length > 0){
      html += `<b>模拟盘今日操作：</b>${todayTrades.length}笔 — `;
      todayTrades.slice(0,3).forEach(t => {
 html += `${t.action==='buy'?'�买':'卖'}${fundName(t.code).slice(0,4)} `;
      });
      if(todayTrades.length > 3) html += `…等${todayTrades.length}笔`;
      html += '<br>';
    }
    const totalVal = getSimTotalValue();
    const cumR = (totalVal - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
    html += `模拟盘累计收益: <b style="color:${cumR>=0?'var(--red)':'var(--green)'}">${cumR>=0?'+':''}${cumR.toFixed(2)}%</b> — 可参考模拟盘验证双引擎信号可靠性<br>`;
  }

  // TOP50基金经理 × 社交热词 趋势共振分析
  const fmData = _fmSocialTrendData || analyzeFMSocialCoupling();
  if(fmData && fmData.topTrends.length > 0){
 html += `<br><b> TOP50基金经理 × 社交热词 趋势共振</b><br>`;
    html += `<span style="font-size:10px;color:var(--sub)">数据源: TOP500基金经理前50名(季报持仓+调研) × 微博/雪球/东财/同花顺</span><br>`;

    // 强共振板块
    const resonated = fmData.topTrends.filter(t => t.resonance === '强共振').slice(0, 5);
    if(resonated.length > 0){
      html += `<div style="margin:6px 0;padding:6px 10px;background:#f0f9ff;border-radius:8px;border:1px solid #bae6fd">`;
 html += `<b style="font-size:11px;color:#0369a1"> 强共振板块</b> <span style="font-size:10px;color:#64748b">经理集中配置 + 社交热度飙升</span><br>`;
      resonated.forEach(t => {
        const trendIcon = t.socialTrend === 'up' ? '🔺' : t.socialTrend === 'down' ? '🔻' : '➡️';
        const barW = Math.round(t.couplingScore * 0.8);
        const hwStr = t.hotwords.map(h => h.word).join('·');
        html += `<div style="margin:3px 0;font-size:11px">`;
        html += `<div style="display:flex;align-items:center;gap:4px">`;
        html += `<b style="min-width:60px">${t.sector}</b>`;
        html += `<div style="flex:1;height:6px;background:#e2e8f0;border-radius:3px"><div style="height:100%;width:${barW}%;background:linear-gradient(90deg,#3b82f6,#06b6d4);border-radius:3px"></div></div>`;
        html += `<span style="font-size:10px;font-weight:700;color:#0369a1;min-width:30px">${t.couplingScore}</span>`;
        html += `</div>`;
        html += `<div style="font-size:9px;color:#64748b;margin-left:64px">经理${t.mgrCount}人(${t.mgrNames.join('/')}) ${trendIcon}热词:${hwStr}</div>`;
        html += `</div>`;
      });
      html += `</div>`;
    }

    // 经理最新动向
    const keyMoves = fmData.recentMoves.slice(0, 4);
    if(keyMoves.length > 0){
      html += `<div style="margin:4px 0;font-size:10px">`;
 html += `<b> 顶级经理最新动向: </b>`;
      keyMoves.forEach(m => {
        html += `<span style="color:#1e293b">${m.name}</span><span style="color:var(--sub)">(${m.firm}): </span><span style="color:#0369a1">${m.recent}</span> `;
      });
      html += `</div>`;
    }

    // 与持仓基金的关联提示
    const holdingSectors = new Set();
    holdings.forEach(h => {
      const se = getFundSectorExposure(h.code);
      if(se) Object.keys(se).forEach(s => holdingSectors.add(s));
      // 也通过基金名称匹配
      const nm = fundName(h.code);
      fmData.topTrends.forEach(t => {
        if(nm.includes(t.sector) || t.sector.split('').some(c => nm.includes(c) && c.length > 1)) holdingSectors.add(t.sector);
      });
    });
    const matchedTrends = fmData.topTrends.filter(t => holdingSectors.has(t.sector) && t.resonance === '强共振');
    if(matchedTrends.length > 0){
      html += `<div style="margin:4px 0;padding:4px 8px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0;font-size:10px">`;
 html += ` 您的持仓与以下强共振方向吻合: <b>${matchedTrends.map(t=>t.sector).join('、')}</b> — 建议持有或适当加仓`;
      html += `</div>`;
    }
  }

  // 数据融合说明
 html += `<br><b> 本次分析融合数据源：</b><br>`;
  const dataSources = [];
  if(_analysisResult) dataSources.push(`AI(${_analysisResult.engineCount}引擎)`);
  if(btSummary) dataSources.push('回测');
  if(_dataIntelLoaded) dataSources.push('宏观·资金流·A股舆情·国际舆情');
  const geoEvtCount = getMacroGeoAnalysis().allEvents.length;
  if(geoEvtCount > 0) dataSources.push(`${geoEvtCount}项地缘事件`);
  const trendCount = plans.filter(p => p.td).length;
  if(trendCount > 0) dataSources.push(`${trendCount}只趋势+波段分析`);
  if(_fmSocialTrendData) dataSources.push('TOP50基金经理×社交热词');
  html += `${dataSources.join(' × ')}<br>`;

 html += `<br><b> 操作原则：</b><br>`;
  html += `① 分批执行：单次操作不超总仓位5%，分2-3次完成<br>`;
  html += `② 核心仓优先：核心仓(宽基/债基)保持60%底仓，卫星仓灵活调整<br>`;
  html += `③ 双引擎分歧时不动：AI与回测方向不一致时，观望为主<br>`;
  html += `④ 止损优先：任何品种亏损超5%立即减仓，不等信号`;
  html += `</div></div>`;

 html += `<div class="ag-disclaimer"> 以上建议基于AI/回测双引擎量化分析，仅供参考，不构成投资建议。投资有风险，决策需谨慎。</div>`;

  container.innerHTML = html;
}

// ==================== PLAIN-LANGUAGE INSTITUTIONAL ANALYSIS ====================
function togglePlainAdvisor(){
  const container = document.getElementById('plain-advisor-container');
  const icon = document.getElementById('plain-advisor-toggle');
  if(!container || !icon) return;
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = '▼';
    renderPlainAdvisor();
  }else{
    container.style.display = 'none';
    icon.textContent = '▶';
  }
}

function _calcVolatility(code, windowDays = 20){
  const navs = fundHistoryData[code]?.navs;
  if(!navs || navs.length < windowDays + 1) return null;
  const prices = navs.slice(-(windowDays + 1)).map(n => parseFloat(n.nav!==undefined?n.nav:n[1])).filter(v => !isNaN(v) && v > 0);
  if(prices.length < windowDays + 1) return null;
  const rets = [];
  for(let i=1;i<prices.length;i++) rets.push((prices[i]-prices[i-1])/prices[i-1]);
  const mean = rets.reduce((s,v)=>s+v,0)/rets.length;
  const variance = rets.reduce((s,v)=>s+Math.pow(v-mean,2),0)/Math.max(1,rets.length-1);
  return Math.sqrt(variance) * 100;
}

function _fundHeatScore(code, type, name){
  const heatmap = _hotEventsData?.heatmap || [];
  const exposure = getFundSectorExposure(code) || {};
  const tags = new Set(Object.keys(exposure));
  const text = `${type||''} ${name||''}`;
  const kwToTag = [
    ['黄金','黄金'],['有色','有色金属'],['军工','军工'],['新能源','新能源'],['锂电','锂电'],
    ['半导体','半导体'],['芯片','半导体'],['人工智能','人工智能'],['AI','AI算力'],['红利','红利'],
    ['宽基','宽基'],['白酒','白酒'],['消费','消费']
  ];
  kwToTag.forEach(([kw, tag])=>{ if(text.includes(kw)) tags.add(tag); });

  const picked = heatmap.filter(h => [...tags].some(t => h.tag.includes(t) || t.includes(h.tag)));
  if(picked.length === 0){
    const avgHeat = heatmap.length ? Math.round(heatmap.reduce((s,h)=>s+(h.temperature||50),0)/heatmap.length) : 50;
    return { heat: avgHeat, trend: 'stable' };
  }
  const heat = Math.round(picked.reduce((s,h)=>s+(h.temperature||50),0)/picked.length);
  let up = 0, down = 0;
  picked.forEach(h=>{ if(h.trend==='up') up++; else if(h.trend==='down') down++; });
  const trend = up>down ? 'up' : down>up ? 'down' : 'stable';
  return { heat, trend };
}

function _valuationBucket(td, heat){
  const dd = td?.drawdownFromHigh ?? -8;
  if(dd <= -25 && heat <= 60) return '极度低估';
  if(dd >= -8 || heat >= 75) return '估值偏高';
  return '估值合理';
}

function _trendBucket(td){
  if(!td) return '筑底震荡';
  if(td.trendDir === 'strong_down' || td.trendDir === 'down') return '跌跌不休';
  if(td.trendDir === 'strong_up' || td.trendDir === 'up') return '强势上涨';
  return '筑底震荡';
}

function _newsPackForFund(code, type, name){
  const keyWords = [...new Set([type, name, '基金', 'A股', '流动性', '政策'].filter(Boolean))];
  const allNews = [];
  (newsHeadlines || []).slice(0, 8).forEach(n => allNews.push({src:'财经', title:n.title || n.text || '', time:n.time || ''}));
  (_hotEventsData?.events || []).slice(0, 8).forEach(e => allNews.push({src:'事件', title:e.title || '', time:e.time || '', impact:e.impact || 0}));
  (globalNews || []).slice(0, 6).forEach(n => allNews.push({src:n.source || '国际', title:n.title || '', time:n.time || ''}));

  const related = allNews.filter(n => keyWords.some(k => (n.title || '').includes(k))).slice(0, 6);
  const noisy = allNews.filter(n => !keyWords.some(k => (n.title || '').includes(k))).slice(0, 5);
  return { related, noisy };
}

function _renderPlainRadarChart(radarScores, riskScore = 0){
  const entries = Object.entries(radarScores || {});
  if(entries.length < 3) return '';

  const score = Math.max(0, Math.min(100, Number(riskScore)||0));
  const strokeColor = score >= 55 ? '#ef4444' : score >= 35 ? '#f59e0b' : '#10b981';
  const fillColor = score >= 55 ? 'rgba(239,68,68,0.20)' : score >= 35 ? 'rgba(245,158,11,0.20)' : 'rgba(16,185,129,0.20)';
  const labelColor = score >= 55 ? '#b91c1c' : score >= 35 ? '#b45309' : '#047857';

  const W = 260, H = 220;
  const cx = 130, cy = 108;
  const R = 72;
  const rings = [20, 40, 60, 80, 100];
  const N = entries.length;

  const axisPoint = (idx, valPct=100) => {
    const ang = -Math.PI/2 + (Math.PI*2*idx/N);
    const r = (Math.max(0, Math.min(100, valPct)) / 100) * R;
    return { x: cx + Math.cos(ang)*r, y: cy + Math.sin(ang)*r };
  };

  let svg = `<svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet" style="width:100%;max-width:320px;height:auto;display:block;margin:0 auto">`;

  rings.forEach(rv => {
    const pts = entries.map((_, i) => {
      const p = axisPoint(i, rv);
      return `${p.x.toFixed(1)},${p.y.toFixed(1)}`;
    }).join(' ');
    svg += `<polygon points="${pts}" fill="none" stroke="rgba(148,163,184,0.35)" stroke-width="0.8"/>`;
  });

  entries.forEach((_, i) => {
    const p = axisPoint(i, 100);
    svg += `<line x1="${cx}" y1="${cy}" x2="${p.x.toFixed(1)}" y2="${p.y.toFixed(1)}" stroke="rgba(148,163,184,0.35)" stroke-width="0.8"/>`;
  });

  const valuePts = entries.map(([_, v], i) => {
    const p = axisPoint(i, Number(v)||0);
    return `${p.x.toFixed(1)},${p.y.toFixed(1)}`;
  }).join(' ');
  svg += `<polygon points="${valuePts}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2"/>`;

  entries.forEach(([k, v], i) => {
    const p = axisPoint(i, Number(v)||0);
    svg += `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="2.8" fill="${strokeColor}"/>`;

    const lp = axisPoint(i, 112);
    const anchor = lp.x < cx - 8 ? 'end' : lp.x > cx + 8 ? 'start' : 'middle';
    const dy = lp.y > cy + R*0.55 ? 12 : -2;
    svg += `<text x="${lp.x.toFixed(1)}" y="${(lp.y+dy).toFixed(1)}" font-size="10" fill="#334155" text-anchor="${anchor}">${k}</text>`;
    svg += `<text x="${lp.x.toFixed(1)}" y="${(lp.y+dy+12).toFixed(1)}" font-size="10" fill="${labelColor}" text-anchor="${anchor}">${Math.round(Number(v)||0)}</text>`;
  });

  svg += `</svg>`;
  return `<div style="background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:8px 6px">${svg}</div>`;
}

function renderPlainAdvisor(){
  const section = document.getElementById('plain-advisor-section');
  const container = document.getElementById('plain-advisor-container');
  if(!section || !container) return;

  if(holdings.length === 0){
    section.style.display = '';
    container.innerHTML = '<div class="empty" style="padding:20px">先添加持仓后，这里会自动生成“说人话”的机构级研判。</div>';
    return;
  }
  section.style.display = '';

  let html = '';
  const geo = getMacroGeoAnalysis();

  const riskRankOf = (item) => {
    const code = item.code;
    const name = item.name || fundName(code);
    const type = item.type || fundType(code);
    const td = fundHistoryData[code]?.trend || null;
    const vol20 = _calcVolatility(code, 20) || 1.0;
    const heatInfo = _fundHeatScore(code, type, name);
    const valuation = _valuationBucket(td, heatInfo.heat);
    const trend = _trendBucket(td);
    const geoImpact = geo?.fundImpacts?.[code]?.score || 0;
    const drawdown = td?.drawdownFromHigh ?? -8;
    const hot = heatInfo.heat;

    let score = 0;
    if(valuation === '估值偏高') score += 20;
    if(trend === '跌跌不休') score += 28;
    if(geoImpact < -8) score += 20;
    if(hot >= 80) score += 18;
    if(vol20 > 1.8) score += 12;
    if(drawdown <= -20) score += 10;
    return score;
  };

  const orderedHoldings = holdings.slice().sort((a, b) => riskRankOf(b) - riskRankOf(a));

  orderedHoldings.forEach(item => {
    const code = item.code;
    const name = item.name || fundName(code);
    const type = item.type || fundType(code);
    const fd = getFundData(code);
    const td = fundHistoryData[code]?.trend || null;
    const vol20 = _calcVolatility(code, 20);
    const heatInfo = _fundHeatScore(code, type, name);
    const valuation = _valuationBucket(td, heatInfo.heat);
    const trend = _trendBucket(td);
    const geoImpact = geo?.fundImpacts?.[code]?.score || 0;
    const wind = geoImpact > 8 ? '顺风' : geoImpact < -8 ? '逆风' : '混乱';
    const newsPack = _newsPackForFund(code, type, name);

    const drawdown = td?.drawdownFromHigh ?? -8;
    const momentum = td?.chg20d ?? 0;
    const hot = heatInfo.heat;

    let tldr = '暂不追高，分批观察';
    if(valuation === '极度低估' && trend !== '跌跌不休') tldr = '便宜区间，可慢慢买';
    else if(valuation === '估值偏高' && trend === '强势上涨') tldr = '热度偏高，防回调';
    else if(trend === '跌跌不休' && wind === '逆风') tldr = '下行未止，先观望';

    let riskPoint = '短期情绪可能反复，容易来回震荡。';
    if(hot >= 80) riskPoint = '拥挤交易过热，容易出现快速回撤。';
    else if(wind === '逆风') riskPoint = '宏观逆风未解除，反弹持续性可能不足。';
    else if(vol20 !== null && vol20 > 1.8) riskPoint = '波动放大，短线大起大落风险上升。';

    let op = '适合底仓持有';
    let tactic = '分成6-10份，小跌小买，不一次性梭哈。';
    if(valuation === '极度低估' && wind !== '逆风' && trend !== '跌跌不休'){
      op = '强烈推荐定投';
      tactic = '把计划资金分10份，每跌2%加1份；反弹时不追。';
    } else if(valuation === '估值偏高' && hot >= 75){
      op = '逢高减仓';
      tactic = '先减20%-30%浮盈仓位，保留底仓等待回落。';
    } else if(trend === '跌跌不休' && wind === '逆风'){
      op = '坚决观望';
      tactic = '先不加仓，等趋势止跌再评估。';
    }

    const ma20 = td?.ma20;
    const stopLine = ma20
      ? `若连续2日跌破 MA20(${ma20.toFixed(4)}) 且资金面转弱，暂停加仓。`
      : '若从当前再跌超5%且无利好催化，暂停加仓。';

    const valScoreBase = valuation === '极度低估' ? 85 : valuation === '估值合理' ? 65 : 42;
    const momentumScore = Math.max(15, Math.min(95, Math.round(50 + momentum * 2.2)));
    const macroScore = Math.max(20, Math.min(90, Math.round(55 + geoImpact * 1.8)));
    const defenseScore = Math.max(20, Math.min(92, Math.round(72 + drawdown * 1.2 - (vol20||1)*6)));
    const crowdPenalty = hot >= 80 ? -15 : hot >= 70 ? -8 : hot <= 35 ? 8 : 0;
    const sentimentScore = Math.max(20, Math.min(95, 70 + crowdPenalty));

    const radar = {
      radar_scores: {
        '估值吸引力': Math.round(Math.max(0, Math.min(100, valScoreBase))),
        '上涨爆发力': Math.round(Math.max(0, Math.min(100, momentumScore))),
        '宏观顺风度': Math.round(Math.max(0, Math.min(100, macroScore))),
        '抗跌防御力': Math.round(Math.max(0, Math.min(100, defenseScore))),
        '情绪健康度': Math.round(Math.max(0, Math.min(100, sentimentScore)))
      }
    };

    const relTxt = newsPack.related.slice(0,3).map(n => `【${n.src}】${n.title}`).join('；') || '暂无强相关要闻';
    const noiseTxt = newsPack.noisy.slice(0,2).map(n => `【${n.src}】${n.title}`).join('；') || '暂无噪音样本';

    html += `<div style="background:var(--card);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);margin-bottom:10px">`;
    const riskScore = riskRankOf(item);
    const riskLabel = riskScore >= 55 ? '高风险' : riskScore >= 35 ? '中风险' : '低风险';
    const riskStyle = riskScore >= 55
      ? 'background:#fef2f2;color:#dc2626;border:1px solid #fecaca;'
      : riskScore >= 35
        ? 'background:#fffbeb;color:#d97706;border:1px solid #fde68a;'
        : 'background:#ecfdf5;color:#059669;border:1px solid #a7f3d0;';

    html += `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">`;
    html += `<div style="font-size:13px;font-weight:800">${name} (${code})</div>`;
    html += `<span style="font-size:10px;padding:2px 8px;border-radius:999px;font-weight:700;${riskStyle}">${riskLabel} · ${riskScore}</span>`;
    html += `</div>`;
    html += `<div style="font-size:11px;color:var(--sub);line-height:1.6">`;
    html += `<b>技术面与交易数据</b>：今日${(fd?.gszzl||0)>=0?'+':''}${(fd?.gszzl||0).toFixed(2)}%，20日动量${momentum>=0?'+':''}${momentum.toFixed(2)}%，回撤${drawdown.toFixed(2)}%，20日波动${vol20!==null?vol20.toFixed(2)+'%':'--'}<br>`;
    html += `<b>基本面与估值数据</b>：类型${type||'--'}，行业热度${hot}，估值温度判定${valuation}<br>`;
    html += `<b>近期相关宏观/行业资讯（含噪音）</b>：${relTxt}<br>`;
    html += `<span style="opacity:0.8">噪音样本：${noiseTxt}</span>`;
    html += `</div>`;

    html += `<div style="margin-top:10px">`;
 html += `<div style="font-size:14px;font-weight:800;margin-bottom:8px"> 一句话诊断 (TL;DR)</div>`;
    html += `<div style="font-size:13px;font-weight:700;color:#1e293b;margin-bottom:10px">${tldr}</div>`;

 html += `<div style="font-size:14px;font-weight:800;margin-bottom:8px"> 多维体检报告</div>`;
    html += `<div style="font-size:12px;line-height:1.7;color:#1e293b">`;
 html += `- <b>当前温度 (估值与位置)</b>：${valuation}。${valuation==='极度低估'?'现在买更像打折区。':valuation==='估值偏高'?'现在买偏贵，容易买在情绪高点。':'价格不算便宜也不算贵，适合分批。'}<br>`;
 html += `- <b>动量趋势 (技术面状态)</b>：${trend}。${trend==='强势上涨'?'趋势在上，但别追高。':trend==='跌跌不休'?'下坡还没走完，先等止跌。':'正在磨底，适合慢慢布局。'}<br>`;
 html += `- <b>风向判定 (宏观与基本面)</b>：${wind}。${wind==='顺风'?'政策/流动性对该方向更友好。':wind==='逆风'?'宏观压力还在，反弹容易被压制。':'利好和利空并存，容易来回打脸。'}<br>`;
 html += `- <b>最大隐患 (排雷)</b>：${riskPoint}`;
    html += `</div>`;

 html += `<div style="font-size:14px;font-weight:800;margin:12px 0 8px"> 行动指南 (Action Plan)</div>`;
    html += `<div style="font-size:12px;line-height:1.7;color:#1e293b">`;
    html += `- <b>操作建议</b>：${op}<br>`;
    html += `- <b>战术安排</b>：${tactic}<br>`;
    html += `- <b>止损/观察线</b>：${stopLine}`;
    html += `</div>`;

 html += `<div style="font-size:14px;font-weight:800;margin:12px 0 8px"> 雷达图数据</div>`;
    html += _renderPlainRadarChart(radar.radar_scores, riskScore);
    html += `</div></div>`;
  });

  container.innerHTML = html;
}

// ===== 实时净值显示辅助函数 =====
function buildNavDisplay(f, compact){
  const ms = getMarketStatus();
  const isLive = f._live && (ms.status==='open' || ms.status==='break');
  const gsz = parseFloat(f.gsz);
  const dwjz = parseFloat(f.dwjz);
  if(isNaN(gsz) && isNaN(dwjz)) return '';

  const navVal = !isNaN(gsz) ? gsz.toFixed(4) : dwjz.toFixed(4);
  const navLabel = isLive ? '估值' : '净值';
  const dotHtml = isLive ? '<span class="nav-live-dot"></span>' : '';

  // 估算时间
  let timeStr = '';
  if(f.gztime){
    const parts = f.gztime.split(' ');
    timeStr = parts.length>1 ? parts[1] : parts[0];
  }

  if(compact){
    return `<div style="font-size:10px;color:var(--sub);text-align:right;margin-top:1px;font-variant-numeric:tabular-nums">
      ${dotHtml}${navLabel} ${navVal}${!isNaN(dwjz)&&!isNaN(gsz)&&gsz!==dwjz?' <span style="opacity:0.6">昨 '+dwjz.toFixed(4)+'</span>':''}
    </div>`;
  }

  return `<div class="signal-nav-row">
    ${dotHtml}<span class="signal-nav-val">${navLabel} ${navVal}</span>
    ${!isNaN(dwjz)&&!isNaN(gsz)&&gsz!==dwjz?'<span class="signal-nav-prev">昨收 '+dwjz.toFixed(4)+'</span>':''}
    ${timeStr?'<span class="signal-nav-time">'+timeStr+'</span>':''}
  </div>`;
}

function renderSignals(){ /* removed – action guide now covers all signals */ }

function renderWatchlist(){
  const section = document.getElementById('watchlist-section');
  const container = document.getElementById('watchlist-container');
  if(watchlist.length===0){ section.style.display='none'; return; }
  section.style.display='';

  let html = '';
  watchlist.forEach((w,i)=>{
    const f = getFundData(w.code);
    const sig = _analysisResult?.signals[w.code];
    const sigText = sig ? (sig.action==='buy'?'建议买入':sig.action==='sell'?'暂不建议':'可关注') : '';
    const sigColor = sig ? (sig.action==='buy'?'background:var(--green-bg);color:var(--green)':sig.action==='sell'?'background:var(--red-bg);color:var(--red)':'background:var(--gray-bg);color:var(--sub)') : '';
    const wTrend = fundHistoryData[w.code]?.trend;
 const trendBrief = wTrend ? ` · ${wTrend.trendDir==='strong_up'||wTrend.trendDir==='up'?'':''}60日${wTrend.chg60d>0?'+':''}${wTrend.chg60d}%` : '';

    const wNavHtml = buildNavDisplay(f, true);
    html += `<div class="watch-item">
      <div class="watch-left">
        <div class="watch-name">${fundName(w.code)} <span style="font-size:10px;color:var(--sub)">${w.code}</span></div>
        <div class="watch-type">${fundType(w.code)}${trendBrief}${sig?.target3m?' · 3月:'+sig.target3m:''}</div>
      </div>
      <div style="text-align:right;min-width:80px">
        <span class="watch-pct" style="color:${f.gszzl>=0?'var(--red)':'var(--green)'}">${sign(f.gszzl)}${fmt(f.gszzl)}%</span>
        ${wNavHtml}
      </div>
      ${sigText?`<span class="watch-signal" style="${sigColor}">${sigText}</span>`:''}
 <button class="watch-del" onclick="removeWatch(${i})"></button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderRecos(){
  const section = document.getElementById('reco-section');
  const container = document.getElementById('reco-container');
  if(!_analysisResult || !_analysisResult.picks || _analysisResult.picks.length===0){
    section.style.display='none';
    return;
  }
  section.style.display='';

  let html = '';
  _analysisResult.picks.forEach(p=>{
    const reco = RECO_FUND_POOL.find(f=>f.code===p.code);
    html += `<div class="reco-card">
      <div class="reco-info">
        <div class="reco-name">${p.name||reco?.name||p.code}</div>
        <div class="reco-meta">${p.type||reco?.type||''} · ${p.endorsements}/${_analysisResult.engineCount}引擎推荐</div>
        <div class="reco-meta">${p.reason||''}</div>
      </div>
      ${p.expected3m?`<div class="reco-expect">${p.expected3m}</div>`:''}
      <button class="reco-add" onclick="addToWatchFromReco('${p.code}','${(p.name||reco?.name||'').replace(/'/g,"\\'")}','${p.type||reco?.type||''}')">+ 自选</button>
    </div>`;
  });
  container.innerHTML = html;
}

function renderMarketSummary(){
  const section = document.getElementById('market-summary-section');
  const container = document.getElementById('market-summary');
  if(!_analysisResult?.marketSummary){ section.style.display='none'; return; }
  section.style.display='';

  const pa = _analysisResult.portfolioAdvice;
  const portHtml = pa ? `<div style="margin-top:10px;padding:10px 14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0">
 <b style="font-size:12px;color:#1e293b"> 仓位建议</b><br>
 <span style="display:inline-flex;align-items:center;gap:6px;margin:6px 0"><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#f0f4ff;color:#3b5998;border:1px solid #d6e0f5">核心仓 ${pa.coreRatio||'60%'}</span>
 <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#fef9ee;color:#b8860b;border:1px solid #f0e4c4">卫星仓 ${pa.satRatio||'40%'}</span></span><br>
    <span style="font-size:11px;color:#475569;line-height:1.5">${pa.advice||''}</span>
  </div>` : '';

  container.innerHTML = `<div class="market-summary">
 <b> 市场研判</b><span class="provider-tag">${_aiProvider.name}</span><br>
    ${_analysisResult.marketSummary}
    ${_analysisResult.benchmarkView?`<br><b>沪深300展望：</b>${_analysisResult.benchmarkView}`:''}
    ${portHtml}
  </div>`;
}

// ==================== UI ACTIONS ====================
async function triggerAI(){
  if(_analyzing) return;
  if(!_aiKey) _aiKey = getStoredApiKey();
  if(!_aiKey){ alert('请先在设置中配置API Key'); return; }
  if(holdings.length===0 && watchlist.length===0){ alert('请先添加持仓或自选基金'); return; }

  const btn = document.getElementById('ai-btn');
  const progress = document.getElementById('ai-progress');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-sm"></span> AI分析中...';

  try {
    _analysisResult = await runAIAnalysis((msg, count)=>{
      progress.textContent = msg;
    });
 progress.textContent = ` ${_analysisResult.engineCount}个引擎分析完成`;
    saveTodayPredictions();
    // 模拟盘自动交易
    const simTrades = simAutoTrade();
    updateSimDaily();
    renderMarketSummary();
    renderActionGuide();
    renderWatchlist();
    renderRecos();
    renderReview();
    renderSimPortfolio();
    if(simTrades > 0) progress.textContent += ` · 模拟盘执行${simTrades}笔交易`;
  } catch(e) {
 progress.textContent = ` ${e.message}`;
  } finally {
    _analyzing = false;
    btn.disabled = false;
 btn.innerHTML = ' 一键AI分析 · 4引擎研判';
  }
}

let _selectedFund = null; // {code, name}
let _searchTimer = null;

function openAddModal(mode){
  _addMode = mode;
  _selectedFund = null;
  document.getElementById('add-modal').style.display = 'flex';
 document.getElementById('add-modal-title').innerHTML = (mode==='holding'?' 添加持仓':' 添加自选') + ' <button onclick="closeAddModal()"></button>';
  document.getElementById('add-search-area').style.display = '';
  document.getElementById('add-selected-area').style.display = 'none';
  document.getElementById('add-search-input').value = '';
  document.getElementById('add-search-results').innerHTML = '';
  document.getElementById('add-search-hint').style.display = '';
  setTimeout(()=>document.getElementById('add-search-input').focus(), 100);
}

function closeAddModal(){ document.getElementById('add-modal').style.display='none'; _selectedFund=null; }

function onFundSearchInput(){
  const q = (document.getElementById('add-search-input').value||'').trim();
  const resultsEl = document.getElementById('add-search-results');
  const hintEl = document.getElementById('add-search-hint');

  if(q.length === 0){
    resultsEl.innerHTML = '';
    hintEl.style.display = '';
    hintEl.textContent = '输入基金代码（如 000216）或关键词（如「黄金」）搜索';
    return;
  }
  hintEl.style.display = 'none';

  // 先搜本地
  const localResults = searchLocalFunds(q);
  if(localResults.length > 0){
    renderSearchResults(localResults);
  }

  // 如果是纯数字且长度>=3，在线搜索
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(async ()=>{
    // 防竞态：异步回调后检查输入是否已变化，过期则丢弃
    const isStale = ()=> (document.getElementById('add-search-input').value||'').trim() !== q;
    if(/^\d{3,6}$/.test(q)){
      // 数字代码：优先用搜索接口（独立回调，不阻塞）
 if(localResults.length===0) resultsEl.innerHTML = '<div class="fund-search-hint"> 正在查询...</div>';
      try {
        const results = [];
        // 搜索接口（独立回调名，无冲突）作为主要来源
        const sugResults = await searchFundsOnline(q);
        if(isStale()) return; // 输入已变化，丢弃过期结果
        if(sugResults.length > 0) results.push(...sugResults);
        // 如果搜索接口没返回结果且是完整6位，再尝试估值接口
        if(results.length === 0 && q.length === 6){
          try {
            const d = await fetchFundEstimate(q);
            if(isStale()) return;
            if(d && d.name) results.push({code:q, name:d.name, source:'online'});
          } catch(e){}
        }
        if(isStale()) return;
        if(results.length > 0){
          renderSearchResults(dedupeResults(results, localResults));
        } else if(localResults.length===0){
 resultsEl.innerHTML = '<div class="fund-search-hint"> 未找到匹配的基金，请检查代码</div>';
        }
      } catch(e){
 if(!isStale() && localResults.length===0) resultsEl.innerHTML = '<div class="fund-search-hint"> 未找到匹配的基金</div>';
      }
    } else if(q.length >= 2){
      // 关键字搜索 — 尝试在线模糊搜索
      try {
        const onlineResults = await searchFundsOnline(q);
        if(isStale()) return; // 输入已变化，丢弃过期结果
        if(onlineResults.length > 0){
          const merged = dedupeResults(onlineResults, localResults);
          renderSearchResults(merged);
        } else if(localResults.length===0){
          resultsEl.innerHTML = '<div class="fund-search-hint">未找到匹配的基金，试试输入完整6位代码</div>';
        }
      } catch(e) { /* keep local results */ }
    }
  }, 400);
}

function searchLocalFunds(q){
  const ql = q.toLowerCase();
  const all = [...FUND_DB, ...RECO_FUND_POOL];
  const seen = new Set();
  return all.filter(f=>{
    if(seen.has(f.code)) return false;
    seen.add(f.code);
    return f.code.includes(ql) || (f.name||'').toLowerCase().includes(ql) || (f.type||'').toLowerCase().includes(ql);
  }).slice(0, 20).map(f=>({code:f.code, name:f.name, type:f.type, source:'local'}));
}

function searchFundsOnline(keyword){
  return new Promise((resolve)=>{
    const cbName = '_fundSearchCb_' + Date.now();
    const script = document.createElement('script');
    const timer = setTimeout(()=>{ cleanup(); resolve([]); }, 5000);
    window[cbName] = function(data){
      clearTimeout(timer);
      cleanup();
      try {
        const items = (data && data.Datas) ? data.Datas : [];
        resolve(items.slice(0, 20).map(d=>({
          code: d.CODE || d.code || '',
          name: d.NAME || d.name || '',
          source: 'online'
        })).filter(d=>d.code && d.code.length===6));
      } catch(e){ resolve([]); }
    };
    script.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?callback=${cbName}&m=1&key=${encodeURIComponent(keyword)}`;
    script.onerror = ()=>{ clearTimeout(timer); cleanup(); resolve([]); };
    document.head.appendChild(script);
    function cleanup(){ try{delete window[cbName]; script.remove();}catch(e){} }
  });
}

function dedupeResults(primary, secondary){
  const codes = new Set(primary.map(f=>f.code));
  return [...primary, ...secondary.filter(f=>!codes.has(f.code))].slice(0,20);
}

function renderSearchResults(results){
  const el = document.getElementById('add-search-results');
  if(!results || results.length===0){ el.innerHTML=''; return; }
  el.innerHTML = results.map(f=>{
    const typeTag = f.type ? `<span class="fund-result-type">${f.type}</span>` : '';
    return `<div class="fund-result-item" onclick="selectFundResult('${f.code}','${(f.name||'').replace(/'/g,"\\'")}')"><span class="fund-result-code">${f.code}</span><span class="fund-result-name">${f.name||''}</span>${typeTag}</div>`;
  }).join('');
}

function selectFundResult(code, name){
  _selectedFund = {code, name};
  // 切到已选中状态
  document.getElementById('add-search-area').style.display = 'none';
  document.getElementById('add-selected-area').style.display = '';
  document.getElementById('add-sel-code').textContent = code;
  document.getElementById('add-sel-name').textContent = name;
  // 自动选类型
  const localMatch = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
  const type = localMatch?.type || guessFundType(name);
  autoSelectType(type);
}

function clearFundSelection(){
  _selectedFund = null;
  document.getElementById('add-search-area').style.display = '';
  document.getElementById('add-selected-area').style.display = 'none';
  document.getElementById('add-search-input').focus();
}

function guessFundType(name){
  if(!name) return '其他';
  const n = name.toLowerCase();
  if(n.includes('黄金') || n.includes('贵金属')) return '黄金';
  if(n.includes('半导体') || n.includes('芯片')) return '半导体';
  if(n.includes('军工') || n.includes('国防')) return '军工';
  if(n.includes('红利') || n.includes('高股息')) return '红利';
  if(n.includes('新能源') || n.includes('光伏') || n.includes('电池')) return '新能源';
  if(n.includes('消费') || n.includes('白酒') || n.includes('食品')) return '消费';
  if(n.includes('医药') || n.includes('医疗') || n.includes('创新药')) return '医药';
  if(n.includes('有色') || n.includes('铜') || n.includes('铝')) return '有色金属';
  if(n.includes('人工智能') || n.includes('ai') || n.includes('云计算') || n.includes('科技') || n.includes('信息')) return 'AI/科技';
  if(n.includes('纳斯达克') || n.includes('标普') || n.includes('美国') || n.includes('qdii') || n.includes('海外')) return 'QDII';
  if(n.includes('300') || n.includes('500') || n.includes('沪深') || n.includes('中证') || n.includes('创业板') || n.includes('上证')) return '宽基';
  return '其他';
}

function autoSelectType(type){
  const sel = document.getElementById('add-type');
  for(let i=0;i<sel.options.length;i++){
    if(sel.options[i].value===type){ sel.selectedIndex=i; break; }
  }
}

function confirmAdd(){
  if(!_selectedFund || !_selectedFund.code){ alert('请先搜索并选择一个基金'); return; }
  const code = _selectedFund.code;
  const name = _selectedFund.name || code;
  const type = document.getElementById('add-type').value || '其他';

  if(_addMode==='holding'){
    if(holdings.find(h=>h.code===code)){ alert('已存在该持仓'); return; }
    // 如果已在自选中，自动移除（持仓优先级更高）
    const wIdx = watchlist.findIndex(w=>w.code===code);
    if(wIdx>=0){ watchlist.splice(wIdx,1); saveWatchlist(); }
    holdings.push({code, name, type});
    saveHoldings();
  } else {
    if(holdings.find(h=>h.code===code)){ alert('该基金已在持仓中，无需重复添加到自选'); return; }
    if(watchlist.find(w=>w.code===code)){ alert('已存在该自选'); return; }
    watchlist.push({code, name, type});
    saveWatchlist();
  }

  closeAddModal();
  _analysisResult = null; // Clear old analysis
  loadData();
  // 如果管理面板打开，刷新列表
  if(document.getElementById('manage-overlay').style.display==='block'){
    renderManageList();
  }
}

function removeHolding(idx){
  if(!confirm(`确认删除持仓「${holdings[idx]?.name||holdings[idx]?.code}」？`)) return;
  holdings.splice(idx,1);
  saveHoldings();
  _analysisResult = null;
  renderAll();
}

function removeWatch(idx){
  watchlist.splice(idx,1);
  saveWatchlist();
  renderWatchlist();
}

function addToWatchFromReco(code, name, type){
  if(watchlist.find(w=>w.code===code)){ alert('已在自选中'); return; }
  watchlist.push({code, name, type});
  saveWatchlist();
  renderWatchlist();
}

// ==================== MANAGE PANEL ====================
let _manageTab = 'holding';

function openManagePanel(tab){
  _manageTab = tab || 'holding';
  document.getElementById('manage-overlay').style.display = 'block';
  document.getElementById('manage-search').value = '';
  switchManageTab(_manageTab);
}

function closeManagePanel(){
  document.getElementById('manage-overlay').style.display = 'none';
}

function switchManageTab(tab){
  _manageTab = tab;
  document.getElementById('manage-tab-holding').classList.toggle('active', tab==='holding');
  document.getElementById('manage-tab-watch').classList.toggle('active', tab==='watch');
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;
 document.getElementById('manage-search').placeholder = tab==='holding' ? ' 搜索持仓基金...' : ' 搜索自选基金...';
  renderManageList();
}

function renderManageList(){
  const body = document.getElementById('manage-body');
  const query = (document.getElementById('manage-search').value||'').trim().toLowerCase();
  const list = _manageTab==='holding' ? holdings : watchlist;
 const emptyIcon = _manageTab==='holding' ? '' : '';
  const emptyLabel = _manageTab==='holding' ? '持仓' : '自选';

  // 更新计数
  document.getElementById('manage-holding-count').textContent = holdings.length;
  document.getElementById('manage-watch-count').textContent = watchlist.length;

  if(list.length===0){
    body.innerHTML = `<div class="manage-empty">
      <div class="manage-empty-icon">${emptyIcon}</div>
      <div class="manage-empty-text">暂无${emptyLabel}基金</div>
      <button class="manage-add-btn" onclick="openAddModal('${_manageTab}')" style="margin:0 auto;display:block">+ 添加${emptyLabel}</button>
    </div>`;
    return;
  }

  // 过滤
  const filtered = list.filter((item,i)=>{
    if(!query) return true;
    const name = (fundName(item.code)||'').toLowerCase();
    return item.code.includes(query) || name.includes(query) || (item.name||'').toLowerCase().includes(query) || (item.type||'').toLowerCase().includes(query);
  });

  if(filtered.length===0){
    body.innerHTML = `<div class="manage-empty">
 <div class="manage-empty-icon"></div>
      <div class="manage-empty-text">未找到匹配 "${query}" 的基金</div>
    </div>`;
    return;
  }

  let html = `<div style="font-size:10px;color:var(--sub);padding:4px 2px 8px">共 ${filtered.length} 只${emptyLabel}基金${query?' (搜索结果)':''}</div>`;

  filtered.forEach((item) => {
    const idx = list.indexOf(item);
    const fd = getFundData(item.code);
    const pctVal = parseFloat(fd?.gszzl) || 0;
    const pctColor = pctVal >= 0 ? 'var(--red)' : 'var(--green)';
    const pctSign = pctVal >= 0 ? '+' : '';
    const navVal = fd?.gsz || fd?.dwjz || '--';
    const navLabel = fd?._live ? '实时估值' : '净值';
    const name = fundName(item.code);
    const type = fundType(item.code);

    // 趋势数据
    const trend = fundHistoryData[item.code]?.trend;
    let trendHtml = '';
    if(trend){
      const mk = (label, val) => {
        const c = val > 0 ? 'var(--red)' : val < 0 ? 'var(--green)' : 'var(--sub)';
        return `<span><span style="color:var(--sub)">${label}</span><span style="color:${c};font-weight:600">${val>0?'+':''}${val}%</span></span>`;
      };
      trendHtml = `<div class="manage-fund-trend">
        ${mk('5日', trend.chg5d)} ${mk('20日', trend.chg20d)} ${mk('60日', trend.chg60d)}
        <span><span style="color:var(--sub)">距高点</span><span style="color:var(--green);font-weight:600">${trend.drawdownFromHigh}%</span></span>
      </div>`;
    }

    // 操作按钮
    let actionsHtml = '';
    if(_manageTab === 'holding'){
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToWatch(${idx})">→ 移至自选</button>
 <button class="manage-action-btn danger" onclick="removeFromManage('holding',${idx})"> 删除</button>
      </div>`;
    } else {
      actionsHtml = `<div class="manage-fund-actions">
        <button class="manage-action-btn" onclick="moveToHolding(${idx})">→ 移至持仓</button>
 <button class="manage-action-btn danger" onclick="removeFromManage('watch',${idx})"> 删除</button>
      </div>`;
    }

    html += `<div class="manage-fund">
      <div class="manage-fund-top">
        <div class="manage-fund-info">
          <div class="manage-fund-name">${name}</div>
          <div class="manage-fund-meta">
            <span>${item.code}</span>
            <span class="manage-fund-type">${type}</span>
            <span>${navLabel}: ${typeof navVal==='number'?navVal.toFixed(4):navVal}</span>
          </div>
        </div>
        <div class="manage-fund-right">
          <div>
            <div class="manage-fund-pct" style="color:${pctColor}">${pctSign}${pctVal.toFixed(2)}%</div>
            <div class="manage-fund-nav">${fd?.gztime||''}</div>
          </div>
 <button class="manage-fund-del" onclick="removeFromManage('${_manageTab}',${idx})" title="删除"></button>
        </div>
      </div>
      ${trendHtml}
      ${actionsHtml}
    </div>`;
  });

  body.innerHTML = html;
}

function removeFromManage(type, idx){
  const list = type==='holding' ? holdings : watchlist;
  const item = list[idx];
  const label = type==='holding' ? '持仓' : '自选';
  if(!item) return;
  if(!confirm(`确认删除${label}「${item.name||fundName(item.code)||item.code}」？`)) return;

  list.splice(idx, 1);
  if(type==='holding'){
    saveHoldings();
    _analysisResult = null;
    renderAll();
  } else {
    saveWatchlist();
    renderWatchlist();
  }
  renderManageList();
}

function moveToWatch(holdingIdx){
  const item = holdings[holdingIdx];
  if(!item) return;
  if(watchlist.find(w=>w.code===item.code)){
    alert('该基金已在自选中');
    return;
  }
  holdings.splice(holdingIdx, 1);
  watchlist.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

function moveToHolding(watchIdx){
  const item = watchlist[watchIdx];
  if(!item) return;
  if(holdings.find(h=>h.code===item.code)){
    alert('该基金已在持仓中');
    return;
  }
  watchlist.splice(watchIdx, 1);
  holdings.push({code:item.code, name:item.name||fundName(item.code), type:item.type||fundType(item.code)});
  saveHoldings();
  saveWatchlist();
  _analysisResult = null;
  renderAll();
  renderManageList();
}

// Settings
function openSettings(){
  document.getElementById('settings-modal').style.display = 'flex';
  document.getElementById('input-key').value = _aiKey || '';
  let phtml = '';
  AI_PROVIDERS.forEach(p=>{
    const sel = p.id===_aiProviderId;
    phtml += `<div onclick="selectProvider('${p.id}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:2px solid ${sel?'var(--primary)':'var(--border)'};border-radius:10px;margin-bottom:6px;cursor:pointer;background:${sel?'var(--primary-bg)':'white'};transition:all .2s">
      <div style="flex:1">
        <div style="font-weight:600;font-size:12px">${p.name} ${p.free?'<span style="font-size:9px;background:#22c55e;color:white;padding:1px 5px;border-radius:3px">免费</span>':''}</div>
        <div style="font-size:9px;color:var(--sub);margin-top:2px">${p.desc}</div>
      </div>
      <div style="width:18px;height:18px;border-radius:50%;border:2px solid ${sel?'var(--primary)':'#ccc'};display:flex;align-items:center;justify-content:center">
        ${sel?'<div style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>':''}
      </div>
    </div>`;
  });
  document.getElementById('provider-list').innerHTML = phtml;
  document.getElementById('provider-hint').innerHTML = `在 <a href='${_aiProvider.link}' target='_blank' style='color:var(--primary)'>${_aiProvider.name}</a> 获取Key${_aiProvider.free?' (免费)':''}`;
  let ehtml = '';
  AI_ENGINES.forEach(eng=>{
    ehtml += `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${eng.icon}</span>
      <span style="flex:1;font-weight:500">${eng.name}</span>
      <span style="font-size:10px;color:var(--primary);background:var(--primary-bg);padding:1px 6px;border-radius:4px">${eng.model}</span>
    </div>`;
  });
  document.getElementById('engine-list').innerHTML = ehtml;
}
function selectProvider(id){ saveProvider(id); openSettings(); }
function closeSettings(){ document.getElementById('settings-modal').style.display='none'; }
function saveSettings(){
  const key = document.getElementById('input-key').value.trim();
  if(!key){ alert('请输入API Key'); return; }
  saveKey(key);
  closeSettings();
  alert(`已保存！当前: ${_aiProvider.name}`);
  // 如果国际新闻已加载但未翻译，自动触发
  if(globalNews.length > 0 && !globalNews[0]?.titleCN){
    translateGlobalNews();
  }
}
function toggleKeyVis(){
  const inp = document.getElementById('input-key');
  inp.type = inp.type==='password'?'text':'password';
}
function clearAllData(){
  if(!confirm('确认清除所有数据？(持仓、自选、分析结果等)')) return;
  localStorage.removeItem('fa_holdings');
  localStorage.removeItem('fa_watchlist');
  localStorage.removeItem('fa_lastAnalysis');
  localStorage.removeItem('fa_lastReco');
  localStorage.removeItem('fa_daily_log');
  localStorage.removeItem('fa_sim_portfolio');
  location.reload();
}

function clearAllData(){
  if(!confirm('确认清除所有数据？(持仓、自选、分析结果等)')) return;
  localStorage.removeItem('fa_holdings');
  localStorage.removeItem('fa_watchlist');
  localStorage.removeItem('fa_lastAnalysis');
  localStorage.removeItem('fa_lastReco');
  localStorage.removeItem('fa_daily_log');
  localStorage.removeItem('fa_sim_portfolio');
  localStorage.removeItem(PRED_TRACKER_KEY);
  location.reload();
}

// ==================== 预测追踪系统 (2:50 PM Snapshot + Next-Day Verification) ====================

function savePredictionTracker(){ localStorage.setItem(PRED_TRACKER_KEY, JSON.stringify(predictionTracker.slice(-60))); }

/** 获取前一个交易日 */
function getPrevTradingDay(dateStr){
  const d = new Date(dateStr + 'T12:00:00');
  for(let i = 0; i < 10; i++){
    d.setDate(d.getDate() - 1);
    const s = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if(isTradingDay(s)) return s;
  }
  return null;
}

/** 获取下一个交易日 */
function getNextTradingDay(dateStr){
  const d = new Date(dateStr + 'T12:00:00');
  for(let i = 0; i < 10; i++){
    d.setDate(d.getDate() + 1);
    const s = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if(isTradingDay(s)) return s;
  }
  return null;
}

/**
 * 14:50 快照：记录每只持仓的三引擎建议
 * @param {boolean} manual 是否手动触发(绕过时间检查)
 */
function snapshotPredictions(manual = false){
  if(holdings.length === 0){ if(manual) alert('无持仓，无法记录'); return; }
  const today = todayStr();
  const now = new Date();
  const hhmm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

  // 不是交易日不记录
  if(!isTradingDay(today) && !manual){ return; }

  // 今日已记录过
  if(predictionTracker.find(p => p.date === today)){
    if(manual && !confirm('今日已有记录，覆盖？')) return;
    predictionTracker = predictionTracker.filter(p => p.date !== today);
  }

  // 采集每只持仓快照
  const holdingsSnap = {};
  let totalScore = 0;
  holdings.forEach(h => {
    const vote = getTriEngineVote(h.code);
    const fd = getFundData(h.code);
    const btR = btResults[h.code];
    holdingsSnap[h.code] = {
      name: h.name || fundName(h.code),
      type: h.type || fundType(h.code),
      action: vote.action,                 // buy/sell/hold
      actionLabel: vote.actionLabel,
      score: +vote.score.toFixed(3),
      confidence: Math.round(vote.effConf || 0),
      aiVote: vote.ai.vote,
      aiConf: vote.ai.conf,
      rlVote: vote.rl.vote,
      rlConf: vote.rl.conf,
      btVote: vote.bt.vote,
      btConf: vote.bt.conf,
      buyVotes: vote.buyVotes,
      sellVotes: vote.sellVotes,
      consensusMult: +vote.consensusMult.toFixed(2),
      gszzl: +(fd?.gszzl || 0).toFixed(2),   // 快照时今日估算涨幅
      dwjz: fd?.dwjz || 0,                    // 昨收净值
      gsz: fd?.gsz || 0,                      // 估算净值
      rsi: btR?.lastRSI ? +btR.lastRSI.toFixed(1) : null,
      geoBias: +vote.geoBias.toFixed(3),
      sotStatus: vote.sotStatus || 'normal',
      crowdingPenalty: vote.crowdingPenalty || 0,
      contrarianBonus: vote.contrarianBonus || 0,
    };
    totalScore += vote.score;
  });

  const avgScore = totalScore / holdings.length;
  const overallScore = Math.round(Math.max(0, Math.min(100, 50 + avgScore * 50)));
  let overallLabel = '中性观望';
  if(overallScore >= 70) overallLabel = '积极加仓';
  else if(overallScore >= 58) overallLabel = '偏多持有';
  else if(overallScore >= 42) overallLabel = '中性观望';
  else if(overallScore >= 30) overallLabel = '偏空谨慎';
  else overallLabel = '防御减仓';

  const entry = {
    date: today,
    timestamp: hhmm,
    holdings: holdingsSnap,
    overallScore,
    overallLabel,
    verified: false,
    verification: null
  };

  predictionTracker.push(entry);
  savePredictionTracker();
  _predSnapshotDoneToday = true;

  console.log(`[预测追踪] ✅ ${today} ${hhmm} 快照完成: ${Object.keys(holdingsSnap).length}只基金, 综合${overallScore}(${overallLabel})`);
  if(manual) renderPredictionTracker();
  return entry;
}

/**
 * 验证前一个交易日的预测：用今日收盘数据比对
 */
function verifyPredictions(){
  const today = todayStr();
  if(!isTradingDay(today)) return;

  // 找到最近一个未验证的记录(应该是昨天/上一个交易日)
  const prevDay = getPrevTradingDay(today);
  if(!prevDay) return;
  const entry = predictionTracker.find(p => p.date === prevDay && !p.verified);
  if(!entry) return;

  const results = {};
  let correct = 0, wrong = 0, neutral = 0, total = 0;
  let totalPredReturn = 0, countPred = 0;

  Object.entries(entry.holdings).forEach(([code, pred]) => {
    const fd = getFundData(code);
    const nextDayPct = +(fd?.gszzl || 0).toFixed(2);
    total++;

    let verdict = 'neutral';
    let lesson = '';
    const predAction = pred.action;

    if(predAction === 'buy'){
      if(nextDayPct > 0.3){ verdict = 'correct'; correct++; }
      else if(nextDayPct < -0.3){ verdict = 'wrong'; wrong++; lesson = `建议加仓但次日跌${nextDayPct}%`; }
      else { verdict = 'neutral'; neutral++; }
    } else if(predAction === 'sell'){
      if(nextDayPct < -0.3){ verdict = 'correct'; correct++; }
      else if(nextDayPct > 0.3){ verdict = 'wrong'; wrong++; lesson = `建议减仓但次日涨+${nextDayPct}%`; }
      else { verdict = 'neutral'; neutral++; }
    } else { // hold
      if(Math.abs(nextDayPct) < 1){ verdict = 'correct'; correct++; }
      else if(nextDayPct < -1.5){ verdict = 'wrong'; wrong++; lesson = `建议持有但次日跌${nextDayPct}%`; }
      else if(nextDayPct > 2){ verdict = 'neutral'; neutral++; lesson = `持有中涨${nextDayPct}%，未建议加仓`; }
      else { verdict = 'neutral'; neutral++; }
    }

    // 计算假设收益: buy→次日涨幅, sell→-次日涨幅, hold→0
    const hypotheticalRet = predAction === 'buy' ? nextDayPct : predAction === 'sell' ? -nextDayPct : 0;
    totalPredReturn += hypotheticalRet;
    countPred += (predAction !== 'hold') ? 1 : 0;

    results[code] = {
      name: pred.name,
      type: pred.type,
      predAction,
      predActionLabel: pred.actionLabel,
      predScore: pred.score,
      predAiVote: pred.aiVote,
      predRlVote: pred.rlVote,
      predBtVote: pred.btVote,
      prevDayPct: pred.gszzl,        // 预测当天的涨幅
      nextDayPct,                    // 次日实际涨幅
      verdict,
      lesson,
      hypotheticalRet: +hypotheticalRet.toFixed(2),
    };
  });

  const accuracy = total > 0 ? Math.round(correct / total * 100) : 0;
  const avgPredReturn = countPred > 0 ? +(totalPredReturn / countPred).toFixed(2) : 0;

  // HS300 作为基准
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300Pct = +(hs300?.pct || 0).toFixed(2);

  entry.verified = true;
  entry.verification = {
    verifyDate: today,
    results,
    accuracy,
    correctCount: correct,
    wrongCount: wrong,
    neutralCount: neutral,
    totalCount: total,
    avgPredReturn,
    hs300Pct,
    beatBenchmark: avgPredReturn > hs300Pct,
  };

  savePredictionTracker();
  console.log(`[预测追踪] 📊 验证完成: ${prevDay}预测 → ${today}验证, 准确率${accuracy}% (${correct}对/${wrong}错/${neutral}平)`);
  return entry;
}

/**
 * 获取追踪器汇总统计
 */
function getPredTrackerStats(){
  const verified = predictionTracker.filter(p => p.verified && p.verification);
  if(verified.length === 0) return null;

  let totalCorrect = 0, totalWrong = 0, totalNeutral = 0, totalCount = 0;
  let totalReturn = 0, returnDays = 0;
  let aiCorrect = 0, aiTotal = 0, rlCorrect = 0, rlTotal = 0, btCorrect = 0, btTotal = 0;
  const dailyAccuracies = [];

  verified.forEach(entry => {
    const v = entry.verification;
    totalCorrect += v.correctCount;
    totalWrong += v.wrongCount;
    totalNeutral += v.neutralCount;
    totalCount += v.totalCount;
    if(v.avgPredReturn !== 0){ totalReturn += v.avgPredReturn; returnDays++; }
    dailyAccuracies.push(v.accuracy);

    // 分引擎统计
    Object.entries(v.results).forEach(([code, r]) => {
      const snap = entry.holdings[code];
      if(!snap) return;
      const dir = r.nextDayPct > 0.3 ? 1 : r.nextDayPct < -0.3 ? -1 : 0;
      // AI
      const aiDir = snap.aiVote > 0 ? 1 : snap.aiVote < 0 ? -1 : 0;
      aiTotal++;
      if(aiDir === dir || (aiDir === 0 && Math.abs(r.nextDayPct) < 1)) aiCorrect++;
      // RL
      const rlDir = snap.rlVote > 0 ? 1 : snap.rlVote < 0 ? -1 : 0;
      rlTotal++;
      if(rlDir === dir || (rlDir === 0 && Math.abs(r.nextDayPct) < 1)) rlCorrect++;
      // BT
      const btDir = snap.btVote > 0 ? 1 : snap.btVote < 0 ? -1 : 0;
      btTotal++;
      if(btDir === dir || (btDir === 0 && Math.abs(r.nextDayPct) < 1)) btCorrect++;
    });
  });

  const overallAcc = totalCount > 0 ? Math.round(totalCorrect / totalCount * 100) : 0;
  const avgDailyAcc = dailyAccuracies.length > 0 ? Math.round(dailyAccuracies.reduce((s,v)=>s+v,0) / dailyAccuracies.length) : 0;
  const avgReturn = returnDays > 0 ? +(totalReturn / returnDays).toFixed(2) : 0;

  return {
    totalDays: verified.length,
    overallAccuracy: overallAcc,
    avgDailyAccuracy: avgDailyAcc,
    totalCorrect, totalWrong, totalNeutral, totalCount,
    avgReturn,
    aiAccuracy: aiTotal > 0 ? Math.round(aiCorrect / aiTotal * 100) : null,
    rlAccuracy: rlTotal > 0 ? Math.round(rlCorrect / rlTotal * 100) : null,
    btAccuracy: btTotal > 0 ? Math.round(btCorrect / btTotal * 100) : null,
    recentAccuracies: dailyAccuracies.slice(-10),
  };
}

/**
 * 渲染预测追踪 UI
 */
function renderPredictionTracker(){
  const container = document.getElementById('pred-tracker-container');
  if(!container) return;

  const stats = getPredTrackerStats();
  const today = todayStr();
  const todayEntry = predictionTracker.find(p => p.date === today);
  const latestVerified = [...predictionTracker].reverse().find(p => p.verified && p.verification);

  let html = '';

  // === 操作栏 ===
  html += `<div style="display:flex;gap:6px;align-items:center;margin-bottom:8px;flex-wrap:wrap">`;
 html += `<button onclick="snapshotPredictions(true)" style="padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:rgba(59,130,246,0.15);color:#60a5fa;font-size:11px;cursor:pointer"> 手动快照</button>`;
 html += `<button onclick="verifyAndRender()" style="padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:rgba(34,197,94,0.15);color:#4ade80;font-size:11px;cursor:pointer"> 手动验证</button>`;
 if(todayEntry) html += `<span style="font-size:10px;color:#4ade80"> 今日已记录 (${todayEntry.timestamp})</span>`;
  else html += `<span style="font-size:10px;color:var(--sub)">今日未记录 (14:50自动)</span>`;
  html += `</div>`;

  // === 汇总统计 ===
  if(stats){
    const accColor = stats.overallAccuracy >= 65 ? '#4ade80' : stats.overallAccuracy >= 45 ? '#fbbf24' : '#f87171';
    const retColor = stats.avgReturn >= 0 ? '#f87171' : '#4ade80';
    html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px">`;
    html += `<div style="text-align:center;padding:8px 4px;background:rgba(255,255,255,0.03);border-radius:8px">`;
    html += `<div style="font-size:20px;font-weight:800;color:${accColor}">${stats.overallAccuracy}%</div>`;
    html += `<div style="font-size:9px;color:var(--sub)">总准确率</div></div>`;
    html += `<div style="text-align:center;padding:8px 4px;background:rgba(255,255,255,0.03);border-radius:8px">`;
    html += `<div style="font-size:20px;font-weight:800;color:${retColor}">${stats.avgReturn >= 0?'+':''}${stats.avgReturn}%</div>`;
    html += `<div style="font-size:9px;color:var(--sub)">日均收益</div></div>`;
    html += `<div style="text-align:center;padding:8px 4px;background:rgba(255,255,255,0.03);border-radius:8px">`;
    html += `<div style="font-size:20px;font-weight:800;color:var(--text)">${stats.totalDays}</div>`;
    html += `<div style="font-size:9px;color:var(--sub)">追踪天数</div></div>`;
    html += `<div style="text-align:center;padding:8px 4px;background:rgba(255,255,255,0.03);border-radius:8px">`;
    html += `<div style="font-size:16px;font-weight:700;color:var(--text)">${stats.totalCorrect}<span style="font-size:10px;color:var(--sub)">/${stats.totalCount}</span></div>`;
    html += `<div style="font-size:9px;color:var(--sub)">正确/总数</div></div>`;
    html += `</div>`;

    // 三引擎分别准确率
    html += `<div style="display:flex;gap:6px;margin-bottom:10px">`;
 [{name:'AI', acc:stats.aiAccuracy}, {name:'RL', acc:stats.rlAccuracy}, {name:'BT', acc:stats.btAccuracy}].forEach(eng => {
      const c = eng.acc === null ? 'var(--sub)' : eng.acc >= 60 ? '#4ade80' : eng.acc >= 40 ? '#fbbf24' : '#f87171';
      html += `<div style="flex:1;text-align:center;padding:4px;background:rgba(255,255,255,0.03);border-radius:6px">`;
      html += `<span style="font-size:10px">${eng.name}</span> `;
      html += `<span style="font-size:13px;font-weight:700;color:${c}">${eng.acc !== null ? eng.acc+'%' : '--'}</span>`;
      html += `</div>`;
    });
    html += `</div>`;

    // 准确率趋势小图
    if(stats.recentAccuracies.length >= 2){
      html += renderAccuracyTrendChart(stats.recentAccuracies);
    }
  } else {
    html += `<div style="text-align:center;padding:16px;color:var(--sub);font-size:11px">暂无验证数据<br>每个交易日14:50自动记录，次日收盘后自动验证</div>`;
  }

  // === 最新验证详情 ===
  if(latestVerified){
    const v = latestVerified.verification;
    const accColor = v.accuracy >= 65 ? '#4ade80' : v.accuracy >= 45 ? '#fbbf24' : '#f87171';
    html += `<div style="margin-top:8px;padding:8px 10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid var(--border)">`;
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
 html += `<span style="font-size:11px;font-weight:600;color:var(--text)"> 最近验证: ${latestVerified.date} → ${v.verifyDate}</span>`;
    html += `<span style="font-size:12px;font-weight:700;color:${accColor}">${v.accuracy}%</span>`;
    html += `</div>`;

    // 逐基金结果
    const sortedResults = Object.entries(v.results).sort((a,b) => {
      const o = {wrong:0, correct:1, neutral:2};
      return (o[a[1].verdict]||2) - (o[b[1].verdict]||2);
    });
    sortedResults.forEach(([code, r]) => {
 const verdictIcon = r.verdict === 'correct' ? '' : r.verdict === 'wrong' ? '' : '';
 const predIcon = r.predAction === 'buy' ? '加仓' : r.predAction === 'sell' ? '减仓' : '持有';
      const actColor = r.nextDayPct >= 0 ? '#f87171' : '#4ade80';
      html += `<div style="display:flex;align-items:center;gap:4px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:10px">`;
      html += `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${r.name}</span>`;
      html += `<span style="min-width:50px;text-align:center">${predIcon}</span>`;
      html += `<span style="min-width:45px;text-align:right;color:${actColor};font-weight:600">${r.nextDayPct>=0?'+':''}${r.nextDayPct}%</span>`;
      html += `<span style="min-width:20px;text-align:center">${verdictIcon}</span>`;
      html += `</div>`;
      if(r.lesson){
 html += `<div style="font-size:9px;color:#f59e0b;padding:1px 0 3px 8px"> ${r.lesson}</div>`;
      }
    });

    // 假设收益 vs 基准
    if(v.avgPredReturn !== 0 || v.hs300Pct !== 0){
      const rColor = v.avgPredReturn >= 0 ? '#f87171' : '#4ade80';
      const hColor = v.hs300Pct >= 0 ? '#f87171' : '#4ade80';
      html += `<div style="display:flex;gap:8px;margin-top:6px;font-size:10px;color:var(--sub)">`;
      html += `<span>策略收益: <b style="color:${rColor}">${v.avgPredReturn>=0?'+':''}${v.avgPredReturn}%</b></span>`;
      html += `<span>沪深300: <b style="color:${hColor}">${v.hs300Pct>=0?'+':''}${v.hs300Pct}%</b></span>`;
 html += `<span>${v.beatBenchmark ? '跑赢' : '跑输'}基准</span>`;
      html += `</div>`;
    }
    html += `</div>`;
  }

  // === 历史记录(最近10条) ===
  const recentEntries = predictionTracker.slice().reverse().slice(0, 10);
  if(recentEntries.length > 0){
    html += `<div style="margin-top:10px">`;
 html += `<div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:4px;cursor:pointer" onclick="document.getElementById('pred-history-list').style.display=document.getElementById('pred-history-list').style.display==='none'?'':'none'"> 历史记录 (${predictionTracker.length}天) ▾</div>`;
    html += `<div id="pred-history-list" style="display:none">`;
    recentEntries.forEach(entry => {
      const isVerified = entry.verified && entry.verification;
      const acc = isVerified ? entry.verification.accuracy : null;
      const accColor = acc !== null ? (acc >= 65 ? '#4ade80' : acc >= 45 ? '#fbbf24' : '#f87171') : 'var(--sub)';
      const fundCount = Object.keys(entry.holdings).length;
      const buys = Object.values(entry.holdings).filter(h => h.action === 'buy').length;
      const sells = Object.values(entry.holdings).filter(h => h.action === 'sell').length;
      html += `<div style="display:flex;align-items:center;gap:4px;padding:5px 2px;border-bottom:1px solid var(--border);font-size:10px">`;
      html += `<span style="min-width:70px;color:var(--sub)">${entry.date}</span>`;
      html += `<span style="min-width:35px">${entry.timestamp}</span>`;
      html += `<span style="min-width:30px;font-weight:600">${entry.overallScore}</span>`;
      html += `<span style="min-width:50px;font-size:9px">${buys}买${sells}卖</span>`;
      html += `<span style="flex:1;text-align:right;font-weight:600;color:${accColor}">${isVerified ? acc+'%' : '⏳待验证'}</span>`;
      html += `</div>`;
    });
    html += `</div></div>`;
  }

  container.innerHTML = html;
}

/** 准确率趋势小图 */
function renderAccuracyTrendChart(accuracies){
  if(!accuracies || accuracies.length < 2) return '';
  const h = 40, w = 100;
  const max = 100, min = 0;
  let pts = '';
  for(let i = 0; i < accuracies.length; i++){
    const x = (i / (accuracies.length - 1)) * w;
    const y = h - (accuracies[i] / 100) * h;
    pts += `${x.toFixed(1)},${y.toFixed(1)} `;
  }
  // 50% baseline
  const baseY = h * 0.5;
  let s = `<div style="position:relative;height:${h+8}px;margin-bottom:6px">`;
  s += `<svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s += `<line x1="0" y1="${baseY}" x2="${w}" y2="${baseY}" stroke="rgba(255,255,255,0.1)" stroke-dasharray="2,2"/>`;
  s += `<defs><linearGradient id="accGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#4ade80" stop-opacity="0.2"/><stop offset="100%" stop-color="#4ade80" stop-opacity="0.02"/></linearGradient></defs>`;
  s += `<polygon points="0,${h+2} ${pts.trim()} ${w},${h+2}" fill="url(#accGrad)"/>`;
  s += `<polyline points="${pts.trim()}" fill="none" stroke="#4ade80" stroke-width="1.5"/>`;
  // dots
  for(let i = 0; i < accuracies.length; i++){
    const x = (i / (accuracies.length - 1)) * w;
    const y = h - (accuracies[i] / 100) * h;
    const c = accuracies[i] >= 60 ? '#4ade80' : accuracies[i] >= 40 ? '#fbbf24' : '#f87171';
    s += `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="2" fill="${c}"/>`;
  }
  s += `</svg>`;
  s += `<div style="position:absolute;top:1px;left:4px;font-size:8px;color:var(--sub)">准确率趋势</div>`;
  s += `<div style="position:absolute;bottom:1px;right:4px;font-size:8px;color:#4ade80">${accuracies[accuracies.length-1]}%</div>`;
  s += `</div>`;
  return s;
}

/** 手动验证 + 渲染 */
function verifyAndRender(){
  const result = verifyPredictions();
  renderPredictionTracker();
  if(result) alert(`验证完成: ${result.date}预测 → 准确率${result.verification.accuracy}%`);
  else alert('没有需要验证的记录 (需要前一交易日有快照 + 今日为交易日)');
}

/** 14:50 自动快照检查 (由30s定时器调用) */
function checkAutoSnapshot(){
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const today = todayStr();

  // 仅在交易日14:49~14:52之间自动快照
  if(!isTradingDay(today)) return;
  if(h !== 14 || m < 49 || m > 52) return;
  if(_predSnapshotDoneToday) return;
  if(predictionTracker.find(p => p.date === today)) return;
  if(holdings.length === 0) return;

  console.log('[预测追踪] ⏰ 14:50 自动快照触发');
  snapshotPredictions(false);
  renderPredictionTracker();
}

/** 自动验证检查 (页面加载 + 定时器14:55后调用) */
function checkAutoVerify(){
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const today = todayStr();

  if(!isTradingDay(today)) return;
  // 14:55后 (收盘前或收盘后) 进行验证
  if(h * 60 + m < 895) return; // 14:55 = 895

  const prevDay = getPrevTradingDay(today);
  if(!prevDay) return;
  const entry = predictionTracker.find(p => p.date === prevDay && !p.verified);
  if(!entry) return;

  console.log(`[预测追踪] 🔄 自动验证: ${prevDay} → ${today}`);
  verifyPredictions();
  renderPredictionTracker();
}

// ==================== DAILY REVIEW SYSTEM ====================
// 保存今日AI预测快照
function saveTodayPredictions(){
  if(!_analysisResult || !_analysisResult.signals) return;
  const today = todayStr();

  // 记录今日每只基金的预估涨跌 + 预测信号
  const pnl = {};
  const predictions = {};
  const allCodes = [...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)];
  allCodes.forEach(code=>{
    const f = getFundData(code);
    pnl[code] = +(f.gszzl||0).toFixed(2);
    const sig = _analysisResult.signals[code];
    if(sig){
      predictions[code] = {
        action: sig.action,
        confidence: sig.confidence,
        trend: sig.trend,
        reason: (sig.reason||'').slice(0,80),
        posType: sig.posType||''
      };
    }
  });

  // 持仓平均盈亏
  let avgPnl = 0;
  if(holdings.length>0){
    holdings.forEach(h=>{ avgPnl += (pnl[h.code]||0); });
    avgPnl = +(avgPnl/holdings.length).toFixed(2);
  }

  // 沪深300
  const hs300 = getIndexData(INDICES_CONFIG[3]);

  // 更新或新增今日记录
  const idx = dailyLog.findIndex(d=>d.date===today);
  const entry = {
    date: today,
    predictions,
    pnl,
    avgPnl,
    hs300Pct: +(hs300.pct||0).toFixed(2),
    holdingCodes: holdings.map(h=>h.code),
    watchCodes: watchlist.map(w=>w.code),
    timestamp: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})
  };
  if(idx>=0) dailyLog[idx] = entry;
  else dailyLog.push(entry);

  saveDailyLog();
}

// 生成每日复盘（将昨天的预测与今日实际表现对比）
function generateDailyReview(){
  const today = todayStr();
  if(!isTradingDay(today)) return null;

  // 优先使用前一交易日记录；若缺失则回退到最近有记录日
  const prevDay = getPrevTradingDay(today);
  const pastEntries = dailyLog.filter(d=>d.date < today && d.predictions && Object.keys(d.predictions).length>0);
  if(pastEntries.length===0) return null;

  let yesterday = prevDay ? dailyLog.find(d => d.date === prevDay && d.predictions && Object.keys(d.predictions).length>0) : null;
  if(!yesterday){
    yesterday = pastEntries.slice().sort((a,b)=>a.date.localeCompare(b.date)).pop();
  }
  if(!yesterday) return null;

  // 今日实际盈亏（用live数据）
  const reviews = [];
  Object.keys(yesterday.predictions).forEach(code=>{
    const pred = yesterday.predictions[code];
    const todayData = getFundData(code);
    if(!todayData || todayData._noData) return;
    const actualPct = +(todayData?.gszzl||0).toFixed(2);

    // 预测是否正确
    let verdict = 'neutral'; // correct / wrong / neutral
    let lesson = '';
    if(pred.action==='buy'){
      if(actualPct > 0){ verdict='correct'; }
      else if(actualPct < -0.5){ verdict='wrong'; lesson=`建议买入但今日跌${actualPct}%，可能低吸时机未到或趋势判断需修正`; }
      else { verdict='neutral'; }
    } else if(pred.action==='sell'){
      if(actualPct < 0){ verdict='correct'; }
      else if(actualPct > 0.5){ verdict='wrong'; lesson=`建议减仓但今日涨${actualPct}%，可能过早离场错失收益`; }
      else { verdict='neutral'; }
    } else { // hold
      if(Math.abs(actualPct) < 1){ verdict='correct'; }
      else if(actualPct < -1.5){ verdict='wrong'; lesson=`建议持有但今日跌${actualPct}%，未及时止损或未识别风险信号`; }
      else if(actualPct > 2){ verdict='neutral'; lesson=`建议持有，今日涨${actualPct}%，但未建议加仓可能错失波段机会`; }
    }

    reviews.push({
      code,
      name: fundName(code),
      predAction: pred.action,
      predConfidence: pred.confidence,
      predReason: pred.reason,
      actualPct,
      verdict,
      lesson
    });
  });

  if(reviews.length===0) return null;

  // 汇总
  const correct = reviews.filter(r=>r.verdict==='correct').length;
  const wrong = reviews.filter(r=>r.verdict==='wrong').length;
  const total = reviews.length;
  const accuracy = total>0 ? Math.round(correct/total*100) : 0;

  // 昨日持仓平均
  const yesterdayAvg = yesterday.avgPnl||0;

  return {
    reviewDate: yesterday.date,
    todayDate: today,
    reviews,
    accuracy,
    correct,wrong,total,
    yesterdayAvg,
    yesterdayHs300: yesterday.hs300Pct||0
  };
}

// 构建复盘上下文（注入AI prompt）
function buildReviewContext(){
  const review = generateDailyReview();
  if(!review || review.reviews.length===0) return '';

  let ctx = `\n【历史复盘教训 - 请从过去的判断失误中学习】\n`;
  ctx += `上次分析日期:${review.reviewDate} → 今日验证:${review.todayDate}\n`;
  ctx += `预测准确率: ${review.accuracy}% (${review.correct}对/${review.wrong}错/${review.total}总)\n`;

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  if(wrongOnes.length>0){
 ctx += `\n 判断失误需反思：\n`;
    wrongOnes.forEach(r=>{
      ctx += `- ${r.name}(${r.code}): 预测${r.predAction==='buy'?'买入':r.predAction==='sell'?'减仓':'持有'} → 实际${r.actualPct>0?'+':''}${r.actualPct}%`;
      if(r.lesson) ctx += ` | 教训:${r.lesson}`;
      ctx += `\n`;
    });
    ctx += `请在今日分析中特别注意这些失误的同类型基金，避免重复犯错。\n`;
  }

  const correctOnes = review.reviews.filter(r=>r.verdict==='correct');
  if(correctOnes.length>0){
 ctx += `\n 判断正确的经验：\n`;
    correctOnes.slice(0,3).forEach(r=>{
 ctx += `- ${r.name}: 预测${r.predAction==='buy'?'买入':r.predAction==='sell'?'减仓':'持有'} → 实际${r.actualPct>0?'+':''}${r.actualPct}% \n`;
    });
  }

  // 加入最近几天的盈亏趋势
  const recent = dailyLog.slice(-5).filter(d=>d.avgPnl!==undefined);
  if(recent.length>=2){
    ctx += `\n【近期持仓盈亏走势】\n`;
    recent.forEach(d=>{
      ctx += `${d.date}: 持仓平均${d.avgPnl>0?'+':''}${d.avgPnl}% | 沪深300 ${d.hs300Pct>0?'+':''}${d.hs300Pct}%\n`;
    });
  }

  return ctx;
}

// 渲染复盘UI
function renderReview(){
  const section = document.getElementById('review-section');
  const container = document.getElementById('review-container');
  const histToggle = document.getElementById('review-history-toggle');

  const review = generateDailyReview();

  if(!review || review.reviews.length===0){
    section.style.display = 'none';
    return;
  }
  section.style.display = '';

  const wrongOnes = review.reviews.filter(r=>r.verdict==='wrong');
  const accColor = review.accuracy>=70?'var(--green)':review.accuracy>=40?'var(--yellow)':'var(--red)';

  let html = `<div class="review-card">
    <div class="review-header">
 <div class="review-date"> ${review.reviewDate} → 今日验证</div>
      <div class="review-pnl" style="color:${review.yesterdayAvg>=0?'var(--red)':'var(--green)'}">${review.yesterdayAvg>=0?'+':''}${review.yesterdayAvg}%</div>
    </div>
    <div class="review-stats">
      <div class="review-stat"><span class="review-stat-label">准确率</span><span class="review-stat-val" style="color:${accColor}">${review.accuracy}%</span></div>
 <div class="review-stat"><span class="review-stat-label">正确</span><span class="review-stat-val" style="color:var(--green)">${review.correct}</span></div>
 <div class="review-stat"><span class="review-stat-label">失误</span><span class="review-stat-val" style="color:var(--red)">${review.wrong}</span></div>
      <div class="review-stat"><span class="review-stat-label">总数</span><span class="review-stat-val">${review.total}</span></div>
    </div>`;

  // 展示每只基金的验证结果
  html += `<div class="review-items">`;
  // 先显示错误的（重点关注）
  [...wrongOnes, ...review.reviews.filter(r=>r.verdict!=='wrong')].forEach(r=>{
    const predText = r.predAction==='buy'?'加仓':r.predAction==='sell'?'减仓':'持有';
 const verdictText = r.verdict==='correct'?'对':r.verdict==='wrong'?'错':'—';
    const verdictClass = r.verdict;
    html += `<div class="review-item">
      <span class="review-fund-name">${r.name}</span>
      <span class="review-pred ${r.predAction}">${predText}</span>
      <span class="review-actual" style="color:${r.actualPct>=0?'var(--red)':'var(--green)'}">${r.actualPct>=0?'+':''}${r.actualPct}%</span>
      <span class="review-verdict ${verdictClass}">${verdictText}</span>
    </div>`;
  });
  html += `</div>`;

  // 失误教训
  if(wrongOnes.length>0){
    const lessons = wrongOnes.filter(r=>r.lesson).map(r=>`• ${r.name}: ${r.lesson}`).join('<br>');
    if(lessons){
 html += `<div class="review-lesson"> <b>教训总结</b><br>${lessons}</div>`;
    }
  }

  html += `</div>`;
  container.innerHTML = html;

  // 历史记录
  if(dailyLog.length>1){
    histToggle.style.display = '';
  }
}

function toggleReviewHistory(){
  const histEl = document.getElementById('review-history');
  if(histEl.style.display==='none'){
    histEl.style.display = '';
    renderReviewHistory();
  } else {
    histEl.style.display = 'none';
  }
}

function renderReviewHistory(){
  const histEl = document.getElementById('review-history');
  const entries = dailyLog.slice().reverse().slice(0,10);
  if(entries.length===0){ histEl.innerHTML='<div style="text-align:center;font-size:11px;color:var(--sub);padding:12px">暂无历史记录</div>'; return; }

  let html = '';
  entries.forEach(entry=>{
    const holdPnlColor = entry.avgPnl>=0?'var(--red)':'var(--green)';
    const beatHs300 = entry.avgPnl > entry.hs300Pct;
    const predCount = Object.keys(entry.predictions||{}).length;
    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid var(--border);font-size:12px">
      <span style="color:var(--sub);min-width:80px">${entry.date}</span>
      <span style="font-weight:700;color:${holdPnlColor}">${entry.avgPnl>=0?'+':''}${entry.avgPnl}%</span>
      <span style="font-size:10px;color:var(--sub)">沪深300 ${entry.hs300Pct>=0?'+':''}${entry.hs300Pct}%</span>
      <span style="font-size:10px;padding:1px 6px;border-radius:4px;${beatHs300?'background:#ecfdf5;color:#16a34a':'background:#fef2f2;color:#dc2626'}">${beatHs300?'跑赢':'跑输'}</span>
      <span style="font-size:10px;color:var(--sub)">${predCount}只</span>
      <span style="font-size:10px;color:var(--sub)">${entry.timestamp||''}</span>
    </div>`;
  });
  histEl.innerHTML = `<div style="background:var(--card);border-radius:var(--radius);padding:10px 14px;margin-top:4px;box-shadow:var(--shadow)">
 <div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--text)"> 最近盈亏记录</div>
    ${html}
  </div>`;
}

// ==================== SIMULATION PORTFOLIO ====================
function saveSimPortfolio(){ localStorage.setItem('fa_sim_portfolio', JSON.stringify(simPortfolio)); }

function initSimPortfolio(){
  if(simPortfolio && simPortfolio.positions && simPortfolio.positions.length > 0) return;
  // 需要有真实持仓才能初始化
  if(holdings.length === 0){
    simPortfolio = null;
    return;
  }
  buildSimFromHoldings();
}

function buildSimFromHoldings(){
  const today = todayStr();
  simPortfolio = {
    cash: 0, totalCapital: SIM_INITIAL_CAPITAL,
    positions: [], history: [], dailySnapshots: [],
    strategy: {
      coreRatio: 0.6, satRatio: 0.4,
      maxSinglePos: 0.25,
      stopLoss: -8, takeProfit: 20,
      dipBuyThreshold: -1.5, surgeSellThreshold: 3,
      rebalanceDays: 15,
    },
    created: today, targetMonthlyReturn: SIM_TARGET_MONTHLY,
    syncSource: 'holdings', // 标记来源
    learningLog: [],
  };

  // 根据用户持仓等权分配资金
  const n = holdings.length;
  const perFundPct = Math.floor(90 / n); // 90%分配，10%留现金
  let usedCash = 0;
  let hasRealData = false;
  const CORE_TYPES = new Set(['宽基','黄金','红利','债券']);

  holdings.forEach((h, i) => {
    // 最后一只基金把剩余90%全给
    const pct = (i === n-1) ? (90 - perFundPct * (n-1)) : perFundPct;
    const amount = Math.round(SIM_INITIAL_CAPITAL * pct / 100);
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const fd = getFundData(h.code);
    let nav;
    if(fd?._live){
      nav = fd.dwjz || fd.gsz;
      hasRealData = true;
    } else if(fd?._histFallback){
      nav = fd.dwjz;
      hasRealData = true;
    } else {
      nav = fd?.dwjz || 1.0;
    }
    const shares = Math.floor(netAmount / nav * 100) / 100;
    const group = CORE_TYPES.has(h.type) ? 'core' : 'satellite';
    simPortfolio.positions.push({
      code:h.code, name:h.name||fundName(h.code)||h.code, type:h.type||'其他', group,
      shares, avgCost:nav, buyDate:today, targetPct:pct, investedAmount:amount,
      initNavSource: fd?._live ? 'live' : fd?._histFallback ? 'history' : 'fallback',
    });
    simPortfolio.history.push({
      date:today, action:'buy', code:h.code, name:h.name||h.code,
      amount, shares, nav, fee,
      reason:`从持仓同步·${group==='core'?'核心':'卫星'} ${pct}%配比${fd?._live?' (实时)':fd?._histFallback?' (历史)':' (待校准)'}`
    });
    usedCash += amount;
  });
  simPortfolio.cash = SIM_INITIAL_CAPITAL - usedCash;
  simPortfolio.dataQuality = hasRealData ? 'real' : 'pending';
  saveSimPortfolio();
}

function getSimNav(code){
  // 收盘后优先用dwjz(确认净值)，盘中用gsz(估算净值)
  const fd = getFundData(code);
  if(!fd) return null;
  const ms = getMarketStatus();
  if(ms.status==='open' || ms.status==='break'){
    return fd.gsz || fd.dwjz; // 盘中用估算
  }
  return fd.dwjz || fd.gsz; // 收盘用确认净值
}

function getSimTotalValue(){
  if(!simPortfolio) return SIM_INITIAL_CAPITAL;
  let total = simPortfolio.cash;
  simPortfolio.positions.forEach(pos => {
    const nav = getSimNav(pos.code) || pos.avgCost;
    total += pos.shares * nav;
  });
  return total;
}

function updateSimDaily(){
  if(!simPortfolio || !simPortfolio.positions) return;
  const today = todayStr();
  // 只在交易日更新快照
  if(!isTradingDay(today)) return;

  // 检查是否有真实数据可用（至少有一个position有live数据）
  let liveCount = 0;
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    if(fd?._live) liveCount++;
  });

  // 如果已存在今日快照，只有当新数据质量更好时才更新
  const existingIdx = simPortfolio.dailySnapshots.findIndex(s => s.date === today);
  if(existingIdx >= 0 && liveCount <= (simPortfolio.dailySnapshots[existingIdx].liveDataCount||0)){
    return; // 现有数据质量已经更好或相同，跳过
  }

  let positionValue = 0;
  const posDetails = [];
  simPortfolio.positions.forEach(pos => {
    const fd = getFundData(pos.code);
    const nav = getSimNav(pos.code) || pos.avgCost;
    const currentValue = pos.shares * nav;
    const pnl = currentValue - pos.investedAmount;
    const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
    positionValue += currentValue;
    posDetails.push({
      code:pos.code, nav:+nav.toFixed(4), value:Math.round(currentValue),
      pnl:Math.round(pnl), pnlPct:+pnlPct.toFixed(2),
      todayPct:+(fd?.gszzl||0).toFixed(2),
      isLive: !!(fd?._live),
    });
  });

  const totalValue = positionValue + simPortfolio.cash;
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  // 取前一天（非今天）的快照计算日回报
  const prevSnapshots = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const prevSnapshot = prevSnapshots.length > 0 ? prevSnapshots[prevSnapshots.length - 1] : null;
  const prevTotal = prevSnapshot ? prevSnapshot.totalValue : SIM_INITIAL_CAPITAL;
  const dailyReturn = (totalValue - prevTotal) / prevTotal * 100;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300Price = parseFloat(hs300.price) || 0;
  // 基准：取第一天有效记录的hs300价格
  const allSnaps = simPortfolio.dailySnapshots.filter(s => s.date !== today);
  const hs300Base = allSnaps.length > 0 ? allSnaps[0].hs300Base : hs300Price;
  const hs300CumPct = hs300Base > 0 ? (hs300Price / hs300Base - 1) * 100 : 0;

  const snapshot = {
    date:today, totalValue:Math.round(totalValue), cash:Math.round(simPortfolio.cash),
    positionValue:Math.round(positionValue), dailyReturn:+dailyReturn.toFixed(2),
    cumReturn:+cumReturn.toFixed(2), hs300Pct:+(hs300.pct||0).toFixed(2),
    hs300CumReturn:+hs300CumPct.toFixed(2), hs300Base, hs300Price,
    positions:posDetails, liveDataCount:liveCount,
    updatedAt: new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
  };

  if(existingIdx >= 0){
    simPortfolio.dailySnapshots[existingIdx] = snapshot; // 更新为更好的数据
  } else {
    simPortfolio.dailySnapshots.push(snapshot);
  }
  if(simPortfolio.dailySnapshots.length > 60) simPortfolio.dailySnapshots = simPortfolio.dailySnapshots.slice(-60);
  saveSimPortfolio();
}

function simTrade(code, action, amountOrPct, reason){
  if(!simPortfolio) return;
  const today = todayStr();
  const fd = getFundData(code);
  // 只用有真实数据的净值进行交易
  if(!fd?._live && !fd?._histFallback){
    console.warn(`simTrade: ${code} 无真实数据，跳过交易`);
    return;
  }
  const nav = getSimNav(code) || fd?.gsz || fd?.dwjz || 1.0;
  const pos = simPortfolio.positions.find(p => p.code === code);

  if(action === 'buy'){
    const amount = (typeof amountOrPct==='number' && amountOrPct < 1) ? Math.round(getSimTotalValue() * amountOrPct) : amountOrPct;
    if(amount > simPortfolio.cash || amount < 100) return;
    const fee = Math.round(amount * SIM_FEE_RATE);
    const netAmount = amount - fee;
    const newShares = Math.floor(netAmount / nav * 100) / 100;
    if(pos){
      const totalInvested = pos.investedAmount + amount;
      pos.shares += newShares;
      pos.avgCost = totalInvested / pos.shares;
      pos.investedAmount = totalInvested;
    } else {
      const known = FUND_DB.find(f=>f.code===code) || RECO_FUND_POOL.find(f=>f.code===code);
      simPortfolio.positions.push({
        code, name:known?.name||fd?.name||code, type:known?.type||'其他', group:'satellite',
        shares:newShares, avgCost:nav, buyDate:today, targetPct:0, investedAmount:amount,
      });
    }
    simPortfolio.cash -= amount;
    simPortfolio.history.push({date:today, action:'buy', code, name:pos?.name||code, amount, shares:newShares, nav, fee, reason});

  } else if(action === 'sell' && pos){
    const sellPct = (typeof amountOrPct==='number' && amountOrPct <= 1) ? amountOrPct : 0.5;
    const sellShares = Math.floor(pos.shares * sellPct * 100) / 100;
    if(sellShares < 0.01) return;
    const sellValue = Math.round(sellShares * nav);
    const fee = Math.round(sellValue * SIM_FEE_RATE * 0.5);
    pos.shares -= sellShares;
    pos.investedAmount = Math.round(pos.investedAmount * (1 - sellPct));
    simPortfolio.cash += (sellValue - fee);
    if(pos.shares < 0.01) simPortfolio.positions = simPortfolio.positions.filter(p => p.code !== code);
    simPortfolio.history.push({date:today, action:'sell', code, name:pos.name, amount:sellValue, shares:sellShares, nav, fee, reason});
  }
  saveSimPortfolio();
}

function simAutoTrade(){
  if(!simPortfolio || !_analysisResult) return 0;
  // 只在交易日交易时段执行
  const ms = getMarketStatus();
  if(ms.status!=='open' && ms.status!=='break' && ms.status!=='closed') return 0;
  if(!isTradingDay()) return 0;
  const strategy = simPortfolio.strategy;
  let tradesExecuted = 0;

  // 数据情报信号系数: 根据宏观+资金+舆情调节交易激进度
  const dataSignal = _dataIntelLoaded ? generateDataSignal() : { score:50 };
  const dsScore = dataSignal.score; // 0-100, 50=中性
  // buyMult: 1.0(中性), 0.5(熊市)~1.5(牛市)
  const buyMult = 0.5 + dsScore / 100;
  // sellMult: 反向, 熊市卖更多
  const sellMult = 1.5 - dsScore / 100;
  // 信心门槛调节: 牛市降低买入门槛，熊市提高
  const confAdj = Math.round((50 - dsScore) * 0.15); // ±7.5

  // 1. 止盈止损检查（数据信号影响止损幅度）
  const dynStopLoss = strategy.stopLoss + (dsScore < 40 ? 1 : dsScore > 60 ? -1 : 0);
  const dynTakeProfit = strategy.takeProfit + (dsScore > 65 ? 3 : dsScore < 35 ? -2 : 0);

  [...simPortfolio.positions].forEach(pos => {
    const fd = getFundData(pos.code);
    if(!fd?._live && !fd?._histFallback) return;
    const nav = getSimNav(pos.code) || pos.avgCost;
    const pnlPct = (nav - pos.avgCost) / pos.avgCost * 100;
    if(pnlPct <= dynStopLoss && pos.group === 'satellite'){
      const sellPct = Math.min(0.9, 0.7 * sellMult);
 simTrade(pos.code, 'sell', sellPct, `止损: 亏${pnlPct.toFixed(1)}%超线${dynStopLoss}% [数据信号${dsScore}]`);
      tradesExecuted++;
    }
    if(pnlPct >= dynTakeProfit && pos.group === 'satellite'){
      const sellPct = Math.min(0.6, 0.4 * sellMult);
 simTrade(pos.code, 'sell', sellPct, `止盈: 赚${pnlPct.toFixed(1)}%达${dynTakeProfit}% [数据信号${dsScore}]`);
      tradesExecuted++;
    }
  });

  // 2. 三引擎投票共识交易系统（AI + RL + Backtest）
  const buyConfThreshold = Math.max(50, 65 + confAdj);
  const sellConfThreshold = Math.max(45, 60 + confAdj);

  simPortfolio.positions.forEach(pos => {
    const sig = _analysisResult.signals[pos.code];
    if(!sig) return;
    const fd = getFundData(pos.code);
    if(!fd?._live) return;
    const todayPct = fd?.gszzl || 0;

    // 检查该板块的资金流向
    const posType = pos.type || '';
    const sectorFlow = sectorCapFlow.find(s => posType && (s.name.includes(posType) || posType.includes(s.name)));
    const sectorBullish = sectorFlow && sectorFlow.mainNet > 0;
    const sectorBearish = sectorFlow && sectorFlow.mainNet < -1e8;

    // === 使用共享三引擎投票核心 ===
    const triVote = computeTriEngineVote(pos.code, sig, _rlSignals[pos.code], btResults[pos.code]);
    const { score: consensusScore, consensusMult, buyVotes, sellVotes } = triVote;
    const unanimousBuy = buyVotes >= 2 && sellVotes === 0;
    const unanimousSell = sellVotes >= 2 && buyVotes === 0;
    const effConf = triVote.effConf;

    const rlSig = _rlSignals[pos.code];
    const btR = btResults[pos.code];
    const rlTag = rlSig ? ` RL:${rlSig.actionName}${rlSig.confidence}%${rlSig.conviction?'('+rlSig.conviction+')':''}` : '';
    const btTag = btR ? ` BT:${btR.sharpe>0?'▲':'▼'}${btR.sharpe.toFixed(1)}` : '';
    const voteTag = ` 投票[${buyVotes}买/${sellVotes}卖]×${consensusMult.toFixed(1)}`;

    if(sig.action==='buy' && effConf>=buyConfThreshold && todayPct<=strategy.dipBuyThreshold){
      const posValue = pos.shares * (getSimNav(pos.code) || pos.avgCost);
      const totalValue = getSimTotalValue();
      if(posValue / totalValue < strategy.maxSinglePos){
        const kellyLimit = btR?.finalKelly || 0.05;
        let addPct = Math.min(0.03 * buyMult * consensusMult, kellyLimit);
        if(sectorBullish) addPct *= 1.3;
        if(unanimousBuy) addPct *= 1.2;
        // RL高确信度额外加成
        if(rlSig?.conviction === '强' && rlSig?.action === 1) addPct *= 1.15;
        // 回测Sharpe过滤
        if(btR && btR.sharpe < 0) addPct = 0;
        const addAmt = Math.min(Math.round(totalValue * addPct), Math.round(simPortfolio.cash * 0.3));
        if(addAmt >= 1000){
          const kellyTag = btR ? ` K:${(kellyLimit*100).toFixed(0)}%` : '';
          const reason = `AI加仓(${sig.confidence}%)+跌${todayPct.toFixed(1)}%低吸 [${voteTag} 数据${dsScore}${sectorBullish?' 板块流入':''}${rlTag}${btTag}${kellyTag}]`;
          simTrade(pos.code, 'buy', addAmt, reason);
          tradesExecuted++;
        }
      }
    }

    if(sig.action==='sell' && effConf>=sellConfThreshold && todayPct>=strategy.surgeSellThreshold && pos.group==='satellite'){
      let sellPct = 0.3 * sellMult * consensusMult;
      if(sectorBearish) sellPct = Math.min(0.5, sellPct * 1.3);
      if(unanimousSell) sellPct = Math.min(0.7, sellPct * 1.3);
      // RL高确信卖出加码
      if(rlSig?.conviction === '强' && rlSig?.action === 2) sellPct = Math.min(0.8, sellPct * 1.2);
      sellPct = Math.max(0.1, Math.min(0.8, sellPct));
      simTrade(pos.code, 'sell', sellPct, `AI减仓(${sig.confidence}%)+涨${todayPct.toFixed(1)}% [${voteTag} 数据${dsScore}${sectorBearish?' 板块流出':''}${rlTag}${btTag}]`);
      tradesExecuted++;
    }
  });

  // 3. AI新推荐品种（三引擎共识过滤）
  if(_analysisResult.picks && simPortfolio.cash > 20000 && dsScore >= 40){
    const minEndorsements = dsScore >= 60 ? 1 : 2;
    _analysisResult.picks.forEach(pick => {
      if(simPortfolio.positions.find(p => p.code === pick.code)) return;
      // 回测过滤: 如果回测Sharpe<0且收益为负，跳过
      const pickBT = btResults[pick.code];
      if(pickBT && pickBT.sharpe < 0 && pickBT.totalReturn < 0) return;
      // RL过滤: 如果RL强烈看空(卖出且>60%置信)，跳过
      const pickRL = _rlSignals[pick.code];
      if(pickRL && pickRL.action === 2 && pickRL.confidence > 60) return;
      // 三引擎新品种投票
      const pickAiVote = 1; // AI推荐=看多
      const pickRlVote = pickRL ? (pickRL.action===1 ? 1 : pickRL.action===2 ? -1 : 0) : 0;
      const pickBtVote = (pickBT && pickBT.sharpe > 0 && pickBT.lastRSI < 60) ? 1 :
                         (pickBT && pickBT.sharpe < 0) ? -1 : 0;
      const pickBuyVotes = [pickAiVote, pickRlVote, pickBtVote].filter(v=>v>0).length;
      const pickSellVotes = [pickAiVote, pickRlVote, pickBtVote].filter(v=>v<0).length;
      const pickConsensusMult = pickBuyVotes >= 3 ? 1.4 : pickBuyVotes >= 2 ? 1.1 :
                                pickSellVotes > 0 ? 0.5 : 0.8;

      if(pick.endorsements >= minEndorsements){
        // Kelly仓位: 用回测Kelly × 共识系数
        const pickKelly = pickBT?.finalKelly || 0.1;
        const basePct = Math.min(dsScore >= 60 ? 0.18 : 0.12, pickKelly * 1.5) * pickConsensusMult;
        const amount = Math.min(Math.round(simPortfolio.cash * basePct), 25000);
        if(amount >= 5000){
          const kTag = pickBT ? ` Sharpe:${pickBT.sharpe.toFixed(1)} Kelly:${(pickKelly*100).toFixed(0)}%` : '';
          const rlTag2 = pickRL ? ` RL:${pickRL.action===1?'买':pickRL.action===2?'卖':'持'}${pickRL.confidence}%` : '';
          simTrade(pick.code, 'buy', amount, `AI推荐(${pick.endorsements}引擎) [投票${pickBuyVotes}买×${pickConsensusMult.toFixed(1)} 数据${dsScore}${kTag}${rlTag2}]: ${(pick.reason||'').slice(0,30)}`);
          tradesExecuted++;
        }
      }
    });
  }

  // 4. 策略学习
  learnFromPerformance();
  // 5. RL在线学习反馈：用模拟盘交易结果进行增量训练
  if(tradesExecuted > 0) rlOnlineLearning();
  // 6. 结算延迟奖励：检查前几天的pending交易，用实际多日收益做RL更新
  settleDelayedRewards();
  // 7. 更新引擎准确率追踪 + 重新检测市场Regime
  updateEngineAccuracy();
  detectMarketRegime();
  saveSimPortfolio();
  return tradesExecuted;
}

// ==================== RL在线学习 (Online Learning from Sim Trades) ====================
function rlOnlineLearning(){
  if(!_rlModelLoaded || !rlTrainer?.agent || !simPortfolio?.history) return;
  const today = todayStr();
  const todayTrades = simPortfolio.history.filter(h => h.date === today);
  if(!todayTrades.length) return;

  let onlineReplayCount = 0;
  for(const trade of todayTrades){
    const code = trade.code;
    const hd = fundHistoryData[code];
    if(!hd?.navs || hd.navs.length < 65) continue;
    const navArr = hd.navs.map(n=>({date:n.date||n[0],nav:parseFloat(n.nav!==undefined?n.nav:n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
    if(navArr.length < 65) continue;

    // 构建当前状态
    const env = new MarketEnv(navArr, code);
    env.idx = navArr.length - 1;
    const simPos = simPortfolio.positions.find(p => p.code === code);
    env.pos = simPos ? 1 : 0;
    if(simPos) env.entryPrice = simPos.avgCost;
    const state = env._state();
    // 注入宏观/舆情/资金流/国际 (36维状态: indices 23-26)
    if(_dataIntelLoaded){
      const ds = generateDataSignal();
      state[23] = rlClip((ds.score-50)/25, -2, 2);
      state[24] = rlClip((newsSentiment.score-50)/25, -2, 2);
      const cn = sectorCapFlow.reduce((s,d)=>s+(d.mainNet||0), 0);
      state[25] = rlClip(cn/1e10, -2, 2);
      if(typeof globalNews!=='undefined'&&globalNews.length>0){
        const gSent=typeof getGlobalNewsSentiment==='function'?getGlobalNewsSentiment():{score:50};
        state[26]=rlClip((gSent.score-50)/25,-2,2);
      }
    }
    // Inject portfolio features [36-39]
    const _pR2=getPortfolioRiskMetrics();
    state[36]=rlClip(_pR2.dd*10,-5,0);
    state[37]=rlClip(_pR2.cashRatio,0,1);
    state[38]=rlClip(_pR2.hhi*4,0,2);
    state[39]=rlClip((_pR2.fundWeight[code]||0)*4,0,2);

    // 映射交易动作到RL action
    const action = trade.action === 'buy' ? 1 : trade.action === 'sell' ? 2 : 0;

    // === 即时小奖励(方向性) + 登记延迟奖励 ===
    let reward = 0;
    const fd = getFundData(code);
    const todayPct = (fd?.gszzl || 0) / 100;
    // 即时奖励: 较小的方向信号(最终奖励由延迟结算给出)
    if(action === 1) reward = todayPct > 0 ? todayPct * 2 : todayPct * 3;
    else if(action === 2) reward = todayPct < 0 ? Math.abs(todayPct) * 2 : -todayPct * 1.5;
    // 组合级奖励
    const totalValue = getSimTotalValue();
    const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL;
    reward += rlClip(cumReturn * 1, -0.3, 0.3);

    // 注册延迟奖励(3天后结算真实多日回报)
    const pendingKey = `${code}_${today}_${action}`;
    _rlPendingRewards[pendingKey] = {
      code, action, state: Float32Array.from(state),
      date: today, entryNav: parseFloat(fd?.dwjz || fd?.gsz || 0),
      positionValue: simPos ? simPos.shares * (getSimNav(code) || simPos.avgCost) : 0,
      timestamp: Date.now()
    };

    // 在线经验存入PER(提升优先级)
    const nextState = Float32Array.from(state);
    nextState[20] = simPos ? 1 : 0;
    // 即时经验用提升的优先级
    const origMaxP = rlTrainer.agent.maxPriority;
    rlTrainer.agent.maxPriority = origMaxP * RL_ONLINE_PRIORITY_BOOST;
    rlTrainer.agent.remember(state, action, reward, nextState, false, true);
    rlTrainer.agent.maxPriority = origMaxP;
    onlineReplayCount++;
  }

  // 增量训练: 每次在线学习做少量Replay
  if(onlineReplayCount > 0 && rlTrainer.agent.perTree.size >= rlTrainer.agent.batchSize * 2){
    const onlineBatches = Math.min(onlineReplayCount * 3, 12);
    for(let i = 0; i < onlineBatches; i++){
      rlTrainer.agent.replay();
    }
    rlTrainer.saveModel();
    rlTrainer.generateSignals();
    renderRLBrief();
    console.log(`RL在线学习: ${onlineReplayCount}条即时经验·${onlineBatches}次Replay·ε=${rlTrainer.agent.epsilon.toFixed(4)}·${Object.keys(_rlPendingRewards).length}条待延迟结算`);
  }
}

// ==================== RL延迟奖励结算 ====================
function settleDelayedRewards(){
  if(!_rlModelLoaded || !rlTrainer?.agent) return;
  const today = todayStr();
  const SETTLE_DAYS = 3; // 3天后结算
  let settled = 0;

  for(const [key, pending] of Object.entries(_rlPendingRewards)){
    // 检查是否满3天
    const daysSince = Math.floor((Date.now() - pending.timestamp) / 86400000);
    if(daysSince < SETTLE_DAYS) continue;

    const code = pending.code;
    const fd = getFundData(code);
    const currentNav = parseFloat(fd?.dwjz || fd?.gsz || 0);
    if(!currentNav || !pending.entryNav) { delete _rlPendingRewards[key]; continue; }

    // 计算多日实际回报
    const multiDayReturn = (currentNav - pending.entryNav) / pending.entryNav;
    let delayedReward = 0;

    if(pending.action === 1){ // 买入
      // 买入后上涨=好决策, 下跌=坏决策
      delayedReward = multiDayReturn > 0 ? multiDayReturn * 8 : multiDayReturn * 12;
      if(multiDayReturn > 0.03) delayedReward += 0.3; // 超过3%额外奖励
      if(multiDayReturn < -0.03) delayedReward -= 0.4; // 超过-3%额外惩罚
    } else if(pending.action === 2){ // 卖出
      // 卖出后下跌=好决策(逃顶), 上涨=错过
      delayedReward = multiDayReturn < 0 ? Math.abs(multiDayReturn) * 8 : -multiDayReturn * 6;
      if(multiDayReturn < -0.03) delayedReward += 0.3;
      if(multiDayReturn > 0.03) delayedReward -= 0.3;
    }

    // 构建结算时的下一状态
    const hd = fundHistoryData[code];
    if(hd?.navs && hd.navs.length >= 65){
      const navArr = hd.navs.map(n=>({date:n.date||n[0],nav:parseFloat(n.nav!==undefined?n.nav:n[1])})).filter(n=>!isNaN(n.nav)&&n.nav>0);
      if(navArr.length >= 65){
        const env = new MarketEnv(navArr, code);
        env.idx = navArr.length - 1;
        const simPos = simPortfolio?.positions?.find(p => p.code === code);
        env.pos = simPos ? 1 : 0;
        if(simPos) env.entryPrice = simPos.avgCost;
        const nextState = env._state();
        // 延迟经验以更高优先级存入
        const origMaxP = rlTrainer.agent.maxPriority;
        rlTrainer.agent.maxPriority = origMaxP * RL_ONLINE_PRIORITY_BOOST * 1.5;
        rlTrainer.agent.remember(pending.state, pending.action, delayedReward, nextState, false, true);
        rlTrainer.agent.maxPriority = origMaxP;
        settled++;
      }
    }
    delete _rlPendingRewards[key];
  }

  // 延迟经验专门做Replay
  if(settled > 0 && rlTrainer.agent.perTree.size >= rlTrainer.agent.batchSize * 2){
    for(let i = 0; i < Math.min(settled * 4, 16); i++){
      rlTrainer.agent.replay();
    }
    rlTrainer.saveModel();
    rlTrainer.generateSignals();
    renderRLBrief();
    console.log(`RL延迟奖励结算: ${settled}条·多日回报经验已注入`);
  }
  // 清理超过7天未结算的pending(数据不可用)
  for(const [key, pending] of Object.entries(_rlPendingRewards)){
    if(Date.now() - pending.timestamp > 7 * 86400000) delete _rlPendingRewards[key];
  }
}

// ==================== 模拟盘绩效→回测参数自适应 ====================
function simFeedbackToBT(){
  if(!simPortfolio?.history || simPortfolio.history.length < 10) return;
  const recent = simPortfolio.history.slice(-30);
  const buyTrades = recent.filter(t => t.action === 'buy');
  const sellTrades = recent.filter(t => t.action === 'sell');
  if(buyTrades.length + sellTrades.length < 5) return;

  // 统计模拟盘实际胜率
  const positions = simPortfolio.positions || [];
  const snapshots = simPortfolio.dailySnapshots || [];
  if(snapshots.length < 3) return;
  const recentSnaps = snapshots.slice(-5);
  const avgReturn = recentSnaps.reduce((s,d) => s + (d.dailyReturn||0), 0) / recentSnaps.length;
  const totalValue = getSimTotalValue();
  const simReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL;

  // 根据模拟盘绩效调整回测参数
  // 模拟盘亏损→回测趋于保守(提高买入门槛, 降低卖出门槛)
  // 模拟盘盈利→回测趋于积极(降低买入门槛)
  if(simReturn < -0.03){ // 亏损>3%
    BT_RSI_BUY = Math.max(55, BT_RSI_BUY - 2); // 更严格的买入RSI
    BT_RSI_SELL = Math.max(65, BT_RSI_SELL - 2); // 更早卖出
    BT_MOMENTUM_BUY = Math.min(0.02, BT_MOMENTUM_BUY + 0.002); // 需要更强动量
  } else if(simReturn > 0.05){ // 盈利>5%
    BT_RSI_BUY = Math.min(75, BT_RSI_BUY + 1); // 放宽买入
    BT_RSI_SELL = Math.min(80, BT_RSI_SELL + 1); // 给更多空间
    BT_MOMENTUM_BUY = Math.max(0.005, BT_MOMENTUM_BUY - 0.001);
  }
  // 最近日均回报极端→额外调整
  if(avgReturn < -0.01){
    BT_MOMENTUM_BUY = Math.min(0.025, BT_MOMENTUM_BUY + 0.003);
  }
  console.log(`BT参数自适应(SimReturn=${(simReturn*100).toFixed(1)}%): RSI_BUY=${BT_RSI_BUY} RSI_SELL=${BT_RSI_SELL} MOM_BUY=${BT_MOMENTUM_BUY.toFixed(4)}`);
}

function learnFromPerformance(){
  if(!simPortfolio || simPortfolio.dailySnapshots.length < 2) return;
  const today = todayStr();
  const snapshots = simPortfolio.dailySnapshots;
  const recent = snapshots.slice(-5);
  const avgDailyReturn = recent.reduce((s,d) => s + d.dailyReturn, 0) / recent.length;
  const strategy = simPortfolio.strategy;
  let lesson = '';
  let strategyChange = '';

  if(recent.length >= 3){
    const negDays = recent.filter(d => d.dailyReturn < 0).length;
    const posDays = recent.filter(d => d.dailyReturn > 0).length;
    if(negDays >= 4 && strategy.stopLoss > -6){
      strategy.stopLoss = Math.max(strategy.stopLoss - 1, -10);
      strategyChange = `连续亏损${negDays}天→止损收紧至${strategy.stopLoss}%`;
      lesson = '市场持续走弱，减少卫星仓敞口，加强风控';
    }
    if(posDays >= 4 && strategy.takeProfit < 25){
      strategy.takeProfit = Math.min(strategy.takeProfit + 2, 30);
      strategyChange = `连续盈利${posDays}天→止盈上调至${strategy.takeProfit}%`;
      lesson = '市场趋势良好，保持仓位让利润奔跑';
    }
  }

  // 板块胜率分析
  const latestSnap = snapshots[snapshots.length - 1];
  if(latestSnap?.positions){
    const winCount = latestSnap.positions.filter(p => p.todayPct > 0).length;
    const loseCount = latestSnap.positions.filter(p => p.todayPct < 0).length;
    if(loseCount > winCount && !lesson) lesson = `今日${loseCount}跌/${winCount}涨，注意回调风险`;
  }

  // 预测准确率反馈
  const review = generateDailyReview();
  if(review && review.accuracy < 40 && !lesson){
    lesson = `AI预测准确率仅${review.accuracy}%，减少频繁操作`;
    if(strategy.dipBuyThreshold > -2.5){
      strategy.dipBuyThreshold -= 0.5;
      strategyChange += (strategyChange?'；':'') + `加仓阈值→${strategy.dipBuyThreshold}%`;
    }
  }

  // 月度回报检查
  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const daysRunning = snapshots.length;
  if(daysRunning >= 10){
    const monthlyPace = cumReturn / daysRunning * 22;
    if(monthlyPace < 1 && !lesson){
      lesson = `月化收益率约${monthlyPace.toFixed(1)}%，低于2%目标，需提高进攻性`;
      if(strategy.dipBuyThreshold > -2.0){
        strategy.dipBuyThreshold = Math.max(strategy.dipBuyThreshold + 0.3, -1.0);
        strategyChange += (strategyChange?'；':'') + `降低加仓门槛→${strategy.dipBuyThreshold.toFixed(1)}%`;
      }
    }
    if(monthlyPace > 5 && !lesson){
      lesson = `月化约${monthlyPace.toFixed(1)}%，大幅超额，适当锁定利润防回撤`;
    }
  }

  if(lesson || strategyChange){
    simPortfolio.learningLog.push({
      date:today, lesson, strategyChange,
      cumReturn:+cumReturn.toFixed(2),
      avgDailyReturn:+avgDailyReturn.toFixed(3),
    });
    if(simPortfolio.learningLog.length > 30) simPortfolio.learningLog = simPortfolio.learningLog.slice(-30);
  }
  saveSimPortfolio();
}

function generateDataSignal(){
  let score = 50; // 50=中性
  // 宏观面 ±15
  const macro = getMacroSummary();
  score += (macro.positiveCount - 2.5) * 6;
  // 资金面 ±15
  const capFlow = getCapFlowSummary();
  if(capFlow.netTotal > 5e9) score += 15;
  else if(capFlow.netTotal > 0) score += 8;
  else if(capFlow.netTotal < -5e9) score -= 15;
  else if(capFlow.netTotal < 0) score -= 8;
  // 舆情面 ±10
  score += (newsSentiment.score - 50) * 0.2;
  // 国际舆情面 ±8
  if(globalNews.length > 0){
    const gSent = getGlobalNewsSentiment();
    score += (gSent.score - 50) * 0.16;
    // AI评分加权
    if(globalNewsSummary?.score) score += (globalNewsSummary.score - 50) * 0.08;
  }
  // 宏观地缘事件 ±12
  const geoAnalysis = getMacroGeoAnalysis();
  score += (geoAnalysis.score - 50) * 0.24;
  // PMI特殊权重
  if(macroData.pmi?.[0]){
    const pmi = macroData.pmi[0].MAKE_INDEX;
    if(pmi >= 51) score += 5;
    else if(pmi < 49) score -= 5;
  }
  // === 实时大盘动量 ±10 ===
  // 沪深300实时涨跌幅作为当日市场情绪信号
  const hs300 = liveIndices['1.000300'];
  if(hs300 && !isNaN(hs300.pct)){
    const mkPct = parseFloat(hs300.pct);
    if(mkPct > 2) score += 10;
    else if(mkPct > 1) score += 6;
    else if(mkPct > 0.3) score += 3;
    else if(mkPct < -2) score -= 10;
    else if(mkPct < -1) score -= 6;
    else if(mkPct < -0.3) score -= 3;
  }
  // 板块涨跌幅广度: 涨幅板块数远多于跌幅板块数 → 市场情绪偏多
  if(liveSectors && liveSectors.length > 5){
    const upCount = liveSectors.filter(s => s.pct > 0).length;
    const downCount = liveSectors.filter(s => s.pct < 0).length;
    const breadth = (upCount - downCount) / liveSectors.length; // -1 to +1
    score += Math.round(breadth * 5); // ±5
  }

  score = Math.max(0, Math.min(100, Math.round(score)));
  if(score >= 70) return { score, label:'积极看多', icon:'�', color:'#ef4444', advice:'宏观+资金+舆情+国际四维共振偏多，可适当增配' };
  if(score >= 58) return { score, label:'谨慎偏多', icon:'🟡', color:'#f59e0b', advice:'多数指标偏正面，维持仓位、可低吸' };
  if(score >= 42) return { score, label:'中性观望', icon:'⚪', color:'rgba(255,255,255,0.7)', advice:'信号分歧较大，维持现有配置不宜激进' };
  if(score >= 30) return { score, label:'谨慎偏空', icon:'🟠', color:'#f59e0b', advice:'部分指标走弱，控制仓位、降低风险敞口' };
  return { score, label:'防御为主', icon:'�', color:'#22c55e', advice:'多维度信号偏负面，建议降低仓位、增加现金' };
}

// ==================== RL BRAIN RENDERING ====================
function toggleRLBrain(){
  // Now handled by engine detail tabs
  switchEngTab('rl');
  const body = document.getElementById('engine-detail-body');
  if(body.style.display === 'none') toggleEngineDetail();
}

// === Merged Engine Detail Section ===
function toggleEngineDetail(){
  const body = document.getElementById('engine-detail-body');
  const icon = document.getElementById('engine-detail-toggle');
  if(body.style.display === 'none'){
    body.style.display = '';
    icon.textContent = '▼';
    // Render whichever tab is active
    if(document.getElementById('rl-brain-container').style.display !== 'none') renderRLBrain();
    else if(document.getElementById('bt-container').style.display !== 'none') renderBacktest();
    else if(document.getElementById('sot-container').style.display !== 'none') renderSOTDashboard();
  } else {
    body.style.display = 'none';
    icon.textContent = '▶';
  }
}
function switchEngTab(tab){
  ['rl','bt','sot'].forEach(t => {
    const tabEl = document.getElementById('eng-tab-'+t);
    const containerId = t==='rl'?'rl-brain-container':t==='bt'?'bt-container':'sot-container';
    const container = document.getElementById(containerId);
    if(t === tab){
      tabEl.style.borderBottomColor = '#1e293b';
      tabEl.style.color = 'var(--text)';
      container.style.display = '';
      if(t==='rl') renderRLBrain();
      else if(t==='bt') renderBacktest();
      else renderSOTDashboard();
    } else {
      tabEl.style.borderBottomColor = 'transparent';
      tabEl.style.color = 'var(--sub)';
      container.style.display = 'none';
    }
  });
}
function togglePortfolioSection(){
  const body = document.getElementById('pf-section-body');
  const icon = document.getElementById('pf-section-toggle');
  if(body.style.display === 'none'){
    body.style.display = '';
    icon.textContent = '▼';
    renderPortfolio();
  } else {
    body.style.display = 'none';
    icon.textContent = '▶';
  }
}

function renderRLBrief(){
  const el=document.getElementById('rl-brain-brief');
  if(!el)return;
  if(_rlTraining){
    el.style.color='#eab308';
    el.textContent=`RL:训练中 E${(rlTrainer?.episode||0)+1}`;
    return;
  }
  if(!_rlModelLoaded||!rlTrainer?.agent){
    el.style.color='var(--sub)';el.textContent='RL:未训练';return;
  }
  const sigs=Object.values(_rlSignals);
  if(!sigs.length){el.style.color='var(--sub)';el.textContent=`RL:E${rlTrainer.episode+1}`;return;}
  const buys=sigs.filter(s=>s.action===1).length;
  const sells=sigs.filter(s=>s.action===2).length;
  const holds=sigs.filter(s=>s.action===0).length;
  let txt='RL:';
  if(buys>0)txt+=`买${buys} `;
  if(sells>0)txt+=`卖${sells} `;
  if(holds>0)txt+=`持${holds}`;
  // Show average conviction from ensemble
  const strongCount=sigs.filter(s=>s.conviction==='强').length;
  const label=strongCount===sigs.length?'强':'混';
  el.style.color=buys>sells?'var(--red)':sells>buys?'var(--green)':'var(--sub)';
  el.textContent=txt.trim();
}

function renderRLBrain(){
  const container=document.getElementById('rl-brain-container');
  if(!container)return;
  const hasModel=_rlModelLoaded&&rlTrainer?.agent;
  const m=rlTrainer?.metrics||{};
  const sClass=_rlTraining?'training':hasModel?'active':'idle';
  const sTxt=_rlTraining?
    `训练中 Episode ${(rlTrainer.episode||0)+1}/${rlTrainer.maxEpisodes}`:
    hasModel?`已就绪 · ${rlTrainer.agent.trainSteps}步训练 · ε=${rlTrainer.agent.epsilon.toFixed(3)}`:'模型未训练';

  let html='';
  // Status + Metrics card
 html+=`<div class="rl-card"><div class="rl-card-title"> Rainbow DQN 强化学习引擎</div>`;
  html+=`<div class="rl-status"><span class="rl-status-dot ${sClass}"></span><span class="rl-status-text">${sTxt}</span></div>`;
  if(_rlTraining&&rlTrainer){
    const pct=Math.round((rlTrainer.episode+1)/rlTrainer.maxEpisodes*100);
    html+=`<div class="rl-progress"><div class="rl-progress-fill" style="width:${pct}%"></div></div>`;
  }
  if(hasModel){
    html+=`<div class="rl-metrics">`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">平均收益</span><span class="rl-metric-val" style="color:${(m.avgReturn||0)>=0?'var(--red)':'var(--green)'}">${(m.avgReturn||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">胜率</span><span class="rl-metric-val">${(m.winRate||0).toFixed(0)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Sharpe</span><span class="rl-metric-val">${(m.sharpe||0).toFixed(2)}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">最佳回报</span><span class="rl-metric-val" style="color:var(--red)">${(m.bestReturn||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">最大回撤</span><span class="rl-metric-val" style="color:var(--green)">${(m.mdd||0).toFixed(1)}%</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">训练轮次</span><span class="rl-metric-val">${(rlTrainer.episode||0)+1}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">探索率ε</span><span class="rl-metric-val">${rlTrainer.agent.epsilon.toFixed(3)}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">学习率</span><span class="rl-metric-val">${(rlTrainer.agent.lr*10000).toFixed(1)}e-4</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Sortino</span><span class="rl-metric-val">${(m.sortino||0).toFixed(2)}</span></div>`;
    html+=`<div class="rl-metric"><span class="rl-metric-label">Ensemble</span><span class="rl-metric-val">${rlTrainer.agent.nHeads}头</span></div>`;
    html+=`</div>`;
    if(m.portfolios&&m.portfolios.length>1)html+=renderRLChart(m.portfolios,'收益率%');
  }
  // Train button
  if(_rlTraining){
    html+=`<button class="rl-train-btn stop" onclick="stopRLTraining()">⏹ 停止训练</button>`;
  }else{
    const dc=Object.keys(fundHistoryData).length;
    html+=`<button class="rl-train-btn start" onclick="startRLTraining()" ${dc<1?'disabled title="需要先加载历史数据"':''}>`;
 html+=hasModel?' 重新训练 (Rainbow DQN)':' 开始训练 (Rainbow DQN)';
    html+=`</button>`;
  }
  html+=`</div>`;

  // RL Signals card
  if(hasModel&&Object.keys(_rlSignals).length>0){
 html+=`<div class="rl-card"><div class="rl-card-title"> RL集成决策信号 <span style="font-size:9px;color:var(--sub);font-weight:400">Ensemble投票 · 置信度仓位</span></div>`;
    for(const code of Object.keys(_rlSignals)){
      const sig=_rlSignals[code];
      const name=fundName(code);
      const ac=sig.action===1?'buy':sig.action===2?'sell':'hold';
      const qAbs=(sig.qValues||[0,0,0]).map(v=>Math.abs(v));
      const qMax=Math.max(...qAbs,0.01);
      // Conviction color
      const cvColor=sig.conviction==='强'?'#22d3ee':sig.conviction==='中'?'#f59e0b':'#ef4444';
      html+=`<div class="rl-signal-row">`;
      html+=`<span class="rl-signal-name">${name}</span>`;
      html+=`<div class="rl-qbar">`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[0]/qMax*30}px;background:var(--sub);opacity:0.5" title="Q(持有)=${(sig.qValues[0]||0).toFixed(2)}"></div>`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[1]/qMax*30}px;background:var(--red);opacity:0.6" title="Q(买入)=${(sig.qValues[1]||0).toFixed(2)}"></div>`;
      html+=`<div class="rl-qbar-seg" style="width:${qAbs[2]/qMax*30}px;background:var(--green);opacity:0.6" title="Q(卖出)=${(sig.qValues[2]||0).toFixed(2)}"></div>`;
      html+=`</div>`;
      html+=`<span class="rl-signal-action ${ac}">${sig.actionName}</span>`;
      html+=`<span style="font-size:9px;color:${cvColor};font-weight:700;min-width:16px" title="置信=${sig.conviction} 仓位=${sig.positionPct}% 不确定性=${(sig.uncertainty||0).toFixed(3)} 投票=[${(sig.headVotes||[]).join(',')}]">${sig.conviction}${sig.positionPct}%</span>`;
      html+=`</div>`;
    }
    html+=`</div>`;
  }

  // Architecture info
 html+=`<div class="rl-card"><div class="rl-card-title"> Rainbow DQN 架构</div>`;
  html+=`<div style="font-size:10px;color:var(--sub);line-height:1.6">`;
  html+=`<b>算法:</b> <b style="color:#f59e0b">Dueling</b> + Double + <b style="color:#f59e0b">PER</b> + <b style="color:#8b5cf6">N-Step(3)</b> + <b style="color:#22d3ee">Bootstrapped Ensemble(×${RL_ENSEMBLE_K})</b> + Adam + 梯度裁剪 + LR衰减<br>`;
  html+=`<b>网络:</b> [${RL_STATE_SIZE}] → 128(ReLU) → 64(ReLU) → <b style="color:#f59e0b">V(s)[1] + A(s,a)[${RL_ACTION_SIZE}]</b> × ${RL_ENSEMBLE_K}头<br>`;
  html+=`<b>状态(40维):</b> 动量×5 · 波动率×3 · RSI(14/7) · MACD+直方图 · MA偏离 · 布林%B · 回撤 · ATR · 趋势 · 持仓+PnL+时长 · 宏观×4 · 回测×3 · 高阶×6 · <b style="color:#22d3ee">组合DD·现金比·HHI集中度·权重</b><br>`;
  html+=`<b>奖励:</b> <b style="color:#f59e0b">Sortino风险调整</b> · 持仓因子 · 阶梯回撤惩罚 · 过度交易惩罚 · 滚动Sortino奖励<br>`;
  html+=`<b>训练:</b> 80轮 <b style="color:#22d3ee">课程学习</b>(低波动→高波动) · γ=0.99 · PER=20K · Bootstrap概率=80%<br>`;
  html+=`<b>信号:</b> <b style="color:#22d3ee">Ensemble多数投票</b> · 置信度仓位(强100%/中60%/弱30%) · 认知不确定性量化<br>`;
  html+=`<b>联动:</b> <span style="color:#22d3ee">Regime自适应权重 → 引擎EMA准确率调权 → 反羊群RSI极端校正 → 时序滞回防翻转 → 组合风险约束 → 延迟奖励 → BT参数自适应</span>`;
  html+=`</div>`;
  // 新增: Regime + 引擎准确率展示
  html+=`<div style="margin-top:8px;font-size:10px;line-height:1.5">`;
 const regimeLabels = { bull:' 牛市趋势', bear:' 熊市防御', volatile:' 高波震荡', sideways:'↔ 横盘震荡', unknown:' 未知' };
  html+=`<b>市场Regime:</b> <span style="color:#f59e0b">${regimeLabels[_marketRegime]||_marketRegime}</span> `;
  html+=`<span style="color:var(--sub)">(AI×${_regimeWeights.ai} RL×${_regimeWeights.rl} BT×${_regimeWeights.bt})</span><br>`;
  html+=`<b>引擎准确率:</b> `;
  html+=`AI <span style="color:${_engineAccuracy.ai>0.55?'#22d3ee':'#ef4444'}">${(_engineAccuracy.ai*100).toFixed(0)}%</span> · `;
  html+=`RL <span style="color:${_engineAccuracy.rl>0.55?'#22d3ee':'#ef4444'}">${(_engineAccuracy.rl*100).toFixed(0)}%</span> · `;
  html+=`BT <span style="color:${_engineAccuracy.bt>0.55?'#22d3ee':'#ef4444'}">${(_engineAccuracy.bt*100).toFixed(0)}%</span>`;
  html+=`</div>`;
  html+=`</div>`;

  container.innerHTML=html;
}

function renderRLChart(data,label){
  if(!data||data.length<2)return'';
  const max=Math.max(...data),min=Math.min(...data);
  const range=max-min||1;
  const h=50,w=100;
  const pts=data.map((v,i)=>{
    const x=(i/(data.length-1))*w;
    const y=h-((v-min)/range)*h;
    return`${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  let s=`<div class="rl-chart"><svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s+=`<defs><linearGradient id="rlGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#8b5cf6" stop-opacity="0.3"/><stop offset="100%" stop-color="#8b5cf6" stop-opacity="0.02"/></linearGradient></defs>`;
  s+=`<polygon points="0,${h+2} ${pts} ${w},${h+2}" fill="url(#rlGrad)"/>`;
  s+=`<polyline points="${pts}" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>`;
  // Zero line
  const zeroY=h-((-min)/range)*h;
  if(zeroY>0&&zeroY<h)s+=`<line x1="0" y1="${zeroY.toFixed(1)}" x2="${w}" y2="${zeroY.toFixed(1)}" stroke="rgba(255,255,255,0.15)" stroke-dasharray="2,2"/>`;
  s+=`</svg>`;
  s+=`<div style="position:absolute;bottom:2px;left:4px;font-size:8px;color:var(--sub)">${label}: ${data[data.length-1].toFixed(1)}</div>`;
  s+=`<div style="position:absolute;bottom:2px;right:4px;font-size:8px;color:var(--sub)">E${data.length}</div>`;
  s+=`</div>`;
  return s;
}

async function startRLTraining(){
  if(_rlTraining)return;
  if(!rlTrainer)rlTrainer=new RLTrainer();
  const hdCount = Object.keys(fundHistoryData).length;
  console.log(`[RL] 开始准备训练数据, 已加载历史数据: ${hdCount}只基金`);
  const count=rlTrainer.prepare();
  if(count===0){
    alert('没有足够的历史数据进行训练。需要≥80天NAV数据(60天回溯窗口+20天训练)。\n请先添加持仓基金并等待历史数据加载完成。\n\n当前已加载历史数据: '+hdCount+' 只基金\n\n提示: 如果基金数>0但训练数据=0，说明历史数据天数不足80天。');
    return;
  }
  _rlTraining=true;
  renderRLBrain();renderRLBrief();
  console.log(`[RL] 训练开始: ${count}只基金历史数据, ${rlTrainer.maxEpisodes}轮训练`);
  try{
    await rlTrainer.train((ep,total,metrics)=>{
      renderRLBrain();renderRLBrief();
    });
    _rlModelLoaded=true;
    rlTrainer.generateSignals();
    console.log('[RL] 训练完成:',rlTrainer.metrics);
  }catch(err){
    console.error('[RL] 训练出错:', err);
    alert('RL训练过程中出错: ' + err.message);
  }finally{
    _rlTraining=false;
    renderRLBrain();renderRLBrief();
  }
  // RL训练完成 → 自动重跑回测(RL信号已更新，回测结果需要同步)
  if(Object.keys(fundHistoryData).length > 0){
    console.log('RL训练后自动重跑回测(同步逐步RL信号)...');
    setTimeout(()=>runBacktest(), 300);
  }
}

function stopRLTraining(){
  if(rlTrainer)rlTrainer.stop();
  _rlTraining=false;
  renderRLBrain();renderRLBrief();
}

// Build RL context for AI prompt
function buildRLContext(){
  if(!_rlModelLoaded||!rlTrainer?.agent||!Object.keys(_rlSignals).length)return'';
 let ctx='\n【 Rainbow DQN 强化学习信号 (Dueling+Ensemble+40维)】\n';
  ctx+=`模型: Rainbow DQN(40维·Dueling·PER·N-Step·${rlTrainer.agent.nHeads}头Ensemble) · 已训练${rlTrainer.episode+1}轮 · ${rlTrainer.agent.trainSteps}步 · 课程学习\n`;
  ctx+=`指标: 胜率${(rlTrainer.metrics.winRate||0).toFixed(0)}% · 平均收益${(rlTrainer.metrics.avgReturn||0).toFixed(1)}% · Sharpe${(rlTrainer.metrics.sharpe||0).toFixed(2)} · Sortino${(rlTrainer.metrics.sortino||0).toFixed(2)} · MDD${(rlTrainer.metrics.mdd||0).toFixed(1)}%\n`;
  ctx+=`在线学习: ${Object.keys(_rlPendingRewards).length}条延迟奖励待结算 · BT参数自适应: RSI买=${BT_RSI_BUY}/卖=${BT_RSI_SELL} 动量=${BT_MOMENTUM_BUY.toFixed(4)}\n`;
  // 新增: 市场Regime + 引擎准确率 + 组合风险
  ctx+=`市场Regime: ${_marketRegime} (权重: AI=${_regimeWeights.ai} RL=${_regimeWeights.rl} BT=${_regimeWeights.bt})\n`;
  ctx+=`引擎准确率(EMA): AI=${(_engineAccuracy.ai*100).toFixed(0)}% RL=${(_engineAccuracy.rl*100).toFixed(0)}% BT=${(_engineAccuracy.bt*100).toFixed(0)}%\n`;
  const portRisk = getPortfolioRiskMetrics();
  ctx+=`组合风险: 评分=${(portRisk.riskScore*100).toFixed(0)}% 回撤=${(portRisk.dd*100).toFixed(1)}% 现金比=${(portRisk.cashRatio*100).toFixed(0)}% HHI集中度=${portRisk.hhi.toFixed(2)}\n`;
  ctx+='个股Rainbow DQN集成决策 + 三引擎共识:\n';
  for(const[code,sig]of Object.entries(_rlSignals)){
    const name=fundName(code);
    const qStr=(sig.qValues||[]).map(v=>(v||0).toFixed(2)).join('/');
    const votes=(sig.headVotes||[]).map(v=>RL_ACTION_NAMES[v]).join(',');
    // 附加三引擎共识信息
    let triInfo = '';
    if(_analysisResult?.signals?.[code] || btResults[code]){
      const tri = computeTriEngineVote(code, _analysisResult?.signals?.[code], sig, btResults[code]);
      triInfo = ` → 三引擎共识:${tri.actionLabel}(${tri.buyVotes}买/${tri.sellVotes}卖×${tri.consensusMult.toFixed(1)}) 综合=${tri.score.toFixed(2)} Regime=${tri.regime} 风控=${tri.riskMult.toFixed(2)}`;
    }
    ctx+=`  ${name}(${code}): ${sig.actionName} 置信=${sig.conviction}(仓位${sig.positionPct}%) 投票=[${votes}] 不确定性=${(sig.uncertainty||0).toFixed(3)} Q=[${qStr}]${triInfo}\n`;
  }
 ctx+=' 闭环联动: RL逐步信号融入回测(消除前瞻偏差) → 回测指标注入RL 40维状态(含组合DD/现金/集中度/权重) → Regime自适应引擎权重 → 引擎准确率EMA动态调权 → 反羊群RSI极端校正 → 时序一致性+滞回防翻转 → 组合风险约束 → 延迟奖励在线学习 → Sim绩效自适应BT参数 → RL训练完成自动重跑回测。\n';
  // 宏观地缘事件上下文
  const geoCtx = getMacroGeoAnalysis();
 ctx+='\n【 宏观地缘事件分析】\n';
  ctx+=`综合地缘评分: ${geoCtx.score}/100 (${geoCtx.label})\n`;
  ctx+=`三个月展望(${geoCtx.outlook.period}): ${geoCtx.outlook.overall}\n`;
  ctx+='关键事件:\n';
  geoCtx.topEvents.forEach(e => {
    ctx+=`  ${e.icon} ${e.name}: 影响=${e.impact>0?'+':''}${e.impact} 置信=${(e.confidence*100).toFixed(0)}% — ${e.advice}\n`;
    if(e.scenarios && e.scenarios.length > 0){
      e.scenarios.forEach(sc => {
        ctx+=`    [${sc.name}] 概率${(sc.probability*100).toFixed(0)}% 影响${sc.impact>0?'+':''}${sc.impact}: ${sc.note}\n`;
      });
    }
  });
  ctx+='投资主线:\n';
  geoCtx.outlook.themes.forEach(t => {
    const arrow = t.direction==='up'?'↑':t.direction==='down'?'↓':'→';
    ctx+=`  ${arrow} ${t.name}(${t.conviction}): ${t.reason}\n`;
  });
  ctx+=`建议配置: 进攻=${geoCtx.outlook.allocation.offensive} / 核心=${geoCtx.outlook.allocation.core} / 防御=${geoCtx.outlook.allocation.hedge}\n`;
 ctx+=' 请结合以上地缘事件和三个月展望，对每只基金给出是否受益/受损的具体判断，并在操作建议中体现宏观逻辑。\n';
  return ctx;
}

function toggleSimDetail(){
  const container = document.getElementById('sim-container');
  const icon = document.getElementById('sim-toggle-icon');
  if(container.style.display === 'none'){
    container.style.display = '';
    icon.textContent = '▼';
    renderSimPortfolio();
  } else {
    container.style.display = 'none';
    icon.textContent = '▶';
  }
}

function renderSimBrief(){
  const brief = document.getElementById('sim-brief');
  if(!brief) return;
  if(!simPortfolio || !simPortfolio.positions || simPortfolio.positions.length===0){
    brief.innerHTML = holdings.length>0 ? '<span style="color:var(--sub)">待建仓</span>' : '<span style="color:var(--sub)">需持仓</span>';
    return;
  }
  const totalValue = getSimTotalValue();
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  let liveCount = 0;
  simPortfolio.positions.forEach(p => { if(getFundData(p.code)?._live) liveCount++; });
  const total = simPortfolio.positions.length;
 const liveTag = liveCount===total ? '' : liveCount>0 ? '' : '';
  const color = cumProfit >= 0 ? 'var(--red)' : 'var(--green)';
  brief.innerHTML = `<span style="color:${color}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}元</span> <span style="font-size:9px">${liveTag}${liveCount}/${total}</span>`;
}

function renderSimPortfolio(){
  const container = document.getElementById('sim-container');
  if(!simPortfolio || !simPortfolio.positions || simPortfolio.positions.length===0){
    const msg = holdings.length===0
      ? '请先添加持仓基金<br><span style="font-size:11px;color:var(--sub)">模拟盘将基于您的持仓自动建仓</span>'
 : '<span>持仓已就绪，点击建仓开始模拟</span><br><button class="form-btn" style="width:auto;padding:8px 20px;margin-top:10px;font-size:12px" onclick="syncSimFromHoldings()"> 从持仓开始建仓</button>';
 container.innerHTML = `<div class="empty"><div class="empty-icon"></div>${msg}</div>`;
    return;
  }

  const totalValue = getSimTotalValue();
  const cumReturn = (totalValue - SIM_INITIAL_CAPITAL) / SIM_INITIAL_CAPITAL * 100;
  const cumProfit = totalValue - SIM_INITIAL_CAPITAL;
  const targetPct = SIM_TARGET_MONTHLY / SIM_INITIAL_CAPITAL * 100;
  const progressPct = Math.min(100, Math.max(0, cumReturn / targetPct * 100));

  let realPnlPct = 0;
  if(holdings.length > 0){
    holdings.forEach(h => { realPnlPct += (getFundData(h.code).gszzl||0); });
    realPnlPct /= holdings.length;
  }

  const snapshots = simPortfolio.dailySnapshots;
  const latestSnap = snapshots[snapshots.length - 1];
  const todayReturn = latestSnap?.dailyReturn || 0;
  const hs300 = getIndexData(INDICES_CONFIG[3]);
  const hs300CumPct = latestSnap?.hs300CumReturn || 0;
  const beatMarket = cumReturn > hs300CumPct;

  let html = '';

  // 概览卡片
  html += `<div class="sim-overview">
    <div class="sim-stat-row">
      <div class="sim-stat"><div class="sim-stat-label">总资产</div><div class="sim-stat-val">${(totalValue/10000).toFixed(2)}<span style="font-size:11px">万</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">累计收益</div><div class="sim-stat-val" style="color:${cumProfit>=0?'#ef4444':'#22c55e'}">${cumProfit>=0?'+':''}${cumProfit.toFixed(0)}<span style="font-size:11px">元</span></div></div>
      <div class="sim-stat"><div class="sim-stat-label">现金</div><div class="sim-stat-val" style="font-size:14px">${(simPortfolio.cash/10000).toFixed(2)}<span style="font-size:10px">万</span></div></div>
    </div>
    <div class="sim-target">
      <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
        <span>月目标: +¥${SIM_TARGET_MONTHLY.toLocaleString()} (${targetPct.toFixed(1)}%)</span>
        <span style="font-weight:600;color:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'rgba(255,255,255,0.5)'}">
 ${cumProfit>=SIM_TARGET_MONTHLY?' 已达成':'进度 '+progressPct.toFixed(0)+'%'}
        </span>
      </div>
      <div class="sim-progress"><div class="sim-progress-fill" style="width:${progressPct}%;background:${cumProfit>=SIM_TARGET_MONTHLY?'#22c55e':'linear-gradient(90deg,#f59e0b,#ef4444)'}"></div></div>
    </div>
  </div>`;

  // 对比卡片
  html += `<div class="sim-compare">
 <div class="sim-compare-title"> 今日对比</div>
    <div class="sim-compare-row">
      <div class="sim-compare-item">
 <span class="sim-compare-label"> 模拟盘</span>
        <span class="sim-compare-val" style="color:${todayReturn>=0?'var(--red)':'var(--green)'}">${todayReturn>=0?'+':''}${todayReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
 <span class="sim-compare-label"> 真实持仓</span>
        <span class="sim-compare-val" style="color:${realPnlPct>=0?'var(--red)':'var(--green)'}">${holdings.length>0?(realPnlPct>=0?'+':'')+realPnlPct.toFixed(2)+'%':'--'}</span>
      </div>
      <div class="sim-compare-item">
 <span class="sim-compare-label"> 沪深300</span>
        <span class="sim-compare-val" style="color:${hs300.pct>=0?'var(--red)':'var(--green)'}">${hs300.pct>=0?'+':''}${fmt(hs300.pct)}%</span>
      </div>
    </div>
    <div class="sim-compare-row" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
      <div class="sim-compare-item">
        <span class="sim-compare-label">累计收益率</span>
        <span class="sim-compare-val" style="color:${cumReturn>=0?'var(--red)':'var(--green)'}; font-weight:800">${cumReturn>=0?'+':''}${cumReturn.toFixed(2)}%</span>
      </div>
      <div class="sim-compare-item">
        <span class="sim-compare-label">vs 沪深300</span>
        <span class="sim-compare-val" style="color:${beatMarket?'var(--red)':'var(--green)'}; font-weight:600">${beatMarket?'跑赢':'跑输'} ${Math.abs(cumReturn-hs300CumPct).toFixed(2)}%</span>
      </div>
    </div>
  </div>`;

  // 持仓明细
  const syncLabel = simPortfolio.syncSource==='holdings' ? ' · 来自持仓' : '';
  html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px;display:flex;justify-content:space-between">
 <span> 模拟持仓 (${simPortfolio.positions.length}只)</span>
    <span style="font-weight:400;color:var(--sub);font-size:10px">建仓: ${simPortfolio.created}${syncLabel}</span>
  </div>`;

  // 数据质量统计
  {
    let lc=0,hc=0,fc=0;
    simPortfolio.positions.forEach(p=>{const fd=getFundData(p.code);if(fd?._live)lc++;else if(fd?._histFallback)hc++;else fc++;});
    const tp=simPortfolio.positions.length;
    const ls=snapshots.length>0?snapshots[snapshots.length-1]:null;
    html += `<div style="font-size:9px;color:var(--sub);text-align:center;margin:6px 0;padding:4px 8px;background:rgba(255,255,255,0.03);border-radius:6px">
 数据源: 实时${lc} ${hc>0?'历史'+hc+' ':''}${fc>0?'待校准'+fc+' ':''}· 共${tp}只 ${ls?.updatedAt?'· 更新 '+ls.updatedAt:''}
    </div>`;
  }

  [...simPortfolio.positions]
    .sort((a,b) => a.group==='core'&&b.group!=='core' ? -1 : a.group!=='core'&&b.group==='core' ? 1 : 0)
    .forEach(pos => {
      const fd = getFundData(pos.code);
      const nav = getSimNav(pos.code) || pos.avgCost;
      const currentValue = pos.shares * nav;
      const pnl = currentValue - pos.investedAmount;
      const pnlPct = pos.investedAmount > 0 ? (pnl / pos.investedAmount * 100) : 0;
      const todayPct = fd?.gszzl || 0;
      const weight = currentValue / totalValue * 100;
 const g = pos.group === 'core' ? '' : '';
 const dataBadge = fd?._live ? '' : fd?._histFallback ? '' : '';
      const _simPLabel = pctLabel(fd);
      const _simNoData = fd?._noData;
      html += `<div class="sim-pos-card">
        <div class="sim-pos-top">
          <div class="sim-pos-info">
            <div class="sim-pos-name">${g} ${pos.name} <span style="font-size:8px">${dataBadge}</span></div>
            <div class="sim-pos-meta">${pos.code} · ${pos.type} · ${weight.toFixed(1)}%</div>
          </div>
          <div class="sim-pos-right">
            <div class="sim-pos-pct" style="color:${_simNoData?'var(--sub)':(todayPct>=0?'var(--red)':'var(--green)')}">${_simNoData?'待开盘':((todayPct>=0?'+':'')+todayPct.toFixed(2)+'%')}</div>
            <div style="font-size:9px;color:var(--sub)">${_simPLabel}</div>
            <div style="font-size:10px;color:${pnlPct>=0?'var(--red)':'var(--green)'}">累计${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%</div>
          </div>
        </div>
        <div class="sim-pos-detail">
          <span>¥${currentValue.toFixed(0)}</span>
          <span>成本¥${pos.investedAmount}</span>
          <span style="color:${pnl>=0?'var(--red)':'var(--green)'}">盈亏${pnl>=0?'+':''}¥${pnl.toFixed(0)}</span>
        </div>
      </div>`;
    });

  // 策略参数
  html += `<div class="sim-strategy-card">
 <div style="font-size:11px;font-weight:600;margin-bottom:6px"> 当前策略参数 <span style="font-weight:400;color:var(--sub);font-size:9px">AI自动学习调优</span></div>
    <div class="sim-param-grid">
      <div class="sim-param"><span class="sp-label">核心/卫星</span><span class="sp-val">${(simPortfolio.strategy.coreRatio*100).toFixed(0)}/${(simPortfolio.strategy.satRatio*100).toFixed(0)}</span></div>
      <div class="sim-param"><span class="sp-label">止损线</span><span class="sp-val" style="color:var(--green)">${simPortfolio.strategy.stopLoss}%</span></div>
      <div class="sim-param"><span class="sp-label">止盈线</span><span class="sp-val" style="color:var(--red)">+${simPortfolio.strategy.takeProfit}%</span></div>
      <div class="sim-param"><span class="sp-label">低吸阈值</span><span class="sp-val">${simPortfolio.strategy.dipBuyThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">冲高减仓</span><span class="sp-val">+${simPortfolio.strategy.surgeSellThreshold}%</span></div>
      <div class="sim-param"><span class="sp-label">单只上限</span><span class="sp-val">${(simPortfolio.strategy.maxSinglePos*100).toFixed(0)}%</span></div>
    </div>
  </div>`;

  // 学习日志
  if(simPortfolio.learningLog && simPortfolio.learningLog.length > 0){
 html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px"> 策略学习日志</div>`;
    simPortfolio.learningLog.slice(-5).reverse().forEach(log => {
      html += `<div class="sim-learn-card">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--sub)">
          <span>${log.date}</span><span>累计${log.cumReturn>=0?'+':''}${log.cumReturn}%</span>
        </div>
 ${log.lesson ? `<div style="font-size:11px;margin-top:4px;line-height:1.5"> ${log.lesson}</div>` : ''}
 ${log.strategyChange ? `<div style="font-size:10px;color:var(--primary);margin-top:2px"> ${log.strategyChange}</div>` : ''}
      </div>`;
    });
  }

  // 交易记录
  const recentTrades = (simPortfolio.history || []).slice(-8).reverse();
  if(recentTrades.length > 0){
 html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px"> 最近交易 <span style="font-weight:400;color:var(--sub)">(共${simPortfolio.history.length}笔)</span></div>`;
    recentTrades.forEach(t => {
      const actionColor = t.action==='buy'?'var(--red)':'var(--green)';
 const actionIcon = t.action==='buy'?'�买':'卖';
      html += `<div class="sim-trade-item">
        <span style="color:${actionColor};font-weight:600;min-width:36px">${actionIcon}</span>
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.name||t.code}</span>
        <span style="min-width:56px;text-align:right;font-weight:600">¥${t.amount.toLocaleString()}</span>
        <span style="min-width:70px;text-align:right;color:var(--sub)">${t.date}</span>
      </div>`;
    });
  }

  // 收益走势
  if(snapshots.length >= 2){
 html += `<div style="font-size:11px;font-weight:600;margin:10px 0 6px"> 收益走势 (${snapshots.length}天)</div><div class="sim-chart">`;
    const displaySnaps = snapshots.slice(-15);
    const maxRet = Math.max(...displaySnaps.map(s => Math.abs(s.cumReturn)), 0.1);
    displaySnaps.forEach(s => {
      const w = Math.abs(s.cumReturn) / maxRet * 100;
      const color = s.cumReturn >= 0 ? 'var(--red)' : 'var(--green)';
      html += `<div class="sim-chart-row">
        <span class="sim-chart-date">${s.date.slice(5)}</span>
        <div class="sim-chart-bar"><div style="width:${Math.max(w,2)}%;height:100%;background:${color};border-radius:3px"></div></div>
        <span class="sim-chart-val" style="color:${color}">${s.cumReturn>=0?'+':''}${s.cumReturn.toFixed(2)}%</span>
      </div>`;
    });
    html += `</div>`;
  }

  // 交易日/休市状态
  const msSim = getMarketStatus();
 const tradingTag = isTradingDay() ? (msSim.status==='open'?' 交易中':'⏸ '+msSim.text) : ' 今日休市';
  html += `<div style="text-align:center;margin:10px 0 4px;font-size:10px;color:var(--sub)">${tradingTag}${msSim.isHoliday?' (节假日)':''}</div>`;

  html += `<div style="text-align:center;margin-top:8px;display:flex;gap:10px;justify-content:center">
 <span style="font-size:10px;color:var(--primary);cursor:pointer;text-decoration:underline" onclick="syncSimFromHoldings()"> 同步持仓重建</span>
    <span style="font-size:10px;color:var(--sub);cursor:pointer;text-decoration:underline" onclick="resetSimPortfolio()">↩ 重置模拟盘</span>
  </div>`;

  container.innerHTML = html;
  renderSimBrief();
}

function resetSimPortfolio(){
  if(holdings.length === 0){ alert('请先添加持仓基金，模拟盘将基于您的持仓建仓'); return; }
  if(!confirm(`确认重置模拟盘？\n\n将以50万资金，按您当前${holdings.length}只持仓等权建仓。`)) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  buildSimFromHoldings();
  updateSimDaily();
  renderSimPortfolio();
  renderSimBrief();
}

function syncSimFromHoldings(){
  if(holdings.length === 0){ alert('请先添加持仓基金'); return; }
 if(!confirm(`同步持仓到模拟盘？\n\n将重置模拟盘，以50万资金按您当前${holdings.length}只持仓重新建仓。\n 所有模拟交易记录将被清除。`)) return;
  localStorage.removeItem('fa_sim_portfolio');
  simPortfolio = null;
  buildSimFromHoldings();
  updateSimDaily();
  renderSimPortfolio();
  renderSimBrief();
}

// ==================== INITIALIZATION ====================
// 支持URL参数设置API Key: ?key=xxx 或 #key=xxx
(function(){
  const params = new URLSearchParams(location.search);
  const hashParams = new URLSearchParams(location.hash.replace('#',''));
  const urlKey = params.get('key') || hashParams.get('key');
  if(urlKey){
    _aiKey = urlKey;
    localStorage.setItem(AI_KEY_PRIMARY_STORAGE, urlKey);
    console.log('[Init] API Key set from URL');
    // 清除URL中的key
    history.replaceState(null, '', location.pathname);
  }
})();

async function loadData(){
  // 并行: 行情+热点事件
  await Promise.all([fetchIndices(), fetchSectors(), fetchAllFunds(), fetchHotEvents()]);
  // 热点事件加载完成后, 注入隔夜美股归因事件
  await fetchUSMarketForAttribution();
  renderAll();
  // 异步加载盘中分时数据（交易时段或收盘后都拉取当日分时）
  fetchAllIntradayDetail().then(()=>{
    console.log('[Intraday] 盘中分时数据就绪:', Object.keys(intradayData).filter(k=>intradayData[k].length>1).length, '只基金');
    renderActionGuide();
    renderWatchlist();
  }).catch(e=>console.warn('盘中分时加载失败:', e));
  // 异步加载历史数据和数据情报（不阻塞主渲染）
  fetchAllHistory().then(()=>{
    console.log('历史趋势数据加载完成:', Object.keys(fundHistoryData).length, '只基金');
    // 加载引擎准确率追踪
    loadEngineAccuracy();
    // 检测市场Regime
    const regimeInfo = detectMarketRegime();
    console.log(`市场Regime: ${regimeInfo.regime} (动量=${regimeInfo.avgMom?.toFixed(1)}% 波动=${regimeInfo.avgVol?.toFixed(1)}%)`);
    // 历史数据加载完成后，初始化RL大脑
    initRLBrain();
    // 自动运行回测（如果没有缓存结果）
    if(!btSummary && Object.keys(fundHistoryData).length > 0){
      console.log('自动启动回测...');
      setTimeout(()=>runBacktest(), 500);
    }
  }).catch(e=>console.warn('历史数据加载失败:', e));
  // 宏观数据加载：资金流+舆情+国际新闻
  fetchAllDataIntel().then(()=>{
    console.log('宏观数据加载完成: 资金/舆情/国际');
    // 初始化TOP50基金经理×社交热词耦合分析
    analyzeFMSocialCoupling();
    renderAll();
    // 启动地缘新闻自动刷新（每小时从全球媒体获取）
    startGeoNewsAutoRefresh();
  }).catch(e=>console.warn('宏观数据加载失败:', e));
}

function startTimers(){
  _countdownTimer = setInterval(()=>{ renderCountdown(); }, 1000);

  _refreshTimer = setInterval(async ()=>{
    const ms = getMarketStatus();
    if(ms.status==='open' || ms.status==='break'){
      await Promise.all([fetchIndices(), fetchAllFunds()]);
      // 每5分钟拉一次完整分时数据（补全快照可能遗漏的点）
      if(new Date().getMinutes() % 5 === 0) fetchAllIntradayDetail().catch(()=>{});
      // 更新净值刷新时间
      const _rt = document.getElementById('nav-refresh-time');
      if(_rt){ const _n=new Date(); _rt.textContent='净值 '+String(_n.getHours()).padStart(2,'0')+':'+String(_n.getMinutes()).padStart(2,'0')+':'+String(_n.getSeconds()).padStart(2,'0'); _rt.style.display=''; }
      renderIndices();
      renderStats();
      renderActionGuide();
      renderWatchlist();
      renderPortfolio();
      // 刷新模拟盘数据（用最新市场数据更新）
      updateSimDaily();
      renderSimBrief();
      if(document.getElementById('sim-container')?.style.display !== 'none'){
        renderSimPortfolio();
      }
      // 刷新宏观数据（资金流和新闻每30s更新）
      fetchSectorCapFlow().catch(()=>{});
      fetchNewsHeadlines().catch(()=>{});
      // 预测追踪: 14:50自动快照 + 14:55后自动验证
      checkAutoSnapshot();
      checkAutoVerify();
    }
  }, 30000);
}

(async function init(){
  renderCountdown();
  renderAll();
  startTimers();
  await loadData();

  // 加载基金持仓数据(异步，不阻塞渲染)
  loadAllFundHoldings().then(() => {
    console.log('[持仓分析] 持仓数据就绪，重新渲染信号');
    renderAll(); // 重新渲染以反映持仓分析结果
  });

  // 初始化模拟盘
  initSimPortfolio();
  updateSimDaily();
  renderSimBrief();

  generateDailyReview();
  renderReview();

  // 预测追踪: 页面加载时渲染 + 自动验证
  renderPredictionTracker();
  // 延迟3s后自动验证(等待数据就绪)
  setTimeout(()=>{ checkAutoVerify(); renderPredictionTracker(); }, 3000);

  // 初始化RL训练器（尝试加载已保存模型）
  rlTrainer = new RLTrainer();
  if(rlTrainer.loadModel()){
    renderRLBrief();
  }

  // 加载回测缓存
  loadBTResults();

  // Auto-trigger AI if we have holdings/watchlist and API key
  if(_aiKey && (holdings.length>0 || watchlist.length>0)){
    triggerAI();
  }
})();

// RL Brain initialization (called after history data loads)
function initRLBrain(){
  if(!rlTrainer)rlTrainer=new RLTrainer();
  if(_rlModelLoaded && rlTrainer.agent){
    rlTrainer.generateSignals();
    renderRLBrief();
    renderActionGuide(); // RL信号就绪后重新渲染操作建议
    if(document.getElementById('rl-brain-container')?.style.display!=='none')renderRLBrain();
    console.log('RL信号已更新:', Object.keys(_rlSignals).length, '只基金');
  }
}

// ==================== BACKTEST ENGINE ====================
// 纯JS实现: RSI策略过滤 + Kelly仓位管理 + 完整回测指标
// 策略: 预测涨幅>1% + RSI<70 → 买入; RSI>75 → 卖出
// 仓位: Kelly f* = (bp-q)/b

function btCalcRSI(prices, period){
  const rsi = new Array(prices.length).fill(50);
  if(prices.length < period + 1) return rsi;
  let avgGain = 0, avgLoss = 0;
  for(let i = 1; i <= period; i++){
    const d = prices[i] - prices[i-1];
    if(d > 0) avgGain += d; else avgLoss += Math.abs(d);
  }
  avgGain /= period; avgLoss /= period;
  rsi[period] = avgLoss === 0 ? 100 : 100 - 100/(1 + avgGain/avgLoss);
  for(let i = period + 1; i < prices.length; i++){
    const d = prices[i] - prices[i-1];
    avgGain = (avgGain * (period-1) + (d > 0 ? d : 0)) / period;
    avgLoss = (avgLoss * (period-1) + (d < 0 ? Math.abs(d) : 0)) / period;
    rsi[i] = avgLoss === 0 ? 100 : 100 - 100/(1 + avgGain/avgLoss);
  }
  return rsi;
}

function btCalcMA(prices, period){
  const ma = [];
  for(let i = 0; i < prices.length; i++){
    if(i < period - 1){ ma.push(prices[i]); continue; }
    let s = 0; for(let j = i - period + 1; j <= i; j++) s += prices[j];
    ma.push(s / period);
  }
  return ma;
}

function btCalcMACD(prices){
  // EMA12, EMA26, MACD signal
  const ema = (arr, k) => {
    const mult = 2/(k+1); const r = [arr[0]];
    for(let i=1;i<arr.length;i++) r.push(arr[i]*mult+r[i-1]*(1-mult));
    return r;
  };
  const e12 = ema(prices, 12), e26 = ema(prices, 26);
  const dif = e12.map((v,i) => v - e26[i]);
  const dea = ema(dif, 9);
  return { dif, dea, hist: dif.map((v,i) => 2*(v-dea[i])) };
}

function btCalcVolatility(prices, period){
  const vol = [];
  for(let i = 0; i < prices.length; i++){
    if(i < period){ vol.push(0); continue; }
    const rets = [];
    for(let j = i-period+1; j <= i; j++) rets.push((prices[j]-prices[j-1])/prices[j-1]);
    const mu = rets.reduce((s,v)=>s+v,0)/rets.length;
    const variance = rets.reduce((s,v)=>s+(v-mu)**2,0)/rets.length;
    vol.push(Math.sqrt(variance));
  }
  return vol;
}

// 凯利公式: f* = (b*p - q) / b
function kellyFraction(winRate, avgWin, avgLoss){
  if(avgLoss === 0 || winRate <= 0) return 0;
  const b = Math.abs(avgWin / avgLoss); // 赔率 = 平均盈利/平均亏损
  const p = winRate;
  const q = 1 - p;
  let f = (b * p - q) / b;
  f = Math.max(0, Math.min(0.25, f)); // 限制最大仓位25% (半Kelly)
  return f;
}

// 单只基金回测
function backtestFund(navArray, code){
  if(!navArray || navArray.length < 60) return null;
  const prices = navArray.map(n => typeof n.nav === 'number' ? n.nav : parseFloat(n.nav || n[1]));
  const dates = navArray.map(n => n.date || n[0]);
  const n = prices.length;

  // 技术指标
  const rsi = btCalcRSI(prices, BT_RSI_PERIOD);
  const ma5 = btCalcMA(prices, 5);
  const ma20 = btCalcMA(prices, 20);
  const macd = btCalcMACD(prices);
  const vol20 = btCalcVolatility(prices, 20);

  // 回测状态
  let cash = 100000;
  const initialCash = cash;
  let shares = 0;
  let entryPrice = 0;
  let position = 0; // 0~1 仓位比例
  const trades = [];
  const equity = []; // 净值曲线
  const drawdown = []; // 回撤曲线
  let peak = initialCash;
  let wins = 0, losses = 0;
  let totalWinAmt = 0, totalLossAmt = 0;
  let _currentKelly = 0;

  // 滚动统计(用于Kelly)
  const recentTrades = []; // 最近N次交易的盈亏率

  const startIdx = Math.max(60, BT_RSI_PERIOD + 1); // 确保指标+RL回溯窗口已够

  // === RL逐步信号(消除前瞻偏差): 用RL Agent在每一bar生成实时信号 ===
  const hasRLAgent = _rlModelLoaded && rlTrainer?.agent;
  let btEnv = null;
  if(hasRLAgent){
    const navSlice = navArray.map(n => ({date: n.date||n[0], nav: typeof n.nav==='number'?n.nav:parseFloat(n.nav||n[1])}));
    btEnv = new MarketEnv(navSlice, code);
  }

  for(let i = startIdx; i < n; i++){
    const price = prices[i];
    const totalValue = cash + shares * price;
    equity.push({ date: dates[i], value: totalValue / initialCash });
    peak = Math.max(peak, totalValue);
    drawdown.push({ date: dates[i], dd: (totalValue - peak) / peak });

    // 预测明日涨幅(简化: 用动量+MACD+MA趋势估算)
    const ret5d = i >= 5 ? (prices[i] - prices[i-5])/prices[i-5] : 0;
    const macdHist = macd.hist[i];
    const maTrend = (ma5[i] - ma20[i]) / ma20[i];
    const predictedReturn = ret5d * 0.3 + macdHist / price * 50 + maTrend * 2;

    // 计算滚动Kelly
    if(recentTrades.length >= 5){
      const wt = recentTrades.filter(r => r > 0);
      const lt = recentTrades.filter(r => r <= 0);
      const wr = wt.length / recentTrades.length;
      const aw = wt.length > 0 ? wt.reduce((s,v)=>s+v,0)/wt.length : 0.01;
      const al = lt.length > 0 ? Math.abs(lt.reduce((s,v)=>s+v,0)/lt.length) : 0.01;
      _currentKelly = kellyFraction(wr, aw, al);
    } else {
      _currentKelly = 0.05; // 默认5%仓位
    }

    // === RL逐步信号(每个bar用Agent实时推断，消除前瞻偏差) ===
    let rlBuyBoost = 0, rlSellBoost = 0;
    if(hasRLAgent && btEnv && i >= 60){
      // 同步env到当前bar
      btEnv.idx = i;
      btEnv.pos = position > 0.01 ? 1 : 0;
      if(position > 0.01) btEnv.entryPrice = entryPrice;
      try {
        const barState = btEnv._state();
        const ens = rlTrainer.agent.getEnsembleQ(barState);
        const barAction = rlArgmax(ens.qMean);
        const probs = rlSoftmax(ens.qMean);
        const barConf = Math.round(probs[barAction] * 100);
        // Ensemble agreement加权
        const voteCounts = [0,0,0];
        ens.votes.forEach(v => voteCounts[v]++);
        const agreement = Math.max(...voteCounts) / ens.votes.length;
        const effConf = barConf * (agreement >= 0.99 ? 1.3 : agreement >= 0.66 ? 1.0 : 0.5);
        if(barAction === 1 && effConf > 40) rlBuyBoost = Math.min(0.5, effConf / 150);
        if(barAction === 2 && effConf > 40) rlSellBoost = Math.min(0.5, effConf / 150);
        if(barAction === 2 && effConf > 60) rlBuyBoost = -0.5;
        if(barAction === 1 && effConf > 60) rlSellBoost = -0.5;
      } catch(e){ /* RL state build failed for this bar, skip */ }
    }

    // 买入: 预测涨幅>1% + RSI<70 + MA5>MA20(趋势向上) + RL信号融合
    const adjMomentumBuy = BT_MOMENTUM_BUY * (1 - rlBuyBoost); // RL看多时降低门槛
    if(predictedReturn > adjMomentumBuy && rsi[i] < BT_RSI_BUY && ma5[i] > ma20[i] && position < 0.9){
      const kellyAdj = _currentKelly * (1 + rlBuyBoost); // RL看多时放大Kelly
      const targetPos = Math.min(position + kellyAdj, 0.95);
      const addPos = targetPos - position;
      if(addPos > 0.02){
        const buyAmt = Math.round(totalValue * addPos);
        const fee = Math.round(buyAmt * BT_FEE);
        const buyShares = (buyAmt - fee) / price;
        if(cash >= buyAmt){
          cash -= buyAmt;
          shares += buyShares;
          if(position === 0) entryPrice = price;
          else entryPrice = (entryPrice * position + price * addPos) / (position + addPos);
          position = targetPos;
          trades.push({
            date: dates[i], action: 'buy', price, shares: buyShares, amount: buyAmt,
            rsi: rsi[i], kelly: kellyAdj, predicted: predictedReturn, rlBoost: rlBuyBoost, fee
          });
        }
      }
    }

    // 卖出: RSI>75 或 趋势反转(MA5<MA20且持仓) 或 止损(-5%) + RL融合
    const pnlPct = position > 0 ? (price - entryPrice) / entryPrice : 0;
    const adjRsiSell = BT_RSI_SELL - Math.round(rlSellBoost * 10); // RL看空时降低卖出RSI门槛
    const shouldSell = (rsi[i] > adjRsiSell && position > 0.2)
      || (ma5[i] < ma20[i] && position > 0.3 && macdHist < 0)
      || (pnlPct < -0.05 && position > 0); // 止损

    if(shouldSell && position > 0){
      let sellRatio = 0.5 * (1 + rlSellBoost); // RL看空时放大卖出比例
      if(rsi[i] > 80) sellRatio = 0.8;
      if(pnlPct < -0.05) sellRatio = 1.0; // 止损全卖
      if(ma5[i] < ma20[i] && macdHist < -0.001) sellRatio = Math.max(sellRatio, 0.7);
      sellRatio = Math.min(sellRatio, 1.0);

      const sellShares = Math.floor(shares * sellRatio * 100) / 100;
      const sellAmt = Math.round(sellShares * price);
      const fee = Math.round(sellAmt * BT_FEE);
      cash += sellAmt - fee;
      shares -= sellShares;
      position = shares * price / (cash + shares * price);

      const tradeReturn = (price - entryPrice) / entryPrice;
      recentTrades.push(tradeReturn);
      if(recentTrades.length > 20) recentTrades.shift();
      if(tradeReturn > 0){ wins++; totalWinAmt += tradeReturn; }
      else{ losses++; totalLossAmt += Math.abs(tradeReturn); }

      trades.push({
        date: dates[i], action: 'sell', price, shares: sellShares, amount: sellAmt,
        rsi: rsi[i], pnl: (tradeReturn*100).toFixed(2)+'%', reason:
          pnlPct<-0.05?'止损':rsi[i]>80?'RSI超买':ma5[i]<ma20[i]?'趋势反转':'获利了结', fee
      });

      if(shares < 0.01){ shares = 0; position = 0; entryPrice = 0; }
    }
  }

  // 最终评估
  const finalValue = cash + shares * prices[n-1];
  const totalReturn = (finalValue - initialCash) / initialCash;
  const tradingDays = equity.length;
  const annualFactor = 250;

  // 年化收益
  const years = tradingDays / annualFactor;
  const annualReturn = years > 0 ? Math.pow(1 + totalReturn, 1/years) - 1 : totalReturn;

  // 日收益率序列
  const dailyReturns = [];
  for(let i = 1; i < equity.length; i++){
    dailyReturns.push(equity[i].value / equity[i-1].value - 1);
  }
  const avgDaily = dailyReturns.length > 0 ? dailyReturns.reduce((s,v)=>s+v,0)/dailyReturns.length : 0;
  const stdDaily = dailyReturns.length > 1 ? Math.sqrt(dailyReturns.reduce((s,v)=>s+(v-avgDaily)**2,0)/(dailyReturns.length-1)) : 1;

  // Sharpe Ratio (年化)
  const dailyRF = BT_RISK_FREE / annualFactor;
  const sharpe = stdDaily > 0 ? (avgDaily - dailyRF) / stdDaily * Math.sqrt(annualFactor) : 0;

  // Max Drawdown
  const maxDD = drawdown.length > 0 ? Math.min(...drawdown.map(d=>d.dd)) : 0;

  // Calmar Ratio
  const calmar = maxDD !== 0 ? annualReturn / Math.abs(maxDD) : 0;

  // Sortino Ratio (下行标准差)
  const downReturns = dailyReturns.filter(r => r < 0);
  const downDev = downReturns.length > 0 ? Math.sqrt(downReturns.reduce((s,v)=>s+v*v,0)/downReturns.length) : stdDaily;
  const sortino = downDev > 0 ? (avgDaily - dailyRF) / downDev * Math.sqrt(annualFactor) : 0;

  // Win Rate & Kelly (整体)
  const totalTrades = wins + losses;
  const winRate = totalTrades > 0 ? wins / totalTrades : 0;
  const avgWin = wins > 0 ? totalWinAmt / wins : 0;
  const avgLoss = losses > 0 ? totalLossAmt / losses : 0.01;
  const finalKelly = kellyFraction(winRate, avgWin, avgLoss);

  // Buy & Hold对比
  const bhReturn = (prices[n-1] - prices[startIdx]) / prices[startIdx];

  return {
    code, totalReturn, annualReturn, sharpe, sortino, calmar,
    maxDD, winRate, wins, losses, totalTrades,
    avgWin, avgLoss, finalKelly,
    bhReturn, // Buy & Hold
    equity, drawdown, trades,
    tradingDays, years,
    finalValue, initialCash,
    lastRSI: rsi[n-1],
    currentKelly: _currentKelly
  };
}

// 全部基金回测
async function runBacktest(){
  if(_btRunning) return;
  _btRunning = true;
  btResults = {};
  // 模拟盘绩效反馈→回测参数自适应(在回测前调整)
  simFeedbackToBT();

  const codes = [...new Set([...holdings.map(h=>h.code), ...watchlist.map(w=>w.code)])];
  if(codes.length === 0){
    alert('请先添加持仓或自选基金');
    _btRunning = false;
    return;
  }

  renderBTBrief();
  renderBacktest();

  let completed = 0;
  const allEquity = [];

  for(const code of codes){
    const hd = fundHistoryData[code];
    if(!hd || !hd.navs || hd.navs.length < 60) continue;

    const navArr = hd.navs.map(n => typeof n === 'object' && n.nav !== undefined ?
      n : { date: n[0], nav: parseFloat(n[1]) }
    ).filter(n => !isNaN(n.nav) && n.nav > 0);

    const result = backtestFund(navArr, code);
    if(result){
      btResults[code] = result;
      allEquity.push(result);
      completed++;
    }

    // 不阻塞UI
    if(completed % 2 === 0) await new Promise(r => setTimeout(r, 0));
  }

  // 组合回测汇总
  if(Object.keys(btResults).length > 0){
    const results = Object.values(btResults);
    const avgReturn = results.reduce((s,r)=>s+r.totalReturn,0)/results.length;
    const avgSharpe = results.reduce((s,r)=>s+r.sharpe,0)/results.length;
    const worstDD = Math.min(...results.map(r=>r.maxDD));
    const avgWinRate = results.reduce((s,r)=>s+r.winRate,0)/results.length;
    const avgKelly = results.reduce((s,r)=>s+r.finalKelly,0)/results.length;
    const avgBH = results.reduce((s,r)=>s+r.bhReturn,0)/results.length;
    const totalTrades = results.reduce((s,r)=>s+r.totalTrades,0);
    const bestFund = results.reduce((a,b)=>a.sharpe>b.sharpe?a:b);
    const worstFund = results.reduce((a,b)=>a.sharpe<b.sharpe?a:b);

    btSummary = {
      avgReturn, avgSharpe, worstDD, avgWinRate, avgKelly, avgBH,
      totalTrades, fundCount: results.length,
      bestFund: bestFund.code, worstFund: worstFund.code,
      excessReturn: avgReturn - avgBH, // 超额收益
      timestamp: Date.now()
    };

    // 保存到localStorage
    try{
      localStorage.setItem(BT_STORAGE_KEY, JSON.stringify({
        results: Object.fromEntries(Object.entries(btResults).map(([k,v])=>
          [k, { code:v.code, totalReturn:v.totalReturn, annualReturn:v.annualReturn, sharpe:v.sharpe, sortino:v.sortino, calmar:v.calmar, maxDD:v.maxDD, winRate:v.winRate, wins:v.wins, losses:v.losses, totalTrades:v.totalTrades, avgWin:v.avgWin, avgLoss:v.avgLoss, finalKelly:v.finalKelly, bhReturn:v.bhReturn, lastRSI:v.lastRSI, currentKelly:v.currentKelly, tradingDays:v.tradingDays }]
        )),
        summary: btSummary
      }));
    }catch(e){ console.warn('回测结果保存失败:', e); }
  }

  _btRunning = false;
  renderBTBrief();
  renderBacktest();
  renderActionGuide(); // 回测完成后重新渲染操作建议(更新回测引擎投票)
  console.log('回测完成:', Object.keys(btResults).length, '只基金', btSummary);
}

// ==================== BACKTEST RENDERING ====================

function toggleBacktest(){
  // Now handled by engine detail tabs
  switchEngTab('bt');
  const body = document.getElementById('engine-detail-body');
  if(body.style.display === 'none') toggleEngineDetail();
}

function renderBTBrief(){
  const el = document.getElementById('bt-brief');
  if(!el) return;
  if(_btRunning){
    el.style.color = '#eab308';
    el.textContent = `BT:回测中`;
    return;
  }
  if(!btSummary){
    el.style.color = 'var(--sub)'; el.textContent = 'BT:未回测'; return;
  }
  const ret = (btSummary.avgReturn*100).toFixed(1);
  const sh = btSummary.avgSharpe.toFixed(2);
  el.style.color = btSummary.avgReturn >= 0 ? 'var(--red)' : 'var(--green)';
  el.textContent = `BT:${ret}% Sh${sh}`;
}

function renderBacktest(){
  const container = document.getElementById('bt-container');
  if(!container) return;

  const hasResults = btSummary && Object.keys(btResults).length > 0;
  let html = '';

  // Run Button + Status
 html += `<div class="bt-card"><div class="bt-card-title"> 策略回测引擎</div>`;
  html += `<div style="font-size:10px;color:var(--sub);margin-bottom:6px">`;
  html += `策略: 预测涨幅>1% + RSI<${BT_RSI_BUY} → 买入 | RSI>${BT_RSI_SELL}或趋势反转 → 卖出<br>`;
  html += `仓位: Kelly f*=(bp-q)/b · 单次最大25%(半Kelly) · 总仓位≤95%`;
  html += `</div>`;
  if(_btRunning){
    html += `<button class="bt-run-btn" disabled>⏳ 回测中... (${Object.keys(btResults).length}只)</button>`;
  } else {
    const dc = Object.keys(fundHistoryData).length;
    html += `<button class="bt-run-btn" onclick="runBacktest()" ${dc<1?'disabled title="需要先加载历史数据"':''}>`;
 html += hasResults ? ' 重新回测 (RSI+Kelly)' : ' 开始回测 (RSI+Kelly)';
    html += `</button>`;
  }
  html += `</div>`;

  if(!hasResults){
    container.innerHTML = html;
    return;
  }

  const s = btSummary;
  const results = Object.values(btResults);

  // Summary Metrics
 html += `<div class="bt-card"><div class="bt-card-title"> 组合回测概览 <span style="font-size:9px;color:var(--sub);font-weight:400">${s.fundCount}只基金</span></div>`;
  html += `<div class="bt-metrics">`;
  html += btMetricHTML('平均收益', (s.avgReturn*100).toFixed(1)+'%', s.avgReturn>=0?'var(--red)':'var(--green)');
  html += btMetricHTML('Sharpe', s.avgSharpe.toFixed(2), s.avgSharpe>=1?'var(--red)':s.avgSharpe>=0?'#f59e0b':'var(--green)');
  html += btMetricHTML('最大回撤', (s.worstDD*100).toFixed(1)+'%', 'var(--green)');
  html += btMetricHTML('胜率', (s.avgWinRate*100).toFixed(0)+'%', s.avgWinRate>=0.5?'var(--red)':'var(--sub)');
  html += btMetricHTML('Kelly仓位', (s.avgKelly*100).toFixed(1)+'%', '#8b5cf6');
  html += btMetricHTML('超额收益', (s.excessReturn>0?'+':'')+(s.excessReturn*100).toFixed(1)+'%', s.excessReturn>=0?'var(--red)':'var(--green)');
  html += `</div>`;

  // Kelly仓位可视化
  const kellyPct = Math.round(s.avgKelly * 100);
  const cashPct = 100 - kellyPct;
  html += `<div style="font-size:9px;color:var(--sub);margin-top:8px">凯利建议仓位</div>`;
  html += `<div class="bt-kelly-bar">`;
  html += `<div class="bt-kelly-seg" style="width:${kellyPct}%;background:linear-gradient(90deg,#3b82f6,#8b5cf6)">${kellyPct}%仓</div>`;
  html += `<div class="bt-kelly-seg" style="width:${cashPct}%;background:rgba(148,163,184,0.2);color:var(--sub)">${cashPct}%现金</div>`;
  html += `</div>`;
  html += `</div>`;

  // Equity Chart (组合平均净值曲线)
  const bestResult = btResults[s.bestFund];
  if(bestResult && bestResult.equity.length > 2){
 html += `<div class="bt-card"><div class="bt-card-title"> 净值 & 回撤曲线 <span style="font-size:9px;color:var(--sub);font-weight:400">${fundName(s.bestFund)}(最优Sharpe)</span></div>`;
    html += renderBTChart(bestResult.equity, bestResult.bhReturn);
    html += `<div style="margin-top:4px">`;
    html += renderBTDDChart(bestResult.drawdown);
    html += `</div></div>`;
  }

  // Per-fund results
 html += `<div class="bt-card"><div class="bt-card-title"> 各基金回测详情</div>`;
  html += `<div style="display:flex;gap:4px;padding:3px 0;border-bottom:1px solid var(--border);margin-bottom:4px">`;
  html += `<span style="font-size:9px;color:var(--sub);flex:1">基金</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:50px;text-align:right">收益率</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:40px;text-align:right">Sharpe</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:45px;text-align:right">最大回撤</span>`;
  html += `<span style="font-size:9px;color:var(--sub);min-width:35px;text-align:right">Kelly</span>`;
  html += `</div>`;
  const sorted = results.sort((a,b) => b.sharpe - a.sharpe);
  sorted.forEach(r => {
    const retColor = r.totalReturn >= 0 ? 'var(--red)' : 'var(--green)';
    const shColor = r.sharpe >= 1 ? 'var(--red)' : r.sharpe >= 0 ? '#f59e0b' : 'var(--green)';
    html += `<div class="bt-fund-row">`;
    html += `<span class="bt-fund-name">${fundName(r.code)}</span>`;
    html += `<span class="bt-fund-ret" style="color:${retColor}">${(r.totalReturn*100).toFixed(1)}%</span>`;
    html += `<span class="bt-fund-sharpe" style="color:${shColor}">${r.sharpe.toFixed(2)}</span>`;
    html += `<span class="bt-fund-mdd" style="color:var(--green)">${(r.maxDD*100).toFixed(1)}%</span>`;
    html += `<span class="bt-fund-kelly" style="color:#8b5cf6">${(r.finalKelly*100).toFixed(0)}%</span>`;
    html += `</div>`;
  });
  html += `</div>`;

  // Trading history (最近10笔)
  const allTrades = [];
  results.forEach(r => {
    r.trades.slice(-5).forEach(t => allTrades.push({...t, code: r.code}));
  });
  allTrades.sort((a,b) => b.date.localeCompare(a.date));

  if(allTrades.length > 0){
 html += `<div class="bt-card"><div class="bt-card-title"> 最近交易记录 <span style="font-size:9px;color:var(--sub);font-weight:400">${s.totalTrades}笔总交易</span></div>`;
    allTrades.slice(0, 10).forEach(t => {
 const ac = t.action === 'buy' ? '�买' : '卖';
      const extra = t.action === 'sell' ? ` ${t.pnl} ${t.reason||''}` : ` RSI:${t.rsi?.toFixed(0)} Kelly:${(t.kelly*100)?.toFixed(0)}%`;
      html += `<div class="bt-trade-row">`;
      html += `<span style="min-width:60px">${t.date?.slice(5)}</span>`;
      html += `<span style="min-width:24px">${ac}</span>`;
      html += `<span style="flex:1">${fundName(t.code)}</span>`;
      html += `<span style="color:var(--sub);text-align:right">${extra}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Architecture
 html += `<div class="bt-card"><div class="bt-card-title"> 回测参数</div>`;
  html += `<div style="font-size:10px;color:var(--sub);line-height:1.6">`;
  html += `<b>数据:</b> 基金历史NAV(近1年~250交易日)<br>`;
  html += `<b>买入条件:</b> 预测涨幅>1% + RSI(14)<${BT_RSI_BUY} + MA5>MA20<br>`;
  html += `<b>卖出条件:</b> RSI>${BT_RSI_SELL} / 趋势反转(MA5<MA20+MACD<0) / 止损(-5%)<br>`;
  html += `<b>仓位管理:</b> Kelly f*=(b·p-q)/b · 半Kelly(max 25%) · 滚动20次交易统计<br>`;
  html += `<b>手续费:</b> ${(BT_FEE*100).toFixed(2)}% 单边<br>`;
  html += `<b>风控:</b> 总仓位≤95% · 止损-5% · RSI超买减仓<br>`;
  html += `<b>指标:</b> Sharpe=(R-Rf)/σ·√250 · Sortino(下行波动) · Calmar(年化/最大回撤) · Kelly<br>`;
  html += `<b>闭环:</b> <span style="color:#22d3ee">RL信号融合买卖 · 三引擎投票共识 · 回测特征注入RL状态</span>`;
  html += `</div></div>`;

  container.innerHTML = html;
}

function btMetricHTML(label, val, color){
  return `<div class="bt-metric"><span class="bt-metric-label">${label}</span><span class="bt-metric-val" style="color:${color||'var(--text)'}">${val}</span></div>`;
}

function renderBTChart(equity, bhReturn){
  if(!equity || equity.length < 2) return '';
  const vals = equity.map(e => e.value);
  const max = Math.max(...vals), min = Math.min(...vals);
  const range = max - min || 0.01;
  const h = 70, w = 100;

  let strategyPts = '', bhPts = '';
  const step = Math.max(1, Math.floor(vals.length / 200));
  for(let i = 0; i < vals.length; i += step){
    const x = (i / (vals.length-1)) * w;
    const y = h - ((vals[i] - min) / range) * h;
    strategyPts += `${x.toFixed(1)},${y.toFixed(1)} `;
    // Buy & Hold line
    const bhVal = 1 + (vals[i] - 1) * 0; // 简化: 线性
    const bhV = 1 + (bhReturn * i / (vals.length-1));
    const bhY = h - ((bhV - min) / range) * h;
    bhPts += `${x.toFixed(1)},${bhY.toFixed(1)} `;
  }

  let s = `<div class="bt-chart"><svg viewBox="0 0 ${w} ${h+4}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  // BH line
  s += `<polyline points="${bhPts.trim()}" fill="none" stroke="rgba(148,163,184,0.4)" stroke-width="1" stroke-dasharray="2,2"/>`;
  // Strategy line
  s += `<defs><linearGradient id="btGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f59e0b" stop-opacity="0.25"/><stop offset="100%" stop-color="#f59e0b" stop-opacity="0.02"/></linearGradient></defs>`;
  s += `<polygon points="0,${h+2} ${strategyPts.trim()} ${w},${h+2}" fill="url(#btGrad)"/>`;
  s += `<polyline points="${strategyPts.trim()}" fill="none" stroke="#f59e0b" stroke-width="1.5"/>`;
  // 1.0 line
  const oneY = h - ((1 - min) / range) * h;
  if(oneY > 0 && oneY < h) s += `<line x1="0" y1="${oneY.toFixed(1)}" x2="${w}" y2="${oneY.toFixed(1)}" stroke="rgba(255,255,255,0.15)" stroke-dasharray="2,2"/>`;
  s += `</svg>`;
  s += `<div style="position:absolute;top:2px;left:4px;font-size:8px;color:#f59e0b">●策略 ${(vals[vals.length-1]*100-100).toFixed(1)}%</div>`;
  s += `<div style="position:absolute;top:2px;right:4px;font-size:8px;color:var(--sub)">●B&H ${(bhReturn*100).toFixed(1)}%</div>`;
  s += `</div>`;
  return s;
}

function renderBTDDChart(drawdown){
  if(!drawdown || drawdown.length < 2) return '';
  const vals = drawdown.map(d => d.dd);
  const minDD = Math.min(...vals);
  const range = Math.abs(minDD) || 0.01;
  const h = 40, w = 100;

  let pts = '';
  const step = Math.max(1, Math.floor(vals.length / 200));
  for(let i = 0; i < vals.length; i += step){
    const x = (i / (vals.length-1)) * w;
    const y = (Math.abs(vals[i]) / range) * h;
    pts += `${x.toFixed(1)},${y.toFixed(1)} `;
  }

  let s = `<div class="bt-dd-chart"><svg viewBox="0 0 ${w} ${h+2}" preserveAspectRatio="none" style="width:100%;height:100%">`;
  s += `<defs><linearGradient id="ddGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ef4444" stop-opacity="0.02"/><stop offset="100%" stop-color="#ef4444" stop-opacity="0.3"/></linearGradient></defs>`;
  s += `<polygon points="0,0 ${pts.trim()} ${w},0" fill="url(#ddGrad)"/>`;
  s += `<polyline points="${pts.trim()}" fill="none" stroke="#ef4444" stroke-width="1"/>`;
  s += `</svg>`;
  s += `<div style="position:absolute;bottom:2px;left:4px;font-size:8px;color:#ef4444">回撤 ${(minDD*100).toFixed(1)}%</div>`;
  s += `</div>`;
  return s;
}

// Build backtest context for AI prompt
function buildBTContext(){
  if(!btSummary || Object.keys(btResults).length === 0) return '';
 let ctx = '\n【 策略回测结果 (RSI+Kelly+RL融合)】\n';
  ctx += `策略: 预测涨幅>1%且RSI<${BT_RSI_BUY}买入 | RSI>${BT_RSI_SELL}或趋势反转卖出 | Kelly仓位管理 | RL信号辅助\n`;
  ctx += `共识: 三引擎(AI+RL+回测)加权投票 · 全票一致×1.4 · 多数票×1.15 · 分歧×0.4\n`;
  ctx += `组合: 平均收益${(btSummary.avgReturn*100).toFixed(1)}% · Sharpe ${btSummary.avgSharpe.toFixed(2)} · 最大回撤${(btSummary.worstDD*100).toFixed(1)}% · 胜率${(btSummary.avgWinRate*100).toFixed(0)}%\n`;
  ctx += `超额收益(vs Buy&Hold): ${(btSummary.excessReturn*100).toFixed(1)}%\n`;
  ctx += `Kelly建议平均仓位: ${(btSummary.avgKelly*100).toFixed(1)}%\n`;
  ctx += '各基金回测:\n';
  Object.values(btResults).sort((a,b)=>b.sharpe-a.sharpe).forEach(r => {
    ctx += `  ${fundName(r.code)}(${r.code}): 收益${(r.totalReturn*100).toFixed(1)}% · Sharpe ${r.sharpe.toFixed(2)} · 回撤${(r.maxDD*100).toFixed(1)}% · 胜率${(r.winRate*100).toFixed(0)}% · Kelly仓位${(r.finalKelly*100).toFixed(0)}% · 当前RSI ${r.lastRSI?.toFixed(0)}\n`;
  });
 ctx += ' 回测已融合RL信号。三引擎投票共识系统: AI/RL/回测多数票→加大仓位, 分歧→缩减仓位。高Sharpe基金可加配，Sharpe<0需谨慎。\n';
  return ctx;
}

// Load saved backtest results
function loadBTResults(){
  try{
    const raw = localStorage.getItem(BT_STORAGE_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    if(d.summary) btSummary = d.summary;
    if(d.results){
      for(const[k,v]of Object.entries(d.results)){
        btResults[k] = v; // partial results (no equity/trades/drawdown arrays)
      }
    }
    renderBTBrief();
    // 缓存加载后延迟渲染操作建议(等待页面DOM就绪)
    setTimeout(() => renderActionGuide(), 100);
    console.log('回测结果已加载:', Object.keys(btResults).length, '只基金');
  }catch(e){ console.warn('回测结果加载失败:', e); }
}
</script>
</body>
</html>
